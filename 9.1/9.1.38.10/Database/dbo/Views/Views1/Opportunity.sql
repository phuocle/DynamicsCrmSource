


--
-- base view for Opportunity
--
create view dbo.[Opportunity]
 (
    -- logical attributes
    [PriceLevelIdName],
    [ParentAccountIdName],
    [OriginatingLeadIdName],
    [CampaignIdName],
    [OriginatingLeadIdYomiName],
    [SLAName],
    [CreatedByName],
    [CreatedByYomiName],
    [CreatedOnBehalfByName],
    [CreatedOnBehalfByYomiName],
    [ModifiedByName],
    [ModifiedByYomiName],
    [ModifiedOnBehalfByName],
    [ModifiedOnBehalfByYomiName],
    [TransactionCurrencyIdName],
    [ParentContactIdName],
    [SLAInvokedIdName],
    [ParentAccountIdYomiName],
    [ParentContactIdYomiName],

    -- ownership entries
    OwnerId,
    OwnerIdName,
    OwnerIdYomiName,
    OwnerIdDsc,
    OwnerIdType,
    OwningUser,
    OwningTeam,


	[AccountId],
	[AccountIdName],
	[AccountIdYomiName],
	[ContactId],
	[ContactIdName],
	[ContactIdYomiName],
    -- physical attributes
    [OpportunityId],
    [CreatedOn],
    [CreatedBy],
    [ModifiedOn],
    [ModifiedBy],
    [CreatedOnBehalfBy],
    [ModifiedOnBehalfBy],
    [OwningBusinessUnit],
    [VersionNumber],
    [EmailAddress],
    [ImportSequenceNumber],
    [OverriddenCreatedOn],
    [TimeZoneRuleVersionNumber],
    [UTCConversionTimeZoneCode],
    [Name],
    [ProcessId],
    [StageId],
    [TraversedPath],
    [ActualCloseDate],
    [ActualValue],
    [TransactionCurrencyId],
    [ExchangeRate],
    [ActualValue_Base],
    [BudgetAmount],
    [BudgetAmount_Base],
    [BudgetStatus],
    [CloseProbability],
    [CompleteInternalReview],
    [ConfirmInterest],
    [CurrentSituation],
    [CustomerId],
    [CustomerNeed],
    [CustomerPainPoints],
    [DecisionMaker],
    [Description],
    [DevelopProposal],
    [DiscountAmount],
    [DiscountAmount_Base],
    [DiscountPercentage],
    [EstimatedCloseDate],
    [EstimatedValue],
    [EstimatedValue_Base],
    [EvaluateFit],
    [ResolveFeedback],
    [FileDebrief],
    [CompleteFinalProposal],
    [FinalDecisionDate],
    [FreightAmount],
    [FreightAmount_Base],
    [InitialCommunication],
    [IsPrivate],
    [IsRevenueSystemCalculated],
    [Need],
    [OpportunityRatingCode],
    [ParentAccountId],
    [ParentContactId],
    [ParticipatesInWorkflow],
    [PriceLevelId],
    [PricingErrorCode],
    [PriorityCode],
    [PurchaseProcess],
    [PurchaseTimeframe],
    [SalesStage],
    [SalesStageCode],
    [PresentProposal],
    [CaptureProposalFeedback],
    [ProposedSolution],
    [PursuitDecision],
    [QualificationComments],
    [QuoteComments],
    [SendThankYouNote],
    [ScheduleFollowup_Prospect],
    [ScheduleFollowup_Qualify],
    [ScheduleProposalMeeting],
    [StateCode],
    [StatusCode],
    [StepId],
    [StepName],
    [TimeLine],
    [TotalAmount],
    [TotalAmount_Base],
    [TotalAmountLessFreight],
    [TotalAmountLessFreight_Base],
    [TotalDiscountAmount],
    [TotalDiscountAmount_Base],
    [TotalLineItemAmount],
    [TotalLineItemAmount_Base],
    [TotalLineItemDiscountAmount],
    [TotalLineItemDiscountAmount_Base],
    [TotalTax],
    [TotalTax_Base],
    [IdentifyCustomerContacts],
    [IdentifyCompetitors],
    [IdentifyPursuitTeam],
    [PresentFinalProposal],
    [OnHoldTime],
    [LastOnHoldTime],
    [SLAId],
    [SLAInvokedId],
    [TimeSpentByMeOnEmailAndMeetings],
    [OriginatingLeadId],
    [CustomerIdName],
    [CustomerIdType],
    [CustomerIdYomiName],
    [CampaignId],
    [TeamsFollowed],
    [SkipPriceCalculation]
) with view_metadata as
select
    -- logical attributes
    [price_level_opportunties].[Name],
    [opportunity_parent_account].[Name],
    [opportunity_originating_lead].[FullName],
    [campaign_opportunities].[Name],
    [opportunity_originating_lead].[YomiFullName],
    [manualsla_opportunity].[Name],
    [lk_opportunitybase_createdby].[FullName],
    [lk_opportunitybase_createdby].[YomiFullName],
    [lk_opportunitybase_createdonbehalfby].[FullName],
    [lk_opportunitybase_createdonbehalfby].[YomiFullName],
    [lk_opportunitybase_modifiedby].[FullName],
    [lk_opportunitybase_modifiedby].[YomiFullName],
    [lk_opportunitybase_modifiedonbehalfby].[FullName],
    [lk_opportunitybase_modifiedonbehalfby].[YomiFullName],
    [transactioncurrency_opportunity].[CurrencyName],
    [opportunity_parent_contact].[FullName],
    [sla_opportunity].[Name],
    [opportunity_parent_account].[YomiName],
    [opportunity_parent_contact].[YomiFullName],

    -- ownership entries
    OwnerId = [OpportunityBase].OwnerId,
    OwnerName = XXowner.Name,
    OwnerYomiName =  XXowner.YomiName,
    OwnerDsc = 0, -- DSC is removed, stub it to 0
    OwnerIdType = XXowner.OwnerIdType,
    OwningUser = case 
 		when XXowner.OwnerIdType= 8 then XXowner.OwnerId
		else null
		end,
    OwningTeam = case 
 		when XXowner.OwnerIdType= 9 then XXowner.OwnerId
		else null
		end,


	[AccountId] = case 
		when [OpportunityBase].[CustomerIdType] = 1 AND [OpportunityBase].[CustomerId] IS NOT NULL then [OpportunityBase].[CustomerId]
		else NULL
		end,
	[AccountIdName] = case 
		when [OpportunityBase].[CustomerIdType] = 1 AND [OpportunityBase].[CustomerId] IS NOT NULL then [OpportunityBase].[CustomerIdName]
		else NULL
		end,
	[AccountIdYomiName] = case 
		when [OpportunityBase].[CustomerIdType] = 1 AND [OpportunityBase].[CustomerId] IS NOT NULL then [OpportunityBase].[CustomerIdYomiName]
		else NULL
		end,
	[ContactId] = case 
		when [OpportunityBase].[CustomerIdType] = 2 AND [OpportunityBase].[CustomerId] IS NOT NULL then [OpportunityBase].[CustomerId]
		else NULL
		end,
	[ContactIdName] = case 
		when [OpportunityBase].[CustomerIdType] = 2 AND [OpportunityBase].[CustomerId] IS NOT NULL then [OpportunityBase].[CustomerIdName]
		else NULL
		end,
	[ContactIdYomiName] = case 
		when [OpportunityBase].[CustomerIdType] = 2 AND [OpportunityBase].[CustomerId] IS NOT NULL then [OpportunityBase].[CustomerIdYomiName]
		else NULL
		end,
    -- physical attribute
    [OpportunityBase].[OpportunityId],
    [OpportunityBase].[CreatedOn],
    [OpportunityBase].[CreatedBy],
    [OpportunityBase].[ModifiedOn],
    [OpportunityBase].[ModifiedBy],
    [OpportunityBase].[CreatedOnBehalfBy],
    [OpportunityBase].[ModifiedOnBehalfBy],
    [OpportunityBase].[OwningBusinessUnit],
    [OpportunityBase].[VersionNumber],
    [OpportunityBase].[EmailAddress],
    [OpportunityBase].[ImportSequenceNumber],
    [OpportunityBase].[OverriddenCreatedOn],
    [OpportunityBase].[TimeZoneRuleVersionNumber],
    [OpportunityBase].[UTCConversionTimeZoneCode],
    [OpportunityBase].[Name],
    [OpportunityBase].[ProcessId],
    [OpportunityBase].[StageId],
    [OpportunityBase].[TraversedPath],
    [OpportunityBase].[ActualCloseDate],
    [OpportunityBase].[ActualValue],
    [OpportunityBase].[TransactionCurrencyId],
    [OpportunityBase].[ExchangeRate],
    [OpportunityBase].[ActualValue_Base],
    [OpportunityBase].[BudgetAmount],
    [OpportunityBase].[BudgetAmount_Base],
    [OpportunityBase].[BudgetStatus],
    [OpportunityBase].[CloseProbability],
    [OpportunityBase].[CompleteInternalReview],
    [OpportunityBase].[ConfirmInterest],
    [OpportunityBase].[CurrentSituation],
    [OpportunityBase].[CustomerId],
    [OpportunityBase].[CustomerNeed],
    [OpportunityBase].[CustomerPainPoints],
    [OpportunityBase].[DecisionMaker],
    [OpportunityBase].[Description],
    [OpportunityBase].[DevelopProposal],
    [OpportunityBase].[DiscountAmount],
    [OpportunityBase].[DiscountAmount_Base],
    [OpportunityBase].[DiscountPercentage],
    [OpportunityBase].[EstimatedCloseDate],
    [OpportunityBase].[EstimatedValue],
    [OpportunityBase].[EstimatedValue_Base],
    [OpportunityBase].[EvaluateFit],
    [OpportunityBase].[ResolveFeedback],
    [OpportunityBase].[FileDebrief],
    [OpportunityBase].[CompleteFinalProposal],
    [OpportunityBase].[FinalDecisionDate],
    [OpportunityBase].[FreightAmount],
    [OpportunityBase].[FreightAmount_Base],
    [OpportunityBase].[InitialCommunication],
    [OpportunityBase].[IsPrivate],
    [OpportunityBase].[IsRevenueSystemCalculated],
    [OpportunityBase].[Need],
    [OpportunityBase].[OpportunityRatingCode],
    [OpportunityBase].[ParentAccountId],
    [OpportunityBase].[ParentContactId],
    [OpportunityBase].[ParticipatesInWorkflow],
    [OpportunityBase].[PriceLevelId],
    [OpportunityBase].[PricingErrorCode],
    [OpportunityBase].[PriorityCode],
    [OpportunityBase].[PurchaseProcess],
    [OpportunityBase].[PurchaseTimeframe],
    [OpportunityBase].[SalesStage],
    [OpportunityBase].[SalesStageCode],
    [OpportunityBase].[PresentProposal],
    [OpportunityBase].[CaptureProposalFeedback],
    [OpportunityBase].[ProposedSolution],
    [OpportunityBase].[PursuitDecision],
    [OpportunityBase].[QualificationComments],
    [OpportunityBase].[QuoteComments],
    [OpportunityBase].[SendThankYouNote],
    [OpportunityBase].[ScheduleFollowup_Prospect],
    [OpportunityBase].[ScheduleFollowup_Qualify],
    [OpportunityBase].[ScheduleProposalMeeting],
    [OpportunityBase].[StateCode],
    [OpportunityBase].[StatusCode],
    [OpportunityBase].[StepId],
    [OpportunityBase].[StepName],
    [OpportunityBase].[TimeLine],
    [OpportunityBase].[TotalAmount],
    [OpportunityBase].[TotalAmount_Base],
    [OpportunityBase].[TotalAmountLessFreight],
    [OpportunityBase].[TotalAmountLessFreight_Base],
    [OpportunityBase].[TotalDiscountAmount],
    [OpportunityBase].[TotalDiscountAmount_Base],
    [OpportunityBase].[TotalLineItemAmount],
    [OpportunityBase].[TotalLineItemAmount_Base],
    [OpportunityBase].[TotalLineItemDiscountAmount],
    [OpportunityBase].[TotalLineItemDiscountAmount_Base],
    [OpportunityBase].[TotalTax],
    [OpportunityBase].[TotalTax_Base],
    [OpportunityBase].[IdentifyCustomerContacts],
    [OpportunityBase].[IdentifyCompetitors],
    [OpportunityBase].[IdentifyPursuitTeam],
    [OpportunityBase].[PresentFinalProposal],
    [OpportunityBase].[OnHoldTime],
    [OpportunityBase].[LastOnHoldTime],
    [OpportunityBase].[SLAId],
    [OpportunityBase].[SLAInvokedId],
    [OpportunityBase].[TimeSpentByMeOnEmailAndMeetings],
    [OpportunityBase].[OriginatingLeadId],
    [OpportunityBase].[CustomerIdName],
    [OpportunityBase].[CustomerIdType],
    [OpportunityBase].[CustomerIdYomiName],
    [OpportunityBase].[CampaignId],
    [OpportunityBase].[TeamsFollowed],
    [OpportunityBase].[SkipPriceCalculation]
from [OpportunityBase] 
    left join [CampaignBase] [campaign_opportunities] on ([OpportunityBase].[CampaignId] = [campaign_opportunities].[CampaignId])
    left join [SystemUserBase] [lk_opportunitybase_createdby] on ([OpportunityBase].[CreatedBy] = [lk_opportunitybase_createdby].[SystemUserId])
    left join [SystemUserBase] [lk_opportunitybase_createdonbehalfby] on ([OpportunityBase].[CreatedOnBehalfBy] = [lk_opportunitybase_createdonbehalfby].[SystemUserId])
    left join [SystemUserBase] [lk_opportunitybase_modifiedby] on ([OpportunityBase].[ModifiedBy] = [lk_opportunitybase_modifiedby].[SystemUserId])
    left join [SystemUserBase] [lk_opportunitybase_modifiedonbehalfby] on ([OpportunityBase].[ModifiedOnBehalfBy] = [lk_opportunitybase_modifiedonbehalfby].[SystemUserId])
    left join [SLABase] [manualsla_opportunity] on ([OpportunityBase].[SLAId] = [manualsla_opportunity].[SLAId] and [manualsla_opportunity].OverwriteTime = 0 and [manualsla_opportunity].ComponentState = 0)
    left join [LeadBase] [opportunity_originating_lead] on ([OpportunityBase].[OriginatingLeadId] = [opportunity_originating_lead].[LeadId])
    left join [AccountBase] [opportunity_parent_account] on ([OpportunityBase].[ParentAccountId] = [opportunity_parent_account].[AccountId])
    left join [ContactBase] [opportunity_parent_contact] on ([OpportunityBase].[ParentContactId] = [opportunity_parent_contact].[ContactId])
    left join [PriceLevelBase] [price_level_opportunties] on ([OpportunityBase].[PriceLevelId] = [price_level_opportunties].[PriceLevelId])
    left join [SLABase] [sla_opportunity] on ([OpportunityBase].[SLAInvokedId] = [sla_opportunity].[SLAId] and [sla_opportunity].OverwriteTime = 0 and [sla_opportunity].ComponentState = 0)
    left join [TransactionCurrencyBase] [transactioncurrency_opportunity] on ([OpportunityBase].[TransactionCurrencyId] = [transactioncurrency_opportunity].[TransactionCurrencyId])
    left join OwnerBase XXowner on ([OpportunityBase].OwnerId = XXowner.OwnerId)
