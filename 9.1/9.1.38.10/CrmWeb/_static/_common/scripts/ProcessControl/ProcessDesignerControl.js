//---------------------------------------------------------------------------------------------
// <copyright file="AttributeTypes.ts" company="Microsoft">
//		Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
//
// <summary>
// CRM Attribute types definition
// </summary>
//---------------------------------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        (function (AttributeType) {
            AttributeType[AttributeType["Unknown"] = -1] = "Unknown";
            AttributeType[AttributeType["Boolean"] = 0] = "Boolean";
            AttributeType[AttributeType["Customer"] = 1] = "Customer";
            AttributeType[AttributeType["DateTime"] = 2] = "DateTime";
            AttributeType[AttributeType["Decimal"] = 3] = "Decimal";
            AttributeType[AttributeType["Double"] = 4] = "Double";
            AttributeType[AttributeType["Integer"] = 5] = "Integer";
            AttributeType[AttributeType["Lookup"] = 6] = "Lookup";
            AttributeType[AttributeType["Money"] = 7] = "Money";
            AttributeType[AttributeType["Owner"] = 8] = "Owner";
            AttributeType[AttributeType["Picklist"] = 10] = "Picklist";
            AttributeType[AttributeType["State"] = 12] = "State";
            AttributeType[AttributeType["Status"] = 13] = "Status";
            AttributeType[AttributeType["String"] = 14] = "String";
            AttributeType[AttributeType["UniqueIdentifier"] = 15] = "UniqueIdentifier";
            AttributeType[AttributeType["CalendarRules"] = 16] = "CalendarRules";
            AttributeType[AttributeType["BigInt"] = 18] = "BigInt";
            AttributeType[AttributeType["ManagedProperty"] = 19] = "ManagedProperty";
            AttributeType[AttributeType["EntityName"] = 20] = "EntityName";
            AttributeType[AttributeType["AliasedValue"] = 21] = "AliasedValue";
            AttributeType[AttributeType["ArrayOfString"] = 22] = "ArrayOfString";
        })(ProcessDesigner.AttributeType || (ProcessDesigner.AttributeType = {}));
        var AttributeType = ProcessDesigner.AttributeType;
        (function (DateFormat) {
            DateFormat[DateFormat["DateTime"] = 0] = "DateTime";
            DateFormat[DateFormat["Date"] = 1] = "Date";
        })(ProcessDesigner.DateFormat || (ProcessDesigner.DateFormat = {}));
        var DateFormat = ProcessDesigner.DateFormat;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
//---------------------------------------------------------------------------------------------
// <copyright file="ConditionOperator.ts" company="Microsoft">
// Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
//
// <summary>
// Enum to represent Operators for Condition
// </summary>
//---------------------------------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        (function (ConditionOperator) {
            ConditionOperator[ConditionOperator["DoesNotContainData"] = 0] = "DoesNotContainData";
            ConditionOperator[ConditionOperator["ContainsData"] = 1] = "ContainsData";
            ConditionOperator[ConditionOperator["LogicalAnd"] = 2] = "LogicalAnd";
            ConditionOperator[ConditionOperator["LogicalOr"] = 3] = "LogicalOr";
            ConditionOperator[ConditionOperator["IN"] = 4] = "IN";
            ConditionOperator[ConditionOperator["NotIn"] = 5] = "NotIn";
            ConditionOperator[ConditionOperator["Equal"] = 6] = "Equal";
            ConditionOperator[ConditionOperator["NotEqual"] = 7] = "NotEqual";
            ConditionOperator[ConditionOperator["Contains"] = 8] = "Contains";
            ConditionOperator[ConditionOperator["DoesNotContain"] = 9] = "DoesNotContain";
            ConditionOperator[ConditionOperator["BeginsWith"] = 10] = "BeginsWith";
            ConditionOperator[ConditionOperator["DoesNotBeginWith"] = 11] = "DoesNotBeginWith";
            ConditionOperator[ConditionOperator["EndsWith"] = 12] = "EndsWith";
            ConditionOperator[ConditionOperator["DoesNotEndWith"] = 13] = "DoesNotEndWith";
            ConditionOperator[ConditionOperator["GreaterThan"] = 14] = "GreaterThan";
            ConditionOperator[ConditionOperator["GreaterThanOrEqual"] = 15] = "GreaterThanOrEqual";
            ConditionOperator[ConditionOperator["LessThan"] = 16] = "LessThan";
            ConditionOperator[ConditionOperator["LessThanOrEqual"] = 17] = "LessThanOrEqual";
            ConditionOperator[ConditionOperator["EqualUserId"] = 18] = "EqualUserId";
            ConditionOperator[ConditionOperator["NotEqualUserId"] = 19] = "NotEqualUserId";
            ConditionOperator[ConditionOperator["On"] = 20] = "On";
            ConditionOperator[ConditionOperator["NotOn"] = 21] = "NotOn";
            ConditionOperator[ConditionOperator["OnOrAfter"] = 22] = "OnOrAfter";
            ConditionOperator[ConditionOperator["OnOrBefore"] = 23] = "OnOrBefore";
            ConditionOperator[ConditionOperator["Yesterday"] = 24] = "Yesterday";
            ConditionOperator[ConditionOperator["Today"] = 25] = "Today";
            ConditionOperator[ConditionOperator["Tomorrow"] = 26] = "Tomorrow";
            ConditionOperator[ConditionOperator["NextSevenDays"] = 27] = "NextSevenDays";
            ConditionOperator[ConditionOperator["LastSevenDays"] = 28] = "LastSevenDays";
            ConditionOperator[ConditionOperator["NextWeek"] = 29] = "NextWeek";
            ConditionOperator[ConditionOperator["LastWeek"] = 30] = "LastWeek";
            ConditionOperator[ConditionOperator["ThisWeek"] = 31] = "ThisWeek";
            ConditionOperator[ConditionOperator["NextMonth"] = 32] = "NextMonth";
            ConditionOperator[ConditionOperator["LastMonth"] = 33] = "LastMonth";
            ConditionOperator[ConditionOperator["ThisMonth"] = 34] = "ThisMonth";
            ConditionOperator[ConditionOperator["NextYear"] = 35] = "NextYear";
            ConditionOperator[ConditionOperator["LastYear"] = 36] = "LastYear";
            ConditionOperator[ConditionOperator["ThisYear"] = 37] = "ThisYear";
            ConditionOperator[ConditionOperator["Anytime"] = 38] = "Anytime";
            ConditionOperator[ConditionOperator["LastXHours"] = 39] = "LastXHours";
            ConditionOperator[ConditionOperator["NextXHours"] = 40] = "NextXHours";
            ConditionOperator[ConditionOperator["LastXDays"] = 41] = "LastXDays";
            ConditionOperator[ConditionOperator["NextXDays"] = 42] = "NextXDays";
            ConditionOperator[ConditionOperator["LastXWeeks"] = 43] = "LastXWeeks";
            ConditionOperator[ConditionOperator["NextXWeeks"] = 44] = "NextXWeeks";
            ConditionOperator[ConditionOperator["LastXMonths"] = 45] = "LastXMonths";
            ConditionOperator[ConditionOperator["NextXMonths"] = 46] = "NextXMonths";
            ConditionOperator[ConditionOperator["LastXYears"] = 47] = "LastXYears";
            ConditionOperator[ConditionOperator["NextXYears"] = 48] = "NextXYears";
            ConditionOperator[ConditionOperator["Under"] = 49] = "Under";
            ConditionOperator[ConditionOperator["NotUnder"] = 50] = "NotUnder";
        })(ProcessDesigner.ConditionOperator || (ProcessDesigner.ConditionOperator = {}));
        var ConditionOperator = ProcessDesigner.ConditionOperator;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
//---------------------------------------------------------------------------------------------
// <copyright file="DateTimeUtil.ts" company="Microsoft">
//		Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
//
// <summary>
// Date time utils.
// </summary>
//---------------------------------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        var DateTimeUtil = (function () {
            function DateTimeUtil(options) {
                this.defaultHour = 8;
                this.defaultMinute = 0;
                this.isTimeFormat24 = MscrmControls.ProcessDesigner.Util.getBooleanValue(options, 'isTimeFormat24', false);
                this.dateFormat = MscrmControls.ProcessDesigner.Util.getStringValue(options, 'dateFormat', 'm/d/yy');
            }
            DateTimeUtil.prototype.defaultTime = function () {
                if (this.isTimeFormat24) {
                    return "08:00";
                }
                else {
                    return "08:00 " + MscrmControls.ProcessDesigner.MetadataProvider.getLocalizedString("ProcessDesignerControl_PBL_DateTimeUtil_AM");
                }
            };
            DateTimeUtil.prototype.prefixZero = function (clk) {
                return (clk < 10) ? ('0' + clk) : ('' + clk);
            };
            DateTimeUtil.prototype.strToDateTime = function (str) {
                var ret = { date: '', time: this.defaultTime(), errors: { date: false, time: false } };
                var milli = NaN;
                try {
                    $.datepicker.parseDate('D, dd M yy', str);
                    milli = Date.parse(str);
                }
                catch (e) {
                }
                if (_.isNaN(milli)) {
                    if (MscrmControls.ProcessDesigner.Util.isNull(str) || str.length == 0) {
                    }
                    else {
                        var space = str.lastIndexOf(' ', str.length - 4);
                        ret.date = str.substring(0, str.lastIndexOf(' ', space));
                        ret.time = str.substring(space + 1);
                        ret.errors.date = true;
                    }
                }
                else {
                    var dateTime = new Date(milli);
                    var date = $.datepicker.formatDate(this.dateFormat, dateTime);
                    var ampm = '';
                    var hours;
                    if (!this.isTimeFormat24) {
                        ampm = dateTime.getHours() % 24 < 12 ? ' ' + MscrmControls.ProcessDesigner.MetadataProvider.getLocalizedString("ProcessDesignerControl_PBL_DateTimeUtil_AM") : ' ' + MscrmControls.ProcessDesigner.MetadataProvider.getLocalizedString("ProcessDesignerControl_PBL_DateTimeUtil_PM");
                        hours = dateTime.getHours() % 12;
                    }
                    var time = this.prefixZero(hours ? hours : dateTime.getHours()) + ':' + this.prefixZero(dateTime.getMinutes()) + ampm;
                    ret.date = date;
                    ret.time = time;
                }
                return ret;
            };
            DateTimeUtil.prototype.parseDate = function (dateStr_) {
                var ret = null;
                try {
                    var dateStr = dateStr_.trim();
                    ret = $.datepicker.parseDate(this.dateFormat, dateStr);
                    ret = new Date(Date.UTC(ret.getFullYear(), ret.getMonth(), ret.getDate()));
                }
                catch (e) {
                }
                return ret;
            };
            DateTimeUtil.prototype.parseTime = function (timeStr) {
                var ret = { hr: this.defaultHour, min: this.defaultMinute, isError: true };
                try {
                    var split = timeStr.split(':');
                    var hr = parseInt(split[0]);
                    var min = parseInt(split[1].substring(0, 2));
                    if (!this.isTimeFormat24) {
                        var ampm = split[1].substring(split[1].length - 2, split[1].length).toUpperCase();
                        if (ampm == MscrmControls.ProcessDesigner.MetadataProvider.getLocalizedString("ProcessDesignerControl_PBL_DateTimeUtil_AM")) {
                        }
                        else if (ampm == MscrmControls.ProcessDesigner.MetadataProvider.getLocalizedString("ProcessDesignerControl_PBL_DateTimeUtil_PM")) {
                            hr = hr + 12;
                        }
                        else {
                            hr = -1;
                        }
                    }
                    if (hr != -1) {
                        ret.hr = hr;
                        ret.min = min;
                        ret.isError = false;
                    }
                }
                catch (e) {
                }
                return ret;
            };
            DateTimeUtil.prototype.dateTimeToStr = function (dateTime) {
                var ret = { val: this.defaultTime(), errors: { date: false, time: false } };
                try {
                    var date = this.parseDate(dateTime.date);
                    if (date == null) {
                        ret.errors.date = true;
                        dateTime.date = dateTime.date ? dateTime.date : '';
                        ret.val = dateTime.date + ' ' + dateTime.time;
                    }
                    else {
                        var time = this.parseTime(dateTime.time);
                        if (time.isError) {
                            ret.errors.time = true;
                        }
                        else if (date < DateTimeUtil._minAllowedDate || date > DateTimeUtil._maxAllowedDate) {
                            ret.errors.date = true;
                            ret.errors.time = true;
                        }
                        date.setHours(time.hr);
                        date.setMinutes(time.min);
                        ret.val = date.toUTCString();
                    }
                }
                catch (e) {
                }
                return ret;
            };
            DateTimeUtil.prototype.generateTimeSequence = function (timeInterval, callback) {
                var ret = '';
                var hrs, min, ampm = '';
                var max = 1440 - timeInterval;
                for (var i = 0; i <= max; i += timeInterval) {
                    hrs = Math.floor(i / 60);
                    min = i % 60;
                    min = this.prefixZero(min);
                    if (!this.isTimeFormat24) {
                        ampm = hrs % 24 < 12 ? ' ' + MscrmControls.ProcessDesigner.MetadataProvider.getLocalizedString("ProcessDesignerControl_PBL_DateTimeUtil_AM") : ' ' + MscrmControls.ProcessDesigner.MetadataProvider.getLocalizedString("ProcessDesignerControl_PBL_DateTimeUtil_PM");
                        hrs = hrs % 12;
                        if (hrs === 0) {
                            hrs = 12;
                        }
                    }
                    hrs = this.prefixZero(hrs);
                    ret += callback(hrs + ":" + min + ampm);
                }
                return ret;
            };
            DateTimeUtil._maxAllowedDate = new Date(9999, 11, 30);
            DateTimeUtil._minAllowedDate = new Date(1753, 0, 1);
            return DateTimeUtil;
        })();
        ProcessDesigner.DateTimeUtil = DateTimeUtil;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
//---------------------------------------------------------------------------------------------
// <copyright file="IValid.ts" company="Microsoft">
//		Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
//
// <summary>
// Interface for objects, those can validate themselves.
// </summary>
//---------------------------------------------------------------------------------------------
var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    __.prototype = b.prototype;
    d.prototype = new __();
};
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        var Validation;
        (function (Validation) {
            (function (Level) {
                Level[Level["Unknown"] = 0] = "Unknown";
                Level[Level["Change"] = 1] = "Change";
                Level[Level["Apply"] = 2] = "Apply";
                Level[Level["Save"] = 3] = "Save";
                Level[Level["SaveAs"] = 4] = "SaveAs";
                Level[Level["SaveAndClose"] = 5] = "SaveAndClose";
                Level[Level["Validate"] = 6] = "Validate";
                Level[Level["Activate"] = 7] = "Activate";
                Level[Level["Deactivate"] = 8] = "Deactivate";
                Level[Level["EveryTime"] = 9999] = "EveryTime";
            })(Validation.Level || (Validation.Level = {}));
            var Level = Validation.Level;
            var SingleResult = (function () {
                function SingleResult() {
                    this._isValid = true;
                    this._message = "";
                }
                SingleResult.prototype.success = function (msg) {
                    this._message = msg;
                    this._isValid = true;
                    return this;
                };
                SingleResult.prototype.failure = function (msg) {
                    this._message = msg;
                    this._isValid = false;
                    return this;
                };
                SingleResult.prototype.set = function (isValid, msg) {
                    this._message = msg;
                    this._isValid = isValid;
                    return this;
                };
                Object.defineProperty(SingleResult.prototype, "isValid", {
                    get: function () {
                        return this._isValid;
                    },
                    enumerable: true,
                    configurable: true
                });
                Object.defineProperty(SingleResult.prototype, "message", {
                    get: function () {
                        return this._message;
                    },
                    enumerable: true,
                    configurable: true
                });
                return SingleResult;
            })();
            Validation.SingleResult = SingleResult;
            var Result = (function () {
                function Result(field) {
                    this._fieldName = field;
                    this._isValid = true;
                    this._results = [];
                    this._errorMessages = {};
                }
                Result.prototype.addResult = function (res) {
                    this._results.push(res);
                    this._isValid = this._isValid && res.isValid;
                    if (!res._isValid) {
                        this._errorMessages[this._fieldName] = res._message;
                    }
                };
                Object.defineProperty(Result.prototype, "isValid", {
                    get: function () {
                        return this._isValid;
                    },
                    enumerable: true,
                    configurable: true
                });
                Object.defineProperty(Result.prototype, "fieldName", {
                    get: function () {
                        return this._fieldName;
                    },
                    enumerable: true,
                    configurable: true
                });
                Object.defineProperty(Result.prototype, "results", {
                    get: function () {
                        return this._results;
                    },
                    enumerable: true,
                    configurable: true
                });
                Object.defineProperty(Result.prototype, "errorMessages", {
                    get: function () {
                        return this._errorMessages;
                    },
                    enumerable: true,
                    configurable: true
                });
                return Result;
            })();
            Validation.Result = Result;
            var ValidModel = (function (_super) {
                __extends(ValidModel, _super);
                function ValidModel(options) {
                    _super.call(this, options);
                    this._showNotifications = true;
                    this.errorMessages = {};
                    this.errCount = 0;
                    this._isValid = true;
                }
                Object.defineProperty(ValidModel.prototype, "showNotifications", {
                    get: function () {
                        return this._showNotifications;
                    },
                    set: function (value) {
                        this._showNotifications = value;
                    },
                    enumerable: true,
                    configurable: true
                });
                Object.defineProperty(ValidModel.prototype, "isValid", {
                    get: function () {
                        return this._isValid;
                    },
                    set: function (value) {
                        this._isValid = value;
                    },
                    enumerable: true,
                    configurable: true
                });
                ValidModel.prototype.addErrorMessage = function (id, errorMessage) {
                    this.errCount++;
                    this.errorMessages[id] = errorMessage;
                };
                ValidModel.prototype.clearErrorMessages = function () {
                    this.errCount = 0;
                    this.errorMessages = {};
                };
                ValidModel.prototype.addMultipleErrorMessages = function (errors) {
                    this.errCount += _.size(errors);
                    $.extend(this.errorMessages, errors);
                };
                ValidModel.prototype.addResult = function (result) {
                    if (!result.isValid) {
                        this.addMultipleErrorMessages(result.errorMessages);
                    }
                    return result.isValid;
                };
                ValidModel.prototype.getErrorCount = function () {
                    return this.errCount;
                };
                ValidModel.prototype.getErrorMessages = function () {
                    return this.errorMessages;
                };
                ValidModel.prototype.validateOnChange = function () {
                    var bRet = true;
                    bRet = this.validateOnAction(Validation.Level.Change);
                    return bRet;
                };
                ValidModel.prototype.validateOnAction = function (action) {
                    var bRet = true;
                    Validation.Engine.setAction(action);
                    GenericWorkflowDesigner.Settings.notification.ClearNotifications();
                    if (ProcessDesigner.ValidateBPF.shouldValidate()) {
                        Validation.Engine.setFromPropertyPage((Validation.Engine.getAction() == Validation.Level.Apply) || (Validation.Engine.getAction() == Validation.Level.Change));
                        if (Validation.Engine.isFromPropertyPage()) {
                            Validation.Engine.setAction(Validation.Engine.getLastAction());
                        }
                        bRet = this.validateActivity();
                        if (Validation.Engine.isFromPropertyPage()) {
                            Validation.Errors.updateTileErrorStatus((action == Validation.Level.Apply));
                        }
                        if (bRet) {
                            if (Validation.Engine.getLastAction() == Validation.Level.Save && Validation.Errors.getCount() == 0) {
                                Validation.Engine.resetLastAction();
                            }
                        }
                        Validation.Engine.setFromPropertyPage(false);
                    }
                    Validation.Engine.resetAction();
                    return bRet;
                };
                ValidModel.prototype.validateActivity = function () {
                    this.clearErrorMessages();
                    this._isValid = this._validateActivity();
                    return this._isValid;
                };
                ValidModel.prototype._validateActivity = function () {
                    throw new Error('Not implemented exception');
                };
                ValidModel.prototype.validateChildren = function (children) {
                    for (var i = 0; i < children.length; i++) {
                        var child = children[i];
                        this._isValid = child.validateActivity() && this._isValid;
                        child.showNotifications = false;
                    }
                    return this._isValid;
                };
                return ValidModel;
            })(Backbone.Model);
            Validation.ValidModel = ValidModel;
        })(Validation = ProcessDesigner.Validation || (ProcessDesigner.Validation = {}));
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
//---------------------------------------------------------------------------------------------
// <copyright file="MetadataProxy.ts" company="Microsoft">
// Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
//
// <summary>
// Proxy to MetadataProvider
// </summary>
//---------------------------------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        var AttributeType = MscrmControls.ProcessDesigner.AttributeType;
        var ConditionOperator = MscrmControls.ProcessDesigner.ConditionOperator;
        var MetadataProxy = (function () {
            function MetadataProxy(options) {
                MetadataProxy.PicklistMap = null;
                MetadataProxy.DependentPicklistMap = null;
                MetadataProxy.SourceAttributesMap = null;
                MetadataProxy.SourceValueToEntityMap = null;
            }
            MetadataProxy.getAttributeList = function (entityLogicalName) {
                var promise = null;
                if (MetadataProxy.SourceAttributesMap == null || MetadataProxy.SourceAttributesMap[entityLogicalName] == null) {
                    promise = $.Deferred(function (d) {
                        ProcessDesigner.MetadataProvider.getAttributeMetadata(entityLogicalName, d.resolve, d.reject);
                    }).promise();
                    promise.done(function (attributeList) {
                        if (MetadataProxy.SourceAttributesMap == null) {
                            MetadataProxy.SourceAttributesMap = {};
                        }
                        _.each(attributeList, function (value) {
                            if (MetadataProxy.SourceAttributesMap[entityLogicalName] == null) {
                                MetadataProxy.SourceAttributesMap[entityLogicalName] = {};
                            }
                            if (!MetadataProxy.IsAttributeNotAllowed(value.logicalName)) {
                                MetadataProxy.SourceAttributesMap[entityLogicalName][value.logicalName] = value;
                            }
                        });
                    });
                }
                else {
                    var deferred = $.Deferred();
                    deferred.resolve(MetadataProxy.SourceAttributesMap[entityLogicalName]);
                    promise = deferred.promise();
                }
                return promise;
            };
            MetadataProxy.getStepAttributeMetadata = function (entityLogicalName) {
                var promise = null;
                if (MetadataProxy.DependentPicklistMap == null || MetadataProxy.DependentPicklistMap[entityLogicalName] == null) {
                    promise = $.Deferred(function (d) {
                        ProcessDesigner.MetadataProvider.getStepAttributeMetadata(entityLogicalName, d.resolve, d.reject);
                    }).promise();
                    promise.done(function (attributeList) {
                        if (MetadataProxy.DependentPicklistMap == null) {
                            MetadataProxy.DependentPicklistMap = {};
                        }
                        _.each(attributeList, function (value) {
                            if (MetadataProxy.DependentPicklistMap[entityLogicalName] == null) {
                                MetadataProxy.DependentPicklistMap[entityLogicalName] = {};
                            }
                            if (!MetadataProxy.IsAttributeNotAllowed(value.logicalName)) {
                                MetadataProxy.DependentPicklistMap[entityLogicalName][value.logicalName] = value;
                            }
                        });
                    });
                }
                else {
                    var deferred = $.Deferred();
                    deferred.resolve(MetadataProxy.DependentPicklistMap[entityLogicalName]);
                    promise = deferred.promise();
                }
                return promise;
            };
            MetadataProxy.IsAttributeNotAllowed = function (attrLogicalName) {
                var invalidBPFAttributes = ["fullname",
                    "yomifullname",
                    "address1_composite",
                    "address2_composite",
                    "shipto_composite",
                    "billto_composite"];
                return (invalidBPFAttributes.indexOf(attrLogicalName) > -1);
            };
            MetadataProxy.getAttributeListForSource = function (entityLogicalName) {
            };
            MetadataProxy.getSourcesList = function () {
                var sourcesList = MscrmControls.ProcessDesigner.MetadataProvider.getLoadedRelationshipEntityMetadata().slice(0, MscrmControls.ProcessDesigner.MetadataProvider.getLoadedRelationshipEntityMetadata().length);
                if (MetadataProxy.SourceValueToEntityMap == null) {
                    MetadataProxy.SourceValueToEntityMap = {};
                    MetadataProxy.SourceValueToEntityMap[MscrmControls.ProcessDesigner.primaryEntity] = new Microsoft.Crm.Workflow.Expressions.PrimaryEntity(MscrmControls.ProcessDesigner.processStep);
                    sourcesList.forEach(function (relationshipMetadata) {
                        if (typeof (relationshipMetadata) != "string") {
                            MetadataProxy.SourceValueToEntityMap[relationshipMetadata.RelationshipName] = new Microsoft.Crm.Workflow.Expressions.RelatedEntityLinked(MscrmControls.ProcessDesigner.processStep, relationshipMetadata.RelationshipAttribute.LogicalName, relationshipMetadata.RelationshipEntity.EntityLogicalName, relationshipMetadata.RelationshipName);
                        }
                    });
                }
                return sourcesList;
            };
            MetadataProxy.getAttributeListByDataType = function (entityLogicalName, dataType) {
                var deferred = $.Deferred();
                if (MetadataProxy.SourceAttributesMap == null || MetadataProxy.SourceAttributesMap[entityLogicalName] == null) {
                    MetadataProxy.getAttributeList(entityLogicalName).then(function (attributeList) {
                        if (MetadataProxy.SourceAttributesMap == null) {
                            MetadataProxy.SourceAttributesMap = {};
                        }
                        var attrList = [];
                        _.each(attributeList, function (value) {
                            if (MetadataProxy.SourceAttributesMap[entityLogicalName] == null) {
                                MetadataProxy.SourceAttributesMap[entityLogicalName] = {};
                            }
                            MetadataProxy.SourceAttributesMap[entityLogicalName][value.logicalName] = value;
                            if (value.attributeType == dataType) {
                                attrList.push(value);
                            }
                        });
                        deferred.resolve(attrList);
                    });
                }
                else {
                    var attrList = [];
                    for (var attributeName in MetadataProxy.SourceAttributesMap[entityLogicalName]) {
                        if (MetadataProxy.SourceAttributesMap[entityLogicalName][attributeName].attributeType == dataType) {
                            attrList.push(MetadataProxy.SourceAttributesMap[entityLogicalName][attributeName]);
                        }
                    }
                    deferred.resolve(attrList);
                }
                return deferred.promise();
            };
            MetadataProxy.getPickListValues = function (entityLogicalName, attributeLogicalName) {
                var promise = null;
                if (MetadataProxy.PicklistMap == null || attributeLogicalName === entityLogicalName || !MetadataProxy.PicklistMap[attributeLogicalName]) {
                    promise = $.Deferred(function (d) {
                        ProcessDesigner.MetadataProvider.getPickListValues(entityLogicalName, [attributeLogicalName], d.resolve, d.reject);
                    }).promise();
                    promise.done(function (pickList) {
                        if (!MetadataProxy.PicklistMap) {
                            MetadataProxy.PicklistMap = {};
                        }
                        MetadataProxy.PicklistMap[attributeLogicalName] = pickList;
                    });
                }
                else {
                    var deferred = $.Deferred();
                    deferred.resolve(MetadataProxy.PicklistMap[attributeLogicalName]);
                    promise = deferred.promise();
                }
                return promise;
            };
            MetadataProxy.getDependentPickListParentLogicalName = function (entityLogicalName, attributeLogicalName) {
                if (MetadataProxy.DependentPicklistMap && MetadataProxy.DependentPicklistMap[entityLogicalName] && MetadataProxy.DependentPicklistMap[entityLogicalName][attributeLogicalName]) {
                    return MetadataProxy.DependentPicklistMap[entityLogicalName][attributeLogicalName].parentPicklistLogicalName;
                }
                return "null";
            };
            MetadataProxy.getDependentPickListChildLogicalName = function (entityLogicalName, attributeLogicalName) {
                if (MetadataProxy.DependentPicklistMap && MetadataProxy.DependentPicklistMap[entityLogicalName] && MetadataProxy.DependentPicklistMap[entityLogicalName][attributeLogicalName]) {
                    return MetadataProxy.DependentPicklistMap[entityLogicalName][attributeLogicalName].childPicklistLogicalNames;
                }
                return "null";
            };
            MetadataProxy.getOperatorList = function (typeName) {
                return ProcessDesigner.MetadataProvider.getOperatorList(AttributeType[typeName]);
            };
            MetadataProxy.getFormulaOperators = function (typeName) {
                var ret = null;
                switch (typeName) {
                    case AttributeType.Double:
                    case AttributeType.Integer:
                    case AttributeType.BigInt:
                    case AttributeType.Decimal:
                    case AttributeType.Money:
                        ret = [{ name: '+', value: 0 }, { name: '-', value: 1 }, { name: '*', value: 2 }, { name: '/', value: 3 }];
                        break;
                    case AttributeType.DateTime:
                        ret = [{ name: '+', value: 0 }, { name: '-', value: 1 }];
                        break;
                }
                return ret;
            };
            MetadataProxy.getLocalizedString = function (inputString) {
                return ProcessDesigner.MetadataProvider.getLocalizedString(inputString);
            };
            MetadataProxy.isUnaryOperator = function (operatorName) {
                return ProcessDesigner.MetadataProvider.isUnaryOperator(operatorName);
            };
            MetadataProxy.isFormulaValidForAttributeType = function (attributeType) {
                return ProcessDesigner.MetadataProvider.isFormulaValidForAttributeType(attributeType);
            };
            MetadataProxy.getNumericAttributesList = function (entityLogicalName) {
                var deferred = $.Deferred();
                if (MetadataProxy.SourceAttributesMap == null || MetadataProxy.SourceAttributesMap[entityLogicalName] == null) {
                    MetadataProxy.getAttributeList(entityLogicalName).then(function (attributeList) {
                        if (MetadataProxy.SourceAttributesMap == null) {
                            MetadataProxy.SourceAttributesMap = {};
                        }
                        var attrList = [];
                        _.each(attributeList, function (value) {
                            if (MetadataProxy.SourceAttributesMap[entityLogicalName] == null) {
                                MetadataProxy.SourceAttributesMap[entityLogicalName] = {};
                            }
                            MetadataProxy.SourceAttributesMap[entityLogicalName][value.logicalName] = value;
                            if (MetadataProxy.isNumericField(value.logicalName, entityLogicalName)) {
                                attrList.push(value);
                            }
                        });
                        deferred.resolve(attrList);
                    });
                }
                else {
                    var attrList = [];
                    for (var attributeName in MetadataProxy.SourceAttributesMap[entityLogicalName]) {
                        if (MetadataProxy.isNumericField(attributeName, entityLogicalName)) {
                            attrList.push(MetadataProxy.SourceAttributesMap[entityLogicalName][attributeName]);
                        }
                    }
                    deferred.resolve(attrList);
                }
                return deferred.promise();
            };
            MetadataProxy.getTextAttributesList = function (entityLogicalName) {
                var deferred = $.Deferred();
                if (MetadataProxy.SourceAttributesMap == null || MetadataProxy.SourceAttributesMap[entityLogicalName] == null) {
                    MetadataProxy.getAttributeList(entityLogicalName).then(function (attributeList) {
                        if (MetadataProxy.SourceAttributesMap == null) {
                            MetadataProxy.SourceAttributesMap = {};
                        }
                        var attrList = [];
                        _.each(attributeList, function (value) {
                            if (MetadataProxy.SourceAttributesMap[entityLogicalName] == null) {
                                MetadataProxy.SourceAttributesMap[entityLogicalName] = {};
                            }
                            MetadataProxy.SourceAttributesMap[entityLogicalName][value.logicalName] = value;
                            if (value.attributeType == AttributeType.String) {
                                attrList.push(value);
                            }
                        });
                        deferred.resolve(attrList);
                    });
                }
                else {
                    var attrList = [];
                    for (var attributeName in MetadataProxy.SourceAttributesMap[entityLogicalName]) {
                        if (MetadataProxy.SourceAttributesMap[entityLogicalName][attributeName].attributeType == AttributeType.String) {
                            attrList.push(MetadataProxy.SourceAttributesMap[entityLogicalName][attributeName]);
                        }
                    }
                    deferred.resolve(attrList);
                }
                return deferred.promise();
            };
            MetadataProxy.getComparableAttributes = function (entityLogicalName, attributeLogicalName, targetEntityLogicalName, operatorType) {
                var attributeType = MetadataProxy.SourceAttributesMap[entityLogicalName][attributeLogicalName].attributeType;
                if (MetadataProxy.isNumericField(attributeLogicalName, entityLogicalName)) {
                    return MetadataProxy.getNumericAttributesList(targetEntityLogicalName);
                }
                else if (attributeType == AttributeType.String) {
                    return MetadataProxy.getTextAttributesList(targetEntityLogicalName);
                }
                else if (!CommonTypes.Types.String.isNullOrEmpty(operatorType)
                    && (MetadataProxy.LookupAttributeTypes.indexOf(attributeType) > -1 || MetadataProxy.StatusAttributeTypes.indexOf(attributeType) > -1)
                    && this.isUniversalStringOperator(operatorType)) {
                    return MetadataProxy.getTextAttributesList(targetEntityLogicalName);
                }
                else if (MetadataProxy.LookupAttributeTypes.indexOf(attributeType) > -1) {
                    return MetadataProxy.getLookupAttributesList(targetEntityLogicalName, attributeType);
                }
                else {
                    return MetadataProxy.getAttributeListByDataType(targetEntityLogicalName, attributeType);
                }
            };
            MetadataProxy.getLookupAttributesList = function (entityLogicalName, dataType) {
                var deferred = $.Deferred();
                if (MetadataProxy.SourceAttributesMap == null || MetadataProxy.SourceAttributesMap[entityLogicalName] == null) {
                    MetadataProxy.getAttributeList(entityLogicalName).then(function (attributeList) {
                        if (MetadataProxy.SourceAttributesMap == null) {
                            MetadataProxy.SourceAttributesMap = {};
                        }
                        var attrList = [];
                        _.each(attributeList, function (value) {
                            if (MetadataProxy.SourceAttributesMap[entityLogicalName] == null) {
                                MetadataProxy.SourceAttributesMap[entityLogicalName] = {};
                            }
                            MetadataProxy.SourceAttributesMap[entityLogicalName][value.logicalName] = value;
                            if (dataType != AttributeType.Owner && MetadataProxy.LookupAttributeTypes.indexOf(value.attributeType) > -1) {
                                attrList.push(value);
                            }
                            else if (MetadataProxy.LookupAttributeTypes.indexOf(value.attributeType) > -1) {
                                if (value.attributeType == AttributeType.Lookup) {
                                    if (value.lookupTypes == AttributeType.Owner) {
                                        attrList.push(value);
                                    }
                                }
                                else {
                                    attrList.push(value);
                                }
                            }
                        });
                        deferred.resolve(attrList);
                    });
                }
                else {
                    var attrList = [];
                    for (var attributeName in MetadataProxy.SourceAttributesMap[entityLogicalName]) {
                        if (dataType != AttributeType.Owner && MetadataProxy.LookupAttributeTypes.indexOf(MetadataProxy.SourceAttributesMap[entityLogicalName][attributeName].attributeType) > -1) {
                            attrList.push(MetadataProxy.SourceAttributesMap[entityLogicalName][attributeName]);
                        }
                        else if (MetadataProxy.LookupAttributeTypes.indexOf(MetadataProxy.SourceAttributesMap[entityLogicalName][attributeName].attributeType) > -1) {
                            if (MetadataProxy.SourceAttributesMap[entityLogicalName][attributeName].attributeType == AttributeType.Lookup) {
                                if (MetadataProxy.SourceAttributesMap[entityLogicalName][attributeName].lookupTypes == AttributeType.Owner) {
                                    attrList.push(MetadataProxy.SourceAttributesMap[entityLogicalName][attributeName]);
                                }
                            }
                            else {
                                attrList.push(MetadataProxy.SourceAttributesMap[entityLogicalName][attributeName]);
                            }
                        }
                    }
                    deferred.resolve(attrList);
                }
                return deferred.promise();
            };
            MetadataProxy.isTextField = function (attributeName, entityLogicalName, operatorName) {
                var attributeType = MetadataProxy.SourceAttributesMap[entityLogicalName][attributeName].attributeType;
                var operatorType = ConditionOperator[operatorName];
                switch (attributeType) {
                    case AttributeType.Picklist:
                    case AttributeType.State:
                    case AttributeType.Status:
                    case AttributeType.Lookup:
                    case AttributeType.Owner:
                    case AttributeType.Customer:
                        switch (operatorType) {
                            case ConditionOperator.Contains:
                            case ConditionOperator.DoesNotContain:
                            case ConditionOperator.BeginsWith:
                            case ConditionOperator.DoesNotBeginWith:
                            case ConditionOperator.EndsWith:
                            case ConditionOperator.DoesNotEndWith:
                                return true;
                            default:
                                return false;
                        }
                    case AttributeType.DateTime:
                    case AttributeType.Boolean:
                        return false;
                    default:
                        return true;
                }
            };
            MetadataProxy.isTextFieldNoOp = function (attributeName, entityLogicalName) {
                var attributeType = MetadataProxy.SourceAttributesMap[entityLogicalName][attributeName].attributeType;
                switch (attributeType) {
                    case AttributeType.Picklist:
                    case AttributeType.DateTime:
                    case AttributeType.State:
                    case AttributeType.Status:
                    case AttributeType.Boolean:
                    case AttributeType.Lookup:
                    case AttributeType.Owner:
                    case AttributeType.Customer:
                        return false;
                    default:
                        return true;
                }
            };
            MetadataProxy.isNumericField = function (attributeName, entityLogicalName) {
                var attributeType = MetadataProxy.SourceAttributesMap[entityLogicalName][attributeName].attributeType;
                switch (attributeType) {
                    case AttributeType.BigInt:
                    case AttributeType.Decimal:
                    case AttributeType.Double:
                    case AttributeType.Integer:
                    case AttributeType.Money:
                        return true;
                    default:
                        return false;
                }
            };
            MetadataProxy.isDependentOptionSetField = function (entityLogicalName, attributeName) {
                if (MetadataProxy.DependentPicklistMap && MetadataProxy.DependentPicklistMap[entityLogicalName] && MetadataProxy.DependentPicklistMap[entityLogicalName][attributeName]
                    && (MetadataProxy.DependentPicklistMap[entityLogicalName][attributeName].parentPicklistLogicalName
                        || MetadataProxy.DependentPicklistMap[entityLogicalName][attributeName].childPicklistLogicalNames)) {
                    return true;
                }
                else {
                    return false;
                }
            };
            MetadataProxy.isEnumeratedField = function (attributeName, entityLogicalName) {
                var attributeType = MetadataProxy.SourceAttributesMap[entityLogicalName][attributeName].attributeType;
                switch (attributeType) {
                    case AttributeType.Picklist:
                    case AttributeType.State:
                    case AttributeType.Status:
                    case AttributeType.Boolean:
                        return true;
                    default:
                        return false;
                }
            };
            MetadataProxy.getPicklistValueNames = function (attributeName, pickListOptionOrderList) {
                if (!MetadataProxy.PicklistMap || !MetadataProxy.PicklistMap[attributeName]) {
                    return pickListOptionOrderList;
                }
                var picklistValues = MetadataProxy.PicklistMap[attributeName];
                var pickListValueNames = [];
                _.each(pickListOptionOrderList, function (id) {
                    _.some(picklistValues, function (value) {
                        if (value.pickListValueOrderId == id) {
                            pickListValueNames.push(value.pickListValue);
                            return true;
                        }
                    });
                });
                return pickListValueNames;
            };
            MetadataProxy.getAttributeType = function (attributeLogicalName, entityLogicalName) {
                if (MetadataProxy.SourceAttributesMap && MetadataProxy.SourceAttributesMap[entityLogicalName] && MetadataProxy.SourceAttributesMap[entityLogicalName][attributeLogicalName]) {
                    return MetadataProxy.SourceAttributesMap[entityLogicalName][attributeLogicalName].attributeType;
                }
                return AttributeType.Unknown;
            };
            MetadataProxy.dispose = function () {
                MetadataProxy.SourceAttributesMap = {};
                MetadataProxy.PicklistMap = [];
            };
            MetadataProxy.getDisplayFieldName = function (entityName) {
                var displayFieldName = "name";
                switch (entityName) {
                    case "systemuser":
                        displayFieldName = "fullname";
                        break;
                }
                return displayFieldName;
            };
            MetadataProxy.isUniversalStringOperator = function (operator) {
                return (this.UniversalStringOperators.indexOf(operator) > -1);
            };
            MetadataProxy.UniversalStringOperators = [ConditionOperator.Contains, ConditionOperator.DoesNotContain, ConditionOperator.BeginsWith, ConditionOperator.DoesNotBeginWith, ConditionOperator.EndsWith, ConditionOperator.DoesNotEndWith];
            MetadataProxy.LookupAttributeTypes = [AttributeType.Lookup, AttributeType.Customer, AttributeType.Owner];
            MetadataProxy.StatusAttributeTypes = [AttributeType.State, AttributeType.Status];
            return MetadataProxy;
        })();
        ProcessDesigner.MetadataProxy = MetadataProxy;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
//---------------------------------------------------------------------------------------------
// <copyright file="Util.ts" company="Microsoft">
//		Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
//
// <summary>
// Provides utilities to read/write members to Object.
// </summary>
//---------------------------------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        var Utility = _Microsoft.Client.Telemetry.Utility;
        var Dictionary = (function () {
            function Dictionary() {
            }
            return Dictionary;
        })();
        ProcessDesigner.Dictionary = Dictionary;
        var ValidationResult = (function () {
            function ValidationResult(field) {
                this.field = field;
                this.isValid = false;
                this.errors = [];
            }
            ValidationResult.prototype.success = function () {
                this.isValid = true;
                return this;
            };
            ValidationResult.prototype.failure = function (err) {
                this.errors.push(err);
                this.isValid = false;
                return this;
            };
            ValidationResult.prototype.addError = function (err) {
                this.errors.push(err);
                this.isValid = false;
                return this;
            };
            return ValidationResult;
        })();
        ProcessDesigner.ValidationResult = ValidationResult;
        var Util = (function () {
            function Util() {
            }
            Util.isNull = function (obj) {
                return _.isNull(obj) || _.isUndefined(obj);
            };
            Util.isEmptyString = function (obj) {
                var ret = false;
                if (!Util.isNull(obj) && _.isString(obj)) {
                    ret = (obj.trim().length == 0);
                }
                return ret;
            };
            Util.getValue_ = function (options, key) {
                var val = null;
                try {
                    if (!Util.isNull(options) && !Util.isNull(key)) {
                        val = options[key];
                    }
                }
                catch (e) {
                }
                return val;
            };
            Util.getValue = function (options, key, defaultVal) {
                var val = defaultVal;
                var val_ = Util.getValue_(options, key);
                if (!Util.isNull(val_)) {
                    val = val_;
                }
                return val;
            };
            Util.getStringValue = function (options, key, defaultVal) {
                var val = defaultVal;
                var val_ = Util.getValue_(options, key);
                if (!Util.isNull(val_) && _.isString(val_)) {
                    val = val_.toString();
                }
                return val;
            };
            Util.getNumberValue = function (options, key, defaultVal) {
                var val = defaultVal;
                var val_ = Util.getValue_(options, key);
                if (!Util.isNull(val_) && _.isNumber(val_)) {
                    val = val_;
                }
                return val;
            };
            Util.getIntValue = function (options, key, defaultVal) {
                var val = defaultVal;
                var val_ = Util.getValue_(options, key);
                if (!Util.isNull(val_) && _.isNumber(val_) && Math.floor(val_) == val_) {
                    val = val_;
                }
                return val;
            };
            Util.getBooleanValue = function (options, key, defaultVal) {
                var val = defaultVal;
                var val_ = Util.getValue_(options, key);
                if (!Util.isNull(val_) && _.isBoolean(val_)) {
                    val = val_;
                }
                return val;
            };
            Util.tabIndexValue = 0;
            return Util;
        })();
        ProcessDesigner.Util = Util;
        var DOMUtil = (function () {
            function DOMUtil() {
            }
            DOMUtil.addErrorStatus = function (el) {
                el.css({ "border-width": "1px", "border-style": "solid", "border-color": "red" });
            };
            DOMUtil.removeErrorStatus = function (el) {
                el.css({ "border-width": "", "border-style": "", "border-color": "" });
            };
            DOMUtil.getIgnoredFields = function (model) {
                var iFields = new Array();
                if (model.ignoredFields) {
                    iFields = model.ignoredFields;
                }
                return iFields;
            };
            DOMUtil.clearIgnoredFields = function (model) {
                if (model.clearIgnoredFields) {
                    model.clearIgnoredFields();
                }
            };
            DOMUtil.removeErrorMessages = function (el, labelClass, errorElementClass) {
                el.find('.' + labelClass).remove();
                var elems = el.find('.' + errorElementClass);
                if (errorElementClass == 'errorElementGlobal') {
                    $("#propertyTab").parent("li").removeAttr('title');
                }
                for (var i = 0; i < elems.length; i++) {
                    var elem = $(elems[i]);
                    elem.css({ "border-width": "", "border-style": "", "border-color": "" });
                    elem.removeClass('.' + errorElementClass);
                    var marginBottom = elem.attr('data-margin-bottom');
                    if (marginBottom) {
                        elem.css('margin-bottom', marginBottom);
                        elem.removeAttr('data-margin-bottom');
                    }
                    else {
                        elem.removeAttr('margin-bottom');
                    }
                }
            };
            DOMUtil._renderErrorMessages = function (model, el, labelClass, errorElementClass, errors) {
                var iFields = DOMUtil.getIgnoredFields(model);
                for (var id in errors) {
                    if (iFields.indexOf(id) == -1) {
                        var error = errors[id];
                        var errorIconMessage = ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_ErrorOn_Prefix");
                        var elem = el.find(id);
                        if (elem && error) {
                            if (errorElementClass != 'errorElementGlobal') {
                                elem.css({ "border-width": "1px", "border-style": "solid", "border-color": "#BF0900" });
                            }
                            elem.addClass(errorElementClass);
                            var marginBottom = elem.css('margin-bottom');
                            elem.css('margin-bottom', '0px');
                            if (marginBottom && marginBottom.length > 0) {
                                elem.attr('data-margin-bottom', marginBottom);
                                marginBottom = 'margin-bottom:' + marginBottom + ';';
                            }
                            else {
                                marginBottom = 'margin-bottom: 15px;';
                            }
                            if (errorElementClass == 'errorElementGlobal') {
                                elem.after("<div  aria-live='assertive' aria-atomic='true' aria-relevant='all' aria-label=\"" + errorIconMessage + error + "\" id='" + labelId + "' class='" + labelClass + "' style='" + marginBottom + "'><table class= 'validationLabel errorLabel'><tr><td><span class= 'validationLabel errorLabel validationSymbol errorSymbol' aria-label=\"" + errorIconMessage + "\" title=\"" + errorIconMessage + "\" ></span></td><td><span class='validationMessage errorMessage' aria-label=\"" + error + "\"  title=\"" + error + "\" >" + error + "</span></td></tr></table></div>");
                                $("#propertyTab").parent("li").attr("title", error);
                            }
                            else {
                                var labelId = Utility.newGuid();
                                elem.after("<div  aria-live='assertive' aria-atomic='true' aria-relevant='all' aria-label=\"" + errorIconMessage + error + "\" id='" + labelId + "' class='" + labelClass + "' style='" + marginBottom + "'><table class= 'validationLabel errorLabel'><tr><td><span class= 'validationLabel errorLabel validationSymbol errorSymbol' aria-label=\"" + errorIconMessage + "\" title=\"" + errorIconMessage + "\" ></span></td><td><span class='validationMessage errorMessage' aria-label=\"" + error + "\"  title=\"" + error + "\" >" + error + "</span></td></tr></table></div>");
                                $(elem).attr("aria-describedby", labelId);
                                var lookupInputString = elem.find("#lookupInput");
                                if (lookupInputString) {
                                    lookupInputString.attr("aria-labelledby", "ActionStepPropertyDetails_ListOfActions " + labelId + " lookupIcon actionSelectionNoteSpan");
                                }
                                var lookupContainerdivString = elem.find("#lookupContainerDiv");
                                if (lookupContainerdivString) {
                                    lookupContainerdivString.attr("aria-labelledby", "ActionStepPropertyDetails_ListOfActions selectedItemLabel " + labelId + " lookupIcon actionSelectionNoteSpan");
                                }
                            }
                        }
                    }
                }
                DOMUtil.clearIgnoredFields(model);
            };
            DOMUtil._renderWarningMessages = function (model, el, labelClass, warningElementClass, warnings) {
                var iFields = DOMUtil.getIgnoredFields(model);
                for (var id in warnings) {
                    if (iFields.indexOf(id) == -1) {
                        var warning = warnings[id];
                        var warningIconMessage = ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("LOCID_PROCESS_CLOSEWARNINGALT");
                        var elem = el.find(id);
                        if (elem && warning) {
                            elem.addClass(warningElementClass);
                            var marginBottom = elem.css('margin-bottom');
                            elem.css('margin-bottom', '10px');
                            if (marginBottom && marginBottom.length > 0) {
                                elem.attr('data-margin-bottom', marginBottom);
                                marginBottom = 'margin-bottom:' + marginBottom + ';';
                            }
                            else {
                                marginBottom = 'margin-bottom: 15px;';
                            }
                            var labelId = Utility.newGuid();
                            elem.parent().children().last().after("<div  aria-live='assertive' aria-atomic='true' aria-relevant='all' aria-label=\"" + warningIconMessage + warning + "\" id='" + labelId + "' class='" + labelClass + "' style='" + marginBottom + "'><table class= 'validationLabel warningLabel'><tr><td><span class= 'validationLabel warningLabel validationSymbol warningSymbol' aria-label=\"" + warningIconMessage + "\" title=\"" + warningIconMessage + "\" ></span></td><td><span class='validationMessage warningMessage' aria-label=\"" + warning + "\"  title=\"" + warning + "\" >" + warning + "</span></td></tr></table></div>");
                            $(elem).attr("aria-describedby", labelId);
                        }
                    }
                }
                DOMUtil.clearIgnoredFields(model);
            };
            DOMUtil.renderErrorMessages = function (model, el, errors) {
                DOMUtil.removeErrorMessages(el, 'errorLabel', 'errorElement');
                DOMUtil._renderErrorMessages(model, el, 'errorLabel', 'errorElement', errors);
            };
            DOMUtil.renderWarningMessages = function (model, el, warnings) {
                DOMUtil.removeErrorMessages(el, 'warningLabel', 'warningElement');
                DOMUtil._renderWarningMessages(model, el, 'warningLabel', 'warningElement', warnings);
            };
            DOMUtil.renderPropertyPageLevelErrorMessages = function (model, el, errors) {
                DOMUtil.removeErrorMessages(el, 'errorLabelGlobal', 'errorElementGlobal');
                DOMUtil._renderErrorMessages(model, el, 'errorLabelGlobal', 'errorElementGlobal', errors);
            };
            return DOMUtil;
        })();
        ProcessDesigner.DOMUtil = DOMUtil;
        var ValidationErrorCodes = (function () {
            function ValidationErrorCodes() {
            }
            ValidationErrorCodes.ValidationErrorCodesMappings = {
                "-2147200941": "Error_Message_0x80045053",
                "-2147089399": "Error_Message_0x80045054",
                "-2147200939": "Error_Message_0x80045055",
                "-2147200938": "Error_Message_0x80045056",
                "-2147200937": "Error_Message_0x80045057",
                "-2147200936": "Error_Message_0x80045058",
                "-2147200935": "Error_Message_0x80045059",
                "-2147089535": "Error_Message_0x80060381"
            };
            return ValidationErrorCodes;
        })();
        ProcessDesigner.ValidationErrorCodes = ValidationErrorCodes;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
//---------------------------------------------------------------------------------------------
// <copyright file="Rules.ts" company="Microsoft">
//		Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
//
// <summary>
// Defines all interfaces/classes required for validation rules. 
// </summary>
//---------------------------------------------------------------------------------------------
/// <reference path="./IValid.ts"/>
/// <reference path="./Util.ts"/>
/// <reference path="./AttributeTypes.ts"/>
/// <reference path="./MetaDataProxy.ts"/>
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        var Validation;
        (function (Validation) {
            var AttributeType = MscrmControls.ProcessDesigner.AttributeType;
            var Result = MscrmControls.ProcessDesigner.Validation.Result;
            var Util = MscrmControls.ProcessDesigner.Util;
            var MetadataProxy = MscrmControls.ProcessDesigner.MetadataProxy;
            var Rules = (function () {
                function Rules() {
                }
                return Rules;
            })();
            Validation.Rules = Rules;
            var BaseRule = (function () {
                function BaseRule() {
                }
                BaseRule.createResult = function (bRes, message) {
                    var res = new Validation.SingleResult();
                    res.set(bRes, message);
                    return res;
                };
                return BaseRule;
            })();
            Validation.BaseRule = BaseRule;
            var Verify = (function () {
                function Verify() {
                }
                Verify.isNull = function (obj) {
                    return Util.isNull(obj);
                };
                Verify.empty = function (val) {
                    var bRet = false;
                    if (_.isString(val)) {
                        bRet = (val.trim().length == 0);
                    }
                    else if (_.isArray(val)) {
                        bRet = (val.length == 0);
                    }
                    else {
                        bRet = (_.size(val) == 0);
                    }
                    return bRet;
                };
                Verify.isTrue = function (val) {
                    return val == true;
                };
                Verify.integer = function (val) {
                    return $.isNumeric(val) && Math.floor(val) == val;
                };
                Verify.max = function (val, max) {
                    return val <= max;
                };
                Verify.min = function (val, min) {
                    return min <= val;
                };
                Verify.range = function (val, max, min) {
                    return Verify.min(val, min) && Verify.max(val, max);
                };
                return Verify;
            })();
            Validation.Verify = Verify;
            var MaxLength = (function (_super) {
                __extends(MaxLength, _super);
                function MaxLength() {
                    _super.apply(this, arguments);
                }
                MaxLength.apply = function (value, options) {
                    var maxLength = Util.getIntValue(options, 'maxLength', 2000);
                    var bRes = Verify.max(value.length, maxLength);
                    var message = ProcessDesigner.MetadataProvider.getLocalizedString("ProcessDesignerControl_PBL_Length_Exceeded");
                    return BaseRule.createResult(bRes, message);
                };
                return MaxLength;
            })(BaseRule);
            Validation.MaxLength = MaxLength;
            var Required = (function (_super) {
                __extends(Required, _super);
                function Required() {
                    _super.apply(this, arguments);
                }
                Required.apply = function (value, options) {
                    var bRes = !Verify.isNull(value) && !Verify.empty(value);
                    var message = ProcessDesigner.MetadataProvider.getLocalizedString("ProcessDesignerControl_PBL_NonEmptyValueMessage");
                    return BaseRule.createResult(bRes, message);
                };
                return Required;
            })(BaseRule);
            Validation.Required = Required;
            var CompleteChain = (function (_super) {
                __extends(CompleteChain, _super);
                function CompleteChain() {
                    _super.apply(this, arguments);
                }
                CompleteChain.apply = function (value, options) {
                    var message = ProcessDesigner.MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_BPFStepActivity_DependentOptionSetField_WarningMessage");
                    var bRes = Verify.isTrue(value);
                    return BaseRule.createResult(bRes, message);
                };
                return CompleteChain;
            })(BaseRule);
            Validation.CompleteChain = CompleteChain;
            var Number_ = (function (_super) {
                __extends(Number_, _super);
                function Number_() {
                    _super.apply(this, arguments);
                }
                Number_.apply = function (value, options) {
                    var bRes = $.isNumeric(value);
                    return BaseRule.createResult(bRes, "");
                };
                return Number_;
            })(BaseRule);
            Validation.Number_ = Number_;
            var NumberFormat = (function (_super) {
                __extends(NumberFormat, _super);
                function NumberFormat() {
                    _super.apply(this, arguments);
                }
                NumberFormat.apply = function (value, options) {
                    var bRet = false;
                    var attributeType = Util.getIntValue(options, 'attributeType', AttributeType.Integer);
                    switch (attributeType) {
                        case AttributeType.BigInt:
                        case AttributeType.Integer:
                            bRet = (Math.floor(value) == value);
                            break;
                        case AttributeType.Double:
                        case AttributeType.Decimal:
                        case AttributeType.Money:
                            bRet = true;
                            break;
                    }
                    return BaseRule.createResult(bRet, "");
                };
                return NumberFormat;
            })(BaseRule);
            Validation.NumberFormat = NumberFormat;
            var Range = (function (_super) {
                __extends(Range, _super);
                function Range() {
                    _super.apply(this, arguments);
                }
                Range.apply = function (value, options) {
                    var maxVal = Util.getIntValue(options, 'maxValue', 2147483647);
                    var minVal = Util.getIntValue(options, 'minValue', -2147483648);
                    var bRet = Verify.range(value, maxVal, minVal);
                    return BaseRule.createResult(bRet, "");
                };
                return Range;
            })(BaseRule);
            Validation.Range = Range;
            var Errors = (function () {
                function Errors() {
                }
                Errors.clearErrors = function () {
                    Errors.errors = {};
                    Errors.errorCount = 0;
                };
                Errors.updateErrors = function (model) {
                    var oldErrCount = Errors.errors[model.cid] ? Errors.errors[model.cid] : 0;
                    Errors.errorCount -= oldErrCount;
                    var newErrCount = model.getErrorCount();
                    Errors.errors[model.cid] = newErrCount;
                    Errors.errorCount += newErrCount;
                };
                Errors.getCount = function () {
                    Errors.errorCount = 0;
                    var activities = GenericWorkflowDesigner.Settings.workflowTree.getActivities();
                    activities.forEach(function (activity) {
                        Errors.errorCount += activity.getErrorCount();
                    });
                    var globalWorkflow = ProcessDesigner.ControlManager.globalWorkflowObject;
                    Errors.errorCount += globalWorkflow.getErrorCount();
                    return Errors.errorCount + GenericWorkflowDesigner.Settings.notification.GetNotifictionCount();
                };
                Errors.updateNotifications = function () {
                    var summaryMessage;
                    var message;
                    var errorCount = Errors.getCount();
                    if (errorCount > 0) {
                        var errorMessage = ProcessDesigner.MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_ValidateBPF_ErrorMessage");
                        if (Engine.getLastAction() == Validation.Level.Save) {
                            errorMessage = ProcessDesigner.MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_ValidateBPF_SaveValidationMessage");
                        }
                        message = CommonTypes.Types.String.Format(errorMessage, errorCount);
                        var ariaLabelMessage = ProcessDesigner.MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_ValidateBPF_ErrorMessageAriaLabelText");
                        ariaLabelMessage = CommonTypes.Types.String.Format(ariaLabelMessage, errorCount);
                        summaryMessage = new GenericWorkflowDesigner.NotificationMessage(GenericWorkflowDesigner.MessageType.Error, message, ariaLabelMessage);
                    }
                    else {
                        message = ProcessDesigner.MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_ValidateBPF_Message");
                        if (Engine.getLastAction() == Validation.Level.Save) {
                            message = ProcessDesigner.MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_ValidateBPF_SaveMessage");
                        }
                        summaryMessage = new GenericWorkflowDesigner.NotificationMessage(GenericWorkflowDesigner.MessageType.Success, message);
                    }
                    GenericWorkflowDesigner.Settings.notification.ShowNotification(summaryMessage, GenericWorkflowDesigner.ValidationMode.Error);
                    return message;
                };
                Errors.registerPropertyViewCurrentModelClone = function (value) {
                    var propertyViewCurrentModel = GenericWorkflowDesigner.PropertyView.getPropertyViewCurrentModel();
                    if (propertyViewCurrentModel) {
                        propertyViewCurrentModel.___internalValidationSetPropertyPageModel(value);
                    }
                };
                Errors._updateTileErrorStatus = function (errorTile) {
                    if (ProcessDesigner.ValidateBPF.shouldValidate()) {
                        if (errorTile.getErrorCount() == 0) {
                            errorTile.isValid = true;
                        }
                        else {
                            errorTile.isValid = false;
                        }
                        Errors.updateErrors(errorTile);
                        Errors.updateNotifications();
                    }
                };
                Errors.updateTileErrorStatus = function (isApply) {
                    var propertyViewCurrentModel = GenericWorkflowDesigner.PropertyView.getPropertyViewCurrentModel();
                    if (propertyViewCurrentModel) {
                        var errorTile = propertyViewCurrentModel.getErrorTile();
                        Errors._updateTileErrorStatus(errorTile);
                    }
                };
                Errors.propertyTabUnloaded = function () {
                    var propertyViewCurrentModel = GenericWorkflowDesigner.PropertyView.getPropertyViewCurrentModel();
                    if (propertyViewCurrentModel) {
                        if (ProcessDesigner.ValidateBPF.shouldValidate()) {
                            var errorTile = propertyViewCurrentModel.getErrorTile();
                            Errors._updateTileErrorStatus(errorTile);
                        }
                    }
                };
                Errors.errorCount = 0;
                Errors.errors = {};
                return Errors;
            })();
            Validation.Errors = Errors;
            var Engine = (function () {
                function Engine() {
                }
                Engine.setAction = function (action) {
                    Engine._action = action;
                    if (action >= Validation.Level.Validate) {
                        var processControl = window["ProcessControl"];
                        if (!processControl.Configuration.ProcessDesignerMenuActions.isValidationOn()) {
                            processControl.Configuration.ProcessDesignerMenuActions.validationButtonOn();
                        }
                    }
                    if (action == Validation.Level.Save || action == Validation.Level.SaveAs || action == Validation.Level.SaveAndClose) {
                        Engine._lastAction = Validation.Level.Save;
                    }
                    else if (action == Validation.Level.Validate) {
                        Engine._lastAction = Validation.Level.Validate;
                    }
                    else if (action == Validation.Level.Activate || action == Validation.Level.Deactivate) {
                        Engine._lastAction = Validation.Level.Activate;
                    }
                };
                Engine.resetAction = function () {
                    Engine._action = Validation.Level.EveryTime;
                };
                Engine.isDefaultAction = function () {
                    return Engine._action == Validation.Level.EveryTime;
                };
                Engine.getAction = function () {
                    return Engine._action ? Engine._action : Validation.Level.EveryTime;
                };
                Engine.getLastAction = function () {
                    return Engine._lastAction;
                };
                Engine.resetLastAction = function () {
                    Engine._lastAction = Validation.Level.Unknown;
                };
                Engine.isFromPropertyPage = function () {
                    return Engine._isFromPropertyPage;
                };
                Engine.setFromPropertyPage = function (val) {
                    Engine._isFromPropertyPage = val;
                };
                Engine.validateField = function (fieldName, value, validationFn, level_, message, options) {
                    var result = new Result(fieldName);
                    var res = Engine.applyRule(value, validationFn, level_, message, options);
                    result.addResult(res);
                    return result;
                };
                Engine.applyRule = function (value, validationFn, level_, message, options) {
                    var res = new Validation.SingleResult();
                    if (Engine.isAllowedLevel(level_)) {
                        var sResult = validationFn(value, options);
                        if (typeof (sResult) === "boolean") {
                            res.set(sResult, message);
                        }
                        else {
                            if (!sResult.isValid && (sResult.message && sResult.message.length > 0)) {
                                message = sResult.message;
                            }
                            res.set(sResult.isValid, message);
                        }
                    }
                    return res;
                };
                Engine.isAllowedLevel = function (level_) {
                    return level_ <= Engine.getAction();
                };
                Engine.checkLevel = function (fieldName, level_, message) {
                    var result = new Result(fieldName);
                    var res = new Validation.SingleResult();
                    if (Engine.isAllowedLevel(level_)) {
                        res.set(false, message);
                        result.addResult(res);
                    }
                    return result;
                };
                Engine.addOptions = function (options, newOptions) {
                    if (!options) {
                        options = {};
                    }
                    for (var opt in newOptions) {
                        options[opt] = newOptions[opt];
                    }
                    return options;
                };
                Engine.validateAttributeValue_ = function (fieldName, value, attributeType, level_, options) {
                    var result = new Result(fieldName);
                    var res = new Validation.SingleResult();
                    switch (attributeType) {
                        case AttributeType.Picklist:
                        case AttributeType.State:
                        case AttributeType.Status:
                        case AttributeType.Boolean:
                            res = Engine.applyRule(value, Required.apply, level_, null, options);
                            result.addResult(res);
                            break;
                        case AttributeType.Lookup:
                        case AttributeType.Owner:
                        case AttributeType.Customer:
                            res = Engine.applyRule(value, Required.apply, level_, null, options);
                            result.addResult(res);
                            break;
                        case AttributeType.DateTime:
                            res = Engine.applyRule(value, Required.apply, level_, null, options);
                            if (!res.isValid) {
                                var dtUtil = new ProcessDesigner.DateTimeUtil();
                                var dt = dtUtil.strToDateTime(value);
                                if (dt.errors.date || dt.errors.time) {
                                    var message = window['String'].format(ProcessDesigner.MetadataProvider.getLocalizedString("LOCID_ALERT_ENTER_VALID_DATE"), window['USER_DATE_FORMATSTRING']);
                                    res = new Validation.SingleResult();
                                    res.set(false, message);
                                }
                            }
                            result.addResult(res);
                            break;
                        case AttributeType.BigInt:
                        case AttributeType.Decimal:
                        case AttributeType.Double:
                        case AttributeType.Integer:
                        case AttributeType.Money:
                            res = Engine.applyRule(value, Required.apply, level_, null, options);
                            if (res.isValid) {
                                var maxVal = Util.getNumberValue(options, 'maxValue', 2147483647);
                                var minVal = Util.getNumberValue(options, 'minValue', -2147483648);
                                var precision = Util.getIntValue(options, 'precision', 0);
                                var start = Mscrm.NumberUtility.addFormatting(minVal, precision);
                                var end = Mscrm.NumberUtility.addFormatting(maxVal, precision);
                                var message = ProcessDesigner.MetadataProvider.getLocalizedString("ProcessDesignerControl_PBL_Float_Range");
                                if (attributeType == AttributeType.Integer) {
                                    message = ProcessDesigner.MetadataProvider.getLocalizedString("ProcessDesignerControl_PBL_Int_Range");
                                }
                                message = window['String'].format(message, start, end);
                                res = Engine.applyRule(value, NumberFormat.apply, level_, message, Engine.addOptions(options, { attributeType: attributeType }));
                                if (res.isValid) {
                                    res = Engine.applyRule(value, Range.apply, level_, message, options);
                                }
                            }
                            result.addResult(res);
                            break;
                        case AttributeType.String:
                            res = Engine.applyRule(value, Required.apply, level_, null, options);
                            if (res.isValid) {
                                res = Engine.applyRule(value, MaxLength.apply, level_, null, options);
                            }
                            result.addResult(res);
                            break;
                        default:
                            res = Engine.applyRule(value, Required.apply, level_, null, options);
                            result.addResult(res);
                            break;
                    }
                    return result;
                };
                Engine.validateAttributeValue = function (entityLogicalName, fieldName, val, attributeName, level_) {
                    var result = new Result(fieldName);
                    if (Engine.isAllowedLevel(level_)) {
                        var attributeType = AttributeType.Unknown;
                        if (attributeName) {
                            attributeType = MetadataProxy.getAttributeType(attributeName, entityLogicalName);
                        }
                        var options = {};
                        if (attributeType != AttributeType.Unknown) {
                            options = MetadataProxy.SourceAttributesMap[entityLogicalName][attributeName];
                        }
                        var value = val;
                        if (val && _.isArray(val)) {
                            value = Engine.getAttributeValue(attributeType, val);
                        }
                        result = Engine.validateAttributeValue_(fieldName, value, attributeType, level_, options);
                    }
                    return result;
                };
                Engine.validateDateTimeFormulaValue = function (fieldName, val, level_) {
                    var result = new Result(fieldName);
                    if (Engine.isAllowedLevel(level_)) {
                        var attributeType = AttributeType.Integer;
                        var options = {};
                        var value = val;
                        if (val && _.isArray(val)) {
                            value = Engine.getAttributeValue(attributeType, val);
                        }
                        result = Engine.validateAttributeValue_(fieldName, value, attributeType, level_, options);
                    }
                    return result;
                };
                Engine.getAttributeValue = function (attributeType, val) {
                    var value = val;
                    switch (attributeType) {
                        case AttributeType.Picklist:
                        case AttributeType.State:
                        case AttributeType.Status:
                        case AttributeType.Boolean:
                            value = val;
                            break;
                        case AttributeType.Lookup:
                        case AttributeType.Owner:
                        case AttributeType.Customer:
                        case AttributeType.DateTime:
                        case AttributeType.BigInt:
                        case AttributeType.Decimal:
                        case AttributeType.Double:
                        case AttributeType.Integer:
                        case AttributeType.Money:
                        case AttributeType.String:
                            if (val.length > 0) {
                                value = val[0];
                            }
                            else {
                                value = '';
                            }
                            break;
                    }
                    return value;
                };
                Engine._action = Validation.Level.EveryTime;
                Engine._lastAction = Validation.Level.Unknown;
                Engine._isFromPropertyPage = false;
                Engine.GlobalMessageID = "___GLOBAL___";
                return Engine;
            })();
            Validation.Engine = Engine;
        })(Validation = ProcessDesigner.Validation || (ProcessDesigner.Validation = {}));
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// ---------------------------------------------------------------------------------------------
//  <copyright file="BPFActivityType.ts" company="Microsoft">
//         Copyright (c) Microsoft Corporation.  All rights reserved.
//  </copyright>
// 
//  <summary>
//  Class containing the BPFActivityType Process
//  </summary>
// 
// ---------------------------------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        'use strict';
        var BPFActivityType = (function () {
            function BPFActivityType() {
            }
            BPFActivityType.isBPFActivityType = function (activityType) {
                var isBPFActivityType = false;
                var propertyTypes = Object.getOwnPropertyNames(BPFActivityType);
                propertyTypes.forEach(function (propertyType) {
                    if (propertyType !== "name" || propertyType !== "length") {
                        var propertyValue = Object.getOwnPropertyDescriptor(BPFActivityType, propertyType).value;
                        if (activityType == propertyType) {
                            isBPFActivityType = true;
                        }
                    }
                });
                return isBPFActivityType;
            };
            BPFActivityType.root = "bpf_root";
            BPFActivityType.stage = "stage";
            BPFActivityType.condition = "condition";
            BPFActivityType.step = "step";
            BPFActivityType.empty = "empty";
            BPFActivityType.workflow = "workflow";
            BPFActivityType.globalWorkflow = "globalWorkflow";
            BPFActivityType.action = "action";
            BPFActivityType.flow = "flow";
            return BPFActivityType;
        })();
        ProcessDesigner.BPFActivityType = BPFActivityType;
        var BPFDialogMessageTypes = (function () {
            function BPFDialogMessageTypes() {
            }
            BPFDialogMessageTypes.Information = 0;
            BPFDialogMessageTypes.Warning = 1;
            BPFDialogMessageTypes.Error = 2;
            return BPFDialogMessageTypes;
        })();
        ProcessDesigner.BPFDialogMessageTypes = BPFDialogMessageTypes;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// ---------------------------------------------------------------------------------------------
//  <copyright file="BPFConnectorActivityTypeCommandID.ts" company="Microsoft">
//         Copyright (c) Microsoft Corporation.  All rights reserved.
//  </copyright>
//
//  <summary>
//  Class containing the BPFConnectorActivityTypeCommandID used for operations like connect, disconnect & re-connect.
//  </summary>
//
// ---------------------------------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        'use strict';
        var BPFConnectorActivityTypeCommandID = (function () {
            function BPFConnectorActivityTypeCommandID() {
            }
            BPFConnectorActivityTypeCommandID.Connect = "ConnectTileCommand";
            BPFConnectorActivityTypeCommandID.Reconnect = "ReconnectTileCommand";
            BPFConnectorActivityTypeCommandID.Disconnect = "DisconnectTileCommand";
            return BPFConnectorActivityTypeCommandID;
        })();
        ProcessDesigner.BPFConnectorActivityTypeCommandID = BPFConnectorActivityTypeCommandID;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        'use strict';
        var BPFCssClass = (function () {
            function BPFCssClass() {
            }
            BPFCssClass.stageTile = "stageTile";
            return BPFCssClass;
        })();
        ProcessDesigner.BPFCssClass = BPFCssClass;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// ---------------------------------------------------------------------------------------------
//  <copyright file="BPFAddActivityTypeCommandID.ts" company="Microsoft">
//         Copyright (c) Microsoft Corporation.  All rights reserved.
//  </copyright>
//
//  <summary>
//  Class containing the BPFAddActivityTypeCommand used for adding any activity
//  </summary>
//
// ---------------------------------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        'use strict';
        var BPFAddActivityTypeCommandID = (function () {
            function BPFAddActivityTypeCommandID() {
            }
            BPFAddActivityTypeCommandID.AddStep = "AddStepCommand";
            BPFAddActivityTypeCommandID.AddStage = "AddStageCommand";
            BPFAddActivityTypeCommandID.AddBranch = "AddConditionCommand";
            BPFAddActivityTypeCommandID.AddWorkflow = "AddWorkflowCommand";
            BPFAddActivityTypeCommandID.PasteStep = "PasteStepCommand";
            BPFAddActivityTypeCommandID.PasteStage = "PasteStageCommand";
            BPFAddActivityTypeCommandID.PasteBranch = "PasteConditionCommand";
            BPFAddActivityTypeCommandID.PasteWorkflow = "PasteWorkflowCommand";
            BPFAddActivityTypeCommandID.AddActionStep = "AddActionCommand";
            BPFAddActivityTypeCommandID.PasteActionStep = "PasteActionCommand";
            BPFAddActivityTypeCommandID.AddFlowStep = "AddFlowCommand";
            BPFAddActivityTypeCommandID.PasteFlowStep = "PasteFlowCommand";
            return BPFAddActivityTypeCommandID;
        })();
        ProcessDesigner.BPFAddActivityTypeCommandID = BPFAddActivityTypeCommandID;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// <copyright file="BPFDragDropValidator.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        "use strict";
        var BPFDragDropValidator = (function () {
            function BPFDragDropValidator() {
                this.libraryStageElementId = "libraryElementstage";
                this.libraryConditionElementId = "libraryElementcondition";
                this.libraryStepElementId = "libraryElementstep";
                this.libraryConnectElementId = "libraryElementconnect";
                this.libraryWorkflowElementId = "libraryElementworkflow";
                this.libraryActionElementId = "libraryElementaction";
                this.libraryFlowElementId = "libraryElementflow";
            }
            BPFDragDropValidator.prototype.isValidDropOnCanvas = function (targetElementId, draggedElementId, isHitArea) {
                var targetActivity = GenericWorkflowDesigner.Settings.workflowTree.getActivityById(targetElementId);
                var stageActivities = GenericWorkflowDesigner.Settings.workflowTree.getStageActivities();
                if (draggedElementId == this.libraryStageElementId && stageActivities.length >= 30) {
                    return false;
                }
                if (targetActivity == null && targetElementId.indexOf("_hitarea") > -1) {
                    targetActivity = GenericWorkflowDesigner.Settings.workflowTree.getActivityById(targetElementId.substring(0, targetElementId.indexOf("_hitarea")));
                }
                if (targetActivity == null && targetElementId.indexOf("_verticalhitarea") > -1) {
                    targetActivity = GenericWorkflowDesigner.Settings.workflowTree.getActivityById(targetElementId.substring(0, targetElementId.indexOf("_verticalhitarea")));
                }
                if (isHitArea == true) {
                    $("#" + targetElementId).html("+");
                }
                if ($("#" + draggedElementId).hasClass("step-list-listitem")) {
                    return false;
                }
                if (targetElementId == "" && draggedElementId != this.libraryWorkflowElementId) {
                    return false;
                }
                else if (targetElementId == "" && draggedElementId == this.libraryWorkflowElementId) {
                    return true;
                }
                else if (isHitArea && draggedElementId == this.libraryStageElementId && targetElementId.indexOf("_verticalhitarea") > -1 &&
                    targetActivity instanceof ProcessDesigner.BPFConditionActivity && !targetActivity.canAddNewBranch()) {
                    return false;
                }
                else if (isHitArea && draggedElementId == this.libraryStageElementId) {
                    return true;
                }
                else if (isHitArea && draggedElementId == this.libraryConditionElementId &&
                    ((targetActivity instanceof ProcessDesigner.BPFStageActivity && !targetActivity.canAddNewNestedBranch()) || (targetActivity instanceof ProcessDesigner.BPFConditionActivity && !targetActivity.canAddNewBranch()))) {
                    return false;
                }
                else if (!isHitArea && draggedElementId != this.libraryStepElementId && draggedElementId != this.libraryConnectElementId && draggedElementId != this.libraryWorkflowElementId && draggedElementId != this.libraryActionElementId && draggedElementId != this.libraryFlowElementId) {
                    return false;
                }
                else if (!isHitArea && (draggedElementId == this.libraryStepElementId || draggedElementId == this.libraryWorkflowElementId || draggedElementId == this.libraryActionElementId || draggedElementId == this.libraryFlowElementId)
                    && typeof targetActivity != "undefined" && targetActivity.getActivityTypeID() == ProcessDesigner.BPFActivityType.condition) {
                    return false;
                }
                else if (isHitArea && (draggedElementId == this.libraryStepElementId || draggedElementId == this.libraryConnectElementId || draggedElementId == this.libraryWorkflowElementId || draggedElementId == this.libraryActionElementId || draggedElementId == this.libraryFlowElementId)) {
                    return false;
                }
                else if (!isHitArea && draggedElementId == this.libraryStepElementId) {
                    return true;
                }
                else if (!isHitArea && draggedElementId == this.libraryActionElementId) {
                    return true;
                }
                else if (!isHitArea && draggedElementId == this.libraryFlowElementId) {
                    return true;
                }
                else if (!isHitArea && draggedElementId == this.libraryWorkflowElementId) {
                    return true;
                }
                else if (!isHitArea && (draggedElementId == this.libraryStageElementId || draggedElementId == this.libraryConditionElementId)) {
                    return false;
                }
                else {
                    var result = this.isValidMoveOnCanvas(targetElementId, draggedElementId, isHitArea);
                    return result;
                }
            };
            BPFDragDropValidator.prototype.isValidMoveOnCanvas = function (targetElementId, draggedElementId, isHitArea) {
                var isVerticalHitArea = isHitArea && targetElementId.indexOf('_verticalhitarea') > -1;
                if (targetElementId == draggedElementId + '_hitarea') {
                    return false;
                }
                var workflowTree = GenericWorkflowDesigner.Settings.workflowTree;
                var targetActivity = workflowTree.getActivityById(targetElementId.replace('_hitarea', '').replace('_verticalhitarea', ''));
                if (typeof targetActivity != "undefined" && draggedElementId == this.libraryConnectElementId) {
                    return this.isConnectorValid(targetActivity);
                }
                if (draggedElementId == this.libraryConditionElementId) {
                    return this.isValidConditionDrop(targetActivity, isVerticalHitArea);
                }
                var draggedActivity = workflowTree.getActivityById(draggedElementId);
                var draggedActivityParent = draggedActivity.getParent();
                if (!CommonTypes.Types.Object.isNullOrUndefined(draggedActivityParent)) {
                    var draggedActivityParentID = draggedActivityParent.getActivityID();
                    if (targetElementId == draggedActivityParentID + '_hitarea') {
                        return false;
                    }
                }
                if (draggedActivity.getActivityID() == workflowTree.getWorkflowDefinitionRoot().getActivityID()) {
                    return false;
                }
                if (draggedActivity.getActivityTypeID() == ProcessDesigner.BPFActivityType.stage
                    && draggedActivityParent.getActivityTypeID() == ProcessDesigner.BPFActivityType.condition) {
                    var children = draggedActivity.getChildActivitiesSorted()[0];
                    if (!CommonTypes.Types.Object.isNullOrUndefined(children) && children.getActivityTypeID() == ProcessDesigner.BPFActivityType.condition) {
                        if (draggedActivity.getParentBranchID() == ProcessDesigner.branchType.Default || draggedActivity.getParentBranchID() == ProcessDesigner.branchType.If)
                            return false;
                        else
                            return true;
                    }
                }
                if (draggedActivityParent.getActivityTypeID() == ProcessDesigner.BPFActivityType.condition
                    && draggedActivity.getParentBranchID() == 0 && draggedActivity.isLeaf()) {
                    return false;
                }
                if (typeof targetActivity != "undefined" && targetActivity.isBranchActivity()) {
                    if (draggedActivity.isBranchActivity()) {
                        return this.isInSameConditionalBranch(targetActivity, draggedActivity, targetElementId);
                    }
                    else {
                        return true;
                    }
                }
                else {
                    if (typeof draggedActivity != "undefined" && draggedActivity.isBranchActivity()) {
                        return false;
                    }
                    else {
                        return true;
                    }
                }
            };
            BPFDragDropValidator.prototype.isConnectorValid = function (targetActivity) {
                var childrens = targetActivity.getChildActivitiesSorted();
                if (childrens.length == 0 && targetActivity.getActivityTypeID() == ProcessDesigner.BPFActivityType.stage && targetActivity.getAllowedDependentActivitiesForConnector(targetActivity)) {
                    return true;
                }
                else if (targetActivity.getActivityTypeID() == ProcessDesigner.BPFActivityType.condition) {
                    var length = childrens.length;
                    switch (length) {
                        case 0:
                            return true;
                        case 1:
                            if (childrens[length - 1].getParentBranchID() == 1)
                                return true;
                            else
                                return false;
                        case 2:
                            if (childrens[length - 1].getParentBranchID() == 1)
                                return true;
                            else
                                return false;
                        case 3:
                            return false;
                    }
                }
                else {
                    return false;
                }
            };
            BPFDragDropValidator.prototype.isValidConditionDrop = function (targetActivity, isVerticalHitArea) {
                var childrens = targetActivity.getChildActivitiesSorted();
                var push = true;
                for (var i = 0; i < childrens.length; i++) {
                    if (childrens[i] && childrens[i].getActivityTypeID() == ProcessDesigner.BPFActivityType.condition) {
                        push = false;
                    }
                }
                if (isVerticalHitArea) {
                    for (var i = 0; i < childrens.length; i++) {
                        if (childrens[i] && childrens[i].getActivityTypeID() == ProcessDesigner.BPFActivityType.condition && childrens[i].getParentBranchID() == ProcessDesigner.branchType.Else) {
                            push = false;
                        }
                    }
                }
                else if (targetActivity.getActivityTypeID() == ProcessDesigner.BPFActivityType.condition) {
                    push = false;
                }
                return push;
            };
            BPFDragDropValidator.prototype.getConditionParentBranchID = function (activity) {
                var parent = activity.getParent();
                if (activity.getActivityTypeID() == ProcessDesigner.BPFActivityType.condition) {
                    return activity.getParentBranchID();
                }
                else if (parent.getActivityTypeID() == ProcessDesigner.BPFActivityType.condition && activity.getParentBranchID() != ProcessDesigner.branchType.Default) {
                    return activity.getParentBranchID();
                }
                else {
                    return this.getConditionParentBranchID(parent);
                }
            };
            BPFDragDropValidator.prototype.getConditionBranchActivityId = function (activity) {
                var parent = activity.getParent();
                if (activity.getActivityTypeID() == ProcessDesigner.BPFActivityType.condition) {
                    return activity.getActivityID();
                }
                else if (parent.getActivityTypeID() == ProcessDesigner.BPFActivityType.condition) {
                    return parent.getActivityID();
                }
                else {
                    return this.getConditionBranchActivityId(parent);
                }
            };
            BPFDragDropValidator.prototype.isInSameConditionalBranch = function (targetActivity, draggedActivity, targetElementId) {
                if (this.getConditionBranchActivityId(targetActivity) == this.getConditionBranchActivityId(draggedActivity)) {
                    if (targetActivity.getActivityTypeID() == ProcessDesigner.BPFActivityType.stage) {
                        if (this.getConditionParentBranchID(targetActivity) == this.getConditionParentBranchID(draggedActivity)) {
                            return true;
                        }
                        else {
                            return false;
                        }
                    }
                    else {
                        if (this.getConditionParentBranchID(draggedActivity) == ProcessDesigner.branchType.If) {
                            if ((targetElementId.indexOf('_hitarea') > -1 && targetElementId.indexOf('_verticalhitarea') == -1)) {
                                var childs = targetActivity.getChildActivitiesSorted();
                                switch (childs.length) {
                                    case 0:
                                        return true;
                                    case 1:
                                        if (childs[0].getParentBranchID() == ProcessDesigner.branchType.If) {
                                            if (this.getConditionParentBranchID(draggedActivity) == ProcessDesigner.branchType.If)
                                                return true;
                                            else
                                                return false;
                                        }
                                        else
                                            return false;
                                    case 2:
                                        if (childs[0].getParentBranchID() == ProcessDesigner.branchType.Default && childs[1].getParentBranchID() == ProcessDesigner.branchType.If || childs[0].getParentBranchID() == ProcessDesigner.branchType.If && childs[1].getParentBranchID() == ProcessDesigner.branchType.Else) {
                                            if (this.getConditionParentBranchID(draggedActivity) == ProcessDesigner.branchType.If)
                                                return true;
                                            else
                                                return false;
                                        }
                                        else
                                            return false;
                                    case 3:
                                        if (this.getConditionParentBranchID(draggedActivity) == ProcessDesigner.branchType.If)
                                            return true;
                                        else
                                            return false;
                                }
                                ;
                            }
                            else
                                return false;
                        }
                        else {
                            if (this.getConditionParentBranchID(draggedActivity) == ProcessDesigner.branchType.Else) {
                                if ((targetElementId.indexOf('_hitarea') == -1 && targetElementId.indexOf('_verticalhitarea') > -1)) {
                                    var childs = targetActivity.getChildActivitiesSorted();
                                    switch (childs.length) {
                                        case 0:
                                            return true;
                                        case 1:
                                            if (childs[0] != draggedActivity && childs[0].getParentBranchID() == ProcessDesigner.branchType.Else) {
                                                if (this.getConditionParentBranchID(draggedActivity) == ProcessDesigner.branchType.Else)
                                                    return true;
                                                else
                                                    return false;
                                            }
                                            else
                                                return false;
                                        case 2:
                                            if (childs[1] != draggedActivity && childs[1].getParentBranchID() == ProcessDesigner.branchType.Else) {
                                                if (this.getConditionParentBranchID(draggedActivity) == ProcessDesigner.branchType.Else)
                                                    return true;
                                                else
                                                    return false;
                                            }
                                            else
                                                return false;
                                        case 3:
                                            if (childs[2] != draggedActivity && this.getConditionParentBranchID(draggedActivity) == ProcessDesigner.branchType.Else)
                                                return true;
                                            else
                                                return false;
                                    }
                                    ;
                                }
                                else
                                    return false;
                            }
                        }
                    }
                }
                else
                    return false;
            };
            return BPFDragDropValidator;
        })();
        ProcessDesigner.BPFDragDropValidator = BPFDragDropValidator;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        var WorkflowStepJson = (function () {
            function WorkflowStepJson() {
                this.__class = "WorkflowStep:#Microsoft.Crm.Workflow.ObjectModel";
            }
            return WorkflowStepJson;
        })();
        ProcessDesigner.WorkflowStepJson = WorkflowStepJson;
        var EntityStepJson = (function () {
            function EntityStepJson() {
                this.__class = "EntityStep:#Microsoft.Crm.Workflow.ObjectModel";
            }
            EntityStepJson.getStepCount = function () {
                return EntityStepJson.counter++;
            };
            EntityStepJson.counter = 0;
            return EntityStepJson;
        })();
        ProcessDesigner.EntityStepJson = EntityStepJson;
        var StageStepJson = (function () {
            function StageStepJson() {
                this.__class = "StageStep:#Microsoft.Crm.Workflow.ObjectModel";
            }
            return StageStepJson;
        })();
        ProcessDesigner.StageStepJson = StageStepJson;
        var StepStepJson = (function () {
            function StepStepJson() {
                this.__class = "StepStep:#Microsoft.Crm.Workflow.ObjectModel";
            }
            return StepStepJson;
        })();
        ProcessDesigner.StepStepJson = StepStepJson;
        var ConditionStepJson = (function () {
            function ConditionStepJson() {
                this.__class = "ConditionStep:#Microsoft.Crm.Workflow.ObjectModel";
            }
            return ConditionStepJson;
        })();
        ProcessDesigner.ConditionStepJson = ConditionStepJson;
        var ConditionBranchJson = (function () {
            function ConditionBranchJson() {
                this.__class = "ConditionBranchStep:#Microsoft.Crm.Workflow.ObjectModel";
            }
            return ConditionBranchJson;
        })();
        ProcessDesigner.ConditionBranchJson = ConditionBranchJson;
        var RelationshipCollectionStepJson = (function () {
            function RelationshipCollectionStepJson() {
                this.__class = "RelationshipCollectionStep:#Microsoft.Crm.Workflow.ObjectModel";
            }
            return RelationshipCollectionStepJson;
        })();
        ProcessDesigner.RelationshipCollectionStepJson = RelationshipCollectionStepJson;
        var NextStageStepJson = (function () {
            function NextStageStepJson() {
                this.__class = "SetNextStageStep:#Microsoft.Crm.Workflow.ObjectModel";
            }
            return NextStageStepJson;
        })();
        ProcessDesigner.NextStageStepJson = NextStageStepJson;
        var ControlStepJson = (function () {
            function ControlStepJson() {
                this.__class = "ControlStep:#Microsoft.Crm.Workflow.ObjectModel";
            }
            ControlStepJson.getStepCount = function () {
                return EntityStepJson.counter++;
            };
            ControlStepJson.counter = 0;
            return ControlStepJson;
        })();
        ProcessDesigner.ControlStepJson = ControlStepJson;
        var PrimaryEntityJson = (function () {
            function PrimaryEntityJson() {
                this.__class = "PrimaryEntity:#Microsoft.Crm.Workflow.Expressions";
            }
            return PrimaryEntityJson;
        })();
        ProcessDesigner.PrimaryEntityJson = PrimaryEntityJson;
        var MethodCallExpressionJson = (function () {
            function MethodCallExpressionJson() {
                this.__class = "MethodCallExpression:#Microsoft.Crm.Workflow.Expressions";
                this.type = "0";
                this.typeSet = false;
                this.behavior = 0;
                this.method = "0";
                this.parameters = [];
            }
            return MethodCallExpressionJson;
        })();
        ProcessDesigner.MethodCallExpressionJson = MethodCallExpressionJson;
        var EntityAttributeExpressionJson = (function () {
            function EntityAttributeExpressionJson() {
                this.__class = "EntityAttributeExpression:#Microsoft.Crm.Workflow.Expressions";
                this.type = "4";
                this.typeSet = false;
                this.behavior = 0;
            }
            return EntityAttributeExpressionJson;
        })();
        ProcessDesigner.EntityAttributeExpressionJson = EntityAttributeExpressionJson;
        var PrimitiveExpressionJson = (function () {
            function PrimitiveExpressionJson() {
                this.__class = "PrimitiveExpression:#Microsoft.Crm.Workflow.Expressions";
                this.typeSet = false;
                this.behavior = 0;
            }
            return PrimitiveExpressionJson;
        })();
        ProcessDesigner.PrimitiveExpressionJson = PrimitiveExpressionJson;
        var BinaryExpressionJson = (function () {
            function BinaryExpressionJson() {
                this.__class = "BinaryExpression:#Microsoft.Crm.Workflow.Expressions";
                this.type = "0";
                this.typeSet = false;
                this.behavior = 0;
                this.right = [];
            }
            return BinaryExpressionJson;
        })();
        ProcessDesigner.BinaryExpressionJson = BinaryExpressionJson;
        var UnaryExpressionJson = (function () {
            function UnaryExpressionJson() {
                this.__class = "UnaryExpression:#Microsoft.Crm.Workflow.Expressions";
                this.type = "0";
                this.typeSet = false;
                this.behavior = 0;
            }
            return UnaryExpressionJson;
        })();
        ProcessDesigner.UnaryExpressionJson = UnaryExpressionJson;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// ---------------------------------------------------------------------------------------------
//  <copyright file="BPFLayoutProperties.ts" company="Microsoft">
//         Copyright (c) Microsoft Corporation.  All rights reserved.
//  </copyright>
//
//  <summary>
//  Class used for specifying layout properties of the BPF control
//  </summary>
//
// ---------------------------------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        'use strict';
        var BPFLayoutProperties = (function (_super) {
            __extends(BPFLayoutProperties, _super);
            function BPFLayoutProperties(workspacePosition) {
                _super.call(this, workspacePosition);
                this.topMargin = 0;
                this.rowSpaceing = 58;
                this.colSpaceing = 60;
                this.insertSlotVerticalOffset = 28;
                this.insertSlotHorizontalOffset = 24;
            }
            return BPFLayoutProperties;
        })(GenericWorkflowDesigner.LayoutProperties);
        ProcessDesigner.BPFLayoutProperties = BPFLayoutProperties;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// ---------------------------------------------------------------------------------------------
//  <copyright file="BPFWorkflowTriggerTypes.ts" company="Microsoft">
//         Copyright (c) Microsoft Corporation.  All rights reserved.
//  </copyright>
// 
//  <summary>
//  Class containing the BPFWorkflowTriggerTypes 
//  </summary>
// 
// ---------------------------------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        'use strict';
        var BPFWorkflowTriggerTypes = (function () {
            function BPFWorkflowTriggerTypes() {
            }
            BPFWorkflowTriggerTypes.ProcessApplied = "PROCESSAPPLIED";
            BPFWorkflowTriggerTypes.ProcessStatusChange = "PROCESSSTATUSCHANGE";
            BPFWorkflowTriggerTypes.StageEnter = "STAGEENTER";
            BPFWorkflowTriggerTypes.StageExit = "STAGEEXIT";
            return BPFWorkflowTriggerTypes;
        })();
        ProcessDesigner.BPFWorkflowTriggerTypes = BPFWorkflowTriggerTypes;
        var BPFWorkflowPipelineStage = (function () {
            function BPFWorkflowPipelineStage() {
            }
            BPFWorkflowPipelineStage.preEvent = "20";
            BPFWorkflowPipelineStage.postEvent = "40";
            return BPFWorkflowPipelineStage;
        })();
        ProcessDesigner.BPFWorkflowPipelineStage = BPFWorkflowPipelineStage;
        var BPFWorkflowTriggerValues = (function () {
            function BPFWorkflowTriggerValues() {
            }
            BPFWorkflowTriggerValues.ProcessApplied = "ProcessApplied";
            BPFWorkflowTriggerValues.ProcessReactivated = "ProcessRe-activated";
            BPFWorkflowTriggerValues.ProcessAbandon = "ProcessAbandon";
            BPFWorkflowTriggerValues.ProcessFinished = "ProcessFinished";
            BPFWorkflowTriggerValues.StageEntry = "Entry";
            BPFWorkflowTriggerValues.StageExit = "Exit";
            return BPFWorkflowTriggerValues;
        })();
        ProcessDesigner.BPFWorkflowTriggerValues = BPFWorkflowTriggerValues;
        var BPFProcessStatus = (function () {
            function BPFProcessStatus() {
            }
            BPFProcessStatus.Active = "1";
            BPFProcessStatus.Finished = "2";
            BPFProcessStatus.Aborted = "3";
            return BPFProcessStatus;
        })();
        ProcessDesigner.BPFProcessStatus = BPFProcessStatus;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// -----------------------------------------------------------------------
// <copyright file="WindowUtility.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        var WindowUtility = (function () {
            function WindowUtility() {
            }
            WindowUtility.GetTopWindow = function () {
                return WindowUtility.IsTopAccessible() ? window.top : window.self;
            };
            WindowUtility.IsTopAccessible = function () {
                try {
                    return window.top.location != null && window.top.location.href != null;
                }
                catch (ex) {
                    return false;
                }
            };
            WindowUtility.GetParentWindow = function () {
                return WindowUtility.IsParentAccessible() ? window.parent : window.self;
            };
            WindowUtility.IsParentAccessible = function () {
                try {
                    return window.parent.location != null && window.parent.location.href != null;
                }
                catch (ex) {
                    return false;
                }
            };
            return WindowUtility;
        })();
        ProcessDesigner.WindowUtility = WindowUtility;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
///<reference path="../../../Utility/WindowUtility.ts" />
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        var ValidateBPF = (function () {
            function ValidateBPF() {
            }
            ValidateBPF.validateOff = function () {
                ProcessDesigner.ProcessDesignerControl.validationMode = GenericWorkflowDesigner.ValidationMode.None;
                GenericWorkflowDesigner.Settings.notification.ClearNotifications();
                ProcessDesigner.Validation.Engine.resetAction();
                ProcessDesigner.Validation.Engine.resetLastAction();
                var activities = GenericWorkflowDesigner.Settings.workflowTree.getAllConcreteActivities();
                for (var i = 0; i < activities.length; i++) {
                    activities[i].setValidationMode(GenericWorkflowDesigner.ValidationMode.None);
                    activities[i].clearErrorMessages();
                }
                ProcessDesigner.ControlManager.globalWorkflowObject.clearErrorMessages();
                GenericWorkflowDesigner.EventManager.publish(GenericWorkflowDesigner.FrameworkEvents.refreshPropertyPageErrorMessages);
                $('.tileError').remove();
                $('.errorTile').removeClass('errorTile');
            };
            ValidateBPF.validate = function () {
                var isValid = true;
                GenericWorkflowDesigner.Settings.notification.ClearNotifications();
                if (ValidateBPF.shouldValidate()) {
                    var activities = GenericWorkflowDesigner.Settings.workflowTree.getAllConcreteActivities();
                    var status;
                    for (var i = 0; i < activities.length; i++) {
                        activities[i].setValidationMode(ProcessDesigner.ProcessDesignerControl.validationMode);
                        status = activities[i].validateActivity();
                        isValid = status && isValid;
                    }
                    var globalWorkflow = ProcessDesigner.ControlManager.globalWorkflowObject;
                    status = globalWorkflow.validateActivity();
                    isValid = status && isValid;
                    var validationResult = new ProcessDesigner.ValidationResult("");
                    var message = ProcessDesigner.Validation.Errors.updateNotifications();
                    ProcessDesigner.TelemetryEventReporter.ReportProcessDesignerValidateEvent("", message, ProcessDesigner.Validation.Errors.errorCount.toString());
                    if (isValid) {
                        validationResult.success();
                        if (ProcessDesigner.Validation.Engine.getLastAction() == ProcessDesigner.Validation.Level.Save && ProcessDesigner.Validation.Errors.getCount() == 0) {
                            ProcessDesigner.Validation.Engine.resetLastAction();
                        }
                    }
                    else {
                        validationResult.failure(message);
                    }
                }
                ProcessDesigner.Validation.Engine.resetAction();
                GenericWorkflowDesigner.EventManager.publish(GenericWorkflowDesigner.FrameworkEvents.refreshPropertyPageErrorMessages);
                $('.warningLabel').remove();
                return validationResult;
            };
            ValidateBPF.validateDependentOptionSet = function () {
                var isValid = true;
                GenericWorkflowDesigner.Settings.notification.ClearNotifications();
                var activities = GenericWorkflowDesigner.Settings.workflowTree.getAllConcreteActivities();
                activities = _.filter(activities, function (activity) { return activity.getActivityTypeID() == "stage"; });
                var status;
                var currentMode = ProcessDesigner.ProcessDesignerControl.validationMode;
                var currentAction = ProcessDesigner.Validation.Engine.getAction();
                for (var i = 0; i < activities.length; i++) {
                    ProcessDesigner.MetadataProxy.getStepAttributeMetadata(activities[i].entityName);
                    ProcessDesigner.ProcessDesignerControl.validationMode = GenericWorkflowDesigner.ValidationMode.Error;
                    ProcessDesigner.Validation.Engine.setAction(ProcessDesigner.Validation.Level.Validate);
                    activities[i].setValidationMode(ProcessDesigner.ProcessDesignerControl.validationMode);
                    status = activities[i].validateDependentOptionSetActivity();
                    ProcessDesigner.Validation.Engine.resetAction();
                    ProcessDesigner.Validation.Engine.resetLastAction();
                    activities[i].setValidationMode(currentMode);
                    isValid = status && isValid;
                }
                ProcessDesigner.ProcessDesignerControl.validationMode = currentMode;
                var processControl = window["ProcessControl"];
                processControl.Configuration.ProcessDesignerMenuActions.validationButtonOff();
                var validationResult = new ProcessDesigner.ValidationResult("");
                if (ProcessDesigner.Validation.Errors.errorCount > 0) {
                    var message = ProcessDesigner.Validation.Errors.updateNotifications();
                }
                ProcessDesigner.TelemetryEventReporter.ReportProcessDesignerValidateEvent("", message, ProcessDesigner.Validation.Errors.errorCount.toString());
                if (isValid) {
                    validationResult.success();
                    if (ProcessDesigner.Validation.Engine.getLastAction() == ProcessDesigner.Validation.Level.Save && ProcessDesigner.Validation.Errors.getCount() == 0) {
                        ProcessDesigner.Validation.Engine.resetLastAction();
                    }
                }
                else {
                    validationResult.failure(message);
                }
                ProcessDesigner.Validation.Engine.resetAction();
                GenericWorkflowDesigner.EventManager.publish(GenericWorkflowDesigner.FrameworkEvents.refreshPropertyPageErrorMessages);
                return validationResult;
            };
            ValidateBPF.shouldValidate = function () {
                var doValidate = false;
                if (ProcessDesigner.Validation.Engine.getLastAction() >= ProcessDesigner.Validation.Level.Save) {
                    doValidate = true;
                }
                else if (ProcessDesigner.Validation.Engine.isDefaultAction()) {
                    doValidate = false;
                }
                else if (ProcessDesigner.ProcessDesignerControl.validationMode == GenericWorkflowDesigner.ValidationMode.None) {
                    doValidate = false;
                }
                else {
                    doValidate = true;
                }
                return doValidate;
            };
            return ValidateBPF;
        })();
        ProcessDesigner.ValidateBPF = ValidateBPF;
        var top = ProcessDesigner.WindowUtility.GetTopWindow();
        $(top.document).on("doValidation", function (event, success, failure) {
            var result = MscrmControls.ProcessDesigner.ValidateBPF.validate();
            top.document.createAttribute("validateSuccess");
            if (result.isValid) {
                top.document["validateSuccess"] = true;
                if (success) {
                    success();
                }
            }
            else {
                top.document["validateSuccess"] = false;
                if (failure) {
                    failure();
                }
            }
        });
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// -----------------------------------------------------------------------
// <copyright file="BPFGraphics.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        'use strict';
        var Point = GenericWorkflowDesigner.Point;
        var PositionCalculator = GenericWorkflowDesigner.PositionCalculator;
        var BPFGraphics = (function (_super) {
            __extends(BPFGraphics, _super);
            function BPFGraphics() {
                _super.apply(this, arguments);
            }
            BPFGraphics.prototype.createRectangleDOM = function (rectangle, segmentClass, lineWidth) {
                lineWidth = (lineWidth == undefined) ? GenericWorkflowDesigner.Settings.layoutProperties.lineWidth : lineWidth;
                var leftLine = this.createLineDOM(new Point(rectangle.getLeft(), rectangle.getTop()), lineWidth, rectangle.getHeight(), segmentClass);
                var rightLine = this.createLineDOM(new Point(rectangle.getRight(), rectangle.getTop()), lineWidth, rectangle.getHeight(), segmentClass);
                var topLine = this.createLineDOM(new Point(rectangle.getLeft(), rectangle.getTop()), rectangle.getWidth(), lineWidth, segmentClass);
                var bottomLine = this.createLineDOM(new Point(rectangle.getLeft(), rectangle.getBottom()), rectangle.getWidth(), lineWidth, segmentClass);
                var segments = [];
                segments.push(leftLine);
                segments.push(rightLine);
                segments.push(topLine);
                segments.push(bottomLine);
                return segments;
            };
            BPFGraphics.prototype.createLineDOM = function (pointStart, width, height, segmentClass) {
                var line = $('<div class="' + segmentClass + '">');
                line.css("position", "absolute");
                line.css("width", width);
                line.css("height", height);
                line.css(GenericWorkflowDesigner.getLeftAlignmentAttributeName(), pointStart.getX());
                line.css("top", pointStart.getY());
                return line;
            };
            BPFGraphics.prototype.createConnectorExtendDOM = function (startPoint, endPoint, segmentClass, parentBranchID, depth) {
                var segments = [], p2;
                var width = GenericWorkflowDesigner.Settings.layoutProperties.width;
                var height = GenericWorkflowDesigner.Settings.layoutProperties.height;
                var tileHeight = GenericWorkflowDesigner.Settings.layoutProperties.tileHeight;
                var tileButtonHeight = height - tileHeight;
                var colSpaceing = GenericWorkflowDesigner.Settings.layoutProperties.colSpaceing;
                var defaultColSpaceing = colSpaceing / 2;
                var lineWidth = GenericWorkflowDesigner.Settings.layoutProperties.lineWidth;
                var extra = depth * GenericWorkflowDesigner.Settings.layoutProperties.rowSpaceing + (depth - 1) * height;
                var top = startPoint.getY() + height;
                var left = startPoint.getX() + width / 2;
                var p1 = new GenericWorkflowDesigner.Point(left, top);
                segments.push(this.createLineDOM(p1, lineWidth, extra, segmentClass));
                var startLoc = left;
                var endLoc = endPoint.getX() - defaultColSpaceing;
                p2 = new GenericWorkflowDesigner.Point(left, top + extra);
                segments.push(this.createLineDOM(p2, endLoc - startLoc, lineWidth, segmentClass));
                top = endPoint.getY() + tileHeight / 2;
                left = endPoint.getX() - defaultColSpaceing;
                var p3 = new GenericWorkflowDesigner.Point(left, top);
                segments.push(this.createLineDOM(p3, lineWidth, startPoint.getY() + extra + lineWidth + tileHeight / 2 + tileButtonHeight, segmentClass));
                top = endPoint.getY() + tileHeight / 2;
                left = endPoint.getX() - defaultColSpaceing;
                var p4 = new GenericWorkflowDesigner.Point(left, top);
                segments.push(this.createLineDOM(p4, defaultColSpaceing, lineWidth, segmentClass));
                return segments;
            };
            BPFGraphics.prototype.createConnectorDOM = function (startPoint, endPoint, segmentClass, parentBranchID) {
                var segments = [], p2;
                var width = GenericWorkflowDesigner.Settings.layoutProperties.width;
                var height = GenericWorkflowDesigner.Settings.layoutProperties.height;
                var tileHeight = GenericWorkflowDesigner.Settings.layoutProperties.tileHeight;
                var tileButtonHeight = height - tileHeight;
                var borderHeight = GenericWorkflowDesigner.Settings.layoutProperties.borderHeight;
                var colSpaceing = GenericWorkflowDesigner.Settings.layoutProperties.colSpaceing;
                var defaultColSpaceing = colSpaceing / 2;
                var lineWidth = GenericWorkflowDesigner.Settings.layoutProperties.lineWidth;
                if (endPoint.getX() - startPoint.getX() != (width + colSpaceing)) {
                    if (GenericWorkflowDesigner.Settings.renderMinimapFlag) {
                        colSpaceing = endPoint.getX() - startPoint.getX() - GenericWorkflowDesigner.Settings.layoutProperties.width;
                    }
                    else {
                        colSpaceing = endPoint.getX() - startPoint.getX() - width;
                    }
                }
                var top = startPoint.getY() + tileHeight / 2;
                var left = startPoint.getX() + width;
                var p1 = new GenericWorkflowDesigner.Point(left, top);
                if (parentBranchID == 2) {
                    top = startPoint.getY() + height / 2 + borderHeight;
                    p1 = new GenericWorkflowDesigner.Point(left, top);
                    segments.push(this.createLineDOM(p1, 0, lineWidth, segmentClass));
                }
                else {
                    segments.push(this.createLineDOM(p1, colSpaceing - defaultColSpaceing, lineWidth, segmentClass));
                }
                var top1 = startPoint.getY() + tileHeight / 2;
                var top2 = endPoint.getY() + tileHeight / 2;
                if (top2 - top1 >= 0) {
                    left = endPoint.getX() - colSpaceing;
                    if (parentBranchID == 2) {
                        p2 = new GenericWorkflowDesigner.Point(left - width / 2, top + height / 2 + borderHeight / 2);
                        segments.push(this.createLineDOM(p2, lineWidth, top2 - top1 - tileHeight / 2 - tileButtonHeight, segmentClass));
                    }
                    else {
                        p2 = new GenericWorkflowDesigner.Point(left, top);
                        segments.push(this.createLineDOM(p2, lineWidth, top2 - top1, segmentClass));
                    }
                }
                else {
                    left = endPoint.getX() - defaultColSpaceing - Math.floor(lineWidth / 2);
                    top = endPoint.getY() + tileHeight / 2;
                    if (parentBranchID == 2) {
                        top = endPoint.getY() + height / 2 + borderHeight / 2;
                        p2 = new GenericWorkflowDesigner.Point(left - width, top);
                    }
                    else {
                        p2 = new GenericWorkflowDesigner.Point(left, top);
                    }
                    segments.push(this.createLineDOM(p2, lineWidth, top1 - top2 + lineWidth, segmentClass));
                }
                top = endPoint.getY() + tileHeight / 2;
                left = endPoint.getX() - defaultColSpaceing;
                var p3;
                if (parentBranchID == 2) {
                    p3 = new GenericWorkflowDesigner.Point(left - width / 2 - defaultColSpaceing, top);
                }
                else {
                    p3 = new GenericWorkflowDesigner.Point(left, top);
                }
                if (parentBranchID == 2) {
                    segments.push(this.createLineDOM(p3, colSpaceing + width / 2, lineWidth, segmentClass));
                }
                else {
                    segments.push(this.createLineDOM(p3, defaultColSpaceing, lineWidth, segmentClass));
                }
                return segments;
            };
            BPFGraphics.prototype.drawTileConnectors = function (canvasObj) {
                var self = this;
                var nextActivity;
                var workflowDefinition = GenericWorkflowDesigner.Settings.workflowTree.getWorkflowDefinition();
                jQuery.each(workflowDefinition, function (index, activity) {
                    var parentActivity = activity.getParent();
                    if (parentActivity != null && parentActivity.getActivityTypeID() != "bpf_root") {
                        self.drawConnector(parentActivity, activity, canvasObj);
                    }
                });
                jQuery.each(workflowDefinition, function (index, activity) {
                    if (activity.getNextActivityID()) {
                        nextActivity = GenericWorkflowDesigner.Settings.workflowTree.getNextActivity(activity);
                        if (nextActivity != null && nextActivity.getActivityID()) {
                            self.drawConnector(activity, nextActivity, canvasObj);
                        }
                    }
                });
                jQuery.each(workflowDefinition, function (index, activity) {
                    if (activity.getActivityTypeID() == ProcessDesigner.BPFActivityType.condition) {
                        var condition = activity;
                        if (condition.NextElseBranchActivity) {
                            var defaultActivity = condition.NextElseBranchActivity;
                            if (defaultActivity != null && defaultActivity.getActivityID()) {
                                self.drawDefaultElseBranchConnectorForNestedConditions(activity, defaultActivity, canvasObj);
                            }
                        }
                    }
                });
            };
            BPFGraphics.prototype.drawDefaultElseBranchConnectorForNestedConditions = function (condition, defaultActivity, canvasObj) {
                var positionCalculator = new PositionCalculator(GenericWorkflowDesigner.Settings.layoutProperties);
                var startPoint = new Point(positionCalculator.computeLeft(condition.getCol()), positionCalculator.computeTop(condition.getRow()));
                var endPointForDefaultPath = new Point(positionCalculator.computeLeft(defaultActivity.getCol()), positionCalculator.computeTop(defaultActivity.getRow()));
                var maxDepthForDefaultPath = GenericWorkflowDesigner.Settings.workflowTree.getMaxDepth(defaultActivity) + 1;
                var connectorSegmentsStart = GenericWorkflowDesigner.Settings.graphics.createConnectorExtendDOM(startPoint, endPointForDefaultPath, "line", 0, maxDepthForDefaultPath);
                jQuery.each(connectorSegmentsStart, function (index, segment) {
                    canvasObj.$el.append(segment);
                });
            };
            BPFGraphics.prototype.drawConnector = function (parentActivity, childActivity, canvasObj) {
                var connectorSegments;
                var row1 = parentActivity.getRow();
                var col1 = parentActivity.getCol();
                var row2 = childActivity.getRow();
                var col2 = childActivity.getCol();
                var positionCalculator = new PositionCalculator(GenericWorkflowDesigner.Settings.layoutProperties);
                var startPoint = new Point(positionCalculator.computeLeft(col1), positionCalculator.computeTop(row1));
                var endPoint = new Point(positionCalculator.computeLeft(col2), positionCalculator.computeTop(row2));
                var childs = parentActivity.getChildActivitiesSorted();
                if (childs.length == 2 && childs[1].getParentBranchID() == 1 && parentActivity.getActivityTypeID() == "condition" && childActivity.getParentBranchID() == 0) {
                    var maxDepth = GenericWorkflowDesigner.Settings.workflowTree.getMaxDepth(childs[1]) + 1;
                    var connectorSegmentsStart = GenericWorkflowDesigner.Settings.graphics.createConnectorExtendDOM(startPoint, endPoint, "line", childActivity.getParentBranchID(), maxDepth);
                    jQuery.each(connectorSegmentsStart, function (index, segment) {
                        canvasObj.$el.append(segment);
                    });
                }
                else {
                    var check = 0;
                    if (parentActivity.getActivityTypeID() == ProcessDesigner.BPFActivityType.condition) {
                        switch (childs.length) {
                            case 2:
                                if (childActivity.getParentBranchID() == 0 && childs[1].getParentBranchID() == 1) {
                                    check = 1;
                                }
                                break;
                            case 3:
                                if (childActivity.getParentBranchID() == 0) {
                                    check = 1;
                                }
                                break;
                        }
                    }
                    if (parentActivity != null && parentActivity.getActivityTypeID() != "bpf_root" && !check) {
                        connectorSegments = GenericWorkflowDesigner.Settings.graphics.createConnectorDOM(startPoint, endPoint, "line", childActivity.getParentBranchID());
                        jQuery.each(connectorSegments, function (index, segment) {
                            canvasObj.$el.append(segment);
                        });
                    }
                }
            };
            return BPFGraphics;
        })(GenericWorkflowDesigner.Graphics);
        ProcessDesigner.BPFGraphics = BPFGraphics;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// -----------------------------------------------------------------------
// <copyright file="ProcessActivityType.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        'use strict';
        var ProcessActivityType = (function () {
            function ProcessActivityType() {
            }
            ProcessActivityType.Empty = "empty";
            ProcessActivityType.Root = "root";
            ProcessActivityType.Condition = "condition";
            return ProcessActivityType;
        })();
        ProcessDesigner.ProcessActivityType = ProcessActivityType;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// -----------------------------------------------------------------------
// <copyright file="ProcessActivityDefinitionModel.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        'use strict';
        var Validation = MscrmControls.ProcessDesigner.Validation;
        var ProcessActivityDefinitionModel = (function (_super) {
            __extends(ProcessActivityDefinitionModel, _super);
            function ProcessActivityDefinitionModel(activityType) {
                _super.call(this, activityType);
                this._processStep = null;
                this.errCount = 0;
                this._showNotifications = true;
                this.propertyPageModel = null;
                this.setActivityTypeID(activityType);
            }
            Object.defineProperty(ProcessActivityDefinitionModel.prototype, "processStep", {
                get: function () {
                    return this._processStep;
                },
                set: function (value) {
                    if (this._processStep !== value) {
                        this._processStep = value;
                        this.initializeFromProcessStep();
                    }
                },
                enumerable: true,
                configurable: true
            });
            ProcessActivityDefinitionModel.prototype.initialize = function (options) {
                this.setWorkflowID("workflow0");
                if ($.isEmptyObject(this.get("Properties"))) {
                    var properties = this.getDefaultProperties();
                    this.set("Properties", properties);
                }
                this.setActivityTypeID(GenericWorkflowDesigner.ActivityType.Empty);
            };
            ProcessActivityDefinitionModel.prototype.reinitialize = function (activity) {
                var addModeName = ProcessDesigner.TelemetryEventReporter.GetAddModeNameForActivity(ProcessDesigner.BPFToolBarView.addMode);
                switch (activity.getActivityTypeID()) {
                    case ProcessDesigner.BPFActivityType.condition:
                        var self = activity;
                        var parentActivity = activity.getParent();
                        if (parentActivity) {
                            if (parentActivity.getActivityTypeID() == ProcessDesigner.BPFActivityType.stage) {
                                self._parentStageEntityName = parentActivity.entityName;
                            }
                            else if (parentActivity.getActivityTypeID() == ProcessDesigner.BPFActivityType.condition) {
                                self._parentStageEntityName = parentActivity.parentStageEntityName;
                            }
                        }
                        ProcessDesigner.TelemetryEventReporter.ReportTileAddedTelemetryEvent(addModeName, "", ProcessDesigner.BPFActivityType.condition, "");
                        break;
                    case ProcessDesigner.BPFActivityType.stage:
                        GenericWorkflowDesigner.Settings.isNewStageAdded = true;
                        ProcessDesigner.TelemetryEventReporter.ReportTileAddedTelemetryEvent(addModeName, activity.stageId, ProcessDesigner.BPFActivityType.stage, "");
                        _super.prototype.reinitialize.call(this, activity);
                        break;
                    default:
                        _super.prototype.reinitialize.call(this, activity);
                }
                GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.editDone);
            };
            ProcessActivityDefinitionModel.prototype.getDefaultProperties = function () {
                return {
                    Items: [],
                    UI: { Row: 0, Col: 0, readonlyMode: false },
                    ActiveItemIndex: 0
                };
            };
            ProcessActivityDefinitionModel.prototype.getParentStage = function () {
                var parentStage = this.getParent();
                if (CommonTypes.Types.Object.isNullOrUndefined(parentStage)) {
                    return null;
                }
                if (parentStage.getActivityTypeID() == ProcessDesigner.BPFActivityType.stage) {
                    return parentStage;
                }
                else {
                    return parentStage.getParentStage();
                }
            };
            ProcessActivityDefinitionModel.prototype.initializeFromProcessStep = function () {
                this.setActivityID(this._processStep.get_Id());
                this.setWorkflowID(this._processStep.get_workflow().get_Id());
            };
            ProcessActivityDefinitionModel.prototype.getAllowedDependentActivityTypes = function (slotType) {
                var _this = this;
                var activtyTypes = [ProcessDesigner.BPFActivityType.stage, ProcessDesigner.BPFActivityType.condition];
                var allowedActivityTypes = [];
                activtyTypes.forEach(function (activityType) {
                    var newActivity = GenericWorkflowDesigner.Settings.activityDefinitionFactory.createActivity(activityType);
                    var parentActivity = _this.getParent();
                    var currentActivity = _this;
                    var isParentValid = false;
                    var isChildValid = false;
                    switch (slotType) {
                        case GenericWorkflowDesigner.SlotType.InsertHorizontal:
                            isParentValid = (!parentActivity) ? true : (parentActivity.getAllowedDependentActivityTypes(GenericWorkflowDesigner.SlotType.InsertVertical).indexOf(activityType) > -1);
                            isChildValid = (newActivity.getAllowedDependentActivityTypes(GenericWorkflowDesigner.SlotType.InsertVertical).indexOf(currentActivity.getActivityTypeID()) > -1);
                            if (isParentValid == true && isChildValid == true) {
                                allowedActivityTypes.push(activityType);
                            }
                            break;
                        case GenericWorkflowDesigner.SlotType.TileHolder:
                            isParentValid = (!parentActivity) ? true : (currentActivity.getAllowedDependentActivityTypes(GenericWorkflowDesigner.SlotType.InsertVertical).indexOf(activityType) > -1);
                            var childActivities = currentActivity.getChildActivitiesSorted();
                            var isChildValid = (childActivities.length == 0) ? true : (newActivity.getAllowedDependentActivityTypes(GenericWorkflowDesigner.SlotType.InsertVertical).indexOf(childActivities[0].getActivityTypeID()) > -1);
                            if (isParentValid == true && isChildValid == true) {
                                allowedActivityTypes.push(activityType);
                            }
                            break;
                        case GenericWorkflowDesigner.SlotType.InsertVertical:
                            isParentValid = (!parentActivity) ? true : (parentActivity.getAllowedDependentActivityTypes(GenericWorkflowDesigner.SlotType.InsertVertical).indexOf(activityType) > -1);
                            if (isParentValid == true) {
                                allowedActivityTypes.push(activityType);
                            }
                            break;
                    }
                    ;
                });
                return allowedActivityTypes;
            };
            Object.defineProperty(ProcessActivityDefinitionModel.prototype, "showNotifications", {
                get: function () {
                    return this._showNotifications;
                },
                set: function (value) {
                    this._showNotifications = value;
                },
                enumerable: true,
                configurable: true
            });
            ProcessActivityDefinitionModel.prototype.addErrorMessage = function (id, errorMessage) {
                this.errCount++;
                return _super.prototype.addErrorMessage.call(this, id, errorMessage);
            };
            ProcessActivityDefinitionModel.prototype.addResult = function (result) {
                if (!result.isValid) {
                    this.addMultipleErrorMessages(result.errorMessages);
                }
                return result.isValid;
            };
            ProcessActivityDefinitionModel.prototype.validateChildren = function (children) {
                var status = true;
                for (var i = 0; i < children.length; i++) {
                    var child = children[i];
                    child.showNotifications = false;
                    status = child.validateActivity() && status;
                }
                return status;
            };
            ProcessActivityDefinitionModel.prototype.validateDependentOptionSetChildren = function (children) {
                var status = true;
                for (var i = 0; i < children.length; i++) {
                    var child = children[i];
                    child.showNotifications = false;
                    status = child.validateDependentOptionSetActivity() && status;
                }
                return status;
            };
            ProcessActivityDefinitionModel.prototype.validateChildrenVM = function (children) {
                var status = true;
                for (var i = 0; i < children.length; i++) {
                    var child = children[i];
                    child.showNotifications = false;
                    status = child.validateActivity() && status;
                }
                return status;
            };
            ProcessActivityDefinitionModel.prototype.validateCollection = function (children) {
                var status = true;
                for (var i = 0; i < children.length; i++) {
                    var child = children[i];
                    child.showNotifications = false;
                    status = child.validateActivity() && status;
                }
                return status;
            };
            ProcessActivityDefinitionModel.prototype.validateCollectionVM = function (children) {
                var status = true;
                for (var i = 0; i < children.length; i++) {
                    var child = children[i];
                    child.showNotifications = false;
                    status = child.validateActivity() && status;
                }
                return status;
            };
            ProcessActivityDefinitionModel.prototype.addNotifications = function () {
                if (this.showNotifications && !Validation.Engine.isFromPropertyPage()) {
                    var errors = this.getErrorMessages();
                    for (var id in errors) {
                        if (id === Validation.Engine.GlobalMessageID) {
                            GenericWorkflowDesigner.Settings.notification.AppendNotification(new GenericWorkflowDesigner.NotificationMessage(GenericWorkflowDesigner.MessageType.Error, errors[id]));
                        }
                    }
                    Validation.Errors.updateErrors(this);
                }
            };
            ProcessActivityDefinitionModel.prototype.clearErrorMessages = function () {
                this.errCount = 0;
                if (this.propertyPageModel != null)
                    this.propertyPageModel.clearErrorMessages();
                return _super.prototype.clearErrorMessages.call(this);
            };
            ProcessActivityDefinitionModel.prototype.addMultipleErrorMessages = function (errors) {
                this.errCount += _.size(errors);
                return _super.prototype.addMultipleErrorMessages.call(this, errors);
            };
            ProcessActivityDefinitionModel.prototype.getErrorCount = function () {
                var propertyViewCurrentModel = GenericWorkflowDesigner.PropertyView.getPropertyViewCurrentModel();
                if (this.cid == propertyViewCurrentModel.cid && Validation.Engine.isFromPropertyPage() && this.propertyPageModel) {
                    return this.propertyPageModel.getErrorCount() + this._getSubViewsErrorCount();
                }
                else {
                    return this._getErrorCount();
                }
            };
            ProcessActivityDefinitionModel.prototype._getErrorCount = function () {
                return this.errCount;
            };
            ProcessActivityDefinitionModel.prototype._getSubViewsErrorCount = function () {
                return 0;
            };
            ProcessActivityDefinitionModel.prototype.getChildrenErrorCount = function (children) {
                var errCount = 0;
                if (children) {
                    for (var i = 0; i < children.length; i++) {
                        var child = children[i];
                        errCount += child.getErrorCount();
                    }
                }
                return errCount;
            };
            ProcessActivityDefinitionModel.prototype.getErrorTile = function () {
                return this;
            };
            ProcessActivityDefinitionModel.prototype.getCanvasTile = function () {
                return null;
            };
            ProcessActivityDefinitionModel.prototype.markInvalid = function () {
                this.isValid = false;
                this.addNotifications();
                return this.isValid;
            };
            ProcessActivityDefinitionModel.prototype.validateOnChange = function () {
                var bRet = true;
                bRet = this.validateOnAction(Validation.Level.Change);
                return bRet;
            };
            ProcessActivityDefinitionModel.prototype.___internalValidationSetPropertyPageModel = function (value) {
                this.propertyPageModel = value;
            };
            ProcessActivityDefinitionModel.prototype.validateOnAction = function (action) {
                var bRet = true;
                Validation.Engine.setAction(action);
                Validation.Engine.setFromPropertyPage((Validation.Engine.getAction() == Validation.Level.Apply) || (Validation.Engine.getAction() == Validation.Level.Change));
                GenericWorkflowDesigner.Settings.notification.ClearNotifications();
                this.clearWarningMessages();
                this.clearErrorMessages();
                GenericWorkflowDesigner.PropertyView.getPropertyViewCurrentModel().clearErrorMessages();
                if (ProcessDesigner.ValidateBPF.shouldValidate()) {
                    if (Validation.Engine.isFromPropertyPage()) {
                        Validation.Engine.setAction(Validation.Engine.getLastAction());
                    }
                    bRet = this.validateActivity();
                    if (Validation.Engine.isFromPropertyPage()) {
                        Validation.Errors.updateTileErrorStatus((action == Validation.Level.Apply));
                    }
                    if (bRet) {
                        if (Validation.Engine.getLastAction() == Validation.Level.Save && Validation.Errors.getCount() == 0) {
                            Validation.Engine.resetLastAction();
                        }
                    }
                }
                Validation.Engine.setFromPropertyPage(false);
                Validation.Engine.resetAction();
                return bRet;
            };
            ProcessActivityDefinitionModel.prototype.validateActivity = function () {
                this.clearErrorMessages();
                if (ProcessDesigner.ValidateBPF.shouldValidate()) {
                    var status = this._validateActivity();
                    if (!status) {
                        this.addNotifications();
                    }
                    this.isValid = status;
                }
                return this.isValid;
            };
            ProcessActivityDefinitionModel.prototype.validateDependentOptionSetActivity = function () {
                this.clearErrorMessages();
                var status = this._validateDependentOptionSetActivity();
                if (!status) {
                    this.addNotifications();
                }
                this.isValid = status;
                return this.isValid;
            };
            ProcessActivityDefinitionModel.prototype._validateActivity = function () {
                throw new Error("Internal : Method not implemented");
            };
            ProcessActivityDefinitionModel.prototype._validateDependentOptionSetActivity = function () {
                return true;
            };
            ProcessActivityDefinitionModel.PropertyTreeHeight = "TreeHeight";
            ProcessActivityDefinitionModel.PropertyTreeWidth = "TreeWidth";
            return ProcessActivityDefinitionModel;
        })(GenericWorkflowDesigner.ActivityDefinitionModel);
        ProcessDesigner.ProcessActivityDefinitionModel = ProcessActivityDefinitionModel;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// -----------------------------------------------------------------------
// <copyright file="RootActivity.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
/// <reference path="../Common/ProcessActivityType.ts"/>
/// <reference path="ProcessActivityDefinitionModel.ts"/>
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        'use strict';
        var RootActivity = (function (_super) {
            __extends(RootActivity, _super);
            function RootActivity() {
                _super.call(this, ProcessDesigner.ProcessActivityType.Root);
            }
            RootActivity.prototype.initialize = function (options) {
                _super.prototype.initialize.call(this, options);
                this.setRow(0);
                this.setCol(0);
            };
            return RootActivity;
        })(ProcessDesigner.ProcessActivityDefinitionModel);
        ProcessDesigner.RootActivity = RootActivity;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// -----------------------------------------------------------------------
// <copyright file="ProcessActivityDefinitionFactory.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
/// <reference path="RootActivity.ts"/>
/// <reference path="ProcessActivityDefinitionModel.ts"/>
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        'use strict';
        var DefaultActivityDefinitionFactory = GenericWorkflowDesigner.DefaultActivityDefinitionFactory;
        var ProcessActivityDefinitionFactory = (function (_super) {
            __extends(ProcessActivityDefinitionFactory, _super);
            function ProcessActivityDefinitionFactory() {
                _super.apply(this, arguments);
            }
            ProcessActivityDefinitionFactory.prototype.createActivity = function (activityType) {
                switch (activityType) {
                    case ProcessDesigner.ProcessActivityType.Root:
                        return new ProcessDesigner.RootActivity();
                    default:
                        return new ProcessDesigner.ProcessActivityDefinitionModel(activityType);
                }
            };
            return ProcessActivityDefinitionFactory;
        })(DefaultActivityDefinitionFactory);
        ProcessDesigner.ProcessActivityDefinitionFactory = ProcessActivityDefinitionFactory;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
//---------------------------------------------------------------------------------------------
// <copyright file="BPFActivityDefinitionFactory.ts" company="Microsoft">
//		Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
//
// <summary>
// Factories to instantiate new instance of process activities given the activity type
// </summary>
//
//---------------------------------------------------------------------------------------------
/// <reference path="../../../Process/Model/ProcessActivityDefinitionFactory.ts"/>
/// <reference path="../../Common/BPFActivityType.ts"/>
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        var BPFActivityDefinitionFactory = (function (_super) {
            __extends(BPFActivityDefinitionFactory, _super);
            function BPFActivityDefinitionFactory() {
                _super.apply(this, arguments);
            }
            BPFActivityDefinitionFactory.prototype.createActivity = function (activityType) {
                switch (activityType) {
                    case ProcessDesigner.BPFActivityType.stage:
                        return new ProcessDesigner.BPFStageActivity();
                    case ProcessDesigner.BPFActivityType.root:
                        return new ProcessDesigner.BPFRootActivity();
                    case ProcessDesigner.BPFActivityType.condition:
                        return new ProcessDesigner.BPFConditionActivity();
                    case ProcessDesigner.BPFActivityType.step:
                        return new ProcessDesigner.BPFStepActivity();
                    case ProcessDesigner.BPFActivityType.workflow:
                        return new ProcessDesigner.BPFWorkflowActivity();
                    case ProcessDesigner.BPFActivityType.action:
                        return new ProcessDesigner.BPFActionStepActivity();
                    case ProcessDesigner.BPFActivityType.flow:
                        return new ProcessDesigner.BPFFlowStepActivity();
                    case ProcessDesigner.BPFActivityType.globalWorkflow:
                        return new ProcessDesigner.BPFGlobalWorkflowActivity();
                    default:
                        return _super.prototype.createActivity.call(this, activityType);
                }
            };
            return BPFActivityDefinitionFactory;
        })(ProcessDesigner.ProcessActivityDefinitionFactory);
        ProcessDesigner.BPFActivityDefinitionFactory = BPFActivityDefinitionFactory;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// -----------------------------------------------------------------------
// <copyright file="BPFActivityDefinitionCollection.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        "use strict";
        var BPFActivityDefinitionCollection = (function (_super) {
            __extends(BPFActivityDefinitionCollection, _super);
            function BPFActivityDefinitionCollection() {
                _super.call(this);
            }
            BPFActivityDefinitionCollection.prototype.UpdatePositions = function () {
                var row = 0, pre_row;
                var startColumn = 0;
                var length = 0, maxLength = 0;
                var UpdatePositionsRecursive = function (root, column, row) {
                    var left = 0, right = 0, pre_row = 0;
                    root.setRow(row);
                    root.setCol(column);
                    var children = root.getChildActivitiesSorted();
                    var step = 0;
                    var maxDepth = 0;
                    for (var i = 0; i < children.length; i++) {
                        if (i == 0)
                            pre_row = row;
                        maxDepth = 0;
                        var childLength = children.length;
                        switch (childLength) {
                            case 1:
                                if (children[i].getParentBranchID() == 2)
                                    row += 1;
                                break;
                            case 2:
                                if (children[i].getParentBranchID() == 2) {
                                    if (children[0].getParentBranchID() == 1) {
                                        maxDepth = GenericWorkflowDesigner.Settings.workflowTree.getMaxDepth(children[0]);
                                        row = row + maxDepth + 1;
                                    }
                                    else {
                                        row += 1;
                                    }
                                }
                                break;
                            case 3:
                                if (children[i].getParentBranchID() == 2) {
                                    maxDepth = GenericWorkflowDesigner.Settings.workflowTree.getMaxDepth(children[1]);
                                    row = row + maxDepth + 1;
                                }
                                break;
                        }
                        if (root.attributes.ActivityTypeID == "condition" && children[i].attributes.ParentBranchID == 0) {
                            if (children[1] != undefined)
                                left = ProcessDesigner.BPFWorkflowTree.prototype.getMaxDrift(children[1]);
                            if (children[2] != undefined)
                                right = ProcessDesigner.BPFWorkflowTree.prototype.getMaxDrift(children[2]);
                            if (left > right)
                                maxLength = left;
                            else
                                maxLength = right;
                            UpdatePositionsRecursive(children[i], column + maxLength + 1, row);
                        }
                        else {
                            UpdatePositionsRecursive(children[i], column + 1, row);
                        }
                    }
                    row = pre_row;
                };
                var root = this.getWorkflowDefinitionRoot();
                UpdatePositionsRecursive(root, startColumn, row);
            };
            return BPFActivityDefinitionCollection;
        })(GenericWorkflowDesigner.ActivityDefinitionCollection);
        ProcessDesigner.BPFActivityDefinitionCollection = BPFActivityDefinitionCollection;
        ;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
//  <copyright file="BPFGlobalWorkflowActivity.ts" company="Microsoft">
//  Copyright (c) Microsoft Corporation.  All rights reserved.
//  </copyright>
// 
//  <summary>
//  Represent the Global Workflow activity of the business process
//  </summary>
/// <reference path="../../common/bpfactivitytype.ts" />
/// <reference path="../../../process/common/processactivitytype.ts" />
/// <reference path="../../../process/model/processactivitydefinitionmodel.ts" />
/// <reference path="../../common/bpfjsonobjects.ts" />
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        'use strict';
        var BPFGlobalWorkflowActivity = (function (_super) {
            __extends(BPFGlobalWorkflowActivity, _super);
            function BPFGlobalWorkflowActivity() {
                _super.call(this, ProcessDesigner.BPFActivityType.globalWorkflow);
                this.workflows = [];
                this.count = 0;
                this._description = "";
                this._name = "";
                this._name = "Gloabl Workflow";
            }
            BPFGlobalWorkflowActivity.prototype.initialize = function (properties) {
                _super.prototype.initialize.call(this, properties);
            };
            Object.defineProperty(BPFGlobalWorkflowActivity.prototype, "description", {
                get: function () {
                    return this._description;
                },
                set: function (value) {
                    this._description = value;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BPFGlobalWorkflowActivity.prototype, "name", {
                get: function () {
                    return this._name;
                },
                set: function (value) {
                    this._name = value;
                },
                enumerable: true,
                configurable: true
            });
            BPFGlobalWorkflowActivity.prototype.setNewWorkflows = function (NewWorkflows) {
                this.workflows = NewWorkflows;
            };
            BPFGlobalWorkflowActivity.prototype._validateActivity = function () {
                var status = true;
                var result = null;
                if (ProcessDesigner.Validation.Engine.isAllowedLevel(ProcessDesigner.Validation.Level.Save)) {
                    status = this.validateChildren(this.workflows) && status;
                }
                return status;
            };
            BPFGlobalWorkflowActivity.prototype.clearErrorMessages = function () {
                _super.prototype.clearErrorMessages.call(this);
                for (var i = 0; i < this.workflows.length; i++) {
                    var tempStatus = this.workflows[i].clearErrorMessages();
                }
            };
            BPFGlobalWorkflowActivity.prototype._getErrorCount = function () {
                return this.errCount + this.getChildrenErrorCount(this.workflows);
            };
            return BPFGlobalWorkflowActivity;
        })(ProcessDesigner.ProcessActivityDefinitionModel);
        ProcessDesigner.BPFGlobalWorkflowActivity = BPFGlobalWorkflowActivity;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
//  <copyright file="BPFWorkflowActivity.ts" company="Microsoft">
//         Copyright (c) Microsoft Corporation.  All rights reserved.
//  </copyright>
//
//  <summary>
//  Represent the workflow activity of the business process
//  </summary>
/// <reference path="../../common/bpfactivitytype.ts" />
/// <reference path="../../../process/common/processactivitytype.ts" />
/// <reference path="../../../process/model/processactivitydefinitionmodel.ts" />
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        'use strict';
        var FlowStep = Microsoft.Crm.Workflow.ObjectModel.FlowStep;
        var Utility = _Microsoft.Client.Telemetry.Utility;
        var WorkflowObjectModel = Microsoft.Crm.Workflow.ObjectModel;
        var ProcessTriggerData = Microsoft.Crm.Workflow.ObjectModel.ProcessTriggerData;
        var BPFWorkflowActivity = (function (_super) {
            __extends(BPFWorkflowActivity, _super);
            function BPFWorkflowActivity() {
                _super.call(this, ProcessDesigner.BPFActivityType.workflow);
                this._attributeDisplayName = "";
                this._uniqueName = "";
                this._triggerEvents = [];
                this._defaultWorkflowName = ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_WorkFlow_NewWorkflowName");
                this._classId = "";
                this._systemStepType = "";
                this._description = this.defaultWorkflowName;
                this.classId = "";
            }
            Object.defineProperty(BPFWorkflowActivity.prototype, "parentStage", {
                get: function () {
                    return this._parentStage;
                },
                set: function (value) {
                    if (this._parentStage !== value) {
                        this._parentStage = value;
                    }
                },
                enumerable: true,
                configurable: true
            });
            BPFWorkflowActivity.prototype.getLookupItems = function () {
                return this._lookupItems;
            };
            BPFWorkflowActivity.prototype.setLookupItems = function (lookupItems) {
                this._lookupItems = lookupItems;
            };
            BPFWorkflowActivity.prototype.getLookupContext = function () {
                if (CommonTypes.Types.Object.isNullOrUndefined(this._lookupContext)) {
                    var entitySetName = "workflows";
                    var filter;
                    if (!this.isGlobalWorkflow())
                        filter = "type eq 1 and category eq 0 and ondemand eq true and statecode eq 1 and primaryentity eq '" + this.parentStage.entityName + "'";
                    else
                        filter = "type eq 1 and category eq 0 and ondemand eq true and statecode eq 1 and primaryentity eq '" + (GenericWorkflowDesigner.Settings.workflowTree.getWorkflowDefinitionRoot()).entityName + "'";
                    var numberOfRecords = 10;
                    var attributes = ["name", "mode"];
                    var lookupContext = new ProcessDesigner.LookupContext(entitySetName, attributes, numberOfRecords, filter, this.lookupMoreRecords, this.lookupSuccessCallback, null, this, this.postLookupItemSelection, ProcessDesigner.BPFActivityType.workflow);
                    this._lookupContext = lookupContext;
                }
                return this._lookupContext;
            };
            BPFWorkflowActivity.prototype.postLookupItemSelection = function () {
                if (window.hasOwnProperty('showUnsavedChangesNote')) {
                    window['showUnsavedChangesNote'].call();
                }
            };
            BPFWorkflowActivity.getValueHash = function (value) {
                var valuesHash = new MscrmControls.ProcessDesigner.Dictionary();
                if (CommonTypes.Types.Object.isNullOrUndefined(value))
                    return valuesHash;
                var valueJson = JSON.parse(value);
                for (var i = 0; i < valueJson.length; i++) {
                    var key = valueJson[i].name;
                    var resultValue = valueJson[i].value;
                    valuesHash[key] = resultValue;
                }
                return valuesHash;
            };
            BPFWorkflowActivity.setModelWorkflow = function (callback) {
                var currentLookupItem;
                if (GenericWorkflowDesigner.currentModel instanceof BPFWorkflowActivity) {
                    var currentModel = GenericWorkflowDesigner.currentModel;
                    currentLookupItem = new GenericWorkflowDesigner.LookupItem(currentModel.processId, currentModel.uniqueName, window["Xrm"].Page.context.getClientUrl() + "/sfa/workflow/edit.aspx?id=" + currentModel.processId, BPFWorkflowSymbol.symbol);
                }
                else
                    currentLookupItem = null;
                callback(currentLookupItem);
            };
            BPFWorkflowActivity.isSelectedWorkflowEntityDifferent = function (entityName) {
                if (GenericWorkflowDesigner.currentModel instanceof BPFWorkflowActivity) {
                    var currentModel = GenericWorkflowDesigner.currentModel;
                    var stageEntityName = "";
                    if (currentModel.isGlobalWorkflow()) {
                        stageEntityName = GenericWorkflowDesigner.Settings.workflowTree.getWorkflowDefinitionRoot().entityName;
                    }
                    else {
                        stageEntityName = currentModel.parentStage.entityName;
                    }
                    stageEntityName = Xrm.Internal.getEntityDisplayName(stageEntityName);
                    return stageEntityName != entityName;
                }
                return false;
            };
            BPFWorkflowActivity.prototype.lookupMoreRecords = function (callback, callbackContext) {
                var processControl = window["ProcessControl"];
                var showNewBtn = window["_Process_IsSMBSalesApp"] ? false : true;
                var workflowDialog = processControl.Configuration.BPFClientProxy.launchWorkflowLookupDialog(BPFWorkflowActivity.lookupMoreRecordsViewId, function (dialogParams, callbackParams) {
                    var lookupControlItems = dialogParams["items"];
                    if (lookupControlItems.length > 0) {
                        var workflowId = lookupControlItems[0].id;
                        var valueHash = {};
                        valueHash = BPFWorkflowActivity.getValueHash(lookupControlItems[0].values);
                        var entityName = valueHash["primaryentity"];
                        if (BPFWorkflowActivity.isSelectedWorkflowEntityDifferent(entityName)) {
                            var dialogDetails = {
                                dialogTitle: ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_ErrorTitle"),
                                dialogMessage: GenericWorkflowDesigner.currentModel.isGlobalWorkflow() ? ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_WorkFlowProcess_Entity_ErrorMessage") : ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_WorkFlowStage_Entity_ErrorMessage"),
                                messageType: ProcessDesigner.BPFDialogMessageTypes.Warning,
                                width: 200,
                                height: 400
                            };
                            GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.showDialog, dialogDetails);
                            BPFWorkflowActivity.setModelWorkflow(callback);
                        }
                        else {
                            if (!CommonTypes.Types.Object.isNullOrUndefined(valueHash["mode"]))
                                BPFWorkflowActivity.workflowRecords[workflowId] = parseInt(valueHash["mode"]);
                            var selectedWorkflowName = lookupControlItems[0].name;
                            var url = window["Xrm"].Page.context.getClientUrl() + "/sfa/workflow/edit.aspx?id=" + workflowId;
                            $("#WorkflowTxtLookup").val(selectedWorkflowName);
                            $('#displayName').text(selectedWorkflowName);
                            var lookupItem = new GenericWorkflowDesigner.LookupItem(workflowId, selectedWorkflowName, url, BPFWorkflowSymbol.symbol);
                            callback(lookupItem);
                        }
                    }
                    else {
                        BPFWorkflowActivity.setModelWorkflow(callback);
                    }
                    if (!CommonTypes.Types.Object.isNullOrUndefined(workflowDialog))
                        workflowDialog.close();
                }, showNewBtn);
            };
            Object.defineProperty(BPFWorkflowActivity.prototype, "attributeDisplayName", {
                get: function () {
                    return this._attributeDisplayName;
                },
                set: function (value) {
                    if (this._attributeDisplayName !== value) {
                        this._attributeDisplayName = value;
                    }
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BPFWorkflowActivity.prototype, "actionStepId", {
                get: function () {
                    return this._actionStepId;
                },
                set: function (value) {
                    if (this._actionStepId !== value) {
                        this._actionStepId = value;
                    }
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BPFWorkflowActivity.prototype, "actionType", {
                get: function () {
                    if (this._actionType == null) {
                        if (!CommonTypes.Types.Object.isNullOrUndefined(BPFWorkflowActivity.workflowRecords[this.processId])) {
                            if (BPFWorkflowActivity.workflowRecords[this.processId] == BPFWorkflowMode.AsyncWorkflow)
                                this._actionType = BPFWorkflowActionType.AsyncWorkflow;
                            else
                                this._actionType = BPFWorkflowActionType.SyncWorkflow;
                        }
                    }
                    return this._actionType;
                },
                set: function (value) {
                    if (this._actionType !== value) {
                        this._actionType = value;
                    }
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BPFWorkflowActivity.prototype, "description", {
                get: function () {
                    return this._description;
                },
                set: function (value) {
                    if (this._description !== value) {
                        this._description = value;
                    }
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BPFWorkflowActivity.prototype, "processId", {
                get: function () {
                    return this._processId;
                },
                set: function (value) {
                    if (this._processId !== value) {
                        this._processId = value;
                    }
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BPFWorkflowActivity.prototype, "uniqueName", {
                get: function () {
                    return this._uniqueName;
                },
                set: function (value) {
                    if (this._uniqueName !== value) {
                        this._uniqueName = value;
                    }
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BPFWorkflowActivity.prototype, "triggerEvents", {
                get: function () {
                    return this._triggerEvents;
                },
                set: function (value) {
                    if (value.length != 0) {
                        this._triggerEvents = value;
                    }
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BPFWorkflowActivity.prototype, "defaultWorkflowName", {
                get: function () {
                    return this._defaultWorkflowName;
                },
                set: function (value) {
                    if (this._defaultWorkflowName !== value) {
                        this._defaultWorkflowName = value;
                    }
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BPFWorkflowActivity.prototype, "isNewlyAdded", {
                get: function () {
                    return this._isNewlyAdded;
                },
                set: function (value) {
                    if (this._isNewlyAdded !== value) {
                        this._isNewlyAdded = value;
                    }
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BPFWorkflowActivity.prototype, "classId", {
                get: function () {
                    return this._classId;
                },
                set: function (value) {
                    if (this._classId !== value) {
                        this._classId = value;
                    }
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BPFWorkflowActivity.prototype, "systemStepType", {
                get: function () {
                    return this._systemStepType;
                },
                set: function (value) {
                    if (this._systemStepType !== value) {
                        this._systemStepType = value;
                    }
                },
                enumerable: true,
                configurable: true
            });
            BPFWorkflowActivity.prototype.initialize = function (properties) {
                _super.prototype.initialize.call(this, properties);
                this.actionStepId = Utility.newGuid();
                this._actionStepId = this.actionStepId;
                this.setActivityTypeID(ProcessDesigner.BPFActivityType.workflow);
            };
            BPFWorkflowActivity.prototype.lookupSuccessCallback = function (workflowRecords, callbackContext) {
                var lookupItems = BPFWorkflowActivity.convertWorkflowRecordsIntoLookupItems(workflowRecords);
                callbackContext.setLookupItems(lookupItems);
                return lookupItems;
            };
            BPFWorkflowActivity.convertWorkflowRecordsIntoLookupItems = function (workflowRecords) {
                var lookupItems = [];
                if (!CommonTypes.Types.Object.isNullOrUndefined(workflowRecords) && workflowRecords.length > 0) {
                    jQuery.each(workflowRecords, function (index, workflowRecord) {
                        var id = workflowRecord.workflowid;
                        var name = workflowRecord.name;
                        var mode = workflowRecord.mode;
                        var url = window["Xrm"].Page.context.getClientUrl() + "/sfa/workflow/edit.aspx?id=" + workflowRecord.workflowid;
                        var lookupItem = new GenericWorkflowDesigner.LookupItem(id, name, url, BPFWorkflowSymbol.symbol);
                        lookupItems.push(lookupItem);
                        BPFWorkflowActivity.workflowRecords[id] = mode;
                    });
                }
                return lookupItems;
            };
            BPFWorkflowActivity.prototype.getTriggerEvent = function (triggerName) {
                var triggerEvent = new Microsoft.Crm.Workflow.ObjectModel.ProcessTriggerData();
                var triggerEventName;
                var triggerEventValue;
                var filterId;
                switch (triggerName) {
                    case ProcessDesigner.BPFWorkflowTriggerValues.StageExit:
                        triggerEventName = ProcessDesigner.BPFWorkflowTriggerTypes.StageExit;
                        triggerEventValue = ProcessDesigner.BPFWorkflowPipelineStage.preEvent;
                        filterId = this._parentStage.stageId;
                        break;
                    case ProcessDesigner.BPFWorkflowTriggerValues.StageEntry:
                        triggerEventName = ProcessDesigner.BPFWorkflowTriggerTypes.StageEnter;
                        triggerEventValue = ProcessDesigner.BPFWorkflowPipelineStage.postEvent;
                        filterId = this._parentStage.stageId;
                        break;
                    case ProcessDesigner.BPFWorkflowTriggerValues.ProcessApplied:
                        triggerEventName = ProcessDesigner.BPFWorkflowTriggerTypes.ProcessApplied;
                        triggerEventValue = ProcessDesigner.BPFWorkflowPipelineStage.postEvent;
                        filterId = MscrmControls.ProcessDesigner.processId;
                        break;
                    case ProcessDesigner.BPFWorkflowTriggerValues.ProcessReactivated:
                        triggerEventName = ProcessDesigner.BPFWorkflowTriggerTypes.ProcessStatusChange;
                        triggerEventValue = ProcessDesigner.BPFWorkflowPipelineStage.postEvent;
                        filterId = MscrmControls.ProcessDesigner.BPFProcessStatus.Active;
                        break;
                    case ProcessDesigner.BPFWorkflowTriggerValues.ProcessAbandon:
                        triggerEventName = ProcessDesigner.BPFWorkflowTriggerTypes.ProcessStatusChange;
                        triggerEventValue = ProcessDesigner.BPFWorkflowPipelineStage.postEvent;
                        filterId = MscrmControls.ProcessDesigner.BPFProcessStatus.Aborted;
                        break;
                    case ProcessDesigner.BPFWorkflowTriggerValues.ProcessFinished:
                        triggerEventName = ProcessDesigner.BPFWorkflowTriggerTypes.ProcessStatusChange;
                        triggerEventValue = ProcessDesigner.BPFWorkflowPipelineStage.postEvent;
                        filterId = ProcessDesigner.BPFProcessStatus.Finished;
                        break;
                }
                triggerEvent.set_Event(triggerEventName);
                triggerEvent.set_FilterId(filterId);
                triggerEvent.set_PipelineStageId(triggerEventValue);
                return triggerEvent;
            };
            BPFWorkflowActivity.prototype.InitializeFromProcessStep = function () {
                _super.prototype.initializeFromProcessStep.call(this);
            };
            BPFWorkflowActivity.prototype.preparePropertyDetails = function () {
                var target = {
                    _attributeName: this.attributeDisplayName,
                    _description: this.description,
                    _defaultWorkflowName: this.defaultWorkflowName
                };
                return JSON.stringify(target);
            };
            BPFWorkflowActivity.prototype.generateActionStepJson = function (workflowStep) {
                var actionStep = new WorkflowObjectModel.ActionStep(workflowStep);
                actionStep.set_workflow(workflowStep);
                actionStep.set_Description(this.defaultWorkflowName);
                actionStep.set_actionId(this.actionStepId);
                actionStep.set_actionType(this.actionType);
                actionStep.set_processId(this.processId);
                actionStep.set_uniqueName(this.uniqueName);
                actionStep.set_triggerEvents(this.triggerEvents);
                return actionStep;
            };
            BPFWorkflowActivity.prototype.generateFlowStepJson = function (workflowStep) {
                var flowStep = new FlowStep(workflowStep);
                flowStep.set_workflow(workflowStep);
                flowStep.set_Description(this.defaultWorkflowName);
                flowStep.set_uniqueName(this.uniqueName);
                flowStep.set_workflowId(this.processId);
                flowStep.set_actionId(this.actionStepId);
                return flowStep;
            };
            BPFWorkflowActivity.prototype._validateActivity = function () {
                var status = true;
                var result = null;
                status = this.validateProperties() && status;
                return status;
            };
            BPFWorkflowActivity.prototype.validateProperties = function () {
                var status = true;
                var result = null;
                result = ProcessDesigner.Validation.Engine.validateField("#displayName", this.uniqueName, ProcessDesigner.Validation.Required.apply, ProcessDesigner.Validation.Level.Change, ProcessDesigner.MetadataProvider.getLocalizedString("ProcessDesignerControl_PBL_NonEmptyValueMessage"), null);
                status = this.addResult(result) && status;
                if (status) {
                }
                result = ProcessDesigner.Validation.Engine.validateField("#TriggerDropDown", this.triggerEvents, ProcessDesigner.Validation.Required.apply, ProcessDesigner.Validation.Level.Change, ProcessDesigner.MetadataProvider.getLocalizedString("ProcessDesignerControl_PBL_NonEmptyValueMessage"), null);
                if (this.triggerEvents.length > 0 && this.triggerEvents[0] instanceof ProcessTriggerData)
                    result = ProcessDesigner.Validation.Engine.validateField("#TriggerDropDown", this.triggerEvents[0].get_Event(), ProcessDesigner.Validation.Required.apply, ProcessDesigner.Validation.Level.Change, ProcessDesigner.MetadataProvider.getLocalizedString("ProcessDesignerControl_PBL_NonEmptyValueMessage"), null);
                status = this.addResult(result) && status;
                return status;
            };
            BPFWorkflowActivity.prototype.getErrorTile = function () {
                if (this.parentStage != null) {
                    return this.parentStage;
                }
                else {
                    return ProcessDesigner.ControlManager.globalWorkflowObject;
                }
            };
            BPFWorkflowActivity.prototype.getCanvasTile = function () {
                return this;
            };
            BPFWorkflowActivity.prototype.getAllowedDependentActivityTypes = function (slotType) {
                return [];
            };
            BPFWorkflowActivity.prototype.getCloneOfActivity = function () {
                var newActivity = new BPFWorkflowActivity();
                newActivity.setWorkflowID(this.getWorkflowID());
                newActivity.uniqueName = this.uniqueName;
                newActivity.attributeDisplayName = this.attributeDisplayName;
                newActivity.defaultWorkflowName = this.defaultWorkflowName;
                newActivity.description = this.description;
                newActivity.actionStepId = this.actionStepId;
                newActivity.actionType = this.actionType;
                newActivity.processId = this.processId;
                newActivity.triggerEvents = this.getCloneOftriggerEvents();
                return newActivity;
            };
            BPFWorkflowActivity.prototype.getCloneOftriggerEvents = function () {
                var self = this;
                if (!CommonTypes.Types.Object.isNullOrUndefined(self.triggerEvents)) {
                    var newtriggerEvents = [];
                    jQuery.each(self.triggerEvents, function (index, triggerEvent) {
                        var newtriggerEvent = new ProcessTriggerData();
                        newtriggerEvent.set_Event(triggerEvent.get_Event());
                        newtriggerEvent.set_FilterId(triggerEvent.get_FilterId());
                        newtriggerEvent.set_PipelineStageId(triggerEvent.get_PipelineStageId());
                        newtriggerEvents.push(newtriggerEvent);
                    });
                    return newtriggerEvents;
                }
                return null;
            };
            BPFWorkflowActivity.prototype.updateStageId = function (stageId) {
                jQuery.each(this.triggerEvents, function (index, triggerEvent) {
                    triggerEvent.set_FilterId(stageId);
                });
            };
            BPFWorkflowActivity.prototype.getPropertyPageClone = function () {
                var newActivity = new BPFWorkflowActivity();
                newActivity.uniqueName = this.uniqueName;
                newActivity.attributeDisplayName = this.attributeDisplayName;
                newActivity.defaultWorkflowName = this.defaultWorkflowName;
                newActivity.description = this.description;
                newActivity.actionStepId = this.actionStepId;
                newActivity.actionType = this.actionType;
                newActivity.processId = this.processId;
                newActivity.triggerEvents = this.triggerEvents;
                return newActivity;
            };
            BPFWorkflowActivity.prototype.isGlobalWorkflow = function () {
                if (this._triggerEvents.length > 0) {
                    var event = this._triggerEvents[0].get_Event();
                    if (!CommonTypes.Types.Object.isNullOrUndefined(event) && (event.toLowerCase() == "stageenter" || this._triggerEvents[0].get_Event().toLowerCase() == "stageexit"))
                        return false;
                    else
                        return true;
                }
                else {
                    if (this._parentStage != null)
                        return false;
                    else
                        return true;
                }
            };
            BPFWorkflowActivity.lookupMoreRecordsViewId = "45102185-B1B4-422b-A3BF-F1BA9C6E130A";
            BPFWorkflowActivity.workflowRecords = [];
            return BPFWorkflowActivity;
        })(ProcessDesigner.ProcessActivityDefinitionModel);
        ProcessDesigner.BPFWorkflowActivity = BPFWorkflowActivity;
        var BPFWorkflowActionType = (function () {
            function BPFWorkflowActionType() {
            }
            BPFWorkflowActionType.AsyncWorkflow = 3;
            BPFWorkflowActionType.SyncWorkflow = 2;
            return BPFWorkflowActionType;
        })();
        ProcessDesigner.BPFWorkflowActionType = BPFWorkflowActionType;
        var BPFWorkflowMode = (function () {
            function BPFWorkflowMode() {
            }
            BPFWorkflowMode.AsyncWorkflow = 0;
            BPFWorkflowMode.SyncWorkflow = 1;
            return BPFWorkflowMode;
        })();
        ProcessDesigner.BPFWorkflowMode = BPFWorkflowMode;
        var BPFWorkflowSymbol = (function () {
            function BPFWorkflowSymbol() {
            }
            BPFWorkflowSymbol.symbol = "workflowSymbol ";
            return BPFWorkflowSymbol;
        })();
        ProcessDesigner.BPFWorkflowSymbol = BPFWorkflowSymbol;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// -----------------------------------------------------------------------
// <copyright file="BPFWorkflowTree.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        'use strict';
        var BPFWorkflowTree = (function (_super) {
            __extends(BPFWorkflowTree, _super);
            function BPFWorkflowTree() {
                _super.apply(this, arguments);
            }
            BPFWorkflowTree.prototype.getMaxDrift = function (activity) {
                var childActivities = activity.getChildActivitiesSorted();
                switch (childActivities.length) {
                    case 0:
                        return 1;
                    case 1:
                        return this.getMaxDrift(childActivities[0]) + 1;
                    case 2:
                        if (childActivities[0].attributes.ParentBranchID == 0)
                            return this.getMaxDrift(childActivities[0]) + this.getMaxDrift(childActivities[1]) + 1;
                        else
                            return Math.max(this.getMaxDrift(childActivities[0]), this.getMaxDrift(childActivities[1])) + 1;
                    case 3:
                        return this.getMaxDrift(childActivities[0])
                            + Math.max(this.getMaxDrift(childActivities[1]), this.getMaxDrift(childActivities[2]))
                            + 1;
                }
            };
            BPFWorkflowTree.prototype.getMaxDepth = function (activity) {
                if (activity) {
                    var childActivities = activity.getChildActivitiesSorted();
                    var length = childActivities.length;
                    switch (length) {
                        case 0:
                            return 0;
                        case 1:
                            if (childActivities[length - 1].getParentBranchID() == ProcessDesigner.branchType.Else)
                                return this.getMaxDepth(childActivities[0]) + 1;
                            else
                                return this.getMaxDepth(childActivities[0]);
                        case 2:
                            if (childActivities[length - 1].getParentBranchID() == ProcessDesigner.branchType.Else)
                                return this.getMaxDepth(childActivities[0]) + this.getMaxDepth(childActivities[1]) + 1;
                            else
                                return Math.max(this.getMaxDepth(childActivities[0]), this.getMaxDepth(childActivities[1])) + 1;
                        case 3:
                            return Math.max(this.getMaxDepth(childActivities[0]), (this.getMaxDepth(childActivities[1])) + this.getMaxDepth(childActivities[2]))
                                + 1;
                    }
                }
            };
            BPFWorkflowTree.prototype.insertChildActivityComponentAtIndex = function (parentActivity, childActivityComponent, parentBranchID) {
                var self = this;
                var childActivities = parentActivity.getChildActivitiesSorted();
                var childActivity = childActivityComponent.getRoot();
                var oldParent = childActivity.getParent();
                var deferred = $.Deferred();
                var promiseList = [];
                childActivity.setParentActivityID(parentActivity.getActivityID());
                childActivity.setParentBranchID(parentBranchID);
                var length = childActivities.length;
                switch (length) {
                    case 0:
                        childActivity.setNextActivityID(GenericWorkflowDesigner.ActivityType.Empty);
                        break;
                    case 1:
                        var branchID = childActivities[0].getParentBranchID();
                        switch (branchID) {
                            case ProcessDesigner.branchType.Default:
                                childActivity.setNextActivityID(childActivities[0].getActivityID());
                                if (parentActivity.getNextActivityID())
                                    parentActivity.setNextActivityID(GenericWorkflowDesigner.ActivityType.Empty);
                                break;
                            case ProcessDesigner.branchType.If:
                                childActivity.setNextActivityID(GenericWorkflowDesigner.ActivityType.Empty);
                                break;
                        }
                        break;
                    case 2:
                        childActivity.setNextActivityID(childActivities[0].getActivityID());
                        if (parentActivity.getNextActivityID())
                            parentActivity.setNextActivityID(GenericWorkflowDesigner.ActivityType.Empty);
                        break;
                }
                ;
                if (childActivity.getActivityTypeID() != GenericWorkflowDesigner.ActivityType.Empty) {
                    var promise = childActivity.save();
                    promiseList.push(promise);
                }
                self.add(childActivity);
                $.when.apply(self, promiseList).done(function () {
                    deferred.resolveWith(childActivity, [childActivity]);
                });
                return deferred.promise();
            };
            BPFWorkflowTree.prototype.insertActivityComponentAfter = function (parentActivity, insertActivityComponent) {
                var self = this;
                var childActivities = parentActivity.getChildActivitiesSorted();
                var deferred = $.Deferred();
                var promiseList = [], activity;
                var insertActivity = insertActivityComponent.getRoot();
                var promise = insertActivity.save().done(function () {
                    var length = childActivities.length;
                    switch (length) {
                        case 0:
                            if (parentActivity.getActivityTypeID() == ProcessDesigner.BPFActivityType.condition) {
                                insertActivity.setParentActivityID(parentActivity.getActivityID());
                                insertActivity.setParentBranchID(ProcessDesigner.branchType.If);
                            }
                            else {
                                insertActivity.setParentActivityID(parentActivity.getActivityID());
                                insertActivity.setParentBranchID(ProcessDesigner.branchType.Default);
                            }
                            if (parentActivity.getNextActivityID() != GenericWorkflowDesigner.ActivityType.Empty) {
                                insertActivity.setNextActivityID(parentActivity.getNextActivityID());
                                parentActivity.setNextActivityID(GenericWorkflowDesigner.ActivityType.Empty);
                            }
                            break;
                        case 1:
                            if (parentActivity.getActivityTypeID() == ProcessDesigner.BPFActivityType.condition) {
                                var parentBranchID = childActivities[0].getParentBranchID();
                                switch (parentBranchID) {
                                    case ProcessDesigner.branchType.Default:
                                        insertActivity.setParentActivityID(parentActivity.getActivityID());
                                        insertActivity.setParentBranchID(ProcessDesigner.branchType.If);
                                        if (parentActivity.getNextActivityID()) {
                                            insertActivity.setNextActivityID(childActivities[0].getActivityID());
                                        }
                                        break;
                                    case ProcessDesigner.branchType.If:
                                        insertActivity.setParentActivityID(parentActivity.getActivityID());
                                        insertActivity.setParentBranchID(ProcessDesigner.branchType.If);
                                        childActivities[0].setParentActivityID(insertActivity.getActivityID());
                                        childActivities[0].setParentBranchID(ProcessDesigner.branchType.Default);
                                        if (parentActivity.getNextActivityID()) {
                                            insertActivity.setNextActivityID(parentActivity.getNextActivityID());
                                        }
                                        break;
                                    case ProcessDesigner.branchType.Else:
                                        insertActivity.setParentActivityID(parentActivity.getActivityID());
                                        insertActivity.setParentBranchID(ProcessDesigner.branchType.If);
                                        if (parentActivity.getNextActivityID()) {
                                            insertActivity.setNextActivityID(parentActivity.getNextActivityID());
                                            parentActivity.setNextActivityID(GenericWorkflowDesigner.ActivityType.Empty);
                                        }
                                        break;
                                }
                                ;
                            }
                            else {
                                insertActivity.setParentActivityID(parentActivity.getActivityID());
                                insertActivity.setParentBranchID(ProcessDesigner.branchType.Default);
                                childActivities[0].setParentActivityID(insertActivity.getActivityID());
                                if (insertActivity.getActivityTypeID() == ProcessDesigner.BPFActivityType.condition) {
                                    childActivities[0].setParentBranchID(ProcessDesigner.branchType.Default);
                                    insertActivity.setNextActivityID(childActivities[0].getActivityID());
                                }
                            }
                            break;
                        case 2:
                            var parentBranchID = childActivities[0].getParentBranchID();
                            switch (parentBranchID) {
                                case ProcessDesigner.branchType.Default:
                                    if (childActivities[1].getParentBranchID() == ProcessDesigner.branchType.Else) {
                                        insertActivity.setParentActivityID(parentActivity.getActivityID());
                                        insertActivity.setParentBranchID(ProcessDesigner.branchType.If);
                                        insertActivity.setNextActivityID(childActivities[0].getActivityID());
                                        if (parentActivity.getNextActivityID() != "empty" || parentActivity.getNextActivityID() != null)
                                            parentActivity.setNextActivityID(GenericWorkflowDesigner.ActivityType.Empty);
                                        childActivities[0].setParentBranchID(ProcessDesigner.branchType.Default);
                                    }
                                    else {
                                        insertActivity.setParentActivityID(parentActivity.getActivityID());
                                        insertActivity.setParentBranchID(ProcessDesigner.branchType.If);
                                        childActivities[1].setParentActivityID(insertActivity.getActivityID());
                                        childActivities[1].setParentBranchID(ProcessDesigner.branchType.Default);
                                    }
                                    break;
                                case ProcessDesigner.branchType.If:
                                    insertActivity.setParentActivityID(parentActivity.getActivityID());
                                    insertActivity.setParentBranchID(ProcessDesigner.branchType.If);
                                    childActivities[0].setParentActivityID(insertActivity.getActivityID());
                                    childActivities[0].setParentBranchID(ProcessDesigner.branchType.Default);
                                    break;
                            }
                            ;
                            break;
                        case 3:
                            insertActivity.setParentActivityID(parentActivity.getActivityID());
                            insertActivity.setParentBranchID(ProcessDesigner.branchType.If);
                            childActivities[1].setParentActivityID(insertActivity.getActivityID());
                            childActivities[1].setParentBranchID(ProcessDesigner.branchType.Default);
                            break;
                    }
                    if (childActivities[0]) {
                        promise = childActivities[0].save();
                        promiseList.push(promise);
                    }
                    if (childActivities[1]) {
                        promise = childActivities[1].save();
                        promiseList.push(promise);
                    }
                    if (parentActivity)
                        parentActivity.save();
                    insertActivity.save();
                    self.add(insertActivity);
                    $.when.apply(self, promiseList).done(function () {
                        deferred.resolveWith(insertActivity, [insertActivity]);
                    });
                });
                promiseList.push(promise);
                return deferred.promise();
            };
            BPFWorkflowTree.prototype.insertActivityComponentBefore = function (activity, insertComponent) {
                var self = this;
                var deferred = $.Deferred();
                var root = insertComponent.getRoot();
                root.setParentActivityID(activity.getParentActivityID());
                root.setParentBranchID(activity.getParentBranchID());
                root.save().done(function () {
                    self.add(root);
                    activity.setParentActivityID(root.getActivityID());
                    if (root.getActivityTypeID() == ProcessDesigner.BPFActivityType.condition && activity.getParentBranchID() == ProcessDesigner.branchType.Else) {
                        activity.setParentBranchID(ProcessDesigner.branchType.If);
                    }
                    else {
                        activity.setParentBranchID(ProcessDesigner.branchType.Default);
                    }
                    if (root.getActivityTypeID() == ProcessDesigner.BPFActivityType.condition) {
                        root.setNextActivityID(activity.getActivityID());
                    }
                    activity.save().done(function () {
                        deferred.resolveWith(root, [root]);
                    });
                });
                return deferred.promise();
            };
            BPFWorkflowTree.prototype.cutConnectedComponent = function (component) {
                var self = this;
                var deferred = $.Deferred();
                var promiseList = [];
                var activityToCut = component.getRoot();
                var branchIndex = activityToCut.getParentBranchID();
                var oldParent;
                var oldParentActivityID;
                if (activityToCut == GenericWorkflowDesigner.Settings.workflowTree.getWorkflowDefinitionRoot()) {
                    oldParent = activityToCut;
                    oldParentActivityID = activityToCut.getParentActivityID();
                }
                else {
                    oldParent = activityToCut.getParent();
                    if (oldParent == null) {
                        deferred.resolve();
                        return deferred.promise();
                    }
                    oldParentActivityID = oldParent.getActivityID();
                }
                var oldParentChildren = oldParent.getChildActivitiesSorted();
                var activityToCutBranchId = activityToCut.getParentBranchID();
                jQuery.each(component.getOrphanChildren(), function (index, child) {
                    if (child.getActivityTypeID() == GenericWorkflowDesigner.ActivityType.Empty) {
                        self.remove(child);
                    }
                });
                var activitiesToMove = self.getActivitiesToMoveOnCut(component);
                var numberOfActivitiesToBeInserted = activitiesToMove.length;
                jQuery.each(oldParentChildren, function (index, activity) {
                    var branchID = activity.getParentBranchID();
                    if (branchID > activityToCutBranchId) {
                        activity.setParentBranchID(branchID + numberOfActivitiesToBeInserted - 1);
                        var promise = activity.save();
                        promiseList.push(promise);
                    }
                });
                var allActivities = GenericWorkflowDesigner.Settings.workflowTree.getWorkflowDefinition();
                var nextStage = activityToCut.getChildActivitiesSorted()[0];
                if (nextStage) {
                    jQuery.each(allActivities, function (index, currentActivity) {
                        if (currentActivity.getNextActivityID() == activityToCut.getActivityID()) {
                            if (nextStage)
                                currentActivity.setNextActivityID(nextStage.getActivityID());
                            else
                                currentActivity.setNextActivityID(GenericWorkflowDesigner.ActivityType.Empty);
                        }
                    });
                }
                else {
                    if (activityToCut.getNextActivityID()) {
                        var parentActivity = activityToCut.getParent();
                        if (parentActivity) {
                            if (parentActivity.getActivityTypeID() == ProcessDesigner.BPFActivityType.condition) {
                                var branchId = activityToCut.getParentBranchID();
                                switch (branchId) {
                                    case ProcessDesigner.branchType.Default:
                                        var children = parentActivity.getChildActivitiesSorted();
                                        if (children.length == 1 && children[0].getActivityID() == activityToCut.getActivityID()) {
                                            parentActivity.setNextActivityID(activityToCut.getNextActivityID());
                                        }
                                        else {
                                            jQuery.each(allActivities, function (index, currentActivity) {
                                                if (currentActivity.getNextActivityID() == activityToCut.getActivityID()) {
                                                    if (activityToCut.getNextActivityID()) {
                                                        currentActivity.setNextActivityID(activityToCut.getNextActivityID());
                                                    }
                                                    else {
                                                        currentActivity.setNextActivityID(GenericWorkflowDesigner.ActivityType.Empty);
                                                    }
                                                }
                                            });
                                        }
                                        break;
                                    case ProcessDesigner.branchType.If:
                                        parentActivity.setNextActivityID(activityToCut.getNextActivityID());
                                        activityToCut.setNextActivityID(GenericWorkflowDesigner.ActivityType.Empty);
                                        break;
                                    case ProcessDesigner.branchType.Else:
                                        parentActivity.setNextActivityID(activityToCut.getNextActivityID());
                                        activityToCut.setNextActivityID(GenericWorkflowDesigner.ActivityType.Empty);
                                        break;
                                }
                                ;
                            }
                            else {
                                parentActivity.setNextActivityID(activityToCut.getNextActivityID());
                                activityToCut.setNextActivityID(GenericWorkflowDesigner.ActivityType.Empty);
                            }
                        }
                    }
                }
                jQuery.each(activitiesToMove, function (index, child) {
                    child.setParentActivityID(oldParentActivityID);
                    child.setParentBranchID(branchIndex);
                    promiseList.push(child.save());
                    branchIndex++;
                });
                activityToCut.setParentActivityID(null);
                $.when.apply(self, promiseList).done(function () {
                    deferred.resolve();
                });
                return deferred.promise();
            };
            BPFWorkflowTree.prototype.traverseActivityTreeForward = function (currentActivity, activitiesInOrder) {
                if (!CommonTypes.Types.Object.isNullOrUndefined(currentActivity)) {
                    activitiesInOrder.push(currentActivity);
                }
                var childrenOfCurrentActivity = this.getChildActivities(currentActivity);
                if (currentActivity instanceof ProcessDesigner.BPFStageActivity && childrenOfCurrentActivity.length == 1 && !CommonTypes.Types.Object.isNullOrUndefined(childrenOfCurrentActivity[0])) {
                    activitiesInOrder = this.traverseActivityTreeForward(childrenOfCurrentActivity[0], activitiesInOrder);
                }
                else if (currentActivity instanceof ProcessDesigner.BPFConditionActivity) {
                    var yesBranchActivity = null;
                    var noBranchActivity = null;
                    var defaultBranchActivity = null;
                    childrenOfCurrentActivity.forEach(function (childActivity) {
                        if (childActivity.getParentBranchID() == ProcessDesigner.DefaultBranchIndices.YesBranch) {
                            yesBranchActivity = childActivity;
                        }
                        else if (childActivity.getParentBranchID() == ProcessDesigner.DefaultBranchIndices.NoBranch) {
                            noBranchActivity = childActivity;
                        }
                        else {
                            defaultBranchActivity = childActivity;
                        }
                    });
                    if (!CommonTypes.Types.Object.isNullOrUndefined(yesBranchActivity)) {
                        activitiesInOrder = this.traverseActivityTreeForward(yesBranchActivity, activitiesInOrder);
                    }
                    if (!CommonTypes.Types.Object.isNullOrUndefined(noBranchActivity)) {
                        activitiesInOrder = this.traverseActivityTreeForward(noBranchActivity, activitiesInOrder);
                    }
                    if (!CommonTypes.Types.Object.isNullOrUndefined(defaultBranchActivity)) {
                        activitiesInOrder = this.traverseActivityTreeForward(defaultBranchActivity, activitiesInOrder);
                    }
                }
                return activitiesInOrder;
            };
            BPFWorkflowTree.prototype.getStageActivitiesOrdered = function () {
                var activitiesInOrder = [];
                var stageActivities = [];
                var rootActivity = this.getWorkflowDefinitionRoot();
                activitiesInOrder = this.traverseActivityTreeForward(rootActivity, activitiesInOrder);
                activitiesInOrder.forEach(function (activity) {
                    if (activity instanceof ProcessDesigner.BPFStageActivity) {
                        stageActivities.push(activity);
                    }
                });
                return stageActivities;
            };
            BPFWorkflowTree.prototype.getStageActivities = function () {
                var stageActivities = [];
                this.getActivities().forEach(function (activity) {
                    if (activity instanceof ProcessDesigner.BPFStageActivity) {
                        stageActivities.push(activity);
                    }
                });
                return stageActivities;
            };
            BPFWorkflowTree.prototype.getAllChildActivities = function (activity) {
                var allChildActivities = [];
                var self = this;
                $(this.getChildActivities(activity)).each(function (index, childActivity) {
                    allChildActivities.push(childActivity);
                    if (!childActivity.isLeaf()) {
                        allChildActivities = allChildActivities.concat(self.getAllChildActivities(childActivity));
                    }
                });
                return allChildActivities;
            };
            return BPFWorkflowTree;
        })(GenericWorkflowDesigner.WorkflowTree);
        ProcessDesigner.BPFWorkflowTree = BPFWorkflowTree;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// -----------------------------------------------------------------------
// <copyright file="IProcessToActivityCollectionVisitor.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
// -----------------------------------------------------------------------
// <copyright file="ProcessToActivityCollectionVisitor.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
/// <reference path="iprocesstoactivitycollectionvisitor.ts" />
/// <reference path="../model/processactivitydefinitionmodel.ts" />
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        var ConditionBranchDisplayMode = Microsoft.Crm.Workflow.ObjectModel.ConditionBranchDisplayMode;
        var ProcessToActivityCollectionVisitor = (function (_super) {
            __extends(ProcessToActivityCollectionVisitor, _super);
            function ProcessToActivityCollectionVisitor() {
                _super.call(this);
                this.collection = null;
                this.currentParent = null;
                this.currentParentBranchId = ProcessToActivityCollectionVisitor.defaultParentBranchId;
                this.activityDefinitionFactory = null;
                this.activityDefinitionFactory = new ProcessDesigner.BPFActivityDefinitionFactory();
                this.collection = new ProcessDesigner.BPFActivityDefinitionCollection();
            }
            ProcessToActivityCollectionVisitor.prototype.convert = function (root) {
                this.visitWorkflowStep(root);
                return this.collection;
            };
            ProcessToActivityCollectionVisitor.prototype.visitConditionBranchStep = function (conditionBranchStep) {
                var conditionBranchActivity = null;
                var displayMode = conditionBranchStep.get_conditionBranchDisplayMode();
                if (displayMode === ConditionBranchDisplayMode.IF ||
                    displayMode === ConditionBranchDisplayMode.elseIf) {
                    conditionBranchActivity = this.createActivity(conditionBranchStep, ProcessDesigner.ProcessActivityType.Condition);
                    this.currentParent = conditionBranchActivity;
                    this.currentParentBranchId = ProcessDesigner.DefaultBranchIndices.YesBranch;
                }
                this.visitSteps(conditionBranchStep);
                this.currentParent = conditionBranchActivity;
            };
            ProcessToActivityCollectionVisitor.prototype.visitConditionStep = function (conditionStep) {
                var firstCondition = null;
                var steps = conditionStep.get_Steps();
                for (var i = 0; i < steps.get_Count(); ++i) {
                    steps.get_item(i).apply(this);
                    this.currentParentBranchId = ProcessDesigner.DefaultBranchIndices.NoBranch;
                    if (i === 0) {
                        firstCondition = this.currentParent;
                    }
                }
                this.currentParent = firstCondition;
                this.currentParentBranchId = ProcessDesigner.DefaultBranchIndices.DefaultBranch;
            };
            ProcessToActivityCollectionVisitor.prototype.visitWorkflowStep = function (workflowStep) {
                var model = this.createActivity(workflowStep, ProcessDesigner.ProcessActivityType.Root);
                this.currentParent = model;
                this.currentParentBranchId = ProcessToActivityCollectionVisitor.defaultParentBranchId;
                this.visitSteps(workflowStep);
            };
            ProcessToActivityCollectionVisitor.prototype.visitSteps = function (step) {
                var steps = step.get_Steps();
                for (var i = 0; i < steps.get_Count(); ++i) {
                    steps.get_item(i).apply(this);
                }
            };
            ProcessToActivityCollectionVisitor.prototype.createActivity = function (step, activityType) {
                var activity = this.activityDefinitionFactory.createActivity(activityType);
                if (this.currentParent !== null) {
                    activity.setParentActivityID(this.currentParent.getActivityID());
                    activity.setParentBranchID(this.currentParentBranchId);
                }
                activity.processStep = step;
                if (activityType != ProcessDesigner.BPFActivityType.root)
                    this.collection.add(activity);
                return activity;
            };
            ProcessToActivityCollectionVisitor.prototype.visitEntityStep = function (entityStep) { };
            ProcessToActivityCollectionVisitor.prototype.visitSetAttributeValueStep = function (setAttributeValueStep) { };
            ProcessToActivityCollectionVisitor.prototype.visitSetDisplayModeStep = function (setDisplayModeStep) { };
            ProcessToActivityCollectionVisitor.prototype.visitSetFieldRequiredLevelStep = function (setFieldRequiredLevelStep) { };
            ProcessToActivityCollectionVisitor.prototype.visitSetMessageStep = function (setMessageStep) { };
            ProcessToActivityCollectionVisitor.prototype.visitSetVisibilityStep = function (setVisibilityStep) { };
            ProcessToActivityCollectionVisitor.prototype.visitStageStep = function (stageStep) { };
            ProcessToActivityCollectionVisitor.prototype.visitPageStep = function (pageStep) { };
            ProcessToActivityCollectionVisitor.prototype.visitStepStep = function (stepStep) { };
            ProcessToActivityCollectionVisitor.prototype.visitControlStep = function (controlStep) { };
            ProcessToActivityCollectionVisitor.prototype.visitActionStep = function (actionStep) { };
            ProcessToActivityCollectionVisitor.prototype.visitCustomJavascriptStep = function (customJSStep) { };
            ProcessToActivityCollectionVisitor.prototype.visitCreateStep = function (createStep) { };
            ProcessToActivityCollectionVisitor.prototype.visitCustomActivityStep = function (customActivityStep) { };
            ProcessToActivityCollectionVisitor.prototype.visitAssignStep = function (assignStep) { };
            ProcessToActivityCollectionVisitor.prototype.visitChildWorkflowStep = function (childWorkflowStep) { };
            ProcessToActivityCollectionVisitor.prototype.visitSendEmailStep = function (sendEmailStep) { };
            ProcessToActivityCollectionVisitor.prototype.visitSetStateStep = function (setStateStep) { };
            ProcessToActivityCollectionVisitor.prototype.visitUpdateStep = function (updateStep) { };
            ProcessToActivityCollectionVisitor.prototype.visitWaitBranchStep = function (waitBranchStep) { };
            ProcessToActivityCollectionVisitor.prototype.visitWaitStep = function (waitStep) { };
            ProcessToActivityCollectionVisitor.prototype.visitWaitTimeoutStep = function (waitTimeoutStep) { };
            ProcessToActivityCollectionVisitor.prototype.visitStopWorkflowStep = function (stopWorkflowStep) { };
            ProcessToActivityCollectionVisitor.prototype.visitRollupRuleStep = function (rollupRuleStep) { };
            ProcessToActivityCollectionVisitor.prototype.visitSetDefaultValueStep = function (setDefaultValueStep) { };
            ProcessToActivityCollectionVisitor.prototype.visitSetNextStageStep = function (setNextStageStep) { };
            ProcessToActivityCollectionVisitor.prototype.visitRelationshipCollectionStep = function (relationshipCollectionStep) { };
            ProcessToActivityCollectionVisitor.prototype.visitRelationshipStep = function (relationshipStep) { };
            ProcessToActivityCollectionVisitor.prototype.visitInteractionStep = function (interactionStep) { };
            ProcessToActivityCollectionVisitor.prototype.visitInteractionPageStep = function (interactionPageStep) { };
            ProcessToActivityCollectionVisitor.prototype.visitChildInteractiveWorkflowStep = function (childWorkflowStep) { };
            ProcessToActivityCollectionVisitor.prototype.visitAssignVariableStep = function (assignVariableStep) { };
            ProcessToActivityCollectionVisitor.prototype.visitQueryStep = function (queryStep) { };
            ProcessToActivityCollectionVisitor.defaultParentBranchId = 0;
            return ProcessToActivityCollectionVisitor;
        })(Microsoft.Crm.Workflow.ObjectModel.StepVisitorBase);
        ProcessDesigner.ProcessToActivityCollectionVisitor = ProcessToActivityCollectionVisitor;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// -----------------------------------------------------------------------
// <copyright file="StageRelationship.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        var StageRelationship = (function () {
            function StageRelationship(relationshipStep, source) {
                this._step = null;
                this._source = null;
                this._step = relationshipStep;
                this._source = source;
            }
            Object.defineProperty(StageRelationship.prototype, "step", {
                get: function () {
                    return this._step;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(StageRelationship.prototype, "sourceStep", {
                get: function () {
                    return this._source;
                },
                enumerable: true,
                configurable: true
            });
            return StageRelationship;
        })();
        ProcessDesigner.StageRelationship = StageRelationship;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
//  <copyright file="BPFStepActivity.ts" company="Microsoft">
//         Copyright (c) Microsoft Corporation.  All rights reserved.
//  </copyright>
// 
//  <summary>
//  Represent the step activity of the business process
//  </summary>
/// <reference path="../../common/bpfactivitytype.ts" />
/// <reference path="../../../process/common/processactivitytype.ts" />
/// <reference path="../../../process/model/processactivitydefinitionmodel.ts" />
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        'use strict';
        var Utility = _Microsoft.Client.Telemetry.Utility;
        var WorkflowObjectModel = Microsoft.Crm.Workflow.ObjectModel;
        var BPFStepActivity = (function (_super) {
            __extends(BPFStepActivity, _super);
            function BPFStepActivity() {
                _super.call(this, ProcessDesigner.BPFActivityType.step);
                this._attributeDisplayName = "";
                this._attributeName = "";
                this._parentPicklistLogicalName = "";
                this._childPicklistLogicalNames = null;
                this._defaultStepName = ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_BPFStepActivity_StepName");
                this._classId = "";
                this._systemStepType = "";
                this._isSystemControl = false;
                this._parameters = "";
                this._description = this.defaultStepName;
                this._isRequired = false;
                this.classId = "";
            }
            Object.defineProperty(BPFStepActivity.prototype, "parentStage", {
                get: function () {
                    return this._parentStage;
                },
                set: function (value) {
                    if (this._parentStage !== value) {
                        this._parentStage = value;
                    }
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BPFStepActivity.prototype, "controlStep", {
                get: function () {
                    return this._controlStep;
                },
                set: function (value) {
                    if (this._controlStep !== value) {
                        this._controlStep = value;
                    }
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BPFStepActivity.prototype, "attributeDisplayName", {
                get: function () {
                    return this._attributeDisplayName;
                },
                set: function (value) {
                    if (this._attributeDisplayName !== value) {
                        this._attributeDisplayName = value;
                    }
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BPFStepActivity.prototype, "stepId", {
                get: function () {
                    return this._stepId;
                },
                set: function (value) {
                    if (this._stepId !== value) {
                        this._stepId = value;
                    }
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BPFStepActivity.prototype, "currentStepId", {
                get: function () {
                    return this._currentStepId;
                },
                set: function (value) {
                    if (this._currentStepId !== value) {
                        this._currentStepId = value;
                    }
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BPFStepActivity.prototype, "description", {
                get: function () {
                    return this._description;
                },
                set: function (value) {
                    if (this._description !== value) {
                        this._description = value;
                    }
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BPFStepActivity.prototype, "isRequired", {
                get: function () {
                    return this._isRequired;
                },
                set: function (value) {
                    if (this._isRequired !== value) {
                        this._isRequired = value;
                    }
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BPFStepActivity.prototype, "isNewlyAdded", {
                get: function () {
                    return this._isNewlyAdded;
                },
                set: function (value) {
                    if (this._isNewlyAdded !== value) {
                        this._isNewlyAdded = value;
                    }
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BPFStepActivity.prototype, "sequence", {
                get: function () {
                    return this._sequence;
                },
                set: function (value) {
                    if (this._sequence !== value) {
                        this._sequence = value;
                    }
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BPFStepActivity.prototype, "attributeName", {
                get: function () {
                    return this._attributeName;
                },
                set: function (value) {
                    if (this._attributeName !== value) {
                        this._attributeName = value;
                    }
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BPFStepActivity.prototype, "attributeType", {
                get: function () {
                    return this._attributeType;
                },
                set: function (value) {
                    if (this._attributeType !== value) {
                        this._attributeType = value;
                    }
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BPFStepActivity.prototype, "parentPicklistLogicalName", {
                get: function () {
                    return this._parentPicklistLogicalName;
                },
                set: function (value) {
                    if (this._parentPicklistLogicalName !== value) {
                        this._parentPicklistLogicalName = value;
                    }
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BPFStepActivity.prototype, "childPicklistLogicalNames", {
                get: function () {
                    return this._childPicklistLogicalNames;
                },
                set: function (value) {
                    if (this._childPicklistLogicalNames !== value) {
                        this._childPicklistLogicalNames = value;
                    }
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BPFStepActivity.prototype, "defaultStepName", {
                get: function () {
                    return this._defaultStepName;
                },
                set: function (value) {
                    if (this._defaultStepName !== value) {
                        this._defaultStepName = value;
                    }
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BPFStepActivity.prototype, "classId", {
                get: function () {
                    return this._classId;
                },
                set: function (value) {
                    if (this._classId !== value) {
                        this._classId = value;
                    }
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BPFStepActivity.prototype, "systemStepType", {
                get: function () {
                    return this._systemStepType;
                },
                set: function (value) {
                    if (this._systemStepType !== value) {
                        this._systemStepType = value;
                    }
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BPFStepActivity.prototype, "isSystemControl", {
                get: function () {
                    return this._isSystemControl;
                },
                set: function (value) {
                    this._isSystemControl = value;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BPFStepActivity.prototype, "parameters", {
                get: function () {
                    return this._parameters;
                },
                set: function (value) {
                    this._parameters = value;
                },
                enumerable: true,
                configurable: true
            });
            BPFStepActivity.prototype.initialize = function (properties) {
                _super.prototype.initialize.call(this, properties);
                this.stepId = Utility.newGuid();
                this.setActivityTypeID(ProcessDesigner.BPFActivityType.step);
            };
            BPFStepActivity.prototype.InitializeFromProcessStep = function () {
                _super.prototype.initializeFromProcessStep.call(this);
            };
            BPFStepActivity.prototype.preparePropertyDetails = function () {
                var target = {
                    _attributeName: this.attributeName,
                    _isRequired: this.isRequired,
                    _description: this.description,
                    _defaultStepName: this.defaultStepName
                };
                return JSON.stringify(target);
            };
            BPFStepActivity.prototype.getStepLabel = function () {
                var stepLabel = new WorkflowObjectModel.StepLabel();
                stepLabel.set_description(this.description);
                stepLabel.set_labelId(this.stepId);
                stepLabel.set_languageCode(window._Process_CurrentLCID);
                return stepLabel;
            };
            BPFStepActivity.prototype.generateControlStepJson = function (workflowStep) {
                var controlStep = new WorkflowObjectModel.ControlStep(workflowStep);
                controlStep.set_workflow(workflowStep);
                controlStep.set_Description("");
                if (this.isSystemControl) {
                    var systemControlMetadata = ProcessDesigner.MetadataProvider.getSystemControlDataByLogicalName(this.attributeName, this.parentStage.entityName);
                    controlStep.set_classId(systemControlMetadata.get_classId());
                    controlStep.set_controlId(systemControlMetadata.get_controlId());
                    controlStep.set_isSystemControl(true);
                    if (ProcessDesigner.Util.isEmptyString(this.parameters)) {
                        this.parameters = systemControlMetadata.get_parameters();
                    }
                    controlStep.set_parameters(this.parameters);
                    if (systemControlMetadata.get_classId() == ProcessDesigner.FormControlClassId.LinkControl) {
                        controlStep.set_dataFieldName('');
                    }
                    else {
                        controlStep.set_dataFieldName(systemControlMetadata.get_logicalName());
                    }
                    controlStep.set_controlDisplayName(systemControlMetadata.get_displayText());
                    controlStep.set_systemStepType("");
                }
                else {
                    controlStep.set_classId(this.classId);
                    controlStep.set_controlId(this.attributeName);
                    controlStep.set_isSystemControl(false);
                    controlStep.set_parameters("");
                    if (!CommonTypes.Types.Object.isNullOrUndefined(this.attributeName)) {
                        controlStep.set_dataFieldName(this.attributeName);
                    }
                    controlStep.set_controlDisplayName(this.attributeDisplayName);
                    controlStep.set_systemStepType(this.systemStepType);
                }
                controlStep.set_isUnbound(false);
                controlStep.set_controlType("0");
                return controlStep;
            };
            BPFStepActivity.prototype.generateStepStepJson = function (workflowStep) {
                var stepStep = new WorkflowObjectModel.StepStep(workflowStep, this.defaultStepName);
                stepStep.set_workflow(workflowStep);
                stepStep.set_Description(this.defaultStepName);
                stepStep.set_isProcessRequired(this.isRequired);
                stepStep.set_isHidden(false);
                stepStep.set_stepStepId(this.stepId);
                stepStep.addLabel(this.getStepLabel());
                stepStep.appendStep(this.generateControlStepJson(workflowStep));
                return stepStep;
            };
            BPFStepActivity.prototype._validateActivity = function () {
                var status = true;
                var result = null;
                status = this.validateProperties() && status;
                return status;
            };
            BPFStepActivity.prototype._validateDependentOptionSetActivity = function () {
                return this.validateDependentOptionSetProperties();
            };
            BPFStepActivity.prototype.validateProperties = function () {
                var status = true;
                var result = null;
                result = ProcessDesigner.Validation.Engine.validateField("#attributeNameDropDown", this.attributeName, ProcessDesigner.Validation.Required.apply, ProcessDesigner.Validation.Level.Validate, ProcessDesigner.MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_BPFStepActivity_Field"), null);
                status = this.addResult(result) && status;
                if (result.isValid) {
                    status = this.validateDependentOptionSetProperties();
                }
                result = ProcessDesigner.Validation.Engine.validateField("#descriptionTextbox", this.description, ProcessDesigner.Validation.Required.apply, ProcessDesigner.Validation.Level.Change, ProcessDesigner.MetadataProvider.getLocalizedString("ProcessDesignerControl_PBL_NonEmptyValueMessage"), null);
                status = this.addResult(result) && status;
                return status;
            };
            BPFStepActivity.prototype.validateDependentOptionSetProperties = function () {
                var status = true;
                var isCompleteChain = true;
                var result = null;
                if (ProcessDesigner.MetadataProxy.isDependentOptionSetField(this.parentStage.entityName, this.attributeName)) {
                    if (this.parentPicklistLogicalName !== 'null') {
                        this.parentPicklistLogicalName = ProcessDesigner.MetadataProxy.getDependentPickListParentLogicalName(this.parentStage.entityName, this.attributeName);
                    }
                    var message = ProcessDesigner.MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_BPFStepActivity_DependentOptionSetField_WarningMessage");
                    isCompleteChain = this.IsDependentOptionSetParentAdded();
                    if (ProcessDesigner.ProcessDesignerControl.validationMode == GenericWorkflowDesigner.ValidationMode.Warning) {
                        if (!isCompleteChain) {
                            this.addWarningMessage("#attributeNameDropDown", message);
                        }
                        ProcessDesigner.ProcessDesignerControl.validationMode = (ProcessDesigner.ProcessDesignerControl.validationMode == GenericWorkflowDesigner.ValidationMode.Error) ? ProcessDesigner.ProcessDesignerControl.validationMode : GenericWorkflowDesigner.ValidationMode.None;
                    }
                    else if (ProcessDesigner.ProcessDesignerControl.validationMode == GenericWorkflowDesigner.ValidationMode.Error) {
                        result = ProcessDesigner.Validation.Engine.validateField("#attributeNameDropDown", isCompleteChain, ProcessDesigner.Validation.CompleteChain.apply, ProcessDesigner.Validation.Level.Validate, message, null);
                        status = this.addResult(result) && status;
                    }
                }
                return isCompleteChain;
            };
            BPFStepActivity.prototype.getPreviousStageActivities = function (parentStage, previousStageActivities) {
                if (parentStage != null) {
                    var stage = parentStage;
                    if (stage != null) {
                        previousStageActivities.push(parentStage);
                        parentStage = stage.getParentStage();
                        this.getPreviousStageActivities(parentStage, previousStageActivities);
                    }
                }
            };
            BPFStepActivity.prototype.isParentAttributeAdded = function (attributeDependentOptionSetMappings, parentName, parentOptionSetStages, stageId) {
                var result = true;
                result = !CommonTypes.Types.Object.isNullOrUndefined(attributeDependentOptionSetMappings[parentName]);
                if (result) {
                    var steps = attributeDependentOptionSetMappings[parentName];
                    _.each(steps.map(function (step) { return step.stageId; }), function (stageId) {
                        if (parentOptionSetStages.indexOf(stageId) == -1) {
                            parentOptionSetStages.push(stageId);
                        }
                    });
                    for (var i = 0; i < steps.length; i++) {
                        var parentLogicalName = steps[i].parentPicklistLogicalName;
                        var parentOptionSetStageId = steps[i].stageId;
                        if (!CommonTypes.Types.Object.isNullOrUndefined(parentLogicalName) && parentLogicalName !== "null" && parentLogicalName.length > 0) {
                            parentName = parentLogicalName;
                            stageId = parentOptionSetStageId;
                            return this.isParentAttributeAdded(attributeDependentOptionSetMappings, parentName, parentOptionSetStages, stageId);
                        }
                    }
                }
                return result;
            };
            BPFStepActivity.prototype.IsDependentOptionSetParentAdded = function () {
                var result = true;
                if (((ProcessDesigner.ProcessDesignerControl.validationMode == GenericWorkflowDesigner.ValidationMode.Warning) || (ProcessDesigner.ProcessDesignerControl.validationMode == GenericWorkflowDesigner.ValidationMode.Error) ||
                    (ProcessDesigner.Validation.Engine.getLastAction() >= ProcessDesigner.Validation.Level.Validate || (ProcessDesigner.ProcessDesignerControl.validationMode == GenericWorkflowDesigner.ValidationMode.Error && ProcessDesigner.Validation.Engine.getLastAction() >= ProcessDesigner.Validation.Level.Validate)))
                    && !CommonTypes.Types.Object.isNullOrUndefined(this.parentPicklistLogicalName)
                    && this.parentPicklistLogicalName.length > 0
                    && this.parentPicklistLogicalName !== "null") {
                    var currentAttributeName = this.attributeName;
                    var previousStageActivities = [];
                    var parentOptionSetStages = [];
                    this.getPreviousStageActivities(this.parentStage, previousStageActivities);
                    var parentStageId = this.parentStage.stageId;
                    var activities = GenericWorkflowDesigner.Settings.workflowTree.getAllConcreteActivities();
                    var currentStepId = this.currentStepId;
                    var branchedactvities = _.filter(activities, function (activity) { return activity.getActivityTypeID() == "stage" && activity.nextStageId == parentStageId; });
                    previousStageActivities = _.union(previousStageActivities, branchedactvities);
                    var attributeDependentOptionSetMappings = {};
                    _.each(previousStageActivities, function (stageActivity) {
                        _.each(stageActivity.steps, function (step) {
                            if (!CommonTypes.Types.Object.isNullOrUndefined(step.attributeName)
                                && step.getActivityTypeID() == "step"
                                && ProcessDesigner.MetadataProxy.isDependentOptionSetField(stageActivity.entityName, step.attributeName)
                                && step.attributeName.length > 0
                                && (step.stepId !== currentStepId
                                    || step.attributeName == currentAttributeName)) {
                                var stepProperties = !CommonTypes.Types.Object.isNullOrUndefined(attributeDependentOptionSetMappings[step.attributeName]) ?
                                    attributeDependentOptionSetMappings[step.attributeName] : [];
                                var attributeDependentOptionSetProperties = { parentPicklistLogicalName: "", childPicklistLogicalNames: null, stageId: stageActivity.stageId };
                                attributeDependentOptionSetProperties.parentPicklistLogicalName = ProcessDesigner.MetadataProxy.getDependentPickListParentLogicalName(stageActivity.entityName, step.attributeName);
                                attributeDependentOptionSetProperties.childPicklistLogicalNames = ProcessDesigner.MetadataProxy.getDependentPickListChildLogicalName(stageActivity.entityName, step.attributeName);
                                stepProperties.push(attributeDependentOptionSetProperties);
                                attributeDependentOptionSetMappings[step.attributeName] = stepProperties;
                            }
                        });
                    });
                    result = this.isParentAttributeAdded(attributeDependentOptionSetMappings, this.parentPicklistLogicalName, parentOptionSetStages, parentStageId);
                    if (result) {
                        var conditionBranches = _.filter(previousStageActivities, function (conditionBranch) {
                            if (!CommonTypes.Types.Object.isNullOrUndefined(conditionBranch.getParent()))
                                return conditionBranch.getParent().getActivityTypeID() == "condition"
                                    && conditionBranch.stageId !== parentStageId;
                        }).map(function (branch) { return branch.stageId; });
                        var parentOptionSetInConditionBranch = _.intersection(conditionBranches, parentOptionSetStages).length;
                        result = parentOptionSetInConditionBranch > 0 ? parentOptionSetInConditionBranch == conditionBranches.length : result;
                    }
                }
                return result;
            };
            BPFStepActivity.prototype.getErrorTile = function () {
                return this.parentStage;
            };
            BPFStepActivity.prototype.getCanvasTile = function () {
                return this;
            };
            BPFStepActivity.prototype.getAllowedDependentActivityTypes = function (slotType) {
                return [];
            };
            BPFStepActivity.prototype.getCloneOfActivity = function () {
                var newActivity = new BPFStepActivity();
                newActivity.setWorkflowID(this.getWorkflowID());
                newActivity.showNotifications = this.showNotifications;
                newActivity.systemStepType = this.systemStepType;
                newActivity.parameters = this.parameters;
                newActivity.classId = this.classId;
                newActivity.isSystemControl = this.isSystemControl;
                newActivity.attributeName = this.attributeName;
                newActivity.attributeDisplayName = this.attributeDisplayName;
                newActivity.attributeType = this.attributeType;
                newActivity.parentPicklistLogicalName = this.parentPicklistLogicalName;
                newActivity.defaultStepName = this.defaultStepName;
                newActivity.description = this.description;
                newActivity.isRequired = this.isRequired;
                newActivity.parentStage = this.parentStage;
                newActivity.setParentActivityID(this.getParentActivityID());
                return newActivity;
            };
            BPFStepActivity.prototype.getPropertyPageClone = function () {
                var newActivity = new BPFStepActivity();
                newActivity.attributeName = this.attributeName;
                newActivity.attributeDisplayName = this.attributeDisplayName;
                newActivity.defaultStepName = this.defaultStepName;
                newActivity.description = this.description;
                newActivity.isRequired = this.isRequired;
                newActivity.attributeType = this.attributeType;
                newActivity.parentPicklistLogicalName = this.parentPicklistLogicalName;
                newActivity.parentStage = this.parentStage;
                newActivity.currentStepId = this.stepId;
                return newActivity;
            };
            return BPFStepActivity;
        })(ProcessDesigner.ProcessActivityDefinitionModel);
        ProcessDesigner.BPFStepActivity = BPFStepActivity;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
/// <reference path="../../common/bpfactivitytype.ts" />
/// <reference path="../../../process/common/processactivitytype.ts" />
/// <reference path="../../../process/model/processactivitydefinitionmodel.ts" />
/// <reference path="bpfstepactivity.ts" />
// -----------------------------------------------------------------------
// <copyright file="BPFToActivityCollectionVisitor.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
/// <reference path="../../Process/Converter/ProcessToActivityCollectionVisitor.ts"/>
/// <reference path="../Model/StageRelationship.ts"/>
/// <reference path="../model/activity/IBPFStageActivity.ts"/>
/// <reference path="../model/activity/BPFStepActivity.ts"/>
/// <reference path="../model/activity/BPFGlobalWorkflowActivity.ts"/>
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        var ConditionBranchDisplayMode = Microsoft.Crm.Workflow.ObjectModel.ConditionBranchDisplayMode;
        var StageStep = Microsoft.Crm.Workflow.ObjectModel.StageStep;
        var StepStep = Microsoft.Crm.Workflow.ObjectModel.StepStep;
        var EntityStep = Microsoft.Crm.Workflow.ObjectModel.EntityStep;
        var BusinessProcessFlowVisitor = ProcessObjectModel.Visitors.BusinessProcessFlowVisitor;
        var Dictionary = (function () {
            function Dictionary() {
            }
            return Dictionary;
        })();
        var BpfToActivityCollectionVisitor = (function (_super) {
            __extends(BpfToActivityCollectionVisitor, _super);
            function BpfToActivityCollectionVisitor() {
                _super.call(this);
                this.visitedStages = new Dictionary();
                this.mergeParentReverseLookup = new Dictionary();
            }
            BpfToActivityCollectionVisitor.prototype.visitWorkflowStep = function (workflowStep) {
                ProcessDesigner.primaryEntity = workflowStep.get_primaryEntityName();
                this.businessProcessFlowVisitor = new BusinessProcessFlowVisitor();
                this.businessProcessFlowVisitor.visit(workflowStep);
                var model = this.createActivity(workflowStep, ProcessDesigner.BPFActivityType.root);
                ProcessDesigner.ProcessDesignerControl.Title = workflowStep.get_title();
                ProcessDesigner.ProcessDesignerControl.Description = workflowStep.get_Description();
                this.currentParent = model;
                this.currentParentBranchId = ProcessDesigner.ProcessToActivityCollectionVisitor.defaultParentBranchId;
                var steps = workflowStep.get_Steps();
                for (var i = 0; i < steps.get_Count(); ++i) {
                    steps.get_item(i).apply(this);
                }
                ProcessDesigner.processStep = workflowStep;
            };
            BpfToActivityCollectionVisitor.prototype.visitStageStep = function (stageStep) {
                var stageId = stageStep.get_stageId();
                var visited = this.visitedStages[stageId] != null;
                var model;
                if (!visited) {
                    model = this.createStageActivity(stageStep, ProcessDesigner.BPFActivityType.stage);
                    this.visitedStages[stageId] = model;
                }
                else {
                    model = this.visitedStages[stageId];
                }
                this.currentParent = model;
                this.currentStageActivity = model;
                this.currentParentBranchId = ProcessDesigner.ProcessToActivityCollectionVisitor.defaultParentBranchId;
                this.currentStepIndex = 1;
                if (!visited) {
                    var stepList = stageStep.get_Steps();
                    for (var i = 0; i < stepList.get_Count(); i++) {
                        this.currentParent = model;
                        stepList.get_item(i).apply(this);
                        if (stepList.get_item(i) instanceof StepStep) {
                            this.currentStepIndex++;
                        }
                    }
                }
            };
            BpfToActivityCollectionVisitor.prototype.visitStepStep = function (stepStep) {
                if (this.currentParent instanceof ProcessDesigner.BPFStageActivity) {
                    this.currentStageActivity = this.currentParent;
                }
                var model;
                if (stepStep.get_Steps().get_item(0) instanceof Microsoft.Crm.Workflow.ObjectModel.ControlStep) {
                    model = this.createStepActivity(stepStep, ProcessDesigner.BPFActivityType.step);
                    model.stepId = stepStep.get_stepStepId();
                    this.currentStepActivity = model;
                    this.visitSteps(stepStep);
                }
                else if (stepStep.get_Steps().get_item(0) instanceof Microsoft.Crm.Workflow.ObjectModel.ActionStep) {
                    ProcessDesigner.ControlManager.hasActionStep = true;
                    model = this.createProcessActionStepActivity(stepStep, ProcessDesigner.BPFActivityType.action);
                    model.stepId = stepStep.get_stepStepId();
                    var actionStep = stepStep.get_Steps().get_item(0);
                    this.visitSteps(actionStep);
                }
                else if (stepStep.get_Steps().get_item(0) instanceof Microsoft.Crm.Workflow.ObjectModel.FlowStep) {
                    ProcessDesigner.ControlManager.hasFlowStep = true;
                    model = this.createFlowStepActivity(stepStep, ProcessDesigner.BPFActivityType.flow);
                    model.stepId = stepStep.get_stepStepId();
                    var flowStep = stepStep.get_Steps().get_item(0);
                    this.visitSteps(flowStep);
                }
                this.currentStageActivity.steps.push(model);
            };
            BpfToActivityCollectionVisitor.prototype.visitActionStep = function (actionStep) {
                if (this.currentParent instanceof ProcessDesigner.BPFStageActivity) {
                    this.currentStageActivity = this.currentParent;
                }
                var model = this.createActionStepActivity(actionStep, ProcessDesigner.BPFActivityType.workflow);
                this.currentWorkflowActivity = model;
                this.visitSteps(actionStep);
                if (model.isGlobalWorkflow()) {
                    model.parentStage = null;
                    ProcessDesigner.ControlManager.globalWorkflowObject.workflows.push(model);
                }
                else {
                    this.currentStageActivity.workflows.push(model);
                }
            };
            BpfToActivityCollectionVisitor.prototype.visitControlStep = function (controlStep) {
                if (controlStep.get_isSystemControl()) {
                    this.currentStepActivity.isSystemControl = true;
                    var attributeName = controlStep.get_dataFieldName();
                    if (ProcessDesigner.Util.isEmptyString(attributeName)) {
                        attributeName = controlStep.get_controlId();
                    }
                    this.currentStepActivity.attributeName = attributeName;
                    var entityName = this.currentStepActivity.parentStage.entityName;
                    this.currentStepActivity.attributeDisplayName = ProcessDesigner.MetadataProvider.getSystemControlDataByLogicalName(attributeName, entityName).get_displayText();
                    this.currentStepActivity.parameters = controlStep.get_parameters();
                }
                else {
                    this.currentStepActivity.attributeName = controlStep.get_dataFieldName();
                    this.currentStepActivity.attributeDisplayName = controlStep.get_controlDisplayName();
                }
                this.currentStepActivity.classId = controlStep.get_classId();
                this.currentStepActivity.controlStep = controlStep;
                this.currentStepActivity.systemStepType = controlStep.get_systemStepType();
            };
            BpfToActivityCollectionVisitor.prototype.visitEntityStep = function (entityStep) {
                _super.prototype.visitEntityStep.call(this, entityStep);
                this.visitSteps(entityStep);
            };
            BpfToActivityCollectionVisitor.prototype.visitConditionBranchStep = function (conditionBranchStep) {
                _super.prototype.visitConditionBranchStep.call(this, conditionBranchStep);
                if (conditionBranchStep.get_conditionBranchDisplayMode() == ConditionBranchDisplayMode.ELSE) {
                    if (this.currentConditionBranchActivity != null) {
                        this.currentConditionBranchActivity.initializeElseBranchStepParameters(conditionBranchStep);
                    }
                    return;
                }
                var parentStep = conditionBranchStep.get_parent().get_parent();
                if (!(parentStep instanceof StageStep)) {
                    return;
                }
                var parentStageStep = parentStep;
                var conditionBranchActivity = this.currentParent;
                this.currentConditionBranchActivity = conditionBranchActivity;
                conditionBranchActivity.parentStageEntityName = this.getEntityNameByStageId(parentStageStep.get_stageId());
                var parentNextStageId = parentStageStep.get_nextStageId();
                if (conditionBranchStep.get_conditionBranchDisplayMode() == ConditionBranchDisplayMode.elseIf || parentNextStageId == null || parentNextStageId === "") {
                    return;
                }
                var workflowStep = parentStageStep.get_parent().get_parent();
                for (var i = 0; i < workflowStep.get_Steps().get_Count(); i++) {
                    if (workflowStep.get_Steps().get_item(i) instanceof EntityStep) {
                        var entityStep = workflowStep.get_Steps().get_item(i);
                        if (!CommonTypes.Types.Object.isNullOrUndefined(entityStep.get_Steps().get_item(0)) && entityStep.get_Steps().get_item(0) instanceof StageStep) {
                            var stageStep = entityStep.get_Steps().get_item(0);
                            if (stageStep.get_nextStageId() == parentNextStageId) {
                                if (stageStep.get_stageId() == parentStageStep.get_stageId()) {
                                    this.mergeParentReverseLookup[parentNextStageId] = conditionBranchActivity.getActivityID();
                                }
                                break;
                            }
                        }
                    }
                }
            };
            BpfToActivityCollectionVisitor.prototype.visitSetNextStageStep = function (setNextStageStep) {
                var nextStageId = setNextStageStep.get_stageId();
                var nextStage = null;
                if (nextStageId != null && nextStageId != "") {
                    nextStage = this.businessProcessFlowVisitor.get_stagesById()[nextStageId];
                }
                if (nextStage != null) {
                    nextStage.apply(this);
                }
            };
            BpfToActivityCollectionVisitor.prototype.getRelationshipData = function (workflowStep, currentStageId) {
                var relation = [];
                if (workflowStep) {
                    var relations = workflowStep.get_Steps().get_item(0).get_Steps();
                    var relCount = workflowStep.get_Steps().get_item(0).get_Steps().get_Count();
                    for (var i = 0; i < relCount; i++) {
                        var relationStep = relations.get_item(i);
                        if (relationStep.get_targetStageId() === currentStageId) {
                            relation.push({ "sourceStageId": relationStep.get_sourceStageId(), "targetStageId": currentStageId, "relationshipName": relationStep.get_relationshipName(), "attributeName": relationStep.get_attributeName() });
                        }
                    }
                }
                return relation;
            };
            BpfToActivityCollectionVisitor.prototype.createStageActivity = function (stageStep, activityType) {
                var activity = this.createActivity(stageStep, activityType);
                var relationshipSteps = this.businessProcessFlowVisitor.getRelationshipStepsByTargetStage(stageStep.get_stageId());
                if (relationshipSteps != null) {
                    var relationships = [];
                    var relationshipName = "";
                    var relationshipStepsArray = Object.keys(relationshipSteps).map(function (key) { return relationshipSteps[key]; });
                    if (relationshipStepsArray && relationshipStepsArray.length > 0) {
                        activity.relationshipData = this.getRelationshipData(relationshipStepsArray[0].get_workflow(), stageStep.get_stageId());
                    }
                    for (var i = 0; i < relationshipStepsArray.length; ++i) {
                        var entry = relationshipStepsArray[i];
                        var source = this.businessProcessFlowVisitor.get_stagesById()[entry.sourceStageId];
                        var stageRelationship = new ProcessDesigner.StageRelationship(entry, source);
                        relationshipName = stageRelationship.step.get_relationshipName();
                        relationships.push(stageRelationship);
                        activity.relationShipAttributeName = stageRelationship.step.get_attributeName();
                        activity.relationshipName = stageRelationship.step.get_relationshipName();
                    }
                }
                activity.entityName = this.getEntityNameByStageId(stageStep.get_stageId());
                var parentActivityId = this.mergeParentReverseLookup[stageStep.get_stageId()];
                if (parentActivityId != null && parentActivityId !== "") {
                    activity.setParentActivityID(parentActivityId);
                    activity.setParentBranchID(ProcessDesigner.DefaultBranchIndices.DefaultBranch);
                }
                else if (this.currentParent instanceof ProcessDesigner.BPFStageActivity && this.currentParent.getActivityID() != null) {
                    if (this.currentParent.nextStageId != stageStep.get_stageId()) {
                        for (var stageId in this.visitedStages) {
                            if (this.visitedStages[stageId].nextStageId == stageStep.get_stageId()) {
                                activity.setParentActivityID(this.visitedStages[stageId].getActivityID());
                            }
                        }
                    }
                }
                activity.stageId = stageStep.get_stageId();
                activity.nextStageId = stageStep.get_nextStageId();
                activity.stageCategory = stageStep.get_stageCategory();
                return activity;
            };
            BpfToActivityCollectionVisitor.prototype.createStepActivity = function (stepStep, activityType) {
                var activity = new ProcessDesigner.BPFStepActivity();
                activity.parentStage = this.currentStageActivity;
                activity.description = stepStep.get_stepLabels().get_item(0).get_description();
                activity.isRequired = stepStep.get_isProcessRequired();
                activity.sequence = this.currentStepIndex;
                activity.processStep = stepStep;
                if (this.currentParent != null) {
                    activity.setParentActivityID(this.currentParent.getActivityID());
                }
                if (this.currentParentBranchId != null) {
                    activity.setParentBranchID(this.currentParentBranchId);
                }
                return activity;
            };
            BpfToActivityCollectionVisitor.prototype.createActionStepActivity = function (actionStep, activityType) {
                var activity = new ProcessDesigner.BPFWorkflowActivity();
                activity.parentStage = this.currentStageActivity;
                activity.description = actionStep.get_uniqueName();
                activity.uniqueName = actionStep.get_uniqueName();
                activity.processId = actionStep.get_processId();
                activity.actionType = actionStep.get_actionType();
                activity.triggerEvents = actionStep.get_triggerEvents();
                activity.attributeDisplayName = actionStep.get_Name();
                activity.actionStepId = actionStep.get_actionId();
                if (this.currentParent != null) {
                    activity.setParentActivityID(this.currentParent.getActivityID());
                }
                if (this.currentParentBranchId != null) {
                    activity.setParentBranchID(this.currentParentBranchId);
                }
                return activity;
            };
            BpfToActivityCollectionVisitor.prototype.createProcessActionStepActivity = function (stepStep, activityType) {
                var actionStep = stepStep.get_Steps().get_item(0);
                var activity = new ProcessDesigner.BPFActionStepActivity();
                activity.parentStage = this.currentStageActivity;
                activity.description = stepStep.get_stepLabels().get_item(0).get_description();
                activity.uniqueName = actionStep.get_uniqueName();
                activity.processId = actionStep.get_processId();
                activity.actionType = actionStep.get_actionType();
                activity.stepId = actionStep.get_actionId();
                activity.workflowName = stepStep.get_Description();
                if (this.currentParent != null) {
                    activity.setParentActivityID(this.currentParent.getActivityID());
                }
                if (this.currentParentBranchId != null) {
                    activity.setParentBranchID(this.currentParentBranchId);
                }
                if (actionStep.get_processId() != null && actionStep.get_actionType() == ProcessDesigner.BPFActionStepActivity.BPFProcessActionType) {
                    var stageEntity = this.currentStageActivity.entityName;
                    ProcessDesigner.BPFActionStepActivity.getProcessArguments(stageEntity, actionStep.get_processId().toString(), function (result) {
                        var steps = actionStep.get_Steps();
                        for (var icnt = 0; icnt < result.length; icnt++) {
                            for (var i = 0; i < steps.get_Count(); i++) {
                                var step = steps.get_item(i);
                                if (step.get_variableName() === result[icnt].ArgumentName && step.get_direction() === result[icnt].ArgumentDirection) {
                                    result[icnt].ArgumentAttributeName = step.get_valueExpression().get_attributeName();
                                    break;
                                }
                            }
                            if (result[icnt].ArgumentDirection == ProcessDesigner.ArgumentDirection.Input) {
                                activity.InputArguments.push(result[icnt]);
                            }
                            else {
                                activity.OutputArguments.push(result[icnt]);
                            }
                        }
                    }, null);
                }
                return activity;
            };
            BpfToActivityCollectionVisitor.prototype.createFlowStepActivity = function (stepStep, activityType) {
                var flowStep = stepStep.get_Steps().get_item(0);
                var activity = new ProcessDesigner.BPFFlowStepActivity();
                activity.parentStage = this.currentStageActivity;
                activity.description = stepStep.get_stepLabels().get_item(0).get_description();
                activity.stepId = flowStep.get_actionId();
                activity.workflowId = flowStep.get_workflowId();
                activity.workflowName = stepStep.get_Description();
                activity.uniqueName = flowStep.get_uniqueName();
                activity.isRequired = stepStep.get_isProcessRequired();
                if (this.currentParent != null) {
                    activity.setParentActivityID(this.currentParent.getActivityID());
                }
                if (this.currentParentBranchId != null) {
                    activity.setParentBranchID(this.currentParentBranchId);
                }
                return activity;
            };
            BpfToActivityCollectionVisitor.prototype.createActionArgument = function (variableStep, stageEntity) {
                var activity = new ProcessDesigner.ActionArgument();
                activity.ArgumentAttributeName = variableStep.get_valueExpression().get_attributeName();
                activity.ArgumentDirection = variableStep.get_direction();
                activity.ArgumentId = variableStep.get_Id();
                activity.ArgumentName = variableStep.get_variableName();
                activity.ArgumentType = variableStep.get_dataType();
                activity.ValueExpression = variableStep.get_valueExpression();
                ProcessDesigner.MetadataProxy.getAttributeListByDataType(stageEntity, activity.ArgumentType).then(function (result) {
                    activity.AttributeList = result;
                });
                return activity;
            };
            BpfToActivityCollectionVisitor.prototype.getEntityNameByStageId = function (stageId) {
                var canonicalId = stageId.toLowerCase();
                var parentStep = this.businessProcessFlowVisitor.get_parentEntityStepByStageId()[canonicalId];
                return parentStep.get_EntityLogicalName();
            };
            return BpfToActivityCollectionVisitor;
        })(ProcessDesigner.ProcessToActivityCollectionVisitor);
        ProcessDesigner.BpfToActivityCollectionVisitor = BpfToActivityCollectionVisitor;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
//<copyright file="BPFCutCommand.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        'use strict';
        var BPFCutCommand = (function (_super) {
            __extends(BPFCutCommand, _super);
            function BPFCutCommand() {
                _super.apply(this, arguments);
            }
            BPFCutCommand.prototype.execute = function () {
                var selectedActivities = GenericWorkflowDesigner.Settings.workflowTree.getSelectedActivities();
                if (CommonTypes.Types.Object.isNullOrUndefined(selectedActivities) || selectedActivities.length <= 0) {
                    return;
                }
                jQuery.each(selectedActivities, function (index, activity) {
                    var activityType = activity.getActivityTypeID();
                    if (activityType == ProcessDesigner.BPFActivityType.step) {
                        $("#" + activity.stepId).addClass("cutTile");
                    }
                    else if (activityType == ProcessDesigner.BPFActivityType.action) {
                        $("#" + activity.stepId).addClass("cutTile");
                    }
                    else if (activityType == ProcessDesigner.BPFActivityType.workflow) {
                        $("#" + activity.actionStepId).addClass("cutTile");
                    }
                    else if (activityType == ProcessDesigner.BPFActivityType.flow) {
                        $("#" + activity.stepId).addClass("cutTile");
                    }
                    else {
                        $('#' + activity.getActivityID()).addClass("cutTile");
                    }
                });
                GenericWorkflowDesigner.Settings.workflowTree.setCopiedActivities(selectedActivities);
                GenericWorkflowDesigner.CutCommand.cutInProgress = true;
                GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.refreshToolbarItems);
            };
            return BPFCutCommand;
        })(GenericWorkflowDesigner.CutCommand);
        ProcessDesigner.BPFCutCommand = BPFCutCommand;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// ---------------------------------------------------------------------------------------------
//  <copyright file="CommandHandlerFactory.ts" company="Microsoft">
//         Copyright (c) Microsoft Corporation.  All rights reserved.
//  </copyright>
// ---------------------------------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        var CommandHandlerFactory = (function () {
            function CommandHandlerFactory() {
            }
            CommandHandlerFactory.prototype.GetCommandHandler = function (commandType) {
                switch (commandType.toLowerCase()) {
                    case "add":
                        return new ProcessDesigner.AddCommand();
                    case "cut":
                        return new ProcessDesigner.BPFCutCommand();
                    case "copy":
                        return new ProcessDesigner.BPFCopyCommand();
                    case "paste":
                        return new ProcessDesigner.BPFPasteCommand();
                    case "delete":
                        return new ProcessDesigner.BPFDeleteCommand();
                    case "snapshot":
                        return new ProcessDesigner.SnapshotCommand();
                    case "connector":
                        return new ProcessDesigner.ConnectorCommand();
                    default:
                        return new ProcessDesigner.DefaultCommand();
                }
            };
            return CommandHandlerFactory;
        })();
        ProcessDesigner.CommandHandlerFactory = CommandHandlerFactory;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// <copyright file="ConnectorCommand.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        "use strict";
        var ConnectorCommand = (function () {
            function ConnectorCommand() {
            }
            ConnectorCommand.prototype.execute = function () {
                new MscrmControls.ProcessDesigner.ConnectorActivityListView();
            };
            return ConnectorCommand;
        })();
        ProcessDesigner.ConnectorCommand = ConnectorCommand;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// <copyright file="DefaultCommand.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        "use strict";
        var DefaultCommand = (function () {
            function DefaultCommand() {
            }
            DefaultCommand.prototype.execute = function () {
                throw new Error("Internal : Not implemented exception");
            };
            return DefaultCommand;
        })();
        ProcessDesigner.DefaultCommand = DefaultCommand;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// <copyright file="AddCommand.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        "use strict";
        var AddCommand = (function () {
            function AddCommand() {
            }
            AddCommand.prototype.execute = function () {
                new MscrmControls.ProcessDesigner.AddActivityListView();
            };
            return AddCommand;
        })();
        ProcessDesigner.AddCommand = AddCommand;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// <copyright file="BPFPasteCommand.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        'use strict';
        var BPFPasteCommand = (function (_super) {
            __extends(BPFPasteCommand, _super);
            function BPFPasteCommand() {
                _super.apply(this, arguments);
            }
            BPFPasteCommand.prototype.execute = function () {
                var copiedActivities = GenericWorkflowDesigner.Settings.workflowTree.getCopiedActivities();
                if (copiedActivities.length <= 0) {
                    return;
                }
                var activityType = copiedActivities[0].getActivityTypeID();
                var targetDiv = document.createElement("div");
                switch (activityType) {
                    case ProcessDesigner.BPFActivityType.step:
                        targetDiv.setAttribute("id", ProcessDesigner.BPFAddActivityTypeCommandID.PasteStep);
                        break;
                    case ProcessDesigner.BPFActivityType.action:
                        targetDiv.setAttribute("id", ProcessDesigner.BPFAddActivityTypeCommandID.PasteActionStep);
                        break;
                    case ProcessDesigner.BPFActivityType.flow:
                        targetDiv.setAttribute("id", ProcessDesigner.BPFAddActivityTypeCommandID.PasteFlowStep);
                        break;
                    case ProcessDesigner.BPFActivityType.stage:
                        if (window["_Process_IsSMBSalesApp"] == true) {
                            var isValidSupportedEntity = false;
                            MscrmControls.ProcessDesigner.MetadataProvider.getEntityMetadata(function (list) {
                                jQuery.each(list, function (index, entityData) {
                                    if (entityData.logicalName == copiedActivities[0]['entityName']) {
                                        isValidSupportedEntity = true;
                                        return false;
                                    }
                                });
                            }, null);
                            if (!isValidSupportedEntity) {
                                return;
                            }
                        }
                        targetDiv.setAttribute("id", ProcessDesigner.BPFAddActivityTypeCommandID.PasteStage);
                        break;
                    case ProcessDesigner.BPFActivityType.condition:
                        targetDiv.setAttribute("id", ProcessDesigner.BPFAddActivityTypeCommandID.PasteBranch);
                        break;
                    case ProcessDesigner.BPFActivityType.workflow:
                        targetDiv.setAttribute("id", ProcessDesigner.BPFAddActivityTypeCommandID.PasteWorkflow);
                        break;
                    default:
                        throw new Error("Internal : Activity type not supported for Paste");
                }
                var event = {};
                if (GenericWorkflowDesigner.CutCommand.cutInProgress) {
                    targetDiv.setAttribute('data-activityID', copiedActivities[0].getActivityID());
                }
                event["currentTarget"] = targetDiv;
                MscrmControls.ProcessDesigner.AddActivityListSubView.ClickHandler(event);
            };
            BPFPasteCommand.prototype.pasteComponentAtSlot = function (slot, copiedActivities) {
                if (CommonTypes.Types.Object.isNullOrUndefined(copiedActivities)) {
                    copiedActivities = GenericWorkflowDesigner.Settings.workflowTree.getCopiedActivities();
                    if (copiedActivities.length <= 0) {
                        return;
                    }
                }
                var activity = copiedActivities[0].getCloneOfActivity();
                var activityType = activity.getActivityTypeID();
                if (activityType === ProcessDesigner.BPFActivityType.workflow) {
                    var newStageID = slot.model.attributes.activity.stageId;
                    var newWorkflowActivity = activity;
                    newWorkflowActivity.updateStageId(newStageID);
                }
                if (GenericWorkflowDesigner.CutCommand.cutInProgress) {
                    switch (activityType) {
                        case ProcessDesigner.BPFActivityType.stage:
                            ProcessDesigner.BPFStageActivityDeleteHandler.prototype.deleteActivities(copiedActivities);
                            break;
                        case ProcessDesigner.BPFActivityType.step:
                        case ProcessDesigner.BPFActivityType.action:
                        case ProcessDesigner.BPFActivityType.flow:
                            ProcessDesigner.BPFStepActivityDeleteHandler.prototype.deleteActivities(copiedActivities);
                            break;
                        case ProcessDesigner.BPFActivityType.workflow:
                            ProcessDesigner.BPFWorkflowActivityDeleteHandler.prototype.deleteActivities(copiedActivities);
                            break;
                        default:
                            throw new Error("Internal : Activity type not supported for paste");
                    }
                }
                var component = new GenericWorkflowDesigner.ConnectedComponent(activity);
                var dropHandler = GenericWorkflowDesigner.Settings.slotHandlerProvider.createDropHandler(slot.model);
                dropHandler.drop(component).done(function (activity) {
                    if (activity != undefined) {
                        GenericWorkflowDesigner.updateCurrentModel(activity);
                        GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.editDone);
                        GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.canvasRefresh);
                        if (GenericWorkflowDesigner.CutCommand.cutInProgress) {
                            GenericWorkflowDesigner.CutCommand.cutInProgress = false;
                            GenericWorkflowDesigner.Settings.workflowTree.setCopiedActivities([]);
                        }
                        GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.activatePropertyTab);
                        GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.refreshToolbarItems);
                        GenericWorkflowDesigner.Settings.workflowTree.setSelectedActivities([activity]);
                        activity.highLight();
                    }
                });
            };
            return BPFPasteCommand;
        })(GenericWorkflowDesigner.PasteCommand);
        ProcessDesigner.BPFPasteCommand = BPFPasteCommand;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
//<copyright file="BPFCopyCommand.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        'use strict';
        var BPFCopyCommand = (function (_super) {
            __extends(BPFCopyCommand, _super);
            function BPFCopyCommand() {
                _super.apply(this, arguments);
            }
            BPFCopyCommand.prototype.execute = function () {
                if (GenericWorkflowDesigner.CutCommand.cutInProgress) {
                    $(".cutTile").removeClass("cutTile");
                    GenericWorkflowDesigner.CutCommand.cutInProgress = false;
                }
                _super.prototype.execute.call(this);
                GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.refreshToolbarItems);
            };
            return BPFCopyCommand;
        })(GenericWorkflowDesigner.CopyCommand);
        ProcessDesigner.BPFCopyCommand = BPFCopyCommand;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// <copyright file="SnapshotCommand.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        "use strict";
        var SnapshotCommand = (function () {
            function SnapshotCommand() {
            }
            SnapshotCommand.prototype.execute = function () {
                var stopwatch = new GenericWorkflowDesigner.Stopwatch();
                stopwatch.start();
                var canvasDiv = document.getElementById('zoomCanvasWrapper');
                var parentDiv = document.getElementById('workspaceWrapperID');
                var miniMapWrapperVisibility = $("#mini-map-wrapper").css("visibility");
                var showMiniMapDivVisibility = $("#show-mini-map-div").css("visibility");
                var detailsOverflowStyle = $('.stage-detail-container').css('overflow-y');
                var parentDivStyle = parentDiv.style.cssText;
                $("#mini-map-wrapper").css("visibility", "hidden");
                $("#show-mini-map-div").css("visibility", "hidden");
                $('.stage-detail-container').css('overflow-y', 'hidden');
                $("#workspaceWrapperID").attr('style', 'position: fixed !important');
                $("#workspaceWrapperID").css('top', 0);
                $("#workspaceWrapperID").css('left', 0);
                $("#workspaceWrapperID").css('z-index', 1);
                GenericWorkflowDesigner.Utilities.saveSnapshot(canvasDiv, ProcessDesigner.ControlManager.processTitle);
                parentDiv.style.cssText = parentDivStyle;
                $("#mini-map-wrapper").css("visibility", miniMapWrapperVisibility);
                $('.stage-detail-container').css('overflow-y', detailsOverflowStyle);
                $("#show-mini-map-div").css("visibility", showMiniMapDivVisibility);
                stopwatch.stop();
                localStorage.setItem("ProcessDesignerControl_BPF_SnapshotTime", stopwatch.elapsedMilliseconds.toString());
            };
            return SnapshotCommand;
        })();
        ProcessDesigner.SnapshotCommand = SnapshotCommand;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// -----------------------------------------------------------------------
// <copyright file="BPFDeleteCommand.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        'use strict';
        var BPFDeleteCommand = (function () {
            function BPFDeleteCommand() {
            }
            BPFDeleteCommand.prototype.execute = function () {
                var toBeDeleted = GenericWorkflowDesigner.Settings.workflowTree.getSelectedActivities();
                if (!toBeDeleted) {
                    return;
                }
                for (var i = 0; i < toBeDeleted.length && toBeDeleted[i]; i++) {
                    switch (toBeDeleted[i].getActivityTypeID()) {
                        case ProcessDesigner.BPFActivityType.stage:
                            ProcessDesigner.BPFStageActivityDeleteHandler.prototype.deleteSelectedActivities();
                            break;
                        case ProcessDesigner.BPFActivityType.condition:
                            ProcessDesigner.BPFConditionActivityDeleteHandler.prototype.deleteSelectedActivities();
                            break;
                        case ProcessDesigner.BPFActivityType.step:
                        case ProcessDesigner.BPFActivityType.action:
                        case ProcessDesigner.BPFActivityType.flow:
                            ProcessDesigner.BPFStepActivityDeleteHandler.prototype.deleteSelectedActivities();
                            break;
                        case ProcessDesigner.BPFActivityType.workflow:
                            ProcessDesigner.BPFWorkflowActivityDeleteHandler.prototype.deleteSelectedActivities();
                            break;
                    }
                    ;
                }
            };
            return BPFDeleteCommand;
        })();
        ProcessDesigner.BPFDeleteCommand = BPFDeleteCommand;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// -----------------------------------------------------------------------
// <copyright file="BPFStageActivityDeleteHandler.ts" company="Microsoft">
// Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        'use strict';
        var BPFStageActivityDeleteHandler = (function (_super) {
            __extends(BPFStageActivityDeleteHandler, _super);
            function BPFStageActivityDeleteHandler() {
                _super.apply(this, arguments);
            }
            BPFStageActivityDeleteHandler.prototype.canvasRefreshUtil = function () {
                GenericWorkflowDesigner.updateCurrentModel(null);
                GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.canvasRefresh);
                GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.clearPanel);
            };
            BPFStageActivityDeleteHandler.prototype.alertDialog = function (title, message) {
                var dialogDetails = {
                    dialogTitle: title,
                    dialogMessage: message,
                    messageType: ProcessDesigner.BPFDialogMessageTypes.Warning
                };
                GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.showDialog, dialogDetails);
            };
            BPFStageActivityDeleteHandler.prototype.deleteActivityConfirmationDialog = function (activity) {
                var message = ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_Delete_Message");
                message = window['String'].format(message, ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_Stage_Activity_Name"));
                var dialogDetails = {
                    dialogTitle: ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_DeleteStage_Title"),
                    dialogMessage: message,
                    messageType: ProcessDesigner.BPFDialogMessageTypes.Warning,
                    yesCallbackAction: this.deleteConfirmedCallback,
                    noCallbackAction: this.deleteCanceledCallback
                };
                GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.showDialog, dialogDetails);
            };
            BPFStageActivityDeleteHandler.prototype.deleteConfirmedCallback = function () {
                BPFStageActivityDeleteHandler.prototype.deleteActivities();
            };
            BPFStageActivityDeleteHandler.prototype.deleteCanceledCallback = function () {
                return;
            };
            BPFStageActivityDeleteHandler.prototype.getAllSubsequentActivities = function (activity) {
                var selectedActivities = new Array();
                var stack = new Array();
                stack.push(activity);
                while (stack.length != 0) {
                    var currentActivity = stack.pop();
                    selectedActivities.push(currentActivity);
                    var childActivities = GenericWorkflowDesigner.Settings.workflowTree.getChildActivities(currentActivity);
                    for (var i = 0; i < childActivities.length; i++) {
                        stack.push(childActivities[i]);
                    }
                }
                return selectedActivities;
            };
            BPFStageActivityDeleteHandler.prototype.getDefaultChild = function (activity) {
                var childsOfChildren = activity.getChildActivitiesSorted();
                for (var i = 0; i < childsOfChildren.length; ++i) {
                    if (childsOfChildren[i].getParentBranchID() == ProcessDesigner.branchType.Default) {
                        return childsOfChildren[i];
                    }
                }
                return null;
            };
            BPFStageActivityDeleteHandler.prototype.deleteActivities = function (toBeDeleted) {
                if (CommonTypes.Types.Object.isNullOrUndefined(toBeDeleted)) {
                    toBeDeleted = GenericWorkflowDesigner.Settings.workflowTree.getSelectedActivities();
                    if (toBeDeleted.length <= 0) {
                        return;
                    }
                }
                var _this = BPFStageActivityDeleteHandler.prototype;
                var allActivities = GenericWorkflowDesigner.Settings.workflowTree.getWorkflowDefinition();
                var deletedActivities = [];
                var stageActivities = [];
                var moreToBeDeletedActivities = [];
                var defaultChild = null;
                var parentStage = null;
                for (var i = 0; i < toBeDeleted.length; i++) {
                    var currentActivity = toBeDeleted[i];
                    stageActivities.push(currentActivity);
                }
                if (stageActivities.length > 0) {
                    deletedActivities.push(currentActivity);
                    var parentActivity = currentActivity.getParent();
                    if (parentActivity.getActivityTypeID() == ProcessDesigner.BPFActivityType.stage) {
                        var children = currentActivity.getChildActivitiesSorted()[0];
                        if (children) {
                            if (currentActivity.getNextActivityID() == GenericWorkflowDesigner.ActivityType.Empty || CommonTypes.Types.Object.isNullOrUndefined(currentActivity.getNextActivityID())) {
                                children.setParentActivityID(parentActivity.getActivityID());
                            }
                            else {
                                children.setParentActivityID(parentActivity.getActivityID());
                                parentActivity.setNextActivityID(children.getActivityID());
                            }
                        }
                    }
                    else {
                        if (parentActivity.getActivityTypeID() == ProcessDesigner.BPFActivityType.condition) {
                            var children = currentActivity.getChildActivitiesSorted()[0];
                            if (children) {
                                if (children.getActivityTypeID() == ProcessDesigner.BPFActivityType.condition) {
                                    switch (currentActivity.getParentBranchID()) {
                                        case ProcessDesigner.branchType.Default:
                                        case ProcessDesigner.branchType.If:
                                            var dialogTitle = ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_DeleteStage_InProcess_Title");
                                            ;
                                            var dialogMessage = ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_DeleteStage_InProcess_Message");
                                            this.alertDialog(dialogTitle, dialogMessage);
                                            return;
                                        case ProcessDesigner.branchType.Else:
                                            children.setParentActivityID(parentActivity.getActivityID());
                                            children.setParentBranchID(ProcessDesigner.branchType.Else);
                                            break;
                                    }
                                    ;
                                }
                                else {
                                    switch (currentActivity.getParentBranchID()) {
                                        case ProcessDesigner.branchType.Default:
                                            children.setParentActivityID(parentActivity.getActivityID());
                                            children.setParentBranchID(ProcessDesigner.branchType.Default);
                                            jQuery.each(allActivities, function (index, currentChild) {
                                                if (currentChild.getNextActivityID() == currentActivity.getActivityID()) {
                                                    currentChild.setNextActivityID(children.getActivityID());
                                                }
                                            });
                                            break;
                                        case ProcessDesigner.branchType.If:
                                            children.setParentActivityID(parentActivity.getActivityID());
                                            children.setParentBranchID(ProcessDesigner.branchType.If);
                                            break;
                                        case ProcessDesigner.branchType.Else:
                                            children.setParentActivityID(parentActivity.getActivityID());
                                            children.setParentBranchID(ProcessDesigner.branchType.Else);
                                            break;
                                    }
                                    ;
                                }
                            }
                            else {
                                switch (currentActivity.getParentBranchID()) {
                                    case ProcessDesigner.branchType.Default:
                                        jQuery.each(allActivities, function (index, currentChild) {
                                            if (currentChild.getNextActivityID() == currentActivity.getActivityID()) {
                                                currentChild.setNextActivityID(GenericWorkflowDesigner.ActivityType.Empty);
                                            }
                                        });
                                        break;
                                    case ProcessDesigner.branchType.If:
                                        if (currentActivity.getNextActivityID()) {
                                            parentActivity.setNextActivityID(currentActivity.getNextActivityID());
                                        }
                                        break;
                                    case ProcessDesigner.branchType.Else:
                                        if (currentActivity.getNextActivityID() && currentActivity.getParent()) {
                                            var childrenOfParent = currentActivity.getParent().getChildActivitiesSorted();
                                            for (var i = 0; i < childrenOfParent.length; i++) {
                                                if (childrenOfParent[i].getParentBranchID() == ProcessDesigner.branchType.Default) {
                                                    parentActivity.setNextActivityID(currentActivity.getNextActivityID());
                                                    break;
                                                }
                                            }
                                        }
                                        break;
                                }
                                ;
                            }
                        }
                    }
                }
                jQuery.each(deletedActivities, function (indexNode, node) {
                    GenericWorkflowDesigner.Settings.workflowTree.remove(node);
                });
                $("#canvas").width("auto");
                $("#canvas").height("auto");
                GenericWorkflowDesigner.Settings.isStageDeleted = true;
                var currentRow = currentActivity.getRow();
                var currentColumn = currentActivity.getCol();
                var allActivities = GenericWorkflowDesigner.Settings.workflowTree.getActivities();
                for (var i = 0; i < allActivities.length; i++) {
                    if (allActivities[i].getRow() == currentRow) {
                        GenericWorkflowDesigner.Settings.tileCountInRow = 1;
                    }
                    if (allActivities[i].getCol() == currentColumn) {
                        GenericWorkflowDesigner.Settings.tileCountInColumn = 1;
                    }
                }
                _this.canvasRefreshUtil();
                var activityIdToSelect = null;
                var activityTypeToSelect = null;
                if (parentActivity) {
                    activityIdToSelect = parentActivity.getActivityID();
                    activityTypeToSelect = parentActivity.getActivityTypeID();
                    GenericWorkflowDesigner.Settings.workflowTree.setSelectedActivities([parentActivity]);
                }
                if (activityTypeToSelect == ProcessDesigner.BPFActivityType.stage && activityIdToSelect) {
                    $('#' + activityIdToSelect).find(".stageTile").addClass("selected");
                    ProcessDesigner.ControlManager.canvasScrollIntoView($(".selected.stageTile").get(0));
                }
                else {
                    $('#' + activityIdToSelect).find(".conditionTile").addClass("selected");
                    ProcessDesigner.ControlManager.canvasScrollIntoView($(".selected.conditionTile").get(0));
                }
                GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.refreshToolbarItems);
                GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.editDone);
                GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.activityDeleted, deletedActivities);
                return deletedActivities;
            };
            BPFStageActivityDeleteHandler.prototype.deleteSelectedActivities = function () {
                var _this = BPFStageActivityDeleteHandler.prototype;
                var toBeDeleted = GenericWorkflowDesigner.Settings.workflowTree.getSelectedActivities();
                for (var i = 0; i < toBeDeleted.length; i++) {
                    var currentActivity = toBeDeleted[i];
                    if (currentActivity.getActivityTypeID() == ProcessDesigner.BPFActivityType.stage && CommonTypes.Types.Object.isNullOrUndefined(currentActivity.getParent())) {
                        var dialogTitle = ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_DeleteRootNode_Title");
                        var dialogMessage = ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_DeleteRootNode_Message");
                        this.alertDialog(dialogTitle, dialogMessage);
                        GenericWorkflowDesigner.Settings.workflowTree.setSelectedActivities(null);
                        return [];
                    }
                    _this.deleteActivityConfirmationDialog(currentActivity.getActivityTypeID());
                }
            };
            return BPFStageActivityDeleteHandler;
        })(GenericWorkflowDesigner.ActivityDeleteHandler);
        ProcessDesigner.BPFStageActivityDeleteHandler = BPFStageActivityDeleteHandler;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// -----------------------------------------------------------------------
// <copyright file="BPFConditionActivityDeleteHandler.ts" company="Microsoft">
// Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        'use strict';
        var BPFConditionActivityDeleteHandler = (function (_super) {
            __extends(BPFConditionActivityDeleteHandler, _super);
            function BPFConditionActivityDeleteHandler() {
                _super.apply(this, arguments);
            }
            BPFConditionActivityDeleteHandler.prototype.canvasRefreshUtil = function () {
                GenericWorkflowDesigner.updateCurrentModel(null);
                GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.canvasRefresh);
                GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.clearPanel);
            };
            BPFConditionActivityDeleteHandler.prototype.alertDialog = function (title, message) {
                var dialogDetails = {
                    dialogTitle: title,
                    dialogMessage: message,
                    messagetType: ProcessDesigner.BPFDialogMessageTypes.Warning
                };
                GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.showDialog, dialogDetails);
            };
            BPFConditionActivityDeleteHandler.prototype.deleteActivityConfirmationDialog = function (activity) {
                var message = ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_Delete_Message");
                message = window['String'].format(message, ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_Condition_Activity_Name"));
                var dialogDetails = {
                    dialogTitle: ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_DeleteCondition_Title"),
                    dialogMessage: message,
                    messageType: ProcessDesigner.BPFDialogMessageTypes.Warning,
                    yesCallbackAction: this.deleteConfirmedCallback,
                    noCallbackAction: this.deleteCanceledCallback
                };
                GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.showDialog, dialogDetails);
            };
            BPFConditionActivityDeleteHandler.prototype.deleteConfirmedCallback = function () {
                BPFConditionActivityDeleteHandler.prototype.deleteActivities();
            };
            BPFConditionActivityDeleteHandler.prototype.deleteCanceledCallback = function () {
                GenericWorkflowDesigner.Settings.workflowTree.setSelectedActivities(null);
                return;
            };
            BPFConditionActivityDeleteHandler.prototype.getAllSubsequentActivities = function (activity) {
                var selectedActivities = new Array();
                var stack = new Array();
                stack.push(activity);
                while (stack.length != 0) {
                    var currentActivity = stack.pop();
                    selectedActivities.push(currentActivity);
                    var childActivities = GenericWorkflowDesigner.Settings.workflowTree.getChildActivities(currentActivity);
                    for (var i = 0; i < childActivities.length; i++) {
                        stack.push(childActivities[i]);
                    }
                }
                return selectedActivities;
            };
            BPFConditionActivityDeleteHandler.prototype.findLastChild = function (ifChild) {
                if (ifChild) {
                    var found = false, branchID;
                    var lastNodeIfChild = ifChild;
                    while (ifChild && !found) {
                        lastNodeIfChild = ifChild;
                        if (ifChild.getActivityTypeID() == ProcessDesigner.BPFActivityType.condition) {
                            var tempChilds = ifChild.getChildActivitiesSorted();
                            var tempLength = tempChilds.length;
                            switch (tempLength) {
                                case 1:
                                    branchID = tempChilds[0].getParentBranchID();
                                    switch (branchID) {
                                        case ProcessDesigner.branchType.Default:
                                            ifChild = ifChild.getChildActivitiesSorted()[0];
                                            break;
                                        case ProcessDesigner.branchType.If:
                                            found = true;
                                            lastNodeIfChild = ifChild;
                                            break;
                                        case ProcessDesigner.branchType.Else:
                                            break;
                                    }
                                    ;
                                    break;
                                case 2:
                                    branchID = tempChilds[0].getParentBranchID();
                                    switch (branchID) {
                                        case ProcessDesigner.branchType.Default:
                                            ifChild = ifChild.getChildActivitiesSorted()[0];
                                            break;
                                        case ProcessDesigner.branchType.If:
                                            found = true;
                                            lastNodeIfChild = ifChild;
                                            break;
                                        case ProcessDesigner.branchType.Else:
                                            break;
                                    }
                                    ;
                                    break;
                                case 3:
                                    ifChild = ifChild.getChildActivitiesSorted()[0];
                                    break;
                            }
                        }
                        else {
                            ifChild = ifChild.getChildActivitiesSorted()[0];
                        }
                    }
                    return lastNodeIfChild;
                }
                else
                    return null;
            };
            BPFConditionActivityDeleteHandler.prototype.deleteActivities = function (toBeDeleted) {
                if (CommonTypes.Types.Object.isNullOrUndefined(toBeDeleted)) {
                    toBeDeleted = GenericWorkflowDesigner.Settings.workflowTree.getSelectedActivities();
                    if (toBeDeleted.length <= 0) {
                        return;
                    }
                }
                var _this = BPFConditionActivityDeleteHandler.prototype;
                var deletedActivities = [];
                var stageActivities = [], lastChild = null;
                var branchID = 0, parentActivity, moreToBeDeletedActivities;
                var allActivities = GenericWorkflowDesigner.Settings.workflowTree.getWorkflowDefinition();
                var parentStage = null;
                for (var i = 0; i < toBeDeleted.length; i++) {
                    var currentActivity = toBeDeleted[i];
                    deletedActivities.push(currentActivity);
                    var children = currentActivity.getChildActivitiesSorted();
                    var length = children.length;
                    parentActivity = currentActivity.getParent();
                    switch (length) {
                        case 0:
                            break;
                        case 1:
                            branchID = children[length - 1].getParentBranchID();
                            switch (branchID) {
                                case ProcessDesigner.branchType.Default:
                                case ProcessDesigner.branchType.If:
                                case ProcessDesigner.branchType.Else:
                                    children[length - 1].setParentActivityID(parentActivity.getActivityID());
                                    if (parentActivity.getActivityTypeID() == ProcessDesigner.BPFActivityType.stage) {
                                        children[length - 1].setParentBranchID(ProcessDesigner.branchType.Default);
                                    }
                                    else {
                                        if (parentActivity.getActivityTypeID() == ProcessDesigner.BPFActivityType.condition) {
                                            children[length - 1].setParentBranchID(ProcessDesigner.branchType.Else);
                                        }
                                    }
                                    break;
                            }
                            ;
                            break;
                        case 2:
                            branchID = children[0].getParentBranchID();
                            switch (branchID) {
                                case ProcessDesigner.branchType.Default:
                                    if (parentActivity.getActivityTypeID() == ProcessDesigner.BPFActivityType.stage) {
                                        lastChild = _this.findLastChild(children[1]);
                                        children[1].setParentActivityID(parentActivity.getActivityID());
                                        children[1].setParentBranchID(ProcessDesigner.branchType.Default);
                                        children[0].setParentActivityID(lastChild.getActivityID());
                                        children[0].setParentBranchID(ProcessDesigner.branchType.Default);
                                        if (lastChild.getNextActivityID())
                                            lastChild.setNextActivityID(GenericWorkflowDesigner.ActivityType.Empty);
                                    }
                                    else if (parentActivity.getActivityTypeID() == ProcessDesigner.BPFActivityType.condition) {
                                        var lastChild = _this.findLastChild(children[1]);
                                        children[1].setParentActivityID(parentActivity.getActivityID());
                                        children[1].setParentBranchID(ProcessDesigner.branchType.Else);
                                        children[0].setParentActivityID(lastChild.getActivityID());
                                        children[0].setParentBranchID(ProcessDesigner.branchType.Default);
                                        if (lastChild.getNextActivityID())
                                            lastChild.setNextActivityID(GenericWorkflowDesigner.ActivityType.Empty);
                                    }
                                    break;
                                case ProcessDesigner.branchType.If:
                                    if (parentActivity.getActivityTypeID() == ProcessDesigner.BPFActivityType.stage) {
                                        moreToBeDeletedActivities = _this.getAllSubsequentActivities(children[0]);
                                        for (var j = 0; j < moreToBeDeletedActivities.length; ++j) {
                                            deletedActivities.push(moreToBeDeletedActivities[j]);
                                        }
                                        children[1].setParentActivityID(parentActivity.getActivityID());
                                        children[1].setParentBranchID(ProcessDesigner.branchType.Default);
                                    }
                                    else if (parentActivity.getActivityTypeID() == ProcessDesigner.BPFActivityType.condition) {
                                        moreToBeDeletedActivities = _this.getAllSubsequentActivities(children[0]);
                                        for (var j = 0; j < moreToBeDeletedActivities.length; ++j) {
                                            deletedActivities.push(moreToBeDeletedActivities[j]);
                                        }
                                        children[1].setParentActivityID(parentActivity.getActivityID());
                                        children[1].setParentBranchID(ProcessDesigner.branchType.Else);
                                    }
                                    break;
                            }
                            ;
                            break;
                        case 3:
                            if (parentActivity.getActivityTypeID() == ProcessDesigner.BPFActivityType.stage) {
                                lastChild = _this.findLastChild(children[2]);
                                moreToBeDeletedActivities = _this.getAllSubsequentActivities(children[1]);
                                for (var j = 0; j < moreToBeDeletedActivities.length; ++j) {
                                    deletedActivities.push(moreToBeDeletedActivities[j]);
                                }
                                children[2].setParentActivityID(parentActivity.getActivityID());
                                children[2].setParentBranchID(ProcessDesigner.branchType.Default);
                                children[0].setParentActivityID(lastChild.getActivityID());
                                children[0].setParentBranchID(ProcessDesigner.branchType.Default);
                                jQuery.each(allActivities, function (index, currentChild) {
                                    if (currentChild.getNextActivityID() == children[0].getActivityID()) {
                                        currentChild.setNextActivityID(GenericWorkflowDesigner.ActivityType.Empty);
                                    }
                                });
                            }
                            else if (parentActivity.getActivityTypeID() == ProcessDesigner.BPFActivityType.condition) {
                                lastChild = _this.findLastChild(children[2]);
                                moreToBeDeletedActivities = _this.getAllSubsequentActivities(children[1]);
                                for (var j = 0; j < moreToBeDeletedActivities.length; ++j) {
                                    deletedActivities.push(moreToBeDeletedActivities[j]);
                                }
                                children[2].setParentActivityID(parentActivity.getActivityID());
                                children[2].setParentBranchID(ProcessDesigner.branchType.Else);
                                children[0].setParentActivityID(lastChild.getActivityID());
                                children[0].setParentBranchID(ProcessDesigner.branchType.Default);
                                jQuery.each(allActivities, function (index, currentChild) {
                                    if (currentChild.getNextActivityID() == children[0].getActivityID()) {
                                        currentChild.setNextActivityID(GenericWorkflowDesigner.ActivityType.Empty);
                                    }
                                });
                            }
                            break;
                    }
                    ;
                }
                var currentRow = currentActivity.getRow();
                var currentColumn = currentActivity.getCol();
                var columnHasMoreTiles = false;
                jQuery.each(deletedActivities, function (indexNode, node) {
                    if (node.id != currentActivity.id) {
                        if (node.getRow() == currentRow && node.getCol() != currentColumn) {
                            var allActivities = GenericWorkflowDesigner.Settings.workflowTree.getActivities();
                            for (var i = 0; i < allActivities.length; i++) {
                                if (allActivities[i].id != node.id && allActivities[i].getCol() == node.getCol()) {
                                    columnHasMoreTiles = true;
                                }
                            }
                            if (columnHasMoreTiles == false)
                                GenericWorkflowDesigner.Settings.childCount++;
                            else
                                columnHasMoreTiles = false;
                        }
                    }
                    GenericWorkflowDesigner.Settings.workflowTree.remove(node);
                });
                $("#canvas").width("auto");
                $("#canvas").height("auto");
                GenericWorkflowDesigner.Settings.isStageDeleted = true;
                var allActivities = GenericWorkflowDesigner.Settings.workflowTree.getActivities();
                for (var i = 0; i < allActivities.length; i++) {
                    if (allActivities[i].getRow() == currentRow) {
                        GenericWorkflowDesigner.Settings.tileCountInRow = 1;
                    }
                    if (allActivities[i].getCol() == currentColumn) {
                        GenericWorkflowDesigner.Settings.tileCountInColumn = 1;
                    }
                }
                _this.canvasRefreshUtil();
                var activityIdToSelect = null;
                var activityTypeToSelect = null;
                if (parentActivity) {
                    activityIdToSelect = parentActivity.getActivityID();
                    activityTypeToSelect = parentActivity.getActivityTypeID();
                    GenericWorkflowDesigner.Settings.workflowTree.setSelectedActivities([parentActivity]);
                }
                if (activityTypeToSelect == ProcessDesigner.BPFActivityType.stage && activityIdToSelect) {
                    $('#' + activityIdToSelect).find(".stageTile").addClass("selected");
                    ProcessDesigner.ControlManager.canvasScrollIntoView($(".selected.stageTile").get(0));
                }
                else {
                    $('#' + activityIdToSelect).find(".conditionTile").addClass("selected");
                    ProcessDesigner.ControlManager.canvasScrollIntoView($(".selected.conditionTile").get(0));
                }
                GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.refreshToolbarItems);
                GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.editDone);
                GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.activityDeleted, deletedActivities);
                return deletedActivities;
            };
            BPFConditionActivityDeleteHandler.prototype.deleteSelectedActivities = function () {
                var _this = BPFConditionActivityDeleteHandler.prototype;
                var toBeDeleted = GenericWorkflowDesigner.Settings.workflowTree.getSelectedActivities();
                for (var i = 0; i < toBeDeleted.length; i++) {
                    var currentActivity = toBeDeleted[i];
                    _this.deleteActivityConfirmationDialog(currentActivity.getActivityTypeID());
                }
            };
            return BPFConditionActivityDeleteHandler;
        })(GenericWorkflowDesigner.ActivityDeleteHandler);
        ProcessDesigner.BPFConditionActivityDeleteHandler = BPFConditionActivityDeleteHandler;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// -----------------------------------------------------------------------
// <copyright file="BPFStepActivityDeleteHandler.ts" company="Microsoft">
// Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        'use strict';
        var BPFStepActivityDeleteHandler = (function (_super) {
            __extends(BPFStepActivityDeleteHandler, _super);
            function BPFStepActivityDeleteHandler() {
                _super.apply(this, arguments);
            }
            BPFStepActivityDeleteHandler.prototype.canvasRefreshUtil = function () {
                GenericWorkflowDesigner.updateCurrentModel(null);
                GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.canvasRefresh);
                GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.clearPanel);
            };
            BPFStepActivityDeleteHandler.prototype.alertDialog = function (title, message) {
                var dialogDetails = {
                    dialogTitle: title,
                    dialogMessage: message,
                    messageType: ProcessDesigner.BPFDialogMessageTypes.Warning
                };
                GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.showDialog, dialogDetails);
            };
            BPFStepActivityDeleteHandler.prototype.deleteActivityConfirmationDialog = function (activity) {
                var message = ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_Delete_Message");
                var activityDisplayName = activity;
                if (activity == ProcessDesigner.BPFActivityType.action) {
                    activityDisplayName = ProcessDesigner.MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_ActionStepPropertyDetails_Header");
                }
                else if (activity == ProcessDesigner.BPFActivityType.flow) {
                    activityDisplayName = ProcessDesigner.MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_FlowStepPropertyDetails_Header");
                }
                else {
                    activityDisplayName = ProcessDesigner.MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_Step_Activity_Name");
                }
                message = window['String'].format(message, activityDisplayName);
                var dialogDetails = {
                    dialogTitle: ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_DeleteStep_Title"),
                    dialogMessage: message,
                    messageType: ProcessDesigner.BPFDialogMessageTypes.Warning,
                    yesCallbackAction: this.DeleteConfirmedCallback,
                    noCallbackAction: this.DeleteCanceledCallback
                };
                GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.showDialog, dialogDetails);
            };
            BPFStepActivityDeleteHandler.prototype.DeleteConfirmedCallback = function () {
                return BPFStepActivityDeleteHandler.prototype.deleteActivities();
            };
            BPFStepActivityDeleteHandler.prototype.DeleteCanceledCallback = function () {
                GenericWorkflowDesigner.Settings.workflowTree.setSelectedActivities(null);
                return;
            };
            BPFStepActivityDeleteHandler.prototype.deleteStepFromStageActivity = function (step) {
                var stage = step.getParent();
                var steps = stage.steps;
                var index = jQuery.inArray(step, steps);
                if (index == -1) {
                    return;
                }
                for (var i = index; i < steps.length - 1; i++) {
                    steps[i] = steps[i + 1];
                }
                steps.pop();
                stage.steps = steps;
            };
            BPFStepActivityDeleteHandler.prototype.deleteActivities = function (toBeDeleted) {
                if (CommonTypes.Types.Object.isNullOrUndefined(toBeDeleted)) {
                    toBeDeleted = GenericWorkflowDesigner.Settings.workflowTree.getSelectedActivities();
                    if (toBeDeleted.length <= 0) {
                        return;
                    }
                }
                var allowDelete;
                var _this = BPFStepActivityDeleteHandler.prototype;
                var deletedActivities = [];
                var stageActivities = [];
                for (var i = 0; i < toBeDeleted.length; i++) {
                    var currentActivity = toBeDeleted[i];
                    deletedActivities.push(currentActivity);
                    _this.deleteStepFromStageActivity(currentActivity);
                }
                _this.canvasRefreshUtil();
                ProcessDesigner.CanvasDisplayUtility.HandleStageDetailsOverlap();
                var stage = currentActivity.getParent();
                var activityIdToSelect = null;
                if (stage) {
                    activityIdToSelect = stage.getActivityID();
                    GenericWorkflowDesigner.Settings.workflowTree.setSelectedActivities([stage]);
                }
                if (activityIdToSelect) {
                    $('#' + activityIdToSelect).find(".stageTile").addClass("selected");
                }
                GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.refreshToolbarItems);
                GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.editDone);
                GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.activityDeleted, deletedActivities);
                return deletedActivities;
            };
            BPFStepActivityDeleteHandler.prototype.deleteSelectedActivities = function () {
                var toBeDeleted = GenericWorkflowDesigner.Settings.workflowTree.getSelectedActivities();
                for (var i = 0; i < toBeDeleted.length; i++) {
                    var currentActivity = toBeDeleted[i];
                    var stage = currentActivity.getParent();
                    var steps = stage.steps;
                    if (steps.length == 1) {
                        var alertTitle = ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_DeleteSingleStep_Title");
                        var alertMessage = ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_DeleteSingleStep_Message");
                        this.alertDialog(alertTitle, alertMessage);
                        GenericWorkflowDesigner.Settings.workflowTree.setSelectedActivities(null);
                        return;
                    }
                    this.deleteActivityConfirmationDialog(currentActivity.getActivityTypeID());
                }
            };
            return BPFStepActivityDeleteHandler;
        })(GenericWorkflowDesigner.ActivityDeleteHandler);
        ProcessDesigner.BPFStepActivityDeleteHandler = BPFStepActivityDeleteHandler;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// -----------------------------------------------------------------------
// <copyright file="BPFWorkflowActivityDeleteHandler.ts" company="Microsoft">
// Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        'use strict';
        var BPFWorkflowActivityDeleteHandler = (function (_super) {
            __extends(BPFWorkflowActivityDeleteHandler, _super);
            function BPFWorkflowActivityDeleteHandler() {
                _super.apply(this, arguments);
            }
            BPFWorkflowActivityDeleteHandler.prototype.canvasRefreshUtil = function () {
                GenericWorkflowDesigner.updateCurrentModel(null);
                GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.canvasRefresh);
                GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.clearPanel);
            };
            BPFWorkflowActivityDeleteHandler.prototype.deleteActivityConfirmationDialog = function (activity) {
                var message = ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_Delete_Message");
                message = window['String'].format(message, ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_Workflow_Activity_Name"));
                var dialogDetails = {
                    dialogTitle: ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_DeleteWorkflow_Title"),
                    dialogMessage: message,
                    messageType: ProcessDesigner.BPFDialogMessageTypes.Warning,
                    yesCallbackAction: this.DeleteConfirmedCallback,
                    noCallbackAction: this.DeleteCancelledCallback
                };
                GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.showDialog, dialogDetails);
            };
            BPFWorkflowActivityDeleteHandler.prototype.DeleteConfirmedCallback = function () {
                return BPFWorkflowActivityDeleteHandler.prototype.deleteActivities();
            };
            BPFWorkflowActivityDeleteHandler.prototype.DeleteCancelledCallback = function () {
                GenericWorkflowDesigner.updateCurrentModel(null);
                return;
            };
            BPFWorkflowActivityDeleteHandler.prototype.deleteWorkflowFromGlobalWorkflow = function (workflow) {
                var workflows = ProcessDesigner.ControlManager.globalWorkflowObject.workflows;
                var index = jQuery.inArray(workflow, workflows);
                if (index == -1) {
                    return;
                }
                ProcessDesigner.ControlManager.globalWorkflowObject.workflows.splice(index, 1);
            };
            BPFWorkflowActivityDeleteHandler.prototype.deleteWorkflowFromStageActivity = function (workflow) {
                var parentStage = workflow.getParent();
                if (parentStage) {
                    var workflows = parentStage.workflows;
                    var index = jQuery.inArray(workflow, workflows);
                    if (index == -1) {
                        return;
                    }
                    parentStage.workflows.splice(index, 1);
                }
            };
            BPFWorkflowActivityDeleteHandler.prototype.deleteActivities = function (toBeDeleted) {
                if (CommonTypes.Types.Object.isNullOrUndefined(toBeDeleted)) {
                    toBeDeleted = GenericWorkflowDesigner.Settings.workflowTree.getSelectedActivities();
                    if (toBeDeleted.length <= 0) {
                        return;
                    }
                }
                var _this = BPFWorkflowActivityDeleteHandler.prototype;
                var deletedActivities = [];
                var stageActivities = [];
                var stage;
                for (var i = 0; i < toBeDeleted.length; i++) {
                    var currentActivity = toBeDeleted[i];
                    stage = currentActivity.getParentStage();
                    deletedActivities.push(currentActivity);
                    if (currentActivity.isGlobalWorkflow())
                        _this.deleteWorkflowFromGlobalWorkflow(currentActivity);
                    else
                        _this.deleteWorkflowFromStageActivity(currentActivity);
                }
                _this.canvasRefreshUtil();
                ProcessDesigner.CanvasDisplayUtility.HandleStageDetailsOverlap();
                var activityIdToSelect = null;
                if (stage) {
                    activityIdToSelect = stage.getActivityID();
                    GenericWorkflowDesigner.updateCurrentModel(stage);
                }
                if (activityIdToSelect) {
                    $('#' + activityIdToSelect).find(".stageTile").addClass("selected");
                }
                GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.refreshToolbarItems);
                GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.editDone);
                GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.activityDeleted, deletedActivities);
                return deletedActivities;
            };
            BPFWorkflowActivityDeleteHandler.prototype.deleteSelectedActivities = function () {
                var toBeDeleted = GenericWorkflowDesigner.Settings.workflowTree.getSelectedActivities();
                for (var i = 0; i < toBeDeleted.length; i++) {
                    var currentActivity = toBeDeleted[i];
                    this.deleteActivityConfirmationDialog(currentActivity.getActivityTypeID());
                }
            };
            return BPFWorkflowActivityDeleteHandler;
        })(GenericWorkflowDesigner.ActivityDeleteHandler);
        ProcessDesigner.BPFWorkflowActivityDeleteHandler = BPFWorkflowActivityDeleteHandler;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// -----------------------------------------------------------------------
// <copyright file="BPFSlotTileHolderGeneratorFactory.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
var ActivityDefinitionModel = GenericWorkflowDesigner.ActivityDefinitionModel;
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        "use strict";
        var BpfSlotTileHolderGeneratorFactory = (function (_super) {
            __extends(BpfSlotTileHolderGeneratorFactory, _super);
            function BpfSlotTileHolderGeneratorFactory() {
                _super.apply(this, arguments);
            }
            BpfSlotTileHolderGeneratorFactory.prototype.createSlotGenerator = function (activity) {
                switch (activity.getActivityTypeID()) {
                    case ProcessDesigner.BPFActivityType.stage:
                        return new ProcessDesigner.BPFSlotTileHolderGenerator(activity);
                    default:
                        return new GenericWorkflowDesigner.DefaultSlotTileHolderGenerator(activity);
                }
            };
            return BpfSlotTileHolderGeneratorFactory;
        })(GenericWorkflowDesigner.SlotTileHolderGeneratorFactory);
        ProcessDesigner.BpfSlotTileHolderGeneratorFactory = BpfSlotTileHolderGeneratorFactory;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// -----------------------------------------------------------------------
// <copyright file="BPFSlotTileHolderGenerator.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        var BPFSlotTileHolderGenerator = (function (_super) {
            __extends(BPFSlotTileHolderGenerator, _super);
            function BPFSlotTileHolderGenerator(slotTileActivity) {
                _super.call(this, slotTileActivity);
                this.activity = slotTileActivity;
            }
            BPFSlotTileHolderGenerator.prototype.generateSlot = function () {
                var slotView = new ProcessDesigner.BpfStageSlotTileHolderView(new GenericWorkflowDesigner.SlotModel(this.activity));
                return slotView;
            };
            return BPFSlotTileHolderGenerator;
        })(GenericWorkflowDesigner.DefaultSlotTileHolderGenerator);
        ProcessDesigner.BPFSlotTileHolderGenerator = BPFSlotTileHolderGenerator;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// -----------------------------------------------------------------------
// <copyright file="BPFSubsequentActivityGenerator.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        var BPFSubsequentActivityGenerator = (function (_super) {
            __extends(BPFSubsequentActivityGenerator, _super);
            function BPFSubsequentActivityGenerator() {
                _super.apply(this, arguments);
            }
            BPFSubsequentActivityGenerator.prototype.BPFSubsequentActivityGenerator = function () {
            };
            BPFSubsequentActivityGenerator.prototype.createGenerator = function (activity) {
                if (activity.getActivityTypeID() == ProcessDesigner.BPFActivityType.condition) {
                    return new ProcessDesigner.ConditionSubsequentActivities(activity);
                }
                else {
                    return new ProcessDesigner.StageSubsequentActivities(activity);
                }
            };
            BPFSubsequentActivityGenerator.prototype.createChildActivities = function (activity) {
                var generator = this.createGenerator(activity);
                return generator.createChildActivities();
            };
            return BPFSubsequentActivityGenerator;
        })(GenericWorkflowDesigner.SubsequentActivityGenerator);
        ProcessDesigner.BPFSubsequentActivityGenerator = BPFSubsequentActivityGenerator;
        ;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// -----------------------------------------------------------------------
// <copyright file="BPFSlotTileHolderHandlerFactory.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        var BPFSlotTileHolderHandlerFactory = (function (_super) {
            __extends(BPFSlotTileHolderHandlerFactory, _super);
            function BPFSlotTileHolderHandlerFactory() {
                _super.apply(this, arguments);
            }
            BPFSlotTileHolderHandlerFactory.prototype.createDropHandler = function (currentActivity) {
                switch (currentActivity.getActivityTypeID()) {
                    case ProcessDesigner.BPFActivityType.stage:
                        return new ProcessDesigner.BPFStageDropHandler(currentActivity);
                    case ProcessDesigner.BPFActivityType.condition:
                        return new ProcessDesigner.BPFConditionDropHandler(currentActivity);
                    default:
                        return _super.prototype.createDropHandler.call(this, currentActivity);
                }
            };
            BPFSlotTileHolderHandlerFactory.prototype.createDblClickHandler = function (currentActivity) {
                switch (currentActivity.getActivityTypeID()) {
                    case ProcessDesigner.BPFActivityType.stage:
                        return new GenericWorkflowDesigner.DefaultActivityDblClickHandler(currentActivity);
                    default:
                        return null;
                }
            };
            return BPFSlotTileHolderHandlerFactory;
        })(GenericWorkflowDesigner.DefaultSlotTileHolderHandlerFactory);
        ProcessDesigner.BPFSlotTileHolderHandlerFactory = BPFSlotTileHolderHandlerFactory;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// -----------------------------------------------------------------------
// <copyright file="ConditionSubsequentActivities.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        var ConditionSubsequentActivities = (function (_super) {
            __extends(ConditionSubsequentActivities, _super);
            function ConditionSubsequentActivities() {
                _super.apply(this, arguments);
            }
            ConditionSubsequentActivities.prototype.createChildActivities = function () {
                if (this.parentActivity.getActivityTypeID() != ProcessDesigner.BPFActivityType.condition) {
                    return [];
                }
                var conditionActivity = this.parentActivity;
                conditionActivity.setNextActivityID(null);
                conditionActivity.NextElseBranchActivity = null;
                var childrenOfCondition = conditionActivity.getChildActivitiesSorted();
                var ifPathExists = false;
                var elsePathExists = false;
                if (childrenOfCondition.length > 0) {
                    childrenOfCondition.forEach(function (childOfCondition) {
                        if (childOfCondition instanceof ProcessDesigner.BPFStageActivity && childOfCondition.getParentBranchID() == ProcessDesigner.DefaultBranchIndices.YesBranch) {
                            ifPathExists = true;
                            conditionActivity.setNextActivityID(childOfCondition.getActivityID());
                        }
                        if ((childOfCondition instanceof ProcessDesigner.BPFStageActivity || childOfCondition instanceof ProcessDesigner.BPFConditionActivity)
                            && childOfCondition.getParentBranchID() == ProcessDesigner.DefaultBranchIndices.NoBranch) {
                            elsePathExists = true;
                        }
                    });
                }
                if (!ifPathExists || !elsePathExists) {
                    var currentActivity = conditionActivity;
                    var defaultStageToPointTo = null;
                    var parentNodes = [];
                    while (!CommonTypes.Types.Object.isNullOrUndefined(currentActivity) && CommonTypes.Types.Object.isNullOrUndefined(defaultStageToPointTo)) {
                        var ifConditionBranchActivity = this.findNextIfConditionBranch(currentActivity);
                        if (!CommonTypes.Types.Object.isNullOrUndefined(ifConditionBranchActivity)) {
                            var childrenOfIfConditionBranch = ifConditionBranchActivity.getChildActivitiesSorted();
                            if (childrenOfIfConditionBranch.length > 0
                                && !CommonTypes.Types.Object.isNullOrUndefined(childrenOfIfConditionBranch[0])
                                && childrenOfIfConditionBranch[0] instanceof ProcessDesigner.BPFStageActivity
                                && childrenOfIfConditionBranch[0].getParentBranchID() == ProcessDesigner.DefaultBranchIndices.DefaultBranch
                                && parentNodes.indexOf(childrenOfIfConditionBranch[0]) < 0) {
                                defaultStageToPointTo = childrenOfIfConditionBranch[0];
                            }
                        }
                        if (CommonTypes.Types.Object.isNullOrUndefined(defaultStageToPointTo)) {
                            currentActivity = currentActivity.getParent();
                            parentNodes[parentNodes.length] = currentActivity;
                        }
                    }
                    if (!CommonTypes.Types.Object.isNullOrUndefined(defaultStageToPointTo)) {
                        if (!ifPathExists) {
                            conditionActivity.setNextActivityID(defaultStageToPointTo.getActivityID());
                        }
                        if (!elsePathExists) {
                            conditionActivity.NextElseBranchActivity = defaultStageToPointTo;
                        }
                    }
                }
            };
            ConditionSubsequentActivities.prototype.findNextIfConditionBranch = function (currentActivity) {
                if (CommonTypes.Types.Object.isNullOrUndefined(currentActivity)) {
                    return null;
                }
                else if (currentActivity instanceof ProcessDesigner.BPFConditionActivity) {
                    while (currentActivity.getParent() instanceof ProcessDesigner.BPFConditionActivity && currentActivity.getParentBranchID() == ProcessDesigner.DefaultBranchIndices.NoBranch) {
                        currentActivity = currentActivity.getParent();
                    }
                    return currentActivity;
                }
                else {
                    if (currentActivity.getParent() instanceof ProcessDesigner.BPFConditionActivity && currentActivity.getParentBranchID() == ProcessDesigner.DefaultBranchIndices.DefaultBranch) {
                        currentActivity = currentActivity.getParent();
                    }
                    return this.findNextIfConditionBranch(currentActivity.getParent());
                }
            };
            return ConditionSubsequentActivities;
        })(GenericWorkflowDesigner.AbstractSubsequentActivities);
        ProcessDesigner.ConditionSubsequentActivities = ConditionSubsequentActivities;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// -----------------------------------------------------------------------
// <copyright file="StageSubsequentActivities.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        var StageSubsequentActivities = (function (_super) {
            __extends(StageSubsequentActivities, _super);
            function StageSubsequentActivities() {
                _super.apply(this, arguments);
            }
            StageSubsequentActivities.prototype.createChildActivities = function () {
                if (this.parentActivity.getActivityTypeID() != ProcessDesigner.BPFActivityType.stage) {
                    return [];
                }
                var stageActivity = this.parentActivity;
                var childrenOfStage = stageActivity.getChildActivitiesSorted();
                if (childrenOfStage.length > 0 && !CommonTypes.Types.Object.isNullOrUndefined(childrenOfStage[0])) {
                    this.parentActivity.setNextActivityID(childrenOfStage[0].getActivityID());
                }
                else {
                    var currentActivity = this.parentActivity;
                    var defaultStageToPointTo = null;
                    while (!CommonTypes.Types.Object.isNullOrUndefined(currentActivity) && CommonTypes.Types.Object.isNullOrUndefined(defaultStageToPointTo)) {
                        if (currentActivity instanceof ProcessDesigner.BPFStageActivity && currentActivity.getParent() instanceof ProcessDesigner.BPFConditionActivity && currentActivity.getParentBranchID() != ProcessDesigner.DefaultBranchIndices.DefaultBranch) {
                            var conditionActivity = currentActivity.getParent();
                            while (conditionActivity.getParentBranchID() == ProcessDesigner.DefaultBranchIndices.NoBranch && conditionActivity.getParent() instanceof ProcessDesigner.BPFConditionActivity) {
                                conditionActivity = conditionActivity.getParent();
                            }
                            var childrenOfIfBranch = conditionActivity.getChildActivitiesSorted();
                            if (!CommonTypes.Types.Object.isNullOrUndefined(childrenOfIfBranch[0]) &&
                                childrenOfIfBranch[0] instanceof ProcessDesigner.BPFStageActivity &&
                                childrenOfIfBranch[0].getParentBranchID() == 0) {
                                defaultStageToPointTo = childrenOfIfBranch[0];
                            }
                        }
                        if (CommonTypes.Types.Object.isNullOrUndefined(defaultStageToPointTo)) {
                            currentActivity = currentActivity.getParent();
                        }
                    }
                    if (currentActivity == null) {
                        this.parentActivity.setNextActivityID(null);
                    }
                    else {
                        if (!CommonTypes.Types.Object.isNullOrUndefined(defaultStageToPointTo)) {
                            this.parentActivity.setNextActivityID(defaultStageToPointTo.getActivityID());
                        }
                        else {
                            this.parentActivity.setNextActivityID(null);
                        }
                    }
                }
                return null;
            };
            return StageSubsequentActivities;
        })(GenericWorkflowDesigner.DefaultSubsequentActivities);
        ProcessDesigner.StageSubsequentActivities = StageSubsequentActivities;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// -----------------------------------------------------------------------
// <copyright file="BPFSlotGeneratorProvider.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        "use strict";
        var BPFSlotGeneratorProvider = (function () {
            function BPFSlotGeneratorProvider() {
            }
            BPFSlotGeneratorProvider.prototype.createGeneratorFactory = function (slotType) {
                switch (slotType) {
                    case GenericWorkflowDesigner.SlotType.TileHolder:
                        return new ProcessDesigner.BpfSlotTileHolderGeneratorFactory();
                    case GenericWorkflowDesigner.SlotType.InsertHorizontal:
                        return new GenericWorkflowDesigner.SlotInsertHorizontalGeneratorFactory();
                    case GenericWorkflowDesigner.SlotType.InsertVertical:
                        return new GenericWorkflowDesigner.SlotInsertVerticalGeneratorFactory();
                    case GenericWorkflowDesigner.SlotType.IconHolder:
                        return new ProcessDesigner.BPFSlotIconHolderGeneratorFactory();
                    case GenericWorkflowDesigner.SlotType.DetailsContainerPlaceholder:
                        return new GenericWorkflowDesigner.SlotDetailsContainerPlaceholderGeneratorFactory();
                    default:
                        return new GenericWorkflowDesigner.SlotTileHolderGeneratorFactory();
                }
            };
            BPFSlotGeneratorProvider.prototype.generateSlotsForActivity = function (activity) {
                var slotTypes = [GenericWorkflowDesigner.SlotType.TileHolder, GenericWorkflowDesigner.SlotType.InsertHorizontal, GenericWorkflowDesigner.SlotType.IconHolder, GenericWorkflowDesigner.SlotType.DetailsContainerPlaceholder];
                if (activity.getActivityTypeID() == "condition") {
                    slotTypes.push(GenericWorkflowDesigner.SlotType.InsertVertical);
                }
                var slotsList = [];
                var insertSlotList = [];
                if (activity.getActivityTypeID() == "stage") {
                    if (activity.entityName == "") {
                        var eName = this.getEntityName(activity.getParent());
                        activity.entityName = eName;
                    }
                }
                for (var i = 0; i < slotTypes.length; i++) {
                    var slotGeneratorFactory = this.createGeneratorFactory(slotTypes[i]);
                    var slot = slotGeneratorFactory.createSlotGenerator(activity).generateSlot();
                    if (slot instanceof GenericWorkflowDesigner.InsertSlotHorizontalView || slot instanceof GenericWorkflowDesigner.InsertSlotVerticalView || slot instanceof GenericWorkflowDesigner.SlotDetailsContainerPlaceholderView) {
                        insertSlotList.push(slot);
                    }
                    if (slot != null) {
                        if (slot instanceof Array) {
                            slotsList.push.apply(slotsList, slot);
                        }
                        else {
                            slotsList.push(slot);
                        }
                    }
                    this.insetSlotClickHandler(insertSlotList);
                }
                this.AddButtonEventListner(slotsList);
                return slotsList;
            };
            BPFSlotGeneratorProvider.prototype.insetSlotClickHandler = function (insertSlotList) {
                for (var i = 0; i < insertSlotList.length; i++) {
                    var self = insertSlotList[i];
                    self.$el.on("mousedown", function (event) {
                        GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.clearSelections);
                        event.stopPropagation();
                    });
                    self.$el.on("click keydown", function (event) {
                        if (($(self.$el).hasClass("hoverOverDroppable") || $(self.$el).hasClass("hoverOverDroppableHighlight"))
                            && (event.type == "click" || event.keyCode == 13)) {
                            switch (ProcessDesigner.BPFToolBarView.addMode) {
                                case ProcessDesigner.BPFToolBarAddMode.AddStage:
                                    var droppedElement = new GenericWorkflowDesigner.LibraryElementModel({
                                        Title: ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_SlotGenerator_Title"),
                                        Tooltip: ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_LibraryTileStageTooltip"),
                                        Image: "", DataURI: "",
                                        Alt: ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_LibraryTileAltText"),
                                        FontIconImage: "", ActivityTypeID: "stage"
                                    });
                                    GenericWorkflowDesigner.SlotBase.supportedEvents.dropLibraryElement.trigger(self, self, droppedElement);
                                    break;
                                case ProcessDesigner.BPFToolBarAddMode.AddCondition:
                                    var droppedElement = new GenericWorkflowDesigner.LibraryElementModel({
                                        Title: ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_SlotGenerator_Title"),
                                        Tooltip: ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_SlotGenerator_ConditionToolTip"),
                                        Image: "", DataURI: "",
                                        Alt: ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_LibraryTileAltText"),
                                        FontIconImage: "", ActivityTypeID: "condition"
                                    });
                                    GenericWorkflowDesigner.SlotBase.supportedEvents.dropLibraryElement.trigger(self, self, droppedElement);
                                    break;
                                case ProcessDesigner.BPFToolBarAddMode.PasteStage:
                                case ProcessDesigner.BPFToolBarAddMode.PasteBranch:
                                    var pasteCmd = new ProcessDesigner.BPFPasteCommand();
                                    pasteCmd.pasteComponentAtSlot(self);
                                    break;
                                default:
                                    console.warn("Internal : Invalid Activity for Adding Stage/Condition");
                            }
                            ProcessDesigner.BPFToolBarView.addMode = ProcessDesigner.BPFToolBarAddMode.None;
                        }
                    });
                }
            };
            BPFSlotGeneratorProvider.prototype.AddButtonEventListner = function (slotList) {
                var AcceptableTiles;
                $(document).on('PasteButton', function (event, droppable) {
                    for (var i = 0; i < slotList.length; i++) {
                        AcceptableTiles = GenericWorkflowDesigner.SlotBase.isValidDroppable(slotList[i].el.id, droppable);
                        if (AcceptableTiles) {
                            $(slotList[i].el).addClass("hoverOverDroppable").attr("aria-hidden", "false");
                        }
                    }
                });
                $(document).on('AddButton', function (event, droppable) {
                    for (var i = 0; i < slotList.length; i++) {
                        AcceptableTiles = slotList[i].getValidDroppables();
                        if (AcceptableTiles.indexOf(droppable) > -1) {
                            if (droppable.search("conditionTile") > 0) {
                                if (slotList[i].model.getActivity() instanceof ProcessDesigner.BPFStageActivity && slotList[i] instanceof GenericWorkflowDesigner.InsertSlotHorizontalView) {
                                    if (!slotList[i].model.getActivity().canAddNewNestedBranch()) {
                                        continue;
                                    }
                                }
                                else if (slotList[i].model.getActivity() instanceof ProcessDesigner.BPFConditionActivity && slotList[i] instanceof GenericWorkflowDesigner.InsertSlotVerticalView) {
                                    if (!slotList[i].model.getActivity().canAddNewBranch()) {
                                        continue;
                                    }
                                }
                            }
                            else if (droppable.search("stageTile") > 0) {
                                if (slotList[i].model.getActivity() instanceof ProcessDesigner.BPFConditionActivity && slotList[i] instanceof GenericWorkflowDesigner.InsertSlotVerticalView) {
                                    if (!slotList[i].model.getActivity().canAddNewBranch()) {
                                        continue;
                                    }
                                }
                            }
                            if (droppable.search("stageTile") > 0 || droppable.search("conditionTile") > 0) {
                                $(slotList[i].el).addClass("hoverOverDroppable").attr("aria-hidden", "false");
                                $(slotList[i].el).html("+");
                            }
                            else if (droppable.search("stepTile") > 0 || droppable.search("connectTile") > 0 || droppable.search("flowStepTile") > 0) {
                                var copied = GenericWorkflowDesigner.Settings.workflowTree.getCopiedActivities();
                                if ((!CommonTypes.Types.Object.isNullOrUndefined(copied)) && copied.length > 0) {
                                    var activityType = copied[0].getActivityTypeID();
                                    if (activityType == ProcessDesigner.BPFActivityType.step || activityType == ProcessDesigner.BPFActivityType.action || activityType == ProcessDesigner.BPFActivityType.flow) {
                                        if ((copied[0].parentStage).entityName == slotList[i].model.getActivity().entityName) {
                                            $(slotList[i].el).addClass("hoverOverDroppable").attr("aria-hidden", "false");
                                        }
                                    }
                                }
                                else {
                                    $(slotList[i].el).addClass("hoverOverDroppable").attr("aria-hidden", "false");
                                }
                            }
                            else {
                                $(slotList[i].el).addClass("hoverOverDroppable").attr("aria-hidden", "false");
                            }
                            if (droppable.search("connectTile") > 0) {
                                $("#globalButtonArea").find(".ui-droppable").addClass("hoverOverDroppable").attr("aria-hidden", "false");
                                $("#globalButtonArea #globalButtonAreaTable #btnToggleButtons").attr("aria-label", ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_ScreenReader_AddNewTile"));
                            }
                        }
                    }
                    var allDroppableTiles = $('.ui-droppable.slot.hoverOverDroppable .tile .stageTile');
                    $.each(allDroppableTiles, function (key, val) {
                        var droppableTile = $(val);
                        droppableTile.attr('aria-label', ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_ScreenReader_AddNewTile")).attr("aria-hidden", "false");
                    });
                    $("#zoomoutdiv .ui-droppable.slotInsertHorizontal").removeAttr("title");
                });
            };
            BPFSlotGeneratorProvider.prototype.getEntityName = function (activity) {
                if (activity.getActivityTypeID() == "stage") {
                    this.entityName = activity.entityName;
                    return this.entityName;
                }
                else if (activity.getActivityTypeID() == "condition") {
                    return this.getEntityName(activity.getParent());
                }
                else {
                    return null;
                }
            };
            return BPFSlotGeneratorProvider;
        })();
        ProcessDesigner.BPFSlotGeneratorProvider = BPFSlotGeneratorProvider;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// -----------------------------------------------------------------------
// <copyright file="BPFSlotHandlerProvider.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        'use strict';
        var SlotType = GenericWorkflowDesigner.SlotType;
        var BPFSlotHandlerProvider = (function (_super) {
            __extends(BPFSlotHandlerProvider, _super);
            function BPFSlotHandlerProvider() {
                _super.apply(this, arguments);
            }
            BPFSlotHandlerProvider.prototype.createFactory = function (slotModel) {
                switch (slotModel.getType()) {
                    case SlotType.TileHolder:
                        return GenericWorkflowDesigner.Settings.slotHandlerFactory;
                    case SlotType.InsertHorizontal:
                        return new ProcessDesigner.BPFSlotInsertHorizontalHandlerFactory();
                    case SlotType.InsertVertical:
                        return new ProcessDesigner.BPFSlotInsertVerticalHandlerFactory();
                    case SlotType.IconHolder:
                        return new GenericWorkflowDesigner.SlotIconHolderHandlerFactory();
                    default:
                        throw Error("Internal : Slot type is not supported");
                }
            };
            BPFSlotHandlerProvider.prototype.createDropHandler = function (slotModel) {
                var slotHandlerFactory = this.createFactory(slotModel);
                return slotHandlerFactory.createDropHandler(slotModel.getActivity());
            };
            return BPFSlotHandlerProvider;
        })(GenericWorkflowDesigner.SlotHandlerProvider);
        ProcessDesigner.BPFSlotHandlerProvider = BPFSlotHandlerProvider;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// -----------------------------------------------------------------------
// <copyright file="BPFSlotInsertHorizontalHandlerFactory.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        'use strict';
        var BPFSlotInsertHorizontalHandlerFactory = (function (_super) {
            __extends(BPFSlotInsertHorizontalHandlerFactory, _super);
            function BPFSlotInsertHorizontalHandlerFactory() {
                _super.apply(this, arguments);
            }
            BPFSlotInsertHorizontalHandlerFactory.prototype.createDropHandler = function (currentActivity) {
                switch (currentActivity.getActivityTypeID()) {
                    default: return new GenericWorkflowDesigner.DefaultInsertSlotHorizontalDropHandler(currentActivity);
                }
            };
            return BPFSlotInsertHorizontalHandlerFactory;
        })(GenericWorkflowDesigner.SlotInsertHorizontalHandlerFactory);
        ProcessDesigner.BPFSlotInsertHorizontalHandlerFactory = BPFSlotInsertHorizontalHandlerFactory;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// -----------------------------------------------------------------------
// <copyright file="BPFSlotInsertVerticalHandlerFactory.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        'use strict';
        var BPFSlotInsertVerticalHandlerFactory = (function (_super) {
            __extends(BPFSlotInsertVerticalHandlerFactory, _super);
            function BPFSlotInsertVerticalHandlerFactory() {
                _super.apply(this, arguments);
            }
            BPFSlotInsertVerticalHandlerFactory.prototype.createDropHandler = function (currentActivity) {
                switch (currentActivity.getActivityTypeID()) {
                    default: return new ProcessDesigner.BPFDefaultInsertSlotVerticalDropHandler(currentActivity);
                }
            };
            return BPFSlotInsertVerticalHandlerFactory;
        })(GenericWorkflowDesigner.SlotInsertVerticalHandlerFactory);
        ProcessDesigner.BPFSlotInsertVerticalHandlerFactory = BPFSlotInsertVerticalHandlerFactory;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// -----------------------------------------------------------------------
// <copyright file="BPFSlotIconHolderGeneratorFactory.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        "use strict";
        var BPFSlotIconHolderGeneratorFactory = (function () {
            function BPFSlotIconHolderGeneratorFactory() {
            }
            BPFSlotIconHolderGeneratorFactory.prototype.createSlotGenerator = function (activity) {
                switch (activity.getActivityTypeID()) {
                    case ProcessDesigner.BPFActivityType.stage:
                    case ProcessDesigner.BPFActivityType.condition:
                        return new ProcessDesigner.BPFSlotIconHolderGenerator(activity);
                    default:
                        return new ProcessDesigner.BPFSlotIconHolderGenerator(activity);
                }
            };
            return BPFSlotIconHolderGeneratorFactory;
        })();
        ProcessDesigner.BPFSlotIconHolderGeneratorFactory = BPFSlotIconHolderGeneratorFactory;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// -----------------------------------------------------------------------
// <copyright file="BPFSlotIconHolderGenerator.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        "use strict";
        var BPFSlotIconHolderGenerator = (function (_super) {
            __extends(BPFSlotIconHolderGenerator, _super);
            function BPFSlotIconHolderGenerator() {
                _super.apply(this, arguments);
            }
            BPFSlotIconHolderGenerator.prototype.generateSlot = function () {
                var list = [];
                if (this.activity.getActivityTypeID() != "condition") {
                    return null;
                }
                if (this.activity.getActivityTypeID() == "condition") {
                    var yesIconView = new GenericWorkflowDesigner.SlotIconHolderView({ model: new GenericWorkflowDesigner.SlotModel(this.activity, GenericWorkflowDesigner.SlotType.IconHolder, GenericWorkflowDesigner.SlotIconType.YesBranch) });
                    var noIconView = new GenericWorkflowDesigner.SlotIconHolderView({ model: new GenericWorkflowDesigner.SlotModel(this.activity, GenericWorkflowDesigner.SlotType.IconHolder, GenericWorkflowDesigner.SlotIconType.NoBranch) });
                    list.push(yesIconView);
                    list.push(noIconView);
                    return list;
                }
                return null;
            };
            return BPFSlotIconHolderGenerator;
        })(GenericWorkflowDesigner.AbstractSlotGenerator);
        ProcessDesigner.BPFSlotIconHolderGenerator = BPFSlotIconHolderGenerator;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// -----------------------------------------------------------------------
// <copyright file="BPFSlotGeneratorProvider.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        "use strict";
        var BPFIconFactory = (function () {
            function BPFIconFactory() {
                this.iconTemplate = "";
                this.iconTemplate = '<div class="iconContainer"><%if(typeof (image) !== "undefined") {%><img width="16px" height="16px" title="<%- tooltipText %>" src="<%- image %>" alt="<%- alt %>"></img><%}%><%if(typeof(dataURI) !== "undefined"){%><img width="16px" height="16px" title="<%- tooltipText %>" src="data:png;base64,<%- dataURI %>" alt="<%- alt %>"></img> <%}%><%if(typeof(fontIconImage) !== "undefined"){%><span class="CCFSymbolFont <%- fontIconImage %> <%- fontIconType %>"></span><%}%></div>';
            }
            BPFIconFactory.prototype.getIconAttributes = function (iconType) {
                switch (iconType) {
                    case GenericWorkflowDesigner.SlotIconType.YesBranch:
                        return new ProcessDesigner.YesBranchIconAttributes();
                    case GenericWorkflowDesigner.SlotIconType.NoBranch:
                        return new ProcessDesigner.NoBranchIconAttributes();
                    default:
                        throw Error("Internal : Specified icon type does not exist");
                }
            };
            BPFIconFactory.prototype.createIcon = function (iconType) {
                var iconAttributes = this.getIconAttributes(iconType);
                var slotIconHolderTemplate = _.template(this.iconTemplate);
                return $(slotIconHolderTemplate(iconAttributes))[0];
            };
            return BPFIconFactory;
        })();
        ProcessDesigner.BPFIconFactory = BPFIconFactory;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// -----------------------------------------------------------------------
// <copyright file="YesBranchIconAttributes.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        "use strict";
        var YesBranchIconAttributes = (function () {
            function YesBranchIconAttributes() {
                this.title = "Yes Branch";
                this.fontIconImage = "yesBranchSymbol";
                this.fontIconType = "yesBranchFontIcon";
                this.alt = "Condition evaluates to Yes.";
                this.tooltipText = "Condition Positive Branch Activity";
            }
            return YesBranchIconAttributes;
        })();
        ProcessDesigner.YesBranchIconAttributes = YesBranchIconAttributes;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// -----------------------------------------------------------------------
// <copyright file="NoBranchIconAttributes.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        "use strict";
        var NoBranchIconAttributes = (function () {
            function NoBranchIconAttributes() {
                this.title = "No Branch";
                this.fontIconImage = "noBranchSymbol";
                this.fontIconType = "noBranchFontIcon";
                this.alt = "Condition evaluates to No.";
                this.tooltipText = "Condition Negative Branch Activity";
            }
            return NoBranchIconAttributes;
        })();
        ProcessDesigner.NoBranchIconAttributes = NoBranchIconAttributes;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// -----------------------------------------------------------------------
// <copyright file="StageTileButtonClickHandler.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        var StageTileButtonClickHandler = (function () {
            function StageTileButtonClickHandler(currentActivity) {
                this.currentActivity = currentActivity;
            }
            StageTileButtonClickHandler.prototype.click = function (elementClicked) {
                GenericWorkflowDesigner.eventManager.trigger('hideMenus');
                GenericWorkflowDesigner.eventManager.trigger('hideContextMenus');
                ProcessDesigner.TelemetryEventReporter.ReportTileDetailsViewedTelemetryEvent(this.currentActivity.stageId, ProcessDesigner.BPFActivityType.stage, "");
                if ($("#canvas").find(".stage-detail-container").length > 0) {
                    if (ProcessDesigner.BPFToolBarView.addMode != ProcessDesigner.BPFToolBarAddMode.DropStep && ProcessDesigner.BPFToolBarView.addMode != ProcessDesigner.BPFToolBarAddMode.DropWorkflow) {
                        var stageDetailsContainer = $("#canvas").find(".stage-detail-container");
                        var selectedActivity = this.getSelectedActivity(this.currentActivity);
                        if (!selectedActivity) {
                            selectedActivity = this.currentActivity;
                        }
                        var selectedActivityName = ProcessDesigner.ElementPrefixes.DetailsPrefix + selectedActivity.getActivityID();
                        var stageDetailsContainerId = $(stageDetailsContainer).attr("id");
                        stageDetailsContainer.remove();
                        if (StageTileButtonClickHandler.stepListView) {
                            StageTileButtonClickHandler.stepListView.deleteStepListView();
                        }
                        if (selectedActivityName != stageDetailsContainerId) {
                            var stopwatch = new GenericWorkflowDesigner.Stopwatch();
                            stopwatch.start();
                            GenericWorkflowDesigner.updateCurrentModel(this.currentActivity);
                            var existingButtonText = stageDetailsContainerId.replace(ProcessDesigner.ElementPrefixes.DetailsPrefix, ProcessDesigner.ElementPrefixes.TileButtonTextPrefix);
                            var existingButtonImage = stageDetailsContainerId.replace(ProcessDesigner.ElementPrefixes.DetailsPrefix, ProcessDesigner.ElementPrefixes.TileButtonImagePrefix);
                            if ($(existingButtonImage).hasClass("Expanded-symbol")) {
                                $(existingButtonImage).removeClass("Expanded-symbol");
                                $(existingButtonImage).addClass("Collapsed-symbol");
                            }
                            else {
                                $(existingButtonImage).removeClass("Collapsed-symbol");
                                $(existingButtonImage).addClass("Expanded-symbol");
                            }
                            GenericWorkflowDesigner.updateCurrentModel(this.currentActivity);
                            var currentModelName = GenericWorkflowDesigner.currentModel.getActivityID();
                            var tileButtonImageName = ProcessDesigner.ElementPrefixes.TileButtonImagePrefix + currentModelName;
                            if ($(tileButtonImageName).hasClass("Expanded-symbol")) {
                                $(tileButtonImageName).removeClass("Expanded-symbol");
                                $(tileButtonImageName).addClass("Collapsed-symbol");
                            }
                            else {
                                $(tileButtonImageName).removeClass("Collapsed-symbol");
                                $(tileButtonImageName).addClass("Expanded-symbol");
                            }
                            StageTileButtonClickHandler.stepListView = new MscrmControls.ProcessDesigner.StepListView(this.currentActivity, elementClicked);
                            stopwatch.stop();
                            localStorage.setItem("ProcessDesignerControl_BPF_ExpandStepList", stopwatch.elapsedMilliseconds.toString());
                            return;
                        }
                        else {
                            var currentModelName = selectedActivity.getActivityID();
                            var tileButtonImageName = ProcessDesigner.ElementPrefixes.TileButtonImagePrefix + currentModelName;
                            if ($(tileButtonImageName).hasClass("Expanded-symbol")) {
                                $(tileButtonImageName).removeClass("Expanded-symbol");
                                $(tileButtonImageName).addClass("Collapsed-symbol");
                            }
                            else {
                                $(tileButtonImageName).removeClass("Collapsed-symbol");
                                $(tileButtonImageName).addClass("Expanded-symbol");
                            }
                        }
                    }
                }
                else {
                    var stopwatch = new GenericWorkflowDesigner.Stopwatch();
                    stopwatch.start();
                    GenericWorkflowDesigner.currentModel = this.currentActivity;
                    var currentModelName = GenericWorkflowDesigner.currentModel.getActivityID();
                    var tileButtonImageName = ProcessDesigner.ElementPrefixes.TileButtonImagePrefix + currentModelName;
                    if ($(tileButtonImageName).hasClass("Expanded-symbol")) {
                        $(tileButtonImageName).removeClass("Expanded-symbol");
                        $(tileButtonImageName).addClass("Collapsed-symbol");
                    }
                    else {
                        $(tileButtonImageName).removeClass("Collapsed-symbol");
                        $(tileButtonImageName).addClass("Expanded-symbol");
                    }
                    StageTileButtonClickHandler.stepListView = new MscrmControls.ProcessDesigner.StepListView(this.currentActivity, elementClicked);
                    stopwatch.stop();
                    localStorage.setItem("ProcessDesignerControl_BPF_ExpandStepList", stopwatch.elapsedMilliseconds.toString());
                    return;
                }
            };
            StageTileButtonClickHandler.prototype.getSelectedActivity = function (givenActivity) {
                if (givenActivity instanceof MscrmControls.ProcessDesigner.BPFStepActivity) {
                    return givenActivity.parentStage;
                }
                else if (givenActivity instanceof MscrmControls.ProcessDesigner.BPFStageActivity) {
                    return givenActivity;
                }
            };
            return StageTileButtonClickHandler;
        })();
        ProcessDesigner.StageTileButtonClickHandler = StageTileButtonClickHandler;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// -----------------------------------------------------------------------
// <copyright file="BPFStageDropHandler.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        var BPFStageDropHandler = (function (_super) {
            __extends(BPFStageDropHandler, _super);
            function BPFStageDropHandler() {
                _super.apply(this, arguments);
            }
            BPFStageDropHandler.prototype.drop = function (droppedActivitiesComponent) {
                var self = this;
                var deferred = $.Deferred();
                var rootActivity = droppedActivitiesComponent.getRoot();
                if (rootActivity && rootActivity.getActivityTypeID() != ProcessDesigner.BPFActivityType.workflow && !this.isStageStep(rootActivity)) {
                    return _super.prototype.drop.call(this, droppedActivitiesComponent);
                }
                if (!this.dropAllowed(droppedActivitiesComponent)) {
                    deferred.resolveWith(this.currentActivity, [this.currentActivity]);
                    return deferred.promise();
                }
                if (rootActivity && rootActivity.getParent() && rootActivity.getParent().entityName != this.currentActivity.entityName) {
                    deferred.resolveWith(this.currentActivity, [this.currentActivity]);
                    return deferred.promise();
                }
                if (!rootActivity || this.currentActivity.getActivityTypeID() != ProcessDesigner.BPFActivityType.stage) {
                    deferred.resolveWith(this.currentActivity, [this.currentActivity]);
                    return deferred.promise();
                }
                var addModeName = ProcessDesigner.TelemetryEventReporter.GetAddModeNameForActivity(ProcessDesigner.BPFToolBarView.addMode);
                if (this.isStageStep(rootActivity)) {
                    var stepActivity = rootActivity.getActivityTypeID() == ProcessDesigner.BPFActivityType.step ? rootActivity : rootActivity;
                    stepActivity.parentStage = this.currentActivity;
                    stepActivity.setParentActivityID(this.currentActivity.getActivityID());
                    stepActivity.isNewlyAdded = true;
                    this.currentActivity.steps.push(stepActivity);
                    ProcessDesigner.TelemetryEventReporter.ReportTileAddedTelemetryEvent(addModeName, stepActivity.stepId, ProcessDesigner.BPFActivityType.step, this.currentActivity.stageId);
                    deferred.resolveWith(rootActivity, [rootActivity]);
                    GenericWorkflowDesigner.currentModel = this.currentActivity;
                    ProcessDesigner.BPFToolBarView.addMode = ProcessDesigner.BPFToolBarAddMode.DropStep;
                    GenericWorkflowDesigner.Settings.isNewStageAdded = false;
                    ProcessDesigner.ControlManager.isNewStepAdded = false;
                    ProcessDesigner.ControlManager.ShowSeeDetails();
                    ProcessDesigner.ControlManager.isNewStepAdded = true;
                    ProcessDesigner.CanvasDisplayUtility.HandleStageDetailsOverlap();
                    ProcessDesigner.BPFToolBarView.addMode = ProcessDesigner.BPFToolBarAddMode.None;
                    return deferred.promise();
                }
                else if (rootActivity.getActivityTypeID() == ProcessDesigner.BPFActivityType.workflow) {
                    var workflowActivity = rootActivity;
                    workflowActivity.parentStage = this.currentActivity;
                    workflowActivity.setParentActivityID(this.currentActivity.getActivityID());
                    workflowActivity.isNewlyAdded = true;
                    this.currentActivity.workflows.push(workflowActivity);
                    ProcessDesigner.TelemetryEventReporter.ReportTileAddedTelemetryEvent(addModeName, workflowActivity.actionStepId, ProcessDesigner.BPFActivityType.workflow, this.currentActivity.stageId);
                    deferred.resolveWith(rootActivity, [rootActivity]);
                    GenericWorkflowDesigner.currentModel = this.currentActivity;
                    ProcessDesigner.BPFToolBarView.addMode = ProcessDesigner.BPFToolBarAddMode.DropWorkflow;
                    ProcessDesigner.ControlManager.isNewActionStepAdded = false;
                    ProcessDesigner.ControlManager.ShowSeeDetails();
                    ProcessDesigner.ControlManager.isNewActionStepAdded = true;
                    ProcessDesigner.CanvasDisplayUtility.HandleStageDetailsOverlap();
                    ProcessDesigner.BPFToolBarView.addMode = ProcessDesigner.BPFToolBarAddMode.None;
                    return deferred.promise();
                }
            };
            BPFStageDropHandler.prototype.dropAllowed = function (activityComponent) {
                if (this.isStageStep(activityComponent.getRoot())) {
                    return true;
                }
                else {
                    return _super.prototype.dropAllowed.call(this, activityComponent);
                }
            };
            BPFStageDropHandler.prototype.isStageStep = function (activity) {
                return activity.getActivityTypeID() == ProcessDesigner.BPFActivityType.step
                    || activity.getActivityTypeID() == ProcessDesigner.BPFActivityType.action
                    || activity.getActivityTypeID() == ProcessDesigner.BPFActivityType.flow;
            };
            return BPFStageDropHandler;
        })(GenericWorkflowDesigner.DefaultActivityDropHandler);
        ProcessDesigner.BPFStageDropHandler = BPFStageDropHandler;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// -----------------------------------------------------------------------
// <copyright file="BPFConditionDropHandler.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        var BPFConditionDropHandler = (function (_super) {
            __extends(BPFConditionDropHandler, _super);
            function BPFConditionDropHandler() {
                _super.apply(this, arguments);
            }
            BPFConditionDropHandler.prototype.drop = function (droppedActivitiesComponent) {
                var self = this;
                var deferred = $.Deferred();
                if (!this.dropAllowed(droppedActivitiesComponent)) {
                    deferred.resolveWith(this.currentActivity, [this.currentActivity]);
                    return deferred.promise();
                }
                if (droppedActivitiesComponent.getRoot().getActivityTypeID() == "connect") {
                    deferred.resolve();
                    return deferred.promise();
                }
                var childActivities = self.currentActivity.getChildActivitiesSorted();
                if (childActivities.length > 0 && childActivities[0].getActivityTypeID() == GenericWorkflowDesigner.ActivityType.Empty) {
                    GenericWorkflowDesigner.Settings.workflowTree.remove(childActivities[0]);
                }
                GenericWorkflowDesigner.Settings.workflowTree.cutConnectedComponent(droppedActivitiesComponent).done(function () {
                    var rootActivity = droppedActivitiesComponent.getRoot();
                    GenericWorkflowDesigner.Settings.workflowTree.addChildActivity(self.currentActivity, rootActivity);
                    rootActivity.saveActivityWithSubsequentActivities().done(function (insertedActivity) {
                        deferred.resolveWith(insertedActivity, [insertedActivity]);
                    });
                });
                return deferred.promise();
            };
            return BPFConditionDropHandler;
        })(GenericWorkflowDesigner.DefaultActivityDropHandler);
        ProcessDesigner.BPFConditionDropHandler = BPFConditionDropHandler;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// -----------------------------------------------------------------------
// <copyright file="BPFDefaultInsertSlotVerticalDropHandler.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        'use strict';
        var BPFDefaultInsertSlotVerticalDropHandler = (function (_super) {
            __extends(BPFDefaultInsertSlotVerticalDropHandler, _super);
            function BPFDefaultInsertSlotVerticalDropHandler() {
                _super.apply(this, arguments);
            }
            BPFDefaultInsertSlotVerticalDropHandler.prototype.drop = function (activityComponent) {
                var self = this;
                var deferred = $.Deferred();
                if (!this.dropAllowed(activityComponent)) {
                    deferred.resolve();
                    return deferred.promise();
                }
                GenericWorkflowDesigner.Settings.workflowTree.cutConnectedComponent(activityComponent).done(function () {
                    self.insertActivityComponent(activityComponent).done(function (activity) {
                        var addModeName = ProcessDesigner.TelemetryEventReporter.GetAddModeNameForActivity(ProcessDesigner.BPFToolBarView.addMode);
                        switch (activity.getActivityTypeID()) {
                            case ProcessDesigner.BPFActivityType.stage:
                                GenericWorkflowDesigner.Settings.isNewStageAdded = true;
                                ProcessDesigner.TelemetryEventReporter.ReportTileAddedTelemetryEvent(addModeName, activity.stageId, ProcessDesigner.BPFActivityType.stage, "");
                                break;
                            case ProcessDesigner.BPFActivityType.condition:
                                ProcessDesigner.TelemetryEventReporter.ReportTileAddedTelemetryEvent(addModeName, "", ProcessDesigner.BPFActivityType.condition, "");
                                break;
                        }
                        deferred.resolveWith(activity, [activity]);
                    });
                });
                return deferred.promise();
            };
            BPFDefaultInsertSlotVerticalDropHandler.prototype.insertActivityComponent = function (droppedActivityComponent) {
                var parent = this.currentActivity;
                var index = 2, branchID;
                var childs = parent.getChildActivitiesSorted();
                switch (childs.length) {
                    case 0:
                        return GenericWorkflowDesigner.Settings.workflowTree.insertChildActivityComponentAtIndex(parent, droppedActivityComponent, index);
                    case 1:
                        branchID = childs[0].getParentBranchID();
                        switch (branchID) {
                            case 0:
                                return GenericWorkflowDesigner.Settings.workflowTree.insertChildActivityComponentAtIndex(parent, droppedActivityComponent, index);
                            case 1:
                                return GenericWorkflowDesigner.Settings.workflowTree.insertChildActivityComponentAtIndex(parent, droppedActivityComponent, index);
                            case 2:
                                return GenericWorkflowDesigner.Settings.workflowTree.insertActivityComponentBefore(childs[0], droppedActivityComponent);
                        }
                        ;
                        break;
                    case 2:
                        branchID = childs[0].getParentBranchID();
                        switch (branchID) {
                            case 0:
                                var innerBranchID = childs[1].getParentBranchID();
                                switch (innerBranchID) {
                                    case 1:
                                        return GenericWorkflowDesigner.Settings.workflowTree.insertChildActivityComponentAtIndex(parent, droppedActivityComponent, index);
                                    case 2:
                                        return GenericWorkflowDesigner.Settings.workflowTree.insertActivityComponentBefore(childs[1], droppedActivityComponent);
                                }
                                ;
                                break;
                            case 1:
                                return GenericWorkflowDesigner.Settings.workflowTree.insertActivityComponentBefore(childs[1], droppedActivityComponent);
                        }
                        ;
                        break;
                    case 3:
                        return GenericWorkflowDesigner.Settings.workflowTree.insertActivityComponentBefore(childs[2], droppedActivityComponent);
                }
            };
            BPFDefaultInsertSlotVerticalDropHandler.prototype.dropAllowed = function (activityComponent) {
                if (activityComponent.getRoot().getActivityID() == this.currentActivity.getActivityID() ||
                    $.inArray(this.currentActivity, activityComponent.getNodes()) > -1) {
                    return false;
                }
                return true;
            };
            return BPFDefaultInsertSlotVerticalDropHandler;
        })(GenericWorkflowDesigner.DefaultInsertSlotVerticalDropHandler);
        ProcessDesigner.BPFDefaultInsertSlotVerticalDropHandler = BPFDefaultInsertSlotVerticalDropHandler;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
//---------------------------------------------------------------------------------------------
// <copyright file="BranchActivity.ts" company="Microsoft">
//		Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
//
// <summary>
// Represent the tile information of the Branch activity
// </summary>
//
//---------------------------------------------------------------------------------------------
/// <reference path="../Common/ProcessActivityType.ts"/>
/// <reference path="ProcessActivityDefinitionModel.ts"/>
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        'use strict';
        var BranchActivity = (function (_super) {
            __extends(BranchActivity, _super);
            function BranchActivity(activityType) {
                _super.call(this, activityType);
            }
            Object.defineProperty(BranchActivity.prototype, "defaultBranch", {
                get: function () {
                    if (this._defaultBranch == null) {
                        this._defaultBranch = this.findDefaultBranch();
                    }
                    return this._defaultBranch;
                },
                enumerable: true,
                configurable: true
            });
            BranchActivity.prototype.findDefaultBranch = function () {
                return null;
            };
            BranchActivity.prototype.findBranchById = function (branchId) {
                var children = this.getChildActivitiesSorted();
                for (var i = 0; i < children.length; ++i) {
                    if (children[i].getParentBranchID() === branchId) {
                        return children[i];
                    }
                }
                return null;
            };
            BranchActivity.prototype.getDefaultBranchActivityParentsForLineConnections = function () {
                return this.recursiveGetDefaultBranchActivityParentsForLineConnections(this);
            };
            BranchActivity.prototype.recursiveGetDefaultBranchActivityParentsForLineConnections = function (activity) {
                if (activity == null) {
                    return null;
                }
                var children = activity.getChildActivitiesSorted();
                var parents = [];
                for (var i = 0; i < children.length; ++i) {
                    var child = children[i];
                    if (child === this.defaultBranch) {
                        continue;
                    }
                    if (child.isLeaf()) {
                        parents.push(child);
                    }
                    else {
                        if (child instanceof BranchActivity) {
                            var connections = child.getDefaultBranchActivityParentsForLineConnections();
                            parents = parents.concat(connections);
                        }
                        else {
                            parents = parents.concat(this.recursiveGetDefaultBranchActivityParentsForLineConnections(child));
                        }
                    }
                }
                return parents;
            };
            return BranchActivity;
        })(ProcessDesigner.ProcessActivityDefinitionModel);
        ProcessDesigner.BranchActivity = BranchActivity;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// ---------------------------------------------------------------------------------------------
//  <copyright file="ConditionActivity.ts" company="Microsoft">
//         Copyright (c) Microsoft Corporation.  All rights reserved.
//  </copyright>
// 
//  <summary>
//  Represent the condition activity of the process
//  </summary>
// 
// ---------------------------------------------------------------------------------------------
/// <reference path="branchactivity.ts" />
/// <reference path="../../bpf/common/bpfactivitytype.ts" />
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        var ConditionActivity = (function (_super) {
            __extends(ConditionActivity, _super);
            function ConditionActivity() {
                _super.call(this, ProcessDesigner.BPFActivityType.condition);
            }
            ConditionActivity.prototype.initialize = function (properties) {
                _super.prototype.initialize.call(this, properties);
                this.setActivityTypeID(ProcessDesigner.BPFActivityType.condition);
                this.addNewItem(ProcessDesigner.BPFActivityType.condition);
            };
            ConditionActivity.prototype.findDefaultBranch = function () {
                return this.findBranchById(ProcessDesigner.DefaultBranchIndices.DefaultBranch);
            };
            ConditionActivity.prototype.recursiveGetDefaultBranchActivityParentsForLineConnections = function (activity) {
                var children = activity.getChildActivitiesSorted();
                var parents = [];
                var nonDefaultChildren = 0;
                for (var i = 0; i < children.length; ++i) {
                    var child = children[i];
                    if (child === this.defaultBranch) {
                        continue;
                    }
                    if (child.isLeaf()) {
                        parents.push(child);
                    }
                    else {
                        var connections = [];
                        if (child instanceof ProcessDesigner.BranchActivity) {
                            connections = child.getDefaultBranchActivityParentsForLineConnections();
                        }
                        else {
                            connections = _super.prototype.recursiveGetDefaultBranchActivityParentsForLineConnections.call(this, child);
                        }
                        parents = parents.concat(connections);
                    }
                    ++nonDefaultChildren;
                }
                if (nonDefaultChildren === 1) {
                    parents.push(this);
                }
                return parents;
            };
            ConditionActivity.prototype.isLeaf = function () {
                var count = this.getActivities().length;
                return (count > 0) ? false : true;
            };
            return ConditionActivity;
        })(ProcessDesigner.BranchActivity);
        ProcessDesigner.ConditionActivity = ConditionActivity;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
//---------------------------------------------------------------------------------------------
// <copyright file="IBPFConditionActivity.ts" company="Microsoft">
//		Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
//
// <summary>
// Represent the stage activity of the business process
// </summary>
//---------------------------------------------------------------------------------------------
//---------------------------------------------------------------------------------------------
// <copyright file="BPFConditionActivity.ts" company="Microsoft">
//		Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
//
// <summary>
// Represent the condition activity of the business process
// </summary>
//---------------------------------------------------------------------------------------------
/// <reference path="../../../process/model/conditionactivity.ts" />
/// <reference path="ibpfconditionactivity.ts" />
/// <reference path="../../../../Common/IValid.ts" />
/// <reference path="../../../../Common/Rules.ts" />
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        var WorkflowObjectModel = Microsoft.Crm.Workflow.ObjectModel;
        var WorkflowExpressions = Microsoft.Crm.Workflow.Expressions;
        var MetadataProxy = MscrmControls.ProcessDesigner.MetadataProxy;
        var Validation = MscrmControls.ProcessDesigner.Validation;
        (function (formulaOperator) {
            formulaOperator[formulaOperator["Add"] = 0] = "Add";
            formulaOperator[formulaOperator["Substract"] = 1] = "Substract";
            formulaOperator[formulaOperator["Multiply"] = 2] = "Multiply";
            formulaOperator[formulaOperator["Divide"] = 3] = "Divide";
        })(ProcessDesigner.formulaOperator || (ProcessDesigner.formulaOperator = {}));
        var formulaOperator = ProcessDesigner.formulaOperator;
        (function (branchType) {
            branchType[branchType["Default"] = 0] = "Default";
            branchType[branchType["If"] = 1] = "If";
            branchType[branchType["Else"] = 2] = "Else";
        })(ProcessDesigner.branchType || (ProcessDesigner.branchType = {}));
        var branchType = ProcessDesigner.branchType;
        var ConditionFormula = (function (_super) {
            __extends(ConditionFormula, _super);
            function ConditionFormula() {
                _super.apply(this, arguments);
                this._attribute = "";
                this._isAttribute = false;
                this._value = "0";
            }
            Object.defineProperty(ConditionFormula.prototype, "operator", {
                get: function () {
                    return this._operator;
                },
                set: function (value) {
                    this._operator = value;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(ConditionFormula.prototype, "isAttribute", {
                get: function () {
                    return this._isAttribute;
                },
                set: function (value) {
                    this._isAttribute = value;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(ConditionFormula.prototype, "attribute", {
                get: function () {
                    return this._attribute;
                },
                set: function (value) {
                    this._attribute = value;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(ConditionFormula.prototype, "parentAttribute", {
                set: function (value) {
                    this._parentAttribute = value;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(ConditionFormula.prototype, "entityName", {
                set: function (value) {
                    this._entityName = value;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(ConditionFormula.prototype, "value", {
                get: function () {
                    return this._value;
                },
                set: function (value) {
                    this._value = value;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(ConditionFormula.prototype, "leftAttributeType", {
                get: function () {
                    return this._leftAttributeType;
                },
                set: function (value) {
                    this._leftAttributeType = value;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(ConditionFormula.prototype, "rightAttributeType", {
                get: function () {
                    return this._rightAttributeType;
                },
                set: function (value) {
                    this._rightAttributeType = value;
                },
                enumerable: true,
                configurable: true
            });
            ConditionFormula.prototype.equals = function (cf) {
                if (!(cf instanceof ConditionFormula))
                    return false;
                if (this._operator != cf.operator)
                    return false;
                if (this._attribute != cf._attribute)
                    return false;
                if (this._isAttribute != cf._isAttribute)
                    return false;
                if (this._value != cf._value)
                    return false;
                if (this._leftAttributeType != cf._leftAttributeType)
                    return false;
                if (this._rightAttributeType != cf._rightAttributeType)
                    return false;
                return true;
            };
            ConditionFormula.prototype._validateActivity = function () {
                var status = true;
                if (!this._isAttribute) {
                    var attributeType = MetadataProxy.getAttributeType(this._parentAttribute, this._entityName);
                    var result = null;
                    if (attributeType == ProcessDesigner.AttributeType.DateTime) {
                        result = Validation.Engine.validateDateTimeFormulaValue("#formulaValueContainer", this._value, Validation.Level.Change);
                    }
                    else {
                        result = Validation.Engine.validateAttributeValue(this._entityName, "#formulaValueContainer", this._value, this._parentAttribute, Validation.Level.Change);
                    }
                    status = this.addResult(result) && status;
                }
                return status;
            };
            return ConditionFormula;
        })(Validation.ValidModel);
        ProcessDesigner.ConditionFormula = ConditionFormula;
        var Value = (function (_super) {
            __extends(Value, _super);
            function Value() {
                _super.apply(this, arguments);
                this._isAttribute = false;
                this._isFormula = false;
                this._isLookup = false;
                this._value = [];
            }
            Object.defineProperty(Value.prototype, "isAttribute", {
                get: function () {
                    return this._isAttribute;
                },
                set: function (value) {
                    this._isAttribute = value;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Value.prototype, "isFormula", {
                get: function () {
                    return this._isFormula;
                },
                set: function (value) {
                    this._isFormula = value;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Value.prototype, "isLookup", {
                get: function () {
                    return this._isLookup;
                },
                set: function (value) {
                    this._isLookup = value;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Value.prototype, "formula", {
                get: function () {
                    return this._formula;
                },
                set: function (value) {
                    this._formula = value;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Value.prototype, "parentAttribute", {
                set: function (value) {
                    this._formula.parentAttribute = value;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Value.prototype, "entityName", {
                set: function (value) {
                    this._formula.entityName = value;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Value.prototype, "value", {
                get: function () {
                    return this._value;
                },
                set: function (value) {
                    this._value = value;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Value.prototype, "attributeType", {
                get: function () {
                    return this._attributeType;
                },
                set: function (value) {
                    this._attributeType = value;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Value.prototype, "lookupEntityType", {
                get: function () {
                    return this._lookupEntityType;
                },
                set: function (value) {
                    this._lookupEntityType = value;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(Value.prototype, "lookupLabel", {
                get: function () {
                    return this._lookupLabel;
                },
                set: function (value) {
                    this._lookupLabel = value;
                },
                enumerable: true,
                configurable: true
            });
            Value.prototype.get_formulaExpression = function () {
                if (this.isFormula)
                    return (this._formula.attribute + ' ' + this._formula.operator.toString + ' ' + this._formula.value);
                return "";
            };
            Value.prototype.equals = function (v) {
                if (!(v instanceof Value))
                    return false;
                if (this._isAttribute != v._isAttribute)
                    return false;
                if (this._isFormula != v._isFormula)
                    return false;
                if (this._isLookup != v._isLookup)
                    return false;
                if (this._value.sort().toString() != v._value.sort().toString())
                    return false;
                if (this.hasOwnProperty("_formula") != v.hasOwnProperty("_formula"))
                    return false;
                else if (this.hasOwnProperty("_formula") && !this._formula.equals(v._formula))
                    return false;
                if (this._attributeType != v._attributeType)
                    return false;
                if (this._lookupEntityType != v._lookupEntityType)
                    return false;
                if (this._lookupLabel != v._lookupLabel)
                    return false;
                return true;
            };
            Value.prototype._validateActivity = function () {
                var status = true;
                this._isValid = status;
                if (this._isFormula) {
                    status = this.validateChildren([this._formula]) && status;
                    this.addMultipleErrorMessages(this._formula.getErrorMessages());
                }
                return status;
            };
            return Value;
        })(Validation.ValidModel);
        ProcessDesigner.Value = Value;
        var ConditionExpression = (function (_super) {
            __extends(ConditionExpression, _super);
            function ConditionExpression() {
                _super.apply(this, arguments);
                this._hasConditionExpChanged = false;
                this._validationMessages = {};
            }
            Object.defineProperty(ConditionExpression.prototype, "hasConditionExpChanged", {
                get: function () {
                    return this._hasConditionExpChanged;
                },
                set: function (value) {
                    this._hasConditionExpChanged = value;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(ConditionExpression.prototype, "attribute", {
                get: function () {
                    return this._attribute;
                },
                set: function (value) {
                    this._attribute = value;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(ConditionExpression.prototype, "parentConditionActivity", {
                set: function (value) {
                    this._parentConditionActivity = value;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(ConditionExpression.prototype, "operator", {
                get: function () {
                    return this._operator;
                },
                set: function (value) {
                    this._operator = value;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(ConditionExpression.prototype, "value", {
                get: function () {
                    return this._value;
                },
                set: function (value) {
                    this._value = value;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(ConditionExpression.prototype, "prevStepOperator", {
                get: function () {
                    return this._prevStepOperator;
                },
                set: function (value) {
                    this._prevStepOperator = value;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(ConditionExpression.prototype, "isValid", {
                get: function () {
                    return this._isValid;
                },
                set: function (value) {
                    this._isValid = value;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(ConditionExpression.prototype, "validationMessages", {
                get: function () {
                    return this._validationMessages;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(ConditionExpression.prototype, "attributeType", {
                get: function () {
                    return this._attributeType;
                },
                set: function (value) {
                    this._attributeType = value;
                },
                enumerable: true,
                configurable: true
            });
            ConditionExpression.prototype._validateActivity = function () {
                var status = true;
                var result = null;
                var exp = this.get('_expression');
                var entityLogicalName = this._parentConditionActivity.getEntityName();
                var isUnaryOperator = ProcessDesigner.MetadataProvider.isUnaryOperatorByValue(this.operator);
                if (!isUnaryOperator) {
                    if (!this._value.isFormula) {
                        if (!this.value.isAttribute) {
                            var id = "#value";
                            var attributeType = this._attribute ? MetadataProxy.getAttributeType(this._attribute, entityLogicalName) : ProcessDesigner.AttributeType.Unknown;
                            if (attributeType == ProcessDesigner.AttributeType.Owner || attributeType == ProcessDesigner.AttributeType.Lookup || attributeType == ProcessDesigner.AttributeType.Customer || attributeType == ProcessDesigner.AttributeType.Picklist || attributeType == ProcessDesigner.AttributeType.State || attributeType == ProcessDesigner.AttributeType.Status || attributeType == ProcessDesigner.AttributeType.Boolean) {
                                id = "#valueContainer div:first";
                            }
                            else if (attributeType == ProcessDesigner.AttributeType.DateTime) {
                                id = "#valueContainer";
                            }
                            result = Validation.Engine.validateAttributeValue(entityLogicalName, id, this._value.value, this._attribute, Validation.Level.Change);
                            status = this.addResult(result) && status;
                        }
                        else {
                            var isFromPrevStage_1 = this.isFieldStepFromPreviousStage(this._parentConditionActivity.stepAttributeList);
                            if (isFromPrevStage_1 == false) {
                                result = Validation.Engine.checkLevel("#value", Validation.Level.Change, ProcessDesigner.MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_BPFConditionActivity_BranchCondition"));
                                status = this.addResult(result) && status;
                            }
                        }
                    }
                    else {
                        this._value.parentAttribute = this._attribute;
                        this._value.entityName = this._parentConditionActivity.getEntityName();
                        this._isValid = status;
                        status = this.validateChildren([this._value]) && status;
                        this.addMultipleErrorMessages(this._value.getErrorMessages());
                        var isFormulaAttributeFromPrevStage = this.isFormulaAttributeFromPreviousStage(this._parentConditionActivity.stepAttributeList);
                        if (isFormulaAttributeFromPrevStage == false) {
                            result = Validation.Engine.checkLevel("#formula-attribute", Validation.Level.Change, ProcessDesigner.MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_BPFConditionActivity_BranchCondition"));
                            status = this.addResult(result) && status;
                        }
                        if (!CommonTypes.Types.Object.isNullOrUndefined(this._value.formula) && this._value.formula.isAttribute) {
                            var isFormulaValueFromPrevStage = this.isFormulaValueFromPreviousStage(this._parentConditionActivity.stepAttributeList);
                            if (isFormulaValueFromPrevStage == false) {
                                result = Validation.Engine.checkLevel("#formula-value", Validation.Level.Change, ProcessDesigner.MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_BPFConditionActivity_BranchCondition"));
                                status = this.addResult(result) && status;
                            }
                        }
                    }
                }
                result = Validation.Engine.validateField("#attribute", this._attribute, Validation.Required.apply, Validation.Level.Change, ProcessDesigner.MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_BPFStepActivity_Field"), null);
                status = this.addResult(result) && status;
                var isFromPrevStage = this.isStepFromPreviousStage(this._parentConditionActivity.stepAttributeList);
                if (isFromPrevStage == false) {
                    result = Validation.Engine.checkLevel("#attribute", Validation.Level.Change, ProcessDesigner.MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_BPFConditionActivity_BranchCondition"));
                    status = this.addResult(result) && status;
                }
                return status;
            };
            ConditionExpression.prototype.isStepFromPreviousStage = function (attributeList) {
                var isValid = false;
                for (var i = 0; i < attributeList.length; i++) {
                    if (attributeList[i] == this._attribute.trim()) {
                        isValid = true;
                        break;
                    }
                }
                return isValid;
            };
            ConditionExpression.prototype.isFieldStepFromPreviousStage = function (attributeList) {
                var isValid = false;
                for (var i = 0; i < attributeList.length; i++) {
                    if (this._value.value[0] && attributeList[i] == this._value.value[0].trim()) {
                        isValid = true;
                        break;
                    }
                }
                return isValid;
            };
            ConditionExpression.prototype.isFormulaAttributeFromPreviousStage = function (attributeList) {
                var isValid = true;
                if (this._value.isFormula) {
                    isValid = false;
                    if (!CommonTypes.Types.Object.isNullOrUndefined(this._value.formula)) {
                        for (var i = 0; i < attributeList.length; i++) {
                            if (!CommonTypes.Types.Object.isNullOrUndefined(this._value.formula.attribute) && attributeList[i] == this._value.formula.attribute.trim()) {
                                isValid = true;
                                break;
                            }
                        }
                    }
                }
                return isValid;
            };
            ConditionExpression.prototype.isFormulaValueFromPreviousStage = function (attributeList) {
                var isValid = true;
                if (this._value.isFormula) {
                    if (!CommonTypes.Types.Object.isNullOrUndefined(this._value.formula)) {
                        if (this._value.formula.isAttribute) {
                            isValid = false;
                            for (var i = 0; i < attributeList.length; i++) {
                                if (!CommonTypes.Types.Object.isNullOrUndefined(this._value.formula.value) && attributeList[i] == this._value.formula.value.trim()) {
                                    isValid = true;
                                    break;
                                }
                            }
                        }
                    }
                }
                return isValid;
            };
            ConditionExpression.prototype.clone = function () {
                var self = this;
                var expression = new ConditionExpression();
                expression._attribute = self._attribute;
                expression.operator = self._operator;
                expression.prevStepOperator = self._prevStepOperator;
                expression.isValid = self._isValid;
                expression.validationMessages = self._validationMessages;
                expression.attributeType = self._attributeType;
                expression.parentConditionActivity = self._parentConditionActivity;
                if (!self.isValid) {
                    expression.addMultipleErrorMessages(self.getErrorMessages());
                }
                if (self._value) {
                    expression.value = new Value();
                    expression.value.isAttribute = self._value._isAttribute;
                    expression.value.isFormula = self._value._isFormula;
                    expression.value.isLookup = self._value._isLookup;
                    expression.value.attributeType = self._value._attributeType;
                    expression.value.lookupEntityType = self._value._lookupEntityType;
                    expression.value.lookupLabel = self._value._lookupLabel;
                    if (self._value._isFormula && self._value._formula) {
                        expression.value.formula = new ConditionFormula();
                        expression.value.formula.attribute = self._value._formula._attribute;
                        expression.value.formula.operator = self._value._formula._operator;
                        expression.value.formula.isAttribute = self._value._formula._isAttribute;
                        expression.value.formula.value = self._value._formula._value;
                        expression.value.formula.leftAttributeType = self._value._formula._leftAttributeType;
                        expression.value.formula.rightAttributeType = self._value._formula._rightAttributeType;
                    }
                    else if (self._value._value) {
                        expression.value.value = self._value._value.slice(0);
                    }
                }
                return expression;
            };
            ConditionExpression.prototype.equals = function (ce) {
                if (!(ce instanceof ConditionExpression))
                    return false;
                var attributes = ["_value", "_attribute", "_operator", "_prevStepOperator", "_attributeType"];
                for (var index in attributes) {
                    var attr = attributes[index];
                    if (CommonTypes.Types.Object.isNullOrUndefined(this[attr]) != CommonTypes.Types.Object.isNullOrUndefined(ce[attr]))
                        return false;
                    if (!CommonTypes.Types.Object.isNullOrUndefined(this[attr])) {
                        if (this[attr].equals) {
                            if (!this[attr].equals(ce[attr]))
                                return false;
                        }
                        else {
                            if (this[attr] != ce[attr])
                                return false;
                        }
                    }
                }
                return true;
            };
            return ConditionExpression;
        })(Validation.ValidModel);
        ProcessDesigner.ConditionExpression = ConditionExpression;
        var BPFConditionActivity = (function (_super) {
            __extends(BPFConditionActivity, _super);
            function BPFConditionActivity() {
                _super.call(this);
                this._elseConditionBranchDescription = "";
                this._conditionDescription = "";
                this._setNextStageDescription = "";
                this._elseSetNextStageDescription = "";
                this._parentConditionActivity = null;
                this.displayName = ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_Default_DisplayName_Condition");
                this.addDefaultConditionExpression();
                this.defaults.NextElseBranchActivity = null;
                var self = this;
                _.bindAll(this, 'clone');
                this.clone = _.wrap(this.clone, function (clone) {
                    var cloneObj = clone();
                    BPFConditionActivityClone.extend(this, cloneObj);
                    return cloneObj;
                }).bind(this);
            }
            BPFConditionActivity.prototype.addDefaultConditionExpression = function () {
                this._conditionExpression = [];
                var exp = new ConditionExpression();
                exp.parentConditionActivity = this;
                exp.attribute = 'NEW_EXP';
                exp.value = new Value();
                exp.value.isAttribute = false;
                exp.value.isFormula = false;
                exp.value.isLookup = false;
                exp.value.value = [];
                this._conditionExpression.push(exp);
            };
            Object.defineProperty(BPFConditionActivity.prototype, "parentStageEntityName", {
                get: function () {
                    if (this.getParentStage())
                        return this.getParentStage().entityName;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BPFConditionActivity.prototype, "containsElseBranch", {
                get: function () {
                    return this._containsElseBranch;
                },
                set: function (value) {
                    this._containsElseBranch = value;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BPFConditionActivity.prototype, "conditonExpression", {
                get: function () {
                    return this._conditionExpression;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BPFConditionActivity.prototype, "conditionExpression", {
                set: function (value) {
                    this._conditionExpression = value;
                    if (!this._conditionExpression || this._conditionExpression.length == 0) {
                        this.addDefaultConditionExpression();
                    }
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BPFConditionActivity.prototype, "elseConditionBranchDescription", {
                get: function () {
                    return this._elseConditionBranchDescription;
                },
                set: function (value) {
                    this._elseConditionBranchDescription = value;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BPFConditionActivity.prototype, "conditionDescription", {
                get: function () {
                    return this._conditionDescription;
                },
                set: function (value) {
                    this._conditionDescription = value;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BPFConditionActivity.prototype, "setNextStageDescription", {
                get: function () {
                    return this._setNextStageDescription;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BPFConditionActivity.prototype, "elseSetNextStageDescription", {
                get: function () {
                    return this._elseSetNextStageDescription;
                },
                set: function (value) {
                    this._elseSetNextStageDescription = value;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BPFConditionActivity.prototype, "parentConditionActivity", {
                get: function () {
                    return this._parentConditionActivity;
                },
                set: function (value) {
                    this._parentConditionActivity = value;
                },
                enumerable: true,
                configurable: true
            });
            BPFConditionActivity.prototype.resetConditionExpressions = function () {
                this._conditionExpression = [];
            };
            Object.defineProperty(BPFConditionActivity.prototype, "NextElseBranchActivity", {
                get: function () {
                    return this.defaults.NextElseBranchActivity;
                },
                set: function (activity) {
                    this.defaults.NextElseBranchActivity = activity;
                },
                enumerable: true,
                configurable: true
            });
            BPFConditionActivity.prototype.setParentActivityID = function (value) {
                _super.prototype.setParentActivityID.call(this, value);
                if (this.getParent() != null && this.getParent() instanceof ProcessDesigner.BPFStageActivity && this.getParent().entityName == "") {
                    this.getParent().entityName = this.parentStageEntityName;
                }
                else if (GenericWorkflowDesigner.Settings.workflowTree.getActivities() != null && this.getParent() != null && this.getParent() instanceof ProcessDesigner.BPFStageActivity) {
                    this._parentStageEntityName = this.getParent().entityName;
                }
                else if (GenericWorkflowDesigner.Settings.workflowTree.getActivities() != null && this.getParent() != null && this.getParent() instanceof BPFConditionActivity) {
                    this._parentStageEntityName = this.getParent().parentStageEntityName;
                }
            };
            BPFConditionActivity.prototype.buildConditionExpression = function (conditionExpression) {
                if (conditionExpression == null) {
                    return [];
                }
                var conditionList = [];
                var leftExpression = [];
                var rightExpression = [];
                var isLeafExpression = true;
                if (conditionExpression.left != null && (conditionExpression.left.__class == this.unaryExpressionClass || conditionExpression.left.__class == this.binaryExpressionClass)) {
                    leftExpression = this.buildConditionExpression(conditionExpression.left);
                    isLeafExpression = false;
                }
                if (conditionExpression.right != null && (conditionExpression.right.get_item(0).__class == this.unaryExpressionClass || conditionExpression.right.get_item(0).__class == this.binaryExpressionClass)) {
                    rightExpression = this.buildConditionExpression(conditionExpression.right.get_item(0));
                    isLeafExpression = false;
                    rightExpression[0].prevStepOperator = conditionExpression.conditionOperatoroperator;
                }
                if (isLeafExpression) {
                    var condition = null;
                    if (conditionExpression != null && conditionExpression.__class == this.unaryExpressionClass) {
                        condition = this.buildUnaryExpressionCondition(conditionExpression);
                    }
                    else if (conditionExpression != null && conditionExpression.__class == this.binaryExpressionClass) {
                        condition = this.buildBinaryExpressionCondition(conditionExpression);
                    }
                    if (condition != null) {
                        conditionList.push(condition);
                    }
                }
                else {
                    conditionList = leftExpression.concat(rightExpression);
                }
                return conditionList;
            };
            BPFConditionActivity.prototype.buildUnaryExpressionCondition = function (conditionExpression) {
                var condition = new ConditionExpression();
                condition.operator = conditionExpression.conditionOperatoroperator;
                condition.attribute = conditionExpression.operand.attributeName;
                condition.attributeType = conditionExpression.operand.type;
                condition.value = new Value();
                condition.prevStepOperator = null;
                return condition;
            };
            BPFConditionActivity.prototype.buildBinaryExpressionCondition = function (conditionExpression) {
                var condition = new ConditionExpression();
                condition.operator = conditionExpression.conditionOperatoroperator;
                condition.attribute = conditionExpression.left.attributeName;
                condition.attributeType = conditionExpression.left.type;
                condition.value = new Value();
                var rightStepArray = conditionExpression.right;
                var rightStep = null;
                if (rightStepArray != null && rightStepArray.get_count() > 0 && rightStepArray.get_item(0) != null) {
                    rightStep = rightStepArray.get_item(0);
                    condition.value.isAttribute = (rightStep.__class == this.entityAttributeExpressionClass);
                    condition.value.isFormula = (rightStep.__class == this.methodCallExpressionClass);
                    condition.value.isLookup = (rightStep.__class == this.lookupExpressionClass);
                }
                var valueArray = [];
                if (rightStep != null) {
                    if (condition.value.isAttribute) {
                        valueArray.push(rightStep.attributeName);
                        condition.value.value = valueArray;
                        condition.value.attributeType = rightStep.type;
                    }
                    else if (condition.value.isFormula) {
                        condition.value.formula = this.buildFormula(rightStep);
                    }
                    else {
                        if (condition.value.isLookup) {
                            condition.value.lookupEntityType = rightStep.entityType;
                            condition.value.lookupLabel = rightStep.label;
                            if (rightStep.staticValue != null) {
                                var rightStepvalue = rightStep.staticValue.primitiveValue;
                                var rightStepType = rightStep.staticValue.type;
                            }
                        }
                        else {
                            if (rightStepArray.get_count() == 1) {
                                var rightStepvalue = rightStep.primitiveValue;
                            }
                            else {
                                var rightStepValue = [];
                                for (var i = 0; i < rightStepArray.get_count(); i++) {
                                    rightStepValue.push(rightStepArray.get_item(i).primitiveValue);
                                }
                            }
                            var rightStepType = rightStep.type;
                        }
                        condition.value.attributeType = rightStepType;
                        if (rightStepValue instanceof Array) {
                            valueArray = rightStepValue;
                        }
                        else {
                            valueArray.push(rightStepvalue);
                        }
                    }
                }
                condition.value.value = valueArray;
                condition.prevStepOperator = null;
                return condition;
            };
            BPFConditionActivity.prototype.getFormulaOperator = function (operator) {
                switch (operator) {
                    case 0:
                        return formulaOperator.Add;
                    case 1:
                        return formulaOperator.Substract;
                    case 2:
                        return formulaOperator.Multiply;
                    case 3:
                        return formulaOperator.Divide;
                }
            };
            BPFConditionActivity.prototype.buildFormula = function (formulaStep) {
                var formula = new ConditionFormula();
                if (formulaStep.parameters != null) {
                    var operator = formulaStep.parameters[0];
                    formula.operator = this.getFormulaOperator(operator);
                    if (formulaStep.parameters[1].parameters != null) {
                        formula.attribute = formulaStep.parameters[1].parameters[0].attributeName;
                        formula.leftAttributeType = formulaStep.parameters[1].parameters[0].type;
                    }
                    if (formulaStep.parameters[2].parameters != null) {
                        var parameterRight = formulaStep.parameters[2].parameters[0];
                        formula.isAttribute = (parameterRight.entity != null);
                        formula.rightAttributeType = parameterRight.type;
                        if (formula.isAttribute) {
                            formula.value = parameterRight.attributeName;
                        }
                        else if (parameterRight instanceof Microsoft.Crm.Workflow.Expressions.TimeSpanExpression) {
                            formula.value = parameterRight.value.days;
                        }
                        else {
                            formula.value = parameterRight.primitiveValue;
                        }
                    }
                }
                return formula;
            };
            BPFConditionActivity.prototype.initializeFromProcessStep = function () {
                _super.prototype.initializeFromProcessStep.call(this);
                var step = (this.processStep);
                this.initializeStepParameters(step);
                this.unaryExpressionClass = "UnaryExpression:#Microsoft.Crm.Workflow.Expressions";
                this.binaryExpressionClass = "BinaryExpression:#Microsoft.Crm.Workflow.Expressions";
                this.entityAttributeExpressionClass = "EntityAttributeExpression:#Microsoft.Crm.Workflow.Expressions";
                this.methodCallExpressionClass = "MethodCallExpression:#Microsoft.Crm.Workflow.Expressions";
                this.lookupExpressionClass = "LookupExpression:#Microsoft.Crm.Workflow.Expressions";
                this.conditionExpression = this.buildConditionExpression(step.get_conditionExpression());
            };
            BPFConditionActivity.prototype.initializeStepParameters = function (step) {
                this.displayName = step.get_Description();
                var conditionStep = step.get_parent();
                this.conditionDescription = conditionStep.get_Description();
                this.containsElseBranch = conditionStep.get_containsElseBranch();
                var setNextStageStep = step.get_Steps().get_item(0);
                this.setNextStageDescription = setNextStageStep.get_Description();
            };
            BPFConditionActivity.prototype.initializeElseBranchStepParameters = function (step) {
                if (this.containsElseBranch) {
                    this.elseConditionBranchDescription = step.get_Description();
                    var setNextStageStep = step.get_Steps().get_item(0);
                    this.elseSetNextStageDescription = setNextStageStep.get_Description();
                }
            };
            BPFConditionActivity.prototype.getYesBranches = function () {
                var activityList = this.getChildActivitiesSorted();
                var yesBranchActivities = [];
                $.each(activityList, function (index, activity) {
                    if (activity.attributes.ParentBranchID === branchType.If) {
                        yesBranchActivities.push(activity);
                    }
                });
                if (yesBranchActivities[0] != null) {
                    var currentYesChildActivity = yesBranchActivities[0];
                    while (currentYesChildActivity != null) {
                        currentYesChildActivity.parentConditionActivity = this;
                        yesBranchActivities.push(currentYesChildActivity);
                        var currentYesChildActivities = GenericWorkflowDesigner.Settings.workflowTree.getChildActivities(currentYesChildActivity);
                        if (currentYesChildActivities.length > 0) {
                            currentYesChildActivity = currentYesChildActivities[0];
                        }
                        else {
                            currentYesChildActivity = null;
                        }
                    }
                }
                return yesBranchActivities;
            };
            BPFConditionActivity.prototype.getYesBranchFirstChild = function () {
                var yesBranchChildren = this.getYesBranches();
                var yesBranchFirstChild = null;
                if (yesBranchChildren.length > 0) {
                    yesBranchFirstChild = yesBranchChildren[0];
                }
                return yesBranchFirstChild;
            };
            BPFConditionActivity.prototype.getYesBranchLastChild = function () {
                var yesBranchChildren = this.getYesBranches();
                var yesBranchLastChild = null;
                if (yesBranchChildren.length > 0) {
                    yesBranchLastChild = yesBranchChildren[yesBranchChildren.length - 1];
                }
                return yesBranchLastChild;
            };
            BPFConditionActivity.prototype.getNoBranch = function () {
                var activityList = this.getChildActivitiesSorted();
                var noBranchActivity;
                if (activityList.length == 0) {
                    return null;
                }
                var noIndex = activityList.length - 1;
                noBranchActivity = activityList[noIndex];
                return noBranchActivity;
            };
            BPFConditionActivity.prototype.getNoBranches = function () {
                var activityList = this.getChildActivitiesSorted();
                var noBranchActivities = [];
                $.each(activityList, function (index, activity) {
                    if (activity.attributes.ParentBranchID === branchType.Else) {
                        noBranchActivities.push(activity);
                    }
                });
                if (noBranchActivities[0] != null) {
                    var currentNoChildActivity = noBranchActivities[0];
                    while (currentNoChildActivity != null) {
                        currentNoChildActivity.parentConditionActivity = this;
                        var currentNoChildActivities = GenericWorkflowDesigner.Settings.workflowTree.getChildActivities(currentNoChildActivity);
                        if (currentNoChildActivities.length > 0) {
                            currentNoChildActivity = currentNoChildActivities[0];
                        }
                        else {
                            currentNoChildActivity = null;
                        }
                    }
                }
                return noBranchActivities;
            };
            BPFConditionActivity.prototype.getNoBranchFirstChild = function () {
                var noBranchChildren = this.getNoBranches();
                var noBranchFirstChild = null;
                if (noBranchChildren.length > 0) {
                    noBranchFirstChild = noBranchChildren[0];
                }
                return noBranchFirstChild;
            };
            BPFConditionActivity.prototype.getDefaultBranch = function () {
                var activityList = this.getChildActivitiesSorted();
                var defaultActivity = null;
                $.each(activityList, function (index, activity) {
                    if (activity.attributes.ParentBranchID === branchType.Default) {
                        defaultActivity = activity;
                    }
                });
                return defaultActivity;
            };
            BPFConditionActivity.prototype.getDefaultChildOfParentActivity = function () {
                var defaultActivityOfParentActivity = null;
                var currentParentConditionActivity = this.parentConditionActivity;
                while (currentParentConditionActivity != null) {
                    defaultActivityOfParentActivity = currentParentConditionActivity.getDefaultBranch();
                    if (defaultActivityOfParentActivity == null) {
                        currentParentConditionActivity = currentParentConditionActivity.parentConditionActivity;
                    }
                    else {
                        break;
                    }
                }
                return defaultActivityOfParentActivity;
            };
            BPFConditionActivity.prototype.preparePropertyDetails = function () {
                var self = this;
                var target = {
                    _parentStageEntityName: self.parentStageEntityName,
                    _conditionExpression: self._conditionExpression
                };
                return JSON.stringify(target);
            };
            BPFConditionActivity.prototype.canAddNewBranch = function () {
                var count = 0;
                var currentActivity = this;
                while (currentActivity instanceof BPFConditionActivity) {
                    count++;
                    currentActivity = currentActivity.getParent();
                }
                if (count >= ProcessDesigner.BPFConditionBranchLimits.MaximumAllowedBranchesUnderCondition) {
                    return false;
                }
                else {
                    return true;
                }
            };
            BPFConditionActivity.prototype.generateConditionExpression = function (workflowStep) {
                var conditionExpressionList = [];
                for (var i = 0; i < this._conditionExpression.length; i++) {
                    var condExpr = this._conditionExpression[i];
                    if (condExpr.attribute == "NEW_EXP") {
                        continue;
                    }
                    var isUnaryOperator = ProcessDesigner.MetadataProvider.isUnaryOperatorByValue(condExpr.operator);
                    if (isUnaryOperator && condExpr.operator != null) {
                        var conditionExpression = this.generateUnaryExpression(condExpr, workflowStep);
                        conditionExpressionList.push(conditionExpression);
                    }
                    else if (condExpr.operator != null) {
                        var conditionExpression = this.generateBinaryExpression(condExpr, workflowStep);
                        conditionExpressionList.push(conditionExpression);
                    }
                }
                if (this._conditionExpression.length == 1) {
                    return conditionExpressionList[0];
                }
                else if (this._conditionExpression.length > 1) {
                    var condOperator = this._conditionExpression[1].prevStepOperator.toString();
                    conditionExpressionList.reverse();
                    var childConditionOperatoroperator = condOperator;
                    var childLeft = conditionExpressionList.pop();
                    var childRight = [conditionExpressionList.pop()];
                    var childExpression = new WorkflowExpressions.BinaryExpression(workflowStep, childConditionOperatoroperator, childLeft, childRight);
                    while (conditionExpressionList.length > 0) {
                        var parentConditionOperatoroperator = condOperator;
                        var parentLeft = childExpression;
                        var parentRight = [conditionExpressionList.pop()];
                        var parentExpression = new WorkflowExpressions.BinaryExpression(workflowStep, parentConditionOperatoroperator, parentLeft, parentRight);
                        childExpression = parentExpression;
                    }
                    return childExpression;
                }
                else {
                    return null;
                }
            };
            BPFConditionActivity.prototype.generateBinaryExpression = function (conditionExpression, workflowStep) {
                var conditionOperatoroperator = conditionExpression.operator.toString();
                var left = this.generateConditionExpressionLeftObject(conditionExpression, workflowStep);
                var right = this.generateConditionExpressionRightObject(conditionExpression, workflowStep);
                var binaryExpression = new WorkflowExpressions.BinaryExpression(workflowStep, conditionOperatoroperator, left, right);
                return binaryExpression;
            };
            BPFConditionActivity.prototype.generateUnaryExpression = function (conditionExpression, workflowStep) {
                var conditionOperatoroperator = conditionExpression.operator.toString();
                var operand = this.generateConditionExpressionLeftObject(conditionExpression, workflowStep);
                var unaryExpression = new WorkflowExpressions.UnaryExpression(workflowStep, conditionOperatoroperator, operand);
                return unaryExpression;
            };
            BPFConditionActivity.prototype.generatePrimaryEntity = function (workflowStep) {
                var entity = new WorkflowExpressions.PrimaryEntity(workflowStep);
                entity.set_entityName(this.parentStageEntityName);
                entity.set_parameterName("primaryEntity");
                return entity;
            };
            BPFConditionActivity.prototype.generateConditionExpressionLeftObject = function (condExpr, workflowStep) {
                var attributeType = condExpr.attributeType == undefined ? "0" : condExpr.attributeType.toString();
                var entity = this.generatePrimaryEntity(workflowStep);
                var attributeName = condExpr.attribute;
                var left = new WorkflowExpressions.EntityAttributeExpression(entity, attributeName);
                left.set_type(attributeType);
                return left;
            };
            BPFConditionActivity.prototype.generateConditionExpressionRightObject = function (condExpr, workflowStep) {
                var rightArray = [];
                if (condExpr.value.isAttribute == true) {
                    rightArray = this.generateExpressionRightForAttributeType(condExpr, workflowStep);
                }
                else if (condExpr.value.isFormula == true) {
                    rightArray = this.generateExpressionRightForFormulaType(condExpr, workflowStep);
                }
                else {
                    var primitiveExpressionList = this.generateExpressionRightForValueType(condExpr, workflowStep);
                    if (condExpr.value.isLookup) {
                        var primitiveExpression = primitiveExpressionList.pop();
                        primitiveExpression.set_type(15);
                        var lookupExpression = new WorkflowExpressions.LookupExpression(workflowStep, primitiveExpression, 6, condExpr.value.lookupEntityType, condExpr.value.lookupLabel);
                        rightArray.push(lookupExpression);
                    }
                    else {
                        rightArray = primitiveExpressionList;
                    }
                }
                return rightArray;
            };
            BPFConditionActivity.prototype.generateExpressionRightForValueType = function (condExpr, workflowStep) {
                var rightArray = [];
                var flag = $.isArray(condExpr.value.value);
                if (flag == true) {
                    for (var i = 0; i < condExpr.value.value.length; i++) {
                        var initialType = condExpr.value.attributeType == undefined ? "0" : condExpr.value.attributeType.toString();
                        var primitiveValue = condExpr.value.value[i];
                        var right = new WorkflowExpressions.PrimitiveExpression(workflowStep, primitiveValue, initialType);
                        rightArray.push(right);
                    }
                }
                else {
                    var initialType = condExpr.value.attributeType == undefined ? "0" : condExpr.value.attributeType.toString();
                    var primitiveValue = condExpr.value.value.toString();
                    var right = new WorkflowExpressions.PrimitiveExpression(workflowStep, primitiveValue, initialType);
                    rightArray.push(right);
                }
                return rightArray;
            };
            BPFConditionActivity.prototype.generateExpressionRightForAttributeType = function (condExpr, workflowStep) {
                var rightArray = [];
                for (var i = 0; i < condExpr.value.value.length; i++) {
                    var initialType = condExpr.value.attributeType == undefined ? "0" : condExpr.value.attributeType.toString();
                    var entity = this.generatePrimaryEntity(workflowStep);
                    var attributeName = condExpr.value.value[i];
                    var right = new WorkflowExpressions.EntityAttributeExpression(entity, attributeName);
                    rightArray.push(right);
                }
                return rightArray;
            };
            BPFConditionActivity.prototype.generateExpressionRightForFormulaType = function (condExpr, workflowStep) {
                var rightArray = [];
                var leftMethEntity = this.generatePrimaryEntity(workflowStep);
                var leftMethAttributeName = condExpr.value.formula.attribute;
                var leftMethEnt = new WorkflowExpressions.EntityAttributeExpression(leftMethEntity, leftMethAttributeName);
                leftMethEnt.set_type(condExpr.value.formula.leftAttributeType);
                var leftMethExprParam = [];
                leftMethExprParam.push(leftMethEnt);
                var leftMethCallExpMethod = "0";
                var leftMethCallExpParameters = leftMethExprParam;
                var leftMethExpr = new WorkflowExpressions.MethodCallExpression(workflowStep, leftMethCallExpMethod, leftMethCallExpParameters);
                var rightMethExprParam = [];
                if (condExpr.value.formula.isAttribute == true) {
                    var rightMethEntExprEntity = this.generatePrimaryEntity(workflowStep);
                    var rightMethEntExprAttributeName = condExpr.value.formula.value;
                    var rightMethEntExpr = new WorkflowExpressions.EntityAttributeExpression(rightMethEntExprEntity, rightMethEntExprAttributeName);
                    rightMethEntExpr.set_type(condExpr.value.formula.rightAttributeType);
                    rightMethExprParam.push(rightMethEntExpr);
                }
                else {
                    if (parseInt(condExpr.value.formula.leftAttributeType) == ProcessDesigner.AttributeType.DateTime) {
                        var timeSpan = new Microsoft.Crm.Workflow.CrmTimeSpan(0, 0, parseInt(condExpr.value.formula.value), 0, 0);
                        var rightMethTimeSpanExpr = new Microsoft.Crm.Workflow.Expressions.TimeSpanExpression(workflowStep, timeSpan);
                        rightMethExprParam.push(rightMethTimeSpanExpr);
                    }
                    else {
                        var rightMethPrimExprType = condExpr.value.formula.leftAttributeType == undefined ? "0" : condExpr.value.formula.leftAttributeType.toString();
                        var rightMethPrimExprPrimitiveValue = condExpr.value.formula.value;
                        var rightMethPrimExpr = new WorkflowExpressions.PrimitiveExpression(workflowStep, rightMethPrimExprPrimitiveValue, rightMethPrimExprType);
                        rightMethPrimExpr.set_type(condExpr.value.formula.rightAttributeType);
                        rightMethExprParam.push(rightMethPrimExpr);
                    }
                }
                var rightMethExprMethod = "0";
                var rightMethExprParameters = rightMethExprParam;
                var rightMethExpr = new WorkflowExpressions.MethodCallExpression(workflowStep, rightMethExprMethod, rightMethExprParameters);
                var paramArray = [];
                paramArray.push(parseInt(condExpr.value.formula.operator.toString()));
                paramArray.push(leftMethExpr);
                paramArray.push(rightMethExpr);
                var rightMethod = "3";
                var rightParameters = paramArray;
                var right = new WorkflowExpressions.MethodCallExpression(workflowStep, rightMethod, rightParameters);
                rightArray.push(right);
                return rightArray;
            };
            BPFConditionActivity.groupBranchesByConditionBlock = function (activities) {
                var BPFConditionBranchActivitiesByCondition = {};
                for (var i = 0; i < activities.length; i++) {
                    if (activities[i] instanceof BPFConditionActivity) {
                        var conditionBranchActivity = activities[i];
                        var conditionIfBranchActivityID = null;
                        if (conditionBranchActivity.getParentBranchID() == ProcessDesigner.DefaultBranchIndices.DefaultBranch) {
                            conditionIfBranchActivityID = conditionBranchActivity.getActivityID();
                        }
                        else {
                            var parentConditionActivity = conditionBranchActivity;
                            while (parentConditionActivity.getParentBranchID() != ProcessDesigner.DefaultBranchIndices.DefaultBranch) {
                                parentConditionActivity = parentConditionActivity.getParent();
                            }
                            conditionIfBranchActivityID = parentConditionActivity.getActivityID();
                        }
                        if (BPFConditionBranchActivitiesByCondition[conditionIfBranchActivityID] == null) {
                            BPFConditionBranchActivitiesByCondition[conditionIfBranchActivityID] = [];
                        }
                        BPFConditionBranchActivitiesByCondition[conditionIfBranchActivityID].push(conditionBranchActivity);
                    }
                }
                return BPFConditionBranchActivitiesByCondition;
            };
            BPFConditionActivity.generateJson = function (activities, workflowStep) {
                var BPFConditionBranchActivitiesByCondition = BPFConditionActivity.groupBranchesByConditionBlock(activities);
                for (var ifBranchActivityID in BPFConditionBranchActivitiesByCondition) {
                    var branchActivitiesForConditionStep = BPFConditionBranchActivitiesByCondition[ifBranchActivityID];
                    var conditionStep = BPFConditionActivity.generateConditionStepJson(branchActivitiesForConditionStep, workflowStep);
                    var firstConditionBranchSetNextStageStep = conditionStep.get_Steps().get_item(0).get_Steps().get_item(0);
                    var workflowStepIterator;
                    for (workflowStepIterator = 0; workflowStepIterator < workflowStep.get_Steps().get_Count(); workflowStepIterator++) {
                        if (workflowStep.get_Steps().get_item(workflowStepIterator) instanceof WorkflowObjectModel.EntityStep) {
                            var entityStep = workflowStep.get_Steps().get_item(workflowStepIterator);
                            var stageStep = entityStep.get_Steps().get_item(0);
                            if (stageStep.get_stageId() == firstConditionBranchSetNextStageStep.get_parentStageId()) {
                                stageStep.appendStep(conditionStep);
                                break;
                            }
                        }
                    }
                }
                return workflowStep;
            };
            BPFConditionActivity.generateConditionStepJson = function (branchActivitiesForConditionStep, workflowStep) {
                var ifBranchActivity = null;
                branchActivitiesForConditionStep.forEach(function (conditionBranchActivity) {
                    if (conditionBranchActivity.getParentBranchID() == ProcessDesigner.DefaultBranchIndices.DefaultBranch) {
                        ifBranchActivity = conditionBranchActivity;
                    }
                });
                var activities = GenericWorkflowDesigner.Settings.workflowTree.getActivities();
                var parentStageActivity = null;
                activities.forEach(function (activity) {
                    if (activity instanceof ProcessDesigner.BPFStageActivity) {
                        if (activity.getActivityID() == ifBranchActivity.getParentActivityID()) {
                            parentStageActivity = activity;
                        }
                    }
                });
                var conditionStep = new WorkflowObjectModel.ConditionStep(workflowStep);
                conditionStep.set_Description(ifBranchActivity.conditionDescription);
                conditionStep.set_workflow(workflowStep);
                var elseBranchFirstStageActivity = null;
                var elseConditionBranchStep = null;
                branchActivitiesForConditionStep.forEach(function (conditionBranchActivity) {
                    var conditionBranchStep = BPFConditionActivity.generateConditionBranchStepJson(conditionBranchActivity, parentStageActivity, conditionStep, workflowStep, false);
                    conditionStep.appendStep(conditionBranchStep);
                    if (elseConditionBranchStep == null) {
                        activities.forEach(function (activity) {
                            if (elseBranchFirstStageActivity == null && activity instanceof ProcessDesigner.BPFStageActivity) {
                                if (activity.getParentActivityID() == conditionBranchActivity.getActivityID() && (activity.getParentBranchID() == ProcessDesigner.DefaultBranchIndices.NoBranch)) {
                                    elseBranchFirstStageActivity = activity;
                                }
                            }
                        });
                        if (elseBranchFirstStageActivity != null) {
                            elseConditionBranchStep = BPFConditionActivity.generateConditionBranchStepJson(conditionBranchActivity, parentStageActivity, conditionStep, workflowStep, true);
                            conditionStep.appendStep(elseConditionBranchStep);
                            if (!conditionStep.get_containsElseBranch()) {
                                conditionStep.set_containsElseBranch(true);
                            }
                        }
                    }
                });
                return conditionStep;
            };
            BPFConditionActivity.generateConditionBranchStepJson = function (conditionBranchActivity, parentStageActivity, conditionStep, workflowStep, isElseBranch) {
                var conditionExpression = null;
                if (!isElseBranch) {
                    conditionExpression = conditionBranchActivity.generateConditionExpression(workflowStep);
                }
                var conditionBranchStep = new WorkflowObjectModel.ConditionBranchStep(conditionStep, conditionExpression);
                if (!isElseBranch) {
                    conditionBranchStep.set_Description(conditionBranchActivity.displayName);
                }
                else {
                    conditionBranchStep.set_Description(conditionBranchActivity.elseConditionBranchDescription);
                }
                conditionBranchStep.set_workflow(workflowStep);
                var setNextStageStep = BPFConditionActivity.generateSetNextStageStepJson(conditionBranchActivity, parentStageActivity, workflowStep, isElseBranch);
                conditionBranchStep.appendStep(setNextStageStep);
                return conditionBranchStep;
            };
            BPFConditionActivity.generateSetNextStageStepJson = function (conditionBranchActivity, parentStageActivity, workflowStep, isElseBranch) {
                var setNextStageStep = new WorkflowObjectModel.SetNextStageStep(workflowStep);
                setNextStageStep.set_workflow(workflowStep);
                if (!isElseBranch) {
                    setNextStageStep.set_Description(conditionBranchActivity.setNextStageDescription);
                }
                else {
                    setNextStageStep.set_Description(conditionBranchActivity.elseSetNextStageDescription);
                }
                setNextStageStep.set_parentStageId(parentStageActivity.stageId);
                var nextStageId = "";
                var activities = GenericWorkflowDesigner.Settings.workflowTree.getActivities();
                activities.forEach(function (activity) {
                    if (activity instanceof ProcessDesigner.BPFStageActivity) {
                        var stageActivity = activity;
                        if (stageActivity.getParentActivityID() == conditionBranchActivity.getActivityID()) {
                            if ((!isElseBranch && conditionBranchActivity.getParentBranchID() == ProcessDesigner.DefaultBranchIndices.DefaultBranch && stageActivity.getParentBranchID() == ProcessDesigner.DefaultBranchIndices.YesBranch) ||
                                (!isElseBranch && conditionBranchActivity.getParentBranchID() == ProcessDesigner.DefaultBranchIndices.NoBranch && stageActivity.getParentBranchID() == ProcessDesigner.DefaultBranchIndices.YesBranch) ||
                                (isElseBranch && stageActivity.getParentBranchID() == ProcessDesigner.DefaultBranchIndices.NoBranch)) {
                                nextStageId = stageActivity.stageId;
                            }
                        }
                    }
                });
                setNextStageStep.set_stageId(nextStageId);
                return setNextStageStep;
            };
            BPFConditionActivity.overrideWorkflowObjectModelMethods = function () {
                WorkflowObjectModel.ConditionBranchStep.prototype.get_conditionBranchDisplayMode = function () {
                    if (this.get_parent().get_Steps().indexOf(this) == 0) {
                        return WorkflowObjectModel.ConditionBranchDisplayMode.IF;
                    }
                    else if ((this.get_parent().get_containsElseBranch() && this.get_parent().get_Steps().indexOf(this) < this.get_parent().get_Steps().get_Count() - 1) ||
                        (!this.get_parent().get_containsElseBranch())) {
                        return WorkflowObjectModel.ConditionBranchDisplayMode.elseIf;
                    }
                    else {
                        return WorkflowObjectModel.ConditionBranchDisplayMode.ELSE;
                    }
                };
                WorkflowObjectModel.ConditionStep.prototype.appendStep = function (newStep) {
                    if (!(newStep instanceof WorkflowObjectModel.ConditionBranchStep)) {
                        return;
                    }
                    WorkflowObjectModel.CompositeStepBase.prototype.appendStep.call(this, newStep);
                };
                WorkflowObjectModel.ConditionBranchStep.prototype.set_parent = function (parentStep) {
                    if (!(parentStep instanceof WorkflowObjectModel.ConditionStep)) {
                        return;
                    }
                    WorkflowObjectModel.StepBase.prototype.set_parent.call(this, parentStep);
                };
            };
            BPFConditionActivity.prototype.getStepAttributeList = function (parent) {
                var stepAttributes = [];
                for (var i = 0; i < parent.steps.length; i++) {
                    if (parent.steps[i].attributeName != "" && parent.steps[i].attributeName != null && parent.steps[i].attributeName != undefined) {
                        stepAttributes.push(parent.steps[i].attributeName);
                    }
                }
                return stepAttributes;
            };
            Object.defineProperty(BPFConditionActivity.prototype, "stepAttributeList", {
                get: function () {
                    var parentStage = this.getParentStage();
                    return this.getStepAttributeList(parentStage);
                },
                enumerable: true,
                configurable: true
            });
            BPFConditionActivity.prototype.getEntityName = function () {
                return this.getParentStage().entityName;
            };
            BPFConditionActivity.prototype._getErrorCount = function () {
                return this.errCount + this.getChildrenErrorCount(this._conditionExpression);
            };
            BPFConditionActivity.prototype._validateActivity = function () {
                var status = true;
                var result = null;
                var parent = this.getParentStage();
                var condExprns = this._conditionExpression;
                if (condExprns.length == 0) {
                    result = Validation.Engine.checkLevel("#conditionExpression .err1", Validation.Level.Validate, ProcessDesigner.MetadataProvider.getLocalizedString("ProcessDesignerControl_PBL_CondtionExpression_NotEmpty"));
                    status = this.addResult(result) && status;
                }
                if (this.getParentBranchID() == 0) {
                    if (this.parentStageEntityName != parent.entityName) {
                        result = Validation.Engine.checkLevel("#attribute", Validation.Level.Change, ProcessDesigner.MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_BPFStepActivity_Field"));
                        status = this.addResult(result) && status;
                    }
                }
                var hasTrailingStage = false;
                for (var i = 0; i < GenericWorkflowDesigner.Settings.workflowTree.getActivities().length; i++) {
                    var activity = GenericWorkflowDesigner.Settings.workflowTree.getActivities()[i];
                    if (activity instanceof ProcessDesigner.BPFStageActivity && activity.getParentActivityID() == this.getActivityID() && activity.getParentBranchID() == ProcessDesigner.DefaultBranchIndices.YesBranch) {
                        hasTrailingStage = true;
                        break;
                    }
                }
                if (!hasTrailingStage) {
                    result = Validation.Engine.checkLevel("#conditionExpression .err1", Validation.Level.Validate, ProcessDesigner.MetadataProvider.getLocalizedString("Error_Message_0x80060399"));
                    status = status && this.addResult(result);
                    if (!Validation.Engine.isAllowedLevel(Validation.Level.Validate)) {
                        var newStage = GenericWorkflowDesigner.Settings.activityDefinitionFactory.createActivity(ProcessDesigner.BPFActivityType.stage);
                        var addedActivityComponent = new GenericWorkflowDesigner.ConnectedComponent(newStage);
                        var deferred = $.Deferred();
                        GenericWorkflowDesigner.Settings.workflowTree.insertActivityComponentAfter(this, addedActivityComponent).done(function (insertedActivity) {
                            insertedActivity.saveActivityWithSubsequentActivities().done(function (activity) {
                                deferred.resolveWith(activity, [activity]);
                                GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.canvasRefresh);
                            });
                        });
                    }
                }
                var stepAttributes = this.getStepAttributeList(parent);
                var self = this;
                for (var i = 0; i < condExprns.length; i++) {
                    condExprns[i].parentConditionActivity = self;
                    condExprns[i].showNotifications = false;
                    if (condExprns[i].attribute != 'NEW_EXP' || Validation.Engine.getAction() >= Validation.Level.Validate) {
                        var tempStatus = condExprns[i].validateActivity();
                        status = tempStatus && status;
                    }
                }
                return status;
            };
            BPFConditionActivity.prototype.validateOnAction = function (action) {
                var isValid = _super.prototype.validateOnAction.call(this, action);
                if (!isValid && (action == Validation.Level.Apply || action == Validation.Level.Change)) {
                    if (this.getErrorCount() == 1 &&
                        !CommonTypes.Types.Object.isNullOrUndefined(this.getErrorMessages()["#conditionExpression .err1"]) &&
                        this.getErrorMessages()["#conditionExpression .err1"] == ProcessDesigner.MetadataProvider.getLocalizedString("Error_Message_0x80060399")) {
                        isValid = true;
                    }
                }
                return isValid;
            };
            BPFConditionActivity.prototype.clearErrorMessages = function () {
                _super.prototype.clearErrorMessages.call(this);
                for (var i = 0; i < this._conditionExpression.length; i++) {
                    var tempStatus = this._conditionExpression[i].clearErrorMessages();
                    this._conditionExpression[i].isValid = true;
                }
            };
            BPFConditionActivity.prototype.getCloneOfActivity = function () {
                var newConditionActivity = new BPFConditionActivity();
                newConditionActivity.displayName = this.displayName;
                newConditionActivity._parentStageEntityName = this.parentStageEntityName;
                newConditionActivity.conditionDescription = this.conditionDescription;
                newConditionActivity.unaryExpressionClass = this.unaryExpressionClass;
                newConditionActivity.binaryExpressionClass = this.binaryExpressionClass;
                newConditionActivity.entityAttributeExpressionClass = this.entityAttributeExpressionClass;
                newConditionActivity.methodCallExpressionClass = this.methodCallExpressionClass;
                newConditionActivity.lookupExpressionClass = this.lookupExpressionClass;
                var newConditionExpressions = [];
                var self = this;
                jQuery.each(this._conditionExpression, function (index, expression) {
                    var newExpression = this.clone();
                    newConditionExpressions.push(newExpression);
                });
                newConditionActivity.conditionExpression = newConditionExpressions;
                return newConditionActivity;
            };
            BPFConditionActivity.prototype.getAllowedDependentActivityTypes = function (slotType) {
                switch (slotType) {
                    case GenericWorkflowDesigner.SlotType.InsertHorizontal:
                        return [ProcessDesigner.BPFActivityType.stage];
                    case GenericWorkflowDesigner.SlotType.InsertVertical:
                        var child = this.getChildActivitiesSorted();
                        var conditionPush = 1;
                        for (var i = 0; i < child.length; i++) {
                            if (child[i] && child[i].getActivityTypeID() == "condition" && child[i].getParentBranchID() == 2) {
                                conditionPush = 0;
                            }
                        }
                        if (conditionPush) {
                            return [ProcessDesigner.BPFActivityType.stage, ProcessDesigner.BPFActivityType.condition];
                        }
                        else {
                            return [ProcessDesigner.BPFActivityType.stage];
                        }
                    case GenericWorkflowDesigner.SlotType.TileHolder:
                        return [];
                    default:
                        return _super.prototype.getAllowedDependentActivityTypes.call(this, slotType);
                }
                ;
            };
            BPFConditionActivity.prototype.needsSubsequentActivitiesGeneration = function () {
                var needsGeneration = true;
                var childActivities = this.getChildActivitiesSorted();
                if (childActivities.length > 0 && childActivities[0].getParentBranchID() == ProcessDesigner.DefaultBranchIndices.DefaultBranch) {
                    needsGeneration = false;
                    this.NextElseBranchActivity = null;
                }
                return needsGeneration;
            };
            return BPFConditionActivity;
        })(ProcessDesigner.ConditionActivity);
        ProcessDesigner.BPFConditionActivity = BPFConditionActivity;
        var BPFConditionActivityClone = (function (_super) {
            __extends(BPFConditionActivityClone, _super);
            function BPFConditionActivityClone(clonedFrom_) {
                _super.call(this);
                this._errorCountCB = null;
                this.clonedFrom = clonedFrom_;
            }
            BPFConditionActivityClone.prototype.getParent = function () {
                return this.clonedFrom.getParent();
            };
            BPFConditionActivityClone.prototype.getErrorCount = function () {
                if (this._errorCountCB) {
                    return this._errorCountCB();
                }
                else {
                    return this.clonedFrom.getErrorCount();
                }
            };
            BPFConditionActivityClone.extend = function (clonedFrom_, clonedTo_) {
                var clonedFrom = clonedFrom_;
                var clonedTo = clonedTo_;
                var getParent = clonedFrom.getParent;
                clonedTo.getParent = _.wrap(clonedTo.getParent, function (getParent) {
                    return clonedFrom.getParent();
                }).bind(clonedTo);
                var getErrorCount = clonedFrom.getErrorCount;
                clonedTo.getErrorCount = _.wrap(clonedTo.getErrorCount, function (getErrorCount) {
                    if (clonedTo['_errorCountCB']) {
                        return clonedTo['_errorCountCB']();
                    }
                    else {
                        return clonedFrom.getErrorCount();
                    }
                }).bind(clonedTo);
            };
            return BPFConditionActivityClone;
        })(BPFConditionActivity);
        ProcessDesigner.BPFConditionActivityClone = BPFConditionActivityClone;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        'use strict';
        var BPFRootActivity = (function (_super) {
            __extends(BPFRootActivity, _super);
            function BPFRootActivity() {
                _super.call(this, ProcessDesigner.BPFActivityType.root);
            }
            BPFRootActivity.prototype.initialize = function (properties) {
                _super.prototype.initialize.call(this, properties);
                this.setActivityTypeID(ProcessDesigner.BPFActivityType.root);
                this.addNewItem(ProcessDesigner.BPFActivityType.root);
            };
            BPFRootActivity.prototype.initializeFromProcessStep = function () {
                _super.prototype.initializeFromProcessStep.call(this);
            };
            return BPFRootActivity;
        })(ProcessDesigner.ProcessActivityDefinitionModel);
        ProcessDesigner.BPFRootActivity = BPFRootActivity;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
//  <copyright file="BPFStageActivity.ts" company="Microsoft">
//  Copyright (c) Microsoft Corporation.  All rights reserved.
//  </copyright>
// 
//  <summary>
//  Represent the stage activity of the business process
//  </summary>
/// <reference path="../../common/bpfactivitytype.ts" />
/// <reference path="../../../process/common/processactivitytype.ts" />
/// <reference path="../../../process/model/processactivitydefinitionmodel.ts" />
/// <reference path="ibpfstageactivity.ts" />
/// <reference path="../../common/bpfjsonobjects.ts" />
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        'use strict';
        var Utility = _Microsoft.Client.Telemetry.Utility;
        var WorkflowObjectModel = Microsoft.Crm.Workflow.ObjectModel;
        var BPFStageActivity = (function (_super) {
            __extends(BPFStageActivity, _super);
            function BPFStageActivity() {
                _super.call(this, ProcessDesigner.BPFActivityType.stage);
                this.stageId = null;
                this.nextStageId = null;
                this.stageCategory = null;
                this.steps = [];
                this.workflows = [];
                this.count = 0;
                this.relationshipData = [];
                this._entityName = "";
                this._relationshipName = "";
                this._relationShipAttributeName = "";
                this._description = "";
                this._category = "-1";
                this._parentConditionActivity = null;
                this.displayName = ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_BPFStageActivity_StageName");
                this.stageId = Utility.newGuid();
                this.save();
                this.addDefaultStep();
            }
            BPFStageActivity.prototype.initialize = function (properties) {
                _super.prototype.initialize.call(this, properties);
                this.setActivityTypeID(ProcessDesigner.BPFActivityType.stage);
                this.addNewItem(ProcessDesigner.BPFActivityType.stage);
            };
            BPFStageActivity.prototype.clearStepsAndWorkflows = function () {
                this.workflows = [];
                this.steps = [];
                this.addDefaultStep();
            };
            BPFStageActivity.prototype.addDefaultStep = function () {
                var newStepActivity = new ProcessDesigner.BPFStepActivity();
                newStepActivity.parentStage = this;
                newStepActivity.setParentActivityID(this.getActivityID());
                this.steps.push(newStepActivity);
            };
            Object.defineProperty(BPFStageActivity.prototype, "entityName", {
                get: function () {
                    return this._entityName;
                },
                set: function (value) {
                    this._entityName = value;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BPFStageActivity.prototype, "relationShipAttributeName", {
                get: function () {
                    return this._relationShipAttributeName;
                },
                set: function (value) {
                    this._relationShipAttributeName = value;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BPFStageActivity.prototype, "relationshipName", {
                get: function () {
                    return this._relationshipName;
                },
                set: function (value) {
                    this._relationshipName = value;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BPFStageActivity.prototype, "description", {
                get: function () {
                    return this._description;
                },
                set: function (value) {
                    this._description = value;
                },
                enumerable: true,
                configurable: true
            });
            BPFStageActivity.prototype.isNewStage = function () {
                return (this.steps.length == 1 && (this.steps[0].attributeName == null || this.steps[0].attributeName == "") &&
                    CommonTypes.Types.Object.isNullOrUndefined(this.steps[0].processId) && this.workflows.length == 0);
            };
            BPFStageActivity.prototype.setValidationMode = function (validationMode) {
                for (var i = 0; i < this.steps.length; i++) {
                    this.steps[i].setValidationMode(validationMode);
                }
            };
            Object.defineProperty(BPFStageActivity.prototype, "category", {
                get: function () {
                    var categories = ProcessDesigner.ProcessDesignerControl.dataBag.resources.getStageCategoryMetadata();
                    var returnCategory = "-1";
                    var self = this;
                    categories.forEach(function (category) {
                        if (String(category.Value) == self._category)
                            returnCategory = String(category.Value);
                    });
                    return returnCategory;
                },
                set: function (value) {
                    this._category = value;
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BPFStageActivity.prototype, "parentConditionActivity", {
                get: function () {
                    return this._parentConditionActivity;
                },
                set: function (value) {
                    this._parentConditionActivity = value;
                },
                enumerable: true,
                configurable: true
            });
            BPFStageActivity.prototype.setNewSteps = function (NewSteps) {
                this.steps = NewSteps;
            };
            BPFStageActivity.prototype.setNewWorkflows = function (NewWorkflows) {
                this.workflows = NewWorkflows;
            };
            BPFStageActivity.prototype.initializeFromProcessStep = function () {
                _super.prototype.initializeFromProcessStep.call(this);
                if (this.steps.length == 1) {
                    this.steps.pop();
                }
                var step = (this.processStep);
                var workflow = step.get_workflow();
                this.entityName = workflow.get_primaryEntityName();
                this.displayName = step.get_stepLabels().get_item(0).get_description();
                this.category = step.get_stageCategory();
                if (CommonTypes.Types.Object.isNullOrUndefined(this.category)) {
                    this.category = "-1";
                }
                this.count = step.get_Steps().get_Count();
            };
            BPFStageActivity.prototype.preparePropertyDetails = function () {
                var target = {
                    _entityName: this.entityName,
                    _category: this.category,
                    _description: this.description,
                    count: this.count,
                    _relationshipName: this.relationshipName,
                    _relationShipAttributeName: this.relationShipAttributeName
                };
                return JSON.stringify(target);
            };
            BPFStageActivity.prototype.getStepLabel = function () {
                var stepLabel = new WorkflowObjectModel.StepLabel();
                stepLabel.set_description(this.displayName);
                stepLabel.set_labelId(this.stageId);
                stepLabel.set_languageCode(window._Process_CurrentLCID);
                return stepLabel;
            };
            BPFStageActivity.prototype.canAddNewNestedBranch = function () {
                var count = 0;
                var currentActivity = this;
                while (currentActivity.getParent() != null) {
                    if (currentActivity instanceof ProcessDesigner.BPFConditionActivity && currentActivity.getParent() instanceof BPFStageActivity) {
                        count++;
                    }
                    currentActivity = currentActivity.getParent();
                }
                if (count >= ProcessDesigner.BPFConditionBranchLimits.MaximumAllowedNestedBranches) {
                    return false;
                }
                else {
                    return true;
                }
            };
            BPFStageActivity.prototype.tryGetOuterBranchConditionActivity = function (activities, conditionActivity) {
                while (conditionActivity.getParent() != null && !(conditionActivity instanceof ProcessDesigner.BPFConditionActivity)) {
                    if (conditionActivity instanceof BPFStageActivity &&
                        conditionActivity.getParent() instanceof ProcessDesigner.BPFConditionActivity &&
                        conditionActivity.getParentBranchID() == ProcessDesigner.DefaultBranchIndices.DefaultBranch) {
                        break;
                    }
                    conditionActivity = conditionActivity.getParent();
                }
                return conditionActivity;
            };
            BPFStageActivity.prototype.computeConditionBlockNextStageId = function (activities, conditionActivity) {
                var computedNextStageId = null, conditionIfBranchActivityId = null;
                if (conditionActivity instanceof ProcessDesigner.BPFConditionActivity) {
                    conditionIfBranchActivityId = conditionActivity.getActivityID();
                    for (var i = 0; i < activities.length; i++) {
                        if (activities[i].getParentActivityID() == conditionIfBranchActivityId &&
                            activities[i] instanceof BPFStageActivity &&
                            activities[i].getParentBranchID() == ProcessDesigner.DefaultBranchIndices.DefaultBranch) {
                            computedNextStageId = activities[i].stageId;
                            break;
                        }
                    }
                }
                if (computedNextStageId == null) {
                    conditionActivity = this.tryGetOuterBranchConditionActivity(activities, conditionActivity.getParent());
                    if (conditionActivity instanceof ProcessDesigner.BPFConditionActivity) {
                        return this.computeConditionBlockNextStageId(activities, conditionActivity);
                    }
                }
                return computedNextStageId;
            };
            BPFStageActivity.prototype.computeNextStageId = function (activities) {
                var computedNextStageId = null;
                for (var i = 0; i < activities.length; i++) {
                    if (activities[i].getParentActivityID() == this.getActivityID()) {
                        if (activities[i] instanceof BPFStageActivity) {
                            computedNextStageId = activities[i].stageId;
                        }
                        else {
                            computedNextStageId = this.computeConditionBlockNextStageId(activities, activities[i]);
                        }
                        break;
                    }
                }
                if (computedNextStageId == null) {
                    var conditionActivity = this.tryGetOuterBranchConditionActivity(activities, this);
                    if (conditionActivity instanceof ProcessDesigner.BPFConditionActivity) {
                        computedNextStageId = this.computeConditionBlockNextStageId(activities, conditionActivity);
                    }
                }
                return computedNextStageId;
            };
            BPFStageActivity.prototype.generateStageStepJson = function (activities, workflowStep) {
                var stageStep = new WorkflowObjectModel.StageStep(workflowStep, this.displayName);
                stageStep.set_stageId(this.stageId);
                var computedNextStageId = this.computeNextStageId(activities);
                stageStep.set_nextStageId(computedNextStageId);
                stageStep.set_stageCategory(this.category);
                stageStep.set_workflow(workflowStep);
                stageStep.addLabel(this.getStepLabel());
                for (var i = 0; i < this.steps.length; i++) {
                    var stepObj = this.steps[i].generateStepStepJson(workflowStep);
                    stageStep.appendStep(stepObj);
                }
                for (var i = 0; i < this.workflows.length; i++) {
                    var actionStepObj = this.workflows[i].generateActionStepJson(workflowStep);
                    stageStep.appendStep(actionStepObj);
                }
                if (this.getParentStage() == null) {
                    for (var i = 0; i < MscrmControls.ProcessDesigner.ControlManager.globalWorkflowObject.workflows.length; i++) {
                        var actionStepObj = MscrmControls.ProcessDesigner.ControlManager.globalWorkflowObject.workflows[i].generateActionStepJson(workflowStep);
                        stageStep.appendStep(actionStepObj);
                    }
                }
                return stageStep;
            };
            BPFStageActivity.prototype.generateEntityStepJson = function (activities, workflowStep) {
                var entityStep = new WorkflowObjectModel.EntityStep(workflowStep, workflowStep.get_primaryEntityName());
                entityStep.set_workflow(workflowStep);
                entityStep.appendStep(this.generateStageStepJson(activities, workflowStep));
                if (this.entityName != null && this.entityName != "") {
                    entityStep.set_Description(this.entityName);
                }
                return entityStep;
            };
            BPFStageActivity.generateJson = function (activities, workflowStep) {
                var BPFStageActivities = GenericWorkflowDesigner.Settings.workflowTree.getStageActivitiesOrdered();
                var entityStepId = workflowStep.get_nextStepIndex();
                for (var i = 0; i < BPFStageActivities.length; i++) {
                    var entityStep = BPFStageActivities[i].generateEntityStepJson(activities, workflowStep);
                    entityStep.setNameAndId(entityStepId + "");
                    entityStepId++;
                    workflowStep.appendStep(entityStep);
                }
                return workflowStep;
            };
            BPFStageActivity.prototype.validateProperties = function () {
                var status = true;
                var result = null;
                result = ProcessDesigner.Validation.Engine.validateField("#entityName", this._entityName, ProcessDesigner.Validation.Required.apply, ProcessDesigner.Validation.Level.Change, ProcessDesigner.MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_BPFStepActivity_Field"), null);
                status = this.addResult(result) && status;
                result = ProcessDesigner.Validation.Engine.validateField("#stageName", this.displayName, ProcessDesigner.Validation.Required.apply, ProcessDesigner.Validation.Level.Change, ProcessDesigner.MetadataProvider.getLocalizedString("ProcessDesignerControl_PBL_NonEmptyValueMessage"), null);
                status = this.addResult(result) && status;
                return status;
            };
            BPFStageActivity.prototype._validateActivity = function () {
                var status = true;
                var result = null;
                status = this.validateProperties() && status;
                if (ProcessDesigner.Validation.Engine.isAllowedLevel(ProcessDesigner.Validation.Level.Save)) {
                    status = this.validateChildren(this.steps) && status;
                    for (var i = 0; i < this.steps.length; i++) {
                        var child = this.steps[i];
                        var step = this.steps[i];
                        if (step.getErrorCount() > 0) {
                            $("#" + step.stepId).find(".subViewTileError").css("visibility", "visible");
                        }
                        else {
                            $("#" + step.stepId).find(".subViewTileError").css("visibility", "hidden");
                            GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.updateTileTitle);
                        }
                    }
                    status = this.validateChildren(this.workflows) && status;
                    for (var i = 0; i < this.workflows.length; i++) {
                        var child = this.workflows[i];
                        var workflow = this.workflows[i];
                        if (workflow.getErrorCount() > 0) {
                            $("#" + workflow.actionStepId).find(".subViewTileError").css("visibility", "visible");
                        }
                        else {
                            $("#" + workflow.actionStepId).find(".subViewTileError").css("visibility", "hidden");
                        }
                    }
                }
                return status;
            };
            BPFStageActivity.prototype._validateDependentOptionSetActivity = function () {
                var status = this.validateProperties();
                if (ProcessDesigner.Validation.Engine.isAllowedLevel(ProcessDesigner.Validation.Level.Save)) {
                    status = this.validateDependentOptionSetChildren(this.steps) && status;
                    for (var i = 0; i < this.steps.length; i++) {
                        var child = this.steps[i];
                        var step = this.steps[i];
                        if (step.getErrorCount() > 0) {
                            $("#" + step.stepId).find(".subViewTileError").css("visibility", "visible");
                        }
                        else {
                            $("#" + step.stepId).find(".subViewTileError").css("visibility", "hidden");
                            GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.updateTileTitle);
                        }
                    }
                }
                return status;
            };
            BPFStageActivity.prototype.clearErrorMessages = function () {
                _super.prototype.clearErrorMessages.call(this);
                for (var i = 0; i < this.steps.length; i++) {
                    var tempStatus = this.steps[i].clearErrorMessages();
                }
                for (var i = 0; i < this.workflows.length; i++) {
                    var tempStatus = this.workflows[i].clearErrorMessages();
                }
            };
            BPFStageActivity.prototype._getErrorCount = function () {
                return this.errCount + this._getSubViewsErrorCount();
            };
            BPFStageActivity.prototype._getSubViewsErrorCount = function () {
                return this.getChildrenErrorCount(this.steps) + this.getChildrenErrorCount(this.workflows);
                ;
            };
            BPFStageActivity.prototype.getAllowedDependentActivitiesForConnector = function (currentActivity) {
                if (currentActivity.getParent() == null)
                    return false;
                else {
                    var parentActivity = currentActivity.getParent();
                    if (parentActivity != null) {
                        if (currentActivity instanceof BPFStageActivity && parentActivity instanceof ProcessDesigner.BPFConditionActivity && currentActivity.getParentBranchID() != ProcessDesigner.DefaultBranchIndices.DefaultBranch) {
                            return true;
                        }
                        else {
                            return this.getAllowedDependentActivitiesForConnector(parentActivity);
                        }
                    }
                }
            };
            BPFStageActivity.prototype.getAllowedDependentActivityTypes = function (slotType) {
                switch (slotType) {
                    case GenericWorkflowDesigner.SlotType.InsertHorizontal:
                        var child = this.getChildActivitiesSorted();
                        var push = true;
                        for (var i = 0; i < child.length; i++) {
                            if (child[i] && child[i].getActivityTypeID() == "condition") {
                                push = false;
                            }
                        }
                        if (push) {
                            return [ProcessDesigner.BPFActivityType.stage, ProcessDesigner.BPFActivityType.condition];
                        }
                        else {
                            return [ProcessDesigner.BPFActivityType.stage];
                        }
                    case GenericWorkflowDesigner.SlotType.InsertVertical:
                        return [ProcessDesigner.BPFActivityType.stage, ProcessDesigner.BPFActivityType.condition];
                    case GenericWorkflowDesigner.SlotType.TileHolder:
                        return [ProcessDesigner.BPFActivityType.step, ProcessDesigner.BPFActivityType.workflow, ProcessDesigner.BPFActivityType.flow];
                    default:
                        return _super.prototype.getAllowedDependentActivityTypes.call(this, slotType);
                }
            };
            BPFStageActivity.prototype.getStepSequence = function (stepId) {
                for (var i = 0; i < this.steps.length; i++) {
                    if (this.steps[i].stepId === stepId) {
                        return i + 1;
                    }
                }
                return -1;
            };
            BPFStageActivity.prototype.getCloneOfActivity = function () {
                var newActivity = new BPFStageActivity();
                newActivity.description = this.description;
                newActivity.displayName = this.displayName;
                newActivity.category = this.category;
                newActivity.entityName = this.entityName;
                newActivity.setWorkflowID(this.getWorkflowID());
                newActivity.setParentBranchID(this.getParentBranchID());
                var properties = this.getDefaultProperties();
                properties.Items = this.getProperties().Items;
                newActivity.set("Properties", properties);
                if (newActivity.steps.length == 1) {
                    newActivity.steps.pop();
                }
                jQuery.each(this.steps, function (index, stepActivity) {
                    var newStepActivity = stepActivity.getCloneOfActivity();
                    newStepActivity.parentStage = newActivity;
                    newStepActivity.setParentActivityID(newActivity.getActivityID());
                    newActivity.steps.push(newStepActivity);
                });
                jQuery.each(this.workflows, function (index, workflowActivity) {
                    var newWorkflowActivity = workflowActivity.getCloneOfActivity();
                    newWorkflowActivity.parentStage = newActivity;
                    newWorkflowActivity.setParentActivityID(newActivity.getActivityID());
                    newWorkflowActivity.updateStageId(newActivity.stageId);
                    newActivity.workflows.push(newWorkflowActivity);
                });
                return newActivity;
            };
            BPFStageActivity.prototype.getPropertyPageClone = function () {
                var newActivity = new BPFStageActivity();
                newActivity.description = this.description;
                newActivity.displayName = this.displayName;
                newActivity.category = this.category;
                newActivity.entityName = this.entityName;
                var properties = this.getDefaultProperties();
                properties.Items = this.getProperties().Items;
                newActivity.set("Properties", properties);
                if (newActivity.steps.length == 1) {
                    newActivity.steps.pop();
                }
                return newActivity;
            };
            BPFStageActivity.prototype.needsSubsequentActivitiesGeneration = function () {
                var needsGeneration = false;
                var childActivities = this.getChildActivitiesSorted();
                if (childActivities.length == 0 || (!CommonTypes.Types.Object.isNullOrUndefined(this.getNextActivityID()) && this.getNextActivityID() != childActivities[0].getActivityID())) {
                    needsGeneration = true;
                }
                return needsGeneration;
            };
            return BPFStageActivity;
        })(ProcessDesigner.ProcessActivityDefinitionModel);
        ProcessDesigner.BPFStageActivity = BPFStageActivity;
        var StageCategoryMetadata = (function () {
            function StageCategoryMetadata() {
            }
            return StageCategoryMetadata;
        })();
        ProcessDesigner.StageCategoryMetadata = StageCategoryMetadata;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
//  <copyright file="BPFActionStepActivity.ts" company="Microsoft">
//         Copyright (c) Microsoft Corporation.  All rights reserved.
//  </copyright>
// 
//  <summary>
//  Represent the step activity of the business process
//  </summary>
/// <reference path="../../common/bpfactivitytype.ts" />
/// <reference path="../../../process/common/processactivitytype.ts" />
/// <reference path="../../../process/model/processactivitydefinitionmodel.ts" />
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        'use strict';
        var Utility = _Microsoft.Client.Telemetry.Utility;
        var WorkflowObjectModel = Microsoft.Crm.Workflow.ObjectModel;
        var WorkflowExpressions = Microsoft.Crm.Workflow.Expressions;
        var BPFActionStepActivity = (function (_super) {
            __extends(BPFActionStepActivity, _super);
            function BPFActionStepActivity() {
                _super.call(this, ProcessDesigner.BPFActivityType.action);
                this._processId = '00000000-0000-0000-0000-000000000000';
                this._uniqueName = "";
                this._workflowName = "";
                this._inputArguments = [];
                this._outputArguments = [];
                this._attributeName = "";
                this._defaultStepName = ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_BPFStepActivity_StepName");
                this._description = this.defaultStepName;
            }
            Object.defineProperty(BPFActionStepActivity.prototype, "parentStage", {
                get: function () {
                    return this._parentStage;
                },
                set: function (value) {
                    if (this._parentStage !== value) {
                        this._parentStage = value;
                    }
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BPFActionStepActivity.prototype, "assignVariableStep", {
                get: function () {
                    return this._assignVariableStep;
                },
                set: function (value) {
                    if (this._assignVariableStep !== value) {
                        this._assignVariableStep = value;
                    }
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BPFActionStepActivity.prototype, "isNewlyAdded", {
                get: function () {
                    return this._isNewlyAdded;
                },
                set: function (value) {
                    if (this._isNewlyAdded !== value) {
                        this._isNewlyAdded = value;
                    }
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BPFActionStepActivity.prototype, "sequence", {
                get: function () {
                    return this._sequence;
                },
                set: function (value) {
                    if (this._sequence !== value) {
                        this._sequence = value;
                    }
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BPFActionStepActivity.prototype, "stepId", {
                get: function () {
                    return this._stepId;
                },
                set: function (value) {
                    if (this._stepId !== value) {
                        this._stepId = value;
                    }
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BPFActionStepActivity.prototype, "description", {
                get: function () {
                    return this._description;
                },
                set: function (value) {
                    if (this._description !== value) {
                        this._description = value;
                    }
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BPFActionStepActivity.prototype, "processId", {
                get: function () {
                    return this._processId;
                },
                set: function (value) {
                    if (this._processId !== value) {
                        this._processId = value;
                    }
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BPFActionStepActivity.prototype, "uniqueName", {
                get: function () {
                    return this._uniqueName;
                },
                set: function (value) {
                    if (this._uniqueName !== value) {
                        this._uniqueName = value;
                    }
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BPFActionStepActivity.prototype, "workflowName", {
                get: function () {
                    return this._workflowName;
                },
                set: function (value) {
                    if (this._workflowName !== value) {
                        this._workflowName = value;
                    }
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BPFActionStepActivity.prototype, "actionType", {
                get: function () {
                    return this._actionType;
                },
                set: function (value) {
                    if (this._actionType !== value) {
                        this._actionType = value;
                    }
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BPFActionStepActivity.prototype, "InputArguments", {
                get: function () {
                    return this._inputArguments;
                },
                set: function (value) {
                    if (this._inputArguments !== value) {
                        this._inputArguments = value;
                    }
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BPFActionStepActivity.prototype, "OutputArguments", {
                get: function () {
                    return this._outputArguments;
                },
                set: function (value) {
                    if (this._outputArguments !== value) {
                        this._outputArguments = value;
                    }
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BPFActionStepActivity.prototype, "attributeName", {
                get: function () {
                    return this._attributeName;
                },
                set: function (value) {
                    if (this._attributeName !== value) {
                        this._attributeName = value;
                    }
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BPFActionStepActivity.prototype, "defaultStepName", {
                get: function () {
                    return this._defaultStepName;
                },
                set: function (value) {
                    if (this._defaultStepName !== value) {
                        this._defaultStepName = value;
                    }
                },
                enumerable: true,
                configurable: true
            });
            BPFActionStepActivity.prototype.getLookupItems = function () {
                return this._lookupItems;
            };
            BPFActionStepActivity.prototype.setLookupItems = function (lookupItems) {
                this._lookupItems = lookupItems;
            };
            BPFActionStepActivity.prototype.getLookupContext = function () {
                if (CommonTypes.Types.Object.isNullOrUndefined(this._lookupContext)) {
                    var entitySetName = "workflows";
                    var filter = this.parentStage.entityName;
                    var numberOfRecords = 10;
                    var attributes = ["name", "mode"];
                    var lookupContext = new ProcessDesigner.LookupContext(entitySetName, attributes, numberOfRecords, filter, this.lookupMoreRecords, this.lookupSuccessCallback, null, this, BPFActionStepActivity.postLookupItemSelection, ProcessDesigner.BPFActivityType.action);
                    this._lookupContext = lookupContext;
                }
                return this._lookupContext;
            };
            BPFActionStepActivity.getValueHash = function (value) {
                var valuesHash = new MscrmControls.ProcessDesigner.Dictionary();
                if (CommonTypes.Types.Object.isNullOrUndefined(value))
                    return valuesHash;
                var valueJson = JSON.parse(value);
                for (var i = 0; i < valueJson.length; i++) {
                    var key = valueJson[i].name;
                    var resultValue = valueJson[i].value;
                    valuesHash[key] = resultValue;
                }
                return valuesHash;
            };
            BPFActionStepActivity.setModelWorkflow = function (callback) {
                var currentLookupItem;
                if (GenericWorkflowDesigner.currentModel instanceof BPFActionStepActivity) {
                    var currentASModel = GenericWorkflowDesigner.currentModel;
                    currentLookupItem = new GenericWorkflowDesigner.LookupItem(currentASModel.processId, currentASModel.uniqueName, window["Xrm"].Page.context.getClientUrl() + "/sfa/workflow/edit.aspx?id=" + currentASModel.processId, ProcessDesigner.BPFWorkflowSymbol.symbol);
                }
                if (GenericWorkflowDesigner.currentModel instanceof ProcessDesigner.BPFFlowStepActivity) {
                    var currentFSModel = GenericWorkflowDesigner.currentModel;
                    currentLookupItem = new GenericWorkflowDesigner.LookupItem(currentFSModel.workflowId, currentFSModel.uniqueName, ProcessDesigner.BPFFlowStepActivity.getFlowUrl(currentFSModel.workflowId), ProcessDesigner.BPFWorkflowSymbol.symbol);
                }
                else
                    currentLookupItem = null;
                callback(currentLookupItem);
            };
            BPFActionStepActivity.isSelectedWorkflowEntityDifferent = function (entityName) {
                if (GenericWorkflowDesigner.currentModel instanceof BPFActionStepActivity) {
                    var currentModel = GenericWorkflowDesigner.currentModel;
                    var stageEntityName = currentModel.parentStage.entityName;
                    stageEntityName = Xrm.Internal.getEntityDisplayName(stageEntityName);
                    return stageEntityName != entityName;
                }
                return false;
            };
            BPFActionStepActivity.getCurrentEntityName = function () {
                if (GenericWorkflowDesigner.currentModel instanceof BPFActionStepActivity) {
                    var currentModel = GenericWorkflowDesigner.currentModel;
                    var stageEntityName = currentModel.parentStage.entityName;
                    stageEntityName = Xrm.Internal.getEntityDisplayName(stageEntityName);
                    return stageEntityName;
                }
            };
            BPFActionStepActivity.prototype.lookupMoreRecords = function (callback, callbackContext) {
                var processControl = window["ProcessControl"];
                var showNewBtn = window["_Process_IsSMBSalesApp"] ? false : true;
                var workflowDialog = processControl.Configuration.BPFClientProxy.launchWorkflowLookupDialog(BPFActionStepActivity.lookupMoreRecordsViewId, function (dialogParams, callbackParams) {
                    var lookupControlItems = dialogParams["items"];
                    if (lookupControlItems.length > 0) {
                        var workflowId = lookupControlItems[0].id;
                        var valueHash = {};
                        valueHash = BPFActionStepActivity.getValueHash(lookupControlItems[0].values);
                        var entityName = valueHash["primaryentity"];
                        var category = ProcessDesigner.ProcessType[valueHash["category"]];
                        if (BPFActionStepActivity.isSelectedWorkflowEntityDifferent(entityName)) {
                            BPFActionStepActivity.showErrorOrWarningDialog(ProcessDesigner.BPFDialogMessageTypes.Warning, ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_ErrorTitle"), window['String'].format(ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_ActionStepPropertyDetails_Entity_ErrorMessage"), BPFActionStepActivity.getCurrentEntityName()));
                        }
                        else {
                            var processId = workflowId;
                            if (workflowId.lastIndexOf("{", 0) === 0 && workflowId.lastIndexOf("}", workflowId.length) === workflowId.length - 1) {
                                processId = workflowId.substring(1, workflowId.length - 1);
                            }
                            ProcessDesigner.MetadataProvider.validateProcessForUI(processId, function (result) {
                                if (!CommonTypes.Types.Object.isNullOrUndefined(result)) {
                                    if (result.ValidationSuccess == true) {
                                        if (!CommonTypes.Types.Object.isNullOrUndefined(valueHash["mode"]))
                                            BPFActionStepActivity.actionRecords[workflowId] = parseInt(valueHash["mode"]);
                                        var selectedWorkflowName = lookupControlItems[0].name;
                                        var url = window["Xrm"].Page.context.getClientUrl() + "/sfa/workflow/edit.aspx?id=" + workflowId;
                                        $("#WorkflowTxtLookup").val(selectedWorkflowName);
                                        $('#displayName').text(selectedWorkflowName);
                                        var processType = valueHash["category"] == ProcessDesigner.ProcessType.Action ? ProcessDesigner.MetadataProvider.getLocalizedString('ProcessDesignerControl_BPF_ActionStepPropertyDetails_ProcessType_Action') : ProcessDesigner.MetadataProvider.getLocalizedString('ProcessDesignerControl_BPF_ActionStepPropertyDetails_ProcessType_Workflow');
                                        $("#workflowTypeTextbox").val(processType);
                                        var lookupItem = new GenericWorkflowDesigner.LookupItem(workflowId, selectedWorkflowName, url, ProcessDesigner.BPFWorkflowSymbol.symbol, category);
                                        callback(lookupItem);
                                        BPFActionStepActivity.postLookupItemSelection();
                                    }
                                    else {
                                        BPFActionStepActivity.showProcessUIValidationFailure(result);
                                    }
                                }
                            }, BPFActionStepActivity.showErrorOrWarningDialog);
                        }
                    }
                    else {
                        BPFActionStepActivity.setModelWorkflow(callback);
                    }
                    if (!CommonTypes.Types.Object.isNullOrUndefined(workflowDialog))
                        workflowDialog.close();
                }, showNewBtn);
            };
            BPFActionStepActivity.showProcessUIValidationFailure = function (result) {
                var errorMessage = "";
                for (var iCnt = 0; iCnt < result.ValidationIssueList.length; iCnt++) {
                    errorMessage += "\n" + ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString(ProcessDesigner.ValidationErrorCodes.ValidationErrorCodesMappings[result.ValidationIssueList[iCnt].CRMErrorCode]);
                }
                BPFActionStepActivity.showErrorOrWarningDialog(ProcessDesigner.BPFDialogMessageTypes.Error, ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_ErrorTitle"), errorMessage);
            };
            BPFActionStepActivity.showErrorOrWarningDialog = function (messageType, title, message) {
                if (messageType === void 0) { messageType = ProcessDesigner.BPFDialogMessageTypes.Error; }
                var dialogDetails = {
                    dialogTitle: ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_ErrorTitle"),
                    dialogMessage: ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_WorkFlowProcess_Entity_ErrorMessage"),
                    messageType: messageType,
                    width: 200,
                    height: 400
                };
                GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.showDialog, dialogDetails);
            };
            BPFActionStepActivity.postLookupItemSelection = function () {
                if (window.hasOwnProperty('lookupDialogCloseCallback')) {
                    window['lookupDialogCloseCallback'].call();
                }
            };
            BPFActionStepActivity.prototype.isGlobalWorkflow = function () {
                return false;
            };
            BPFActionStepActivity.prototype.initialize = function (properties) {
                _super.prototype.initialize.call(this, properties);
                this.stepId = Utility.newGuid();
                this.setActivityTypeID(ProcessDesigner.BPFActivityType.action);
            };
            BPFActionStepActivity.prototype.lookupSuccessCallback = function (actionRecords, callbackContext) {
                var lookupItems = BPFActionStepActivity.convertActionRecordsIntoLookupItems(actionRecords);
                callbackContext.setLookupItems(lookupItems);
                return lookupItems;
            };
            BPFActionStepActivity.convertActionRecordsIntoLookupItems = function (actionRecords) {
                var lookupItems = [];
                if (!CommonTypes.Types.Object.isNullOrUndefined(actionRecords) && actionRecords.length > 0) {
                    jQuery.each(actionRecords, function (index, workflowRecord) {
                        var id = workflowRecord.workflowid;
                        var name = workflowRecord.name;
                        var mode = workflowRecord.mode;
                        var url = window["Xrm"].Page.context.getClientUrl() + "/sfa/workflow/edit.aspx?id=" + workflowRecord.workflowid;
                        var category = workflowRecord.category;
                        var lookupItem = new GenericWorkflowDesigner.LookupItem(id, name, url, ProcessDesigner.BPFWorkflowSymbol.symbol, category);
                        lookupItems.push(lookupItem);
                        BPFActionStepActivity.actionRecords[id] = mode;
                    });
                }
                return lookupItems;
            };
            BPFActionStepActivity.prototype.InitializeFromProcessStep = function () {
                _super.prototype.initializeFromProcessStep.call(this);
            };
            BPFActionStepActivity.prototype.preparePropertyDetails = function () {
                var target = {
                    _attributeName: this.attributeName,
                    _description: this.description,
                    _defaultStepName: this.defaultStepName
                };
                return JSON.stringify(target);
            };
            BPFActionStepActivity.prototype.getStepLabel = function () {
                var stepLabel = new WorkflowObjectModel.StepLabel();
                stepLabel.set_description(this.description);
                stepLabel.set_labelId(this.stepId);
                stepLabel.set_languageCode(window._Process_CurrentLCID);
                return stepLabel;
            };
            BPFActionStepActivity.prototype.generateActionControlStepJson = function (workflowStep) {
                var controlStep = new WorkflowObjectModel.ControlStep(workflowStep);
                controlStep.set_workflow(workflowStep);
                controlStep.set_Description("");
                controlStep.set_isUnbound(true);
                controlStep.set_classId("00ad73da-bd4d-49c6-88a8-2f4f4cad4a20");
                controlStep.set_controlId(this.uniqueName + "_" + controlStep.get_Name());
                controlStep.set_dataFieldName("");
                controlStep.set_controlDisplayName(this.description);
                controlStep.set_controlType("0");
                controlStep.set_parameters("");
                return controlStep;
            };
            BPFActionStepActivity.prototype.generateAssignVariableStepJson = function (argument, workflowStep) {
                var assignVariable = new WorkflowObjectModel.AssignVariableStep(workflowStep);
                assignVariable.set_variableName(argument.ArgumentName);
                assignVariable.set_Name(argument.ArgumentName);
                assignVariable.set_dataType(argument.ArgumentType);
                assignVariable.set_direction(argument.ArgumentDirection);
                assignVariable.set_valueExpression(this.generateAttributeExpression(argument, workflowStep));
                return assignVariable;
            };
            BPFActionStepActivity.prototype.generateActionStepJson = function (workflowStep) {
                var actionStep = new WorkflowObjectModel.ActionStep(workflowStep);
                actionStep.set_workflow(workflowStep);
                actionStep.set_Description(this.defaultStepName);
                actionStep.set_actionId(this.stepId);
                actionStep.set_actionType(this.actionType);
                actionStep.set_processId(this.processId);
                if (this.actionType == 2 || this.actionType == 3) {
                    this.uniqueName = "";
                }
                actionStep.set_uniqueName(this.uniqueName);
                actionStep.set_actionControl(this.generateActionControlStepJson(workflowStep));
                for (var cnt = 0; cnt < this.InputArguments.length; cnt++) {
                    if (!CommonTypes.Types.Object.isNullOrUndefined(this.InputArguments[cnt].ArgumentAttributeName) && this.InputArguments[cnt].ArgumentAttributeName != "") {
                        actionStep.appendStep(this.generateAssignVariableStepJson(this.InputArguments[cnt], workflowStep));
                    }
                }
                for (var cnt = 0; cnt < this.OutputArguments.length; cnt++) {
                    if (!CommonTypes.Types.Object.isNullOrUndefined(this.OutputArguments[cnt].ArgumentAttributeName) && this.OutputArguments[cnt].ArgumentAttributeName != "") {
                        actionStep.appendStep(this.generateAssignVariableStepJson(this.OutputArguments[cnt], workflowStep));
                    }
                }
                return actionStep;
            };
            BPFActionStepActivity.prototype.generateStepStepJson = function (workflowStep) {
                var stepStep = new WorkflowObjectModel.StepStep(workflowStep, this.defaultStepName);
                stepStep.set_workflow(workflowStep);
                stepStep.set_Description(this.workflowName);
                stepStep.set_isHidden(false);
                stepStep.set_stepStepId(this.stepId);
                stepStep.addLabel(this.getStepLabel());
                stepStep.appendStep(this.generateActionStepJson(workflowStep));
                return stepStep;
            };
            BPFActionStepActivity.prototype._validateActivity = function () {
                var status = true;
                var result = null;
                status = this.validateProperties() && status;
                return status;
            };
            BPFActionStepActivity.prototype.validateProperties = function () {
                var status = true;
                var result = null;
                result = ProcessDesigner.Validation.Engine.validateField("#displayNameTextbox", this.description, ProcessDesigner.Validation.Required.apply, ProcessDesigner.Validation.Level.Change, ProcessDesigner.MetadataProvider.getLocalizedString("ProcessDesignerControl_PBL_NonEmptyValueMessage"), null);
                status = this.addResult(result) && status;
                result = ProcessDesigner.Validation.Engine.validateField("#lookupControl", this.actionType, ProcessDesigner.Validation.Verify.min, ProcessDesigner.Validation.Level.Change, ProcessDesigner.MetadataProvider.getLocalizedString("ProcessDesignerControl_PBL_NonEmptyValueMessage"), 0);
                status = this.addResult(result) && status;
                if (!CommonTypes.Types.Object.isNullOrUndefined(this.uniqueName) && this.processId != '00000000-0000-0000-0000-000000000000') {
                    var res = this.validateProcess(this.processId.toString());
                    if (!CommonTypes.Types.Object.isNullOrUndefined(res)) {
                        status = this.addResult(res) && status;
                    }
                }
                return status;
            };
            BPFActionStepActivity.prototype.getErrorTile = function () {
                return this.parentStage;
            };
            BPFActionStepActivity.prototype.getCanvasTile = function () {
                return this;
            };
            BPFActionStepActivity.prototype.getAllowedDependentActivityTypes = function (slotType) {
                return [];
            };
            BPFActionStepActivity.prototype.getCloneOfActivity = function () {
                var newActivity = new BPFActionStepActivity();
                newActivity.setWorkflowID(this.getWorkflowID());
                newActivity.attributeName = this.attributeName;
                newActivity.defaultStepName = this.defaultStepName;
                newActivity.description = this.description;
                newActivity.parentStage = this.parentStage;
                newActivity.processId = this.processId;
                newActivity.uniqueName = this.uniqueName;
                newActivity.actionType = this.actionType;
                newActivity.InputArguments = this.InputArguments;
                newActivity.OutputArguments = this.OutputArguments;
                newActivity.workflowName = this.workflowName;
                newActivity.setParentActivityID(this.getParentActivityID());
                return newActivity;
            };
            BPFActionStepActivity.prototype.getPropertyPageClone = function () {
                var newActivity = new BPFActionStepActivity();
                newActivity.attributeName = this.attributeName;
                newActivity.defaultStepName = this.defaultStepName;
                newActivity.description = this.description;
                newActivity.parentStage = this.parentStage;
                newActivity.processId = this.processId;
                newActivity.uniqueName = this.uniqueName;
                newActivity.actionType = this.actionType;
                newActivity.InputArguments = this.InputArguments;
                newActivity.OutputArguments = this.OutputArguments;
                newActivity.workflowName = this.workflowName;
                return newActivity;
            };
            BPFActionStepActivity.prototype.generatePrimaryEntity = function (workflowStep) {
                var entity = new WorkflowExpressions.PrimaryEntity(workflowStep);
                entity.set_entityName(this.getParentStage().entityName);
                entity.set_parameterName("primaryEntity");
                return entity;
            };
            BPFActionStepActivity.prototype.generateAttributeExpression = function (actionArgument, workflowStep) {
                var entity = this.generatePrimaryEntity(workflowStep);
                var attributeName = actionArgument.ArgumentAttributeName;
                var left = new WorkflowExpressions.EntityAttributeExpression(entity, attributeName);
                left.set_type(actionArgument.ArgumentType);
                return left;
            };
            BPFActionStepActivity.getProcessArguments = function (stageEntity, processId, successCallback, errorCallback) {
                var columns = ["sdkmessageid"];
                var deferred = $.Deferred();
                var childPromises = [];
                var that = this;
                var wInstance = ProcessDesigner.WindowUtility.GetParentWindow();
                wInstance["Xrm"].Internal.messages.retrieve(Mscrm.InternalUtilities.EntityNames.Workflow, processId, columns).then(function (retrieveResponse) {
                    if (!Mscrm.InternalUtilities.JSTypes.isNull(retrieveResponse)) {
                        var responseEntity = retrieveResponse.entity;
                        var processArguments = [];
                        if (!Mscrm.InternalUtilities.JSTypes.isNull(responseEntity)) {
                            var sdkmessageid = responseEntity.getValue("sdkmessageid").Id.toString();
                            columns = ["name"];
                            var sdkRequestMessageFieldFetchXMLModified = that.sdkRequestMessageFieldFetchXML.replace("{0}", sdkmessageid);
                            var inArgPromise = wInstance["Xrm"].Internal.messages.retrieveMultiple(sdkRequestMessageFieldFetchXMLModified);
                            childPromises.push(inArgPromise);
                            var sdkResponseMessageFieldFetchXmlModified = that.sdkResponseMessageFieldFetchXml.replace("{0}", sdkmessageid);
                            var outArgPromise = wInstance["Xrm"].Internal.messages.retrieveMultiple(sdkResponseMessageFieldFetchXmlModified);
                            childPromises.push(outArgPromise);
                            $.when.apply(self, childPromises)
                                .then(function (inputArguments, outputArguments) {
                                var requestEntities = inputArguments.entityCollection.get_entities();
                                var responseEntities = outputArguments.entityCollection.get_entities();
                                if (!Mscrm.InternalUtilities.JSTypes.isNull(requestEntities)) {
                                    for (var i = 0; i < requestEntities.length; i++) {
                                        if (!CommonTypes.Types.Object.isNullOrUndefined(requestEntities[i].fields["clrparser"])) {
                                            if (!CommonTypes.Types.Object.isNullOrUndefined(requestEntities[i].fields["name"]) && requestEntities[i].fields["name"].toString().toLowerCase() != "target" &&
                                                requestEntities[i].fields["name"].toString().toLowerCase() != "businessprocessflowid" && requestEntities[i].fields["name"].toString().toLowerCase() != "businessprocessflowinstanceid" &&
                                                requestEntities[i].fields["name"].toString().toLowerCase() != "actionstepid") {
                                                var inputArgumentModel = new MscrmControls.ProcessDesigner.ActionArgument();
                                                inputArgumentModel.ArgumentName = requestEntities[i].fields["name"];
                                                inputArgumentModel.ArgumentType = MscrmControls.ProcessDesigner.ArgumentType[requestEntities[i].fields["clrparser"].split(",")[0]];
                                                inputArgumentModel.ArgumentDirection = MscrmControls.ProcessDesigner.ArgumentDirection.Input;
                                                MscrmControls.ProcessDesigner.MetadataProxy.getAttributeListByDataType(stageEntity, inputArgumentModel.ArgumentType).then(function (d) {
                                                    inputArgumentModel.AttributeList = d;
                                                });
                                                processArguments.push(inputArgumentModel);
                                            }
                                        }
                                    }
                                }
                                if (!Mscrm.InternalUtilities.JSTypes.isNull(responseEntities)) {
                                    for (var i = 0; i < responseEntities.length; i++) {
                                        var outputArgumentModel = new MscrmControls.ProcessDesigner.ActionArgument();
                                        outputArgumentModel.ArgumentName = responseEntities[i].fields["name"];
                                        outputArgumentModel.ArgumentType = MscrmControls.ProcessDesigner.ArgumentType[responseEntities[i].fields["clrformatter"].split(",")[0]];
                                        outputArgumentModel.ArgumentDirection = MscrmControls.ProcessDesigner.ArgumentDirection.Output;
                                        outputArgumentModel.AttributeList = [];
                                        if (outputArgumentModel.ArgumentType == ProcessDesigner.ArgumentType["Microsoft.Xrm.Sdk.EntityReference"]) {
                                            for (var iCntr = 0; iCntr < ProcessDesigner.MetadataProxy.LookupAttributeTypes.length; iCntr++) {
                                                MscrmControls.ProcessDesigner.MetadataProxy.getAttributeListByDataType(stageEntity, ProcessDesigner.MetadataProxy.LookupAttributeTypes[iCntr]).then(function (d) {
                                                    if (!CommonTypes.Types.Object.isNullOrUndefined(d)) {
                                                        outputArgumentModel.AttributeList = outputArgumentModel.AttributeList.concat(d);
                                                    }
                                                });
                                            }
                                        }
                                        else {
                                            MscrmControls.ProcessDesigner.MetadataProxy.getAttributeListByDataType(stageEntity, outputArgumentModel.ArgumentType).then(function (d) {
                                                outputArgumentModel.AttributeList = d;
                                            });
                                        }
                                        processArguments.push(outputArgumentModel);
                                    }
                                }
                                successCallback(processArguments);
                            }, Mscrm.InternalUtilities.ClientApiUtility.actionFailedCallback);
                        }
                    }
                }, Mscrm.InternalUtilities.ClientApiUtility.actionFailedCallback);
                return deferred.promise();
            };
            BPFActionStepActivity.prototype.validateProcess = function (processId) {
                var that = this;
                var validationResult;
                if (processId.lastIndexOf("{", 0) === 0 && processId.lastIndexOf("}", processId.length) === processId.length - 1) {
                    processId = processId.substring(1, processId.length - 1);
                }
                ProcessDesigner.MetadataProvider.validateProcessForUI(processId, function (response) {
                    if (!CommonTypes.Types.Object.isNullOrUndefined(response)) {
                        var res;
                        if (response.ValidationSuccess == false) {
                            var errorMessage = "";
                            for (var iCnt = 0; iCnt < response.ValidationIssueList.length; iCnt++) {
                                errorMessage += "\n" + ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString(ProcessDesigner.ValidationErrorCodes.ValidationErrorCodesMappings[response.ValidationIssueList[iCnt].CRMErrorCode]);
                            }
                            validationResult = ProcessDesigner.Validation.Engine.checkLevel("#lookupControl", ProcessDesigner.Validation.Level.Change, errorMessage);
                        }
                    }
                }, function () {
                    validationResult = ProcessDesigner.Validation.Engine.checkLevel("#lookupControl", ProcessDesigner.Validation.Level.Change, ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_WorkFlowProcess_Entity_ErrorMessage"));
                }, false);
                return validationResult;
            };
            BPFActionStepActivity.lookupMoreRecordsViewId = "73E26387-D7EF-4DE1-B4BF-0894056FF9B8";
            BPFActionStepActivity.actionRecords = [];
            BPFActionStepActivity.BPFProcessActionType = 0;
            BPFActionStepActivity.sdkRequestMessageFieldFetchXML = "<fetch mapping='logical'> \
											<entity name='sdkmessagerequestfield'> \
												<attribute name='name'/> \
												<attribute name='clrparser'/> \
												<link-entity name='sdkmessagerequest' \
														from='sdkmessagerequestid' \
									   					to='sdkmessagerequestid'> \
													<link-entity name='sdkmessagepair' \
									   						from='sdkmessagepairid' \
									   						to='sdkmessagepairid'> \
														<filter type='and'> \
															<condition \
																attribute='sdkmessageid' \
																operator='eq' \
																value='{0}'/> \
															<condition \
																attribute='endpoint' \
																operator='eq' \
																value='api/data'/> \
										  				</filter> \
							   						</link-entity> \
							  					</link-entity> \
											</entity> \
										   </fetch> ";
            BPFActionStepActivity.sdkResponseMessageFieldFetchXml = "<fetch mapping='logical'> \
											<entity name='sdkmessageresponsefield'> \
												<attribute name='name'/> \
												<attribute name='clrformatter'/> \
												<link-entity name='sdkmessageresponse' \
														from='sdkmessageresponseid' \
														to='sdkmessageresponseid'> \
													<link-entity name='sdkmessagerequest' \
									   						from='sdkmessagerequestid' \
									   						to='sdkmessagerequestid'> \
														<link-entity name='sdkmessagepair' \
									   							from='sdkmessagepairid' \
									   							to='sdkmessagepairid'> \
															<filter type='and'> \
																<condition \
																	attribute='sdkmessageid' \
																	operator='eq' \
																	value='{0}'/>\
																<condition \
																	attribute='endpoint' \
																	operator='eq' \
																	value='api/data'/> \
										  					</filter> \
							   							</link-entity> \
							  						</link-entity> \
							 					</link-entity> \
											</entity> \
										   </fetch> ";
            return BPFActionStepActivity;
        })(ProcessDesigner.ProcessActivityDefinitionModel);
        ProcessDesigner.BPFActionStepActivity = BPFActionStepActivity;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// -----------------------------------------------------------------------
// <copyright file="BPFActivityDropController.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        'use strict';
        var BPFActivityDropController = (function (_super) {
            __extends(BPFActivityDropController, _super);
            function BPFActivityDropController(slot) {
                _super.call(this, slot);
                this.slot = slot;
            }
            BPFActivityDropController.prototype.dropLibraryElement = function (libraryElement) {
                var dropHandler;
                var activity = GenericWorkflowDesigner.Settings.activityDefinitionFactory.createActivity(libraryElement.get("ActivityTypeID"));
                var component = new GenericWorkflowDesigner.ConnectedComponent(activity);
                dropHandler = GenericWorkflowDesigner.Settings.slotHandlerProvider.createDropHandler(this.slot);
                return dropHandler.drop(component);
            };
            BPFActivityDropController.prototype.ConnectButtonEventListner = function (slotList) {
                var AcceptableTiles;
                $(document).on('ConnectButton', function (event, droppable) {
                    alert("something clicked");
                });
            };
            return BPFActivityDropController;
        })(GenericWorkflowDesigner.ActivityDropController);
        ProcessDesigner.BPFActivityDropController = BPFActivityDropController;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
//---------------------------------------------------------------------------------------------
// <copyright file="BPFActivityDropHandlerFactory.ts" company="Microsoft">
//		Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
//
// <summary>
// Factories to instantiate new instance of BPFActivityDropController given the designer
// </summary>
//
//---------------------------------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        var BPFActivityDropHandlerFactory = (function (_super) {
            __extends(BPFActivityDropHandlerFactory, _super);
            function BPFActivityDropHandlerFactory() {
                _super.apply(this, arguments);
            }
            BPFActivityDropHandlerFactory.prototype.createDropActivityController = function (slot) {
                return new ProcessDesigner.BPFActivityDropController(slot);
            };
            return BPFActivityDropHandlerFactory;
        })(GenericWorkflowDesigner.ActivityDropHandlerFactory);
        ProcessDesigner.BPFActivityDropHandlerFactory = BPFActivityDropHandlerFactory;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
//  <copyright file="BPFFlowStepActivity.ts" company="Microsoft">
//         Copyright (c) Microsoft Corporation.  All rights reserved.
//  </copyright>
// 
//  <summary>
//  Represent the step activity of the business process
//  </summary>
/// <reference path="../../common/bpfactivitytype.ts" />
/// <reference path="../../../process/common/processactivitytype.ts" />
/// <reference path="../../../process/model/processactivitydefinitionmodel.ts" />
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        'use strict';
        var Utility = _Microsoft.Client.Telemetry.Utility;
        var WorkflowObjectModel = Microsoft.Crm.Workflow.ObjectModel;
        var BPFFlowStepActivity = (function (_super) {
            __extends(BPFFlowStepActivity, _super);
            function BPFFlowStepActivity() {
                _super.call(this, ProcessDesigner.BPFActivityType.flow);
                this._uniqueName = '';
                this._workflowName = "";
                this._defaultStepName = ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_BPFStepActivity_StepName");
                this._description = this.defaultStepName;
                this._isRequired = false;
            }
            Object.defineProperty(BPFFlowStepActivity.prototype, "parentStage", {
                get: function () {
                    return this._parentStage;
                },
                set: function (value) {
                    if (this._parentStage !== value) {
                        this._parentStage = value;
                    }
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BPFFlowStepActivity.prototype, "isRequired", {
                get: function () {
                    return this._isRequired;
                },
                set: function (value) {
                    if (this._isRequired !== value) {
                        this._isRequired = value;
                    }
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BPFFlowStepActivity.prototype, "isNewlyAdded", {
                get: function () {
                    return this._isNewlyAdded;
                },
                set: function (value) {
                    if (this._isNewlyAdded !== value) {
                        this._isNewlyAdded = value;
                    }
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BPFFlowStepActivity.prototype, "sequence", {
                get: function () {
                    return this._sequence;
                },
                set: function (value) {
                    if (this._sequence !== value) {
                        this._sequence = value;
                    }
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BPFFlowStepActivity.prototype, "stepId", {
                get: function () {
                    return this._stepId;
                },
                set: function (value) {
                    if (this._stepId !== value) {
                        this._stepId = value;
                    }
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BPFFlowStepActivity.prototype, "description", {
                get: function () {
                    return this._description;
                },
                set: function (value) {
                    if (this._description !== value) {
                        this._description = value;
                    }
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BPFFlowStepActivity.prototype, "uniqueName", {
                get: function () {
                    return this._uniqueName;
                },
                set: function (value) {
                    if (this._uniqueName !== value) {
                        this._uniqueName = value;
                    }
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BPFFlowStepActivity.prototype, "workflowId", {
                get: function () {
                    return this._workflowId;
                },
                set: function (value) {
                    if (this._workflowId !== value) {
                        this._workflowId = value;
                    }
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BPFFlowStepActivity.prototype, "workflowName", {
                get: function () {
                    return this._workflowName;
                },
                set: function (value) {
                    if (this._workflowName !== value) {
                        this._workflowName = value;
                    }
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(BPFFlowStepActivity.prototype, "defaultStepName", {
                get: function () {
                    return this._defaultStepName;
                },
                set: function (value) {
                    if (this._defaultStepName !== value) {
                        this._defaultStepName = value;
                    }
                },
                enumerable: true,
                configurable: true
            });
            BPFFlowStepActivity.prototype.getLookupItems = function () {
                return this._lookupItems;
            };
            BPFFlowStepActivity.prototype.setLookupItems = function (lookupItems) {
                this._lookupItems = lookupItems;
            };
            BPFFlowStepActivity.prototype.getLookupContext = function () {
                if (CommonTypes.Types.Object.isNullOrUndefined(this._lookupContext)) {
                    var entitySetName = "workflows";
                    var filter = "type eq 1 and category eq 5 and statecode eq 1";
                    var numberOfRecords = 10;
                    var attributes = ["name", "category"];
                    var lookupContext = new ProcessDesigner.LookupContext(entitySetName, attributes, numberOfRecords, filter, this.lookupMoreRecords, this.lookupSuccessCallback, null, this, ProcessDesigner.BPFActionStepActivity.postLookupItemSelection, ProcessDesigner.BPFActivityType.flow);
                    this._lookupContext = lookupContext;
                }
                return this._lookupContext;
            };
            BPFFlowStepActivity.prototype.isGlobalWorkflow = function () {
                return false;
            };
            BPFFlowStepActivity.prototype.initialize = function (properties) {
                _super.prototype.initialize.call(this, properties);
                this.stepId = Utility.newGuid();
                this.setActivityTypeID(ProcessDesigner.BPFActivityType.flow);
            };
            BPFFlowStepActivity.prototype.preparePropertyDetails = function () {
                var target = {
                    _description: this.description,
                    _workflowId: this.workflowId,
                    _isRequired: this.isRequired,
                    _defaultStepName: this.defaultStepName
                };
                return JSON.stringify(target);
            };
            BPFFlowStepActivity.prototype.getStepLabel = function () {
                var stepLabel = new WorkflowObjectModel.StepLabel();
                stepLabel.set_description(this.description);
                stepLabel.set_labelId(this.stepId);
                stepLabel.set_languageCode(window._Process_CurrentLCID);
                return stepLabel;
            };
            BPFFlowStepActivity.prototype.generateFlowControlStepJson = function (workflowStep) {
                var controlStep = new WorkflowObjectModel.ControlStep(workflowStep);
                controlStep.set_workflow(workflowStep);
                controlStep.set_Description("");
                controlStep.set_isUnbound(true);
                controlStep.set_classId("00ad73da-bd4d-49c6-88a8-2f4f4cad4a20");
                controlStep.set_controlId(controlStep.get_Name());
                controlStep.set_dataFieldName("");
                controlStep.set_controlDisplayName(this.description);
                controlStep.set_controlType("0");
                controlStep.set_parameters("");
                return controlStep;
            };
            BPFFlowStepActivity.prototype.generateFlowStepJson = function (workflowStep) {
                var flowStep = new WorkflowObjectModel.FlowStep(workflowStep);
                flowStep.set_workflow(workflowStep);
                flowStep.set_Description(this.defaultStepName);
                flowStep.set_workflowId(this.workflowId);
                flowStep.set_actionId(this.stepId);
                flowStep.set_uniqueName(this.uniqueName);
                flowStep.set_flowControl(this.generateFlowControlStepJson(workflowStep));
                return flowStep;
            };
            BPFFlowStepActivity.prototype.generateStepStepJson = function (workflowStep) {
                var stepStep = new WorkflowObjectModel.StepStep(workflowStep, this.defaultStepName);
                stepStep.set_workflow(workflowStep);
                stepStep.set_Description(this.workflowName);
                stepStep.set_isHidden(false);
                stepStep.set_isProcessRequired(this.isRequired);
                stepStep.set_stepStepId(this.stepId);
                stepStep.addLabel(this.getStepLabel());
                stepStep.appendStep(this.generateFlowStepJson(workflowStep));
                return stepStep;
            };
            BPFFlowStepActivity.prototype._validateActivity = function () {
                var status = true;
                var result = null;
                status = this.validateProperties() && status;
                return status;
            };
            BPFFlowStepActivity.prototype.validateProperties = function () {
                var status = true;
                var result = null;
                result = ProcessDesigner.Validation.Engine.validateField("#displayNameTextbox", this.description, ProcessDesigner.Validation.Required.apply, ProcessDesigner.Validation.Level.Change, ProcessDesigner.MetadataProvider.getLocalizedString("ProcessDesignerControl_PBL_NonEmptyValueMessage"), null);
                status = this.addResult(result) && status;
                var workflowId = !this.isNullOrEmptyId(this.workflowId) ? this.workflowId : null;
                result = ProcessDesigner.Validation.Engine.validateField("#lookupControl", workflowId, ProcessDesigner.Validation.Required.apply, ProcessDesigner.Validation.Level.Change, ProcessDesigner.MetadataProvider.getLocalizedString("ProcessDesignerControl_PBL_NonEmptyValueMessage"), null);
                status = this.addResult(result) && status;
                return status;
            };
            BPFFlowStepActivity.prototype.getErrorTile = function () {
                return this.parentStage;
            };
            BPFFlowStepActivity.prototype.getAllowedDependentActivityTypes = function (slotType) {
                return [];
            };
            BPFFlowStepActivity.prototype.getCloneOfActivity = function () {
                var newActivity = new BPFFlowStepActivity();
                newActivity.setWorkflowID(this.workflowId);
                newActivity.defaultStepName = this.defaultStepName;
                newActivity.description = this.description;
                newActivity.parentStage = this.parentStage;
                newActivity.uniqueName = this.uniqueName;
                newActivity.workflowId = this.workflowId;
                newActivity.workflowName = this.workflowName;
                newActivity.setParentActivityID(this.getParentActivityID());
                newActivity.isRequired = this.isRequired;
                return newActivity;
            };
            BPFFlowStepActivity.prototype.getPropertyPageClone = function () {
                var newActivity = new BPFFlowStepActivity();
                newActivity.defaultStepName = this.defaultStepName;
                newActivity.description = this.description;
                newActivity.parentStage = this.parentStage;
                newActivity.workflowId = this.workflowId;
                newActivity.workflowName = this.workflowName;
                newActivity.uniqueName = this.uniqueName;
                newActivity.isRequired = this.isRequired;
                return newActivity;
            };
            BPFFlowStepActivity.prototype.lookupMoreRecords = function (callback, callbackContext) {
                var processControl = window["ProcessControl"];
                var workflowDialog = processControl.Configuration.BPFClientProxy.launchWorkflowLookupDialog(BPFFlowStepActivity.lookupMoreRecordsViewId, function (dialogParams, callbackParams) {
                    var lookupControlItems = dialogParams["items"];
                    if (lookupControlItems.length > 0) {
                        var workflowId = lookupControlItems[0].id;
                        var valueHash = {};
                        valueHash = ProcessDesigner.BPFActionStepActivity.getValueHash(lookupControlItems[0].values);
                        var entityName = valueHash["primaryentity"];
                        var category = ProcessDesigner.ProcessType[valueHash["category"]];
                        if (ProcessDesigner.BPFActionStepActivity.isSelectedWorkflowEntityDifferent(entityName)) {
                            ProcessDesigner.BPFActionStepActivity.showErrorOrWarningDialog(ProcessDesigner.BPFDialogMessageTypes.Warning, ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_ErrorTitle"), window['String'].format(ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_ActionStepPropertyDetails_Entity_ErrorMessage"), ProcessDesigner.BPFActionStepActivity.getCurrentEntityName()));
                        }
                        else {
                            var processId = workflowId;
                            if (workflowId.lastIndexOf("{", 0) === 0 && workflowId.lastIndexOf("}", workflowId.length) === workflowId.length - 1) {
                                processId = workflowId.substring(1, workflowId.length - 1);
                            }
                            ProcessDesigner.MetadataProvider.validateProcessForUI(processId, function (result) {
                                if (!CommonTypes.Types.Object.isNullOrUndefined(result)) {
                                    if (result.ValidationSuccess == true) {
                                        if (!CommonTypes.Types.Object.isNullOrUndefined(valueHash["mode"]))
                                            ProcessDesigner.BPFActionStepActivity.actionRecords[workflowId] = parseInt(valueHash["mode"]);
                                        var selectedWorkflowName = lookupControlItems[0].name;
                                        $("#WorkflowTxtLookup").val(selectedWorkflowName);
                                        $('#displayName').text(selectedWorkflowName);
                                        var lookupItem = new GenericWorkflowDesigner.LookupItem(workflowId, selectedWorkflowName, BPFFlowStepActivity.getFlowUrl(workflowId), ProcessDesigner.BPFWorkflowSymbol.symbol, category, BPFFlowStepActivity.getSearchBarSelectedTemplate());
                                        callback(lookupItem);
                                        if (window.hasOwnProperty('lookupDialogCloseCallback')) {
                                            window['lookupDialogCloseCallback'].call();
                                        }
                                    }
                                    else {
                                        ProcessDesigner.BPFActionStepActivity.showProcessUIValidationFailure(result);
                                    }
                                }
                            }, ProcessDesigner.BPFActionStepActivity.showErrorOrWarningDialog);
                        }
                    }
                    else {
                        ProcessDesigner.BPFActionStepActivity.setModelWorkflow(callback);
                    }
                    if (!CommonTypes.Types.Object.isNullOrUndefined(workflowDialog))
                        workflowDialog.close();
                }, false);
            };
            BPFFlowStepActivity.prototype.lookupSuccessCallback = function (records, callbackContext) {
                var lookupItems = BPFFlowStepActivity.convertFlowStepRecordsIntoLookupItems(records);
                callbackContext.setLookupItems(lookupItems);
                return lookupItems;
            };
            BPFFlowStepActivity.convertFlowStepRecordsIntoLookupItems = function (records) {
                var lookupItems = [];
                if (!CommonTypes.Types.Object.isNullOrUndefined(records) && records.length > 0) {
                    jQuery.each(records, function (index, workflowRecord) {
                        var id = workflowRecord.workflowid;
                        var name = workflowRecord.name;
                        var category = workflowRecord.category;
                        var lookupItem = new GenericWorkflowDesigner.LookupItem(id, name, BPFFlowStepActivity.getFlowUrl(id), ProcessDesigner.BPFWorkflowSymbol.symbol, category, BPFFlowStepActivity.getSearchBarSelectedTemplate());
                        lookupItems.push(lookupItem);
                    });
                }
                return lookupItems;
            };
            BPFFlowStepActivity.prototype.isNullOrEmptyId = function (id) {
                return CommonTypes.Types.Object.isNullOrUndefined(id) || id === BPFFlowStepActivity.emptyProcessId;
            };
            BPFFlowStepActivity.getFlowUrl = function (workflowId) {
                return "";
            };
            BPFFlowStepActivity.getSearchBarSelectedTemplate = function () {
                return _.template('<div id="lookupContainerDiv" style="color:black !important" class="searchBar selectedItem borderedContainer selected-search-width" tabindex="0">' +
                    '<div id="selectedFlowLabel"> <%- SelectedItemName %> </div>' +
                    '</div>');
            };
            BPFFlowStepActivity.lookupMoreRecordsViewId = "27793551-980a-446c-a30f-4bdc7b0a7174";
            BPFFlowStepActivity.emptyProcessId = "00000000-0000-0000-0000-000000000000";
            return BPFFlowStepActivity;
        })(ProcessDesigner.ProcessActivityDefinitionModel);
        ProcessDesigner.BPFFlowStepActivity = BPFFlowStepActivity;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// ---------------------------------------------------------------------------------------------
//  <copyright file="BPFRootActivityTileInformation.ts" company="Microsoft">
//         Copyright (c) Microsoft Corporation.  All rights reserved.
//  </copyright>
// 
//  <summary>
//  Represent the tile information of the root activity
//  </summary>
// 
// ---------------------------------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        var BPFRootActivityTileInformation = (function (_super) {
            __extends(BPFRootActivityTileInformation, _super);
            function BPFRootActivityTileInformation(model, itemId) {
                _super.call(this, model, itemId);
            }
            BPFRootActivityTileInformation.prototype.GetProperties = function () {
                var result = _super.prototype.GetBasicTileProperties.call(this);
                result["emptyTitleText"] = "Internal : Root Tile";
                result["fontIconImage"] = "rootTileImage";
                return result;
            };
            return BPFRootActivityTileInformation;
        })(GenericWorkflowDesigner.BaseTileInformation);
        ProcessDesigner.BPFRootActivityTileInformation = BPFRootActivityTileInformation;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// ---------------------------------------------------------------------------------------------
//  <copyright file="BPFStepActivityTileInformation.ts" company="Microsoft">
//         Copyright (c) Microsoft Corporation.  All rights reserved.
//  </copyright>
// 
//  <summary>
//  Represent the tile information of the stage activity
//  </summary>
// ---------------------------------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        var BPFStepActivityTileInformation = (function (_super) {
            __extends(BPFStepActivityTileInformation, _super);
            function BPFStepActivityTileInformation(model, itemId) {
                _super.call(this, model, itemId);
                this.attributeName = "";
                this.stepName = "";
                this.StepActivityTemplate = "<span class=\"tileTitle\" title= \"<%- emptyTitleText %>\"><span class=\"tileTableCell\"><div><span class= \"tileInner ellipsis\" > <%- emptyTitleText  %></span></div><span class=\"tileInner ellipsis\"><%- stepName %></span></span></span> ";
                this.attributeName = model.attributeName;
                this.stepName = model.description;
            }
            BPFStepActivityTileInformation.prototype.GetProperties = function () {
                var result = _super.prototype.GetBasicTileProperties.call(this);
                result["stepName"] = this.stepName;
                result["emptyTitleText"] = this.attributeName;
                result["emptyTileTemplate"] = this.StepActivityTemplate;
                return result;
            };
            return BPFStepActivityTileInformation;
        })(GenericWorkflowDesigner.BaseTileInformation);
        ProcessDesigner.BPFStepActivityTileInformation = BPFStepActivityTileInformation;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// ---------------------------------------------------------------------------------------------
//  <copyright file="BPFActionStepActivityTileInformation.ts" company="Microsoft">
//         Copyright (c) Microsoft Corporation.  All rights reserved.
//  </copyright>
// 
//  <summary>
//  Represent the tile information of the stage activity
//  </summary>
// ---------------------------------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        var BPFActionStepActivityTileInformation = (function (_super) {
            __extends(BPFActionStepActivityTileInformation, _super);
            function BPFActionStepActivityTileInformation(model, itemId) {
                _super.call(this, model, itemId);
                this.attributeName = "";
                this.stepName = "";
                this.StepActivityTemplate = "<span class=\"tileTitle\" title= \"<%- emptyTitleText %>\"><span class=\"tileTableCell\"><div><span class= \"tileInner ellipsis\" > <%- emptyTitleText  %></span></div><span class=\"tileInner ellipsis\"><%- stepName %></span></span></span> ";
                this.attributeName = model.attributeName;
                this.stepName = model.description;
            }
            BPFActionStepActivityTileInformation.prototype.GetProperties = function () {
                var result = _super.prototype.GetBasicTileProperties.call(this);
                result["stepName"] = this.stepName;
                result["emptyTitleText"] = this.attributeName;
                result["emptyTileTemplate"] = this.StepActivityTemplate;
                return result;
            };
            return BPFActionStepActivityTileInformation;
        })(GenericWorkflowDesigner.BaseTileInformation);
        ProcessDesigner.BPFActionStepActivityTileInformation = BPFActionStepActivityTileInformation;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// ---------------------------------------------------------------------------------------------
//  <copyright file="BPFFlowStepActivityTileInformation.ts" company="Microsoft">
//         Copyright (c) Microsoft Corporation.  All rights reserved.
//  </copyright>
//
//  <summary>
//  Represent the tile information of the flow step activity
//  </summary>
// ---------------------------------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        var BPFFlowStepActivityTileInformation = (function (_super) {
            __extends(BPFFlowStepActivityTileInformation, _super);
            function BPFFlowStepActivityTileInformation(model, itemId) {
                _super.call(this, model, itemId);
                this.stepName = "";
                this.FlowStepActivityTemplate = "<span class=\"tileTitle\" title= \"<%- emptyTitleText %>\"><span class=\"tileTableCell\"><div><span class= \"tileInner ellipsis\" > <%- emptyTitleText  %></span></div><span class=\"tileInner ellipsis\"><%- stepName %></span></span></span> ";
                this.stepName = model.description;
            }
            BPFFlowStepActivityTileInformation.prototype.GetProperties = function () {
                var result = _super.prototype.GetBasicTileProperties.call(this);
                result["stepName"] = this.stepName;
                result["emptyTitleText"] = "Internal: Flow Step";
                result["emptyTileTemplate"] = this.FlowStepActivityTemplate;
                return result;
            };
            return BPFFlowStepActivityTileInformation;
        })(GenericWorkflowDesigner.BaseTileInformation);
        ProcessDesigner.BPFFlowStepActivityTileInformation = BPFFlowStepActivityTileInformation;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
//---------------------------------------------------------------------------------------------
// <copyright file="RootTileInformation.ts" company="Microsoft">
//		Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
//
// <summary>
// Represent the tile information of the Root Tile activity
// </summary>
//
//---------------------------------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        'use strict';
        var RootActivityTileInformation = (function (_super) {
            __extends(RootActivityTileInformation, _super);
            function RootActivityTileInformation(model, itemId) {
                _super.call(this, model, itemId);
                this.activityTemplate = "<span class=\"tileTitle\" title=\"<%- Title %>\"><span class=\"tileTableCell\"><span class=\"tileInner ellipsis\"><%- Subtitle %></span>< span class=\"tileInner ellipsis\"><%- Title %></span></span></span>";
            }
            RootActivityTileInformation.prototype.GetProperties = function () {
                var result = _super.prototype.GetBasicTileProperties.call(this);
                result["tileclass"] = "stageTile";
                result["emptyTitleText"] = "Internal : Root Stage";
                return result;
            };
            return RootActivityTileInformation;
        })(GenericWorkflowDesigner.BaseTileInformation);
        ProcessDesigner.RootActivityTileInformation = RootActivityTileInformation;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
//---------------------------------------------------------------------------------------------
// <copyright file="ProcessTileInformationFactory.ts" company="Microsoft">
//		Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
//
// <summary>
// Represent the tile information of the Process Tile Factory
// </summary>
//
//---------------------------------------------------------------------------------------------
/// <reference path="RootActivityTileInformation.ts"/>
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        'use strict';
        var ProcessTileInformationFactory = (function (_super) {
            __extends(ProcessTileInformationFactory, _super);
            function ProcessTileInformationFactory() {
                _super.apply(this, arguments);
            }
            ProcessTileInformationFactory.prototype.GetTileInformationForActivityModel = function (activityModel, specificItemId) {
                var activityType = activityModel.getActivityTypeID();
                switch (activityType) {
                    case ProcessDesigner.ProcessActivityType.Root:
                        return new ProcessDesigner.RootActivityTileInformation(activityModel, specificItemId);
                    case ProcessDesigner.ProcessActivityType.Condition:
                        return new ProcessDesigner.ConditionActivityTileInformation(activityModel, specificItemId);
                    default:
                        return _super.prototype.GetTileInformationForActivityModel.call(this, activityModel, specificItemId);
                }
            };
            ProcessTileInformationFactory.prototype.GetDataUriforImagePath = function (imagePath) {
                return null;
            };
            return ProcessTileInformationFactory;
        })(GenericWorkflowDesigner.DefaultTileInformationFactory);
        ProcessDesigner.ProcessTileInformationFactory = ProcessTileInformationFactory;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        var BPFStageActivityTileInformation = (function (_super) {
            __extends(BPFStageActivityTileInformation, _super);
            function BPFStageActivityTileInformation(model, itemId) {
                _super.call(this, model, itemId);
                this.entityName = "";
                this.stageName = "";
                this.StageActivityTemplate = "<span class=\"tileTitle\" title= \"" + ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_MDDPropertyEntityName") + " <%- emptyTitleText %> " + ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_StagePropertyDetails_StageName") + " <%- stageName %>\"><span class=\"tileTableCell\"><div><span class= \"tileInner ellipsis stringTruncation canvasAreaTileTitle1\" > <%- emptyTitleText  %></span></div><span class=\"tileInner ellipsis stringTruncation canvasAreaTileTitle2\" ><%- stageName %></span></span></span> ";
                this.entityName = model.entityName;
                this.stageName = model.displayName;
            }
            BPFStageActivityTileInformation.prototype.GetProperties = function () {
                var result = _super.prototype.GetBasicTileProperties.call(this);
                result["stageName"] = this.stageName;
                result["emptyTitleText"] = CommonTypes.Types.String.isNullOrEmpty(this.entityName) ? this.entityName : Xrm.Internal.getEntityDisplayName(this.entityName);
                result["emptyTileTemplate"] = this.StageActivityTemplate;
                result["activityTypeName"] = ProcessDesigner.MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_Stage_Activity_Name");
                return result;
            };
            return BPFStageActivityTileInformation;
        })(GenericWorkflowDesigner.BaseTileInformation);
        ProcessDesigner.BPFStageActivityTileInformation = BPFStageActivityTileInformation;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        var BPFWorkflowActivityTileInformation = (function (_super) {
            __extends(BPFWorkflowActivityTileInformation, _super);
            function BPFWorkflowActivityTileInformation(model, itemId) {
                _super.call(this, model, itemId);
                this.attributeName = "";
                this.actionStepName = "";
                this.WorkflowActivityTemplate = "<span class=\"tileTitle\" title= \"<%- emptyTitleText %>\"><span class=\"tileTableCell\"><div><span class= \"tileInner ellipsis\" > <%- emptyTitleText  %></span></div><span class=\"tileInner ellipsis\"><%- stageName %></span></span></span> ";
                this.attributeName = model.uniqueName;
                this.actionStepName = model.description;
            }
            BPFWorkflowActivityTileInformation.prototype.GetProperties = function () {
                var result = _super.prototype.GetBasicTileProperties.call(this);
                result["actionStepName"] = this.actionStepName;
                result["emptyTitleText"] = this.attributeName;
                result["emptyTileTemplate"] = this.WorkflowActivityTemplate;
                result["activityTypeName"] = ProcessDesigner.MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_Workflow_Activity_Name");
                return result;
            };
            return BPFWorkflowActivityTileInformation;
        })(GenericWorkflowDesigner.BaseTileInformation);
        ProcessDesigner.BPFWorkflowActivityTileInformation = BPFWorkflowActivityTileInformation;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// ---------------------------------------------------------------------------------------------
//  <copyright file="BPFTileInformationFactory.ts" company="Microsoft">
//         Copyright (c) Microsoft Corporation.  All rights reserved.
//  </copyright>
// 
//  <summary>
//  Represent the tile information of the visibility activity
//  </summary>
// ---------------------------------------------------------------------------------------------
/// <reference path="../../../process/model/tileinformation/processtileinformationfactory.ts" />
/// <reference path="bpfstageactivitytileinformation.ts" />
/// <reference path="bpfworkflowactivitytileinformation.ts" />
/// <reference path="../../common/bpfactivitytype.ts" />
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        var BPFTileInformationFactory = (function (_super) {
            __extends(BPFTileInformationFactory, _super);
            function BPFTileInformationFactory() {
                _super.apply(this, arguments);
            }
            BPFTileInformationFactory.prototype.GetTileInformationForActivityModel = function (activityModel, specificItemId) {
                switch (activityModel.getActivityTypeID()) {
                    case ProcessDesigner.BPFActivityType.stage:
                        return new ProcessDesigner.BPFStageActivityTileInformation(activityModel, specificItemId);
                    case ProcessDesigner.BPFActivityType.root:
                        return new ProcessDesigner.BPFRootActivityTileInformation(activityModel, specificItemId);
                    case ProcessDesigner.BPFActivityType.condition:
                        return new ProcessDesigner.ConditionActivityTileInformation(activityModel, specificItemId);
                    case ProcessDesigner.BPFActivityType.step:
                        return new ProcessDesigner.BPFStepActivityTileInformation(activityModel, specificItemId);
                    case ProcessDesigner.BPFActivityType.workflow:
                        return new ProcessDesigner.BPFWorkflowActivityTileInformation(activityModel, specificItemId);
                    case ProcessDesigner.BPFActivityType.action:
                        return new ProcessDesigner.BPFActionStepActivityTileInformation(activityModel, specificItemId);
                    case ProcessDesigner.BPFActivityType.flow:
                        return new ProcessDesigner.BPFFlowStepActivityTileInformation(activityModel, specificItemId);
                    default:
                        return _super.prototype.GetTileInformationForActivityModel.call(this, activityModel, specificItemId);
                }
            };
            BPFTileInformationFactory.prototype.GetDataUriforImagePath = function (imagePath) {
                return ProcessDesigner.ProcessDesignerControl.dataBag.resources.getImageresource(imagePath);
            };
            BPFTileInformationFactory.prototype.GetLocalizedString = function (inputString) {
                return ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString(inputString);
            };
            return BPFTileInformationFactory;
        })(ProcessDesigner.ProcessTileInformationFactory);
        ProcessDesigner.BPFTileInformationFactory = BPFTileInformationFactory;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        'use strict';
        var ActionArgument = (function (_super) {
            __extends(ActionArgument, _super);
            function ActionArgument() {
                _super.apply(this, arguments);
            }
            Object.defineProperty(ActionArgument.prototype, "ArgumentId", {
                get: function () {
                    return this._argumentId;
                },
                set: function (value) {
                    if (this._argumentId !== value) {
                        this._argumentId = value;
                    }
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(ActionArgument.prototype, "ArgumentName", {
                get: function () {
                    return this._argumentName;
                },
                set: function (value) {
                    if (this._argumentName !== value) {
                        this._argumentName = value;
                    }
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(ActionArgument.prototype, "ArgumentType", {
                get: function () {
                    return this._argumentType;
                },
                set: function (value) {
                    if (this._argumentType !== value) {
                        this._argumentType = value;
                    }
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(ActionArgument.prototype, "ArgumentDirection", {
                get: function () {
                    return this._argumentDirection;
                },
                set: function (value) {
                    if (this._argumentDirection !== value) {
                        this._argumentDirection = value;
                    }
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(ActionArgument.prototype, "AttributeList", {
                get: function () {
                    return this._attributeList;
                },
                set: function (value) {
                    if (this._attributeList !== value) {
                        this._attributeList = value;
                    }
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(ActionArgument.prototype, "ArgumentAttributeName", {
                get: function () {
                    return this._argumentAttributeName;
                },
                set: function (value) {
                    if (this._argumentAttributeName !== value) {
                        this._argumentAttributeName = value;
                    }
                },
                enumerable: true,
                configurable: true
            });
            Object.defineProperty(ActionArgument.prototype, "ValueExpression", {
                get: function () {
                    return this._valueExpression;
                },
                set: function (value) {
                    if (this._valueExpression !== value) {
                        this._valueExpression = value;
                    }
                },
                enumerable: true,
                configurable: true
            });
            return ActionArgument;
        })(Backbone.Model);
        ProcessDesigner.ActionArgument = ActionArgument;
        (function (ArgumentType) {
            ArgumentType[ArgumentType["System.Boolean"] = 0] = "System.Boolean";
            ArgumentType[ArgumentType["System.DateTime"] = 2] = "System.DateTime";
            ArgumentType[ArgumentType["System.Decimal"] = 3] = "System.Decimal";
            ArgumentType[ArgumentType["System.Double"] = 4] = "System.Double";
            ArgumentType[ArgumentType["System.Int32"] = 5] = "System.Int32";
            ArgumentType[ArgumentType["Microsoft.Xrm.Sdk.Money"] = 7] = "Microsoft.Xrm.Sdk.Money";
            ArgumentType[ArgumentType["Microsoft.Xrm.Sdk.OptionSetValue"] = 10] = "Microsoft.Xrm.Sdk.OptionSetValue";
            ArgumentType[ArgumentType["System.String"] = 14] = "System.String";
            ArgumentType[ArgumentType["Microsoft.Xrm.Sdk.EntityReference"] = 16] = "Microsoft.Xrm.Sdk.EntityReference";
        })(ProcessDesigner.ArgumentType || (ProcessDesigner.ArgumentType = {}));
        var ArgumentType = ProcessDesigner.ArgumentType;
        (function (ArgumentDirection) {
            ArgumentDirection[ArgumentDirection["Input"] = 0] = "Input";
            ArgumentDirection[ArgumentDirection["Output"] = 1] = "Output";
        })(ProcessDesigner.ArgumentDirection || (ProcessDesigner.ArgumentDirection = {}));
        var ArgumentDirection = ProcessDesigner.ArgumentDirection;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// -----------------------------------------------------------------------
// <copyright file="BPFStageSlotTileHolderView.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        "use strict";
        var BpfStageSlotTileHolderView = (function (_super) {
            __extends(BpfStageSlotTileHolderView, _super);
            function BpfStageSlotTileHolderView(stageModel) {
                _super.call(this, { model: stageModel });
            }
            BpfStageSlotTileHolderView.prototype.render = function () {
                _super.prototype.render.call(this);
                if (!GenericWorkflowDesigner.Settings.renderMinimapFlag) {
                    var tileButtonView = new ProcessDesigner.TileButtonView(this.model, this.$el);
                    tileButtonView.render();
                }
                return this;
            };
            BpfStageSlotTileHolderView.prototype.setupEvents = function () {
                var self = this;
                this.listenTo(this.model.getActivity(), 'changeModel', function () {
                    GenericWorkflowDesigner.Settings.renderMinimapFlag = false;
                    this.render();
                    GenericWorkflowDesigner.Settings.renderMinimapFlag = true;
                });
                this.$el.on("click keydown", function (event) {
                    if (event.type == "click" || event.keyCode == 13) {
                        switch (ProcessDesigner.BPFToolBarView.addMode) {
                            case ProcessDesigner.BPFToolBarAddMode.AddStep:
                            case ProcessDesigner.BPFToolBarAddMode.AddActionStep:
                            case ProcessDesigner.BPFToolBarAddMode.AddFlowStep:
                                var activityTypeId = "";
                                if (ProcessDesigner.BPFToolBarView.addMode == ProcessDesigner.BPFToolBarAddMode.AddStep) {
                                    activityTypeId = "step";
                                }
                                else if (ProcessDesigner.BPFToolBarView.addMode == ProcessDesigner.BPFToolBarAddMode.AddActionStep) {
                                    activityTypeId = "action";
                                }
                                else {
                                    activityTypeId = "flow";
                                }
                                var droppedElement = new GenericWorkflowDesigner.LibraryElementModel({
                                    Title: ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_SlotGenerator_Title"),
                                    Tooltip: ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_LibraryTileStepTooltip"),
                                    Image: "",
                                    DataURI: "",
                                    Alt: ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_LibraryTileAltText"),
                                    FontIconImage: "",
                                    ActivityTypeID: activityTypeId
                                });
                                GenericWorkflowDesigner.SlotBase.supportedEvents.dropLibraryElement.trigger(self, self, droppedElement);
                                ProcessDesigner.BPFToolBarView.addMode = ProcessDesigner.BPFToolBarAddMode.None;
                                var stepAdded = GenericWorkflowDesigner.Settings.workflowTree.getSelectedActivities();
                                if (stepAdded.length > 0) {
                                    var currentActivity = stepAdded[0];
                                    var parentStageId = currentActivity.parentStage.stageId;
                                    ProcessDesigner.TelemetryEventReporter.ReportTileAddedTelemetryEvent("Menu", currentActivity.stepId, ProcessDesigner.BPFActivityType.step, parentStageId);
                                    ProcessDesigner.CanvasDisplayUtility.HandleStageDetailsOverlap();
                                }
                                break;
                            case ProcessDesigner.BPFToolBarAddMode.AddWorkflow:
                                var droppedElement = new GenericWorkflowDesigner.LibraryElementModel({ Title: ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_SlotGenerator_Title"), Tooltip: ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_LibraryTileWorkflowTooltip"), Image: "", DataURI: "", Alt: ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_LibraryTileAltText"), FontIconImage: "", ActivityTypeID: "workflow" });
                                GenericWorkflowDesigner.SlotBase.supportedEvents.dropLibraryElement.trigger(self, self, droppedElement);
                                ProcessDesigner.BPFToolBarView.addMode = ProcessDesigner.BPFToolBarAddMode.None;
                                var workflowAdded = GenericWorkflowDesigner.Settings.workflowTree.getSelectedActivities();
                                if (workflowAdded.length > 0) {
                                    var currentActivity = workflowAdded[0];
                                    var parentStageId = currentActivity.parentStage.stageId;
                                    ProcessDesigner.TelemetryEventReporter.ReportTileAddedTelemetryEvent("Menu", currentActivity.actionStepId, ProcessDesigner.BPFActivityType.workflow, parentStageId);
                                    ProcessDesigner.CanvasDisplayUtility.HandleStageDetailsOverlap();
                                }
                                break;
                            case ProcessDesigner.BPFToolBarAddMode.PasteStep:
                            case ProcessDesigner.BPFToolBarAddMode.PasteActionStep:
                            case ProcessDesigner.BPFToolBarAddMode.PasteFlowStep:
                                if ((self.$el).hasClass('hoverOverDroppable')) {
                                    var pasteCmd = new ProcessDesigner.BPFPasteCommand();
                                    pasteCmd.pasteComponentAtSlot(self);
                                    ProcessDesigner.BPFToolBarView.addMode = ProcessDesigner.BPFToolBarAddMode.None;
                                }
                                break;
                            case ProcessDesigner.BPFToolBarAddMode.PasteWorkflow:
                                var pasteCmd = new ProcessDesigner.BPFPasteCommand();
                                pasteCmd.pasteComponentAtSlot(self);
                                ProcessDesigner.BPFToolBarView.addMode = ProcessDesigner.BPFToolBarAddMode.None;
                                break;
                            default:
                                self.slotClick(event);
                        }
                    }
                    $("#canvas").children(".slot.hoverOverDroppable").removeAttr('aria-label').removeClass("hoverOverDroppable").attr("aria-hidden", "true");
                    $("#canvas").children(".slot.selected").removeClass("selected");
                    event.target.focus();
                    event.stopPropagation();
                });
                this.$el.on("mousedown", function (event) {
                    event.stopPropagation();
                });
            };
            BpfStageSlotTileHolderView.prototype.makeDroppable = function () {
                var self = this;
                this.$el.droppable({
                    tolerance: "pointer",
                    accept: function (element) {
                        if (!element.hasClass("step-list-listitem")) {
                            return GenericWorkflowDesigner.SlotBase.isValidDroppable(this.id, element.attr('id'));
                        }
                        else {
                            return false;
                        }
                    },
                    activate: function (event, ui) {
                        $(this).addClass("hoverOverDroppable").attr("aria-hidden", "false");
                    },
                    deactivate: function (event, ui) {
                        $(this).removeClass("hoverOverDroppable").attr("aria-hidden", "true");
                    },
                    over: function (event, ui) {
                        $(this).addClass("hoverOverDroppableHighlight");
                    },
                    out: function (event, ui) {
                        $(this).removeClass("hoverOverDroppableHighlight");
                    },
                    drop: function (event, ui) {
                        if ($(".hoverOverDroppableHighlight").length > 1) {
                            $(this).removeClass("hoverOverDroppableHighlight");
                            return;
                        }
                        $(this).removeClass("hoverOverDroppableHighlight");
                        var droppedElement = ui.helper.data(GenericWorkflowDesigner.HelperElementView.modelDataKey);
                        var activityDropController = GenericWorkflowDesigner.Settings.activityDropHandlerFactory.createDropActivityController(self.model);
                        ProcessDesigner.ControlManager.CloseSeeDetails();
                        var stopwatch = new GenericWorkflowDesigner.Stopwatch();
                        stopwatch.start();
                        activityDropController.dropLibraryElement(droppedElement).done(function (activity) {
                            GenericWorkflowDesigner.updateCurrentModel(activity);
                            ProcessDesigner.ControlManager.updateSlotCount(self);
                            GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.updateTileTitle);
                            GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.activatePropertyTab);
                        });
                        stopwatch.stop();
                        localStorage.setItem("PerfMarker_" + droppedElement.attributes.Title.replace("/", "").replace(/ /g, '') + "Drop", stopwatch.elapsedMilliseconds.toString());
                    }
                });
            };
            BpfStageSlotTileHolderView.prototype.slotClick = function (event) {
                var currentTab = $(GenericWorkflowDesigner.toolpaneId);
                var activeTab = $(GenericWorkflowDesigner.toolpaneId).tabs('option', 'active');
                var propertyTabIndex = 1;
                var selectedTiles = $(this.$el).find('.selected');
                var isTileSelected = false;
                if (selectedTiles.length > 0) {
                    isTileSelected = true;
                }
                if (isTileSelected && activeTab == propertyTabIndex && !$(GenericWorkflowDesigner.toolpaneId).find("#stageProperty")) {
                    return;
                }
                $(".tileButtonDiv").removeClass("selected");
                $(".stageTile").removeClass("selected");
                $(".conditionTile").removeClass("selected");
                if (this.$el.children().find(".conditionTile").length == 1) {
                    this.$el.children().find(".conditionTile").addClass("selected");
                }
                if (this.$el.children().find(".stageTile").length == 1) {
                    this.$el.children().find(".stageTile").addClass("selected");
                }
                if ((".stage-detail-container")) {
                    $(".step-list-listitem.selected").removeClass("selected");
                    $('#DownArrow').attr("aria-disabled", true);
                    $('#DownArrow').addClass("disableArrowButton");
                    $('#UpArrow').attr("aria-disabled", true);
                    $('#UpArrow').addClass("disableArrowButton");
                }
                var clickHandler = GenericWorkflowDesigner.Settings.slotHandlerProvider.createClickHandler(this.model);
                clickHandler.click(this.$el);
                this.$el.focus();
                GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.activatePropertyTab);
                GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.refreshToolbarItems);
                event.stopPropagation();
            };
            return BpfStageSlotTileHolderView;
        })(GenericWorkflowDesigner.SlotTileHolderView);
        ProcessDesigner.BpfStageSlotTileHolderView = BpfStageSlotTileHolderView;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// -----------------------------------------------------------------------
// <copyright file="ConnectorActivityListSubView.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        "use strict";
        var ConnectorActivityListSubView = (function (_super) {
            __extends(ConnectorActivityListSubView, _super);
            function ConnectorActivityListSubView(option, activityItem, parentObj) {
                _super.call(this, {
                    el: activityItem
                });
                this.className = "activity-item";
                this.option = option;
                this.parentObj = parentObj;
            }
            ConnectorActivityListSubView.prototype.initialize = function () {
                this.itemTemplate = _.template(" <button id =\"<%- Title %>TileButton\" tabindex=\"-1\" class=\"connectactivityOptionTitle\" title= \"<%- Tooltip %>\"><%- Title %></span> ");
                this.$el.addClass(this.className);
                var self = this;
                this.$el.on("click", function (event) {
                    self.ClickHandler(event);
                });
            };
            ConnectorActivityListSubView.prototype.render = function () {
                var itemText = this.option["connectorItemText"];
                var itemTooltip = this.option["connectorItemTooltip"];
                this.$el.append(this.itemTemplate({ Tooltip: itemTooltip, Title: itemText }));
                return this;
            };
            ConnectorActivityListSubView.prototype.alertDialog = function (title, message) {
                var dialogDetails = {
                    dialogTitle: title,
                    dialogMessage: message,
                    messageType: ProcessDesigner.BPFDialogMessageTypes.Warning
                };
                GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.showDialog, dialogDetails);
            };
            ConnectorActivityListSubView.prototype.connectionActionConfirmationDialog = function (stageName) {
                var self = this;
                var dialogTitle, dialogMessage;
                if (this.selectedConnectionMode == ProcessDesigner.BPFConnectorActivityTypeCommandID.Connect) {
                    dialogTitle = ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_ConnectMultipleActivity_Title");
                    dialogMessage = CommonTypes.Types.String.Format(ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_ConnectMultipleActivity_Warning"), stageName, ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_Connector_Connect"));
                }
                else if (this.selectedConnectionMode == ProcessDesigner.BPFConnectorActivityTypeCommandID.Disconnect) {
                    dialogTitle = ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_DisconnectMultipleActivity_Title");
                    dialogMessage = CommonTypes.Types.String.Format(ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_ConnectMultipleActivity_Warning"), stageName, ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_Connector_Disconnect"));
                }
                else if (this.selectedConnectionMode == ProcessDesigner.BPFConnectorActivityTypeCommandID.Reconnect) {
                    dialogTitle = ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_ReconnectMultipleActivity_Title");
                    dialogMessage = CommonTypes.Types.String.Format(ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_ConnectMultipleActivity_Warning"), stageName, ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_Connector_Reconnect"));
                }
                var dialogDetails = {
                    dialogTitle: dialogTitle,
                    dialogMessage: dialogMessage,
                    messageType: ProcessDesigner.BPFDialogMessageTypes.Warning,
                    yesCallbackAction: function () {
                        self.connectionActionConfirmedCallback(self);
                    },
                    noCallbackAction: function () {
                        self.connectionActionCanceledCallback();
                    }
                };
                GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.showDialog, dialogDetails);
            };
            ConnectorActivityListSubView.prototype.connectionActionConfirmedCallback = function (context) {
                var startConnectorID = "";
                var connectActivityID = "";
                var ifConditionBranchActivity = null;
                if (ConnectorActivityListSubView.startConnector instanceof ProcessDesigner.BPFStageActivity) {
                    startConnectorID = ConnectorActivityListSubView.startConnector.stageId;
                }
                if (context.connectActivity instanceof ProcessDesigner.BPFStageActivity) {
                    connectActivityID = context.connectActivity.stageId;
                }
                if (!CommonTypes.Types.Object.isNullOrUndefined(ConnectorActivityListSubView.startConnector)) {
                    ifConditionBranchActivity = context.findIfConditionBranch(ConnectorActivityListSubView.startConnector);
                }
                if (context.selectedConnectionMode == ProcessDesigner.BPFConnectorActivityTypeCommandID.Connect) {
                    if (!CommonTypes.Types.Object.isNullOrUndefined(ifConditionBranchActivity) && !CommonTypes.Types.Object.isNullOrUndefined(ConnectorActivityListSubView.startConnector) && !CommonTypes.Types.Object.isNullOrUndefined(context.connectActivity)) {
                        ProcessDesigner.TelemetryEventReporter.ReportTileConnectedTelemetryEvent(startConnectorID, "", connectActivityID);
                    }
                    context.connectTargetClickHandler();
                }
                else if (context.selectedConnectionMode == ProcessDesigner.BPFConnectorActivityTypeCommandID.Disconnect) {
                    if (!CommonTypes.Types.Object.isNullOrUndefined(ifConditionBranchActivity) && !CommonTypes.Types.Object.isNullOrUndefined(ConnectorActivityListSubView.startConnector) && !CommonTypes.Types.Object.isNullOrUndefined(ConnectorActivityListSubView.oldDefaultGlobal)) {
                        ProcessDesigner.TelemetryEventReporter.ReportTileDisconnectedTelemetryEvent(startConnectorID, "", ConnectorActivityListSubView.oldDefaultGlobal.stageId);
                    }
                    context.disconnectTargetHandler();
                }
                else if (context.selectedConnectionMode == ProcessDesigner.BPFConnectorActivityTypeCommandID.Reconnect) {
                    if (!CommonTypes.Types.Object.isNullOrUndefined(ifConditionBranchActivity) && !CommonTypes.Types.Object.isNullOrUndefined(ConnectorActivityListSubView.startConnector) && !CommonTypes.Types.Object.isNullOrUndefined(ConnectorActivityListSubView.oldDefaultGlobal) && !CommonTypes.Types.Object.isNullOrUndefined(context.connectActivity)) {
                        ProcessDesigner.TelemetryEventReporter.ReportTileReconnectedTelemetryEvent(startConnectorID, "", ConnectorActivityListSubView.oldDefaultGlobal.stageId, connectActivityID);
                    }
                    context.disConnect();
                    context.disconnectTargetHandler();
                    context.connectTargetClickHandler();
                }
            };
            ConnectorActivityListSubView.prototype.connectionActionCanceledCallback = function () {
                GenericWorkflowDesigner.Settings.workflowTree.setSelectedActivities(null);
                ProcessDesigner.ConnectorActivityListView.targetID = null;
                GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.editDone);
                GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.canvasRefresh);
                GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.refreshToolbarItems);
                return;
            };
            ConnectorActivityListSubView.prototype.ClickHandler = function (event) {
                var stopwatch = new GenericWorkflowDesigner.Stopwatch();
                stopwatch.start();
                var self = this;
                var tileClass, select;
                var firstPoint = GenericWorkflowDesigner.Settings.workflowTree.getSelectedActivities()[0];
                if (firstPoint) {
                    ProcessDesigner.ConnectorActivityListView.targetID = event.target.id;
                    if (firstPoint.getActivityTypeID() == ProcessDesigner.BPFActivityType.condition) {
                        select = $("#canvas").find(".selected")[1];
                        select = $("#canvas").find(select);
                    }
                    else
                        select = $("#canvas").find(".selected");
                    $("#" + firstPoint.id).attr("aria-label", ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_Connector_FirstEndPoint"));
                    this.notificationObj = new ProcessDesigner.NotificationStatusView("Empty");
                    var calc = new GenericWorkflowDesigner.PositionCalculator(GenericWorkflowDesigner.Settings.layoutProperties);
                    var left = calc.computeLeft(firstPoint.getCol());
                    var top = calc.computeTop(firstPoint.getRow());
                    switch ($(event.currentTarget).attr("id").toString()) {
                        case ProcessDesigner.BPFConnectorActivityTypeCommandID.Connect:
                            ProcessDesigner.BPFToolBarView.connectMode = ProcessDesigner.BPFToolBarConnectMode.ConnectTile;
                            this.notificationObj.render("1st Point", left, top);
                            self.connectSecondPoint(firstPoint, "connect");
                            stopwatch.stop();
                            localStorage.setItem("ProcessDesignerControl_BPF_ShowConnectSecondPoint", stopwatch.elapsedMilliseconds.toString());
                            break;
                        case ProcessDesigner.BPFConnectorActivityTypeCommandID.Disconnect:
                            ProcessDesigner.BPFToolBarView.connectMode = ProcessDesigner.BPFToolBarConnectMode.DisconnectTile;
                            this.notificationObj.render("1st Point", left, top);
                            self.connectSecondPoint(firstPoint, "disconnect");
                            stopwatch.stop();
                            localStorage.setItem("ProcessDesignerControl_BPF_ShowDisconnectConfirm", stopwatch.elapsedMilliseconds.toString());
                            break;
                        case ProcessDesigner.BPFConnectorActivityTypeCommandID.Reconnect:
                            ProcessDesigner.BPFToolBarView.connectMode = ProcessDesigner.BPFToolBarConnectMode.ReconnectTile;
                            this.notificationObj.render("1st Point", left, top);
                            self.connectSecondPoint(firstPoint, "reconnect");
                            stopwatch.stop();
                            localStorage.setItem("ProcessDesignerControl_BPF_ShowReconnectSecondPoint", stopwatch.elapsedMilliseconds.toString());
                            break;
                        default:
                            ProcessDesigner.BPFToolBarView.connectMode = ProcessDesigner.BPFToolBarConnectMode.None;
                    }
                    ;
                    GenericWorkflowDesigner.Settings.workflowTree.setSelectedActivities(null);
                    GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.refreshToolbarItems);
                    $(".slot").unbind("keydown keypress");
                    ProcessDesigner.ControlManager.SetCanvasFocusEvent();
                    $(".selected.stageTile").removeClass("selected");
                    $(".selected.conditionTile").removeClass("selected");
                    $("#" + firstPoint.getActivityID()).find("#" + firstPoint.getActivityID()).addClass("selected");
                    $.find('.selected')[0].focus();
                    GenericWorkflowDesigner.currentModel = firstPoint;
                }
                tileClass = tileClass + ", .slot:has(" + tileClass + ")";
                $.event.trigger('ConnectButton', [tileClass]);
            };
            ConnectorActivityListSubView.prototype.getEligible = function () {
                return ConnectorActivityListSubView.eligible;
            };
            ConnectorActivityListSubView.prototype.getStart = function () {
                return ConnectorActivityListSubView.startConnector;
            };
            ConnectorActivityListSubView.prototype.findEligibleEndConnectorsForYesOrNoPath = function (dropActivity, checkNoPath) {
                var eligibleConnectors = [];
                var self = this;
                var children = dropActivity.getChildActivitiesSorted();
                var firstChildInPath = null;
                children.forEach(function (child) {
                    if ((!checkNoPath && child.getParentBranchID() == ProcessDesigner.DefaultBranchIndices.YesBranch) || (checkNoPath && child.getParentBranchID() == ProcessDesigner.DefaultBranchIndices.NoBranch)) {
                        firstChildInPath = child;
                    }
                });
                if (!CommonTypes.Types.Object.isNullOrUndefined(firstChildInPath) && firstChildInPath instanceof ProcessDesigner.BPFStageActivity) {
                    var orderedChildren = firstChildInPath.getChildActivitiesSorted();
                    while (orderedChildren.length > 0 && !CommonTypes.Types.Object.isNullOrUndefined(orderedChildren[0]) && orderedChildren[0].getParentBranchID() == ProcessDesigner.DefaultBranchIndices.DefaultBranch) {
                        if (orderedChildren[0] instanceof ProcessDesigner.BPFStageActivity) {
                            eligibleConnectors.push(orderedChildren[0]);
                        }
                        orderedChildren = orderedChildren[0].getChildActivitiesSorted();
                    }
                }
                return eligibleConnectors;
            };
            ConnectorActivityListSubView.prototype.findEligibleEndConnectorsForDefaultPath = function (defaultPathStage) {
                var eligibleConnectors = [];
                var self = this;
                var orderedChildren = defaultPathStage.getChildActivitiesSorted();
                while (orderedChildren.length > 0 && !CommonTypes.Types.Object.isNullOrUndefined(orderedChildren[0]) && orderedChildren[0].getParentBranchID() == ProcessDesigner.DefaultBranchIndices.DefaultBranch) {
                    if (orderedChildren[0] instanceof ProcessDesigner.BPFStageActivity && orderedChildren[0].getActivityID() != ConnectorActivityListSubView.oldDefaultGlobal.getActivityID()) {
                        eligibleConnectors.push(orderedChildren[0]);
                    }
                    orderedChildren = orderedChildren[0].getChildActivitiesSorted();
                }
                return eligibleConnectors;
            };
            ConnectorActivityListSubView.prototype.disConnect = function () {
                var calc = new GenericWorkflowDesigner.PositionCalculator(GenericWorkflowDesigner.Settings.layoutProperties);
                var topOfDefault = calc.computeTop(ConnectorActivityListSubView.oldDefaultGlobal.getRow());
                var leftOfDefault = calc.computeLeft(ConnectorActivityListSubView.oldDefaultGlobal.getCol());
                var hitOfDefault;
                var connectHitIdOfDefault = '#connect-hitOfDefault';
                $(connectHitIdOfDefault).remove();
                if (GenericWorkflowDesigner.Settings.renderRTL)
                    hitOfDefault = '<div id="' + ConnectorActivityListSubView.oldDefaultGlobal.getActivityID() + '" style=" right:' + leftOfDefault + 'px; top:' + topOfDefault + 'px; "></div>';
                else
                    hitOfDefault = '<div id="' + ConnectorActivityListSubView.oldDefaultGlobal.getActivityID() + '" style=" left:' + leftOfDefault + 'px; top:' + topOfDefault + 'px; "></div>';
                hitOfDefault = $(hitOfDefault).addClass("connectorSecondPoint");
                hitOfDefault.on("mousedown", function (event) {
                    event.stopPropagation();
                });
                $("#canvas").append(hitOfDefault);
                this.notificationObj.render("2nd Point", leftOfDefault, topOfDefault);
            };
            ConnectorActivityListSubView.prototype.disconnectOldDefault = function () {
                var self = this;
                var conditionActivity = ConnectorActivityListSubView.dropActivityGlobal;
                var oldDefault = ConnectorActivityListSubView.oldDefaultGlobal;
                var attachmentPoint = this.findLastActivityInIfBranch(conditionActivity);
                oldDefault.setParentActivityID(attachmentPoint.getActivityID());
                if (attachmentPoint.getActivityID() == conditionActivity.getActivityID()) {
                    oldDefault.setParentBranchID(ProcessDesigner.DefaultBranchIndices.YesBranch);
                }
                else {
                    oldDefault.setParentBranchID(ProcessDesigner.DefaultBranchIndices.DefaultBranch);
                }
                ConnectorActivityListSubView.startConnector.save();
                $("#canvas").off('click');
                ProcessDesigner.ConnectorActivityListView.targetID = null;
                GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.editDone);
                GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.canvasRefresh);
                GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.refreshToolbarItems);
            };
            ConnectorActivityListSubView.prototype.disconnectTargetHandler = function () {
                var stopwatch = new GenericWorkflowDesigner.Stopwatch();
                stopwatch.start();
                this.disconnectOldDefault();
                stopwatch.stop();
                localStorage.setItem("ProcessDesignerControl_BPF_DisconnectConnector", stopwatch.elapsedMilliseconds.toString());
            };
            ConnectorActivityListSubView.prototype.connectTargetClickHandler = function () {
                var self = this;
                var stopwatch = new GenericWorkflowDesigner.Stopwatch();
                stopwatch.start();
                var ifConditionBranch = self.findIfConditionBranch(ConnectorActivityListSubView.startConnector);
                self.connectActivity.setParentActivityID(ifConditionBranch.getActivityID());
                self.connectActivity.setParentBranchID(ProcessDesigner.branchType.Default);
                self.connectActivity.save();
                $("#canvas").off('click');
                ProcessDesigner.ConnectorActivityListView.targetID = null;
                GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.editDone);
                GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.canvasRefresh);
                GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.refreshToolbarItems);
                stopwatch.stop();
                localStorage.setItem("ProcessDesignerControl_BPF_ConnectUsingConnector", stopwatch.elapsedMilliseconds.toString());
            };
            ConnectorActivityListSubView.prototype.drawTargetView = function (activity) {
                var self = this;
                var calc = new GenericWorkflowDesigner.PositionCalculator(GenericWorkflowDesigner.Settings.layoutProperties);
                var top = calc.computeTop(activity.getRow());
                var left = calc.computeLeft(activity.getCol());
                var hit;
                var connectHitId = '#connect-hit';
                $(connectHitId).remove();
                if (GenericWorkflowDesigner.Settings.renderRTL)
                    hit = '<div id="' + activity.getActivityID() + '" style=" right:' + left + 'px; top:' + top + 'px; "></div>';
                else
                    hit = '<div id="' + activity.getActivityID() + '" style=" left:' + left + 'px; top:' + top + 'px; "></div>';
                hit = $(hit).addClass("connectorSecondPoint");
                $("#" + activity.getActivityID()).attr("aria-label", ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_Connector_SecondEndPoint"));
                hit.on("mousedown", function (event) {
                    event.stopPropagation();
                });
                $("#canvas").append(hit);
                self.notificationObj.render("2nd Point", left, top);
                $("#canvas").off('click keypress', '#' + activity.getActivityID());
                $("#canvas").on('click keypress', '#' + activity.getActivityID(), function (event) {
                    if (event.type == "keypress" && (event.keyCode != 13 && event.keyCode != 32))
                        return;
                    self.connectActivity = activity;
                    var stageBeforeCondition = null;
                    var conditionBlockIfBranch = self.findIfConditionBranch(ConnectorActivityListSubView.startConnector);
                    if (conditionBlockIfBranch != null) {
                        if (self.selectedConnectionMode == ProcessDesigner.BPFConnectorActivityTypeCommandID.Reconnect) {
                            var parentActivity = activity, outside = false;
                            while (parentActivity != null && parentActivity.getParent() != null) {
                                if (parentActivity instanceof ProcessDesigner.BPFStageActivity && parentActivity.getParent() instanceof ProcessDesigner.BPFConditionActivity && parentActivity.getParentBranchID() == ProcessDesigner.DefaultBranchIndices.DefaultBranch) {
                                    if (parentActivity.getParent().getActivityID() == conditionBlockIfBranch.getActivityID()) {
                                        outside = true;
                                        break;
                                    }
                                }
                                parentActivity = parentActivity.getParent();
                            }
                            if (outside) {
                                stageBeforeCondition = parentActivity.getParent().getParent();
                            }
                            else {
                                stageBeforeCondition = self.findIfConditionBranch(activity).getParent();
                            }
                        }
                        else if (self.selectedConnectionMode == ProcessDesigner.BPFConnectorActivityTypeCommandID.Connect) {
                            stageBeforeCondition = self.findIfConditionBranch(activity).getParent();
                        }
                        var numberOfBranchesInConditionBlock = self.getNumberOfBranches(conditionBlockIfBranch);
                        if (numberOfBranchesInConditionBlock >= ConnectorActivityListSubView.minimumNumberOfBranchesForConnectorPrompt) {
                            self.connectionActionConfirmationDialog(conditionBlockIfBranch.getParent().displayName);
                        }
                        else {
                            self.connectionActionConfirmedCallback(self);
                            ProcessDesigner.ControlManager.NavigateToSelectedElement();
                        }
                    }
                });
            };
            ConnectorActivityListSubView.prototype.findIfChild = function (ifChild, activity) {
                if (ifChild) {
                    var found = false, branchID;
                    var lastNodeIfChild = ifChild;
                    while (ifChild && !found) {
                        if (ifChild.getActivityID() == activity.getActivityID()) {
                            ConnectorActivityListSubView.inside = true;
                        }
                        lastNodeIfChild = ifChild;
                        if (ifChild.getActivityTypeID() == ProcessDesigner.BPFActivityType.condition) {
                            var tempChilds = ifChild.getChildActivitiesSorted();
                            var tempLength = tempChilds.length;
                            switch (tempLength) {
                                case 1:
                                    branchID = tempChilds[0].getParentBranchID();
                                    switch (branchID) {
                                        case ProcessDesigner.branchType.Default:
                                            ifChild = ifChild.getChildActivitiesSorted()[0];
                                            break;
                                        case ProcessDesigner.branchType.If:
                                            found = true;
                                            lastNodeIfChild = ifChild;
                                            break;
                                        case ProcessDesigner.branchType.Else:
                                            break;
                                    }
                                    ;
                                    break;
                                case 2:
                                    branchID = tempChilds[0].getParentBranchID();
                                    switch (branchID) {
                                        case ProcessDesigner.branchType.Default:
                                            ifChild = ifChild.getChildActivitiesSorted()[0];
                                            break;
                                        case ProcessDesigner.branchType.If:
                                            found = true;
                                            lastNodeIfChild = ifChild;
                                            break;
                                        case ProcessDesigner.branchType.Else:
                                            break;
                                    }
                                    ;
                                    break;
                                case 3:
                                    ifChild = ifChild.getChildActivitiesSorted()[0];
                                    break;
                            }
                        }
                        else {
                            ifChild = ifChild.getChildActivitiesSorted()[0];
                        }
                    }
                    return lastNodeIfChild;
                }
                else
                    return null;
            };
            ConnectorActivityListSubView.prototype.findLastNodeDefaultChild = function (oldDefault, activity) {
                if (oldDefault) {
                    var found = false, branchID;
                    var tempOldDefault = oldDefault;
                    var lastNodeDefaultChild = oldDefault;
                    while (tempOldDefault && tempOldDefault.getActivityID() != activity.getActivityID() && !found) {
                        lastNodeDefaultChild = tempOldDefault;
                        if (tempOldDefault.getActivityTypeID() == ProcessDesigner.BPFActivityType.condition) {
                            var tempChilds = tempOldDefault.getChildActivitiesSorted();
                            var tempLength = tempChilds.length;
                            switch (tempLength) {
                                case 1:
                                    branchID = tempChilds[0].getParentBranchID();
                                    switch (branchID) {
                                        case ProcessDesigner.branchType.Default:
                                            tempOldDefault = tempOldDefault.getChildActivitiesSorted()[0];
                                            break;
                                        case ProcessDesigner.branchType.If:
                                            break;
                                        case ProcessDesigner.branchType.Else:
                                            break;
                                    }
                                    ;
                                    break;
                                case 2:
                                    branchID = tempChilds[0].getParentBranchID();
                                    switch (branchID) {
                                        case ProcessDesigner.branchType.Default:
                                            tempOldDefault = tempOldDefault.getChildActivitiesSorted()[0];
                                            break;
                                        case ProcessDesigner.branchType.If:
                                            break;
                                        case ProcessDesigner.branchType.Else:
                                            break;
                                    }
                                    ;
                                    break;
                                case 3:
                                    tempOldDefault = tempOldDefault.getChildActivitiesSorted()[0];
                                    break;
                            }
                        }
                        else {
                            tempOldDefault = tempOldDefault.getChildActivitiesSorted()[0];
                        }
                    }
                    return lastNodeDefaultChild;
                }
                else
                    return null;
            };
            ConnectorActivityListSubView.prototype.findIfConditionBranch = function (currentActivity) {
                var parentCondition = this.findParentConditionBranch(currentActivity);
                while (parentCondition instanceof ProcessDesigner.BPFConditionActivity && parentCondition.getParent() instanceof ProcessDesigner.BPFConditionActivity && parentCondition.getParentBranchID() == ProcessDesigner.DefaultBranchIndices.NoBranch) {
                    parentCondition = parentCondition.getParent();
                }
                return parentCondition;
            };
            ConnectorActivityListSubView.prototype.findParentConditionBranch = function (currentActivity) {
                if (CommonTypes.Types.Object.isNullOrUndefined(currentActivity)) {
                    return null;
                }
                else if (currentActivity instanceof ProcessDesigner.BPFConditionActivity) {
                    return currentActivity;
                }
                else {
                    if (currentActivity.getParent() instanceof ProcessDesigner.BPFConditionActivity && currentActivity.getParentBranchID() == ProcessDesigner.DefaultBranchIndices.DefaultBranch) {
                        currentActivity = currentActivity.getParent();
                    }
                    return this.findParentConditionBranch(currentActivity.getParent());
                }
            };
            ConnectorActivityListSubView.prototype.getNumberOfBranches = function (branch) {
                var childrenOfBranch = branch.getChildActivitiesSorted();
                var elseActivity = null;
                childrenOfBranch.forEach(function (activity) {
                    if (activity.getParentBranchID() == ProcessDesigner.DefaultBranchIndices.NoBranch) {
                        elseActivity = activity;
                    }
                });
                if (elseActivity == null) {
                    return 1;
                }
                else if (elseActivity instanceof ProcessDesigner.BPFStageActivity) {
                    return 2;
                }
                else {
                    return 1 + this.getNumberOfBranches(elseActivity);
                }
            };
            ConnectorActivityListSubView.prototype.findLastActivityInIfBranch = function (ifBranch) {
                var lastActivity = ifBranch;
                var self = this;
                ifBranch.getChildActivitiesSorted().forEach(function (childActivity) {
                    if (childActivity instanceof ProcessDesigner.BPFStageActivity && childActivity.getParentBranchID() == ProcessDesigner.DefaultBranchIndices.YesBranch) {
                        lastActivity = null;
                        var finalStage = childActivity;
                        while (lastActivity == null) {
                            var childrenOfStage = finalStage.getChildActivitiesSorted();
                            if (childrenOfStage.length == 0) {
                                lastActivity = finalStage;
                            }
                            else if (childrenOfStage[0] instanceof ProcessDesigner.BPFStageActivity) {
                                finalStage = childrenOfStage[0];
                            }
                            else {
                                var stageAfterConditionBlock = null;
                                childrenOfStage[0].getChildActivitiesSorted().forEach(function (childOfIfConditionBranch) {
                                    if (childOfIfConditionBranch instanceof ProcessDesigner.BPFStageActivity && childOfIfConditionBranch.getParentBranchID() == ProcessDesigner.DefaultBranchIndices.DefaultBranch) {
                                        stageAfterConditionBlock = childOfIfConditionBranch;
                                    }
                                });
                                if (stageAfterConditionBlock != null) {
                                    finalStage = stageAfterConditionBlock;
                                }
                                else {
                                    lastActivity = childrenOfStage[0];
                                }
                            }
                        }
                    }
                });
                return lastActivity;
            };
            ConnectorActivityListSubView.prototype.isInIfBranch = function (currentActivity, parentCondition) {
                if (currentActivity == null) {
                    return false;
                }
                else if (currentActivity instanceof ProcessDesigner.BPFStageActivity) {
                    if (currentActivity.getParentBranchID() == ProcessDesigner.DefaultBranchIndices.NoBranch) {
                        return false;
                    }
                    else if (currentActivity.getParentBranchID() == ProcessDesigner.DefaultBranchIndices.YesBranch) {
                        if (currentActivity.getParent().getActivityID() == parentCondition.getActivityID()) {
                            return true;
                        }
                        else {
                            return false;
                        }
                    }
                }
                else if (currentActivity instanceof ProcessDesigner.ConditionActivity && currentActivity.getActivityID() == parentCondition.getActivityID()) {
                    return true;
                }
                return this.isInIfBranch(currentActivity.getParent(), parentCondition);
            };
            ConnectorActivityListSubView.prototype.isInElseBranch = function (currentActivity, parentCondition) {
                if (currentActivity == null) {
                    return false;
                }
                else if (currentActivity instanceof ProcessDesigner.BPFStageActivity) {
                    if (currentActivity.getParentBranchID() == ProcessDesigner.DefaultBranchIndices.NoBranch) {
                        if (currentActivity.getParent().getActivityID() == parentCondition.getActivityID()) {
                            return true;
                        }
                        else {
                            return false;
                        }
                    }
                    else if (currentActivity.getParentBranchID() == ProcessDesigner.DefaultBranchIndices.YesBranch) {
                        return false;
                    }
                }
                else if (currentActivity instanceof ProcessDesigner.ConditionActivity && currentActivity.getActivityID() == parentCondition.getActivityID()) {
                    return true;
                }
                return this.isInElseBranch(currentActivity.getParent(), parentCondition);
            };
            ConnectorActivityListSubView.prototype.fillAllGlobalValues = function (dropActivity) {
                var children = dropActivity.getChildActivitiesSorted();
                ConnectorActivityListSubView.eligible = [];
                var self = this;
                var branchActivitiesByConditionBlock = ProcessDesigner.BPFConditionActivity.groupBranchesByConditionBlock(GenericWorkflowDesigner.Settings.workflowTree.getActivities());
                var ifConditionBranch = this.findIfConditionBranch(dropActivity);
                if (!CommonTypes.Types.Object.isNullOrUndefined(ifConditionBranch)) {
                    var conditions = branchActivitiesByConditionBlock[ifConditionBranch.getActivityID()];
                    var ifConditionBranchChildren = ifConditionBranch.getChildActivitiesSorted();
                    if (!CommonTypes.Types.Object.isNullOrUndefined(ifConditionBranchChildren[0]) && ifConditionBranchChildren[0] instanceof ProcessDesigner.BPFStageActivity && ifConditionBranchChildren[0].getParentBranchID() == ProcessDesigner.branchType.Default)
                        ConnectorActivityListSubView.oldDefaultGlobal = ifConditionBranchChildren[0];
                    else
                        ConnectorActivityListSubView.oldDefaultGlobal = null;
                    ConnectorActivityListSubView.startConnector = dropActivity;
                    if (dropActivity.getActivityTypeID() == ProcessDesigner.BPFActivityType.stage) {
                        if (children.length == 0) {
                            conditions.forEach(function (condition) {
                                var conditionChildren = condition.getChildActivitiesSorted(), containsElseBranch = false;
                                conditionChildren.forEach(function (child) {
                                    if (child instanceof ProcessDesigner.BPFStageActivity && child.getParentBranchID() == ProcessDesigner.DefaultBranchIndices.NoBranch) {
                                        containsElseBranch = true;
                                    }
                                });
                                if (condition.getActivityID() != self.findParentConditionBranch(dropActivity).getActivityID() || containsElseBranch) {
                                    ConnectorActivityListSubView.dropActivityGlobal = condition;
                                    if (condition.getActivityID() != self.findParentConditionBranch(dropActivity).getActivityID()) {
                                        ConnectorActivityListSubView.eligible = ConnectorActivityListSubView.eligible.concat(self.findEligibleEndConnectorsForYesOrNoPath(condition, false));
                                        if (containsElseBranch) {
                                            ConnectorActivityListSubView.eligible = ConnectorActivityListSubView.eligible.concat(self.findEligibleEndConnectorsForYesOrNoPath(condition, true));
                                        }
                                    }
                                    else {
                                        ConnectorActivityListSubView.eligible = ConnectorActivityListSubView.eligible.concat(self.findEligibleEndConnectorsForYesOrNoPath(condition, !self.isInElseBranch(dropActivity, condition)));
                                    }
                                }
                            });
                            if (!CommonTypes.Types.Object.isNullOrUndefined(ConnectorActivityListSubView.oldDefaultGlobal)) {
                                ConnectorActivityListSubView.eligible = ConnectorActivityListSubView.eligible.concat(self.findEligibleEndConnectorsForDefaultPath(ConnectorActivityListSubView.oldDefaultGlobal));
                            }
                        }
                    }
                    else {
                        if (dropActivity.getActivityTypeID() == ProcessDesigner.BPFActivityType.condition && (children.length == 0 || (children.length == 1 && children[0].getParentBranchID() == ProcessDesigner.DefaultBranchIndices.NoBranch))) {
                            conditions.forEach(function (condition) {
                                if (condition.getActivityID() != dropActivity.getActivityID()) {
                                    ConnectorActivityListSubView.dropActivityGlobal = condition;
                                    var conditionChilds = condition.getChildActivitiesSorted();
                                    ConnectorActivityListSubView.eligible = ConnectorActivityListSubView.eligible.concat(self.findEligibleEndConnectorsForYesOrNoPath(condition, false));
                                }
                            });
                            if (!CommonTypes.Types.Object.isNullOrUndefined(ConnectorActivityListSubView.oldDefaultGlobal)) {
                                ConnectorActivityListSubView.eligible = ConnectorActivityListSubView.eligible.concat(self.findEligibleEndConnectorsForDefaultPath(ConnectorActivityListSubView.oldDefaultGlobal));
                            }
                        }
                        else if (dropActivity.getActivityTypeID() == ProcessDesigner.BPFActivityType.condition) {
                            ConnectorActivityListSubView.dropActivityGlobal = dropActivity;
                            ConnectorActivityListSubView.eligible = this.findEligibleEndConnectorsForYesOrNoPath(dropActivity, false);
                            if (!CommonTypes.Types.Object.isNullOrUndefined(ConnectorActivityListSubView.oldDefaultGlobal)) {
                                ConnectorActivityListSubView.eligible = ConnectorActivityListSubView.eligible.concat(self.findEligibleEndConnectorsForDefaultPath(ConnectorActivityListSubView.oldDefaultGlobal));
                            }
                        }
                    }
                }
            };
            ConnectorActivityListSubView.prototype.connectSecondPoint = function (dropActivity, action) {
                var self = this;
                switch (action) {
                    case "connect":
                        if (ConnectorActivityListSubView.eligible.length > 0) {
                            ConnectorActivityListSubView.eligible.forEach(function (activity) {
                                self.selectedConnectionMode = ProcessDesigner.BPFConnectorActivityTypeCommandID.Connect;
                                self.drawTargetView(activity);
                            });
                        }
                        break;
                    case "disconnect":
                        ConnectorActivityListSubView.oldDefaultGlobal = null;
                        var conditionBlockIfActivity = self.findIfConditionBranch(dropActivity);
                        ConnectorActivityListSubView.dropActivityGlobal = conditionBlockIfActivity;
                        conditionBlockIfActivity.getChildActivitiesSorted().forEach(function (childActivity) {
                            if (childActivity instanceof ProcessDesigner.BPFStageActivity && childActivity.getParentBranchID() == ProcessDesigner.DefaultBranchIndices.DefaultBranch) {
                                ConnectorActivityListSubView.oldDefaultGlobal = childActivity;
                            }
                        });
                        if (ConnectorActivityListSubView.oldDefaultGlobal) {
                            this.disConnect();
                            this.selectedConnectionMode = ProcessDesigner.BPFConnectorActivityTypeCommandID.Disconnect;
                            var numberOfBranchesInConditionBlock = this.getNumberOfBranches(conditionBlockIfActivity);
                            if (numberOfBranchesInConditionBlock >= ConnectorActivityListSubView.minimumNumberOfBranchesForConnectorPrompt) {
                                this.connectionActionConfirmationDialog(conditionBlockIfActivity.getParent().displayName);
                            }
                            else {
                                this.connectionActionConfirmedCallback(this);
                            }
                        }
                        break;
                    case "reconnect":
                        if (ConnectorActivityListSubView.eligible.length > 0) {
                            ConnectorActivityListSubView.oldDefaultGlobal = null;
                            var conditionBlockIfActivity = self.findIfConditionBranch(dropActivity);
                            ConnectorActivityListSubView.dropActivityGlobal = conditionBlockIfActivity;
                            conditionBlockIfActivity.getChildActivitiesSorted().forEach(function (childActivity) {
                                if (childActivity instanceof ProcessDesigner.BPFStageActivity && childActivity.getParentBranchID() == ProcessDesigner.DefaultBranchIndices.DefaultBranch) {
                                    ConnectorActivityListSubView.oldDefaultGlobal = childActivity;
                                }
                            });
                            if (ConnectorActivityListSubView.oldDefaultGlobal) {
                                ConnectorActivityListSubView.eligible.forEach(function (activity) {
                                    self.selectedConnectionMode = ProcessDesigner.BPFConnectorActivityTypeCommandID.Reconnect;
                                    self.drawTargetView(activity);
                                });
                            }
                        }
                        break;
                }
                ;
            };
            ConnectorActivityListSubView.minimumNumberOfBranchesForConnectorPrompt = 3;
            return ConnectorActivityListSubView;
        })(Backbone.View);
        ProcessDesigner.ConnectorActivityListSubView = ConnectorActivityListSubView;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// -----------------------------------------------------------------------
// <copyright file="ConnectorActivityListView.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        "use strict";
        var ConnectorActivityListView = (function (_super) {
            __extends(ConnectorActivityListView, _super);
            function ConnectorActivityListView() {
                _super.call(this, {
                    el: $('#connector')
                });
                this.render();
                $('#ConnectTileButton').prop('disabled', true);
                $('#DisconnectTileButton').prop('disabled', true);
                $('#ReconnectTileButton').prop('disabled', true);
                $('#ConnectTileButton').attr("aria-disabled", true);
                $('#DisconnectTileButton').attr("aria-disabled", true);
                $('#ReconnectTileButton').attr("aria-disabled", true);
                if (!ConnectorActivityListView.targetID) {
                    $('#connector').prop('disabled', false);
                    $('#connector').attr("aria-disabled", false);
                    $('#toolBarItemTitleConnector').removeClass('utilityBarItem-disabled-mode');
                    $('#toolBarItemTitleConnector').addClass('utilityBarItem-normal-mode');
                    var selectedActivities = GenericWorkflowDesigner.Settings.workflowTree.getSelectedActivities();
                    var conditionBlockIsConnected = (!CommonTypes.Types.Object.isNullOrUndefined(ProcessDesigner.ConnectorActivityListSubView.oldDefaultGlobal));
                    if (!conditionBlockIsConnected && !CommonTypes.Types.Object.isNullOrUndefined(ProcessDesigner.ConnectorActivityListSubView.eligible) && ProcessDesigner.ConnectorActivityListSubView.eligible.length > 0) {
                        $('#ConnectTileButton').prop('disabled', false);
                        $('#ConnectTileButton').attr("aria-disabled", false);
                    }
                    else if (conditionBlockIsConnected) {
                        if (!CommonTypes.Types.Object.isNullOrUndefined(ProcessDesigner.ConnectorActivityListSubView.eligible) && ProcessDesigner.ConnectorActivityListSubView.eligible.length > 0) {
                            $('#ReconnectTileButton').prop('disabled', false);
                            $('#ReconnectTileButton').attr("aria-disabled", false);
                        }
                        $('#DisconnectTileButton').prop('disabled', false);
                        $('#DisconnectTileButton').attr("aria-disabled", false);
                    }
                    for (var i = 0; i < $(".activity-list").find("button").length; i++) {
                        var currentButton = $(".activity-list").find("button")[i];
                        if ($(currentButton).attr("aria-disabled") == "false") {
                            $(currentButton).focus();
                            break;
                        }
                    }
                }
            }
            ConnectorActivityListView.prototype.initialize = function () {
                ConnectorActivityListView.removeConnectorButton();
            };
            ConnectorActivityListView.removeConnectorButton = function () {
                $('#connector').prop('disabled', true);
                $('#connector').attr("aria-disabled", true);
                $('#toolBarItemTitleConnector').addClass('utilityBarItem-disabled-mode');
                var toolbar = $("#toolBarRow");
                var activityListContainer = toolbar.find(".connectactivity-list-container");
                if (activityListContainer.length > 0) {
                    toolbar.find("#toolBarItemTitle").removeClass("utilityBarItem-selected-mode");
                    toolbar.find("#toolBarItemTitle").addClass("utilityBarItem-normal-mode");
                    activityListContainer.remove();
                    if (typeof event != 'undefined')
                        event.stopPropagation();
                    return;
                }
            };
            ConnectorActivityListView.prototype.render = function () {
                var div = $('<div class="connectactivity-list-container"></div>');
                var listUl = $('<ul class="activity-list"></ul>');
                var libraryGroups_internal = [];
                libraryGroups_internal.push("Connect");
                libraryGroups_internal.push("Disconnect");
                libraryGroups_internal.push("Reconnect");
                var libraryGroups = [];
                libraryGroups.push(ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_Connector_Connect"));
                libraryGroups.push(ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_Connector_Disconnect"));
                libraryGroups.push(ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_Connector_Reconnect"));
                var connectorActivityListItems = [];
                connectorActivityListItems.push(ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_Connector_ConnectTooltip"));
                connectorActivityListItems.push(ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_Connector_DisconnectTooltip"));
                connectorActivityListItems.push(ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_Connector_ReconnectTooltip"));
                if (this.$el) {
                    this.$el.find(".connectactivity-list-container").remove();
                    this.$el.parent().append(div);
                    $(div).append(listUl);
                    var categoryUl = $("<ul class='activity-list-category'></ul>");
                    $(listUl).append(categoryUl);
                    for (var j = 0; j < libraryGroups_internal.length; j++) {
                        var activityName = libraryGroups_internal[j];
                        var listLi = $("<li class='activity-list-listitem' id='" + activityName + "TileCommand' tabindex='-1'></li>");
                        var templateItems = [];
                        templateItems["connectorItemText"] = libraryGroups[j];
                        templateItems["connectorItemTooltip"] = connectorActivityListItems[j];
                        var elem1 = new ProcessDesigner.ConnectorActivityListSubView(templateItems, $(listLi), this);
                        elem1.render();
                        $(categoryUl).append(elem1.el);
                    }
                }
                $(".connectactivity-list-container").keydown(function (event) {
                    if (event.keyCode == 27) {
                        $(this).hide();
                        $("#connector").focus();
                    }
                    if (event.keyCode == 9) {
                        $(this).hide();
                    }
                });
                $(".activity-list-listitem").keydown(function (event) {
                    if (event.keyCode == 13) {
                        $(event.target).focus();
                        $(event.target).click();
                    }
                    if (event.keyCode == 38) {
                        if ($(event.target.parentElement.previousSibling).length > 0) {
                            var prevAll = $(event.target.parentElement).prevAll();
                            prevAll.each(function (index) {
                                var childButton = $(this).find("button");
                                if ($(childButton).attr("aria-disabled") == "false") {
                                    $(childButton).focus();
                                    return false;
                                }
                            });
                        }
                    }
                    if (event.keyCode == 40) {
                        if ($(event.target.parentElement.nextSibling).length > 0) {
                            var nextAll = $(event.target.parentElement).nextAll();
                            nextAll.each(function (index) {
                                var childButton = $(this).find("button");
                                if ($(childButton).attr("aria-disabled") == "false") {
                                    $(childButton).focus();
                                    return false;
                                }
                            });
                        }
                    }
                });
            };
            ConnectorActivityListView.shouldEnableConnectorMenu = function (selectedActivity) {
                var shouldEnableMenu = false;
                var conditionBlockIsConnected = false;
                var conditionBlockIfBranch = ProcessDesigner.ConnectorActivityListSubView.prototype.findIfConditionBranch(selectedActivity);
                if (!CommonTypes.Types.Object.isNullOrUndefined(conditionBlockIfBranch)) {
                    var conditionBlockIfBranchChildren = conditionBlockIfBranch.getChildActivitiesSorted();
                    if (conditionBlockIfBranchChildren[0] instanceof ProcessDesigner.BPFStageActivity && conditionBlockIfBranchChildren[0].getParentBranchID() == ProcessDesigner.DefaultBranchIndices.DefaultBranch) {
                        conditionBlockIsConnected = true;
                    }
                    if (!conditionBlockIsConnected && ProcessDesigner.ConnectorActivityListSubView.eligible && ProcessDesigner.ConnectorActivityListSubView.eligible.length > 0) {
                        shouldEnableMenu = true;
                    }
                    else if (conditionBlockIsConnected) {
                        var childrenOfActivity = selectedActivity.getChildActivitiesSorted();
                        if (selectedActivity.getActivityID() == conditionBlockIfBranch.getActivityID()) {
                            shouldEnableMenu = true;
                        }
                        else if (selectedActivity instanceof ProcessDesigner.BPFStageActivity && childrenOfActivity.length == 0) {
                            shouldEnableMenu = true;
                        }
                        else if (selectedActivity instanceof ProcessDesigner.BPFConditionActivity && selectedActivity.getParentBranchID() == ProcessDesigner.DefaultBranchIndices.NoBranch) {
                            var currentActivity = selectedActivity;
                            while (currentActivity.getParentBranchID() == ProcessDesigner.DefaultBranchIndices.NoBranch && currentActivity.getParent() instanceof ProcessDesigner.BPFConditionActivity) {
                                currentActivity = currentActivity.getParent();
                            }
                            if (!CommonTypes.Types.Object.isNullOrUndefined(currentActivity) && currentActivity.getActivityID() == conditionBlockIfBranch.getActivityID()) {
                                shouldEnableMenu = true;
                            }
                        }
                    }
                }
                return shouldEnableMenu;
            };
            return ConnectorActivityListView;
        })(Backbone.View);
        ProcessDesigner.ConnectorActivityListView = ConnectorActivityListView;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// -----------------------------------------------------------------------
// <copyright file="NotificationStatusView.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        "use strict";
        var NotificationStatusView = (function (_super) {
            __extends(NotificationStatusView, _super);
            function NotificationStatusView(message) {
                _super.call(this);
            }
            NotificationStatusView.prototype.initialize = function () {
            };
            NotificationStatusView.prototype.render = function (point, left, top) {
                var notificationMsg;
                top = top + GenericWorkflowDesigner.Settings.layoutProperties.height;
                var localizedPoint = "";
                if (point == "1st Point")
                    localizedPoint = ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_Connector_FirstPoint");
                else if (point == "2nd Point") {
                    localizedPoint = ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_Connector_SecondPoint");
                }
                if (GenericWorkflowDesigner.Settings.renderRTL)
                    notificationMsg = '<div class="notificationMessage" style=" right:' + left + 'px; top:' + top + 'px; "> ' + localizedPoint + ' </div>';
                else
                    notificationMsg = '<div class="notificationMessage" style=" left:' + left + 'px; top:' + top + 'px; "> ' + localizedPoint + ' </div>';
                if (point == "1st Point")
                    notificationMsg = $(notificationMsg).addClass("connectFirstPointNotificationMessage");
                else if (point == "2nd Point")
                    notificationMsg = $(notificationMsg).addClass("connectSecondPointNotificationMessage");
                $("#canvas").append(notificationMsg);
            };
            return NotificationStatusView;
        })(Backbone.View);
        ProcessDesigner.NotificationStatusView = NotificationStatusView;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        "use strict";
        var EditFlowStepView = (function (_super) {
            __extends(EditFlowStepView, _super);
            function EditFlowStepView(model, el) {
                _super.call(this, {
                    model: model,
                    el: el
                });
                this.className = "step-item";
            }
            EditFlowStepView.prototype.initialize = function () {
                this.stepTemplate = _.template(" <div class=\"flowStepTile stepTile\" title= \"<%- Title %>\"><div class=\"parentStepDiv\"><span class=\"flowStepImageWrapper\"><span class=\"CCFSymbolFont flowStepTileSymbol stepImageWrapper-size\"></span></span></div><div class=\"editViewTileTitle\" ><div id=\"stepSequence\" class=\"canvasAreaTileTitle5 truncateString\">" + ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_LibraryTileName_FlowStep") + " #<%- Sequence %></div><div id=\"stepTitle\" class=\"canvasAreaTileTitle5 truncatestring\"><%- Title %></div></div><div class=\"subViewTileError\" title= \"<%- ErrorToolTip %>\"><span class=\"CCFSymbolFont errorNotificationSymbol notification- fontIcons - size \"></span></div></div>");
                this.$el.addClass(this.className);
                var self = this;
                this.$el.on("click keydown", function (event) {
                    if (event.type == "click" || event.keyCode == 13) {
                        self.flowStepClickedHandler(event);
                        $(".workflow-list-listitem.selected").addClass("unselected");
                        $(".workflow-list-listitem.selected").removeClass("selected");
                        $(".step-list-listitem.selected").addClass("unselected");
                        $(".step-list-listitem.selected").removeClass("selected");
                        self.$el.addClass('selected');
                        self.$el.removeClass('unselected');
                        if (($(".stage-detail-container").length > 0) && ($(".stageTile.selected").length > 0) && ("details_" + $(".stageTile.selected").attr("id") == $(".stage-detail-container").attr("id"))) {
                            $(".stage-detail-container").addClass("selected");
                        }
                    }
                });
                this.listenTo(this.model, 'changeModel', function () {
                    this.$el.find('.stepTile').remove();
                    this.render();
                });
            };
            EditFlowStepView.prototype.render = function () {
                var step = this.model;
                var errorToolTip = ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_ErrorOn_Prefix") + " " + ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_ErrorOn_Suffix") + " " + step.description;
                this.$el.append(this.stepTemplate({ Title: step.description, Sequence: step.sequence, ErrorToolTip: errorToolTip }));
                return this;
            };
            EditFlowStepView.prototype.remove = function () {
                this.undelegateEvents();
                this.$el.removeData().unbind();
                this.model.off();
                this.stopListening(this.model);
                _super.prototype.remove.call(this);
            };
            EditFlowStepView.prototype.flowStepClickedHandler = function (event) {
                event.stopPropagation();
                var clickHandler = new GenericWorkflowDesigner.DefaultActivityClickHandler(this.model);
                clickHandler.click(this.$el);
                GenericWorkflowDesigner.eventManager.trigger('activatePropertyTab');
                GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.refreshToolbarItems);
                var step = this.model;
                var stage = step.parentStage;
                ProcessDesigner.TelemetryEventReporter.ReportTileDetailsViewedTelemetryEvent(step.stepId, ProcessDesigner.BPFActivityType.flow, stage.stageId);
            };
            return EditFlowStepView;
        })(Backbone.View);
        ProcessDesigner.EditFlowStepView = EditFlowStepView;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        "use strict";
        var EditStepView = (function (_super) {
            __extends(EditStepView, _super);
            function EditStepView(model, el) {
                _super.call(this, {
                    model: model,
                    el: el
                });
                this.className = "step-item";
            }
            EditStepView.prototype.initialize = function () {
                this.stepTemplate = _.template(" <div class=\"stepTile\" title= \"<%- Title %>\"><div class=\"parentStepDiv\"><span class=\"stepImageWrapper\"><span class=\"CCFSymbolFont stepTileSymbol stepImageWrapper-size\"></span></span></div><div class=\"editViewTileTitle\" ><div id=\"stepSequence\" class=\"canvasAreaTileTitle5 truncateString\">" + ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_LibraryTileName_step") + " #<%- Sequence %></div><div id=\"stepTitle\" class=\"canvasAreaTileTitle5 truncatestring\"><%- Title %></div></div><div class=\"subViewTileError\" title= \"<%- ErrorToolTip %>\"><span class=\"CCFSymbolFont errorNotificationSymbol notification- fontIcons - size \"></span></div></div>");
                this.$el.addClass(this.className);
                var self = this;
                this.$el.on("click keydown", function (event) {
                    if (event.type == "click" || event.keyCode == 13) {
                        self.stepClickedHandler(event);
                        $(".workflow-list-listitem.selected").addClass("unselected");
                        $(".workflow-list-listitem.selected").removeClass("selected");
                        $(".step-list-listitem.selected").addClass("unselected");
                        $(".step-list-listitem.selected").removeClass("selected");
                        self.$el.addClass('selected');
                        self.$el.removeClass('unselected');
                        if (($(".stage-detail-container").length > 0) && ($(".stageTile.selected").length > 0) && ("details_" + $(".stageTile.selected").attr("id") == $(".stage-detail-container").attr("id"))) {
                            $(".stage-detail-container").addClass("selected");
                        }
                    }
                    this.focus();
                });
                this.listenTo(this.model, 'changeModel', function () {
                    this.$el.find('.stepTile').remove();
                    this.render();
                });
            };
            EditStepView.prototype.render = function () {
                var step = this.model;
                var errorToolTip = ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_ErrorOn_Prefix") + " " + ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_ErrorOn_Suffix") + " " + step.description;
                this.$el.append(this.stepTemplate({ Title: step.description, Sequence: step.sequence, ErrorToolTip: errorToolTip }));
                return this;
            };
            EditStepView.prototype.remove = function () {
                this.undelegateEvents();
                this.$el.removeData().unbind();
                this.model.off();
                this.stopListening(this.model);
                _super.prototype.remove.call(this);
            };
            EditStepView.prototype.stepClickedHandler = function (event) {
                event.stopPropagation();
                var clickHandler = new GenericWorkflowDesigner.DefaultActivityClickHandler(this.model);
                clickHandler.click(this.$el);
                GenericWorkflowDesigner.eventManager.trigger('activatePropertyTab');
                GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.refreshToolbarItems);
                var step = this.model;
                var stage = step.parentStage;
                ProcessDesigner.TelemetryEventReporter.ReportTileDetailsViewedTelemetryEvent(step.stepId, ProcessDesigner.BPFActivityType.step, stage.stageId);
            };
            return EditStepView;
        })(Backbone.View);
        ProcessDesigner.EditStepView = EditStepView;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        "use strict";
        var EditActionStepView = (function (_super) {
            __extends(EditActionStepView, _super);
            function EditActionStepView(model, el) {
                _super.call(this, {
                    model: model,
                    el: el
                });
                this.className = "step-item";
            }
            EditActionStepView.prototype.initialize = function () {
                this.stepTemplate = _.template(" <div class=\"stepTile\" title= \"<%- Title %>\"><div class=\"parentStepDiv\"><span class=\"stepImageWrapper\"><span class=\"CCFSymbolFont actionStepTileSymbol stepImageWrapper-size\"></span></span></div><div class=\"editViewTileTitle\" ><div id=\"stepSequence\" class=\"canvasAreaTileTitle5 truncateString\">" + ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_LibraryTileName_action") + " #<%- Sequence %></div><div id=\"stepTitle\" class=\"canvasAreaTileTitle5 truncatestring\"><%- Title %></div></div><div class=\"subViewTileError\" title= \"<%- ErrorToolTip %>\"><span class=\"CCFSymbolFont errorNotificationSymbol notification- fontIcons - size \"></span></div></div>");
                this.$el.addClass(this.className);
                var self = this;
                this.$el.on("click keydown", function (event) {
                    if (event.type == "click" || event.keyCode == 13) {
                        self.actionStepClickedHandler(event);
                        $(".workflow-list-listitem.selected").addClass("unselected");
                        $(".workflow-list-listitem.selected").removeClass("selected");
                        $(".step-list-listitem.selected").addClass("unselected");
                        $(".step-list-listitem.selected").removeClass("selected");
                        self.$el.addClass('selected');
                        self.$el.removeClass('unselected');
                        if (($(".stage-detail-container").length > 0) && ($(".stageTile.selected").length > 0) && ("details_" + $(".stageTile.selected").attr("id") == $(".stage-detail-container").attr("id"))) {
                            $(".stage-detail-container").addClass("selected");
                        }
                    }
                });
                this.listenTo(this.model, 'changeModel', function () {
                    this.$el.find('.stepTile').remove();
                    this.render();
                });
            };
            EditActionStepView.prototype.render = function () {
                var step = this.model;
                var errorToolTip = ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_ErrorOn_Prefix") + " " + ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_ErrorOn_Suffix") + " " + step.description;
                this.$el.append(this.stepTemplate({ Title: step.description, Sequence: step.sequence, ErrorToolTip: errorToolTip }));
                return this;
            };
            EditActionStepView.prototype.remove = function () {
                this.undelegateEvents();
                this.$el.removeData().unbind();
                this.model.off();
                this.stopListening(this.model);
                _super.prototype.remove.call(this);
            };
            EditActionStepView.prototype.actionStepClickedHandler = function (event) {
                event.stopPropagation();
                var clickHandler = new GenericWorkflowDesigner.DefaultActivityClickHandler(this.model);
                clickHandler.click(this.$el);
                GenericWorkflowDesigner.eventManager.trigger('activatePropertyTab');
                GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.refreshToolbarItems);
                var step = this.model;
                var stage = step.parentStage;
                ProcessDesigner.TelemetryEventReporter.ReportTileDetailsViewedTelemetryEvent(step.stepId, ProcessDesigner.BPFActivityType.action, stage.stageId);
            };
            return EditActionStepView;
        })(Backbone.View);
        ProcessDesigner.EditActionStepView = EditActionStepView;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// <copyright file="AddGlobalWorkflowButtonView.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        "use strict";
        var AddGlobalWorkflowButtonView = (function (_super) {
            __extends(AddGlobalWorkflowButtonView, _super);
            function AddGlobalWorkflowButtonView(title, buttonIcon) {
                _super.call(this);
                this._WorkflowButtonIcon = buttonIcon;
                this._worflowButtonTitle = title;
                this._buttonId = title.replace(/\s/g, '');
                this._buttonStatusId = this._buttonId + "Status";
                this._buttonIconId = this._buttonId + "Icon";
                this._workflowStatus = ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_GlobalButton_Inactive_Status");
            }
            AddGlobalWorkflowButtonView.prototype.initialize = function () {
                this._workflowList = new Array();
                this._GlobalButtonAreaTemplate = _.template("<td id=\"<%- this._buttonIconId%>\" style=\"height:30px; width:15px\"><span class=\"CCFSymbolFont <%- this._WorkflowButtonIcon%> global-fontIcons-size\" style=\"color:white;\"></td>"
                    + "<td id=\"<%- this._buttonId%>\" class = \"globalButton\"></td>"
                    + "<td id=\"<%- this._buttonStatusId%>\" class=\"globalbuttonStatusText\">(<%- this._workflowStatus%>)</td>"
                    + "<td id=\"buttonSeperator\" class=globalButtonSeperator></td>");
            };
            AddGlobalWorkflowButtonView.prototype.showButtonIcon = function () {
                var self = this;
                var showbuttonIcon = _.template("<td id=\"finishWorkflowIcon\" style=\"height:30px; width:15px\"><span class=\"CCFSymbolFont flagSymbol global-fontIcons-size\"></td>");
                $("#globalbuttonArea").append(showbuttonIcon);
            };
            AddGlobalWorkflowButtonView.prototype.showButtonStatus = function () {
                var self = this;
                var id = "#" + self._buttonStatusId;
                var self = this;
                var result = {
                    workflowStatus: this._workflowStatus,
                    showStatusTemplate: '<span class="globalSlotText" >(<%- workflowStatus%>)<span>'
                };
                var showStatusTemplate = _.template(result.showStatusTemplate);
                $(id).html("");
                $(id).append(showStatusTemplate(result));
                $(id).on("click", function (event) {
                    self.showWorkflows();
                });
            };
            AddGlobalWorkflowButtonView.prototype.showbutton = function (activity) {
                var self = this;
                var id = "#" + self._buttonId;
                var GlobalButtonHolderView = new MscrmControls.ProcessDesigner.GlobalButtonHolderView({ model: new GenericWorkflowDesigner.SlotModel(activity) });
                GlobalButtonHolderView.setupGlobalTile(self._worflowButtonTitle);
                this.listenTo(GlobalButtonHolderView, GenericWorkflowDesigner.SlotBase.supportedEvents.dropLibraryElement.name, this.dropLibraryElementHandler);
                $(id).html("");
                $(id).append(GlobalButtonHolderView.render().$el);
            };
            AddGlobalWorkflowButtonView.prototype.addhWorkflows = function (activity) {
                if (this._workflowList.length == 0) {
                    this._workflowStatus = ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_GlobalButton_Active_Status");
                    this.showButtonStatus();
                }
                this._workflowList.push(activity);
            };
            AddGlobalWorkflowButtonView.prototype.showWorkflows = function () {
                var self = this;
                var id = "#" + self._buttonId;
                if ($("#globalList").length < 1) {
                    if (self._workflowList.length > 0) {
                        $(id).append(self.getWorkflowList(self._workflowList));
                    }
                }
                else {
                    $("#globalList").remove();
                }
            };
            AddGlobalWorkflowButtonView.prototype.getWorkflowList = function (steps) {
                var stepListContainerDiv = $('<div id="globalList"></div>');
                var listUl = $('<ul class="globalListUl" style="list-style: none"></ul>');
                $(stepListContainerDiv).append(listUl);
                for (var i = 0; i < steps.length; i++) {
                    var step = steps[i];
                    var finishWorkflow = new MscrmControls.ProcessDesigner.GlobalButtonHolderView({ model: new GenericWorkflowDesigner.SlotModel(step) });
                    finishWorkflow.setupGlobalTile(GenericWorkflowDesigner.CrmEncodeDecode.CrmHtmlEncode(step._name));
                    var stepId = "workflowList" + i;
                    var listLi = $("<li class='globalListIl' id='" + stepId + "'></li>");
                    $(listLi).append(finishWorkflow.render().$el);
                    $(listUl).append(listLi);
                }
                return stepListContainerDiv;
            };
            AddGlobalWorkflowButtonView.prototype.dropLibraryElementHandler = function (slot, libraryElement) {
                var _this = this;
                var activityDropController = new GenericWorkflowDesigner.ActivityDropController(slot.model);
                activityDropController.dropLibraryElement(libraryElement).done(function (activity) {
                    _this.addhWorkflows(activity);
                    GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.editDone);
                    GenericWorkflowDesigner.eventManager.trigger('activatePropertyTab');
                });
            };
            AddGlobalWorkflowButtonView.prototype.render = function () {
                $("#globalbuttonArea").append(this._GlobalButtonAreaTemplate());
                var activity = GenericWorkflowDesigner.Settings.activityDefinitionFactory.createActivity(GenericWorkflowDesigner.ActivityType.Empty);
                this.showbutton(activity);
                return this;
            };
            return AddGlobalWorkflowButtonView;
        })(GenericWorkflowDesigner.AddGlobalButtonView);
        ProcessDesigner.AddGlobalWorkflowButtonView = AddGlobalWorkflowButtonView;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// -----------------------------------------------------------------------
// <copyright file="EditWorkflowView.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        "use strict";
        var EditWorkflowView = (function (_super) {
            __extends(EditWorkflowView, _super);
            function EditWorkflowView(model, el) {
                this.className = "workflow-item";
                _super.call(this, {
                    model: model,
                    el: el
                });
            }
            EditWorkflowView.prototype.initialize = function () {
                var workflowTooltip = ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_Add_Workflow");
                this.actionStepTemplate = _.template(" <div class=\"workflowTile\" title= \"<%- TitleTooltip %>\"><div class=\"parentWorkflowDiv\"><span class=\"workflowImageWrapper\"><span class=\"CCFSymbolFont workflowSymbol workflowImageWrapper-size\" ></span></span></div><div class=\"editViewTileTitle\" ><div id=\"workflowSequence\" class=\"canvasAreaTileTitle5 truncateString\">" + ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_LibraryTileName_workflow") + "</div><div id=\"workflowTitle\" class=\"canvasAreaTileTitle5 truncateString\"><%- Title %></div></div><div class=\"subViewTileError\" title= \"<%- ErrorToolTip %>\"><span class=\"CCFSymbolFont errorNotificationSymbol notification- fontIcons - size \"></span></div></div></div>");
                this.$el.addClass(this.className);
                this.$el.attr("tabindex", -1);
                var self = this;
                this.$el.on("click keypress", function (event) {
                    self.actionStepClickedHandler(event);
                    $(".step-list-listitem.selected").addClass("unselected");
                    $(".step-list-listitem.selected").removeClass("selected");
                    $(".workflow-list-listitem.selected").addClass("unselected");
                    $(".workflow-list-listitem.selected").removeClass("selected");
                    self.$el.addClass('selected');
                    self.$el.removeClass('unselected');
                });
                this.$el.on("keydown", function (event) {
                    if (event.keyCode == 46) {
                        if (!$("#delete").prop("disabled")) {
                            ProcessDesigner.ControlManager.SetFunctionalityForButtonsWithShortcutKeys("#delete");
                        }
                    }
                    else if (event.keyCode == 40) {
                        $(event.target.nextSibling).focus();
                    }
                    else if (event.keyCode == 38) {
                        $(event.target.previousSibling).focus();
                    }
                    else {
                        ProcessDesigner.ControlManager.SetShortcutKeysToMoveOnMajorAreas(event);
                    }
                });
                this.listenTo(this.model, 'changeModel', this.render);
            };
            EditWorkflowView.prototype.render = function () {
                var actionStep = this.model;
                this.$el.find('.workflowTile').remove();
                var errorToolTip = ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_ErrorOn_Prefix") + " " + ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_ErrorOn_Suffix") + " " + actionStep.uniqueName;
                var titleToolTip = "";
                if (actionStep.uniqueName == "") {
                    titleToolTip = ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_Add_Workflow");
                }
                else {
                    titleToolTip = actionStep.uniqueName;
                }
                this.$el.append(this.actionStepTemplate({ Title: actionStep.uniqueName, TitleTooltip: titleToolTip, ErrorToolTip: errorToolTip }));
                return this;
            };
            EditWorkflowView.prototype.remove = function () {
                this.undelegateEvents();
                this.$el.removeData().unbind();
                this.model.off();
                this.stopListening(this.model);
                _super.prototype.remove.call(this);
            };
            EditWorkflowView.prototype.actionStepClickedHandler = function (event) {
                event.stopPropagation();
                var clickHandler = new GenericWorkflowDesigner.DefaultActivityClickHandler(this.model);
                clickHandler.click(this.$el);
                GenericWorkflowDesigner.eventManager.trigger('activatePropertyTab');
                GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.refreshToolbarItems);
                var actionStep = this.model;
                var parentStageId = "";
                if (actionStep.parentStage) {
                    var parentStage = actionStep.parentStage;
                    parentStageId = parentStage.stageId;
                }
                ProcessDesigner.TelemetryEventReporter.ReportTileDetailsViewedTelemetryEvent(actionStep.actionStepId, ProcessDesigner.BPFActivityType.workflow, parentStageId);
            };
            return EditWorkflowView;
        })(Backbone.View);
        ProcessDesigner.EditWorkflowView = EditWorkflowView;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// <copyright file="GlobalButtonHolderView.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        "use strict";
        var GlobalButtonHolderView = (function (_super) {
            __extends(GlobalButtonHolderView, _super);
            function GlobalButtonHolderView() {
                _super.apply(this, arguments);
                this.selectedClassName = "selected";
                this.dragInProgressClass = "dragInProgress";
                this.globalTileTitle = ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_Globalbutton_Title");
            }
            GlobalButtonHolderView.prototype.initialize = function () {
                this.setupEvents();
                if (!this.model.getActivity().getReadonlyMode()) {
                    this.makeDroppable();
                }
            };
            GlobalButtonHolderView.prototype.setupGlobalTile = function (tileTitle) {
                this.globalTileTitle = tileTitle;
            };
            GlobalButtonHolderView.prototype.setupEvents = function () {
                var self = this;
                var activity = this.model.getActivity();
                activity.on("sync", this.render, this);
                this.$el.on("click", function (event) {
                    if (self.allTilesSelected()) {
                        var droppedElement = new GenericWorkflowDesigner.LibraryElementModel({ Title: ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_SlotGenerator_Title"), Tooltip: ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_LibraryTileStepTooltip"), Image: "", DataURI: "", Alt: ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_LibraryTileAltText"), FontIconImage: "", ActivityTypeID: "step" });
                        GenericWorkflowDesigner.SlotBase.supportedEvents.dropLibraryElement.trigger(self, self, droppedElement);
                    }
                    $("#globalbuttonAreaDiv").focus();
                    $("#globalbuttonAreaDiv").children(".slot.hoverOverDroppable").removeClass("hoverOverDroppable");
                    $("#globalbuttonAreaDiv").children(".slot.selected").removeClass("selected");
                    event.target.focus();
                    self.tileClickedHandler(event);
                });
                this.$el.on("dblclick", function (event) {
                    self.tileDblClickedHandler(event);
                });
                this.$el.on("mousedown", function (event) {
                    event.stopPropagation();
                });
                this.listenTo(activity, ActivityDefinitionModel.supportedEvents.select.name, self.selectHandler);
                this.listenTo(activity, ActivityDefinitionModel.supportedEvents.deselect.name, self.deSelectHandler);
                this.listenTo(activity, ActivityDefinitionModel.supportedEvents.paste.name, self.pasteHandler);
                this.listenTo(activity, ActivityDefinitionModel.supportedEvents.dragInProgress.name, self.dragInProgressHandler);
                this.listenTo(activity, ActivityDefinitionModel.supportedEvents.stopDragInProgress.name, self.stopDragInProgressHandler);
            };
            GlobalButtonHolderView.prototype.clean = function () {
                this.$el.children().remove();
            };
            GlobalButtonHolderView.prototype.GetProperties = function () {
                var result = {
                    template: '',
                    tileImageTemplate: '',
                    image: null,
                    alt: null,
                    tileclass: 'GlobalTile',
                    tooltipText: ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_Globalbutton_ToolTip"),
                    globalTitleText: this.globalTileTitle,
                    globalTileTemplate: '<span class="globalButtonSlot ellipsis" ><%- globalTitleText %><span>',
                    globalTileImageTemplate: ''
                };
                return result;
            };
            GlobalButtonHolderView.prototype.render = function () {
                this.clean();
                if (GenericWorkflowDesigner.currentModel != null && GenericWorkflowDesigner.currentModel.cid == this.model.getActivity().cid) {
                    this.$el.addClass(this.selectedClassName);
                }
                var properties = this.GetProperties();
                var globalTileDescriptionTemplate = _.template(properties.globalTileTemplate);
                this.$el.append(globalTileDescriptionTemplate(properties));
                this.$el.addClass(GlobalButtonHolderView.className);
                this.$el.attr('tabindex', GenericWorkflowDesigner.Settings.tabIndexValue);
                var calc = new GenericWorkflowDesigner.PositionCalculator(GenericWorkflowDesigner.Settings.layoutProperties);
                var top = calc.computeTop(this.model.getActivity().getRow());
                var left = calc.computeLeft(this.model.getActivity().getCol());
                this.$el.css("position", "");
                return this;
            };
            GlobalButtonHolderView.prototype.selectHandler = function () {
                this.$el.addClass(this.selectedClassName);
            };
            GlobalButtonHolderView.prototype.deSelectHandler = function () {
                this.$el.removeClass(this.selectedClassName);
            };
            GlobalButtonHolderView.prototype.pasteHandler = function () {
                GlobalButtonHolderView.supportedEvents.paste.trigger(this);
            };
            GlobalButtonHolderView.prototype.dragInProgressHandler = function () {
                this.$el.addClass(this.dragInProgressClass);
            };
            GlobalButtonHolderView.prototype.stopDragInProgressHandler = function () {
                this.$el.removeClass(this.dragInProgressClass);
            };
            GlobalButtonHolderView.prototype.tileClickedHandler = function (event) {
                var clickHandler = GenericWorkflowDesigner.Settings.slotHandlerProvider.createClickHandler(this.model);
                clickHandler.click(this.$el);
                GenericWorkflowDesigner.eventManager.trigger('activatePropertyTab');
                event.stopPropagation();
            };
            GlobalButtonHolderView.prototype.tileDblClickedHandler = function (event) {
                var dblClickHandler = GenericWorkflowDesigner.Settings.slotHandlerProvider.createDblClickHandler(this.model);
                dblClickHandler.dblclick(this.$el);
                event.stopPropagation();
            };
            GlobalButtonHolderView.prototype.allTilesSelected = function () {
                var arr = $("#globalbuttonAreaDiv").children(), i = 0;
                for (; i < arr.length; i = i + 1) {
                    var Tile = $($(arr[i]).children()).children();
                    if ($(arr[i]).hasClass("hoverOverDroppable") == false && Tile.hasClass("stageTile") == true) {
                        return false;
                    }
                }
                return true;
            };
            GlobalButtonHolderView.className = "globalButton";
            GlobalButtonHolderView.defaultDragHelperCursorOffset = 30;
            GlobalButtonHolderView.supportedEvents = {
                dropLibraryElement: GenericWorkflowDesigner.SlotBase.supportedEvents.dropLibraryElement,
                dropActivity: GenericWorkflowDesigner.SlotBase.supportedEvents.dropActivity,
                paste: {
                    name: "paste",
                    trigger: function (context) {
                        var self = context;
                        var eventName = GlobalButtonHolderView.supportedEvents.paste.name;
                        self.trigger(eventName);
                    }
                }
            };
            return GlobalButtonHolderView;
        })(GenericWorkflowDesigner.SlotBase);
        ProcessDesigner.GlobalButtonHolderView = GlobalButtonHolderView;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// <copyright file="GlobalWorkflowView.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        "use strict";
        var GlobalWorkflowView = (function (_super) {
            __extends(GlobalWorkflowView, _super);
            function GlobalWorkflowView() {
                _super.apply(this, arguments);
                this.selectedClassName = "selected";
                this.dragInProgressClass = "dragInProgress";
                this.globalTileTitle = GenericWorkflowDesigner.Settings.tileInformationFactory.GetLocalizedString("ProcessDesignerControl_BPF_GlobalWorkflow");
                this.globalWorkflowActivityName = GenericWorkflowDesigner.Settings.tileInformationFactory.GetLocalizedString("ProcessDesignerControl_BPF_Global_Workflow_Activity_Name");
                this._IsGlobalWorkflowAreaOpen = false;
            }
            GlobalWorkflowView.prototype.initialize = function () {
                var self = this;
                this._ButtonIcon = "Collapsed-symbol";
                this._globalAreaTemplate = _.template("<div id=\"globalbuttonAreaDiv\" class=\"globalButtonDiv\" title=\""
                    + GenericWorkflowDesigner.Settings.tileInformationFactory.GetLocalizedString("ProcessDesignerControl_BPF_WorkflowTooltip")
                    + "\">"
                    + "<table id= \"globalButtonAreaTable\" class=\"globalButtonAreaTable\">"
                    + "<tbody><tr id=\"globalbuttonArea\">"
                    + "<td id=\"globalWorkflowIcon\" style=\"height:30px; width: 15px\"><span class=\"CCFSymbolFont workflowSymbol global-fontIcons-size\"></span></td>"
                    + "<td id=\"globalWorkFlow\" class=\"globalButton\"> " + GenericWorkflowDesigner.Settings.tileInformationFactory.GetLocalizedString("ProcessDesignerControl_BPF_GlobalWorkflow") + " </td>"
                    + "<td id =\"globalWorkflowCount\"> </td>"
                    + "<td id=\"globalButtonVisibility\" class=\"globalButtonVisibility\">"
                    + "<button id=\"btnToggleButtons\" class=\"showHidebutton\" aria-expanded=\"false\" tabindex= \"" + GenericWorkflowDesigner.Settings.tabIndexValue + "\">"
                    + "<span id=\"spanToggleButtons\" class=\"CCFSymbolFont <%- this._ButtonIcon%> global-fontIcons-size \"></span>"
                    + "</button>"
                    + "</td>"
                    + "</tr>"
                    + "</tbody>"
                    + "</table>"
                    + "<div id=\"globalWorkflowListHolder\" class=\"globalWorkflowListHolder\">"
                    + "</div>"
                    + "</div>");
                $("#globalButtonArea").html("");
                $("#globalButtonArea").addClass("globalAreaDiv");
                this.workflows = (this.model.getActivity()).workflows;
                this._isVisible = false;
                this.setupEvents(this);
                this.makeDroppable();
                this._ToggleButtonsTemplate = _.template('<button id = \"btnToggleButtons\" class= \"showHidebutton\" title=\"' + GenericWorkflowDesigner.Settings.tileInformationFactory.GetLocalizedString("ProcessDesignerControl_BPF_GlobalAreaShowTooltip") + '\" aria-label=\"' + GenericWorkflowDesigner.Settings.tileInformationFactory.GetLocalizedString("ProcessDesignerControl_BPF_GlobalAreaShowTooltip") + '\"><span id=\"spanToggleButtons\" class=\"CCFSymbolFont <%- this._ButtonIcon%> global-fontIcons-size \" style=\"color:white;padding-top:4px;\"></span></button>');
                this._ToggleTemplate = _.template('<div id= \"globalButtonVisibility\" class= \"globalButtonVisibility\"> </div>');
                this.model.getActivity().on("change", this.renderStatus, this);
            };
            GlobalWorkflowView.prototype.renderStatus = function () {
                var activity = (this.model.getActivity());
                var statusView = GenericWorkflowDesigner.Settings.tileInformationFactory.GetTileStatusView(activity);
                this.$el.find(".tileError").remove();
                var errorMessageTile = statusView.render().$el;
                if (statusView instanceof GenericWorkflowDesigner.ErrorStatusView) {
                    var activityTypeId = activity.getActivityTypeID();
                    var title = errorMessageTile.attr("title").replace(activityTypeId, this.globalWorkflowActivityName);
                    var html = errorMessageTile.html().replace(activityTypeId, this.globalWorkflowActivityName);
                    errorMessageTile.attr("title", title);
                    errorMessageTile.html(html);
                }
                this.$el.append(errorMessageTile);
                if (!CommonTypes.Types.Object.isNullOrUndefined(this.$el.find(".tileError")[0])) {
                    var padding = 10;
                    this.$el.find(".tileError")[0].style.top = (this.$el.height() + padding) + "px";
                }
                if (typeof (activity) != "undefined" && (activity.getErrorCount() != 0 || activity.getWarningCount() != 0)) {
                    this.$el.addClass("errorTile");
                }
                else {
                    this.$el.removeClass("errorTile");
                }
            };
            GlobalWorkflowView.prototype.setupEvents = function (GlobalWorkflowView) {
                var self = this;
                var activity = this.model.getActivity();
                activity.on("sync", this.render, this);
                this.$el.on("click keypress", function (event) {
                    switch (ProcessDesigner.BPFToolBarView.addMode) {
                        case ProcessDesigner.BPFToolBarAddMode.AddWorkflow:
                            var droppedElement = new GenericWorkflowDesigner.LibraryElementModel({ Title: ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_SlotGenerator_Title"), Tooltip: ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_LibraryTileWorkflowTooltip"), Image: "", DataURI: "", Alt: ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_LibraryTileAltText"), FontIconImage: "", ActivityTypeID: "workflow" });
                            self.dropLibraryElementHandler(self, droppedElement);
                            ProcessDesigner.BPFToolBarView.addMode = ProcessDesigner.BPFToolBarAddMode.None;
                            break;
                        default:
                            ProcessDesigner.BPFToolBarView.addMode = ProcessDesigner.BPFToolBarAddMode.None;
                            break;
                    }
                });
                this.$el.on("dblclick", function (event) {
                    self.tileDblClickedHandler(event);
                });
                $("#libraryElementworkflow").draggable({
                    stop: function () {
                        $('#workflowList').children().remove("#global-workflow-placeholder");
                        $('#libraryElementworkflow').removeClass("selected");
                    }
                }).data("WorkflowView", GlobalWorkflowView);
                $("#libraryElementworkflow").on("dragstart", function (event) {
                    if ($("#globalWorkflowListHolder").css("visibility") == "visible") {
                        $('#workflowList').children().remove("#global-workflow-placeholder");
                        var placeHolderDiv = $("<div id='global-workflow-placeholder' tabindex=' " + GenericWorkflowDesigner.Settings.tabIndexValue + " '>+</div>");
                        $('#workflowList').append(placeHolderDiv);
                        document.getElementById("global-workflow-placeholder").scrollIntoView(false);
                        GlobalWorkflowView.makeWorkflowDroppable(GlobalWorkflowView);
                    }
                });
                $("#libraryElementworkflow").on("dragend", function (event) {
                    $('#workflowList').removeClass("hoverOverDroppable");
                    $('#workflowList').children().remove("#global-workflow-placeholder");
                });
                $("#libraryElementworkflow").on("drop", function (event) {
                    $('#workflowList').removeClass(".hoverOverDroppable");
                    $('#workflowList').children().remove("#global-workflow-placeholder");
                });
                $("#libraryElementworkflow").on("dragleave", function (event) {
                    $('#workflowList').removeClass("hoverOverDroppable");
                    $('#workflowList').children().remove("#global-workflow-placeholder");
                });
                $(document).on('AddButton', function (event, droppable) {
                    if (ProcessDesigner.BPFToolBarView.addMode == ProcessDesigner.BPFToolBarAddMode.AddWorkflow) {
                        if ($("#globalWorkflowListHolder").css("visibility") == "visible") {
                            $('#workflowList').children().remove("#global-workflow-placeholder");
                            var placeHolderDiv = $("<div id='global-workflow-placeholder' tabindex=' " + GenericWorkflowDesigner.Settings.tabIndexValue + " '>+</div>");
                            $('#workflowList').append(placeHolderDiv);
                            document.getElementById("global-workflow-placeholder").scrollIntoView(false);
                            GlobalWorkflowView.makeWorkflowDroppable(GlobalWorkflowView);
                            GlobalWorkflowView.makePlaceHolderClick(GlobalWorkflowView);
                            GlobalWorkflowView.makePlaceHolderNavigable();
                        }
                    }
                });
                this.listenTo(activity, ActivityDefinitionModel.supportedEvents.select.name, self.selectHandler);
                this.listenTo(activity, ActivityDefinitionModel.supportedEvents.deselect.name, self.deSelectHandler);
                this.listenTo(activity, ActivityDefinitionModel.supportedEvents.paste.name, self.pasteHandler);
                this.listenTo(activity, ActivityDefinitionModel.supportedEvents.dragInProgress.name, self.dragInProgressHandler);
                this.listenTo(activity, ActivityDefinitionModel.supportedEvents.stopDragInProgress.name, self.stopDragInProgressHandler);
                this.listenTo(self, GenericWorkflowDesigner.SlotBase.supportedEvents.dropLibraryElement.name, this.dropLibraryElementHandler);
                GenericWorkflowDesigner.eventManager.on(GenericWorkflowDesigner.FrameworkEvents.canvasRefresh, self.refresh, this);
            };
            GlobalWorkflowView.prototype.makeWorkflowDroppable = function (GlobalWorkflowView) {
                var self = GlobalWorkflowView;
                var activity = GlobalWorkflowView.model.getActivity();
                $("#global-workflow-placeholder").droppable({
                    cursor: 'default',
                    tolerance: 'pointer',
                    activate: function (event, ui) {
                        if (ui.draggable.attr("id") == GenericWorkflowDesigner.Library.libraryElementPrefix + ProcessDesigner.BPFActivityType.workflow) {
                            $(this).addClass("hoverOverDroppable");
                        }
                    },
                    deactivate: function (event, ui) {
                        if (ui.draggable.attr("id") == GenericWorkflowDesigner.Library.libraryElementPrefix + ProcessDesigner.BPFActivityType.workflow) {
                            $(this).removeClass("hoverOverDroppable");
                        }
                    },
                    over: function (event, ui) {
                        if (ui.draggable.attr("id") == GenericWorkflowDesigner.Library.libraryElementPrefix + ProcessDesigner.BPFActivityType.workflow) {
                            $(this).addClass("hoverOverDroppableHighlight");
                        }
                    },
                    out: function (event, ui) {
                        if (ui.draggable.attr("id") == GenericWorkflowDesigner.Library.libraryElementPrefix + ProcessDesigner.BPFActivityType.workflow) {
                            $(this).removeClass("hoverOverDroppableHighlight");
                        }
                    },
                    drop: function (event, ui, GlobalWorkflowView) {
                        if (ui.draggable.attr("id") == GenericWorkflowDesigner.Library.libraryElementPrefix + ProcessDesigner.BPFActivityType.workflow) {
                            var globalWorkflowView = $(ui.draggable).data("WorkflowView");
                            globalWorkflowView.dropWorkflowElementHandler(ui.draggable, globalWorkflowView);
                        }
                    }
                });
            };
            GlobalWorkflowView.prototype.dropWorkflowElementHandler = function (draggable, globalWorkflowView) {
                if (draggable.attr("id") == GenericWorkflowDesigner.Library.libraryElementPrefix + ProcessDesigner.BPFActivityType.workflow) {
                    var rootActivity = GenericWorkflowDesigner.Settings.activityDefinitionFactory.createActivity(ProcessDesigner.BPFActivityType.workflow);
                    var workflowActivity = rootActivity;
                    workflowActivity.isNewlyAdded = true;
                    var addModeName = ProcessDesigner.TelemetryEventReporter.GetAddModeNameForActivity(ProcessDesigner.BPFToolBarView.addMode);
                    ProcessDesigner.TelemetryEventReporter.ReportTileAddedTelemetryEvent(addModeName, workflowActivity.actionStepId, ProcessDesigner.BPFActivityType.workflow, "");
                    (globalWorkflowView.model.getActivity()).workflows.push(workflowActivity);
                    globalWorkflowView.workflows = (globalWorkflowView.model.getActivity()).workflows;
                    globalWorkflowView.render();
                    var lastWorkflowId = $("#globalWorkflowListHolder").find(".workflow-item").last().attr("id");
                    document.getElementById(lastWorkflowId).scrollIntoView(false);
                    $("#" + lastWorkflowId).focus();
                    $("#" + lastWorkflowId).click();
                    $('#workflowList').children().remove("#global-workflow-placeholder");
                    $('#triggeredProcessList').children().remove(".place-holder-listitem");
                    $('#libraryElementworkflow').removeClass("selected");
                    $("#globalButtonArea").find(".ui-droppable").removeClass("hoverOverDroppable");
                    $("#globalButtonArea").find(".ui-droppable").removeClass("hoverOverDroppableHighlight");
                }
            };
            GlobalWorkflowView.prototype.dropLibraryElementHandler = function (slot, libraryElement) {
                var rootActivity = GenericWorkflowDesigner.Settings.activityDefinitionFactory.createActivity(libraryElement.get("ActivityTypeID"));
                var stopwatch = new GenericWorkflowDesigner.Stopwatch();
                stopwatch.start();
                if (rootActivity.getActivityTypeID() == ProcessDesigner.BPFActivityType.workflow) {
                    var workflowActivity = rootActivity;
                    workflowActivity.isNewlyAdded = true;
                    var addModeName = ProcessDesigner.TelemetryEventReporter.GetAddModeNameForActivity(ProcessDesigner.BPFToolBarView.addMode);
                    ProcessDesigner.TelemetryEventReporter.ReportTileAddedTelemetryEvent(addModeName, workflowActivity.actionStepId, ProcessDesigner.BPFActivityType.workflow, "");
                    (this.model.getActivity()).workflows.push(workflowActivity);
                    this.workflows = (this.model.getActivity()).workflows;
                    this.render();
                    this._isVisible = false;
                    this.toggleButtons();
                    var lastWorkflowId = $("#globalWorkflowListHolder").find(".workflow-item").last().attr("id");
                    document.getElementById(lastWorkflowId).scrollIntoView(false);
                    $("#" + lastWorkflowId).focus();
                    $("#" + lastWorkflowId).click();
                    $("#globalButtonArea").find(".ui-droppable").removeClass("hoverOverDroppable");
                    $("#globalButtonArea").find(".ui-droppable").removeClass("hoverOverDroppableHighlight");
                    $('#workflowList').children().remove("#global-workflow-placeholder");
                    $('#triggeredProcessList').children().remove(".place-holder-listitem");
                    GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.clearSelections);
                    GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.editDone);
                    GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.runValidation);
                }
                stopwatch.stop();
                localStorage.setItem("PerfMarker_" + libraryElement.attributes.Title + "Drop", stopwatch.elapsedMilliseconds.toString());
            };
            GlobalWorkflowView.prototype.makePlaceHolderClick = function (globalWorkflowView) {
                $("#global-workflow-placeholder").on("click keypress", function (event) {
                    event.stopPropagation();
                    if (ProcessDesigner.BPFToolBarView.addMode == ProcessDesigner.BPFToolBarAddMode.AddWorkflow) {
                        var rootActivity = GenericWorkflowDesigner.Settings.activityDefinitionFactory.createActivity(ProcessDesigner.BPFActivityType.workflow);
                        var workflowActivity = rootActivity;
                        workflowActivity.isNewlyAdded = true;
                        var addModeName = ProcessDesigner.TelemetryEventReporter.GetAddModeNameForActivity(ProcessDesigner.BPFToolBarView.addMode);
                        ProcessDesigner.TelemetryEventReporter.ReportTileAddedTelemetryEvent(addModeName, workflowActivity.actionStepId, ProcessDesigner.BPFActivityType.workflow, "");
                        (globalWorkflowView.model.getActivity()).workflows.push(workflowActivity);
                        globalWorkflowView.workflows = (globalWorkflowView.model.getActivity()).workflows;
                        globalWorkflowView.render();
                        var lastWorkflowId = $("#globalWorkflowListHolder").find(".workflow-item").last().attr("id");
                        document.getElementById(lastWorkflowId).scrollIntoView(false);
                        $("#" + lastWorkflowId).focus();
                        $("#" + lastWorkflowId).click();
                        $('#workflowList').children().remove("#global-workflow-placeholder");
                        $('#triggeredProcessList').children().remove(".place-holder-listitem");
                        $('#libraryElementworkflow').removeClass("selected");
                        $("#globalButtonArea").find(".ui-droppable").removeClass("hoverOverDroppable");
                        $("#globalButtonArea").find(".ui-droppable").removeClass("hoverOverDroppableHighlight");
                        ProcessDesigner.BPFToolBarView.addMode = ProcessDesigner.BPFToolBarAddMode.None;
                        $("#canvas").children(".hoverOverDroppable").removeClass("hoverOverDroppable");
                    }
                });
            };
            GlobalWorkflowView.prototype.makePlaceHolderNavigable = function () {
                $("#global-workflow-placeholder").on("keydown", function (event) {
                    if (event.keyCode == 40) {
                        $(".step-list-listitem.selected").removeClass("selected");
                        $(event.target.nextSibling).focus();
                        $(event.target.nextSibling).addClass("selected");
                    }
                    if (event.keyCode == 38) {
                        if (event.target.previousSibling == null) {
                            $("#" + ProcessDesigner.ControlManager.GetStageModel(GenericWorkflowDesigner.currentModel).getActivityID()).focus();
                        }
                        else {
                            $(event.target.previousSibling).focus();
                            $(event.target.previousSibling).addClass("selected");
                        }
                    }
                    event.stopImmediatePropagation();
                });
            };
            GlobalWorkflowView.prototype.clean = function () {
                this.$el.children().remove();
            };
            GlobalWorkflowView.prototype.GetProperties = function () {
                var result = {
                    template: '',
                    tileImageTemplate: '',
                    image: null,
                    alt: null,
                    tileclass: 'GlobalTile',
                    tooltipText: ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_Globalbutton_ToolTip"),
                    globalTitleText: this.globalTileTitle,
                    globalTileTemplate: '<span class="globalButtonSlot ellipsis" ><%- globalTitleText %><span>',
                    globalTileImageTemplate: ''
                };
                return result;
            };
            GlobalWorkflowView.prototype.toggleButtons = function () {
                if (this.workflows.length > 0) {
                    if (this._isVisible) {
                        this._isVisible = false;
                        this._ButtonIcon = "Collapsed-symbol";
                        $("#globalButtonVisibility").html('');
                        this._ToggleButtonsTemplate = _.template('<button id = \"btnToggleButtons\" class= \"showHidebutton\" title=\"' + GenericWorkflowDesigner.Settings.tileInformationFactory.GetLocalizedString("ProcessDesignerControl_BPF_GlobalAreaShowTooltip") + '\" aria-label=\"' + GenericWorkflowDesigner.Settings.tileInformationFactory.GetLocalizedString("ProcessDesignerControl_BPF_GlobalAreaShowTooltip") + '\"><span id=\"spanToggleButtons\" class=\"CCFSymbolFont <%- this._ButtonIcon%> global-fontIcons-size \" style=\"color:white;padding-top:4px;\"></span></button>');
                        $("#globalButtonVisibility").append(this._ToggleButtonsTemplate());
                        $("#globalWorkflowListHolder").css('visibility', 'hidden');
                        $("#globalWorkflowListHolder").hide();
                        $("#globalButtonVisibility").css("height", "32px");
                        $("#globalButtonVisibility").css("margin-top", "0px");
                        $("#spanToggleButtons").css("padding-top", "4px");
                        $("#btnToggleButtons").attr("aria-expanded", "false");
                        $("#btnToggleButtons").focus();
                    }
                    else {
                        this._isVisible = true;
                        this._ButtonIcon = "Expanded-symbol";
                        $("#globalButtonVisibility").html('');
                        this._ToggleButtonsTemplate = _.template('<button id = \"btnToggleButtons\" class= \"showHidebutton\" title=\"' + GenericWorkflowDesigner.Settings.tileInformationFactory.GetLocalizedString("ProcessDesignerControl_BPF_GlobalAreaHideTooltip") + '\" aria-label=\"' + GenericWorkflowDesigner.Settings.tileInformationFactory.GetLocalizedString("ProcessDesignerControl_BPF_GlobalAreaHideTooltip") + '\"><span id=\"spanToggleButtons\" class=\"CCFSymbolFont <%- this._ButtonIcon%> global-fontIcons-size \" style=\"color:white;padding-top:4px;\"></span></button>');
                        $("#globalButtonVisibility").append(this._ToggleButtonsTemplate());
                        $("#btnToggleButtons").attr("aria-expanded", "true");
                        $("#globalButtonVisibility").css("height", "24px");
                        $("#globalButtonVisibility").css("margin-top", "3px");
                        $("#spanToggleButtons").css("padding-top", "0px");
                        $("#globalWorkflowListHolder").css('visibility', 'visible');
                        $("#globalWorkflowListHolder").show();
                        $("#globalWorkflowListHolder").find(".workflow-item").first().focus();
                        var self = this;
                        $("#globalWorkflowListHolder .workflow-item").on("keydown", function (event) {
                            if (event.keyCode == 27 || event.keyCode == 9) {
                                self._isVisible = true;
                                self.toggleButtons();
                            }
                        });
                    }
                }
            };
            GlobalWorkflowView.prototype.refresh = function () {
                var liIndex = -1;
                if ($("#workflowList").find(".selected").size() > 0) {
                    var liId = "#" + $("#workflowList").find(".selected")[0].id;
                    var liElement = $("#workflowList").find(liId);
                    liIndex = $("#workflowList").find("li").index(liElement);
                }
                this.render();
                if (this._isVisible) {
                    if (liIndex != -1 && ($("#workflowList").get(liIndex) != null) && ($("#workflowList").get(liIndex).id == liId))
                        $("#workflowList").find("li").get(liIndex).focus();
                    else {
                        if (this.workflows.length > 0)
                            this.toggleButtons();
                        this._isVisible = false;
                        this._ButtonIcon = "Collapsed-symbol";
                        $("#globalButtonVisibility").html('');
                        $("#globalButtonVisibility").append(this._ToggleButtonsTemplate());
                        $("#globalWorkflowListHolder").css('visibility', 'hidden');
                        $("#globalWorkflowListHolder").hide();
                    }
                }
            };
            GlobalWorkflowView.prototype.render = function () {
                this.clean();
                var self = this;
                this.workflows = (this.model.getActivity()).workflows;
                this.$el.append(this._globalAreaTemplate());
                this.$el.css("width", "100%");
                this.$el.css("height", "100%");
                $("#globalButtonArea").append(this.$el);
                var ulElement = "<ul id=\"workflowList\" aria-live=\"polite\" aria-relevant=\"additions removals\"></ul>";
                $("#globalWorkflowListHolder").append(ulElement);
                $("#globalWorkflowCount").append("<span> (" + this.workflows.length + ") </span>");
                for (var i = 0; i < this.workflows.length; i++) {
                    var actionStep = this.workflows[i];
                    var actionStepId = actionStep.actionStepId;
                    var listLi = $("<li tabindex='-1' id='" + actionStepId + "'></li>");
                    var index = i;
                    var elem1 = new ProcessDesigner.EditWorkflowView(actionStep, $(listLi));
                    elem1.render();
                    $("#workflowList").append(elem1.el);
                }
                if (!this._isVisible) {
                    $("#globalWorkflowListHolder").hide();
                    this._isVisible = false;
                }
                $("#globalButtonVisibility").on("click", function (event) {
                    self.toggleButtons();
                });
                return this;
            };
            GlobalWorkflowView.prototype.selectHandler = function () {
                this.$el.addClass(this.selectedClassName);
            };
            GlobalWorkflowView.prototype.deSelectHandler = function () {
                this.$el.removeClass(this.selectedClassName);
            };
            GlobalWorkflowView.prototype.pasteHandler = function () {
                ProcessDesigner.GlobalButtonHolderView.supportedEvents.paste.trigger(this);
            };
            GlobalWorkflowView.prototype.dragInProgressHandler = function () {
                this.$el.addClass(this.dragInProgressClass);
            };
            GlobalWorkflowView.prototype.stopDragInProgressHandler = function () {
                this.$el.removeClass(this.dragInProgressClass);
            };
            GlobalWorkflowView.prototype.tileClickedHandler = function (event) {
                var clickHandler = GenericWorkflowDesigner.Settings.slotHandlerProvider.createClickHandler(this.model);
                clickHandler.click(this.$el);
                GenericWorkflowDesigner.eventManager.trigger('activatePropertyTab');
                event.stopPropagation();
            };
            GlobalWorkflowView.prototype.tileDblClickedHandler = function (event) {
                var dblClickHandler = GenericWorkflowDesigner.Settings.slotHandlerProvider.createDblClickHandler(this.model);
                dblClickHandler.dblclick(this.$el);
                event.stopPropagation();
            };
            GlobalWorkflowView.prototype.allTilesSelected = function () {
                var arr = $("#globalbuttonAreaDiv").children(), i = 0;
                for (; i < arr.length; i = i + 1) {
                    var Tile = $($(arr[i]).children()).children();
                    if ($(arr[i]).hasClass("hoverOverDroppable") == false && Tile.hasClass("stageTile") == true) {
                        return false;
                    }
                }
                return true;
            };
            GlobalWorkflowView.className = "globalButton";
            GlobalWorkflowView.defaultDragHelperCursorOffset = 30;
            GlobalWorkflowView.supportedEvents = {
                dropLibraryElement: GenericWorkflowDesigner.SlotBase.supportedEvents.dropLibraryElement,
                dropActivity: GenericWorkflowDesigner.SlotBase.supportedEvents.dropActivity,
                paste: {
                    name: "paste",
                    trigger: function (context) {
                        var self = context;
                        var eventName = ProcessDesigner.GlobalButtonHolderView.supportedEvents.paste.name;
                        self.trigger(eventName);
                    }
                },
            };
            return GlobalWorkflowView;
        })(GenericWorkflowDesigner.SlotBase);
        ProcessDesigner.GlobalWorkflowView = GlobalWorkflowView;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
//---------------------------------------------------------------------------------------------
// <copyright file="ActionArgumentsView.ts" company="Microsoft">
//		Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>;
//
// <summary>
// Action Arguments View
// </summary>
//---------------------------------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        "use strict";
        var ActionArgumentsView = (function (_super) {
            __extends(ActionArgumentsView, _super);
            function ActionArgumentsView(options) {
                _super.call(this, options);
                this.template = _.template("<% id = \"ActionStepPropertyDetails_\" + ArgumentName %><span class=\"headline2 ellipsis\" role= \"label\" id= \"<%- id + '_field' %>\" style=\"margin-bottom:5px;\" title= \"<%- ArgumentName %>\" > <%- ArgumentName %></span><div class=\"prop-exp-column-input\" ><select id=\"<%- id + '_attribute' %>\" class=\"prop-exp-input headline4\" aria-labelledby=\"<%- id + '_field' %>\" role= \"combobox\" ><option></option><% _.each(AttributeList, function (value) { %><option value=\"<%- value.logicalName %>\" <%- ArgumentAttributeName == value.logicalName ? 'selected' : '' %>> <%- value.displayName %> </option><% }); %></select></div>");
                _.bindAll(this);
                this.model.bind('changeEvent', this.render, this);
                this.model.bind('destroy', this.remove, this);
                ActionArgumentsView.self = this;
            }
            ActionArgumentsView.prototype.initialize = function () {
                this.tagName = 'div';
            };
            ActionArgumentsView.prototype.render = function () {
                var self = this;
                self.$el
                    .html(self.template(this.model))
                    .addClass('prop-expression');
                self.setToolTips();
                self.setTabIndex();
                return this.$el;
            };
            ActionArgumentsView.prototype.setToolTips = function () {
                var selectedOption = this.$el.find('select option:selected');
                if (!CommonTypes.Types.Object.isNullOrUndefined(selectedOption)) {
                    this.$el.attr('title', selectedOption.html());
                }
            };
            ActionArgumentsView.prototype.setTabIndex = function () {
                $("select").attr('tabindex', ProcessDesigner.Util.tabIndexValue);
            };
            ActionArgumentsView.refreshErrorMessages = function () {
                var model = GenericWorkflowDesigner.PropertyView.getPropertyViewCurrentModel();
                if (model == "" || model == undefined || model == null)
                    return;
                if (model.getErrorCount() > 0) {
                    ProcessDesigner.DOMUtil.renderPropertyPageLevelErrorMessages(model, $("#properties-panel"), model.getErrorMessages());
                    model._conditionExpression.forEach(function (exp, idx) {
                        ProcessDesigner.DOMUtil.renderErrorMessages(exp, ActionArgumentsView.self.$el, exp.getErrorMessages());
                    });
                }
                else {
                    ProcessDesigner.DOMUtil.renderPropertyPageLevelErrorMessages(model, $("#properties-panel"), model.getErrorMessages());
                    ProcessDesigner.DOMUtil.renderErrorMessages(ActionArgumentsView.self.model, ActionArgumentsView.self.$el, ActionArgumentsView.self.model.getErrorMessages());
                }
            };
            return ActionArgumentsView;
        })(Backbone.View);
        ProcessDesigner.ActionArgumentsView = ActionArgumentsView;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// -----------------------------------------------------------------------
// <copyright file="ActionStepPropertyView.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
/// <reference path="../../../../Common/Rules.ts"/>
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        var Validation = MscrmControls.ProcessDesigner.Validation;
        "use strict";
        var ActionStepPropertyView = (function (_super) {
            __extends(ActionStepPropertyView, _super);
            function ActionStepPropertyView(model, baseUrl) {
                _super.call(this, { model: model });
                this.baseUrl = '';
                this.className = "property-page";
                this.loaderPanelName = "stepProperty";
                this.baseUrl = baseUrl;
            }
            ActionStepPropertyView.prototype.isInlinePropertyPage = function () {
                return true;
            };
            ActionStepPropertyView.prototype.getPropertyPageUrl = function (activeItem) {
                return this.baseUrl;
            };
            ActionStepPropertyView.prototype.getContainerElementName = function () {
                return this.loaderPanelName;
            };
            ActionStepPropertyView.prototype.getClassName = function () {
                return this.className;
            };
            ActionStepPropertyView.prototype.unloadHandler = function () {
                Validation.Errors.propertyTabUnloaded();
            };
            ActionStepPropertyView.prototype.render = function () {
                _super.prototype.render.call(this);
                this.renderActionArguments();
                return this.$el;
            };
            ActionStepPropertyView.prototype.renderActionArguments = function () {
                var currentModel = this.model;
                for (var icnt = 0; icnt < currentModel.InputArguments.length; icnt++) {
                    this.$el.find('#inputParameterContainer').append(new ProcessDesigner.ActionArgumentsView({ model: currentModel.InputArguments[icnt] }).render());
                }
                for (var ocnt = 0; ocnt < currentModel.OutputArguments.length; ocnt++) {
                    this.$el.find('#outputParameterContainer').append(new ProcessDesigner.ActionArgumentsView({ model: currentModel.OutputArguments[ocnt] }).render());
                }
            };
            return ActionStepPropertyView;
        })(GenericWorkflowDesigner.BasePropertyView);
        ProcessDesigner.ActionStepPropertyView = ActionStepPropertyView;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// -----------------------------------------------------------------------
// <copyright file="FlowStepPropertyView.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
/// <reference path="../../../../Common/Rules.ts"/>
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        var Validation = MscrmControls.ProcessDesigner.Validation;
        "use strict";
        var FlowStepPropertyView = (function (_super) {
            __extends(FlowStepPropertyView, _super);
            function FlowStepPropertyView(model, baseUrl) {
                _super.call(this, { model: model });
                this.baseUrl = '';
                this.className = "property-page";
                this.loaderPanelName = "stepProperty";
                this.baseUrl = baseUrl;
            }
            FlowStepPropertyView.prototype.isInlinePropertyPage = function () {
                return true;
            };
            FlowStepPropertyView.prototype.getPropertyPageUrl = function (activeItem) {
                return this.baseUrl;
            };
            FlowStepPropertyView.prototype.getContainerElementName = function () {
                return this.loaderPanelName;
            };
            FlowStepPropertyView.prototype.getClassName = function () {
                return this.className;
            };
            FlowStepPropertyView.prototype.unloadHandler = function () {
                Validation.Errors.propertyTabUnloaded();
            };
            return FlowStepPropertyView;
        })(GenericWorkflowDesigner.BasePropertyView);
        ProcessDesigner.FlowStepPropertyView = FlowStepPropertyView;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// -----------------------------------------------------------------------
// <copyright file="BranchPropertyView.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
/// <reference path="../../../../Common/Rules.ts"/>
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        var Validation = MscrmControls.ProcessDesigner.Validation;
        "use strict";
        var BranchPropertyView = (function (_super) {
            __extends(BranchPropertyView, _super);
            function BranchPropertyView(model, baseUrl) {
                _super.call(this, { model: model });
                this.baseUrl = "";
                this.className = "property-page";
                this.loaderPanelName = "branchProperty";
                this.baseUrl = baseUrl;
            }
            BranchPropertyView.prototype.isInlinePropertyPage = function () {
                return true;
            };
            BranchPropertyView.prototype.getPropertyPageUrl = function (activeItem) {
                return this.baseUrl;
            };
            BranchPropertyView.prototype.getContainerElementName = function () {
                return this.loaderPanelName;
            };
            BranchPropertyView.prototype.getClassName = function () {
                return this.className;
            };
            BranchPropertyView.prototype.unloadHandler = function () {
                Validation.Errors.propertyTabUnloaded();
                var ControlRoot = MscrmControls;
            };
            return BranchPropertyView;
        })(GenericWorkflowDesigner.BasePropertyView);
        ProcessDesigner.BranchPropertyView = BranchPropertyView;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// -----------------------------------------------------------------------
// <copyright file="StagePropertyView.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
/// <reference path="../../../../Common/Rules.ts"/>
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        var Validation = MscrmControls.ProcessDesigner.Validation;
        "use strict";
        var StagePropertyView = (function (_super) {
            __extends(StagePropertyView, _super);
            function StagePropertyView(model, baseUrl) {
                _super.call(this, { model: model });
                this.className = "property-page";
                this.loaderPanelName = "stageProperty";
                this.baseUrl = baseUrl;
            }
            StagePropertyView.prototype.isInlinePropertyPage = function () {
                return true;
            };
            StagePropertyView.prototype.getPropertyPageUrl = function (activeItem) {
                return this.baseUrl;
            };
            StagePropertyView.prototype.getContainerElementName = function () {
                return this.loaderPanelName;
            };
            StagePropertyView.prototype.getClassName = function () {
                return this.className;
            };
            StagePropertyView.prototype.unloadHandler = function () {
                Validation.Errors.propertyTabUnloaded();
            };
            return StagePropertyView;
        })(GenericWorkflowDesigner.BasePropertyView);
        ProcessDesigner.StagePropertyView = StagePropertyView;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// -----------------------------------------------------------------------
// <copyright file="StepPropertyView.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
/// <reference path="../../../../Common/Rules.ts"/>
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        var Validation = MscrmControls.ProcessDesigner.Validation;
        "use strict";
        var StepPropertyView = (function (_super) {
            __extends(StepPropertyView, _super);
            function StepPropertyView(model, baseUrl) {
                _super.call(this, { model: model });
                this.baseUrl = '';
                this.className = "property-page";
                this.loaderPanelName = "stepProperty";
                this.baseUrl = baseUrl;
            }
            StepPropertyView.prototype.isInlinePropertyPage = function () {
                return true;
            };
            StepPropertyView.prototype.getPropertyPageUrl = function (activeItem) {
                return this.baseUrl;
            };
            StepPropertyView.prototype.getContainerElementName = function () {
                return this.loaderPanelName;
            };
            StepPropertyView.prototype.getClassName = function () {
                return this.className;
            };
            StepPropertyView.prototype.unloadHandler = function () {
                Validation.Errors.propertyTabUnloaded();
            };
            return StepPropertyView;
        })(GenericWorkflowDesigner.BasePropertyView);
        ProcessDesigner.StepPropertyView = StepPropertyView;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// -----------------------------------------------------------------------
// <copyright file="WorkflowPropertyView.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
/// <reference path="../../../../Common/Rules.ts"/>
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        var Validation = MscrmControls.ProcessDesigner.Validation;
        "use strict";
        var WorkflowPropertyView = (function (_super) {
            __extends(WorkflowPropertyView, _super);
            function WorkflowPropertyView(model, baseUrl) {
                _super.call(this, { model: model });
                this.baseUrl = '';
                this.className = "property-page";
                this.loaderPanelName = "workflowProperty";
                this.baseUrl = baseUrl;
            }
            WorkflowPropertyView.prototype.isInlinePropertyPage = function () {
                return true;
            };
            WorkflowPropertyView.prototype.getPropertyPageUrl = function (activeItem) {
                return this.baseUrl;
            };
            WorkflowPropertyView.prototype.getContainerElementName = function () {
                return this.loaderPanelName;
            };
            WorkflowPropertyView.prototype.getClassName = function () {
                return this.className;
            };
            WorkflowPropertyView.prototype.unloadHandler = function () {
                Validation.Errors.propertyTabUnloaded();
            };
            return WorkflowPropertyView;
        })(GenericWorkflowDesigner.BasePropertyView);
        ProcessDesigner.WorkflowPropertyView = WorkflowPropertyView;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        "use strict";
        var StepListView = (function (_super) {
            __extends(StepListView, _super);
            function StepListView(stageModel, tileContainer) {
                var detailsDiv = $("<div class='stage-detail-container-div'></div>");
                _super.call(this, {
                    model: stageModel,
                    el: detailsDiv
                });
                this.parent = tileContainer;
                this.stageDetailsDiv = detailsDiv;
                this.stepViews = [];
                this.steps = this.model.steps;
                this.workflows = this.model.workflows;
                this.keyMap = { 17: false, 18: false, 78: false, 83: false, 87: false };
                this.render();
                this.attachEventHandlers(this);
            }
            StepListView.prototype.initialize = function () {
                var self = this;
            };
            StepListView.prototype.render = function () {
                $(".stage-detail-container-div").remove();
                var steps = this.model.steps;
                var workflows = this.model.workflows;
                $(".tileButtonDiv").removeClass("selected");
                $(".stageTile").removeClass("selected");
                $(".conditionTile").removeClass("selected");
                this.parent.children().children().addClass("selected");
                var div = $("<div class='stage-detail-container' tabindex='-1' id='" + ProcessDesigner.ElementPrefixes.DetailsPrefix + this.model.getActivityID() + "'></div>");
                div.css("width", this.parent[0].clientWidth + "px");
                div.addClass("selected");
                this.parent.find(".stage-detail-container").remove();
                this.$el.append(div);
                this.parent.append(this.$el);
                this.addStepListContainer($(div));
                this.addTriggeredProcessContainer($(div));
                this.setScrollbar($(this.stageDetailsDiv));
                this.openNewlyAddedStep(steps);
                this.openNewlyAddedWorkflow(workflows);
                this.$el.find(".stage-detail-container").addClass("selected");
                var element = $("#libraryElementstep");
                var containers = [$("#canvas"), $(".stage-detail-container-div .list-container-div")];
                var scrollableOptionsCanvas = {
                    step: 20,
                    timer: 25,
                    scrollTriggerMargin: 180
                };
                var scrollableOptionsStepList = {
                    step: 20,
                    timer: 25,
                    scrollTriggerMargin: 60,
                    scrollableHorizontal: false
                };
                var scrollableOptions = [scrollableOptionsCanvas, scrollableOptionsStepList];
                var self = this;
                var draggableOptions = {
                    start: function (event, ui) {
                        element.addClass("selected");
                    },
                    stop: function (event, ui) {
                        element.removeClass("selected");
                    }
                };
                var stepDragDropHelper = new GenericWorkflowDesigner.ScrollableDragDropExtended();
                stepDragDropHelper.makeDraggable(element, containers, draggableOptions, scrollableOptions);
                return this;
            };
            StepListView.prototype.remove = function () {
                this.steps = null;
                this.workflows = null;
                this.model = null;
                _super.prototype.remove.call(this);
            };
            StepListView.prototype.renderSteps = function () {
                for (var i = 0; i < this.stepViews.length; i++)
                    this.stepViews[i].render();
            };
            StepListView.prototype.deleteStepListView = function () {
                this.removeEventHandlers(this);
                this.remove();
            };
            StepListView.prototype.openNewlyAddedStep = function (steps) {
                for (var i = 0; i < this.steps.length; i++) {
                    var step = steps[i];
                    if (step.isNewlyAdded && ProcessDesigner.ControlManager.isNewStepAdded) {
                        step.isNewlyAdded = false;
                        ProcessDesigner.ControlManager.isNewStepAdded = false;
                        $("#" + step.stepId)[0].scrollIntoView(false);
                        $("#" + step.stepId).click();
                        $("#" + step.stepId).focus();
                        this.attachKeyDownEventForStepListItem(this);
                        this.enableDisableArrowButtons(this);
                    }
                    var errcount = step.getErrorCount();
                    var stp = step;
                    if (errcount > 0) {
                        $("#" + stp.stepId).find(".subViewTileError").css("visibility", "visible");
                    }
                    else {
                        $("#" + stp.stepId).find(".subViewTileError").css("visibility", "hidden");
                    }
                }
            };
            StepListView.prototype.openNewlyAddedWorkflow = function (workflows) {
                for (var i = 0; i < this.workflows.length; i++) {
                    var workflow = workflows[i];
                    if (workflow.isNewlyAdded && ProcessDesigner.ControlManager.isNewActionStepAdded) {
                        workflow.isNewlyAdded = false;
                        ProcessDesigner.ControlManager.isNewActionStepAdded = false;
                        this.attachKeyDownEventForStepListItem(this);
                        $("#" + workflow.actionStepId)[0].scrollIntoView(false);
                        $("#" + workflow.actionStepId).click();
                        $("#" + workflow.actionStepId).focus();
                    }
                    var errcount = workflow.getErrorCount();
                    var workflw = workflow;
                    if (errcount > 0) {
                        $("#" + workflw.actionStepId).find(".subViewTileError").css("visibility", "visible");
                    }
                    else {
                        $("#" + workflw.actionStepId).find(".subViewTileError").css("visibility", "hidden");
                    }
                }
            };
            StepListView.prototype.addStepListContainer = function (parentDiv) {
                var stepListContainerDiv = $('<div class="list-container-div"></div>');
                var listUl = $('<ul id="sortable" class="editview-step-list" aria-live=\"polite\" aria-relevant=\"additions removals\"></ul>');
                var stepDiv = $('<span class="step-detail-div"></span>');
                if (this.steps == null) {
                    return this;
                }
                $(parentDiv).find('list-container-div').remove();
                var titleForStepHeader = ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_WorkFlow_StepCount") + " " + this.steps.length;
                this.stepCount = _.template(" <div id=\"step-Count-Wrapper\" class=\" stepCountWrapper\" title=\"" + titleForStepHeader + "\"><span id=\"toggleStep\" class=\"CCFSymbolFont ExpandList-symbol\"></span><span class=\"seeDetailsStepLabel canvasAreaTileTitle6 truncateString\">" + ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_Steps") + " (" + this.steps.length + ")</span><span id=\"DownArrow\" class=\"CCFSymbolFont DownArrow-symbol\"></span><span id=\"UpArrow\" class=\"CCFSymbolFont UpArrow-symbol\"></span></div> ");
                $(stepDiv).append(this.stepCount);
                $(stepListContainerDiv).append(stepDiv);
                $(stepDiv).append(listUl);
                for (var i = 0; i < this.steps.length; i++) {
                    var step = this.steps[i];
                    var stepId = step.stepId;
                    this.steps[i].sequence = i + 1;
                    var listLi = $("<li class='step-list-listitem' tabindex='-1' id='" + stepId + "'></li>");
                    var elem1 = null;
                    switch (step.getActivityTypeID()) {
                        case ProcessDesigner.BPFActivityType.step:
                            elem1 = new ProcessDesigner.EditStepView(step, $(listLi));
                            elem1.render();
                            break;
                        case ProcessDesigner.BPFActivityType.action:
                            elem1 = new ProcessDesigner.EditActionStepView(step, $(listLi));
                            elem1.render();
                            break;
                        case ProcessDesigner.BPFActivityType.flow:
                            elem1 = new ProcessDesigner.EditFlowStepView(step, $(listLi));
                            elem1.render();
                            break;
                    }
                    if (!CommonTypes.Types.Object.isNullOrUndefined(elem1)) {
                        this.stepViews.push(elem1);
                        $(listUl).append(elem1.el);
                    }
                }
                $(parentDiv).append(stepListContainerDiv);
            };
            StepListView.prototype.addTriggeredProcessContainer = function (parentDiv) {
                var stepListContainerDiv = $('<div class="list-container-div" id="workflow-container"></div>');
                var listUl = $('<ul id="triggeredProcessList" class="editview-step-list" aria-live=\"polite\" aria-relevant=\"additions removals\"></ul>');
                var actionStepDiv = $('<span class="step-detail-div"></span>');
                if (this.workflows == null) {
                    return this;
                }
                var titleForWorkflowHeader = ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_WorkFlow_WorkflowCount") + " " + this.workflows.length;
                this.workflowCount = _.template("<div id=\"step-Count-Wrapper\" class=\"workflowCountWrapper\"  title=\"" + titleForWorkflowHeader + "\"><span id=\"toggleProcess\" class=\"CCFSymbolFont ExpandList-symbol\"></span><span class=\"seeDetailsTPLabel canvasAreaTileTitle6 truncateString\">" + ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_WorkFlows") + " (" + this.workflows.length + ")</span></div> ");
                $(actionStepDiv).append(this.workflowCount);
                $(stepListContainerDiv).append(actionStepDiv);
                $(actionStepDiv).append(listUl);
                for (var i = 0; i < this.workflows.length; i++) {
                    var actionStep = this.workflows[i];
                    var actionStepId = actionStep.actionStepId;
                    var listLi = $("<li class='workflow-list-listitem' tabindex='-1' id='" + actionStepId + "'></li>");
                    var elem1 = new ProcessDesigner.EditWorkflowView(actionStep, $(listLi));
                    elem1.render();
                    this.stepViews.push(elem1);
                    $(listUl).append(elem1.el);
                }
                $(parentDiv).append(stepListContainerDiv);
                if (this.workflows.length == 0) {
                    $("#workflow-Count-Wrapper").addClass("noWorkflow");
                }
            };
            StepListView.prototype.HandleCommonEvents = function (event, StepListView) {
                if (event.ctrlKey && event.altKey && event.keyCode == 67) {
                    ProcessDesigner.ControlManager.ClearSelections();
                    $("#libraryTab").children().focus();
                    $("#libraryTab").click();
                }
                else if (event.ctrlKey && event.altKey && event.keyCode == 80) {
                    ProcessDesigner.ControlManager.ClearSelections();
                    $("#propertyTab").children().focus();
                    GenericWorkflowDesigner.eventManager.trigger('activatePropertyTab');
                }
                if (event.keyCode == 83) {
                    if (event.keyCode in StepListView.keyMap) {
                        StepListView.keyMap[87] = false;
                        StepListView.keyMap[event.keyCode] = true;
                    }
                }
                else if (event.keyCode == 87) {
                    if (event.keyCode in StepListView.keyMap) {
                        StepListView.keyMap[83] = false;
                        StepListView.keyMap[event.keyCode] = true;
                    }
                }
                else if (StepListView.keyMap[83] && event.keyCode == 187) {
                    $("#toggleStep").click();
                    $("#" + ProcessDesigner.ControlManager.GetStageModel(GenericWorkflowDesigner.currentModel).getActivityID()).focus();
                }
                else if (StepListView.keyMap[87] && event.keyCode == 187) {
                    $("#toggleProcess").click();
                    $("#" + ProcessDesigner.ControlManager.GetStageModel(GenericWorkflowDesigner.currentModel).getActivityID()).focus();
                }
                else if (event.keyCode == 17) {
                    StepListView.keyMap[event.keyCode] = true;
                }
                else if (event.keyCode == 18) {
                    StepListView.keyMap[event.keyCode] = true;
                }
                else if (event.keyCode == 78) {
                    if (event.srcElement != undefined && $(event.srcElement).attr("type") != "text" && $(event.srcElement).attr("role") != "combobox" && $(event.srcElement).prop("tagName") != "TEXTAREA") {
                        if (StepListView.keyMap[17] && StepListView.keyMap[18]) {
                            StepListView.keyMap[17] = false;
                            StepListView.keyMap[18] = false;
                            ProcessDesigner.ControlManager.SetFunctionalityForButtonsWithShortcutKeys("#Add");
                        }
                    }
                }
                event.stopPropagation();
            };
            StepListView.prototype.attachKeyDownEventForStepListItem = function (StepListView) {
                $(".step-list-listitem").keydown(function (event) {
                    if (event.keyCode == 46) {
                        if (!$("#delete").prop("disabled")) {
                            ProcessDesigner.ControlManager.SetFunctionalityForButtonsWithShortcutKeys("#delete");
                        }
                    }
                    else if (event.keyCode == 40) {
                        if ($(event.target.nextSibling).length > 0) {
                            $(event.target).removeClass("selected");
                            $(event.target.nextSibling).focus();
                            $(event.target.nextSibling).addClass("selected");
                        }
                        else if (event.target.nextSibling == null && $(event.target).closest("div.list-container-div").next().find(".workflow-list-listitem").length > 0) {
                            $(event.target).removeClass("selected");
                            $(event.target).closest("div.list-container-div").next().find(".workflow-list-listitem").first().focus();
                            $(event.target).closest("div.list-container-div").next().find(".workflow-list-listitem").first().addClass("selected");
                        }
                        StepListView.enableDisableArrowButtons(StepListView);
                        event.stopPropagation();
                    }
                    else if (event.keyCode == 38) {
                        if (event.shiftKey) {
                            var currentStage = ProcessDesigner.ControlManager.GetStageModel(GenericWorkflowDesigner.currentModel);
                            var currentTileButtonName = ProcessDesigner.ElementPrefixes.TileButtonPrefix + currentStage.getActivityID();
                            var curretStageDetailsDivName = ProcessDesigner.ElementPrefixes.DetailsPrefix + currentStage.getActivityID();
                            if ($("#" + curretStageDetailsDivName) && $("#" + curretStageDetailsDivName).css("visibility") == "visible") {
                                $(currentTileButtonName).click();
                            }
                            $("#" + currentStage.id).focus();
                            GenericWorkflowDesigner.currentModel = currentStage;
                        }
                        else {
                            if ($(event.target.previousSibling).length > 0) {
                                $(event.target).removeClass("selected");
                                $(event.target.previousSibling).focus();
                                $(event.target.previousSibling).addClass("selected");
                            }
                            else if (event.target.previousSibling == null && $(event.target).closest("div.list-container-div").prev().find(".step-list-listitem").length > 0) {
                                $(event.target).removeClass("selected");
                                $(event.target).closest("div.list-container-div").prev().find(".step-list-listitem").last().focus();
                                $(event.target).closest("div.list-container-div").prev().find(".step-list-listitem").last().addClass("selected");
                            }
                            else {
                                $(event.target).removeClass("selected");
                                $(event.target).addClass("selected");
                                $(event.target).focus();
                            }
                            StepListView.enableDisableArrowButtons(StepListView);
                        }
                        event.stopPropagation();
                    }
                    else if (event.keyCode == 68) {
                        if (event.shiftKey) {
                            $("#DownArrow").click();
                        }
                        event.stopPropagation();
                    }
                    else if (event.keyCode == 85) {
                        if (event.shiftKey) {
                            $("#UpArrow").click();
                        }
                        event.stopPropagation();
                    }
                    else {
                        ProcessDesigner.ControlManager.SetShortcutKeysToMoveOnMajorAreas(event);
                    }
                    StepListView.HandleCommonEvents(event, StepListView);
                    event.stopImmediatePropagation();
                });
                $(".workflow-list-listitem").keydown(function (event) {
                    if (event.keyCode == 40) {
                        if ($(event.target.nextSibling).length > 0) {
                            $(event.target).removeClass("selected");
                            $(event.target.nextSibling).focus();
                            $(event.target.nextSibling).addClass("selected");
                        }
                        else {
                            $(event.target).removeClass("selected");
                            $(event.target).addClass("selected");
                            $(event.target).focus();
                        }
                    }
                    else if (event.keyCode == 38) {
                        if (event.shiftKey) {
                            var currentStage = ProcessDesigner.ControlManager.GetStageModel(GenericWorkflowDesigner.currentModel);
                            $("#" + currentStage.id).focus();
                            var currentTileButtonName = ProcessDesigner.ElementPrefixes.TileButtonPrefix + currentStage.getActivityID();
                            var curretStageDetailsDivName = ProcessDesigner.ElementPrefixes.DetailsPrefix + currentStage.getActivityID();
                            if ($("#" + curretStageDetailsDivName) && $("#" + curretStageDetailsDivName).css("visibility") == "visible") {
                                $(currentTileButtonName).click();
                            }
                        }
                        else {
                            if ($(event.target.previousSibling).length > 0) {
                                $(event.target).removeClass("selected");
                                $(event.target.previousSibling).focus();
                                $(event.target.previousSibling).addClass("selected");
                            }
                            else if (event.target.previousSibling == null && $(event.target).closest("div.list-container-div").prev().find(".step-list-listitem").length > 0) {
                                $(event.target).removeClass("selected");
                                $(event.target).closest("div.list-container-div").prev().find(".step-list-listitem").last().focus();
                                $(event.target).closest("div.list-container-div").prev().find(".step-list-listitem").last().addClass("selected");
                                StepListView.enableDisableArrowButtons(StepListView);
                            }
                        }
                    }
                    StepListView.HandleCommonEvents(event, StepListView);
                    event.stopImmediatePropagation();
                });
            };
            StepListView.prototype.attachEventHandlers = function (StepListView) {
                var self = this;
                $("#sortable").sortable({
                    placeholder: "ui-sortable-placeholder",
                    items: ">li",
                    start: function (event, ui) {
                        ui.helper.addClass("drag-in-progress-li");
                        $('#sortable').children('li.step-list-listitem:not(.drag-in-progress-li)').addClass("ondrag");
                        $('#step-Count-Wrapper').addClass("ondrag");
                    },
                    update: function (event, ui) {
                        $('#sortable').children('li.step-list-listitem:not(.drag-in-progress-li)').removeClass("ondrag");
                        $('#step-Count-Wrapper').removeClass("ondrag");
                        $('.drag-in-progress-li').removeClass("drag-in-progress-li");
                        StepListView.evaluateSteps(StepListView);
                        var tileId = $('li.selected').attr('id');
                        var parentTileId = StepListView.model.stageId;
                        ProcessDesigner.TelemetryEventReporter.ReportTileReorderedTelemetryEvent(tileId, ProcessDesigner.BPFActivityType.step, parentTileId, "Drag-Drop");
                        event.stopPropagation;
                    },
                    stop: function (event, ui) {
                        $('#sortable').children('li.step-list-listitem:not(.drag-in-progress-li)').removeClass("ondrag");
                        $('#step-Count-Wrapper').removeClass("ondrag");
                        $('.drag-in-progress-li').removeClass("drag-in-progress-li");
                        event.stopPropagation;
                    }
                });
                $("#libraryElementstep, #libraryElementaction, #libraryElementflow").draggable({
                    stop: function () {
                        $('#sortable').children().remove(".place-holder-listitem");
                        $(this).removeClass("selected");
                    }
                });
                $("#libraryElementstep, #libraryElementaction, #libraryElementflow").on("dragstart", function (event) {
                    $('#sortable').children().remove(".place-holder-listitem");
                    $('#triggeredProcessList').children().remove(".place-holder-listitem");
                    if ($("#globalWorkflowListHolder").css("visibility") == "visible") {
                        $('#workflowList').children().remove("#global-workflow-placeholder");
                    }
                    var firstPlaceHolderDiv = $("<div class='place-holder-listitem first' tabindex='-1' title=\"" + ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString('ProcessDesignerControl_BPF_ScreenReader_AddNewTile') + "\">+</div>");
                    var placeHolderDiv = $("<div class='place-holder-listitem' tabindex='-1' title=\"" + ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString('ProcessDesignerControl_BPF_ScreenReader_AddNewTile') + "\">+</div>");
                    placeHolderDiv.insertAfter(".step-list-listitem");
                    $('#sortable').children('li').length > 0 ? firstPlaceHolderDiv.insertBefore($('#sortable').children('li').first()) : $('#sortable').append(firstPlaceHolderDiv);
                    StepListView.makeDroppable(StepListView);
                });
                $("#libraryElementstep, #libraryElementaction, #libraryElementflow").on("dragend", function (event) {
                    $('#sortable').children().remove(".place-holder-listitem");
                });
                $("#libraryElementstep, #libraryElementaction, #libraryElementflow").on("drop", function (event) {
                    $('#sortable').children().remove(".place-holder-listitem");
                });
                $("#libraryElementstep, #libraryElementaction, #libraryElementflow").on("dragleave", function (event) {
                    $('#sortable').children().remove(".place-holder-listitem");
                });
                $("#libraryElementworkflow").draggable({
                    stop: function () {
                        $('#triggeredProcessList').children().remove(".place-holder-listitem");
                        $('#libraryElementworkflow').removeClass("selected");
                        $('#workflowList').children().remove("#global-workflow-placeholder");
                    }
                });
                $("#libraryElementworkflow").on("dragstart", function (event) {
                    if ($(".stage-detail-container").length > 0) {
                        $('#sortable').children().remove(".place-holder-listitem");
                        $('#triggeredProcessList').children().remove(".place-holder-listitem");
                        var placeHolderDiv = $("<div class='place-holder-listitem' id='workflow-placeholder' tabindex='-1' title=\"" + ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString('ProcessDesignerControl_BPF_ScreenReader_AddNewTile') + "\">+</div>");
                        $('#triggeredProcessList').append(placeHolderDiv);
                        document.getElementById("workflow-placeholder").scrollIntoView(false);
                        StepListView.makeWorkflowDroppable(StepListView);
                    }
                });
                $("#libraryElementworkflow").on("dragend", function (event) {
                    $('#triggeredProcessList').removeClass("hoverOverDroppable");
                });
                $("#libraryElementworkflow").on("drop", function (event) {
                    $('#triggeredProcessList').removeClass(".hoverOverDroppable");
                });
                $("#libraryElementworkflow").on("dragleave", function (event) {
                    $('#triggeredProcessList').removeClass("hoverOverDroppable");
                });
                $("#UpArrow").on("click", function (event) {
                    StepListView.upArrowButtonClickEvent(event, StepListView);
                });
                $("#DownArrow").on("click", function (event) {
                    StepListView.downArrowButtonClickEvent(event, StepListView);
                });
                $(".step-list-listitem").on("click", function (event) {
                    $(".step-list-listitem.selected").addClass("unselected");
                    $(".step-list-listitem.selected").removeClass("selected");
                    $(this).addClass('selected');
                    $(this).removeClass('unselected');
                    if (($(".stage-detail-container").length > 0) && ($(".stageTile.selected").length > 0) && ("details_" + $(".stageTile.selected").attr("id") == $(".stage-detail-container").attr("id"))) {
                        $(".stage-detail-container").addClass("selected");
                    }
                    StepListView.enableDisableArrowButtons(StepListView);
                });
                $(document).on('AddButton', function (event, droppable) {
                    if (ProcessDesigner.BPFToolBarView.addMode == ProcessDesigner.BPFToolBarAddMode.AddStep || ProcessDesigner.BPFToolBarView.addMode == ProcessDesigner.BPFToolBarAddMode.PasteStep
                        || ProcessDesigner.BPFToolBarView.addMode == ProcessDesigner.BPFToolBarAddMode.AddActionStep || ProcessDesigner.BPFToolBarView.addMode == ProcessDesigner.BPFToolBarAddMode.PasteActionStep
                        || ProcessDesigner.BPFToolBarView.addMode == ProcessDesigner.BPFToolBarAddMode.AddFlowStep || ProcessDesigner.BPFToolBarView.addMode == ProcessDesigner.BPFToolBarAddMode.PasteFlowStep) {
                        if (ProcessDesigner.BPFToolBarView.addMode == ProcessDesigner.BPFToolBarAddMode.PasteActionStep || ProcessDesigner.BPFToolBarView.addMode == ProcessDesigner.BPFToolBarAddMode.PasteFlowStep) {
                            var copied = GenericWorkflowDesigner.Settings.workflowTree.getCopiedActivities();
                            if ((!CommonTypes.Types.Object.isNullOrUndefined(copied)) && copied.length > 0 &&
                                (copied[0].getActivityTypeID() == ProcessDesigner.BPFActivityType.action || copied[0].getActivityTypeID() == ProcessDesigner.BPFActivityType.flow)) {
                                if ((copied[0].parentStage).entityName != ProcessDesigner.ControlManager.GetStageModel(GenericWorkflowDesigner.currentModel).entityName) {
                                    return;
                                }
                            }
                        }
                        if ($(".stage-detail-container").length > 0) {
                            $('#triggeredProcessList').children().remove(".place-holder-listitem");
                            $('#sortable').children().remove(".place-holder-listitem");
                            var firstPlaceHolderDiv = $("<div class='place-holder-listitem first' tabindex='-1' title=\"" + ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString('ProcessDesignerControl_BPF_ScreenReader_AddNewTile') + "\">+</div>");
                            var placeHolderDiv = $("<div class='place-holder-listitem' tabindex='-1' title=\"" + ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString('ProcessDesignerControl_BPF_ScreenReader_AddNewTile') + "\">+</div>");
                            placeHolderDiv.insertAfter(".step-list-listitem");
                            $('#sortable').children('li').length > 0 ? firstPlaceHolderDiv.insertBefore($('#sortable').children('li').first()) : $('#sortable').append(firstPlaceHolderDiv);
                            StepListView.makePlaceHolderClick(StepListView);
                            StepListView.makePlaceHolderNavigable();
                        }
                    }
                    else if (ProcessDesigner.BPFToolBarView.addMode == ProcessDesigner.BPFToolBarAddMode.AddWorkflow) {
                        if ($(".stage-detail-container").length > 0) {
                            $('#triggeredProcessList').children().remove(".place-holder-listitem");
                            $('#sortable').children().remove(".place-holder-listitem");
                            var placeHolderDiv = $("<div class='place-holder-listitem' id='workflow-placeholder' tabindex='-1'>+</div>");
                            $('#triggeredProcessList').append(placeHolderDiv);
                            document.getElementById("workflow-placeholder").scrollIntoView(false);
                            StepListView.makeWorkflowDroppable(StepListView);
                            StepListView.makePlaceHolderClick(StepListView);
                            StepListView.makePlaceHolderNavigable();
                        }
                    }
                });
                $("#toggleStep").on("click", function (event) {
                    if ($("#toggleStep").hasClass("ExpandList-symbol")) {
                        $("#toggleStep").removeClass("ExpandList-symbol");
                        $("#toggleStep").addClass("CollapseList-symbol");
                    }
                    else {
                        $("#toggleStep").removeClass("CollapseList-symbol");
                        $("#toggleStep").addClass("ExpandList-symbol");
                    }
                    $("#sortable").slideToggle("slow");
                    event.stopPropagation();
                });
                $("#toggleProcess").on("click", function (event) {
                    if ($("#toggleProcess").hasClass("ExpandList-symbol")) {
                        $("#toggleProcess").removeClass("ExpandList-symbol");
                        $("#toggleProcess").addClass("CollapseList-symbol");
                    }
                    else {
                        $("#toggleProcess").removeClass("CollapseList-symbol");
                        $("#toggleProcess").addClass("ExpandList-symbol");
                    }
                    $("#triggeredProcessList").slideToggle("slow");
                    event.stopPropagation();
                });
                this.attachKeyDownEventForStepListItem(StepListView);
            };
            StepListView.prototype.removeEventHandlers = function (StepListView) {
                for (var i = 0; i < this.stepViews.length; i++) {
                    this.stepViews[i].remove();
                }
                this.stepViews = null;
                $("#libraryElementstep, #libraryElementaction, #libraryElementflow").off("dragstart", null, null);
                $("#libraryElementstep, #libraryElementaction, #libraryElementflow").off("dragend", null, null);
                $("#libraryElementstep, #libraryElementaction, #libraryElementflow").off("drop", null, null);
                $("#libraryElementstep, #libraryElementaction, #libraryElementflow").off("dragleave", null, null);
                $("#libraryElementworkflow").off("dragstart", null, null);
                $("#libraryElementworkflow").off("dragend", null, null);
                $("#libraryElementworkflow").off("drop", null, null);
                $("#libraryElementworkflow").off("dragleave", null, null);
                $("#sortable").off("focusout", null, null);
                $("#UpArrow").off("click", null, null);
                $("#DownArrow").off("click", null, null);
                $(".step-list-listitem").off("click", null, null);
                $("#toggleStep").off("click", null, null);
                StepListView.off("AddButton", null, null);
            };
            StepListView.prototype.evaluateSteps = function (StepListView) {
                var updatedStepsArray = [];
                $(".step-list-listitem").each(function (index) {
                    var stepIdFromList = $(this).attr("id");
                    for (var i = 0; i < StepListView.steps.length; i++) {
                        if (StepListView.steps[i].stepId == stepIdFromList) {
                            var currentStep = $(".step-list-listitem")[index];
                            var currentStepIndex = updatedStepsArray.length + 1;
                            StepListView.steps[i].sequence = currentStepIndex;
                            if (StepListView.steps[i].getActivityTypeID() == ProcessDesigner.BPFActivityType.step) {
                                $(currentStep).find("#stepSequence").html(ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_LibraryTileName_step") + " #" + currentStepIndex.toString());
                            }
                            else if (StepListView.steps[i].getActivityTypeID() == ProcessDesigner.BPFActivityType.flow) {
                                $(currentStep).find("#stepSequence").html(ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_LibraryTileName_FlowStep") + " #" + currentStepIndex.toString());
                            }
                            else {
                                $(currentStep).find("#stepSequence").html(ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_LibraryTileName_action") + " #" + currentStepIndex.toString());
                            }
                            updatedStepsArray.push(StepListView.steps[i]);
                            break;
                        }
                    }
                });
                GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.updateTileTitle);
                StepListView.steps = updatedStepsArray;
                this.updateActivityTree();
            };
            StepListView.prototype.updateActivityTree = function () {
                this.model.setNewSteps(this.steps);
            };
            StepListView.prototype.DropElement = function (droppable, StepListView, isPasteStep) {
                var newBPFStepActivity = new ProcessDesigner.BPFStepActivity();
                if (isPasteStep) {
                    var copiedActivities = GenericWorkflowDesigner.Settings.workflowTree.getCopiedActivities();
                    if (copiedActivities.length <= 0) {
                        return;
                    }
                    newBPFStepActivity = copiedActivities[0].getCloneOfActivity();
                    if (GenericWorkflowDesigner.CutCommand.cutInProgress) {
                        $(".step-list-listitem").each(function (index) {
                            var currentAction = $(".step-list-listitem")[index];
                            if (currentAction && currentAction.getAttribute("id") == copiedActivities[0].stepId) {
                                $(currentAction).remove();
                                return false;
                            }
                        });
                        ProcessDesigner.BPFStepActivityDeleteHandler.prototype.deleteStepFromStageActivity(copiedActivities[0]);
                        var tileCount = "#tileCount_" + ProcessDesigner.StringUtility.RemoveSpaces(newBPFStepActivity.parentStage.getActivityID());
                        $(tileCount).html(newBPFStepActivity.getParentStage().steps.length);
                    }
                }
                var id = _Microsoft.Client.Telemetry.Utility.newGuid();
                newBPFStepActivity.stepId = id;
                newBPFStepActivity.parentStage = StepListView.model;
                newBPFStepActivity.setParentActivityID(StepListView.model.getActivityID());
                newBPFStepActivity.isNewlyAdded = true;
                StepListView.steps.push(newBPFStepActivity);
                var tileCount = "#tileCount_" + ProcessDesigner.StringUtility.RemoveSpaces(newBPFStepActivity.parentStage.getActivityID());
                $(tileCount).html(StepListView.steps.length);
                GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.updateTileTitle);
                var listLi = $("<li class='step-list-listitem' tabindex='-1' id='" + id + "'></li>");
                var editStepView = new ProcessDesigner.EditStepView(newBPFStepActivity, $(listLi));
                $(".seeDetailsStepLabel").html("Step (" + StepListView.steps.length + ")");
                $(".stepCountWrapper").attr("title", ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_WorkFlow_StepCount") + " " + StepListView.steps.length);
                editStepView.render();
                editStepView.$el.insertAfter(droppable);
                $(".step-list-listitem.selected").addClass("unselected");
                $(".step-list-listitem.selected").removeClass("selected");
                $('#sortable').children().remove(".place-holder-listitem");
                StepListView.evaluateSteps(StepListView);
                ProcessDesigner.ControlManager.isNewStepAdded = true;
                StepListView.openNewlyAddedStep(StepListView.steps);
                editStepView.$el.addClass("selected");
                editStepView.$el.removeClass("unselected");
                editStepView.$el.focus();
                this.attachKeyDownEventForStepListItem(StepListView);
                StepListView.enableDisableArrowButtons(StepListView);
                if (($(".stage-detail-container").length > 0) && ($(".stageTile.selected").length > 0) && ("details_" + $(".stageTile.selected").attr("id") == $(".stage-detail-container").attr("id"))) {
                    $(".stage-detail-container").addClass("selected");
                }
                $(this).removeClass("hoverOverDroppable");
                $(this).removeClass("hoverOverDroppableHighlight");
                ProcessDesigner.TelemetryEventReporter.ReportTileAddedTelemetryEvent("Drag-Drop", newBPFStepActivity.stepId, ProcessDesigner.BPFActivityType.step, newBPFStepActivity.parentStage.stageId);
                ProcessDesigner.CanvasDisplayUtility.HandleStageDetailsOverlap();
            };
            StepListView.prototype.DropActionElement = function (droppable, StepListView, isPasteStep) {
                var newBPFActionStepActivity = new ProcessDesigner.BPFActionStepActivity();
                if (isPasteStep) {
                    var copiedActivities = GenericWorkflowDesigner.Settings.workflowTree.getCopiedActivities();
                    if (copiedActivities.length <= 0) {
                        return;
                    }
                    newBPFActionStepActivity = copiedActivities[0].getCloneOfActivity();
                    if (GenericWorkflowDesigner.CutCommand.cutInProgress) {
                        $(".step-list-listitem").each(function (index) {
                            var currentAction = $(".step-list-listitem")[index];
                            if (currentAction && currentAction.getAttribute("id") == copiedActivities[0].stepId) {
                                $(currentAction).remove();
                                return false;
                            }
                        });
                        ProcessDesigner.BPFStepActivityDeleteHandler.prototype.deleteStepFromStageActivity(copiedActivities[0]);
                        var tileCount = "#tileCount_" + ProcessDesigner.StringUtility.RemoveSpaces(newBPFActionStepActivity.parentStage.getActivityID());
                        $(tileCount).html(newBPFActionStepActivity.getParentStage().steps.length);
                    }
                }
                var id = _Microsoft.Client.Telemetry.Utility.newGuid();
                newBPFActionStepActivity.stepId = id;
                newBPFActionStepActivity.parentStage = StepListView.model;
                newBPFActionStepActivity.setParentActivityID(StepListView.model.getActivityID());
                newBPFActionStepActivity.isNewlyAdded = true;
                StepListView.steps.push(newBPFActionStepActivity);
                var tileCount = "#tileCount_" + ProcessDesigner.StringUtility.RemoveSpaces(newBPFActionStepActivity.parentStage.getActivityID());
                $(tileCount).html(StepListView.steps.length);
                GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.updateTileTitle);
                var listLi = $("<li class='step-list-listitem' tabindex='-1' id='" + id + "'></li>");
                var editActionStepView = new ProcessDesigner.EditActionStepView(newBPFActionStepActivity, $(listLi));
                $(".seeDetailsStepLabel").html("Step (" + StepListView.steps.length + ")");
                $(".stepCountWrapper").attr("title", ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_WorkFlow_StepCount") + " " + StepListView.steps.length);
                editActionStepView.render();
                editActionStepView.$el.insertAfter(droppable);
                $(".step-list-listitem.selected").addClass("unselected");
                $(".step-list-listitem.selected").removeClass("selected");
                $('#sortable').children().remove(".place-holder-listitem");
                StepListView.evaluateSteps(StepListView);
                ProcessDesigner.ControlManager.isNewStepAdded = true;
                StepListView.openNewlyAddedStep(StepListView.steps);
                editActionStepView.$el.addClass("selected");
                editActionStepView.$el.removeClass("unselected");
                editActionStepView.$el.focus();
                this.attachKeyDownEventForStepListItem(StepListView);
                StepListView.enableDisableArrowButtons(StepListView);
                if (($(".stage-detail-container").length > 0) && ($(".stageTile.selected").length > 0) && ("details_" + $(".stageTile.selected").attr("id") == $(".stage-detail-container").attr("id"))) {
                    $(".stage-detail-container").addClass("selected");
                }
                $(this).removeClass("hoverOverDroppable");
                $(this).removeClass("hoverOverDroppableHighlight");
                ProcessDesigner.TelemetryEventReporter.ReportTileAddedTelemetryEvent("Drag-Drop", newBPFActionStepActivity.stepId, ProcessDesigner.BPFActivityType.action, newBPFActionStepActivity.parentStage.stageId);
                ProcessDesigner.CanvasDisplayUtility.HandleStageDetailsOverlap();
            };
            StepListView.prototype.DropFlowElement = function (droppable, StepListView, isPasteStep) {
                var newBPFFlowStepActivity = new ProcessDesigner.BPFFlowStepActivity();
                if (isPasteStep) {
                    var copiedActivities = GenericWorkflowDesigner.Settings.workflowTree.getCopiedActivities();
                    if (copiedActivities.length <= 0) {
                        return;
                    }
                    newBPFFlowStepActivity = copiedActivities[0].getCloneOfActivity();
                    if (GenericWorkflowDesigner.CutCommand.cutInProgress) {
                        $(".step-list-listitem").each(function (index) {
                            var currentAction = $(".step-list-listitem")[index];
                            if (currentAction && currentAction.getAttribute("id") == copiedActivities[0].stepId) {
                                $(currentAction).remove();
                                return false;
                            }
                        });
                        ProcessDesigner.BPFStepActivityDeleteHandler.prototype.deleteStepFromStageActivity(copiedActivities[0]);
                        var tileCount = "#tileCount_" + ProcessDesigner.StringUtility.RemoveSpaces(newBPFFlowStepActivity.parentStage.getActivityID());
                        $(tileCount).html(newBPFFlowStepActivity.getParentStage().steps.length);
                    }
                }
                var id = _Microsoft.Client.Telemetry.Utility.newGuid();
                newBPFFlowStepActivity.stepId = id;
                newBPFFlowStepActivity.parentStage = StepListView.model;
                newBPFFlowStepActivity.setParentActivityID(StepListView.model.getActivityID());
                newBPFFlowStepActivity.isNewlyAdded = true;
                StepListView.steps.push(newBPFFlowStepActivity);
                var tileCount = "#tileCount_" + ProcessDesigner.StringUtility.RemoveSpaces(newBPFFlowStepActivity.parentStage.getActivityID());
                $(tileCount).html(StepListView.steps.length);
                GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.updateTileTitle);
                var listLi = $("<li class='step-list-listitem' tabindex='-1' id='" + id + "'></li>");
                var editFlowStepView = new ProcessDesigner.EditFlowStepView(newBPFFlowStepActivity, $(listLi));
                $(".seeDetailsStepLabel").html("Step (" + StepListView.steps.length + ")");
                $(".stepCountWrapper").attr("title", ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_WorkFlow_StepCount") + " " + StepListView.steps.length);
                editFlowStepView.render();
                editFlowStepView.$el.insertAfter(droppable);
                $(".step-list-listitem.selected").addClass("unselected");
                $(".step-list-listitem.selected").removeClass("selected");
                $('#sortable').children().remove(".place-holder-listitem");
                StepListView.evaluateSteps(StepListView);
                ProcessDesigner.ControlManager.isNewStepAdded = true;
                StepListView.openNewlyAddedStep(StepListView.steps);
                editFlowStepView.$el.addClass("selected");
                editFlowStepView.$el.removeClass("unselected");
                editFlowStepView.$el.focus();
                this.attachKeyDownEventForStepListItem(StepListView);
                StepListView.enableDisableArrowButtons(StepListView);
                if (($(".stage-detail-container").length > 0) && ($(".stageTile.selected").length > 0) && ("details_" + $(".stageTile.selected").attr("id") == $(".stage-detail-container").attr("id"))) {
                    $(".stage-detail-container").addClass("selected");
                }
                $(this).removeClass("hoverOverDroppable");
                $(this).removeClass("hoverOverDroppableHighlight");
                ProcessDesigner.TelemetryEventReporter.ReportTileAddedTelemetryEvent("Drag-Drop", newBPFFlowStepActivity.stepId, ProcessDesigner.BPFActivityType.flow, newBPFFlowStepActivity.parentStage.stageId);
                ProcessDesigner.CanvasDisplayUtility.HandleStageDetailsOverlap();
            };
            StepListView.prototype.makePlaceHolderClick = function (StepListView) {
                $(".place-holder-listitem").on("click keypress", function (event) {
                    event.stopPropagation();
                    if (ProcessDesigner.BPFToolBarView.addMode == ProcessDesigner.BPFToolBarAddMode.AddStep || ProcessDesigner.BPFToolBarView.addMode == ProcessDesigner.BPFToolBarAddMode.PasteStep ||
                        ProcessDesigner.BPFToolBarView.addMode == ProcessDesigner.BPFToolBarAddMode.AddActionStep || ProcessDesigner.BPFToolBarView.addMode == ProcessDesigner.BPFToolBarAddMode.PasteActionStep ||
                        ProcessDesigner.BPFToolBarView.addMode == ProcessDesigner.BPFToolBarAddMode.AddFlowStep || ProcessDesigner.BPFToolBarView.addMode == ProcessDesigner.BPFToolBarAddMode.PasteFlowStep) {
                        if (ProcessDesigner.BPFToolBarView.addMode == ProcessDesigner.BPFToolBarAddMode.AddActionStep || ProcessDesigner.BPFToolBarView.addMode == ProcessDesigner.BPFToolBarAddMode.PasteActionStep) {
                            StepListView.DropActionElement(event.target, StepListView, ProcessDesigner.BPFToolBarView.addMode == ProcessDesigner.BPFToolBarAddMode.PasteActionStep);
                        }
                        else if (ProcessDesigner.BPFToolBarView.addMode == ProcessDesigner.BPFToolBarAddMode.AddFlowStep || ProcessDesigner.BPFToolBarView.addMode == ProcessDesigner.BPFToolBarAddMode.PasteFlowStep) {
                            StepListView.DropFlowElement(event.target, StepListView, ProcessDesigner.BPFToolBarView.addMode == ProcessDesigner.BPFToolBarAddMode.PasteFlowStep);
                        }
                        else {
                            StepListView.DropElement(event.target, StepListView, ProcessDesigner.BPFToolBarView.addMode == ProcessDesigner.BPFToolBarAddMode.PasteStep);
                        }
                        StepListView.setScrollbar($(".stage-detail-container-div"));
                        ProcessDesigner.BPFToolBarView.addMode = ProcessDesigner.BPFToolBarAddMode.None;
                        $("#canvas").children(".hoverOverDroppable").removeClass("hoverOverDroppable");
                    }
                    else if (ProcessDesigner.BPFToolBarView.addMode == ProcessDesigner.BPFToolBarAddMode.AddWorkflow) {
                        StepListView.DropWorkflow(event.target, StepListView);
                        StepListView.setScrollbar($(".stage-detail-container-div"));
                        ProcessDesigner.BPFToolBarView.addMode = ProcessDesigner.BPFToolBarAddMode.None;
                        $("#canvas").children(".hoverOverDroppable").removeClass("hoverOverDroppable");
                    }
                    GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.editDone);
                });
            };
            StepListView.prototype.makePlaceHolderNavigable = function () {
                $(".place-holder-listitem").on("keydown", function (event) {
                    if (event.keyCode == 40) {
                        $(".step-list-listitem.selected").removeClass("selected");
                        $(event.target.nextSibling).focus();
                        $(event.target.nextSibling).addClass("selected");
                    }
                    if (event.keyCode == 38) {
                        if (event.target.previousSibling == null) {
                            $("#" + ProcessDesigner.ControlManager.GetStageModel(GenericWorkflowDesigner.currentModel).getActivityID()).focus();
                        }
                        else {
                            $(event.target.previousSibling).focus();
                            $(event.target.previousSibling).addClass("selected");
                        }
                    }
                    event.stopImmediatePropagation();
                });
            };
            StepListView.prototype.makeDroppable = function (StepListView) {
                var stepElementId = GenericWorkflowDesigner.Library.libraryElementPrefix + ProcessDesigner.BPFActivityType.step;
                var actionStepElementId = GenericWorkflowDesigner.Library.libraryElementPrefix + ProcessDesigner.BPFActivityType.action;
                var flowStepElementId = GenericWorkflowDesigner.Library.libraryElementPrefix + ProcessDesigner.BPFActivityType.flow;
                $(".place-holder-listitem").droppable({
                    cursor: 'default',
                    tolerance: 'pointer',
                    activate: function (event, ui) {
                        if (ui.draggable.attr("id") == stepElementId || ui.draggable.attr("id") == actionStepElementId || ui.draggable.attr("id") == flowStepElementId) {
                            $(this).addClass("hoverOverDroppable");
                        }
                    },
                    deactivate: function (event, ui) {
                        if (ui.draggable.attr("id") == stepElementId || ui.draggable.attr("id") == actionStepElementId || ui.draggable.attr("id") == flowStepElementId) {
                            $(this).removeClass("hoverOverDroppable");
                        }
                    },
                    over: function (event, ui) {
                        if (ui.draggable.attr("id") == stepElementId || ui.draggable.attr("id") == actionStepElementId || ui.draggable.attr("id") == flowStepElementId) {
                            $(this).addClass("hoverOverDroppableHighlight");
                        }
                    },
                    out: function (event, ui) {
                        if (ui.draggable.attr("id") == stepElementId || ui.draggable.attr("id") == actionStepElementId || ui.draggable.attr("id") == flowStepElementId) {
                            $(this).removeClass("hoverOverDroppableHighlight");
                        }
                    },
                    drop: function (event, ui) {
                        var elementId = ui.draggable.attr("id");
                        if (elementId != stepElementId && elementId != actionStepElementId && elementId != flowStepElementId) {
                            return;
                        }
                        if (elementId == stepElementId) {
                            StepListView.DropElement(event.target, StepListView, false);
                        }
                        else if (elementId == actionStepElementId) {
                            StepListView.DropActionElement(event.target, StepListView, false);
                        }
                        else {
                            StepListView.DropFlowElement(event.target, StepListView, false);
                        }
                        StepListView.setScrollbar($(".stage-detail-container-div"));
                        GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.editDone);
                    }
                });
            };
            StepListView.prototype.makeWorkflowDroppable = function (StepListView) {
                $(".place-holder-listitem").droppable({
                    cursor: 'default',
                    tolerance: 'pointer',
                    activate: function (event, ui) {
                        if (ui.draggable.attr("id") == GenericWorkflowDesigner.Library.libraryElementPrefix + ProcessDesigner.BPFActivityType.workflow) {
                            $(this).addClass("hoverOverDroppable");
                        }
                    },
                    deactivate: function (event, ui) {
                        if (ui.draggable.attr("id") == GenericWorkflowDesigner.Library.libraryElementPrefix + ProcessDesigner.BPFActivityType.workflow) {
                            $(this).removeClass("hoverOverDroppable");
                        }
                    },
                    over: function (event, ui) {
                        if (ui.draggable.attr("id") == GenericWorkflowDesigner.Library.libraryElementPrefix + ProcessDesigner.BPFActivityType.workflow) {
                            $(this).addClass("hoverOverDroppableHighlight");
                        }
                    },
                    out: function (event, ui) {
                        if (ui.draggable.attr("id") == GenericWorkflowDesigner.Library.libraryElementPrefix + ProcessDesigner.BPFActivityType.workflow) {
                            $(this).removeClass("hoverOverDroppableHighlight");
                        }
                    },
                    drop: function (event, ui) {
                        if (ui.draggable.attr("id") == GenericWorkflowDesigner.Library.libraryElementPrefix + ProcessDesigner.BPFActivityType.workflow) {
                            StepListView.DropWorkflow(event.target, StepListView);
                            StepListView.setScrollbar($(".stage-detail-container-div"));
                            if ($("#globalWorkflowListHolder").css("visibility") == "visible") {
                                $('#workflowList').children().remove("#global-workflow-placeholder");
                            }
                            GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.editDone);
                        }
                    }
                });
            };
            StepListView.prototype.setScrollbar = function (parentDiv) {
                $(".stage-detail-container").css("height", "auto");
                var canvasHeight = parseInt($("#zoomCanvasWrapper").css("height"), 10);
                var parentDivHeight = parseInt($(parentDiv.parent()[0]).css("height"), 10);
                var parentDivTop = parseInt($(parentDiv.parent()[0]).css("top"), 10);
                var globalButtonHeight = parseInt($("#globalButtonArea").css("height"), 10);
                var globalButtonBottom = parseInt($("#globalButtonArea").css("bottom"), 10);
                var horizontalScrollHeight = 25;
                var totalDivHeight = canvasHeight - (parentDivHeight + parentDivTop + globalButtonBottom + globalButtonHeight + horizontalScrollHeight);
                var minimumHeight = 2 * parseInt($("#step-Count-Wrapper").css("height"), 10);
                if (totalDivHeight < minimumHeight) {
                    $(".stage-detail-container").css("max-height", minimumHeight + "px");
                }
                else {
                    $(".stage-detail-container").css("max-height", totalDivHeight + "px");
                }
                var offsetMargin = 6;
                var currentHeight = parseInt($(".stage-detail-container").css("height"), 10);
                $(".stage-detail-container").css("height", currentHeight + offsetMargin + "px");
                this.restrictDetailsDivHeight();
            };
            StepListView.prototype.restrictDetailsDivHeight = function () {
                var detailContainerDiv = $(".stage-detail-container");
                var targetDivTopArray = [];
                var miniMapDivTop = this.calculateDivTopOffset($("#show-mini-map-div"));
                targetDivTopArray.push(miniMapDivTop);
                var globalWorkflowDivTop = this.calculateDivTopOffset($("#globalButtonArea"));
                targetDivTopArray.push(globalWorkflowDivTop);
                var targetDivOffsetTop = Math.min.apply(null, targetDivTopArray);
                if (detailContainerDiv.length > 0 && targetDivOffsetTop > 0) {
                    var detailContainerDivBottom = detailContainerDiv.offset().top + detailContainerDiv.height();
                    var difference = detailContainerDivBottom - targetDivOffsetTop;
                    if (difference > 0) {
                        $(".stage-detail-container-div").addClass("detailContainerBottomOffset");
                    }
                }
            };
            StepListView.prototype.calculateDivTopOffset = function (targetDiv) {
                var targetDivOffsetTop = 0;
                if (targetDiv.length > 0) {
                    targetDivOffsetTop = targetDiv.offset().top;
                }
                return targetDivOffsetTop;
            };
            StepListView.prototype.disableArrowButton = function (arrowButtonDiv) {
                arrowButtonDiv.attr("aria-disabled", true);
                arrowButtonDiv.addClass("disableArrowButton");
            };
            StepListView.prototype.enableArrowButton = function (arrowButtonDiv) {
                arrowButtonDiv.attr("aria-disabled", false);
                arrowButtonDiv.removeClass("disableArrowButton");
            };
            StepListView.prototype.upArrowButtonClickEvent = function (event, StepListView) {
                $(".step-list-listitem.selected").insertBefore($(".step-list-listitem.selected").prev('.step-list-listitem'));
                $(".step-list-listitem.selected").focus();
                StepListView.evaluateSteps(StepListView);
                var tileId = $('li.selected').attr('id');
                var parentTileId = StepListView.model.stageId;
                ProcessDesigner.TelemetryEventReporter.ReportTileReorderedTelemetryEvent(tileId, ProcessDesigner.BPFActivityType.step, parentTileId, "Up-Down Button");
                StepListView.enableDisableArrowButtons(StepListView);
                GenericWorkflowDesigner.EventManager.publish('updatePropertyHtml');
                event.stopPropagation();
            };
            StepListView.prototype.downArrowButtonClickEvent = function (event, StepListView) {
                $(".step-list-listitem.selected").insertAfter($(".step-list-listitem.selected").next('.step-list-listitem'));
                $(".step-list-listitem.selected").focus();
                StepListView.evaluateSteps(StepListView);
                var tileId = $('li.selected').attr('id');
                var parentTileId = StepListView.model.stageId;
                ProcessDesigner.TelemetryEventReporter.ReportTileReorderedTelemetryEvent(tileId, ProcessDesigner.BPFActivityType.step, parentTileId, "Up-Down Button");
                StepListView.enableDisableArrowButtons(StepListView);
                GenericWorkflowDesigner.EventManager.publish('updatePropertyHtml');
                event.stopPropagation();
            };
            StepListView.prototype.enableDisableArrowButtons = function (StepListView) {
                if ($(".step-list-listitem.selected") != null && $(".step-list-listitem").length > 1) {
                    StepListView.enableArrowButton($('#DownArrow'));
                    StepListView.enableArrowButton($('#UpArrow'));
                }
                if ($(".step-list-listitem.selected") != null && ($(".step-list-listitem.selected").next('.step-list-listitem').length == 0)) {
                    StepListView.disableArrowButton($('#DownArrow'));
                }
                if ($(".step-list-listitem.selected") != null && ($(".step-list-listitem.selected").prev('.step-list-listitem').length == 0)) {
                    StepListView.disableArrowButton($('#UpArrow'));
                }
            };
            StepListView.prototype.DropWorkflow = function (droppable, StepListView) {
                var newBPFWorkflowActivity = new ProcessDesigner.BPFWorkflowActivity();
                var id = _Microsoft.Client.Telemetry.Utility.newGuid();
                newBPFWorkflowActivity.actionStepId = id;
                newBPFWorkflowActivity.parentStage = StepListView.model;
                newBPFWorkflowActivity.setParentActivityID(newBPFWorkflowActivity.parentStage.getActivityID());
                newBPFWorkflowActivity.isNewlyAdded = true;
                StepListView.workflows.push(newBPFWorkflowActivity);
                ProcessDesigner.ControlManager.isNewActionStepAdded = true;
                var tileCount = "#workflowCount_" + ProcessDesigner.StringUtility.RemoveSpaces(newBPFWorkflowActivity.parentStage.getActivityID());
                $(tileCount).html(StepListView.workflows.length);
                GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.updateTileTitle);
                var listLi = $("<li class='workflow-list-listitem' tabindex='-1' id='" + id + "'></li>");
                var editWorkflowView = new ProcessDesigner.EditWorkflowView(newBPFWorkflowActivity, $(listLi));
                $(".seeDetailsTPLabel").html(ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_LibraryTileName_workflow") + " (" + StepListView.workflows.length + ")");
                $(".workflowCountWrapper").attr("title", ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_WorkFlow_WorkflowCount") + " " + StepListView.workflows.length);
                editWorkflowView.render();
                $("#triggeredProcessList").append(editWorkflowView.$el);
                $(".workflow-list-listitem.selected").addClass("unselected");
                $(".workflow-list-listitem.selected").removeClass("selected");
                $('#triggeredProcessList').children().remove(".place-holder-listitem");
                editWorkflowView.$el.addClass("selected");
                editWorkflowView.$el.removeClass("unselected");
                editWorkflowView.$el.focus();
                this.attachKeyDownEventForStepListItem(StepListView);
                StepListView.openNewlyAddedWorkflow(StepListView.workflows);
                if (($(".stage-detail-container").length > 0) && ($(".stageTile.selected").length > 0) && ("details_" + $(".stageTile.selected").attr("id") == $(".stage-detail-container").attr("id"))) {
                    $(".stage-detail-container").addClass("selected");
                }
                $(this).removeClass("hoverOverDroppable");
                $(this).removeClass("hoverOverDroppableHighlight");
                ProcessDesigner.TelemetryEventReporter.ReportTileAddedTelemetryEvent("Drag-Drop", newBPFWorkflowActivity.actionStepId, ProcessDesigner.BPFActivityType.workflow, newBPFWorkflowActivity.parentStage.stageId);
                ProcessDesigner.CanvasDisplayUtility.HandleStageDetailsOverlap();
            };
            return StepListView;
        })(Backbone.View);
        ProcessDesigner.StepListView = StepListView;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// -----------------------------------------------------------------------
// <copyright file="StepView.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        "use strict";
        var StepView = (function (_super) {
            __extends(StepView, _super);
            function StepView(model, el) {
                _super.call(this, {
                    model: model,
                    el: el
                });
                this.className = "step-item";
            }
            StepView.prototype.initialize = function () {
                this.stepTemplate = _.template(" <span class=\"tileTitle\" title= \"<%- Title %>\"><%- Title %></span> ");
                this.$el.addClass(this.className);
                var self = this;
                this.$el.on("click", function (event) {
                    self.stepClickedHandler(event);
                });
            };
            StepView.prototype.render = function () {
                var step = this.model;
                this.$el.append(this.stepTemplate({ Title: GenericWorkflowDesigner.CrmEncodeDecode.CrmHtmlEncode(step.description) }));
                return this;
            };
            StepView.prototype.stepClickedHandler = function (event) {
                event.stopPropagation();
                var clickHandler = new GenericWorkflowDesigner.DefaultActivityClickHandler(this.model);
                clickHandler.click(this.$el);
                GenericWorkflowDesigner.eventManager.trigger('activatePropertyTab');
                var step = this.model;
                var stage = step.parentStage;
                ProcessDesigner.TelemetryEventReporter.ReportTileDetailsViewedTelemetryEvent(step.stepId, ProcessDesigner.BPFActivityType.step, stage.stageId);
            };
            return StepView;
        })(Backbone.View);
        ProcessDesigner.StepView = StepView;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// -----------------------------------------------------------------------
// <copyright file="StepView.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        "use strict";
        var ActionStepView = (function (_super) {
            __extends(ActionStepView, _super);
            function ActionStepView(model, el) {
                _super.call(this, {
                    model: model,
                    el: el
                });
                this.className = "step-item";
            }
            ActionStepView.prototype.initialize = function () {
                this.stepTemplate = _.template(" <span class=\"tileTitle\" title= \"<%- Title %>\"><%- Title %></span> ");
                this.$el.addClass(this.className);
                var self = this;
                this.$el.on("click", function (event) {
                    self.actionStepClickedHandler(event);
                });
            };
            ActionStepView.prototype.render = function () {
                var step = this.model;
                this.$el.append(this.stepTemplate({ Title: GenericWorkflowDesigner.CrmEncodeDecode.CrmHtmlEncode(step.description) }));
                return this;
            };
            ActionStepView.prototype.actionStepClickedHandler = function (event) {
                event.stopPropagation();
                var clickHandler = new GenericWorkflowDesigner.DefaultActivityClickHandler(this.model);
                clickHandler.click(this.$el);
                GenericWorkflowDesigner.eventManager.trigger('activatePropertyTab');
                var step = this.model;
                var stage = step.parentStage;
                ProcessDesigner.TelemetryEventReporter.ReportTileDetailsViewedTelemetryEvent(step.stepId, ProcessDesigner.BPFActivityType.action, stage.stageId);
            };
            return ActionStepView;
        })(Backbone.View);
        ProcessDesigner.ActionStepView = ActionStepView;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// -----------------------------------------------------------------------
// <copyright file="AddActivityListView.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        "use strict";
        var AddActivityListView = (function (_super) {
            __extends(AddActivityListView, _super);
            function AddActivityListView() {
                _super.call(this, {
                    el: $('#Add')
                });
                this.render();
            }
            AddActivityListView.prototype.initialize = function () {
                var self = this;
                GenericWorkflowDesigner.Utilities.bindToolbarSubmenuEvents($(".toolbarItemContainer"), self.$el);
            };
            AddActivityListView.prototype.render = function () {
                var div = $('<div class="activity-list-container"></div>');
                var listUl = $('<ul class="activity-list" role="menubar" ></ul>');
                var libraryGroups = GenericWorkflowDesigner.GenericWorkflowControl.LibraryObject.groups;
                if (libraryGroups == null) {
                    return this;
                }
                if (libraryGroups.length > 0) {
                    this.$el.parent().find(".activity-list-container").remove();
                    this.$el.parent().append(div);
                    $(div).append(listUl);
                    for (var i = 0; i < libraryGroups.length; i++) {
                        var group = libraryGroups[i];
                        var categoryUl = $("<ul class='activity-list-category' aria-label='" + group.key + "' role='menu' ></ul>");
                        var titleSpan = $("<span class='activity-list-title truncateString' aria-label='" + group.key + "' tabindex='-1'>" + group.key + "</span>");
                        $(categoryUl).append(titleSpan);
                        $(listUl).append(categoryUl);
                        for (var j = 0; j < group.value.length; j++) {
                            if (group.value[j].properties["activitytypeid"] == ProcessDesigner.BPFActivityType.flow && !GenericWorkflowDesigner.Settings.isBPFApprovalFlowsEnabled) {
                                continue;
                            }
                            if (!(group.value[j].properties["activitytypeid"] == ProcessDesigner.BPFActivityType.action && !GenericWorkflowDesigner.Settings.isFeatureEnabled)) {
                                var activityName = group.value[j].properties["name"];
                                var addCommandText = ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("GenericWorkflowDesignerControl_Add") + " " + activityName;
                                var templateItems = [];
                                templateItems["addCommandText"] = addCommandText;
                                templateItems["addCommandTooltip"] = group.value[j].properties["addcommandtooltip"];
                                var listLi = $("<li class='activity-list-listitem' tabindex='-1' aria-owns='" + group.key + "' role='menuitem'  aria-label='" + addCommandText + "' id='Add" + group.value[j].properties["activitytypeid"] + "Command'></li>");
                                var elem1 = new ProcessDesigner.AddActivityListSubView(templateItems, $(listLi));
                                elem1.render();
                                $(categoryUl).append(elem1.el);
                            }
                        }
                    }
                    $(".activity-list-listitem").first().focus();
                }
                $(".activity-list-title").keydown(function (event) {
                    if (event.keyCode == 40) {
                        $(event.target.nextSibling).focus();
                    }
                    if (event.keyCode == 38) {
                        $(event.target.previousSibling).focus();
                        if ($(event.target.previousSibling).length < 1) {
                            $(event.target.parentElement.previousSibling.lastChild).focus();
                        }
                    }
                });
                $(".activity-list-listitem").keydown(function (event) {
                    if (event.keyCode == 13) {
                        $(event.target).focus();
                        ProcessDesigner.AddActivityListSubView.ClickHandler(event);
                    }
                    if (event.keyCode == 40) {
                        $(event.target.nextSibling).focus();
                        if ($(event.target.nextSibling).length < 1) {
                            $(event.target.parentElement.nextSibling.firstChild).focus();
                        }
                    }
                    if (event.keyCode == 38)
                        $(event.target.previousSibling).focus();
                });
            };
            return AddActivityListView;
        })(Backbone.View);
        ProcessDesigner.AddActivityListView = AddActivityListView;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// -----------------------------------------------------------------------
// <copyright file="AddActivityListSubView.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        "use strict";
        var AddActivityListSubView = (function (_super) {
            __extends(AddActivityListSubView, _super);
            function AddActivityListSubView(option, activityItem) {
                _super.call(this, {
                    el: activityItem
                });
                this.className = "activity-item";
                this.option = option;
            }
            AddActivityListSubView.prototype.initialize = function () {
                this.itemTemplate = _.template("<button type=\"submit\" tabindex=\"-1\" class=\"activityOptionTitle\" title=\"<%- Tooltip %>\"><div class=\"wrapString truncateString\"><%- Title %></div> </button>");
                this.$el.addClass(this.className);
                var self = this;
                this.$el.on("mousedown", function (event) {
                    $(event.target.children).focus();
                    ProcessDesigner.ControlManager.ClearSelections();
                    AddActivityListSubView.ClickHandler(event);
                });
            };
            AddActivityListSubView.prototype.render = function () {
                var itemText = this.option["addCommandText"];
                var itemTooltip = this.option["addCommandTooltip"];
                this.$el.append(this.itemTemplate({ Tooltip: itemTooltip, Title: itemText }));
                return this;
            };
            AddActivityListSubView.ClickHandler = function (event) {
                var tileClass;
                switch ($(event.currentTarget).attr("id").toString().toLowerCase()) {
                    case ProcessDesigner.BPFAddActivityTypeCommandID.AddStep.toLowerCase():
                        ProcessDesigner.BPFToolBarView.addMode = ProcessDesigner.BPFToolBarAddMode.AddStep;
                        tileClass = '.' + GenericWorkflowDesigner.BaseTileInformation.tileObjects[ProcessDesigner.BPFActivityType.step].properties["tileclass"];
                        break;
                    case ProcessDesigner.BPFAddActivityTypeCommandID.AddActionStep.toLowerCase():
                        ProcessDesigner.BPFToolBarView.addMode = ProcessDesigner.BPFToolBarAddMode.AddActionStep;
                        tileClass = '.' + GenericWorkflowDesigner.BaseTileInformation.tileObjects[ProcessDesigner.BPFActivityType.action].properties["tileclass"];
                        break;
                    case ProcessDesigner.BPFAddActivityTypeCommandID.AddFlowStep.toLowerCase():
                        ProcessDesigner.BPFToolBarView.addMode = ProcessDesigner.BPFToolBarAddMode.AddFlowStep;
                        tileClass = '.' + GenericWorkflowDesigner.BaseTileInformation.tileObjects[ProcessDesigner.BPFActivityType.flow].properties["tileclass"];
                        break;
                    case ProcessDesigner.BPFAddActivityTypeCommandID.AddStage.toLowerCase():
                        ProcessDesigner.BPFToolBarView.addMode = ProcessDesigner.BPFToolBarAddMode.AddStage;
                        tileClass = '.' + GenericWorkflowDesigner.BaseTileInformation.tileObjects[ProcessDesigner.BPFActivityType.stage].properties["tileclass"];
                        break;
                    case ProcessDesigner.BPFAddActivityTypeCommandID.AddBranch.toLowerCase():
                        ProcessDesigner.BPFToolBarView.addMode = ProcessDesigner.BPFToolBarAddMode.AddCondition;
                        tileClass = '.' + GenericWorkflowDesigner.BaseTileInformation.tileObjects[ProcessDesigner.BPFActivityType.condition].properties["tileclass"];
                        break;
                    case ProcessDesigner.BPFAddActivityTypeCommandID.AddWorkflow.toLowerCase():
                        ProcessDesigner.BPFToolBarView.addMode = ProcessDesigner.BPFToolBarAddMode.AddWorkflow;
                        tileClass = '.' + GenericWorkflowDesigner.BaseTileInformation.tileObjects[ProcessDesigner.BPFActivityType.workflow].properties["tileclass"];
                        break;
                    case ProcessDesigner.BPFAddActivityTypeCommandID.PasteStep.toLowerCase():
                        ProcessDesigner.BPFToolBarView.addMode = ProcessDesigner.BPFToolBarAddMode.PasteStep;
                        tileClass = '.' + GenericWorkflowDesigner.BaseTileInformation.tileObjects[ProcessDesigner.BPFActivityType.step].properties["tileclass"];
                        break;
                    case ProcessDesigner.BPFAddActivityTypeCommandID.PasteActionStep.toLowerCase():
                        ProcessDesigner.BPFToolBarView.addMode = ProcessDesigner.BPFToolBarAddMode.PasteActionStep;
                        tileClass = '.' + GenericWorkflowDesigner.BaseTileInformation.tileObjects[ProcessDesigner.BPFActivityType.action].properties["tileclass"];
                        break;
                    case ProcessDesigner.BPFAddActivityTypeCommandID.PasteFlowStep.toLowerCase():
                        ProcessDesigner.BPFToolBarView.addMode = ProcessDesigner.BPFToolBarAddMode.PasteFlowStep;
                        tileClass = '.' + GenericWorkflowDesigner.BaseTileInformation.tileObjects[ProcessDesigner.BPFActivityType.flow].properties["tileclass"];
                        break;
                    case ProcessDesigner.BPFAddActivityTypeCommandID.PasteStage.toLowerCase():
                        ProcessDesigner.BPFToolBarView.addMode = ProcessDesigner.BPFToolBarAddMode.PasteStage;
                        tileClass = '.' + GenericWorkflowDesigner.BaseTileInformation.tileObjects[ProcessDesigner.BPFActivityType.stage].properties["tileclass"];
                        break;
                    case ProcessDesigner.BPFAddActivityTypeCommandID.PasteBranch.toLowerCase():
                        ProcessDesigner.BPFToolBarView.addMode = ProcessDesigner.BPFToolBarAddMode.PasteBranch;
                        tileClass = '.' + GenericWorkflowDesigner.BaseTileInformation.tileObjects[ProcessDesigner.BPFActivityType.condition].properties["tileclass"];
                        break;
                    case ProcessDesigner.BPFAddActivityTypeCommandID.PasteWorkflow.toLowerCase():
                        ProcessDesigner.BPFToolBarView.addMode = ProcessDesigner.BPFToolBarAddMode.PasteWorkflow;
                        tileClass = '.' + GenericWorkflowDesigner.BaseTileInformation.tileObjects[ProcessDesigner.BPFActivityType.workflow].properties["tileclass"];
                        break;
                    default:
                        ProcessDesigner.BPFToolBarView.addMode = ProcessDesigner.BPFToolBarAddMode.None;
                }
                tileClass = tileClass + ", .slot:has(" + tileClass + ")";
                if (GenericWorkflowDesigner.CutCommand.cutInProgress && ProcessDesigner.BPFToolBarView.addMode == ProcessDesigner.BPFToolBarAddMode.PasteStage) {
                    var targetDiv = $(event.currentTarget).attr('data-activityID').toString();
                    tileClass = targetDiv;
                    $.event.trigger('PasteButton', [tileClass]);
                }
                else {
                    $.event.trigger('AddButton', [tileClass]);
                }
                $('.hoverOverDroppable').hover(function () {
                    if ($(this).hasClass("hoverOverDroppable")) {
                        $(this).addClass("hoverOverDroppableHighlight");
                    }
                }, function () {
                    $(this).removeClass("hoverOverDroppableHighlight");
                });
                $(".pageSectionsToolbar").find(".toolbarItemContainer").children(".activity-list-container").remove();
                $(".slot").unbind("keydown keypress");
                ProcessDesigner.ControlManager.SetCanvasFocusEvent();
                if ($('#canvas').children("div .slot").first().length > 0) {
                    if ($('#canvas').children("div .slot").first().find(".stageTile").length > 0) {
                        $(".selected.stageTile").removeClass("selected");
                        $(".selected.conditionTile").removeClass("selected");
                        if ($('#canvas').children("div .slot").first().find(".stage-detail-container").length > 0) {
                            $('#canvas').children("div .slot").first().find(".stage-detail-container").addClass("selected");
                        }
                        else if ($(".stage-detail-container.selected").length > 0) {
                            $(".stage-detail-container.selected").removeClass("selected");
                        }
                        $('#canvas').children("div .slot").first().focus();
                        $('#canvas').children("div .slot").first().find(".stageTile").addClass("selected");
                        var activities = GenericWorkflowDesigner.Settings.workflowTree.getActivities();
                        GenericWorkflowDesigner.currentModel = activities[0];
                    }
                }
                $(".ui-droppable.slotInsertVertical.hoverOverDroppable").keydown(function (event) {
                    if (event.keyCode == 40) {
                        AddActivityListSubView.NavigateFromVerticalHitAreaToDownStage(event);
                    }
                    if (event.keyCode == 38) {
                        AddActivityListSubView.NavigateFromVerticalHitAreaToUpStage(event);
                    }
                    event.stopPropagation();
                });
                $(".ui-droppable.slotInsertHorizontal.hoverOverDroppable").keydown(function (event) {
                    if ((GenericWorkflowDesigner.Settings.renderRTL && event.keyCode == 39) || (!GenericWorkflowDesigner.Settings.renderRTL && event.keyCode == 37)) {
                        AddActivityListSubView.NavigateFromHorizontalHitAreaToLeftStage(event);
                    }
                    if ((GenericWorkflowDesigner.Settings.renderRTL && event.keyCode == 37) || (!GenericWorkflowDesigner.Settings.renderRTL && event.keyCode == 39)) {
                        AddActivityListSubView.NavigateFromHorizontalHitAreaToRightStage(event);
                    }
                    event.stopPropagation();
                });
            };
            AddActivityListSubView.NavigateFromHorizontalHitAreaToLeftStage = function (event) {
                var activityToBeFocused;
                if (!((GenericWorkflowDesigner.currentModel.getActivityID() + "_hitarea") == event.target.getAttribute("id"))) {
                    activityToBeFocused = GenericWorkflowDesigner.Settings.workflowTree.getParent(GenericWorkflowDesigner.currentModel);
                    $("#" + activityToBeFocused.id).focus();
                    if ($("#" + activityToBeFocused.id).find(".stageTile").length > 0) {
                        $("#" + activityToBeFocused.id).find(".stageTile").addClass("selected");
                        if ($("#" + activityToBeFocused.id).find(".stage-detail-container").length > 0) {
                            $("#" + activityToBeFocused.id).find(".stage-detail-container").addClass("selected");
                        }
                    }
                    else {
                        $("#" + activityToBeFocused.getActivityID()).find(".conditionTile").addClass("selected");
                    }
                    GenericWorkflowDesigner.currentModel = activityToBeFocused;
                }
                else {
                    activityToBeFocused = GenericWorkflowDesigner.currentModel;
                    $("#" + activityToBeFocused.getActivityID()).focus();
                    if ($("#" + activityToBeFocused.getActivityID()).find(".conditionTile").length > 0) {
                        $("#" + activityToBeFocused.getActivityID()).find(".conditionTile").addClass("selected");
                    }
                    else {
                        $("#" + activityToBeFocused.getActivityID()).find(".stageTile").addClass("selected");
                        if ($("#" + activityToBeFocused.getActivityID()).find(".stage-detail-container").length > 0) {
                            $("#" + activityToBeFocused.getActivityID()).find(".stage-detail-container").addClass("selected");
                        }
                    }
                }
            };
            AddActivityListSubView.NavigateFromHorizontalHitAreaToRightStage = function (event) {
                var activityToBeFocused = GenericWorkflowDesigner.currentModel;
                $("#" + activityToBeFocused.getActivityID()).focus();
                if ($("#" + activityToBeFocused.getActivityID()).find(".conditionTile").length > 0) {
                    $("#" + activityToBeFocused.getActivityID()).find(".conditionTile").addClass("selected");
                }
                else {
                    $("#" + activityToBeFocused.getActivityID()).find(".stageTile").addClass("selected");
                    if ($("#" + activityToBeFocused.getActivityID()).find(".stage-detail-container").length > 0) {
                        $("#" + activityToBeFocused.getActivityID()).find(".stage-detail-container").addClass("selected");
                    }
                }
            };
            AddActivityListSubView.NavigateFromVerticalHitAreaToUpStage = function (event) {
                var activityToBeFocused;
                if ((GenericWorkflowDesigner.currentModel.getActivityID() + "_verticalhitarea") == event.target.getAttribute("id")) {
                    activityToBeFocused = GenericWorkflowDesigner.currentModel;
                    $("#" + activityToBeFocused.getActivityID()).focus();
                    $("#" + activityToBeFocused.getActivityID()).find(".conditionTile").addClass("selected");
                }
                else {
                    activityToBeFocused = GenericWorkflowDesigner.Settings.workflowTree.getParent(GenericWorkflowDesigner.currentModel);
                    $("#" + activityToBeFocused.id).focus();
                    $("#" + activityToBeFocused.id).find(".conditionTile").addClass("selected");
                }
            };
            AddActivityListSubView.NavigateFromVerticalHitAreaToDownStage = function (event) {
                if ((GenericWorkflowDesigner.currentModel.getActivityID() + "_verticalhitarea") === event.target.getAttribute("id")) {
                    var activity;
                    activity = GenericWorkflowDesigner.currentModel;
                    if (activity.getActivityTypeID() === ProcessDesigner.BPFActivityType.condition) {
                        var noBranchFirstChild = activity.getNoBranchFirstChild();
                        if (noBranchFirstChild != null) {
                            $("#" + noBranchFirstChild.id).focus();
                            if ($('#' + noBranchFirstChild.id).children().find(".conditionTile").length > 0) {
                                $("#" + noBranchFirstChild.id).children().find(".conditionTile").addClass("selected");
                            }
                            else if ($('#' + noBranchFirstChild.id).children().find(".stageTile").length > 0) {
                                $("#" + noBranchFirstChild.id).children().find(".stageTile").addClass("selected");
                                if ($("#" + noBranchFirstChild.id).children().find(".stage-detail-container").length > 0) {
                                    $("#" + noBranchFirstChild.id).children().find(".stage-detail-container").addClass("selected");
                                }
                            }
                            GenericWorkflowDesigner.currentModel = noBranchFirstChild;
                        }
                    }
                }
            };
            return AddActivityListSubView;
        })(Backbone.View);
        ProcessDesigner.AddActivityListSubView = AddActivityListSubView;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// -----------------------------------------------------------------------
// <copyright file="BPFToolBarItemView.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
var toolBarItem = GenericWorkflowDesigner.ToolBarItem;
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        "use strict";
        var BPFToolBarItemView = (function (_super) {
            __extends(BPFToolBarItemView, _super);
            function BPFToolBarItemView(model) {
                _super.call(this, model);
            }
            BPFToolBarItemView.prototype.initialize = function () {
            };
            BPFToolBarItemView.prototype.render = function () {
                _super.prototype.render.call(this);
                return this.$el;
            };
            return BPFToolBarItemView;
        })(GenericWorkflowDesigner.ToolBarItemview);
        ProcessDesigner.BPFToolBarItemView = BPFToolBarItemView;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// <copyright file="BPFToolBarView.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
var ToolBarItem = GenericWorkflowDesigner.ToolBarItem;
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        "use strict";
        (function (BPFToolBarAddMode) {
            BPFToolBarAddMode[BPFToolBarAddMode["AddStep"] = 0] = "AddStep";
            BPFToolBarAddMode[BPFToolBarAddMode["AddActionStep"] = 1] = "AddActionStep";
            BPFToolBarAddMode[BPFToolBarAddMode["AddFlowStep"] = 2] = "AddFlowStep";
            BPFToolBarAddMode[BPFToolBarAddMode["AddStage"] = 3] = "AddStage";
            BPFToolBarAddMode[BPFToolBarAddMode["AddCondition"] = 4] = "AddCondition";
            BPFToolBarAddMode[BPFToolBarAddMode["AddWorkflow"] = 5] = "AddWorkflow";
            BPFToolBarAddMode[BPFToolBarAddMode["PasteStage"] = 6] = "PasteStage";
            BPFToolBarAddMode[BPFToolBarAddMode["PasteStep"] = 7] = "PasteStep";
            BPFToolBarAddMode[BPFToolBarAddMode["PasteActionStep"] = 8] = "PasteActionStep";
            BPFToolBarAddMode[BPFToolBarAddMode["PasteFlowStep"] = 9] = "PasteFlowStep";
            BPFToolBarAddMode[BPFToolBarAddMode["PasteBranch"] = 10] = "PasteBranch";
            BPFToolBarAddMode[BPFToolBarAddMode["PasteWorkflow"] = 11] = "PasteWorkflow";
            BPFToolBarAddMode[BPFToolBarAddMode["DropStep"] = 12] = "DropStep";
            BPFToolBarAddMode[BPFToolBarAddMode["DropWorkflow"] = 13] = "DropWorkflow";
            BPFToolBarAddMode[BPFToolBarAddMode["None"] = 14] = "None";
        })(ProcessDesigner.BPFToolBarAddMode || (ProcessDesigner.BPFToolBarAddMode = {}));
        var BPFToolBarAddMode = ProcessDesigner.BPFToolBarAddMode;
        (function (BPFToolBarConnectMode) {
            BPFToolBarConnectMode[BPFToolBarConnectMode["ConnectTile"] = 0] = "ConnectTile";
            BPFToolBarConnectMode[BPFToolBarConnectMode["DisconnectTile"] = 1] = "DisconnectTile";
            BPFToolBarConnectMode[BPFToolBarConnectMode["ReconnectTile"] = 2] = "ReconnectTile";
            BPFToolBarConnectMode[BPFToolBarConnectMode["None"] = 3] = "None";
        })(ProcessDesigner.BPFToolBarConnectMode || (ProcessDesigner.BPFToolBarConnectMode = {}));
        var BPFToolBarConnectMode = ProcessDesigner.BPFToolBarConnectMode;
        var BPFToolBarView = (function (_super) {
            __extends(BPFToolBarView, _super);
            function BPFToolBarView() {
                _super.call(this);
                this.cleanUp();
                this.newItemArray = new Array();
                this.PrepareItem();
                this.PrepareItemViews();
                GenericWorkflowDesigner.EventManager.subscribe(GenericWorkflowDesigner.FrameworkEvents.toolBarItemClick, this.executeCommand, null);
                BPFToolBarView.addMode = BPFToolBarAddMode.None;
                BPFToolBarView.connectMode = BPFToolBarConnectMode.None;
            }
            BPFToolBarView.prototype.initialize = function () {
            };
            BPFToolBarView.prototype.render = function () {
                _super.prototype.render.call(this);
                return this.$el;
            };
            BPFToolBarView.prototype.PrepareItemViews = function () {
                var _this = this;
                _super.prototype.PrepareItemViews.call(this);
                this.newItemArray.forEach(function (item) {
                    var itemView = new ProcessDesigner.BPFToolBarItemView(item);
                    _this.itemViewArray.push(itemView);
                });
            };
            BPFToolBarView.prototype.PrepareItem = function () {
                _super.prototype.PrepareItems.call(this);
            };
            BPFToolBarView.prototype.executeCommand = function (event) {
                var commandType = event.currentTarget.getAttribute("id");
                var handlerFactory = new ProcessDesigner.CommandHandlerFactory();
                return handlerFactory.GetCommandHandler(commandType).execute();
            };
            BPFToolBarView.prototype.cleanUp = function () {
                GenericWorkflowDesigner.EventManager.unsubscribe(GenericWorkflowDesigner.FrameworkEvents.toolBarItemClick, this.executeCommand);
            };
            return BPFToolBarView;
        })(GenericWorkflowDesigner.ToolBarView);
        ProcessDesigner.BPFToolBarView = BPFToolBarView;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
/// <reference path="../Model/Slot/Handlers/ClickHandlers/StageTileButtonClickHandler.ts" />
// -----------------------------------------------------------------------
// <copyright file="TileButtonView.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        "use strict";
        var TileButtonView = (function (_super) {
            __extends(TileButtonView, _super);
            function TileButtonView(model, el) {
                _super.call(this, {
                    model: model,
                    el: el
                });
            }
            TileButtonView.prototype.initialize = function () {
                var stepsCount = this.model.getActivity().steps.length;
                this.tileClickHandler = new ProcessDesigner.StageTileButtonClickHandler(this.model.getActivity());
                var tpCount = this.model.getActivity().workflows.length;
                var stageName = this.model.getActivity().getActivityID();
                this.buttonTemplate = _.template("<div class=\"tileButtonDiv\"><span class=\"stepCountSpan\"><span class=\"stepCountSpanWrapper\"><span class=\"CCFSymbolFont stepTileSymbol tileCountSpanSymbol-size\"></span></span><span class=\"canvasAreaTileTitle3\" id=\"tileCount_" + stageName + "\">" + stepsCount + "</span></span><span class=\"triggerCountSpan\"><span class=\"triggerCountSpanWrapper\"><span class=\"CCFSymbolFont triggerTileSymbol tileCountSpanSymbol-size\"></span></span><span class=\"canvasAreaTileTitle3\" id=\"workflowCount_" + stageName + "\">" + tpCount + "</span></span><span class=\"tileInner ellipsis\"><button class=\"tilebutton\" type=\"submit\" id=\"tileButton_" + stageName + "\" tabindex=\"-1\"><span id=\"tileButtonSpan_" + stageName + "\" class=\"canvasAreaTileTitle4 truncateString\">" + ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_TileButtonSeeDetailsTooltip") + "</span><span class='CCFSymbolFont Expanded-symbol tileButtonImage' id=\"tileButtonImage_" + stageName + "\" ></span></button></span></div>");
            };
            TileButtonView.prototype.render = function () {
                var se = this;
                var ele = this.$el.find('div .stageTile');
                ele.append(this.buttonTemplate);
                this.$el.find('button').on("click", function (event) {
                    se.stageButtonClickedHandler(event);
                });
                return this;
            };
            TileButtonView.prototype.stageButtonClickedHandler = function (event) {
                if (ProcessDesigner.BPFToolBarView.addMode != ProcessDesigner.BPFToolBarAddMode.AddStep) {
                    event.stopPropagation();
                }
                this.tileClickHandler.click(this.$el);
                ProcessDesigner.CanvasDisplayUtility.HandleStageDetailsOverlap();
            };
            return TileButtonView;
        })(Backbone.View);
        ProcessDesigner.TileButtonView = TileButtonView;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// -----------------------------------------------------------------------
// <copyright file="BPFPropertyViewFactory.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        var BPFPropertyViewFactory = (function () {
            function BPFPropertyViewFactory() {
                this.propertyPagePath = "/_static/_common/scripts/processcontrol/";
            }
            BPFPropertyViewFactory.prototype.createProperty = function (currentModel) {
                var nodeType = currentModel.getActivityTypeID();
                var pageBaseUrl = this.getPropertyPageBaseUrl(nodeType);
                switch (nodeType) {
                    case ProcessDesigner.BPFActivityType.stage:
                        return new ProcessDesigner.StagePropertyView(currentModel, pageBaseUrl);
                    case ProcessDesigner.BPFActivityType.condition:
                        return new ProcessDesigner.BranchPropertyView(currentModel, pageBaseUrl);
                    case ProcessDesigner.BPFActivityType.step:
                        return new ProcessDesigner.StepPropertyView(currentModel, pageBaseUrl);
                    case ProcessDesigner.BPFActivityType.workflow:
                        return new ProcessDesigner.WorkflowPropertyView(currentModel, pageBaseUrl);
                    case ProcessDesigner.BPFActivityType.action:
                        return new ProcessDesigner.ActionStepPropertyView(currentModel, pageBaseUrl);
                    case ProcessDesigner.BPFActivityType.flow:
                        return new ProcessDesigner.FlowStepPropertyView(currentModel, pageBaseUrl);
                    default:
                        return null;
                }
            };
            BPFPropertyViewFactory.prototype.getPropertyPageBaseUrl = function (pageType) {
                var propertyPageBaseUrl;
                switch (pageType) {
                    case ProcessDesigner.BPFActivityType.stage:
                        propertyPageBaseUrl = GenericWorkflowDesigner.BaseTileInformation.tileObjects[ProcessDesigner.BPFActivityType.stage].properties["propertypageurl"];
                        break;
                    case ProcessDesigner.BPFActivityType.condition:
                        propertyPageBaseUrl = GenericWorkflowDesigner.BaseTileInformation.tileObjects[ProcessDesigner.BPFActivityType.condition].properties["propertypageurl"];
                        break;
                    case ProcessDesigner.BPFActivityType.step:
                        propertyPageBaseUrl = GenericWorkflowDesigner.BaseTileInformation.tileObjects[ProcessDesigner.BPFActivityType.step].properties["propertypageurl"];
                        break;
                    case ProcessDesigner.BPFActivityType.action:
                        propertyPageBaseUrl = GenericWorkflowDesigner.BaseTileInformation.tileObjects[ProcessDesigner.BPFActivityType.action].properties["propertypageurl"];
                        break;
                    case ProcessDesigner.BPFActivityType.flow:
                        propertyPageBaseUrl = GenericWorkflowDesigner.BaseTileInformation.tileObjects[ProcessDesigner.BPFActivityType.flow].properties["propertypageurl"];
                        break;
                    case ProcessDesigner.BPFActivityType.workflow:
                        propertyPageBaseUrl = GenericWorkflowDesigner.BaseTileInformation.tileObjects[ProcessDesigner.BPFActivityType.workflow].properties["propertypageurl"];
                        break;
                }
                var absolutePropertyPageBaseUrl = this.getUrl() + this.propertyPagePath + propertyPageBaseUrl;
                return absolutePropertyPageBaseUrl;
            };
            BPFPropertyViewFactory.prototype.getUrl = function () {
                var port = window.location.port;
                var host = window.location.hostname;
                var orgUrl = window.location.protocol + '//' + host;
                if (port) {
                    orgUrl += ":" + port;
                }
                return orgUrl;
            };
            return BPFPropertyViewFactory;
        })();
        ProcessDesigner.BPFPropertyViewFactory = BPFPropertyViewFactory;
        var PropertyHtmlPageName = (function () {
            function PropertyHtmlPageName() {
            }
            PropertyHtmlPageName.stage = "StagePropertyDetails";
            PropertyHtmlPageName.condition = "BranchPropertyDetails";
            PropertyHtmlPageName.step = "StepPropertyDetails";
            PropertyHtmlPageName.workflow = "WorkflowPropertyDetails";
            return PropertyHtmlPageName;
        })();
        ProcessDesigner.PropertyHtmlPageName = PropertyHtmlPageName;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// ---------------------------------------------------------------------------------------------
//  <copyright file="DefaultBranchIndices.ts" company="Microsoft">
//         Copyright (c) Microsoft Corporation.  All rights reserved.
//  </copyright>
// 
//  <summary>
//  Class containing the BPFActivityType Process
//  </summary>
// 
// ---------------------------------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        'use strict';
        var DefaultBranchIndices = (function () {
            function DefaultBranchIndices() {
            }
            DefaultBranchIndices.DefaultBranch = 0;
            DefaultBranchIndices.YesBranch = 1;
            DefaultBranchIndices.NoBranch = 2;
            return DefaultBranchIndices;
        })();
        ProcessDesigner.DefaultBranchIndices = DefaultBranchIndices;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
//---------------------------------------------------------------------------------------------
// <copyright file="ConditionActivityTileInformation.ts" company="Microsoft">
//		Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
//
// <summary>
// Represent the tile information of the condition activity
// </summary>
//
//---------------------------------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        var ConditionActivityTileInformation = (function (_super) {
            __extends(ConditionActivityTileInformation, _super);
            function ConditionActivityTileInformation(model, itemId) {
                _super.call(this, model, itemId);
                this.StageActivityTemplate = "<span class=\"tileTitle\" ><span class=\"tileTableCell\"><div><span class= \"tileInner ellipsis canvasAreaTileTitle1\" > <%- Subtitle %></span></div><span class=\"tileInner ellipsis stringTruncation canvasAreaTileTitle2\"><%- Title %></span> </span></span> ";
                this.ConditionTemplate = '<span class="tileImageWrapper" ><%if(typeof(image) !== "undefined"){%><img class="tileImage" src="<%- image %>" alt="<%- alt %>"></img><%}%><%if(typeof(dataURI) !== "undefined"){%><img class="tileImage" src="data:png;base64,<%- dataURI %>" alt="<%- alt %>"></img><%}%><%if(typeof(fontIconImage) !== "undefined"){%><span class="tileFontIcon CCFSymbolFont <%- fontIconImage %>"></span><%}%></span><div class="condition-footer-div"></div>';
            }
            ConditionActivityTileInformation.prototype.GetProperties = function () {
                var result = _super.prototype.GetBasicTileProperties.call(this);
                result["emptyTitleText"] = ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_ConditionActivityTileInfo");
                result["Title"] = this.activityModel.parentStageEntityName;
                result["Subtitle"] = ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_LibraryTileName_condition");
                result["emptyTileImageTemplate"] = this.ConditionTemplate;
                result["emptyTileTemplate"] = this.StageActivityTemplate;
                result["activityTypeName"] = ProcessDesigner.MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_Condition_Activity_Name");
                return result;
            };
            return ConditionActivityTileInformation;
        })(GenericWorkflowDesigner.BaseTileInformation);
        ProcessDesigner.ConditionActivityTileInformation = ConditionActivityTileInformation;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        var ResourceId = (function () {
            function ResourceId() {
            }
            ResourceId.EmptyActivityText = "[DRAG ELEMENT HERE]";
            ResourceId.ConditionYes = "ConditionYes";
            ResourceId.ConditionNo = "ConditionNo";
            ResourceId.LibraryGeneral = "LibraryGeneral";
            ResourceId.LibraryStage = "LibraryStage";
            ResourceId.LibraryCondition = "LibraryCondition";
            ResourceId.LibraryAction = "LibraryAction";
            ResourceId.LibraryCreateRecord = "LibraryCreateRecord";
            ResourceId.PropertyTitle = "PropertyTitle";
            ResourceId.CreateTileTitleFormat = "CreateTileTitleFormat";
            ResourceId.StopTileTitleFormat = "StopTileTitleFormat";
            ResourceId.SendEmailTileTitleFormat = "SendEmailTileTitleFormat";
            ResourceId.Description = "ProcessDescription";
            ResourceId.ConditionText = "ProcessConditionText";
            ResourceId.Entity = "ProcessEntity";
            ResourceId.PropertyPanelAriaLabel = "[PROPERTY PANEL ARIA LABEL]";
            ResourceId.ConfirmText = "ConfirmText";
            ResourceId.DiscardText = "DiscardText";
            ResourceId.StagePropertyPropertyTitle = "StagePropertyPropertyTitle";
            ResourceId.StagePropertyStageName = "StagePropertyStageName";
            ResourceId.StagePropertyStageCategory = "StagePropertyStageCategory";
            ResourceId.StagePropertyStageCategoryEmpty = "StagePropertyStageCategoryEmpty";
            ResourceId.StagePropertyEntity = "StagePropertyEntity";
            ResourceId.StagePropertyStepsSectionTitle = "StagePropertyStepsSectionTitle";
            ResourceId.StagePropertyStepHeader = "StagePropertyStepHeader";
            ResourceId.StagePropertyTypeHeader = "StagePropertyTypeHeader";
            ResourceId.StagePropertyFieldHeader = "StagePropertyFieldHeader";
            ResourceId.StagePropertyTypeValue = "StagePropertyTypeValue";
            ResourceId.StagePropertyRelationshipSectionTitle = "StagePropertyRelationshipSectionTitle";
            ResourceId.StagePropertyParentStageHeader = "StagePropertyParentStageHeader";
            ResourceId.StagePropertyParentEntityHeader = "StagePropertyParentEntityHeader";
            ResourceId.StagePropertyRelationshipHeader = "StagePropertyRelationshipColumnHeader";
            ResourceId.StagePropertyPropertyEntityTitle = "StagePropertyPropertyEntityTitle";
            ResourceId.AssignPropertyTitle = "AssignPropertyTitle";
            ResourceId.AssignPropertyAssignTo = "AssignPropertyAssignTo";
            ResourceId.CreatePropertyTitle = "CreatePropertyTitle";
            ResourceId.CreatePropertyFieldValues = "CreatePropertyFieldValues";
            ResourceId.UpdatePropertyTitle = "UpdatePropertyTitle";
            ResourceId.UpdatePropertyFieldValues = "UpdatePropertyFieldValues";
            ResourceId.ChangeStatusPropertyTitle = "ChangeStatusPropertyTitle";
            ResourceId.ChangeStatusPropertyStatus = "ChangeStatusPropertyStatus";
            ResourceId.CustomActivityPropertyTitle = "CustomActivityPropertyTitle";
            ResourceId.CustomActivityPropertyActivity = "CustomActivityPropertyActivity";
            ResourceId.ConditionPropertyTitle = "ConditionPropertyTitle";
            ResourceId.ConditionPropertyConditionTextLabel = "ConditionPropertyConditionTextLabel";
            ResourceId.ConditionPropertyEmptyPlaceholder = "ConditionPropertyEmptyPlaceholder";
            ResourceId.WaitBranchPropertyTitle = "WaitBranchPropertyTitle";
            ResourceId.WaitBranchPropertyConditionTextLabel = "WaitBranchPropertyConditionTextLabel";
            ResourceId.WaitPropertyTitle = "WaitPropertyTitle";
            ResourceId.WaitPropertyDisplayText = "WaitPropertyDisplayText";
            ResourceId.WaitTileTitle = "WaitTileTitle";
            ResourceId.SendEmailPropertyTitle = "SendEmailPropertyTitle";
            ResourceId.SendEmailPropertyEntity = "SendEmailPropertyEntity";
            ResourceId.SendEmailPropertyTemplate = "SendEmailPropertyTemplate";
            ResourceId.SendEmailPropertyBody = "SendEmailPropertyBody";
            ResourceId.ChildWorkflowPropertyTitle = "ChildWorkflowPropertyTitle";
            ResourceId.ChildWorkflowPropertyEntity = "ChildWorkflowPropertyEntity";
            ResourceId.ChildWorkflowPropertyWorkflowLabel = "ChildWorkflowPropertyWorkflowLabel";
            ResourceId.StopWorkflowPropertyTitle = "StopWorkflowPropertyTitle";
            ResourceId.StopWorkflowPropertyStatus = "StopWorkflowPropertyStatus";
            ResourceId.StopWorkflowPropertyStatusMessage = "StopWorkflowPropertyStatusMessage";
            ResourceId.ExecutionTime = "ExecutionTime";
            ResourceId.WorkflowTileTitle = "WorkflowTileTitle";
            ResourceId.WorkflowPropertyTitle = "WorkflowPropertyTitle";
            ResourceId.WorkflowPropertyEntity = "WorkflowPropertyEntity";
            ResourceId.WorkflowPropertyScope = "WorkflowPropertyScope";
            ResourceId.WorkflowPropertyUsageLabel = "WorkflowPropertyUsageLabel";
            ResourceId.WorkflowPropertyUsageChild = "WorkflowPropertyUsageChild";
            ResourceId.WorkflowPropertyUsageOnDemand = "WorkflowPropertyUsageOnDemand";
            ResourceId.WorkflowPropertyTriggerOnLabel = "WorkflowPropertyTriggerOnLabel";
            ResourceId.WorkflowPropertyTriggerCreateLabel = "WorkflowPropertyTriggerCreateLabel";
            ResourceId.WorkflowPropertyTriggerDeleteLabel = "WorkflowPropertyTriggerDeleteLabel";
            ResourceId.WorkflowPropertyTriggerLabel = "WorkflowPropertyTriggerLabel";
            ResourceId.WorkflowPropertyTriggerNone = "WorkflowPropertyTriggerNone";
            ResourceId.ActionTileTitle = "ActionTileTitle";
            ResourceId.ActionPropertyTitle = "ActionPropertyTitle";
            ResourceId.ActionPropertyIsTransacted = "ActionPropertyIsTransacted";
            ResourceId.ActionArgumentInput = "ActionArgumentInput";
            ResourceId.ActionArgumentOutput = "ActionArgumentOutput";
            ResourceId.ActionArgumentName = "ActionArgumentName";
            ResourceId.ActionArgumentType = "ActionArgumentType";
            ResourceId.BusinessProcessTileTitle = "BusinessProcessTileTitle";
            ResourceId.BusinessProcessPropertyTitle = "BusinessProcessPropertyTitle";
            ResourceId.BusinessProcessPropertyEntity = "BusinessProcessPropertyEntity";
            ResourceId.BusinessProcessPropertyOwner = "BusinessProcessPropertyOwner";
            ResourceId.BusinessProcessPropertyDescription = "BusinessProcessPropertyDescription";
            ResourceId.BusinessProcessPropertyRoleName = "BusinessProcessPropertyRoleName";
            ResourceId.BusinessProcessPropertyRoleBusinessUnit = "BBusinessProcessPropertyRoleBusinessUnit";
            ResourceId.BusinessProcessPropertySecurityRoles = "BusinessProcessPropertySecurityRoles";
            ResourceId.WorkflowRuntimeStatusLabel = "WorkflowRuntimeStatusLabel";
            ResourceId.PropertyPanelPlaceholderText = "PropertyPanelPlaceholderText";
            ResourceId.EmptyPropertyPlaceholder = "EmptyPropertyPlaceholder";
            ResourceId.RuntimeWorkflowPropertyExecutionDetailsLabel = "RuntimeWorkflowPropertyExecutionDetailsLabel";
            ResourceId.RuntimeJobOwnerLabel = "RuntimeJobOwnerLabel";
            ResourceId.RuntimeRegardingLabel = "RuntimeRegardingLabel";
            ResourceId.RuntimeCreatedOnLabel = "RuntimeCreatedOnLabel";
            ResourceId.RuntimeCompletedOnLabel = "RuntimeCompletedOnLabel";
            ResourceId.RuntimeRetryCountLabel = "RuntimeRetryCountLabel";
            ResourceId.RuntimeStartReasonLabel = "RuntimeStartReasonLabel";
            ResourceId.RuntimePostponeUntilLabel = "RuntimePostponeUntilLabel";
            ResourceId.DialogTileTitle = "DialogTileTitle";
            ResourceId.DialogPropertyTitle = "DialogPropertyTitle";
            ResourceId.DialogInputArguments = "DialogInputArguments";
            ResourceId.DialogVariables = "DialogVariables";
            ResourceId.DialogDefaultValues = "DialogDefaultValues";
            ResourceId.ChildDialogTileTitle = "ChildDialogTileTitle";
            ResourceId.ChildDialogPropertyTitle = "ChildDialogPropertyTitle";
            ResourceId.Dialog = "Dialog";
            ResourceId.PageTileTitle = "PageTileTitle";
            ResourceId.PagePropertyTitle = "PagePropertyTitle";
            ResourceId.PromptAndResponse = "PromptAndResponse";
            ResourceId.AssignValueTileStringFormat = "AssignValueTileStringFormat";
            ResourceId.AssignValuePropertyTitle = "AssignValuePropertyTitle";
            ResourceId.AssignValueVariableName = "AssignValueVariableName";
            ResourceId.Value = "Value";
            ResourceId.QueryTileTitle = "QueryTileTitle";
            ResourceId.QueryPropertyTitle = "QueryPropertyTitle";
            ResourceId.StatementLabel = "StatementLabel";
            return ResourceId;
        })();
        ProcessDesigner.ResourceId = ResourceId;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// -----------------------------------------------------------------------
// <copyright file="EntityRelationshipUtility.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        'use strict';
        var EntityRelationshipUtility = (function () {
            function EntityRelationshipUtility() {
            }
            EntityRelationshipUtility.setRelationshipValues = function (list) {
                var relationshipValue = {};
                var relationshipList = [];
                var attributeValues = [];
                if (list.length > 0) {
                    relationshipValue.hasRelationship = "true";
                    for (var i = 0; i < list.length; i++) {
                        attributeValues = [];
                        attributeValues.splice(0, 0, list[i].displayName);
                        attributeValues.splice(1, 0, list[i].attributeName);
                        attributeValues.splice(2, 0, list[i].logicalName);
                        relationshipList.splice(i, 0, attributeValues);
                    }
                    relationshipValue.relationshipNameChild = relationshipList;
                }
                else {
                    relationshipValue.hasRelationship = "false";
                }
                EntityRelationshipUtility.relationshipValues = relationshipValue;
            };
            EntityRelationshipUtility.getRelationshipValues = function (parentStageEntityName, childStageEntityName) {
                MscrmControls.ProcessDesigner.MetadataProvider.getRelationshipMetadata(parentStageEntityName, childStageEntityName, EntityRelationshipUtility.setRelationshipValues, EntityRelationshipUtility.getRelationshipMetadataFailureCallback);
                return;
            };
            EntityRelationshipUtility.findRelationship = function (allModels, currentStageID, newEntityName) {
                var parentChildRelation = {};
                var parentChildRelationSet = [];
                var modelClone = allModels;
                var listOfChildren;
                var listOfRelations;
                var relationCount = 0;
                var currentEntityValue = $("#entityName").val();
                Object.keys(allModels).forEach(function (itemi, iCtr) {
                    parentChildRelation = {};
                    EntityRelationshipUtility.relationshipValues = {};
                    if (allModels[iCtr].getActivityTypeID() === "stage") {
                        parentChildRelation.ParentDisplayName = allModels[iCtr].displayName;
                        parentChildRelation.ParentEntityName = allModels[iCtr].entityName;
                        parentChildRelation.ParentStageID = allModels[iCtr].stageId;
                        parentChildRelation.NextActivityID = allModels[iCtr].attributes.NextActivityID;
                        listOfChildren = [];
                        listOfRelations = [];
                        Object.keys(modelClone).forEach(function (itemj, jCtr) {
                            if (modelClone[jCtr].getActivityTypeID() === "stage" && allModels[iCtr].entityName !== currentEntityValue
                                && (allModels[iCtr].nextActivity !== undefined
                                    && allModels[iCtr].nextActivity.stageId === modelClone[jCtr].stageId && allModels[iCtr].attributes.NextActivityID === modelClone[jCtr].attributes.ActivityID)) {
                                if (currentStageID !== undefined && newEntityName !== undefined && allModels[iCtr].nextActivity.stageId === currentStageID)
                                    EntityRelationshipUtility.getRelationshipValues(allModels[iCtr].entityName, newEntityName);
                                else
                                    EntityRelationshipUtility.getRelationshipValues(allModels[iCtr].entityName, modelClone[jCtr].entityName);
                                if (EntityRelationshipUtility.relationshipValues.hasRelationship === "true") {
                                    listOfChildren.push({ "displayName": modelClone[jCtr].displayName, "childStageId": modelClone[jCtr].stageId, "childEntityName": modelClone[jCtr].entityName });
                                    for (var relCount = 0; relCount < EntityRelationshipUtility.relationshipValues.relationshipNameChild.length; relCount++)
                                        listOfRelations.splice(relCount, 0, EntityRelationshipUtility.relationshipValues.relationshipNameChild[relCount].slice());
                                }
                            }
                        });
                        if (listOfRelations.length > 0) {
                            parentChildRelation.ChildDetails = listOfChildren;
                            parentChildRelation.ParentChildRelationShipName = listOfRelations;
                            parentChildRelationSet[relationCount++] = parentChildRelation;
                        }
                    }
                });
                var allChildList = EntityRelationshipUtility.allChildrenList(parentChildRelationSet);
                var uniqueList = EntityRelationshipUtility.uniqueChildrenList(allChildList);
                var backRelation = EntityRelationshipUtility.findBackRelationship(parentChildRelationSet, uniqueList);
                if (backRelation.length > 0) {
                    var filteredBackRelation = [];
                    for (var i = 0, j = 0; i < backRelation[0].length; i++) {
                        if (backRelation[0][i] !== undefined && backRelation[0][i].NextActivityID !== null) {
                            filteredBackRelation.splice(j, 0, backRelation[0][i]);
                            j += 1;
                        }
                    }
                    backRelation[0] = filteredBackRelation;
                }
                return backRelation;
            };
            EntityRelationshipUtility.allChildrenList = function (list) {
                var childList = [];
                var count = 0;
                for (var i = 0; i < list.length; i++) {
                    for (var j = 0; j < list[i].ChildDetails.length; j++) {
                        childList[count++] = list[i].ChildDetails[j].childStageId;
                    }
                }
                return childList;
            };
            EntityRelationshipUtility.uniqueList = function (value, index, self) {
                return self.indexOf(value) === index;
            };
            EntityRelationshipUtility.uniqueChildrenList = function (list) {
                var uniqueChildrenList = list.filter(EntityRelationshipUtility.uniqueList);
                return uniqueChildrenList;
            };
            EntityRelationshipUtility.findBackRelationship = function (rset, ulist) {
                var backRelation = [];
                var parentsList = [];
                var count = 0;
                var flag = 0;
                for (var i = 0; i < ulist.length; i++) {
                    count = 0;
                    parentsList = [];
                    for (var j = 0; j < rset.length; j++) {
                        flag = 0;
                        for (var k = 0; k < rset[j].ChildDetails.length && flag === 0; k++) {
                            if (ulist[i] === rset[j].ChildDetails[k].childStageId) {
                                parentsList[count++] = rset[j];
                                flag = 1;
                            }
                        }
                    }
                    if (parentsList.length > 0)
                        backRelation.splice(ulist[i], 0, parentsList);
                }
                return backRelation;
            };
            EntityRelationshipUtility.isDefaultStage = function (relations, stageId) {
                var rel;
                for (var k in relations) {
                    for (var e in relations[k]) {
                        rel = relations[k][e];
                        if (rel.ChildDetails[0].childStageId === stageId)
                            return true;
                    }
                }
                return false;
            };
            EntityRelationshipUtility.getRelationshipMetadataFailureCallback = function () { };
            EntityRelationshipUtility.relationshipValues = {};
            return EntityRelationshipUtility;
        })();
        ProcessDesigner.EntityRelationshipUtility = EntityRelationshipUtility;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// -----------------------------------------------------------------------
// <copyright file="LookupContext.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        "use strict";
        var LookupContext = (function () {
            function LookupContext(entitySetName, attributes, numberOfRecords, filter, lookupmoreRecordsProxy, successCallback, errorCallback, callbackContext, lookupItemClickCallback, callerActivityType) {
                this._numberOfRecords = 0;
                this._lookupmoreRecordsProxy = null;
                this._entitySetName = entitySetName;
                this._numberOfRecords = numberOfRecords;
                this._filter = filter;
                this._attributes = attributes;
                this._successCallback = successCallback;
                this._errorCallback = errorCallback;
                this._queryString = LookupContext.generateQueryString(this._attributes, this._numberOfRecords, this._filter);
                this._lookupmoreRecordsProxy = lookupmoreRecordsProxy;
                this._callbackContext = callbackContext;
                this._lookupItemClickCallback = lookupItemClickCallback;
                this._callerActivityType = callerActivityType;
            }
            LookupContext.prototype.callerActivityType = function () {
                return this._callerActivityType;
            };
            LookupContext.generateQueryString = function (attributes, numberOfRecords, filter) {
                return "$select=" + attributes.join(',') + "&$top=" + numberOfRecords + "&$filter=" + filter;
            };
            LookupContext.prototype.lookupMoreRecords = function (callback) {
                if (!CommonTypes.Types.Object.isNullOrUndefined(this._lookupmoreRecordsProxy)) {
                    this._lookupmoreRecordsProxy(callback, this._callbackContext);
                }
            };
            LookupContext.prototype.lookupRecords = function (lookupStirng, callback) {
                var self = this;
                var newFilter = this._filter;
                if (this._callbackContext instanceof ProcessDesigner.BPFActionStepActivity) {
                    var startswith = "";
                    if (!CommonTypes.Types.Object.isNullOrUndefined(lookupStirng) && lookupStirng.length > 0) {
                        startswith = lookupStirng;
                    }
                    ProcessDesigner.MetadataProvider.retrieveUISupportedProcesses(startswith, newFilter, false, function (records) {
                        var lookupRecords = self._successCallback(records, self._callbackContext);
                        callback(lookupRecords);
                    }, function (error) {
                        callback(error);
                    });
                }
                else {
                    if (!CommonTypes.Types.Object.isNullOrUndefined(lookupStirng) && lookupStirng.length > 0) {
                        var startsWithFilter = " and startswith(name, '" + lookupStirng + "')";
                        newFilter = this._filter + startsWithFilter;
                    }
                    this._queryString = LookupContext.generateQueryString(this._attributes, this._numberOfRecords, newFilter);
                    ProcessDesigner.MetadataProvider.retrieveRecords(this._entitySetName, this._queryString, function (records) {
                        var lookupRecords = self._successCallback(records, self._callbackContext);
                        callback(lookupRecords);
                    }, function (error) {
                        callback(error);
                    });
                }
            };
            LookupContext.prototype.postLookupItemSelection = function () {
                if (!CommonTypes.Types.Object.isNullOrUndefined(this._lookupItemClickCallback)) {
                    this._lookupItemClickCallback();
                }
            };
            return LookupContext;
        })();
        ProcessDesigner.LookupContext = LookupContext;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// -----------------------------------------------------------------------
// <copyright file="CanvasDisplayUtility.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        'use strict';
        var CanvasDisplayUtility = (function () {
            function CanvasDisplayUtility() {
            }
            CanvasDisplayUtility.HandleStageDetailsOverlap = function () {
                if ($(".stage-detail-container-div").css("visibility") == "visible"
                    && !CommonTypes.Types.Object.isNullOrUndefined($(".stage-detail-container").css("visibility"))
                    && $(CanvasDisplayUtility.miniMapWrapperDivId).css("visibility") == "visible") {
                    if (CanvasDisplayUtility.Collision($("#mini-map-wrapper"), $(".stage-detail-container"))) {
                        $(CanvasDisplayUtility.miniMapWrapperDivId).css("visibility", "hidden");
                        $(CanvasDisplayUtility.showMiniMapDivId).css("visibility", "visible");
                        CanvasDisplayUtility.isMinimpStateChanged = true;
                    }
                    else {
                        if (CanvasDisplayUtility.isMinimpStateChanged == true) {
                            CanvasDisplayUtility.toggleStatus();
                            CanvasDisplayUtility.isMinimpStateChanged = false;
                        }
                    }
                }
                else {
                    if (CanvasDisplayUtility.isMinimpStateChanged == true) {
                        if (!CommonTypes.Types.Object.isNullOrUndefined($(".stage-detail-container").css("visibility"))) {
                            if (!CanvasDisplayUtility.Collision($("#mini-map-wrapper"), $(".stage-detail-container"))) {
                                CanvasDisplayUtility.toggleStatus();
                                CanvasDisplayUtility.isMinimpStateChanged = false;
                            }
                        }
                        else {
                            CanvasDisplayUtility.toggleStatus();
                            CanvasDisplayUtility.isMinimpStateChanged = false;
                        }
                    }
                }
            };
            CanvasDisplayUtility.toggleStatus = function () {
                if ($(CanvasDisplayUtility.miniMapWrapperDivId).css("visibility") == "visible") {
                    $(CanvasDisplayUtility.miniMapWrapperDivId).css("visibility", "hidden");
                }
                else {
                    $(CanvasDisplayUtility.miniMapWrapperDivId).css("visibility", "visible");
                }
                if ($(CanvasDisplayUtility.showMiniMapDivId).css("visibility") == "visible") {
                    $(CanvasDisplayUtility.showMiniMapDivId).css("visibility", "hidden");
                }
                else {
                    $(CanvasDisplayUtility.showMiniMapDivId).css("visibility", "visible");
                }
            };
            CanvasDisplayUtility.Collision = function ($div1, $div2) {
                var x1 = $div1.offset().left;
                var y1 = $div1.offset().top;
                var h1 = $div1.outerHeight(true);
                var w1 = $div1.outerWidth(true);
                var b1 = y1 + h1;
                var r1 = x1 + w1;
                var x2 = $div2.offset().left;
                var y2 = $div2.offset().top;
                var h2 = $div2.outerHeight(true);
                var w2 = $div2.outerWidth(true);
                var b2 = y2 + h2;
                var r2 = x2 + w2;
                if (b1 < y2 || y1 > b2 || r1 < x2 || x1 > r2)
                    return false;
                return true;
            };
            CanvasDisplayUtility.isMinimpStateChanged = false;
            CanvasDisplayUtility.miniMapWrapperDivId = "#mini-map-wrapper";
            CanvasDisplayUtility.showMiniMapDivId = "#show-mini-map-div";
            return CanvasDisplayUtility;
        })();
        ProcessDesigner.CanvasDisplayUtility = CanvasDisplayUtility;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// -----------------------------------------------------------------------
// <copyright file="Event.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        'use strict';
        var Event = (function () {
            function Event() {
            }
            Event.prototype.invoke = function (data) {
                for (var i = 0; i < this.listeners.length; ++i) {
                    this.listeners[i](data);
                }
            };
            Event.prototype.add = function (listener) {
                this.listeners.push(listener);
            };
            Event.prototype.remove = function (listener) {
            };
            return Event;
        })();
        ProcessDesigner.Event = Event;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// -----------------------------------------------------------------------
// <copyright file="INotifyPropertyChanged.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        'use strict';
        var PropertyChangeEventArgs = (function () {
            function PropertyChangeEventArgs(propertyName) {
                if (propertyName === void 0) { propertyName = ""; }
                this.propertyName = propertyName;
            }
            return PropertyChangeEventArgs;
        })();
        ProcessDesigner.PropertyChangeEventArgs = PropertyChangeEventArgs;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// -----------------------------------------------------------------------
// <copyright file="ProcessDesignerControlManager.ts" company="Microsoft">//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
/// <reference path="../src/Control/BPF/Converter/BPFToActivityCollectionVisitor.ts"/>
/// <reference path="../src/Control/BPF/View/BPFPropertyViewFactory.ts"/>
/// <reference path="../src/Utility/EntityRelationshipUtility.ts" />
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        'use strict';
        var WorkflowObjectModel = Microsoft.Crm.Workflow.ObjectModel;
        var EntityRelationshipUtil = MscrmControls.ProcessDesigner.EntityRelationshipUtility;
        var ControlManager = (function () {
            function ControlManager(container) {
                this.container = container;
                this.gwfdesigner = new GenericWorkflowDesigner.GenericWorkflowControl();
            }
            ControlManager.prototype.initialize = function (processObject) {
                ControlManager.processObject = processObject;
                GenericWorkflowDesigner.EventManager.subscribe(GenericWorkflowDesigner.FrameworkEvents.editDone, this.editDone, null);
                GenericWorkflowDesigner.EventManager.subscribe(GenericWorkflowDesigner.FrameworkEvents.runValidation, this.runValidation, null);
                GenericWorkflowDesigner.EventManager.subscribe(GenericWorkflowDesigner.FrameworkEvents.activityDropped, ProcessDesigner.ProcessActivityDefinitionModel.prototype.reinitialize, null);
                GenericWorkflowDesigner.EventManager.subscribe(GenericWorkflowDesigner.FrameworkEvents.resetToolbar, this.resetToolbar, null);
                GenericWorkflowDesigner.EventManager.subscribe(GenericWorkflowDesigner.FrameworkEvents.activityDeleted, this.deleteDone, null);
                GenericWorkflowDesigner.EventManager.subscribe(GenericWorkflowDesigner.FrameworkEvents.refreshToolbarItems, this.refreshToolbarItems, null);
                GenericWorkflowDesigner.EventManager.subscribe(GenericWorkflowDesigner.FrameworkEvents.setKeyDownEvents, ControlManager.SetCanvasFocusEvent, null);
                GenericWorkflowDesigner.EventManager.subscribe(GenericWorkflowDesigner.FrameworkEvents.updateTileTitle, this.updateTileTitle, null);
                GenericWorkflowDesigner.EventManager.subscribe(GenericWorkflowDesigner.FrameworkEvents.clearSelections, ControlManager.ClearSelections, null);
                GenericWorkflowDesigner.EventManager.subscribe(GenericWorkflowDesigner.FrameworkEvents.refreshPropertyPageErrorMessages, function () {
                    if (!CommonTypes.Types.Object.isNullOrUndefined(ProcessDesigner.Validation.Errors.refreshErrorMessages))
                        ProcessDesigner.Validation.Errors.refreshErrorMessages();
                }, null);
                ControlManager.globalWorkflowObject = new ProcessDesigner.BPFGlobalWorkflowActivity();
            };
            ControlManager.setProcessTitle = function (title) {
                ControlManager.processTitle = title;
                ProcessDesigner.ProcessDesignerControl.Title = title;
            };
            ControlManager.setProcessDescription = function (description) {
                ControlManager.processDescription = description;
                ProcessDesigner.ProcessDesignerControl.Description = description;
            };
            ControlManager.prototype.editDone = function () {
                ControlManager.processObject.editDone();
                if (ProcessDesigner.ValidateBPF.shouldValidate()) {
                    if (ProcessDesigner.ProcessDesignerControl.validationMode == GenericWorkflowDesigner.ValidationMode.None) {
                        if (ProcessDesigner.Validation.Engine.getLastAction() == ProcessDesigner.Validation.Level.Save) {
                            ProcessDesigner.Validation.Engine.setAction(ProcessDesigner.Validation.Level.Save);
                        }
                    }
                    else {
                        ProcessDesigner.Validation.Engine.setAction(ProcessDesigner.Validation.Level.Validate);
                    }
                    ProcessDesigner.ValidateBPF.validate();
                }
            };
            ControlManager.prototype.runValidation = function () {
                if (ProcessDesigner.ValidateBPF.shouldValidate()) {
                    if (ProcessDesigner.ProcessDesignerControl.validationMode == GenericWorkflowDesigner.ValidationMode.None) {
                        if (ProcessDesigner.Validation.Engine.getLastAction() == ProcessDesigner.Validation.Level.Save) {
                            ProcessDesigner.Validation.Engine.setAction(ProcessDesigner.Validation.Level.Save);
                        }
                    }
                    else {
                        ProcessDesigner.Validation.Engine.setAction(ProcessDesigner.Validation.Level.Validate);
                    }
                    ProcessDesigner.ValidateBPF.validate();
                }
            };
            ControlManager.prototype.resetToolbar = function () {
                GenericWorkflowDesigner.updateCurrentModel(null);
                if (ProcessDesigner.BPFToolBarView.addMode == ProcessDesigner.BPFToolBarAddMode.AddStep || ProcessDesigner.BPFToolBarView.addMode == ProcessDesigner.BPFToolBarAddMode.PasteStep ||
                    ProcessDesigner.BPFToolBarView.addMode == ProcessDesigner.BPFToolBarAddMode.AddActionStep || ProcessDesigner.BPFToolBarView.addMode == ProcessDesigner.BPFToolBarAddMode.PasteActionStep ||
                    ProcessDesigner.BPFToolBarView.addMode == ProcessDesigner.BPFToolBarAddMode.AddFlowStep || ProcessDesigner.BPFToolBarView.addMode == ProcessDesigner.BPFToolBarAddMode.PasteFlowStep) {
                    $('#sortable').children().remove(".place-holder-listitem");
                }
                if (ProcessDesigner.BPFToolBarView.addMode == ProcessDesigner.BPFToolBarAddMode.AddWorkflow || ProcessDesigner.BPFToolBarView.addMode == ProcessDesigner.BPFToolBarAddMode.PasteWorkflow) {
                    $('#triggeredProcessList').children().remove(".place-holder-listitem");
                }
                ProcessDesigner.BPFToolBarView.addMode = ProcessDesigner.BPFToolBarAddMode.None;
                ControlManager.ClearSelections();
                if (GenericWorkflowDesigner.CutCommand.cutInProgress) {
                    $(".cutTile").removeClass("cutTile");
                    GenericWorkflowDesigner.CutCommand.cutInProgress = false;
                    GenericWorkflowDesigner.Settings.workflowTree.setCopiedActivities([]);
                }
                ProcessDesigner.ConnectorActivityListView.targetID = null;
                ProcessDesigner.ConnectorActivityListView.removeConnectorButton();
                if ($('#canvas').find('.connectorSecondPoint').length > 0) {
                    $('#canvas').find('.connectorSecondPoint').removeClass("connectorSecondPoint");
                    $('#canvas').find('.notificationMessage').remove();
                    $('#canvas').find('.connectFirstPointNotificationMessage').removeClass("connectFirstPointNotificationMessage");
                    $('#canvas').find('.connectSecondPointNotificationMessage').removeClass("connectSecondPointNotificationMessage");
                }
            };
            ControlManager.prototype.deleteDone = function (deletedAtivities) {
                for (var i = 0; i < deletedAtivities.length; i++) {
                    var currentActivity = deletedAtivities[i];
                    var activityType = currentActivity.getActivityTypeID();
                    switch (activityType.toLowerCase()) {
                        case ProcessDesigner.BPFActivityType.stage:
                            ProcessDesigner.TelemetryEventReporter.ReportTileRemovedTelemetryEvent(currentActivity.stageId, ProcessDesigner.BPFActivityType.stage, "");
                            break;
                        case ProcessDesigner.BPFActivityType.step:
                            var parentStageActivity = currentActivity.getParent();
                            ProcessDesigner.TelemetryEventReporter.ReportTileRemovedTelemetryEvent(currentActivity.stepId, ProcessDesigner.BPFActivityType.step, parentStageActivity.stageId);
                            break;
                        case ProcessDesigner.BPFActivityType.action:
                            var parentStageActivity = currentActivity.getParent();
                            ProcessDesigner.TelemetryEventReporter.ReportTileRemovedTelemetryEvent(currentActivity.stepId, ProcessDesigner.BPFActivityType.action, parentStageActivity.stageId);
                            break;
                        case ProcessDesigner.BPFActivityType.flow:
                            var parentStageActivity = currentActivity.getParent();
                            ProcessDesigner.TelemetryEventReporter.ReportTileRemovedTelemetryEvent(currentActivity.stepId, ProcessDesigner.BPFActivityType.flow, parentStageActivity.stageId);
                            break;
                        case ProcessDesigner.BPFActivityType.condition:
                            ProcessDesigner.TelemetryEventReporter.ReportTileRemovedTelemetryEvent("", ProcessDesigner.BPFActivityType.condition, "");
                            break;
                        case ProcessDesigner.BPFActivityType.workflow:
                            ProcessDesigner.TelemetryEventReporter.ReportTileRemovedTelemetryEvent("", ProcessDesigner.BPFActivityType.workflow, "");
                            break;
                        case ProcessDesigner.BPFActivityType.globalWorkflow:
                            ProcessDesigner.TelemetryEventReporter.ReportTileRemovedTelemetryEvent("", ProcessDesigner.BPFActivityType.globalWorkflow, "");
                            break;
                    }
                }
            };
            ControlManager.disableButton = function (button) {
                $('#' + button.toLowerCase()).prop('disabled', true);
                $('#' + button.toLowerCase()).attr("aria-disabled", true);
                $('#toolBarItemTitle' + button).removeClass("utilityBarItem-normal-mode");
                $('#toolBarItemTitle' + button).addClass("utilityBarItem-disabled-mode");
            };
            ControlManager.enableButton = function (button) {
                $('#' + button.toLowerCase()).prop('disabled', false);
                $('#' + button.toLowerCase()).attr("aria-disabled", false);
                $('#toolBarItemTitle' + button).removeClass("utilityBarItem-disabled-mode");
                $('#toolBarItemTitleDelete' + button).addClass("utilityBarItem-normal-mode");
            };
            ControlManager.prototype.refreshToolbarItems = function () {
                var selectedActivities = GenericWorkflowDesigner.Settings.workflowTree.getSelectedActivities();
                ProcessDesigner.ConnectorActivityListView.removeConnectorButton();
                if (CommonTypes.Types.Object.isNullOrUndefined(selectedActivities) || selectedActivities.length <= 0) {
                    ControlManager.disableButton("Cut");
                    ControlManager.disableButton("Copy");
                    ControlManager.disableButton("Delete");
                }
                else {
                    var firstPoint = selectedActivities[0];
                    ProcessDesigner.ConnectorActivityListSubView.prototype.fillAllGlobalValues(firstPoint);
                    if (ProcessDesigner.ConnectorActivityListView.shouldEnableConnectorMenu(firstPoint)) {
                        ControlManager.enableButton("Connector");
                    }
                    ControlManager.enableButton("Copy");
                    if (selectedActivities[0] == GenericWorkflowDesigner.Settings.workflowTree.getWorkflowDefinitionRoot()) {
                        ControlManager.disableButton("Cut");
                        ControlManager.disableButton("Delete");
                    }
                    else {
                        ControlManager.enableButton("Cut");
                        ControlManager.enableButton("Delete");
                    }
                    if (selectedActivities[0].getActivityTypeID() == ProcessDesigner.BPFActivityType.condition
                        || (!CommonTypes.Types.Object.isNullOrUndefined(selectedActivities[0].getParent()) && selectedActivities[0].getParent().getActivityTypeID() == ProcessDesigner.BPFActivityType.condition && selectedActivities[0].getParentBranchID() == 0 && selectedActivities[0].isLeaf())) {
                        ControlManager.disableButton("Cut");
                    }
                    if ((selectedActivities[0].getActivityTypeID() == ProcessDesigner.BPFActivityType.step || selectedActivities[0].getActivityTypeID() == ProcessDesigner.BPFActivityType.action || selectedActivities[0].getActivityTypeID() == ProcessDesigner.BPFActivityType.flow)
                        && (selectedActivities[0].getParent()).steps.length == 1) {
                        ControlManager.disableButton("Cut");
                        ControlManager.disableButton("Delete");
                    }
                    if (selectedActivities[0].getActivityTypeID() == ProcessDesigner.BPFActivityType.stage && selectedActivities[0].getParentBranchID() == ProcessDesigner.branchType.Else && (!CommonTypes.Types.Object.isNullOrUndefined(selectedActivities[0].getChildActivitiesSorted()[0])) && selectedActivities[0].getChildActivitiesSorted()[0].getActivityTypeID() == ProcessDesigner.BPFActivityType.condition) {
                        ControlManager.disableButton("Cut");
                        ControlManager.disableButton("Delete");
                    }
                    if (selectedActivities[0].getActivityTypeID() == ProcessDesigner.BPFActivityType.workflow && (selectedActivities[0].isGlobalWorkflow())) {
                        ControlManager.disableButton("Cut");
                        ControlManager.disableButton("Copy");
                        ControlManager.disableButton("Paste");
                    }
                    $("#globalButtonArea").find(".ui-droppable").removeClass("hoverOverDroppable");
                    $('#globalWorkflowList').children().remove("#global-workflow-placeholder");
                }
                if (CommonTypes.Types.Object.isNullOrUndefined(GenericWorkflowDesigner.Settings.workflowTree.getCopiedActivities()) || GenericWorkflowDesigner.Settings.workflowTree.getCopiedActivities().length <= 0) {
                    ControlManager.disableButton("Paste");
                }
                else {
                    ControlManager.enableButton("Paste");
                }
            };
            ControlManager.prototype.propertyChangePreHandler = function (editItems) {
                var isStagEntityChanged;
                isStagEntityChanged = false;
                if (GenericWorkflowDesigner.currentModel instanceof ProcessDesigner.BPFStageActivity) {
                    var currentStageActivity = (GenericWorkflowDesigner.currentModel);
                    if ((!CommonTypes.Types.Object.isNullOrUndefined(editItems.entityName) && currentStageActivity.entityName != editItems.entityName) && !currentStageActivity.isNewStage()) {
                        ControlManager.stageEntityChanged(editItems, currentStageActivity);
                        currentStageActivity.relationShipAttributeName = "";
                        currentStageActivity.relationshipName = "";
                        isStagEntityChanged = true;
                    }
                }
                if (!isStagEntityChanged)
                    ControlManager.updateProperty(editItems);
            };
            ControlManager.reorderStep = function (model, currentPosition, newPosition) {
                var activity = model;
                if ((currentPosition != newPosition) && (currentPosition > 0) && (newPosition > 0) && (currentPosition <= activity.steps.length) && (newPosition <= activity.steps.length)) {
                    var step = activity.steps.splice(currentPosition - 1, 1);
                    activity.steps.splice(newPosition - 1, 0, step[0]);
                }
                activity.trigger("changeModel");
                this.ShowSeeDetails();
            };
            ControlManager.updateProperty = function (data) {
                var currentModel = GenericWorkflowDesigner.currentModel;
                Object.keys(data).forEach(function (key) {
                    if (key == "_sequence" && GenericWorkflowDesigner.currentModel[key] != data[key]) {
                        var model = ControlManager.GetStageModel(GenericWorkflowDesigner.currentModel);
                        if (model != null)
                            ControlManager.reorderStep(model, GenericWorkflowDesigner.currentModel[key], data[key]);
                        GenericWorkflowDesigner.currentModel = currentModel;
                    }
                    else {
                        GenericWorkflowDesigner.currentModel[key] = data[key];
                    }
                });
                GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.editDone);
                if (!(GenericWorkflowDesigner.currentModel instanceof ProcessDesigner.BPFConditionActivity)) {
                    GenericWorkflowDesigner.currentModel.trigger("changeModel");
                }
                else {
                    GenericWorkflowDesigner.currentModel.trigger("changeConditionModel");
                }
            };
            ControlManager.stageEntityChanged = function (editItems, currentStageActivity) {
                var dialogDetails = {
                    dialogTitle: ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_ChangeStageEntity_Title"),
                    text: ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_ChangeStageEntity_Text"),
                    messageType: ProcessDesigner.BPFDialogMessageTypes.Warning,
                    width: 400,
                    height: 600,
                    yesCallbackAction: function () {
                        currentStageActivity.clearStepsAndWorkflows();
                        ControlManager.updateProperty(editItems);
                        GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.editDone);
                        GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.canvasRefresh);
                    },
                    noCallbackAction: null,
                };
                GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.showDialog, dialogDetails);
            };
            ControlManager.prototype.render = function (inputBag) {
                var stopwatch = new GenericWorkflowDesigner.Stopwatch();
                stopwatch.start();
                GenericWorkflowDesigner.Settings.slotHandlerFactory = new ProcessDesigner.BPFSlotTileHolderHandlerFactory();
                GenericWorkflowDesigner.Settings.activityDefinitionFactory = new ProcessDesigner.BPFActivityDefinitionFactory();
                GenericWorkflowDesigner.Settings.propertyViewFactory = new ProcessDesigner.BPFPropertyViewFactory();
                GenericWorkflowDesigner.Settings.tileInformationFactory = new ProcessDesigner.BPFTileInformationFactory();
                GenericWorkflowDesigner.Settings.iconFactory = new ProcessDesigner.BPFIconFactory();
                GenericWorkflowDesigner.Settings.flyoutContentProvider = new GenericWorkflowDesigner.FlyoutContentProvider();
                GenericWorkflowDesigner.Settings.spinnerItem = "/_imgs/btn_lookup_resolving.gif";
                GenericWorkflowDesigner.Settings.activityDropHandlerFactory = new ProcessDesigner.BPFActivityDropHandlerFactory();
                GenericWorkflowDesigner.Settings.graphics = new ProcessDesigner.BPFGraphics();
                GenericWorkflowDesigner.Settings.workflowTree = new ProcessDesigner.BPFWorkflowTree();
                GenericWorkflowDesigner.Settings.workflowTree.setActivityCollection(new ProcessDesigner.BPFActivityDefinitionCollection());
                GenericWorkflowDesigner.Settings.slotInsertHorizontalHandlerFactory = new GenericWorkflowDesigner.SlotInsertHorizontalHandlerFactory();
                GenericWorkflowDesigner.Settings.slotInsertVerticalHandlerFactory = new GenericWorkflowDesigner.SlotInsertVerticalHandlerFactory();
                GenericWorkflowDesigner.Settings.isFeatureEnabled = ProcessDesigner.ProcessDesignerControl.dataBag.internal.isFeatureEnabled;
                GenericWorkflowDesigner.Settings.isBPFApprovalFlowsEnabled = ProcessDesigner.ProcessDesignerControl.dataBag.internal.isBPFApprovalFlowsEnabled;
                GenericWorkflowDesigner.Settings.isBPFApprovalFlowsAsRequiredStepEnabled = ProcessDesigner.ProcessDesignerControl.dataBag.internal.isBPFApprovalFlowsAsRequiredStepEnabled;
                if (window.LOCID_UI_DIR == "RTL") {
                    GenericWorkflowDesigner.Settings.renderRTL = true;
                    if (window.LOCID_LCID == "1025")
                        GenericWorkflowDesigner.Settings.isArabic = true;
                }
                else
                    GenericWorkflowDesigner.Settings.renderRTL = false;
                GenericWorkflowDesigner.designerType = GenericWorkflowDesigner.DesignerType.BpfDesigner;
                GenericWorkflowDesigner.Settings.subsequentActivityGenerator = new ProcessDesigner.BPFSubsequentActivityGenerator();
                GenericWorkflowDesigner.Settings.slotGeneratorProvider = new ProcessDesigner.BPFSlotGeneratorProvider();
                GenericWorkflowDesigner.Settings.notification = new GenericWorkflowDesigner.Notification("#notificationArea");
                GenericWorkflowDesigner.Settings.canvasDragDropValidator = new ProcessDesigner.BPFDragDropValidator();
                this.addCanvasElementToHtml();
                this.SetTabIndices();
                if (ControlManager.validateProcessData(inputBag.ProcessData)) {
                    ControlManager.processJson = inputBag.ProcessData;
                    this.updateProcessActivityTree(ControlManager.processJson.raw);
                }
                GenericWorkflowDesigner.Settings.slotHandlerProvider = new ProcessDesigner.BPFSlotHandlerProvider();
                this.initializeToolBar();
                this.initializeGlobalButtons();
                GenericWorkflowDesigner.MiniMapView.hideMiniMapWhenCloseMiniMapButtonInvisible();
                this.initializeToolTipMenubar();
                if (ControlManager.hasActionStep || ControlManager.hasFlowStep) {
                    ProcessDesigner.Validation.Engine.setAction(ProcessDesigner.Validation.Level.Validate);
                    GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.runValidation);
                }
                stopwatch.stop();
                localStorage.setItem("ProcessDesignerControl_BPF_LoadTime", stopwatch.elapsedMilliseconds.toString());
            };
            ControlManager.prototype.updateTileTitle = function () {
                var slotsList = $('#canvas').children("div .slot");
                var isFirst = true;
                $.each(slotsList, function (slotIndex, slot) {
                    var bpfTile = $("#" + slot.getAttribute("id")).children("div .tile").first().children("div").first();
                    if (bpfTile.find("[class~='stageTile']").length > 0) {
                        var stageTileId = $("#" + slot.getAttribute("id")).children("div .tile").children("div .stageTile").attr("id");
                        var tileTitle = $("#" + stageTileId).find("span.tileTitle").attr("title");
                        $("#" + slot.getAttribute("id")).attr("title", tileTitle);
                        var stepCount = $("#" + stageTileId).find("#tileCount_" + stageTileId).html();
                        var workflowCount = $("#" + stageTileId).find("#workflowCount_" + stageTileId).html();
                        var errorMessage = $("#" + stageTileId).find(".tileError").attr("title");
                        var titleForScreenReader = tileTitle + "\n" + ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_WorkFlow_StepCount") + " " + stepCount + "\n" + ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_WorkFlow_WorkflowCount") + " " + workflowCount + "\n" + ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_TileButtonSeeDetailsTooltip");
                        if (errorMessage != null)
                            titleForScreenReader = titleForScreenReader + "\n" + errorMessage;
                        $("#" + stageTileId).find(".tileButtonDiv").attr("title", titleForScreenReader);
                        $("#" + stageTileId).find(".stageTile").attr("title", titleForScreenReader);
                        if (!isFirst) {
                            $("#" + slot.getAttribute("id")).children("div .tile").children("div .stageTile").attr("tabindex", "-1");
                        }
                        ControlManager.StageTileTitle = true;
                    }
                    if (bpfTile.find("[class~='conditionTile']").length > 0) {
                        var tileTitle1 = bpfTile.find(".tileTableCell").children("div").children().html();
                        var tileTitle2 = bpfTile.find(".tileTableCell").children("span").children("input").val();
                        var errorMessage = bpfTile.find(".tileError").attr("title");
                        var completeTileTitle = tileTitle1 + " " + tileTitle2;
                        if (errorMessage != null)
                            completeTileTitle = completeTileTitle + "\n" + errorMessage;
                        $("#" + slot.getAttribute("id")).attr("title", completeTileTitle);
                        $("#" + slot.getAttribute("id")).children("div .tile").children("div .conditionTile").attr("title", completeTileTitle);
                        $("#" + slot.getAttribute("id")).children("div .tile").children("div .conditionTile").attr("tabindex", "-1");
                    }
                    isFirst = false;
                });
            };
            ControlManager.prototype.showDialog = function (data) {
                var wInstance = ProcessDesigner.WindowUtility.GetParentWindow();
                if (data.yesCallbackAction || data.noCallbackAction) {
                    var dialogStrings = new wInstance["Xrm"].ConfirmDialogStrings();
                    dialogStrings.title = data.dialogTitle;
                    dialogStrings.subtitle = data.dialogMessage;
                    if (!CommonTypes.Types.Object.isNullOrUndefined(data.text)) {
                        dialogStrings.text = data.text;
                    }
                    if (!CommonTypes.Types.Object.isNullOrUndefined(data.confirmButtonLabel)) {
                        dialogStrings.confirmButtonLabel = data.confirmButtonLabel;
                    }
                    else {
                        dialogStrings.confirmButtonLabel = window.LOCID_DLG_OK_BTN_LABEL.toUpperCase();
                    }
                    if (!CommonTypes.Types.Object.isNullOrUndefined(data.cancelButtonLabel)) {
                        dialogStrings.cancelButtonLabel = data.cancelButtonLabel;
                    }
                    var options = new wInstance["Xrm"].DialogOptions();
                    options.height = 200;
                    options.width = 550;
                    if (!CommonTypes.Types.Object.isNullOrUndefined(data.width)) {
                        options.width = data.width;
                    }
                    if (!CommonTypes.Types.Object.isNullOrUndefined(data.height)) {
                        options.width = data.height;
                    }
                    wInstance["Xrm"].Dialog.openConfirmDialog(dialogStrings, options, data.yesCallbackAction, data.noCallbackAction);
                }
                else {
                    var dialogStrings = new wInstance["Xrm"].AlertDialogStrings();
                    dialogStrings.title = data.dialogTitle;
                    dialogStrings.text = data.dialogMessage;
                    var options = new wInstance["Xrm"].DialogOptions();
                    options.height = 200;
                    options.width = 550;
                    if (!CommonTypes.Types.Object.isNullOrUndefined(data.width)) {
                        options.width = data.width;
                    }
                    if (!CommonTypes.Types.Object.isNullOrUndefined(data.height)) {
                        options.width = data.height;
                    }
                    wInstance["Xrm"].Dialog.openAlertDialog(dialogStrings, options);
                }
            };
            ControlManager.ShowSeeDetails = function () {
                if (CommonTypes.Types.Object.isNullOrUndefined(GenericWorkflowDesigner.currentModel)) {
                    return;
                }
                var currentStage = ControlManager.GetStageModel(GenericWorkflowDesigner.currentModel);
                if (CommonTypes.Types.Object.isNullOrUndefined(currentStage)) {
                    return;
                }
                if (ProcessDesigner.BPFToolBarView.addMode == ProcessDesigner.BPFToolBarAddMode.AddStep || ProcessDesigner.BPFToolBarView.addMode == ProcessDesigner.BPFToolBarAddMode.AddActionStep || ProcessDesigner.BPFToolBarView.addMode == ProcessDesigner.BPFToolBarAddMode.AddWorkflow)
                    ProcessDesigner.BPFToolBarView.addMode = ProcessDesigner.BPFToolBarAddMode.None;
                var currentTileButtonName = ProcessDesigner.ElementPrefixes.TileButtonPrefix + currentStage.getActivityID();
                $(currentTileButtonName).click();
            };
            ControlManager.prototype.ShowHideSeeDetails = function () {
                var stageDetailsContainer = $("#canvas").find(".stage-detail-container");
                if (stageDetailsContainer.length > 0) {
                    var openSeeDetailsViewId = stageDetailsContainer.attr("id");
                    var stageId = openSeeDetailsViewId.replace(ProcessDesigner.ElementPrefixes.DetailsPrefix, '');
                    var currentElementClicked = event.currentTarget;
                    if (currentElementClicked != null) {
                        var currentElementClickedId = $(currentElementClicked).attr("id");
                        if (currentElementClickedId != null && stageId !== currentElementClickedId) {
                            stageDetailsContainer.remove();
                            var openTileImageName = openSeeDetailsViewId.replace(ProcessDesigner.ElementPrefixes.DetailsPrefix, ProcessDesigner.ElementPrefixes.TileButtonImagePrefix);
                            if ($(openTileImageName).hasClass("Expanded-symbol")) {
                                $(openTileImageName).removeClass("Expanded-symbol");
                                $(openTileImageName).addClass("Collapsed-symbol");
                            }
                            else {
                                $(openTileImageName).removeClass("Collapsed-symbol");
                                $(openTileImageName).addClass("Expanded-symbol");
                            }
                        }
                    }
                }
            };
            ControlManager.CloseSeeDetails = function () {
                var stageDetailsContainer = $("#canvas").find(".stage-detail-container");
                stageDetailsContainer.remove();
            };
            ControlManager.updateSlotCount = function (slot) {
                var stageTileId = slot.$el.children("div .tile").children("div .stageTile").attr("id");
                $("#" + stageTileId).find("#tileCount_" + stageTileId).html(slot.model.getActivity().steps.length);
                $("#" + stageTileId).find("#workflowCount_" + stageTileId).html(slot.model.getActivity().workflows.length);
            };
            ControlManager.GetStageModel = function (currentModel) {
                if (currentModel.getActivityTypeID() == ProcessDesigner.BPFActivityType.step || currentModel.getActivityTypeID() == ProcessDesigner.BPFActivityType.action
                    || currentModel.getActivityTypeID() == ProcessDesigner.BPFActivityType.flow || currentModel.getActivityTypeID() == ProcessDesigner.BPFActivityType.workflow) {
                    return currentModel.parentStage;
                }
                else if (currentModel.getActivityTypeID() == ProcessDesigner.BPFActivityType.stage) {
                    return currentModel;
                }
            };
            ControlManager.prototype.addCanvasElementToHtml = function () {
                var canvasHtml = '<div id="notificationArea" class="notificationArea" aria-live="assertive"></div>'
                    + '<div class="pageSectionsToolbar" id= "Panel1" role="application"></div>'
                    + '<div  id="workspaceWrapperID" class="workspaceWrapper" role="application">'
                    + '<div id="canvasWrapper" >'
                    + '<div id= "zoomIconHolder" ></div>'
                    + '<div id= "canvas" style="height:auto; width:auto;"></div>'
                    + '</div>'
                    + '<div id="globalButtonArea" ></div>'
                    + '<div id= "loader" ></div>'
                    + '</div>'
                    + '<div id="toolpane" >'
                    + '<ul>'
                    + '<li><a id="libraryTab" href= "#library" > <span title="' + ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_LibraryTab_Label") + '" class="ellipsis workspaceLeftPaneOptionLabelWidth" id= "lblLibrary"  tabindex=' + GenericWorkflowDesigner.Settings.tabIndexValue + '> ' + ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_LibraryTab_Label") + ' </span> </a > </li>'
                    + '<li><a id="propertyTab" href= "#property" > <span title="' + ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_PropertyTab_Label") + '" class=" ellipsis workspaceLeftPaneOptionLabelWidth" id= "lblProperty" tabindex=' + GenericWorkflowDesigner.Settings.tabIndexValue + ' > ' + ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_PropertyTab_Label") + ' </span> </a > </li>'
                    + '</ul>'
                    + '<div id="library" > </div>'
                    + '<div id="property" > </div>'
                    + '</div>';
                var parentContainer = window["parentContainer"];
                if (CommonTypes.Types.Object.isNullOrUndefined(parentContainer)) {
                    parentContainer = $('.custom_control_section');
                }
                else {
                    parentContainer = $('#' + parentContainer);
                }
                var processEditor = parentContainer;
                processEditor.append(canvasHtml);
                $("#libraryTab").on("click", function (event) {
                    GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.clearSelections);
                    event.stopPropagation();
                });
                if (GenericWorkflowDesigner.Settings.renderRTL) {
                    $("html").addClass("rtl");
                }
                if (GenericWorkflowDesigner.Settings.isArabic) {
                    $("html").addClass("arabic");
                }
                $('#canvasWrapper').on("click", function (event) {
                    var target = event.target || event.srcElement;
                    if (target.id.indexOf('mini-map') < 0 && target.id.indexOf('hitarea') < 0) {
                        $("#canvas").children(".hoverOverDroppable").removeAttr("aria-label").removeClass("hoverOverDroppable").attr("aria-hidden", "true");
                        $("#canvas").children(".cutTile").removeClass("cutTile");
                        $('#sortable').children().remove(".place-holder-listitem");
                        $("#Add.toolbarItem").trigger("mouseleave");
                        GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.clearSelections);
                        GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.resetToolbar);
                        GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.refreshToolbarItems);
                        event.stopPropagation();
                    }
                });
            };
            ControlManager.prototype.initializeToolBar = function () {
                var toolbar = new ProcessDesigner.BPFToolBarView();
                $('.pageSectionsToolbar').append(toolbar.render());
                GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.refreshToolbarItems);
            };
            ControlManager.prototype.initializeToolTipMenubar = function () {
                var validationOff = ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_ValidateMode_Off");
                var processSaveAs = ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("GenericWorkflowDesignerControl_MenuItem_Label_Saveas_Tooltip");
                var updateTooltip = ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("GenericWorkflowDesignerControl_MenuItem_Label_Update_Tooltip");
                var showDependencies = ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("GenericWorkflowDesignerControl_MenuItem_Label_ShowDependencies_Tooltip");
                var actionTooltip = ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("GenericWorkflowDesignerControl_MenuItem_Label_Action_Tooltip");
                $("#_MBValidateOn").attr("title", validationOff);
                $("#_MBSaveAs").attr("title", processSaveAs);
                $("#_MBUpdate").attr("title", updateTooltip);
                $("#_MBDependencies").attr("title", showDependencies);
                $("#mnuaction").attr("title", actionTooltip);
            };
            ControlManager.prototype.initializeGlobalButtons = function () {
                var globalButtons = new GenericWorkflowDesigner.GlobalButtonModel();
                var slotModel = new GenericWorkflowDesigner.SlotModel(ControlManager.globalWorkflowObject);
                var globalWorkflowView = new ProcessDesigner.GlobalWorkflowView({ model: slotModel });
                globalWorkflowView.render();
            };
            ControlManager.prototype.SetTabIndices = function () {
                $("#canvas").attr('tabindex', -1);
                $(".columnOverflow.majorComponent").attr('tabindex', -1);
                $(".section_control.custom_control_column").attr('tabindex', -1);
            };
            ControlManager.prototype.updateProcessActivityTree = function (record) {
                if (CommonTypes.Types.String.isNullOrEmpty(record)) {
                    throw (ControlManager.EmptyOrNullInputProcessData);
                }
                else {
                    try {
                        GenericWorkflowDesigner.EventManager.subscribeWithReturnValue(GenericWorkflowDesigner.FrameworkEvents.getActivityDefinitions, ControlManager.InitializeAndGetActivityTreeFromJson);
                        GenericWorkflowDesigner.EventManager.subscribe(GenericWorkflowDesigner.FrameworkEvents.showDialog, this.showDialog, null);
                        GenericWorkflowDesigner.EventManager.subscribe(GenericWorkflowDesigner.FrameworkEvents.propertyMessageReceived, ControlManager.ShowSeeDetails, null);
                        GenericWorkflowDesigner.EventManager.subscribe(GenericWorkflowDesigner.FrameworkEvents.slotTileHolderClick, this.ShowHideSeeDetails, null);
                        GenericWorkflowDesigner.EventManager.subscribe(GenericWorkflowDesigner.FrameworkEvents.showHideSeeDetails, this.ShowHideSeeDetails, null);
                        var appModelObject = new GenericWorkflowDesigner.appModel();
                        appModelObject.workflowAssociatedEntityOID = "fdsf";
                        appModelObject.language = "1";
                        appModelObject.supportMode = "1";
                        appModelObject.applicationRoot = "http://loccalhost";
                        appModelObject.helpPageLink = "help.html";
                        appModelObject.loaderId = "#loader";
                        appModelObject.canvasId = "#canvas";
                        appModelObject.toolpaneId = "#toolpane";
                        appModelObject.workspaceWrapperId = ".workspaceWrapper";
                        appModelObject.librabryId = "#library";
                        appModelObject.propertyId = "#property";
                        appModelObject.goalId = "#goal";
                        appModelObject.zoomIconHolderId = "#zoomIconHolder";
                        appModelObject.workflowSwitchId = "#workflowSwitch";
                        appModelObject.validateId = "#validate";
                        appModelObject.lblLibraryId = "#lblLibrary";
                        appModelObject.loadingImageId = "#loadingImage";
                        appModelObject.workflowProviderType = 2;
                        appModelObject.workflowID = null;
                        appModelObject.libraryTilesDataFileName = "/_static/_common/scripts/processcontrol/LibraryTilesData.xml";
                        var canvasContainer = $(appModelObject.canvasId);
                        var canvasOffset = canvasContainer.offset();
                        GenericWorkflowDesigner.Settings.layoutProperties = new ProcessDesigner.BPFLayoutProperties(canvasOffset);
                        ProcessDesigner.BPFConditionActivity.overrideWorkflowObjectModelMethods();
                        this.gwfdesigner.Initialize(appModelObject);
                        ControlManager.SetCanvasFocusEvent();
                        this.overrideGenericWorkflowEvents();
                    }
                    catch (err) {
                        throw (ControlManager.InvalidInputProcessData);
                    }
                }
            };
            ControlManager.prototype.overrideGenericWorkflowEvents = function () {
                GenericWorkflowDesigner.EventManager.unsubscribeWithoutCallback(GenericWorkflowDesigner.FrameworkEvents.updateProperty);
                GenericWorkflowDesigner.EventManager.subscribe(GenericWorkflowDesigner.FrameworkEvents.updateProperty, this.propertyChangePreHandler, null);
            };
            ControlManager.validateProcessData = function (processdata) {
                if (CommonTypes.Types.Object.isNullOrUndefined(processdata)) {
                    throw (ControlManager.EmptyOrNullInputProcessData);
                }
                else if (CommonTypes.Types.Object.isNullOrUndefined(processdata.raw) || CommonTypes.Types.String.isNullOrEmpty(processdata.raw)) {
                    throw (ControlManager.EmptyOrNullRawPropertyOfInputProcessData);
                }
                return true;
            };
            ControlManager.prototype.validateDependentOptionSetData = function () {
                var stopwatch = new GenericWorkflowDesigner.Stopwatch();
                stopwatch.start();
                ProcessDesigner.ValidateBPF.validateDependentOptionSet();
                stopwatch.stop();
                localStorage.setItem("ProcessDesignerControl_BPF_ValidateDependentOptionSet", stopwatch.elapsedMilliseconds.toString());
            };
            ControlManager.InitializeAndGetActivityTreeFromJson = function () {
                var workflowStep = new Microsoft.Crm.Workflow.ObjectModel.WorkflowStep("account", 0);
                var activities = null;
                if (ControlManager.validateProcessData(ControlManager.processJson)) {
                    workflowStep.initializeFromDynamic($.parseJSON(ControlManager.processJson.raw));
                    ControlManager.processTitle = workflowStep.get_title();
                    ControlManager.processDescription = workflowStep.get_Description();
                    var converter = new ProcessDesigner.BpfToActivityCollectionVisitor();
                    activities = converter.convert(workflowStep);
                }
                return activities;
            };
            ControlManager.SetShortcutKeysToMoveOnMajorAreas = function (event) {
                if (event.keyCode == 77 && event.altKey) {
                    ControlManager.ClearSelections();
                    ControlManager.SetFocusToMiniMapButtons();
                }
                else if (event.keyCode == 17) {
                    ControlManager.keyMap[event.keyCode] = true;
                }
                else if (event.keyCode == 18) {
                    ControlManager.keyMap[event.keyCode] = true;
                }
                else if (event.keyCode == 78) {
                    if (event.srcElement != undefined && $(event.srcElement).attr("type") != "text" && $(event.srcElement).attr("role") != "combobox" && $(event.srcElement).prop("tagName") != "TEXTAREA") {
                        if (ControlManager.keyMap[17] && ControlManager.keyMap[18]) {
                            ControlManager.keyMap[17] = false;
                            ControlManager.keyMap[18] = false;
                            ControlManager.SetFunctionalityForButtonsWithShortcutKeys("#Add");
                        }
                    }
                }
                else if (event.altKey && event.keyCode == 83) {
                    ControlManager.SetFunctionalityForButtonsWithShortcutKeys("#snapshot");
                }
                else if (event.keyCode == 36 && event.shiftKey) {
                    ControlManager.ClearSelections();
                    var activities = GenericWorkflowDesigner.Settings.workflowTree.getActivities();
                    GenericWorkflowDesigner.currentModel = activities[0];
                    $("#canvas").children("div .slot").first().focus();
                }
                else if (event.shiftKey && event.keyCode == 45) {
                    ControlManager.SetFunctionalityForButtonsWithShortcutKeys("button#Add");
                }
                else if (event.altKey && event.keyCode == 189) {
                    ControlManager.SetFunctionalityForButtonsWithShortcutKeys("button#zoomOut");
                }
                else if (event.altKey && event.keyCode == 187) {
                    ControlManager.SetFunctionalityForButtonsWithShortcutKeys("button#zoomIn");
                }
                else if (event.altKey && event.keyCode == 220) {
                    ControlManager.SetFunctionalityForButtonsWithShortcutKeys("button#fitToScreen");
                }
                else if (event.altKey && event.keyCode == 71) {
                    ControlManager.ClearSelections();
                    $("#btnToggleButtons").focus();
                }
                else if (event.ctrlKey && event.altKey && event.keyCode == 67) {
                    ControlManager.ClearSelections();
                    $("#propertyTab").children().attr("aria-selected", false);
                    $("#libraryTab").children().attr("aria-selected", true);
                    $("#libraryTab").children().attr("role", "tab");
                    $("#libraryTab").children().focus();
                    $("#libraryTab").click();
                }
                else if (event.ctrlKey && event.altKey && event.keyCode == 80) {
                    ControlManager.ClearSelections();
                    $("#libraryTab").children().attr("aria-selected", false);
                    $("#propertyTab").children().attr("aria-selected", true);
                    $("#propertyTab").children().attr("role", "tab");
                    $("#propertyTab").children().focus();
                    GenericWorkflowDesigner.eventManager.trigger('activatePropertyTab');
                }
                else if (event.keyCode == 27) {
                    ControlManager.ClearSelections();
                }
                else if (event.ctrlKey && event.altKey && event.keyCode == 68) {
                    ControlManager.NavigateToSelectedElement();
                    event.stopPropagation();
                }
                event.stopPropagation();
            };
            ControlManager.SetFunctionalityForButtonsWithShortcutKeys = function (idName) {
                if (typeof event != 'undefined')
                    event.preventDefault();
                ControlManager.ClearSelections();
                $(idName).focus();
                $(idName).click();
            };
            ControlManager.SetCanvasFocusEvent = function () {
                if ($('#canvas').children("div .slot").first().length > 0) {
                    $("#canvas").children("div .slot").first().children("div .tile").children("div .stageTile").attr("tabindex", GenericWorkflowDesigner.Settings.tabIndexValue);
                    $("#canvas").children("div .slot").first().focusin(function (event) {
                        if (!($(".stageTile.selected").length > 0 || $(".conditionTile.selected").length > 0))
                            $("#canvas").children("div .slot").first().find(".stageTile").addClass("selected");
                    });
                    $("#canvas").children("div .slot").first().focusout(function (event) {
                        $("#canvas").children("div .slot").first().find(".stageTile").removeClass("selected");
                    });
                    $("#canvas").children("div .slot").first().keydown(function (event) {
                        if (event.keyCode == 9) {
                            ControlManager.RemoveSelectedClassFromDivs();
                            $("#canvas").children("div .slot").first().find(".stageTile").addClass("selected");
                        }
                    });
                    GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.updateTileTitle);
                }
                if ($("#libraryTab").parent().length > 0) {
                    $("#libraryTab").parent().attr("tabindex", "-1");
                }
                $(document).on("keydown", function (event) {
                    if (event.keyCode == 8 && event.target != null) {
                        var calendarControlDiv = $(event.target).parents("div.ms-crm-modalDialog.ms-crm-MiniCal-Border");
                        if (calendarControlDiv.length > 0) {
                            event.preventDefault();
                            calendarControlDiv.css("visibility", "hidden");
                            $("input.ms-crm-DateTime-Container-Input").focus();
                        }
                        event.stopPropagation();
                    }
                });
                var keyMap = { 83: false, 187: false, 87: false };
                $(".slot").on("keydown", function (event) {
                    if ((GenericWorkflowDesigner.Settings.renderRTL && event.keyCode == 39) || (!GenericWorkflowDesigner.Settings.renderRTL && event.keyCode == 37)) {
                        ControlManager.NavigateToLeftStage();
                    }
                    if ((GenericWorkflowDesigner.Settings.renderRTL && event.keyCode == 37) || (!GenericWorkflowDesigner.Settings.renderRTL && event.keyCode == 39)) {
                        ControlManager.NavigateToRightStage();
                    }
                    if (event.keyCode == 40 && event.shiftKey) {
                        var currentStage = ControlManager.GetStageModel(GenericWorkflowDesigner.currentModel);
                        var currentTileButtonName = ProcessDesigner.ElementPrefixes.TileButtonPrefix + currentStage.getActivityID();
                        var curretStageDetailsDivName = ProcessDesigner.ElementPrefixes.DetailsPrefix + currentStage.getActivityID();
                        if ($("#" + curretStageDetailsDivName) && $("#" + curretStageDetailsDivName).css("visibility") != "visible") {
                            $(currentTileButtonName).click();
                            if ($("#" + GenericWorkflowDesigner.currentModel.id).find(".list-container-div").first().find(".step-list-listitem").length > 0) {
                                $("#" + GenericWorkflowDesigner.currentModel.id).find(".step-list-listitem.selected").removeClass("selected");
                                $("#" + GenericWorkflowDesigner.currentModel.id).find(".list-container-div").first().find(".step-list-listitem").first().focus();
                                $("#" + GenericWorkflowDesigner.currentModel.id).find(".list-container-div").first().find(".step-list-listitem").first().addClass("selected");
                                $("#UpArrow").attr("aria-disabled", true);
                                $("#UpArrow").addClass("disableArrowButton");
                                if ($("#" + GenericWorkflowDesigner.currentModel.id).find(".list-container-div").first().find(".step-list-listitem").length > 1) {
                                    $("#DownArrow").attr("aria-disabled", false);
                                    $("#DownArrow").removeClass("disableArrowButton");
                                }
                                else {
                                    $("#DownArrow").attr("aria-disabled", true);
                                    $("#DownArrow").addClass("disableArrowButton");
                                }
                            }
                        }
                    }
                    else if (event.keyCode == 40) {
                        ControlManager.NavigateToDownStage();
                    }
                    if (event.keyCode == 38 && event.shiftKey) {
                        var currentStage = ControlManager.GetStageModel(GenericWorkflowDesigner.currentModel);
                        var currentTileButtonName = ProcessDesigner.ElementPrefixes.TileButtonPrefix + currentStage.getActivityID();
                        var curretStageDetailsDivName = ProcessDesigner.ElementPrefixes.DetailsPrefix + currentStage.getActivityID();
                        if ($("#" + curretStageDetailsDivName) && $("#" + curretStageDetailsDivName).css("visibility") == "visible") {
                            $(currentTileButtonName).click();
                        }
                    }
                    else if (event.keyCode == 38) {
                        ControlManager.NavigateToUpStage();
                    }
                    if (event.keyCode == 13) {
                        if ($(".selected.stageTile").length > 0) {
                            $(".selected.stageTile").parent().parent(".slot").click();
                        }
                        else if ($(".selected.conditionTile").length > 0) {
                            $(".selected.conditionTile").parent().parent(".slot").click();
                        }
                    }
                    if (event.keyCode == 27) {
                        ControlManager.ClearSelections();
                        event.stopPropagation();
                    }
                    if (event.keyCode == 77 && event.altKey) {
                        ControlManager.ClearSelections();
                        ControlManager.SetFocusToMiniMapButtons();
                        event.stopPropagation();
                    }
                    if (event.ctrlKey && event.keyCode == 88) {
                        if (!$("#cut").prop("disabled")) {
                            event.preventDefault();
                            ControlManager.ClearSelections();
                            $("#cut").click();
                        }
                    }
                    else if (event.ctrlKey && event.keyCode == 67) {
                        if (!$("#copy").prop("disabled")) {
                            event.preventDefault();
                            ControlManager.ClearSelections();
                            $("#copy").click();
                        }
                    }
                    else if (event.ctrlKey && event.keyCode == 86) {
                        if (!$("#paste").prop("disabled")) {
                            event.preventDefault();
                            ControlManager.ClearSelections();
                            $("#paste").click();
                        }
                    }
                    else if (event.keyCode == 46) {
                        if (!$("#delete").prop("disabled")) {
                            ControlManager.SetFunctionalityForButtonsWithShortcutKeys("#delete");
                        }
                    }
                    else if (event.keyCode == 83) {
                        if (event.keyCode in keyMap) {
                            keyMap[87] = false;
                            keyMap[event.keyCode] = true;
                        }
                    }
                    else if (event.keyCode == 87) {
                        if (event.keyCode in keyMap) {
                            keyMap[83] = false;
                            keyMap[event.keyCode] = true;
                        }
                    }
                    else if (keyMap[83] && event.keyCode == 187) {
                        $("#toggleStep").click();
                    }
                    else if (keyMap[87] && event.keyCode == 187) {
                        $("#toggleProcess").click();
                    }
                    else if (event.keyCode == 67) {
                        if (ControlManager.keyMap[18]) {
                            ControlManager.keyMap[18] = false;
                            if (!$("#connector").prop("disabled")) {
                                ControlManager.ClearSelections();
                                $("#connector").focus();
                                $('#toolBarItemTitleConnector').removeClass('utilityBarItem-disabled-mode');
                                $('#toolBarItemTitleConnector').addClass('utilityBarItem-normal-mode');
                            }
                        }
                    }
                    ControlManager.SetShortcutKeysToMoveOnMajorAreas(event);
                    event.stopPropagation();
                });
                $("#canvas").keydown(function (event) {
                    if (event.keyCode == 27) {
                        ControlManager.ClearSelections();
                    }
                    if (event.keyCode == 77 && event.altKey) {
                        ControlManager.ClearSelections();
                        ControlManager.SetFocusToMiniMapButtons();
                    }
                });
                $("#process_configurator_container").keydown(function (event) {
                    ControlManager.SetShortcutKeysToMoveOnMajorAreas(event);
                });
                $(".stageTile").focusin(function (event) {
                    var rootTileId = $("#canvas").children("div .slot").first().children("div .tile").children("div .stageTile").attr("id");
                    var currentTileId = event.target.getAttribute("id");
                    if (ControlManager.StageTileTitle == true && rootTileId == currentTileId) {
                        var message = ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_ScreenReader_ShiftDownArrowKey");
                        var message1 = ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_ScreenReader_ShiftUpArrowKey");
                        var expression = window['String'].format(ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_ScreenReader_DetailExpand"), message);
                        var expression1 = window['String'].format(ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_ScreenReader_DetailCollapse"), message1);
                        var tileTitle = $("#canvas").children("div .slot").first().children("div .tile").children("div .stageTile").children("div .tileButtonDiv").attr("title");
                        tileTitle = tileTitle + " \n" + ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_MoveBetweenComponent") + "\n" + expression + "\n" + expression1;
                        $("#canvas").children("div .slot").first().children("div .tile").children("div .stageTile").attr("title", tileTitle);
                        $("#canvas").children("div .slot").first().children("div .tile").children("div .stageTile").children("div .tileButtonDiv").attr("title", tileTitle);
                        ControlManager.StageTileTitle = false;
                    }
                    $(".conditionTile.selected").removeClass("selected");
                    $(".slot.selected").removeClass("selected");
                    var id = event.target.getAttribute("id");
                    if (!CommonTypes.Types.Object.isNullOrUndefined(id)) {
                        GenericWorkflowDesigner.EventManager.publishWithPayload(GenericWorkflowDesigner.FrameworkEvents.updateModel, GenericWorkflowDesigner.Settings.workflowTree.getActivityById(id));
                        GenericWorkflowDesigner.currentModel = GenericWorkflowDesigner.Settings.workflowTree.getActivityById(id);
                    }
                });
                $(".conditionTile").focusin(function (event) {
                    $(".stageTile.selected").removeClass("selected");
                    $(".slot.selected").removeClass("selected");
                    var id = event.target.getAttribute("id");
                    if (!CommonTypes.Types.Object.isNullOrUndefined(id)) {
                        GenericWorkflowDesigner.EventManager.publishWithPayload(GenericWorkflowDesigner.FrameworkEvents.updateModel, GenericWorkflowDesigner.Settings.workflowTree.getActivityById(id));
                        GenericWorkflowDesigner.currentModel = GenericWorkflowDesigner.Settings.workflowTree.getActivityById(id);
                    }
                });
                $("#show-mini-map").focusin(function (event) {
                    ControlManager.clearTileFocusEvent = true;
                    ControlManager.ClearSelections();
                });
                $("#close-mini-map").focusin(function (event) {
                    ControlManager.clearTileFocusEvent = true;
                    ControlManager.ClearSelections();
                });
                $("#property").on("keydown", function (event) {
                    if (event.ctrlKey && event.altKey && event.keyCode == 68) {
                        ControlManager.NavigateToSelectedElement();
                        event.stopPropagation();
                    }
                });
            };
            ControlManager.ClearSelections = function () {
                $('#sortable').children().remove(".place-holder-listitem");
                $("#Add.toolbarItem").trigger("mouseleave");
                $(".stageTile.selected").removeClass("selected");
                $(".conditionTile.selected").removeClass("selected");
                $(".stage-detail-container.selected").removeClass("selected");
                $('#canvas').find(".step-list-listitem.selected").removeClass("selected");
                if (!ControlManager.clearTileFocusEvent) {
                    $("#canvas").children(".hoverOverDroppable").removeAttr('aria-label').removeClass("hoverOverDroppable").attr("aria-hidden", "true");
                    $('#globalWorkflowList').children().remove("#global-workflow-placeholder");
                    $('#workflowList').children().remove(".place-holder-listitem");
                    $("#globalButtonArea").find(".ui-droppable").removeAttr('aria-label').removeClass("hoverOverDroppable");
                    $("#globalButtonArea #globalButtonAreaTable #btnToggleButtons").removeAttr('aria-label');
                    $('#triggeredProcessList').children().remove(".place-holder-listitem");
                }
                ControlManager.clearTileFocusEvent = false;
            };
            ControlManager.NavigateToSelectedElement = function () {
                var selectedActivityId;
                var selectedActivityType = GenericWorkflowDesigner.currentModel.getActivityTypeID();
                if (selectedActivityType != null) {
                    switch (selectedActivityType.toLowerCase()) {
                        case ProcessDesigner.BPFActivityType.stage.toLowerCase():
                            selectedActivityId = GenericWorkflowDesigner.currentModel.id;
                            ControlManager.ClearSelections();
                            $("#" + selectedActivityId).find(".stageTile").addClass("selected");
                            $("#" + selectedActivityId).find(".stageTile").focus();
                            if ($("#" + selectedActivityId).find(".stage-detail-container").length > 0) {
                                $("#" + selectedActivityId).find(".stage-detail-container").addClass("selected");
                            }
                            break;
                        case ProcessDesigner.BPFActivityType.condition.toLowerCase():
                            selectedActivityId = GenericWorkflowDesigner.currentModel.id;
                            ControlManager.ClearSelections();
                            $("#" + selectedActivityId).find(".conditionTile").addClass("selected");
                            $("#" + selectedActivityId).find(".conditionTile").focus();
                            break;
                        case ProcessDesigner.BPFActivityType.step.toLowerCase():
                            selectedActivityId = GenericWorkflowDesigner.currentModel.stepId;
                            ControlManager.ClearSelections();
                            $("#" + selectedActivityId).addClass("selected");
                            $("#" + selectedActivityId).focus();
                            $("#" + selectedActivityId).parents(".slot").find(".stageTile").addClass("selected");
                            $("#" + selectedActivityId).parents(".stage-detail-container").addClass("selected");
                            break;
                        case ProcessDesigner.BPFActivityType.action.toLowerCase():
                            selectedActivityId = GenericWorkflowDesigner.currentModel.stepId;
                            ControlManager.ClearSelections();
                            $("#" + selectedActivityId).addClass("selected");
                            $("#" + selectedActivityId).focus();
                            $("#" + selectedActivityId).parents(".slot").find(".stageTile").addClass("selected");
                            $("#" + selectedActivityId).parents(".stage-detail-container").addClass("selected");
                            break;
                        case ProcessDesigner.BPFActivityType.flow.toLowerCase():
                            selectedActivityId = GenericWorkflowDesigner.currentModel.stepId;
                            ControlManager.ClearSelections();
                            $("#" + selectedActivityId).addClass("selected");
                            $("#" + selectedActivityId).focus();
                            $("#" + selectedActivityId).parents(".slot").find(".stageTile").addClass("selected");
                            $("#" + selectedActivityId).parents(".stage-detail-container").addClass("selected");
                            break;
                        case ProcessDesigner.BPFActivityType.workflow.toLowerCase():
                            selectedActivityId = GenericWorkflowDesigner.currentModel.actionStepId;
                            ControlManager.ClearSelections();
                            $("#" + selectedActivityId).addClass("selected");
                            $("#" + selectedActivityId).focus();
                            if ($("#" + selectedActivityId).parents(".slot").find(".stageTile").length > 0) {
                                $("#" + selectedActivityId).parents(".slot").find(".stageTile").addClass("selected");
                                $("#" + selectedActivityId).parents(".stage-detail-container").addClass("selected");
                            }
                            break;
                    }
                }
            };
            ControlManager.SetFocusToMiniMapButtons = function () {
                var miniMapWrapperVisibility = $("#mini-map-wrapper").css("visibility");
                if (miniMapWrapperVisibility == "visible")
                    $("#close-mini-map").focus();
                else
                    $("#show-mini-map").focus();
            };
            ControlManager.RemoveSelectedClassFromDivs = function () {
                $(".selected.stageTile").removeClass("selected");
                $(".selected.conditionTile").removeClass("selected");
                $(".stage-detail-container.selected").removeClass("selected");
            };
            ControlManager.navigateToNewTile = function (newTileActivityId) {
                if ($('#' + newTileActivityId).children().find(".conditionTile").length > 0) {
                    ControlManager.RemoveSelectedClassFromDivs();
                    $('#' + newTileActivityId).children().find(".conditionTile").addClass("selected");
                    $(".selected.conditionTile").focus();
                    ControlManager.canvasScrollIntoView($(".selected.conditionTile").get(0));
                }
                else if ($('#' + newTileActivityId).children().find(".stageTile").length > 0) {
                    ControlManager.RemoveSelectedClassFromDivs();
                    $('#' + newTileActivityId).children().find(".stageTile").addClass("selected");
                    if ($('#' + newTileActivityId).children().find(".stage-detail-container").length > 0) {
                        $('#' + newTileActivityId).children().find(".stage-detail-container").addClass("selected");
                    }
                    $(".selected.stageTile").focus();
                    ControlManager.canvasScrollIntoView($(".selected.stageTile").get(0));
                }
            };
            ControlManager.navigateToDefaultActivityOfParentActivity = function (activity) {
                var defaultChildOfParentActivity = activity.parentConditionActivity.getDefaultChildOfParentActivity();
                if (defaultChildOfParentActivity != null) {
                    ControlManager.navigateToNewTile(defaultChildOfParentActivity.id);
                    GenericWorkflowDesigner.currentModel = defaultChildOfParentActivity;
                }
            };
            ControlManager.NavigateToLeftStage = function () {
                var activity;
                activity = GenericWorkflowDesigner.currentModel;
                var parentActivity = GenericWorkflowDesigner.Settings.workflowTree.getParent(activity);
                if (!CommonTypes.Types.Object.isNullOrUndefined(parentActivity)) {
                    if (parentActivity.getActivityTypeID() === ProcessDesigner.BPFActivityType.condition) {
                        var parentActivityDefaultBranch = parentActivity.getDefaultBranch();
                        if ((parentActivityDefaultBranch != null) && (parentActivityDefaultBranch.id === activity.id)) {
                            var yesBranchLastChild = parentActivity.getYesBranchLastChild();
                            if (yesBranchLastChild != null) {
                                parentActivity = yesBranchLastChild;
                            }
                        }
                    }
                    if ($("#" + parentActivity.id + "_hitarea").length > 0 && $("#" + parentActivity.id + "_hitarea").hasClass("hoverOverDroppable")) {
                        ControlManager.RemoveSelectedClassFromDivs();
                        $("#" + parentActivity.id + "_hitarea").focus();
                    }
                    else {
                        ControlManager.navigateToNewTile(parentActivity.id);
                    }
                    GenericWorkflowDesigner.currentModel = parentActivity;
                }
            };
            ControlManager.NavigateToRightStage = function () {
                var activity;
                activity = GenericWorkflowDesigner.currentModel;
                var defaultChildOfParentActivity = null;
                if (activity.getActivityTypeID() === ProcessDesigner.BPFActivityType.stage) {
                    var childActivities = GenericWorkflowDesigner.Settings.workflowTree.getChildActivities(activity);
                    if ($("#" + activity.id + "_hitarea").length > 0 && $("#" + activity.id + "_hitarea").hasClass("hoverOverDroppable")) {
                        ControlManager.RemoveSelectedClassFromDivs();
                        $("#" + activity.id + "_hitarea").focus();
                        if (childActivities.length > 0)
                            GenericWorkflowDesigner.currentModel = childActivities[0];
                        else if (activity.parentConditionActivity != null) {
                            var parentConditionDefaultBranch = activity.parentConditionActivity.getDefaultBranch();
                            if (parentConditionDefaultBranch != null) {
                                if (parentConditionDefaultBranch.id !== activity.id) {
                                    GenericWorkflowDesigner.currentModel = parentConditionDefaultBranch;
                                }
                            }
                        }
                    }
                    else {
                        if (childActivities.length > 0) {
                            var childActivity = childActivities[0];
                            ControlManager.navigateToNewTile(childActivity.id);
                            GenericWorkflowDesigner.currentModel = childActivity;
                        }
                        else {
                            if (activity.parentConditionActivity != null) {
                                var parentConditionDefaultBranch = activity.parentConditionActivity.getDefaultBranch();
                                if (parentConditionDefaultBranch != null) {
                                    if (parentConditionDefaultBranch.id !== activity.id) {
                                        ControlManager.navigateToNewTile(parentConditionDefaultBranch.id);
                                        GenericWorkflowDesigner.currentModel = parentConditionDefaultBranch;
                                    }
                                    else if (parentConditionDefaultBranch.id === activity.id) {
                                        ControlManager.navigateToDefaultActivityOfParentActivity(activity);
                                    }
                                }
                                else {
                                    ControlManager.navigateToDefaultActivityOfParentActivity(activity);
                                }
                            }
                        }
                    }
                    event.stopPropagation();
                }
                else if (activity.getActivityTypeID() === ProcessDesigner.BPFActivityType.condition) {
                    var yesBranchFirstChild = activity.getYesBranchFirstChild();
                    var defaultChildActivity = activity.getDefaultBranch();
                    if ($("#" + activity.id + "_hitarea").length > 0 && $("#" + activity.id + "_hitarea").hasClass("hoverOverDroppable")) {
                        ControlManager.RemoveSelectedClassFromDivs();
                        $("#" + activity.id + "_hitarea").focus();
                        if (yesBranchFirstChild != null) {
                            GenericWorkflowDesigner.currentModel = yesBranchFirstChild;
                        }
                        else if (defaultChildActivity != null) {
                            GenericWorkflowDesigner.currentModel = defaultChildActivity;
                        }
                    }
                    else {
                        if (yesBranchFirstChild != null) {
                            ControlManager.navigateToNewTile(yesBranchFirstChild.id);
                            GenericWorkflowDesigner.currentModel = yesBranchFirstChild;
                        }
                        else if (defaultChildActivity != null) {
                            ControlManager.navigateToNewTile(defaultChildActivity.id);
                            GenericWorkflowDesigner.currentModel = defaultChildActivity;
                        }
                        else if (defaultChildActivity == null) {
                            defaultChildOfParentActivity = activity.getDefaultChildOfParentActivity();
                            if (defaultChildOfParentActivity != null) {
                                ControlManager.navigateToNewTile(defaultChildOfParentActivity.id);
                                GenericWorkflowDesigner.currentModel = defaultChildOfParentActivity;
                            }
                            else {
                                ControlManager.RemoveSelectedClassFromDivs();
                                return;
                            }
                        }
                    }
                }
            };
            ControlManager.NavigateToUpStage = function () {
                var activity;
                activity = GenericWorkflowDesigner.currentModel;
                var parentActivity = GenericWorkflowDesigner.Settings.workflowTree.getParent(activity);
                if ($("#" + parentActivity.id + "_verticalhitarea").length > 0 && $("#" + activity.id + "_verticalhitarea").hasClass("hoverOverDroppable")) {
                    $(".selected.stageTile").removeClass("selected");
                    $(".selected.conditionTile").removeClass("selected");
                    $("#" + parentActivity.id + "_verticalhitarea").focus();
                }
                else {
                    if ($("#" + parentActivity.id + "_hitarea").length > 0 && $("#" + parentActivity.id + "_hitarea").hasClass("hoverOverDroppable")) {
                        $(".selected.stageTile").removeClass("selected");
                        $(".selected.conditionTile").removeClass("selected");
                        $("#" + parentActivity.id + "_hitarea").focus();
                    }
                    else {
                        ControlManager.navigateToNewTile(parentActivity.id);
                    }
                }
                GenericWorkflowDesigner.currentModel = parentActivity;
            };
            ControlManager.NavigateToDownStage = function () {
                var activity;
                activity = GenericWorkflowDesigner.currentModel;
                if ($("#" + activity.id + "_verticalhitarea").length > 0 && $("#" + activity.id + "_verticalhitarea").hasClass("hoverOverDroppable")) {
                    ControlManager.RemoveSelectedClassFromDivs();
                    $("#" + activity.id + "_verticalhitarea").focus();
                }
                else {
                    if (activity.getActivityTypeID() === ProcessDesigner.BPFActivityType.stage) {
                        if ($("#" + activity.id).find(".list-container-div").first().find(".step-list-listitem").length > 0) {
                            $("#" + activity.id).find(".step-list-listitem.selected").removeClass("selected");
                            $("#" + activity.id).find(".workflow-list-listitem.selected").removeClass("selected");
                            if ($("#" + activity.id).find(".place-holder-listitem").length > 0) {
                                $("#" + activity.id).find(".place-holder-listitem").attr("title", ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_ScreenReader_AddNewTile"));
                                $("#" + activity.id).find(".place-holder-listitem").attr("aria-label", ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_BPF_ScreenReader_AddNewTile"));
                                $("#" + activity.id).find(".place-holder-listitem").first().focus();
                            }
                            else {
                                $("#" + activity.id).find(".list-container-div").first().find(".step-list-listitem").first().focus();
                                $("#" + activity.id).find(".list-container-div").first().find(".step-list-listitem").first().addClass("selected");
                                $("#UpArrow").attr("aria-disabled", true);
                                $("#UpArrow").addClass("disableArrowButton");
                                if ($("#" + activity.id).find(".list-container-div").first().find(".step-list-listitem").length > 1) {
                                    $("#DownArrow").attr("aria-disabled", false);
                                    $("#DownArrow").removeClass("disableArrowButton");
                                }
                                else {
                                    $("#DownArrow").attr("aria-disabled", true);
                                    $("#DownArrow").addClass("disableArrowButton");
                                }
                            }
                            event.stopPropagation();
                        }
                        else {
                            var childActivityArray = ControlManager.getChildActivities(activity);
                            var childActivity = childActivityArray[0];
                            if (childActivityArray.length === 0) {
                                ControlManager.RemoveSelectedClassFromDivs();
                                return;
                            }
                            ControlManager.navigateToNewTile(childActivity.id);
                            GenericWorkflowDesigner.currentModel = childActivity;
                        }
                    }
                    else if (activity.getActivityTypeID() === ProcessDesigner.BPFActivityType.condition) {
                        var noBranchFirstChild = activity.getNoBranchFirstChild();
                        if (noBranchFirstChild != null) {
                            ControlManager.navigateToNewTile(noBranchFirstChild.id);
                            GenericWorkflowDesigner.currentModel = noBranchFirstChild;
                        }
                    }
                }
            };
            ControlManager.canvasScrollIntoView = function (element) {
                element.scrollIntoView(false);
                element = element.getBoundingClientRect();
                var canvasWidow = $("#zoomCanvasWrapper");
                if (canvasWidow.width() < element.right) {
                    canvasWidow.scrollLeft(canvasWidow.scrollLeft() + element.right - canvasWidow.width());
                }
                else if (element.left < 0) {
                    canvasWidow.scrollLeft(canvasWidow.scrollLeft() + element.left - canvasWidow.offset().left);
                }
            };
            ControlManager.ConvertBPFActivityTreeToJson = function () {
                var stopwatch = new GenericWorkflowDesigner.Stopwatch();
                stopwatch.start();
                var json = "";
                this.Activities = [];
                var activities = GenericWorkflowDesigner.Settings.workflowTree.getAllConcreteActivities();
                var rootActivity;
                if (activities.length > 0) {
                    for (var i = 0; i < activities.length; i++) {
                        if (GenericWorkflowDesigner.Settings.workflowTree.getParent(activities[i]) == null) {
                            rootActivity = activities[i];
                            break;
                        }
                    }
                    this.addActivity(rootActivity);
                    this.routeChildren(rootActivity);
                    var workflowStep = new Microsoft.Crm.Workflow.ObjectModel.WorkflowStep(rootActivity.entityName, 4);
                    workflowStep.set_title(ControlManager.processTitle);
                    workflowStep.set_Description(ControlManager.processDescription);
                    var relationshipCollectionStep = new Microsoft.Crm.Workflow.ObjectModel.RelationshipCollectionStep(workflowStep);
                    relationshipCollectionStep.set_Description("");
                    relationshipCollectionStep.set_workflow(workflowStep);
                    var BPFStageActivities = GenericWorkflowDesigner.Settings.workflowTree.getStageActivitiesOrdered();
                    var relations = EntityRelationshipUtil.findRelationship(BPFStageActivities);
                    for (var iCnt = 0; iCnt < BPFStageActivities.length; iCnt++) {
                        if (BPFStageActivities[iCnt].relationshipData.length > 0 && EntityRelationshipUtil.isDefaultStage(relations, BPFStageActivities[iCnt].stageId)) {
                            for (var i = 0; i < BPFStageActivities[iCnt].relationshipData.length; i++) {
                                var relationshipStep = new WorkflowObjectModel.RelationshipStep(workflowStep);
                                relationshipStep.set_targetStageId(BPFStageActivities[iCnt].stageId);
                                relationshipStep.set_attributeName(BPFStageActivities[iCnt].relationshipData[i].attributeName);
                                relationshipStep.set_sourceStageId(BPFStageActivities[iCnt].relationshipData[i].sourceStageId);
                                relationshipStep.set_relationshipName(BPFStageActivities[iCnt].relationshipData[i].relationshipName);
                                relationshipStep.set_Description("");
                                relationshipCollectionStep.appendStep(relationshipStep);
                            }
                        }
                    }
                    for (var i = 0; i < activities.length; i++) {
                        var activity = activities[i];
                        if (activity instanceof ProcessDesigner.BPFStageActivity && !CommonTypes.Types.Object.isNullOrUndefined(activity.getParentStage()) && !EntityRelationshipUtil.isDefaultStage(relations, activity.stageId)) {
                            var relationShipName = activity.relationshipName;
                            var attributeName = activity.relationShipAttributeName;
                            if (!CommonTypes.Types.String.isNullOrEmpty(relationShipName)) {
                                var relationShipStep = new WorkflowObjectModel.RelationshipStep(workflowStep);
                                relationShipStep.set_attributeName(attributeName);
                                relationShipStep.set_relationshipName(relationShipName);
                                var parentStage = activity.getParentStage();
                                relationShipStep.set_sourceStageId(parentStage.stageId);
                                relationShipStep.set_targetStageId(activity.stageId);
                                relationshipCollectionStep.appendStep(relationShipStep);
                            }
                        }
                    }
                    workflowStep.appendStep(relationshipCollectionStep);
                    workflowStep = MscrmControls.ProcessDesigner.BPFStageActivity.generateJson(this.Activities, workflowStep);
                    workflowStep = MscrmControls.ProcessDesigner.BPFConditionActivity.generateJson(this.Activities, workflowStep);
                    json = workflowStep.toJson();
                    window["clientdata"] = json;
                }
                stopwatch.stop();
                localStorage.setItem("ProcessDesignerControl_BPF_SavePreProcessing", stopwatch.elapsedMilliseconds.toString());
                return json;
            };
            ControlManager.routeChildren = function (activity) {
                if (!ProcessDesigner.BPFActivityType.isBPFActivityType(activity.getActivityTypeID())) {
                    return;
                }
                var childActivities = this.getChildActivities(activity);
                switch (childActivities.length) {
                    case 1:
                        this.addStageOrConditionActivity(childActivities[0]);
                        break;
                    case 2:
                        this.addConditionChildren(childActivities);
                        break;
                    case 3:
                        this.addConditionChildren(childActivities);
                        this.addStageOrConditionActivity(childActivities[2]);
                        break;
                }
            };
            ControlManager.addStageOrConditionActivity = function (activity) {
                this.addActivity(activity);
                this.routeChildren(activity);
            };
            ControlManager.addConditionChildren = function (activities) {
                this.addActivity(activities[0]);
                this.addActivity(activities[1]);
                this.routeChildren(activities[0]);
                this.routeChildren(activities[1]);
            };
            ControlManager.addActivity = function (activity) {
                if (!ProcessDesigner.BPFActivityType.isBPFActivityType(activity.getActivityTypeID())) {
                    return;
                }
                this.Activities.push(activity);
            };
            ControlManager.getChildActivities = function (activity) {
                var childActivities = [];
                childActivities = GenericWorkflowDesigner.Settings.workflowTree.getChildActivities(activity);
                return childActivities;
            };
            ControlManager.getRelationshipCollectionStepJson = function () {
                var list = [];
                var relationObj = new ProcessDesigner.RelationshipCollectionStepJson();
                relationObj.id = "";
                relationObj.name = "";
                relationObj.description = "";
                relationObj.steps = new Object({ list: list });
                relationObj.stepLabels = new Object({ list: list });
                return relationObj;
            };
            ControlManager.prototype.dispose = function () { };
            ControlManager.InvalidInputProcessData = "Invalid process data.";
            ControlManager.EmptyOrNullInputProcessData = "Process data is empty or null";
            ControlManager.EmptyOrNullRawPropertyOfInputProcessData = "raw property of Process data is empty or null";
            ControlManager.processTitle = "";
            ControlManager.processDescription = "";
            ControlManager.relationShipSteps = [];
            ControlManager.hasActionStep = false;
            ControlManager.hasFlowStep = false;
            ControlManager.Activities = [];
            ControlManager.clearTileFocusEvent = false;
            ControlManager.StageTileTitle = false;
            ControlManager.keyMap = { 17: false, 18: false, 78: false };
            return ControlManager;
        })();
        ProcessDesigner.ControlManager = ControlManager;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// -----------------------------------------------------------------------
// <copyright file="UserAgent.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
var Mscrm;
(function (Mscrm) {
    var UserAgent;
    (function (UserAgent_1) {
        var UserAgent = (function () {
            function UserAgent() {
                this.isBrowserSupportedIE = false;
                this.isBrowserSupportedChrome = false;
                this.isBrowserSupportedFirefox = false;
                this.isBrowserSafari = false;
                this.isBrowserSupportedSafari = false;
                this.rawValue = navigator.userAgent;
                this.isBrowserIE = (this.rawValue.indexOf("MSIE 10") !== -1 ||
                    this.rawValue.indexOf("MSIE 9.0") !== -1 ||
                    this.rawValue.indexOf("Trident") !== -1 ||
                    this.rawValue.indexOf("Edge") !== -1);
                if (this.isBrowserIE) {
                    this.isBrowserSupportedIE = (this.rawValue.indexOf('MSIE') !== -1) ? this.rawValue.indexOf('MSIE 9.0') == -1 && this.rawValue.indexOf('MSIE 10') !== -1 : true;
                }
                this.isBrowserChrome = (this.rawValue.indexOf("Chrome") !== -1) && !this.isBrowserIE;
                if (this.isBrowserChrome) {
                    this.isBrowserSupportedChrome = UserAgent.prototype.parseChromeVersion() >= 13;
                }
                this.isBrowserFirefox = (this.rawValue.indexOf("Firefox") !== -1);
                if (this.isBrowserFirefox) {
                    this.isBrowserSupportedFirefox = UserAgent.prototype.parseFirefoxVersion() >= 5;
                }
                if (this.rawValue.indexOf("Safari") !== -1 && !this.isBrowserIE) {
                    if ((this.rawValue.indexOf("Chrome") !== -1) || (this.rawValue.indexOf("Android") !== -1)) {
                        this.isBrowserSafari = false;
                    }
                    else {
                        this.isBrowserSafari = true;
                    }
                }
                if (this.isBrowserSafari) {
                    this.isBrowserSupportedSafari = this.parseSafariVersion() > 5;
                }
                this.isIPhone = this.rawValue.indexOf("iPhone") != -1;
                this.isIPad = this.rawValue.indexOf("iPad") != -1;
                this.isIPod = this.rawValue.indexOf("iPod") != -1;
                if (this.isIPhone || this.isIPad || this.isIPod) {
                    this.isIOSSupported = this.parseIOSVersion() >= 5;
                }
                this.isAndroid = this.rawValue.indexOf("Android") != -1;
                if (this.isAndroid) {
                    this.isAndroidModern = this.parseAndroidVersion() >= 4.4;
                }
                this.isAndroidPhone = this.isAndroid && this.rawValue.indexOf("Mobile") !== -1;
                this.isWebKit = this.rawValue.indexOf("WebKit") !== -1 && !this.isBrowserIE;
                this.isMac = navigator.appVersion.indexOf("Mac") !== -1;
                this.isWindows = (navigator.appVersion.indexOf("Win") != -1) || (navigator.appVersion.indexOf("NT") != -1);
                this.isWindows80 = navigator.appVersion.indexOf("Windows NT 6.2") != -1;
                this.isWindowsDesktop = this.isWindows && navigator.appVersion.indexOf("NT") != -1;
                this.isWindowsPhone = this.isWindows && navigator.appVersion.indexOf("Phone") != -1;
                this.isWindows81 = navigator.appVersion.indexOf("Windows NT 6.3") != -1;
                return this;
            }
            UserAgent.prototype.parseChromeVersion = function () {
                return this.parseVersionInteger(new RegExp("Chrome/(\\d+)"));
            };
            UserAgent.prototype.parseFirefoxVersion = function () {
                return this.parseVersionInteger(new RegExp("Firefox/(\\d+)"));
            };
            UserAgent.prototype.parseIOSVersion = function () {
                return this.parseVersionInteger(new RegExp("OS (\\d+)_(\\d+)_?(\\d+)?"));
            };
            UserAgent.prototype.parseVersionInteger = function (regExp) {
                var osString = navigator.userAgent.match(regExp);
                if (osString.length > 1) {
                    var majorVersion = parseInt(osString[1]);
                    return majorVersion;
                }
                return -1;
            };
            UserAgent.prototype.parseSafariVersion = function () {
                var safariString = "Version";
                return this.parseVersionFloat(safariString);
            };
            UserAgent.prototype.parseAndroidVersion = function () {
                var androidString = "Android";
                return this.parseVersionFloat(androidString);
            };
            UserAgent.prototype.parseVersionFloat = function (str) {
                var index = navigator.userAgent.indexOf(str);
                if (index !== -1) {
                    var version = this.rawValue.substring(index + str.length + 1, index + str.length + 4);
                    return parseFloat(version);
                }
                return -1;
            };
            UserAgent.prototype.getIsBrowserIE = function () {
                return this.isBrowserIE;
            };
            UserAgent.prototype.getIsBrowserChrome = function () {
                return this.isBrowserChrome;
            };
            UserAgent.prototype.getIsBrowserFirefox = function () {
                return this.isBrowserFirefox;
            };
            UserAgent.prototype.getIsBrowserSafari = function () {
                return this.isBrowserSafari;
            };
            UserAgent.prototype.getIsBrowserSupportedIE = function () {
                return this.isBrowserSupportedIE;
            };
            UserAgent.prototype.getIsBrowserSupportedChrome = function () {
                return this.isBrowserSupportedChrome;
            };
            UserAgent.prototype.getIsBrowserSupportedFirefox = function () {
                return this.isBrowserSupportedFirefox;
            };
            UserAgent.prototype.getIsBrowserSupportedSafari = function () {
                return this.isBrowserSupportedSafari;
            };
            UserAgent.prototype.getIsIPhone = function () {
                return this.isIPhone;
            };
            UserAgent.prototype.getIsIOSSupported = function () {
                return this.isIOSSupported;
            };
            UserAgent.prototype.getIsIPad = function () {
                return this.isIPad;
            };
            UserAgent.prototype.getIsIPod = function () {
                return this.isIPod;
            };
            UserAgent.prototype.getIsAndroidModern = function () {
                return this.isAndroidModern;
            };
            UserAgent.prototype.getIsMac = function () {
                return this.isMac;
            };
            UserAgent.prototype.getIsWindows = function () {
                return this.isWindows;
            };
            UserAgent.prototype.getIsWindows80 = function () {
                return this.isWindows80;
            };
            UserAgent.prototype.getIsWindowsDesktop = function () {
                return this.isWindowsDesktop;
            };
            UserAgent.prototype.getIsWindowsPhone = function () {
                return this.isWindowsPhone;
            };
            UserAgent.prototype.getIsWindows81 = function () {
                return this.isWindows81;
            };
            UserAgent.prototype.getIsDesktopOutlook = function () {
                return this.isDesktopOutlook;
            };
            UserAgent.prototype.getIsAndroidPhone = function () {
                return this.isAndroidPhone;
            };
            UserAgent.prototype.getUserAgentName = function () {
                if (this.isAndroid) {
                    return "Android";
                }
                else if (this.isAndroidModern) {
                    return "AndroidModern";
                }
                else if (this.isBrowserChrome) {
                    return "Chrome";
                }
                else if (this.isBrowserFirefox) {
                    return "Firefox";
                }
                else if (this.isBrowserIE) {
                    return "IE";
                }
                else if (this.isIOSSupported) {
                    return "Ios";
                }
                else if (this.isWindows) {
                    return "Windows";
                }
                else if (this.isMac) {
                    return "Macintosh";
                }
                else {
                    return "";
                }
            };
            return UserAgent;
        })();
        UserAgent_1.UserAgent = UserAgent;
        var BrowserValidator = (function () {
            function BrowserValidator() {
                this.userAgent = new UserAgent();
            }
            BrowserValidator.prototype.isBrowserSupported = function () {
                return this.userAgent.getIsBrowserSupportedIE() ||
                    this.userAgent.getIsBrowserSupportedChrome() ||
                    this.userAgent.getIsBrowserSupportedFirefox() ||
                    this.userAgent.getIsBrowserSupportedSafari() ||
                    this.userAgent.getIsDesktopOutlook();
            };
            BrowserValidator.prototype.isBrowserIE = function () {
                return this.userAgent.getIsBrowserIE();
            };
            return BrowserValidator;
        })();
        UserAgent_1.BrowserValidator = BrowserValidator;
        var DeviceValidator = (function () {
            function DeviceValidator() {
                this.userAgent = new UserAgent();
            }
            DeviceValidator.prototype.isMobileDevice = function () {
                return this.userAgent.getIsWindowsPhone() || this.userAgent.getIsIPhone() || this.userAgent.getIsAndroidPhone();
            };
            return DeviceValidator;
        })();
        UserAgent_1.DeviceValidator = DeviceValidator;
    })(UserAgent = Mscrm.UserAgent || (Mscrm.UserAgent = {}));
})(Mscrm || (Mscrm = {}));
// -----------------------------------------------------------------------
// <copyright file="ProcessDesignerControl.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
/// <reference path="Controls/ProcessDesignerControlManager.ts"/>
/// <reference path="src/utility/useragent.ts" />
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        'use strict';
        var MetricsReportingServiceTelemetryReporter = _Microsoft.Client.Telemetry.MetricsReportingServiceTelemetryReporter;
        var Utility = _Microsoft.Client.Telemetry.Utility;
        var UserAgent = Mscrm.UserAgent.UserAgent;
        ProcessDesigner.metricsReportingServiceTelemetryReporter;
        ProcessDesigner.xhrResponseFunction;
        ProcessDesigner.xhrObj;
        ProcessDesigner.sessionId;
        ProcessDesigner.processId = "00000000-0000-0000-0000-000000000000";
        ProcessDesigner.processState = "";
        ProcessDesigner.primaryEntity;
        ProcessDesigner.processStep;
        ProcessDesigner.isPropertyPageSaved = false;
        ProcessDesigner.isStructuralChangePerformed = false;
        var ProcessDesignerControl = (function () {
            function ProcessDesignerControl() {
            }
            ProcessDesignerControl.getProcessId = function () {
                if (!ProcessDesigner.processId || ProcessDesigner.processId.indexOf(ProcessDesignerControl.emptyGuidStr) > -1) {
                    ProcessDesignerControl.initProcessId();
                }
                return ProcessDesigner.processId;
            };
            ProcessDesignerControl.getOrigin = function () {
                if (ProcessDesignerControl.dataBag && ProcessDesignerControl.dataBag.internal) {
                    return ProcessDesignerControl.dataBag.internal.origin;
                }
                return null;
            };
            ProcessDesignerControl.prototype.preInit = function () {
                this.startDesignerLoadTimer();
                ProcessDesigner.sessionId = Utility.newGuid();
                this.initializeTelemetryReporter();
            };
            ProcessDesignerControl.prototype.initCore = function (context) {
                if (!ProcessDesigner.metricsReportingServiceTelemetryReporter) {
                    this.initializeTelemetryReporter();
                }
                if (!window["designerLoad_timer"]) {
                    this.startDesignerLoadTimer();
                }
                this.processDesignerControlManager = new ProcessDesigner.ControlManager(null);
                this.processDesignerControlManager.initialize(this);
                var parentContainer = window["parentContainer"];
                if (CommonTypes.Types.Object.isNullOrUndefined(parentContainer)) {
                    parentContainer = $('.custom_control_section');
                }
                else {
                    parentContainer = $(parentContainer);
                }
                this.designerDomElement = parentContainer;
                $(window).bind("beforeunload", ProcessDesigner.TelemetryEventReporter.ReportProcessDesignerCloseEvent(context));
                ProcessDesignerControl.initProcessId();
                var self = this;
                ProcessDesignerControl.dataBag = context;
                this.processDesignerControlManager.render(ProcessDesignerControl.dataBag.parameters);
                this.processDesignerControlManager.validateDependentOptionSetData();
                window["designerActivate"] = MscrmControls.ProcessDesigner.TelemetryEventReporter.ReportProcessDesignerActivateEvent;
                window["designerDeactivate"] = MscrmControls.ProcessDesigner.TelemetryEventReporter.ReportProcessDesignerDeactivateEvent;
                window["designerSave"] = MscrmControls.ProcessDesigner.TelemetryEventReporter.ReportProcessDesignerSaveEvent;
                window["SmbAddBPFAddSolutionDependency"] = MscrmControls.ProcessDesigner.TelemetryEventReporter.ReportProcessDesignerSmbAddOobBPFSolutionDependencyEvent;
                window["designerLoaded"] = true;
                $(window).on('beforeunload', function () {
                    if (window["isDirty"] == true) {
                        var unsavedMessage = ProcessDesignerControl.dataBag.resources.getString("LOCID_PROCESS_UNSAVED_MESSAGE");
                        return unsavedMessage;
                    }
                });
                window["isDirty"] = false;
                GenericWorkflowDesigner.BasePropertyView.outsideArea = "#process_configurator_container";
                this.setProcessDetails();
                GenericWorkflowDesigner.BasePropertyView.showPropertiesModifiedDialog = this.showPropertiesModifiedDialog;
                this.OverrideMenuStyle();
                this.OverrideProcessDetailsSection();
                this.ToolpaneTab();
                $("#header,#processDetailArea").on("keydown", function (event) {
                    ProcessDesigner.ControlManager.SetShortcutKeysToMoveOnMajorAreas(event);
                });
                if (ProcessDesigner.processId && ProcessDesigner.processId.indexOf(ProcessDesignerControl.emptyGuidStr) == -1) {
                    this.retrieveProcessAttributes(context);
                }
            };
            ProcessDesignerControl.prototype.startDesignerLoadTimer = function () {
                window["designerLoad_timer"] = new GenericWorkflowDesigner.Stopwatch();
                window["designerLoad_timer"].start();
            };
            ProcessDesignerControl.prototype.showPropertiesModifiedDialog = function (yescallback, nocallback) {
                var dialogDetails = {
                    dialogTitle: MscrmControls.ProcessDesigner.MetadataProvider.getLocalizedString("DialogTitle_UnResolvedSyncErrors"),
                    dialogMessage: MscrmControls.ProcessDesigner.MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_Component_Properties_TabSwitch_Dialog"),
                    confirmButtonLabel: MscrmControls.ProcessDesigner.MetadataProvider.getLocalizedString("Button_Label_Apply"),
                    cancelButtonLabel: MscrmControls.ProcessDesigner.MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_Component_Properties_TabSwitch_Dialog_Cancel"),
                    yesCallbackAction: yescallback,
                    noCallbackAction: nocallback
                };
                GenericWorkflowDesigner.eventManager.trigger(GenericWorkflowDesigner.FrameworkEvents.showDialog, dialogDetails);
            };
            ProcessDesignerControl.prototype.retrieveProcessAttributes = function (context) {
                var columns = ["category", "statecode", "statuscode"];
                var entityName = Mscrm.InternalUtilities.EntityNames.Workflow;
                var processGuid = ProcessDesigner.processId;
                var parent = ProcessDesigner.WindowUtility.GetParentWindow();
                if (!parent.hasOwnProperty("Xrm"))
                    return;
                parent["Xrm"].Internal.messages.retrieve(entityName, processGuid, columns).then(function (retrieveResponse) {
                    window["designerLoad_timer"].stop();
                    var elapsedTimeInMS = window["designerLoad_timer"].elapsedMilliseconds;
                    if (!Mscrm.InternalUtilities.JSTypes.isNull(retrieveResponse)) {
                        var responseEntity = retrieveResponse.entity;
                        if (!Mscrm.InternalUtilities.JSTypes.isNull(responseEntity)) {
                            context["parameters"]["Category"]["raw"] = responseEntity.getValue("category")._val$p$0;
                            context["parameters"]["StateCode"]["raw"] = responseEntity.getValue("statecode")._val$p$0;
                            context["parameters"]["StatusCode"]["raw"] = responseEntity.getValue("statuscode")._val$p$0;
                            context["client"]["userAgent"] = new UserAgent();
                            ProcessDesigner.TelemetryEventReporter.ReportProcessDesignerLaunchEvent(context, elapsedTimeInMS, "", "0");
                        }
                        else {
                            ProcessDesigner.TelemetryEventReporter.ReportProcessDesignerLaunchEvent(context, elapsedTimeInMS, "retrieveProcessAttributes: failure. retrieveResponse.entity is null.", "1");
                        }
                    }
                    else {
                        ProcessDesigner.TelemetryEventReporter.ReportProcessDesignerLaunchEvent(context, elapsedTimeInMS, "retrieveProcessAttributes: failure. retrieveResponse is null.", "1");
                    }
                }, function (errorResponse) {
                    window["designerLoad_timer"].stop();
                    var elapsedTimeInMS = window["designerLoad_timer"].elapsedMilliseconds;
                    var serviceFault = errorResponse.get_organizationServiceFault();
                    var errorCode;
                    var errorMessage;
                    var serializedException;
                    if (!Mscrm.InternalUtilities.JSTypes.isNull(serviceFault)) {
                        errorCode = serviceFault.get_errorCode();
                        errorMessage = errorResponse.get_message();
                        serializedException = serviceFault.get_responseOuterXml();
                    }
                    ProcessDesigner.TelemetryEventReporter.ReportProcessDesignerLaunchEvent(context, elapsedTimeInMS, "retrieveProcessAttributes: failure."
                        + (!Mscrm.InternalUtilities.JSTypes.isNull(errorCode) ? (" Errorcode : " + errorCode) : "")
                        + (!Mscrm.InternalUtilities.JSTypes.isNull(errorMessage) ? (" ErrorMessage : " + errorMessage) : "")
                        + (!Mscrm.InternalUtilities.JSTypes.isNull(serializedException) ? (" SerializedException : " + serializedException) : ""), "1");
                    Mscrm.InternalUtilities.ClientApiUtility.actionFailedCallback(errorResponse);
                });
            };
            ProcessDesignerControl.prototype.XmlValidationFailureHandler = function (errorData) {
                var errorNotificationHtml = '<div id="errorNotificationArea" class="notificationArea"></div>';
                var processEditor = $('.custom_control_section');
                processEditor.append(errorNotificationHtml);
                if (GenericWorkflowDesigner.Settings.renderRTL) {
                    $("html").addClass("rtl");
                }
                var message = ProcessDesignerControl.dataBag.resources.getString("ProcessDesignerControl_Common_XMLValidationError");
                GenericWorkflowDesigner.Settings.notification = new GenericWorkflowDesigner.Notification("#errorNotificationArea");
                var errorMessage = new GenericWorkflowDesigner.NotificationMessage(GenericWorkflowDesigner.MessageType.Error, message);
                GenericWorkflowDesigner.Settings.notification.AppendNotification(errorMessage);
                var errorCount = GenericWorkflowDesigner.Settings.notification.GetNotifictionCount();
                message = errorCount + " " + errorMessage;
                var summaryMessage = new GenericWorkflowDesigner.NotificationMessage(GenericWorkflowDesigner.MessageType.Error, message);
                GenericWorkflowDesigner.Settings.notification.ShowNotification(summaryMessage, ProcessDesignerControl.validationMode);
            };
            ProcessDesignerControl.prototype.XmlValidationSuccessHandler = function (response) {
                if (this.propertyBagParametersAreValid(ProcessDesignerControl.dataBag)) {
                    this.processDesignerControlManager.render(ProcessDesignerControl.dataBag.parameters);
                }
                else {
                    throw ("TODO Throw message to be written");
                }
            };
            ProcessDesignerControl.prototype.getUrl = function () {
                var port = window.location.port;
                var host = window.location.hostname;
                var orgUrl = window.location.protocol + '//' + host;
                if (port) {
                    orgUrl += ":" + port;
                }
                return orgUrl;
            };
            ProcessDesignerControl.prototype.editDone = function () {
                window["isDirty"] = true;
            };
            ProcessDesignerControl.prototype.propertyBagParametersAreValid = function (context) {
                var propertiesUpdated = !CommonTypes.Types.Object.isNullOrUndefined(context.updatedProperties);
                var processDataExists = !CommonTypes.Types.Object.isNullOrUndefined(context.parameters.ProcessData);
                return propertiesUpdated && processDataExists;
            };
            ProcessDesignerControl.initProcessId = function () {
                ProcessDesigner.processId = ProcessDesignerControl.getURLParameter("id");
                if (ProcessDesigner.processId != null && ProcessDesigner.processId.indexOf('%') > -1) {
                    ProcessDesigner.processId = ProcessDesigner.processId.substr(3, 36);
                }
            };
            ProcessDesignerControl.prototype.saveProcessControlHack = function () {
                var clientdata = ProcessDesigner.ControlManager.ConvertBPFActivityTreeToJson();
                var processId = ProcessDesigner.processId;
                var soapRequest = "<?xml version=\"1.0\" encoding=\"utf-8\" ?><soap:Envelope xmlns:soap=\"http://schemas.xmlsoap.org/soap/envelope/\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\"><soap:Body><UpdateProcess xmlns=\"http://schemas.microsoft.com/crm/2009/WebServices\"><jsonData>" + clientdata + "</jsonData><id>{" + processId + "}</id></UpdateProcess></soap:Body></soap:Envelope>";
                var headers = [];
                headers["ClientAppName"] = "ServiceDesk";
                headers["ClientAppVersion"] = "8.1.0000.0207";
                headers["X-Requested-With"] = "XMLHttpRequest";
                headers["ClientAppName"] = "ServiceDesk";
                headers["Cache-Control"] = "no-cache";
                headers["SessionId"] = localStorage.getItem("MoCASessionID");
                var host = window.location.hostname;
                var orgName = ProcessDesignerControl.getURLParameter("org");
                return jQuery.ajax({
                    type: "POST",
                    url: "http://" + host + "/" + orgName + "/AppWebServices/ProcessControl.asmx",
                    data: soapRequest,
                    headers: headers,
                    contentType: "text/xml; charset=UTF-8",
                    success: this.onSuccess,
                    error: this.onError
                });
            };
            ProcessDesignerControl.getURLParameter = function (sParam) {
                var sPageURL = window.location.search.substring(1);
                var sURLVariables = sPageURL.split('&');
                for (var i = 0; i < sURLVariables.length; i++) {
                    var sParameterName = sURLVariables[i].split('=');
                    if (sParameterName[0] == sParam) {
                        return sParameterName[1];
                    }
                }
            };
            ProcessDesignerControl.prototype.onSuccess = function () {
            };
            ProcessDesignerControl.prototype.onError = function () {
            };
            ProcessDesignerControl.prototype.initializeTelemetryReporter = function () {
                ProcessDesigner.metricsReportingServiceTelemetryReporter = MetricsReportingServiceTelemetryReporter.Instance();
            };
            ProcessDesignerControl.prototype.XhrResponse = function () {
                if (ProcessDesigner.xhrResponseFunction) {
                    ProcessDesigner.xhrResponseFunction(ProcessDesigner.xhrObj);
                }
                else {
                    console.log("XHR Status: ", ProcessDesigner.xhrObj.status, "-", ProcessDesigner.xhrObj.statusText);
                }
            };
            ProcessDesignerControl.prototype.setProcessDetails = function () {
                $("#expandContainer").attr("role", "button");
                $("#expandContainer").attr("aria-expanded", "false");
                $("#collapseContainer").attr("role", "button");
                $("#collapseContainer").attr("aria-expanded", "true");
                $(".bpfexpandCollapse").attr("title", MscrmControls.ProcessDesigner.MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_ScreenReader_GlobalArea_DetailsTooltip"));
            };
            ProcessDesignerControl.prototype.OverrideMenuStyle = function () {
                $('#mnuaction').attr('style', 'display: inline-block');
                $('#mnuaction').attr('aria-label', MscrmControls.ProcessDesigner.MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_MoreMenuTooltip"));
                $('#mnuaction').attr('title', MscrmControls.ProcessDesigner.MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_MoreMenuTooltip"));
                $("#crmMenuBarmnuBar li").each(function () {
                    $('#' + this.id + ' a').attr("title", this.title);
                    $(this).removeAttr("title");
                });
                var AddAttributeToHtmlElement = function (element, attributeName, attributeValue) {
                    $(element).attr(attributeName, attributeValue);
                };
                $('li#mnucrmMenuBarhelp .ms-crm-Menu-Label').click(function () { AddAttributeToHtmlElement('ul#mnucrmMenuBarhelp', 'role', 'item'); });
                $('li#mnucrmMenuBarhelp .ms-crm-Menu-Label').keydown(function (e) { if (e.keyCode == 13 || e.keyCode == 32) {
                    AddAttributeToHtmlElement('ul#mnucrmMenuBarhelp', 'role', 'item');
                } ; });
                $('li#mnuaction .ms-crm-Menu-Label').click(function () { AddAttributeToHtmlElement('ul#mnuaction', 'role', 'item'); });
                $('li#mnuaction .ms-crm-Menu-Label').keydown(function (e) { if (e.keyCode == 13 || e.keyCode == 32) {
                    AddAttributeToHtmlElement('ul#mnuaction', 'role', 'item');
                } ; });
                $('li#mnuaction a.ms-crm-Menu-Label span').text("");
                $('li#mnuaction a.ms-crm-Menu-Label').attr('aria-label', MscrmControls.ProcessDesigner.MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_MoreMenuTooltip"));
                $('li#mnuaction a.ms-crm-Menu-Label img').remove();
            };
            ProcessDesignerControl.prototype.OverrideProcessDetailsSection = function () {
                $('#ProcessOwner_container input').attr('aria-readonly', "true");
                $('#ProcessOwner_container input').attr('title', $('#ProcessOwner').val());
                $('#ProcessOwner_container input').attr('aria-labelledby', "lbl_ProcessOwner");
                $('#ProcessOwner_container input').removeAttr("disabled");
                $('#ProcessOwner_container input').attr('readonly', "readonly");
                $('#PrimaryEntity_container input').attr('aria-readonly', "true");
                $('#PrimaryEntity_container input').attr('title', $('#PrimaryEntity').val());
                $('#PrimaryEntity_container input').attr('aria-labelledby', "lbl_PrimaryEntity");
                $('#PrimaryEntity_container input').removeAttr("disabled");
                $('#PrimaryEntity_container input').attr('readonly', "readonly");
                $('#Category_container input').attr('aria-readonly', "true");
                $('#Category_container input').attr('title', $('#Category').val());
                $('#Category_container input').attr('aria-labelledby', "lbl_Category");
                $('#Category_container input').removeAttr("disabled");
                $('#Category_container input').attr('readonly', "readonly");
                $('#ProcessUniqueName_container input').attr('aria-readonly', "true");
                $('#ProcessUniqueName_container input').attr('title', $('#ProcessUniqueName').val());
                $('#ProcessUniqueName_container input').attr('aria-labelledby', "lbl_ProcessUniqueName");
                $('#ProcessUniqueName_container input').removeAttr("disabled");
                $('#ProcessUniqueName_container input').attr('readonly', "readonly");
            };
            ProcessDesignerControl.prototype.ToolpaneTab = function () {
                $('#lblLibrary').attr('role', "tab");
                $('#lblLibrary').attr('aria-selected', true);
                $('#lblProperty').attr('role', "tab");
                $('#lblProperty').attr('aria-selected', false);
            };
            ProcessDesignerControl.EmptyOrNullInputProcessData = "Process data is empty or null";
            ProcessDesignerControl.EmptyOrNullRawPropertyOfInputProcessData = "raw property of Process data is empty or null";
            ProcessDesignerControl.xmlFilePath = "/_static/_common/scripts/processcontrol/LibraryTilesData.xml";
            ProcessDesignerControl.xsdFilePath = "/_static/_common/scripts/processcontrol/ConfigXmlSchema.xsd";
            ProcessDesignerControl.validationMode = GenericWorkflowDesigner.ValidationMode.None;
            ProcessDesignerControl.emptyGuidStr = "00000000-0000-0000-0000-000000000000";
            return ProcessDesignerControl;
        })();
        ProcessDesigner.ProcessDesignerControl = ProcessDesignerControl;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// -----------------------------------------------------------------------
// <copyright file="ElementIds.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        'use strict';
        var ElementId = (function () {
            function ElementId() {
            }
            ElementId.Canvas = "canvas";
            ElementId.ProcessDesigner = "processdesigner";
            ElementId.WorkspaceWrapper = "workspaceWrapper";
            ElementId.Loader = "loader";
            ElementId.ZoomItem = "zoomItem";
            ElementId.PanIcon = "commandIcon";
            ElementId.ToolPane = "toolpane";
            ElementId.ToolPaneHeader = "toolpaneheader";
            ElementId.Library = "library";
            ElementId.Property = "property";
            ElementId.LibraryTab = "libraryTab";
            ElementId.PropertyTab = "propertyTab";
            ElementId.ProcessFooterReadOnlyState = "footerReadonlystate";
            ElementId.ProcessProp = "process_prop";
            return ElementId;
        })();
        ProcessDesigner.ElementId = ElementId;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// -----------------------------------------------------------------------
// <copyright file="Constants.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        'use strict';
        var HtmlElementNames = (function () {
            function HtmlElementNames() {
            }
            HtmlElementNames.Div = "div";
            HtmlElementNames.ListItem = "li";
            HtmlElementNames.UnorderedList = "ul";
            HtmlElementNames.OrderedList = "ol";
            HtmlElementNames.Select = "select";
            HtmlElementNames.Option = "option";
            HtmlElementNames.Input = "input";
            HtmlElementNames.Image = "img";
            HtmlElementNames.Span = "span";
            HtmlElementNames.NoBR = "nobr";
            HtmlElementNames.TextArea = "textarea";
            HtmlElementNames.Anchor = "a";
            HtmlElementNames.Label = "label";
            HtmlElementNames.Table = "table";
            HtmlElementNames.TableColumn = "col";
            HtmlElementNames.TableColumnGroup = "colgroup";
            HtmlElementNames.TableRow = "tr";
            HtmlElementNames.TableCell = "td";
            return HtmlElementNames;
        })();
        ProcessDesigner.HtmlElementNames = HtmlElementNames;
        var HtmlAttributeNames = (function () {
            function HtmlAttributeNames() {
            }
            HtmlAttributeNames.AltText = "alt";
            HtmlAttributeNames.AttributeLogicalName = "attrName";
            HtmlAttributeNames.DefaultSelected = "defaultSelected";
            HtmlAttributeNames.DefaultValue = "defaultValue";
            HtmlAttributeNames.Id = "id";
            HtmlAttributeNames.NameAttribute = "name";
            HtmlAttributeNames.MaxLength = "maxLength";
            HtmlAttributeNames.PrivilegeMask = "attrPriv";
            HtmlAttributeNames.RequiredLevel = "req";
            HtmlAttributeNames.TabIndex = "tabindex";
            HtmlAttributeNames.Type = "type";
            HtmlAttributeNames.Min = "min";
            HtmlAttributeNames.Max = "max";
            HtmlAttributeNames.Accuracy = "acc";
            HtmlAttributeNames.DataType = "dt";
            HtmlAttributeNames.Href = "href";
            HtmlAttributeNames.Format = "format";
            HtmlAttributeNames.Dir = "dir";
            HtmlAttributeNames.AriaDescribedBy = "aria-describedby";
            HtmlAttributeNames.AriaLabeledBy = "aria-labelledby";
            HtmlAttributeNames.AriaInvalid = "aria-invalid";
            HtmlAttributeNames.Role = "role";
            HtmlAttributeNames.Title = "title";
            HtmlAttributeNames.CssClass = "class";
            return HtmlAttributeNames;
        })();
        ProcessDesigner.HtmlAttributeNames = HtmlAttributeNames;
        var CssClass = (function () {
            function CssClass() {
            }
            CssClass.ZoomItem = "zoomItem";
            CssClass.WorkspaceWrapper = "workspaceWrapper";
            CssClass.CommandButton = "commandButton";
            CssClass.WorkspaceButton = "workspaceButton";
            return CssClass;
        })();
        ProcessDesigner.CssClass = CssClass;
        var TelemetryConstants = (function () {
            function TelemetryConstants() {
            }
            TelemetryConstants.ViewedFromCanvas = "Canvas";
            TelemetryConstants.ViewedFromFlyout = "Flyout";
            TelemetryConstants.processStateDraft = "Draft";
            TelemetryConstants.processStateActive = "Active";
            return TelemetryConstants;
        })();
        ProcessDesigner.TelemetryConstants = TelemetryConstants;
        var ActivityTypeConstants = (function () {
            function ActivityTypeConstants() {
            }
            ActivityTypeConstants.StageActivity = "BPFStageActivity";
            ActivityTypeConstants.StepActivity = "BPFStepActivity";
            ActivityTypeConstants.ConditionActivity = "BPFConditionActivity";
            return ActivityTypeConstants;
        })();
        ProcessDesigner.ActivityTypeConstants = ActivityTypeConstants;
        var BPFConditionBranchLimits = (function () {
            function BPFConditionBranchLimits() {
            }
            BPFConditionBranchLimits.MaximumAllowedNestedBranches = 5;
            BPFConditionBranchLimits.MaximumAllowedBranchesUnderCondition = 10;
            return BPFConditionBranchLimits;
        })();
        ProcessDesigner.BPFConditionBranchLimits = BPFConditionBranchLimits;
        var Events = (function () {
            function Events() {
            }
            Events.StepSequencePropertyUpdated = "stepSequencePropertyUpdated";
            return Events;
        })();
        ProcessDesigner.Events = Events;
        var ElementPrefixes = (function () {
            function ElementPrefixes() {
            }
            ElementPrefixes.DetailsLabel = "Details";
            ElementPrefixes.DetailsPrefix = "details_";
            ElementPrefixes.TileButtonPrefix = "#tileButton_";
            ElementPrefixes.TileButtonImagePrefix = "#tileButtonImage_";
            ElementPrefixes.TileButtonTextPrefix = "#tileButtonSpan_";
            return ElementPrefixes;
        })();
        ProcessDesigner.ElementPrefixes = ElementPrefixes;
        (function (ProcessType) {
            ProcessType[ProcessType["Workflow"] = 0] = "Workflow";
            ProcessType[ProcessType["Dialog"] = 1] = "Dialog";
            ProcessType[ProcessType["BusinessRule"] = 2] = "BusinessRule";
            ProcessType[ProcessType["Action"] = 3] = "Action";
            ProcessType[ProcessType["BusinessProcessFlow"] = 4] = "BusinessProcessFlow";
            ProcessType[ProcessType["ModernFlow"] = 5] = "ModernFlow";
        })(ProcessDesigner.ProcessType || (ProcessDesigner.ProcessType = {}));
        var ProcessType = ProcessDesigner.ProcessType;
        (function (LinkType) {
            LinkType[LinkType["PBLLink"] = 0] = "PBLLink";
            LinkType[LinkType["BPFEntitylink"] = 1] = "BPFEntitylink";
        })(ProcessDesigner.LinkType || (ProcessDesigner.LinkType = {}));
        var LinkType = ProcessDesigner.LinkType;
        var ProcessTypeNames = (function () {
            function ProcessTypeNames() {
            }
            ProcessTypeNames.Workflow = "Workflow";
            ProcessTypeNames.Dialog = "Task Flow";
            ProcessTypeNames.BusinessRule = "Business Rule";
            ProcessTypeNames.Action = "Action";
            ProcessTypeNames.BusinessProcessFlow = "Business Process Flow";
            return ProcessTypeNames;
        })();
        ProcessDesigner.ProcessTypeNames = ProcessTypeNames;
        var FormControlClassId = (function () {
            function FormControlClassId() {
            }
            FormControlClassId.LinkControl = "DFDF1CDE-837B-4AC9-98CF-AC74361FD89D";
            return FormControlClassId;
        })();
        ProcessDesigner.FormControlClassId = FormControlClassId;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// -----------------------------------------------------------------------
// <copyright file="IHtmlTextWriter.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        'use strict';
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// -----------------------------------------------------------------------
// <copyright file="ITextWriter.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        'use strict';
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// -----------------------------------------------------------------------
// <copyright file="HtmlTextWriter.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
/// <reference path="IHtmlTextWriter.ts"/>
/// <reference path="ITextWriter.ts"/>
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        'use strict';
        var HtmlTextWriter = (function () {
            function HtmlTextWriter(writer, tabString) {
                if (tabString === void 0) { tabString = HtmlTextWriter.DefaultTabString; }
                this.indentLevel = 0;
                this.tabsPending = false;
                this.tabString = "\t";
                this.writer = writer;
                this.tabString = tabString;
            }
            HtmlTextWriter.prototype.writeBeginTag = function (tag) {
                if (this.tabsPending) {
                    this.outputTabs();
                }
                this.writer.write(HtmlTextWriter.TagLeftChar);
                this.writer.write(tag);
            };
            HtmlTextWriter.prototype.writeEndTag = function (tag) {
                if (this.tabsPending) {
                    this.outputTabs();
                }
                this.writer.write(HtmlTextWriter.TagLeftChar);
                this.writer.write(HtmlTextWriter.SlashChar);
                this.writer.write(tag);
                this.writer.write(HtmlTextWriter.TagRightChar);
            };
            HtmlTextWriter.prototype.writeAttribute = function (name, value, encode) {
                if (encode === void 0) { encode = false; }
                this.writer.write(HtmlTextWriter.SpaceChar);
                this.writer.write(name);
                if (!CommonTypes.Types.String.isNullOrEmpty(value)) {
                    this.writer.write(HtmlTextWriter.EqualsDoubleQuoteString);
                    this.writer.write(value);
                    this.writer.write(HtmlTextWriter.DoubleQuoteChar);
                }
            };
            HtmlTextWriter.prototype.write = function (value) {
                if (this.tabsPending) {
                    this.outputTabs();
                }
                this.writer.write(value);
            };
            HtmlTextWriter.prototype.writeLine = function (value) {
                if (this.tabsPending) {
                    this.outputTabs();
                }
                this.writer.writeLine(value);
                this.tabsPending = true;
            };
            HtmlTextWriter.prototype.toString = function () {
                return this.writer.getText();
            };
            HtmlTextWriter.prototype.outputTabs = function () {
                if (this.tabsPending) {
                    for (var i = 0; i < this.indentLevel; i++) {
                        this.writer.write(this.tabString);
                    }
                    this.tabsPending = false;
                }
            };
            HtmlTextWriter.TagLeftChar = "<";
            HtmlTextWriter.TagRightChar = ">";
            HtmlTextWriter.SelfClosingChars = " /";
            HtmlTextWriter.SelfClosingTagEnd = " />";
            HtmlTextWriter.EndTagLeftChars = "</";
            HtmlTextWriter.DoubleQuoteChar = "\"";
            HtmlTextWriter.SingleQuoteChar = "'";
            HtmlTextWriter.SpaceChar = " ";
            HtmlTextWriter.EqualsChar = "=";
            HtmlTextWriter.SlashChar = "/";
            HtmlTextWriter.EqualsDoubleQuoteString = "=\"";
            HtmlTextWriter.SemicolonChar = ";";
            HtmlTextWriter.StyleEqualsChar = ":";
            HtmlTextWriter.DefaultTabString = "\t";
            return HtmlTextWriter;
        })();
        ProcessDesigner.HtmlTextWriter = HtmlTextWriter;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// -----------------------------------------------------------------------
// <copyright file="MetadataProvider.ts" company="Microsoft">
// Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        "use strict";
        var MetadataProvider = (function () {
            function MetadataProvider() {
            }
            MetadataProvider.getEntityMetadata = function (success, failure) {
                ProcessDesigner.ProcessDesignerControl.dataBag.resources.getEntityListMetadata(function (entityMetadataList) {
                    var entityMetadataJson = [];
                    for (var i = 0; i < entityMetadataList.length; i++) {
                        var entityMetadata = entityMetadataList[i];
                        var logicalName = entityMetadata.LogicalName;
                        var displayName = entityMetadata.DisplayName;
                        entityMetadataJson.push({
                            logicalName: logicalName,
                            displayName: displayName
                        });
                    }
                    entityMetadataJson = entityMetadataJson.sort(function (a, b) { return (a.displayName < b.displayName ? -1 : 1); });
                    success(entityMetadataJson);
                }, failure);
            };
            MetadataProvider.getEntityMetadataId = function (entityLogicalName, displayName, success, failure) {
                ProcessDesigner.ProcessDesignerControl.dataBag.resources.getEntityMetadata(entityLogicalName, function (entityMetadata) {
                    entityMetadata.entityName = displayName;
                    success(entityMetadata);
                }, failure);
            };
            MetadataProvider.retrieveRecords = function (entityType, options, successCallback, errorCallback) {
                SDK.REST.retrieveMultipleRecords(entityType, options, successCallback, errorCallback, function (data) { });
            };
            MetadataProvider.retrieveUISupportedProcesses = function (processNamePrefix, entityLogicalName, isGlobalProcess, successCallback, errorCallback) {
                SDK.REST.retrieveUISupportedProcesses(processNamePrefix, entityLogicalName, isGlobalProcess, successCallback, errorCallback);
            };
            MetadataProvider.validateProcessForUI = function (processId, successCallback, errorCallback, isAsync) {
                if (isAsync === void 0) { isAsync = true; }
                SDK.REST.validateProcessForUI(processId, successCallback, errorCallback, isAsync);
            };
            MetadataProvider.getSystemControlDataByLogicalName = function (logicalName, entityLogicalName) {
                var systemControlsList = ProcessDesigner.ProcessDesignerControl.dataBag.resources.getSystemControlAttributeMetadataModel(entityLogicalName);
                if (!ProcessDesigner.Util.isNull(systemControlsList)) {
                    for (var i = 0; i < systemControlsList.length; i++) {
                        if (systemControlsList[i].get_logicalName() == logicalName) {
                            return systemControlsList[i];
                        }
                    }
                }
            };
            MetadataProvider.getStepAttributeMetadata = function (entityLogicalName, success, failure) {
                var _this = this;
                if (ProcessDesigner.Util.isNull(entityLogicalName) || ProcessDesigner.Util.isEmptyString(entityLogicalName)) {
                    return [];
                }
                ProcessDesigner.ProcessDesignerControl.dataBag.resources.getAttributeListMetadata(entityLogicalName, function (attributesListWithType) {
                    if (entityLogicalName == "") {
                        return [];
                    }
                    if (attributesListWithType == null || attributesListWithType == undefined) {
                        console.log("Error:attributeMetadataList.childNodes[0].textContent is null File:MetadataProvider.ts Method:getAttributeMetadata()");
                        return;
                    }
                    var attributeTypeMapping = {};
                    var attributeDependentOptionSetMappings = {};
                    for (var attributesCount = 0; attributesCount < attributesListWithType.length; attributesCount++) {
                        attributeTypeMapping[attributesListWithType[attributesCount].LogicalName] = attributesListWithType[attributesCount].Type;
                        if (attributesListWithType[attributesCount].Type == ProcessDesigner.AttributeType.Picklist) {
                            var attributeDependentOptionSetProperties = { parentPicklistLogicalName: "", childPicklistLogicalNames: null };
                            attributeDependentOptionSetProperties.parentPicklistLogicalName = attributesListWithType[attributesCount].AdditionalMetadata.ParentPicklistLogicalName;
                            attributeDependentOptionSetProperties.childPicklistLogicalNames = attributesListWithType[attributesCount].AdditionalMetadata.ChildPicklistLogicalNames;
                            attributeDependentOptionSetMappings[attributesListWithType[attributesCount].LogicalName] = attributeDependentOptionSetProperties;
                        }
                    }
                    var attributeMetadataJson = [];
                    ProcessDesigner.ProcessDesignerControl.dataBag.resources.getStepAttributeListMetadata(entityLogicalName, function (attributesList) {
                        if (!ProcessDesigner.Util.isNull(attributesList)) {
                            attributesList = attributesList.Fields;
                            for (var i = 0; i < attributesList.length; i++) {
                                var attributeData = attributesList[i];
                                var attributeType = attributeTypeMapping[attributeData.LogicalName];
                                var parentPicklistLogicalName = attributeType == ProcessDesigner.AttributeType.Picklist ? attributeDependentOptionSetMappings[attributeData.LogicalName].parentPicklistLogicalName : "";
                                var childPicklistLogicalNames = attributeType == ProcessDesigner.AttributeType.Picklist ? attributeDependentOptionSetMappings[attributeData.LogicalName].childPicklistLogicalNames : null;
                                if (CommonTypes.Types.Object.isNullOrUndefined(attributeType) || _this.verifyAttributeType(attributeType)) {
                                    var logicalName = attributeData.LogicalName;
                                    var displayName = attributeData.Label.Description;
                                    attributeMetadataJson.push({
                                        logicalName: logicalName,
                                        displayName: displayName,
                                        isSystemControl: false,
                                        attributeType: attributeType,
                                        parentPicklistLogicalName: parentPicklistLogicalName,
                                        childPicklistLogicalNames: CommonTypes.Types.Object.isNullOrUndefined(childPicklistLogicalNames) ? childPicklistLogicalNames : childPicklistLogicalNames.join(", ")
                                    });
                                }
                            }
                            attributeMetadataJson = attributeMetadataJson.sort(function (a, b) { return (a.displayName < b.displayName ? -1 : 1); });
                            var systemControlsList = ProcessDesigner.ProcessDesignerControl.dataBag.resources.getSystemControlAttributeMetadataModel(entityLogicalName);
                            if (!ProcessDesigner.Util.isNull(systemControlsList)) {
                                for (var i = 0; i < systemControlsList.length; i++) {
                                    attributeMetadataJson.unshift({
                                        logicalName: systemControlsList[i].get_logicalName(),
                                        displayName: systemControlsList[i].get_displayText(),
                                        isSystemControl: true
                                    });
                                }
                            }
                        }
                        success(attributeMetadataJson);
                    }, failure);
                }, failure);
            };
            MetadataProvider.getAttributeMetadata = function (entityLogicalName, success, failure) {
                var _this = this;
                if (entityLogicalName == "") {
                    return [];
                }
                ProcessDesigner.ProcessDesignerControl.dataBag.resources.getAttributeListMetadata(entityLogicalName, function (attributesList) {
                    if (entityLogicalName == "") {
                        return [];
                    }
                    if (attributesList == null || attributesList == undefined) {
                        console.log("Error:attributeMetadataList.childNodes[0].textContent is null File:MetadataProvider.ts Method:getAttributeMetadata()");
                        return;
                    }
                    var attributeMetadataJson = [];
                    for (var i = 0; i < attributesList.length; i++) {
                        var attributeData = attributesList[i];
                        if (_this.verifyAttributeType(attributeData.Type)) {
                            var logicalName = attributeData.LogicalName;
                            var displayName = attributeData.Label.Description;
                            var attributeType = attributeData.Type;
                            var attributeFormat = attributeData.AdditionalMetadata.Format;
                            var maxLength = attributeData.AdditionalMetadata.MaxLength;
                            var maxValue = attributeData.AdditionalMetadata.MaxValue;
                            var minValue = attributeData.AdditionalMetadata.MinValue;
                            var precision = attributeData.AdditionalMetadata.Precision;
                            if (displayName) {
                                if (attributeType === ProcessDesigner.AttributeType.DateTime) {
                                    attributeMetadataJson.push({
                                        logicalName: logicalName,
                                        displayName: displayName,
                                        attributeType: attributeType,
                                        dateFormat: attributeFormat
                                    });
                                }
                                else if (attributeType === ProcessDesigner.AttributeType.Lookup || attributeType === ProcessDesigner.AttributeType.Owner || attributeType === ProcessDesigner.AttributeType.Customer) {
                                    var targetEntityLookupTypeNames = attributeData.AdditionalMetadata.LookupTypeNames;
                                    var lookupTypeNameStrings = targetEntityLookupTypeNames.split(",");
                                    var targetEntityForLookUp = [];
                                    var lookupTypes = attributeData.AdditionalMetadata.LookupTypes;
                                    for (var lookupTypeName in lookupTypeNameStrings) {
                                        var lookupStrings = lookupTypeNameStrings[lookupTypeName].split(":");
                                        var targetEntity = lookupStrings[0];
                                        targetEntityForLookUp.push(targetEntity);
                                    }
                                    attributeMetadataJson.push({
                                        logicalName: logicalName,
                                        displayName: displayName,
                                        attributeType: attributeType,
                                        targetEntityForLookUp: targetEntityForLookUp,
                                        lookupTypes: lookupTypes
                                    });
                                }
                                else {
                                    attributeMetadataJson.push({
                                        logicalName: logicalName,
                                        displayName: displayName,
                                        attributeType: attributeType,
                                        maxLength: maxLength,
                                        maxValue: maxValue,
                                        minValue: minValue,
                                        precision: precision
                                    });
                                }
                            }
                        }
                    }
                    attributeMetadataJson = attributeMetadataJson.sort(function (a, b) { return (a.displayName < b.displayName ? -1 : 1); });
                    success(attributeMetadataJson);
                }, failure);
            };
            MetadataProvider.verifyAttributeType = function (attributeTypeValue) {
                var attributeType = MscrmControls.ProcessDesigner.AttributeType[attributeTypeValue];
                if (!CommonTypes.Types.Object.isNullOrUndefined(attributeType)) {
                    return true;
                }
                return false;
            };
            MetadataProvider.getOperators = function (entityLogicalName, attributeLogicalName, success, fail) {
                ProcessDesigner.ProcessDesignerControl.dataBag.resources.getAttributeListMetadata(entityLogicalName, function (attributeMetadataListXmlNode) {
                    var attributeType = MetadataProvider.getAttributeType(attributeMetadataListXmlNode, attributeLogicalName);
                    var operatorList = MetadataProvider.getOperatorList(attributeType);
                    success(operatorList);
                }, fail);
            };
            MetadataProvider.isFormulaValid = function (entityLogicalName, attributeLogicalName, success, fail) {
                ProcessDesigner.ProcessDesignerControl.dataBag.resources.getAttributeListMetadata(entityLogicalName, function (attributeMetadataListXmlNode) {
                    var attributeType = MetadataProvider.getAttributeType(attributeMetadataListXmlNode, attributeLogicalName);
                    success(MetadataProvider.isFormulaValidForAttributeType(attributeType));
                }, fail);
            };
            MetadataProvider.isFormulaValidForAttributeType = function (attributeType) {
                var isFormulaValid = false;
                switch (attributeType) {
                    case ProcessDesigner.AttributeType.Double:
                    case ProcessDesigner.AttributeType.Integer:
                    case ProcessDesigner.AttributeType.BigInt:
                    case ProcessDesigner.AttributeType.Decimal:
                    case ProcessDesigner.AttributeType.DateTime:
                    case ProcessDesigner.AttributeType.Money:
                        isFormulaValid = true;
                        break;
                }
                return isFormulaValid;
            };
            MetadataProvider.isUnaryOperator = function (operatorName) {
                var unaryOperatorsList = MetadataProvider.getUnaryOperatorList();
                var isUnaryOperator = false;
                for (var i = 0; i < unaryOperatorsList.length; i++) {
                    if (unaryOperatorsList[i] === operatorName) {
                        isUnaryOperator = true;
                        break;
                    }
                }
                return isUnaryOperator;
            };
            MetadataProvider.isUnaryOperatorByValue = function (operatorValue) {
                var unaryOperatorsList = MetadataProvider.getUnaryOperatorValueList();
                var isUnaryOperator = false;
                for (var i = 0; i < unaryOperatorsList.length; i++) {
                    if (unaryOperatorsList[i].toString() == operatorValue) {
                        isUnaryOperator = true;
                        break;
                    }
                }
                return isUnaryOperator;
            };
            MetadataProvider.getPickListValues = function (entityLogicalName, attributeLogicalNames, success, fail) {
                ProcessDesigner.ProcessDesignerControl.dataBag.resources.getAttributePickListMetadata(entityLogicalName, attributeLogicalNames, function (optionSetList) {
                    var pickListValuesJson = [];
                    for (var i = 0; i < optionSetList.length; i++) {
                        var value = optionSetList[i];
                        var pickListOptionValue = value.Label;
                        var pickListOptionOrder = value.Value;
                        if (pickListOptionValue) {
                            pickListValuesJson.push({
                                pickListValueOrderId: pickListOptionOrder,
                                pickListValue: pickListOptionValue
                            });
                        }
                    }
                    success(pickListValuesJson);
                }, fail);
            };
            MetadataProvider.getAttributeType = function (attributesList, attributeLogicalName) {
                var attributeType;
                if (attributeLogicalName == "") {
                    return null;
                }
                if (attributesList == null || attributesList == undefined) {
                    console.log("Error:attributeMetadataList.childNodes[0].textContent is null File:MetadataProvider.ts Method:getAttributeMetadata()");
                    return;
                }
                var attributeMetadataJson = [];
                for (var i = 0; i < attributesList.length; i++) {
                    var attributeData = attributesList[i];
                    var logicalName = attributeData.LogicalName;
                    if (logicalName === attributeLogicalName) {
                        attributeType = attributeData.Type;
                        break;
                    }
                }
                return attributeType;
            };
            MetadataProvider.getUnaryOperatorList = function () {
                if (this.unaryOperatorList.length === 0) {
                    this.unaryOperatorList = [
                        ProcessDesigner.ConditionOperator.DoesNotContainData,
                        ProcessDesigner.ConditionOperator.ContainsData,
                        ProcessDesigner.ConditionOperator.Yesterday,
                        ProcessDesigner.ConditionOperator.Today,
                        ProcessDesigner.ConditionOperator.Tomorrow,
                        ProcessDesigner.ConditionOperator.NextSevenDays,
                        ProcessDesigner.ConditionOperator.LastSevenDays,
                        ProcessDesigner.ConditionOperator.NextWeek,
                        ProcessDesigner.ConditionOperator.LastWeek,
                        ProcessDesigner.ConditionOperator.ThisWeek,
                        ProcessDesigner.ConditionOperator.NextMonth,
                        ProcessDesigner.ConditionOperator.LastMonth,
                        ProcessDesigner.ConditionOperator.ThisMonth,
                        ProcessDesigner.ConditionOperator.NextYear,
                        ProcessDesigner.ConditionOperator.LastYear,
                        ProcessDesigner.ConditionOperator.ThisYear,
                        ProcessDesigner.ConditionOperator.Anytime
                    ];
                }
                return this.unaryOperatorList;
            };
            MetadataProvider.getUnaryOperatorValueList = function () {
                var unaryOperatorList = [
                    ProcessDesigner.ConditionOperator.DoesNotContainData, ProcessDesigner.ConditionOperator.ContainsData,
                    ProcessDesigner.ConditionOperator.Yesterday, ProcessDesigner.ConditionOperator.Today,
                    ProcessDesigner.ConditionOperator.Tomorrow, ProcessDesigner.ConditionOperator.NextSevenDays,
                    ProcessDesigner.ConditionOperator.LastSevenDays, ProcessDesigner.ConditionOperator.NextWeek,
                    ProcessDesigner.ConditionOperator.LastWeek, ProcessDesigner.ConditionOperator.ThisWeek,
                    ProcessDesigner.ConditionOperator.NextMonth, ProcessDesigner.ConditionOperator.LastMonth,
                    ProcessDesigner.ConditionOperator.ThisMonth, ProcessDesigner.ConditionOperator.NextYear,
                    ProcessDesigner.ConditionOperator.LastYear, ProcessDesigner.ConditionOperator.ThisYear,
                    ProcessDesigner.ConditionOperator.Anytime];
                return unaryOperatorList;
            };
            MetadataProvider.getOperatorList = function (attributeType) {
                var operatorList = [];
                switch (attributeType) {
                    case ProcessDesigner.AttributeType.Boolean:
                        operatorList = [{ name: MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_ConditionOperator_Equal"), value: 6 },
                            { name: MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_ConditionOperator_NotEqual"), value: 7 }
                        ];
                        break;
                    case ProcessDesigner.AttributeType.String:
                    case ProcessDesigner.AttributeType.Lookup:
                    case ProcessDesigner.AttributeType.Owner:
                    case ProcessDesigner.AttributeType.Customer:
                    case ProcessDesigner.AttributeType.State:
                    case ProcessDesigner.AttributeType.Status:
                        operatorList =
                            [{ name: MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_ConditionOperator_Equal"), value: 6 },
                                { name: MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_ConditionOperator_NotEqual"), value: 7 },
                                { name: MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_ConditionOperator_Contains"), value: 8 },
                                { name: MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_ConditionOperator_DoesNotContain"), value: 9 },
                                { name: MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_ConditionOperator_BeginsWith"), value: 10 },
                                { name: MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_ConditionOperator_DoesNotBeginWith"), value: 11 },
                                { name: MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_ConditionOperator_EndsWith"), value: 12 },
                                { name: MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_ConditionOperator_DoesNotEndWith"), value: 13 },
                                { name: MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_ConditionOperator_DoesNotContainData"), value: 0 },
                                { name: MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_ConditionOperator_ContainsData"), value: 1 }
                            ];
                        break;
                    case ProcessDesigner.AttributeType.Picklist:
                        operatorList =
                            [{ name: MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_ConditionOperator_Equal"), value: 6 },
                                { name: MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_ConditionOperator_NotEqual"), value: 7 },
                                { name: MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_ConditionOperator_DoesNotContainData"), value: 0 },
                                { name: MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_ConditionOperator_ContainsData"), value: 1 }
                            ];
                        break;
                    case ProcessDesigner.AttributeType.Money:
                        operatorList =
                            [{ name: MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_ConditionOperator_Equal"), value: 6 },
                                { name: MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_ConditionOperator_NotEqual"), value: 7 },
                                { name: MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_ConditionOperator_GreaterThan"), value: 14 },
                                { name: MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_ConditionOperator_GreaterThanOrEqual"), value: 15 },
                                { name: MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_ConditionOperator_LessThan"), value: 16 },
                                { name: MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_ConditionOperator_LessThanOrEqual"), value: 17 },
                                { name: MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_ConditionOperator_DoesNotContainData"), value: 0 },
                                { name: MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_ConditionOperator_ContainsData"), value: 1 }
                            ];
                        break;
                    case ProcessDesigner.AttributeType.DateTime:
                        operatorList =
                            [{ name: MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_ConditionOperator_Equal"), value: 6 },
                                { name: MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_ConditionOperator_NotEqual"), value: 7 },
                                { name: MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_ConditionOperator_GreaterThan"), value: 14 },
                                { name: MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_ConditionOperator_GreaterThanOrEqual"), value: 15 },
                                { name: MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_ConditionOperator_LessThan"), value: 16 },
                                { name: MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_ConditionOperator_LessThanOrEqual"), value: 17 },
                                { name: MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_ConditionOperator_On"), value: 20 },
                                { name: MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_ConditionOperator_NotOn"), value: 21 },
                                { name: MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_ConditionOperator_DoesNotContainData"), value: 0 },
                                { name: MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_ConditionOperator_ContainsData"), value: 1 }
                            ];
                        break;
                    case ProcessDesigner.AttributeType.Integer:
                        operatorList =
                            [{ name: MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_ConditionOperator_Equal"), value: 6 },
                                { name: MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_ConditionOperator_NotEqual"), value: 7 },
                                { name: MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_ConditionOperator_GreaterThan"), value: 14 },
                                { name: MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_ConditionOperator_GreaterThanOrEqual"), value: 15 },
                                { name: MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_ConditionOperator_LessThan"), value: 16 },
                                { name: MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_ConditionOperator_LessThanOrEqual"), value: 17 },
                                { name: MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_ConditionOperator_DoesNotContainData"), value: 0 },
                                { name: MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_ConditionOperator_ContainsData"), value: 1 }
                            ];
                        break;
                    case ProcessDesigner.AttributeType.BigInt:
                        operatorList =
                            [{ name: MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_ConditionOperator_Equal"), value: 6 },
                                { name: MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_ConditionOperator_NotEqual"), value: 7 },
                                { name: MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_ConditionOperator_GreaterThan"), value: 14 },
                                { name: MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_ConditionOperator_GreaterThanOrEqual"), value: 15 },
                                { name: MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_ConditionOperator_LessThan"), value: 16 },
                                { name: MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_ConditionOperator_LessThanOrEqual"), value: 17 },
                                { name: MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_ConditionOperator_DoesNotContainData"), value: 0 },
                                { name: MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_ConditionOperator_ContainsData"), value: 1 }
                            ];
                        break;
                    case ProcessDesigner.AttributeType.Decimal:
                        operatorList =
                            [{ name: MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_ConditionOperator_Equal"), value: 6 },
                                { name: MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_ConditionOperator_NotEqual"), value: 7 },
                                { name: MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_ConditionOperator_GreaterThan"), value: 14 },
                                { name: MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_ConditionOperator_GreaterThanOrEqual"), value: 15 },
                                { name: MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_ConditionOperator_LessThan"), value: 16 },
                                { name: MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_ConditionOperator_LessThanOrEqual"), value: 17 },
                                { name: MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_ConditionOperator_DoesNotContainData"), value: 0 },
                                { name: MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_ConditionOperator_ContainsData"), value: 1 }
                            ];
                        break;
                    case ProcessDesigner.AttributeType.Double:
                        operatorList =
                            [{ name: MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_ConditionOperator_Equal"), value: 6 },
                                { name: MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_ConditionOperator_NotEqual"), value: 7 },
                                { name: MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_ConditionOperator_GreaterThan"), value: 14 },
                                { name: MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_ConditionOperator_GreaterThanOrEqual"), value: 15 },
                                { name: MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_ConditionOperator_LessThan"), value: 16 },
                                { name: MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_ConditionOperator_LessThanOrEqual"), value: 17 },
                                { name: MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_ConditionOperator_DoesNotContainData"), value: 0 },
                                { name: MetadataProvider.getLocalizedString("ProcessDesignerControl_BPF_ConditionOperator_ContainsData"), value: 1 }
                            ];
                        break;
                }
                return operatorList;
            };
            MetadataProvider.getRelationshipMetadata = function (referencedEntityName, referencingEntityName, success, failure) {
                ProcessDesigner.ProcessDesignerControl.dataBag.resources.getRelationshipMetadata(referencedEntityName, function (metadataArray) {
                    if (metadataArray == null || metadataArray == undefined) {
                        console.log("Error:metadataArray[0].d is null File:MetadataProvider.ts Method:getRelationshipMetadata()");
                        return;
                    }
                    var relationshipMetadataJson = [];
                    var jsonRelationshipMetadata = metadataArray.get_items();
                    for (var i = 0; i < jsonRelationshipMetadata.length; i++) {
                        var relationshipMetadata = jsonRelationshipMetadata[i];
                        var relationshipName = relationshipMetadata.get_relationshipName();
                        var attributeLabel = relationshipMetadata.get_attributeDisplayName();
                        var attributeName = relationshipMetadata.get_attributeLogicalName();
                        var referencingEntityLogicalName = relationshipMetadata.get_targetStageEntityLogicalName();
                        if (referencingEntityName === referencingEntityLogicalName) {
                            relationshipMetadataJson.push({
                                logicalName: relationshipName,
                                displayName: attributeLabel,
                                attributeName: attributeName
                            });
                        }
                    }
                    relationshipMetadataJson = relationshipMetadataJson.sort(function (a, b) { return (a.displayName < b.displayName ? -1 : 1); });
                    success(relationshipMetadataJson);
                }, failure);
            };
            MetadataProvider.getLoadedRelationshipEntityMetadata = function () {
                return ProcessDesigner.ProcessDesignerControl.dataBag.resources.getLoadedRelationshipEntityMetadata();
            };
            MetadataProvider.getLocalizedString = function (inputString) {
                return ProcessDesigner.ProcessDesignerControl.dataBag.resources.getString(inputString);
            };
            MetadataProvider.unaryOperatorList = [];
            return MetadataProvider;
        })();
        ProcessDesigner.MetadataProvider = MetadataProvider;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// -----------------------------------------------------------------------
// <copyright file="StringUtility.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        'use strict';
        var StringUtility = (function () {
            function StringUtility() {
            }
            StringUtility.RemoveSpaces = function (stringWithSpaces) {
                return stringWithSpaces.replace(/\s+/g, '');
                ;
            };
            return StringUtility;
        })();
        ProcessDesigner.StringUtility = StringUtility;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// ---------------------------------------------------------------------------
// <copyright file="ProcessDesignerLaunchedEvent.ts" company="Microsoft">
//     Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// ---------------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        var TelemetryEvent = _Microsoft.Client.Telemetry.TelemetryEvent;
        var Utility = _Microsoft.Client.Telemetry.Utility;
        ProcessDesigner.ProcessDesignerLaunchedEventName = "ProcessDesignerLaunched";
        var ProcessDesignerLaunchedEvent = (function (_super) {
            __extends(ProcessDesignerLaunchedEvent, _super);
            function ProcessDesignerLaunchedEvent() {
                _super.call(this, null, ProcessDesigner.ProcessDesignerLaunchedEventName);
            }
            ProcessDesignerLaunchedEvent.prototype.SetLaunchInfo = function (processId, sessionId, processType, state, originCrmClient, launchedFrom, immediateLaunchedFrom, parentSessionId, elapsedTimeInMS, errorDetails, errorCount) {
                this.AddEventParameter(ProcessDesignerLaunchedParameters.processId, processId);
                this.AddEventParameter(ProcessDesignerLaunchedParameters.sessionId, sessionId);
                this.AddEventParameter(ProcessDesignerLaunchedParameters.processType, processType);
                this.AddEventParameter(ProcessDesignerLaunchedParameters.state, state);
                this.AddEventParameter(ProcessDesignerLaunchedParameters.originCrmClient, originCrmClient);
                this.AddEventParameter(ProcessDesignerLaunchedParameters.launchedFrom, launchedFrom);
                this.AddEventParameter(ProcessDesignerLaunchedParameters.immediatelaunchedFrom, immediateLaunchedFrom);
                this.AddEventParameter(ProcessDesignerLaunchedParameters.parentSessionId, parentSessionId);
                this.AddEventParameter(ProcessDesignerLaunchedParameters.timeCreated, Utility.GetTimeStamp());
                this.AddEventParameter(ProcessDesignerLaunchedParameters.elapsedTimeInMS, elapsedTimeInMS);
                this.AddEventParameter(ProcessDesignerLaunchedParameters.errorDetails, errorDetails);
                this.AddEventParameter(ProcessDesignerLaunchedParameters.errorCount, errorCount);
            };
            ProcessDesignerLaunchedEvent.prototype.SetEnvInfo = function (formFactor, userAgent, locale, languageCode) {
                this.AddEventParameter(ProcessDesignerLaunchedParameters.formFactor, formFactor);
                this.AddEventParameter(ProcessDesignerLaunchedParameters.userAgent, userAgent);
                this.AddEventParameter(ProcessDesignerLaunchedParameters.locale, locale);
                this.AddEventParameter(ProcessDesignerLaunchedParameters.languageCode, languageCode);
            };
            ProcessDesignerLaunchedEvent.prototype.SetUserAndOrgInfo = function (userId, userRole, organizationId) {
                this.AddEventParameter(ProcessDesignerLaunchedParameters.userId, userId);
                this.AddEventParameter(ProcessDesignerLaunchedParameters.userRole, userRole);
            };
            return ProcessDesignerLaunchedEvent;
        })(TelemetryEvent);
        ProcessDesigner.ProcessDesignerLaunchedEvent = ProcessDesignerLaunchedEvent;
        var ProcessDesignerLaunchedParameters = (function () {
            function ProcessDesignerLaunchedParameters() {
            }
            ProcessDesignerLaunchedParameters.processId = "ProcessId";
            ProcessDesignerLaunchedParameters.sessionId = "SessionId";
            ProcessDesignerLaunchedParameters.processType = "ProcessType";
            ProcessDesignerLaunchedParameters.state = "State";
            ProcessDesignerLaunchedParameters.originCrmClient = "OriginCrmClient";
            ProcessDesignerLaunchedParameters.timeCreated = "TimeCreated";
            ProcessDesignerLaunchedParameters.elapsedTimeInMS = "ElapsedTimeInMilliSeconds";
            ProcessDesignerLaunchedParameters.errorDetails = "ErrorDetails";
            ProcessDesignerLaunchedParameters.errorCount = "ErrorCount";
            ProcessDesignerLaunchedParameters.launchedFrom = "LaunchedFrom";
            ProcessDesignerLaunchedParameters.immediatelaunchedFrom = "ImmediateLaunchedFrom";
            ProcessDesignerLaunchedParameters.parentSessionId = "ParentSessionId";
            ProcessDesignerLaunchedParameters.userId = "UserId";
            ProcessDesignerLaunchedParameters.userRole = "UserRole";
            ProcessDesignerLaunchedParameters.formFactor = "FormFactor";
            ProcessDesignerLaunchedParameters.userAgent = "UserAgent";
            ProcessDesignerLaunchedParameters.locale = "Locale";
            ProcessDesignerLaunchedParameters.languageCode = "LanguageCode";
            return ProcessDesignerLaunchedParameters;
        })();
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// ---------------------------------------------------------------------------
// <copyright file="ProcessDesignerTileDetailsViewedEvent.ts" company="Microsoft">
//     Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// ---------------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        var TelemetryEvent = _Microsoft.Client.Telemetry.TelemetryEvent;
        var Utility = _Microsoft.Client.Telemetry.Utility;
        ProcessDesigner.ProcessDesignerTileDetailsViewedEventName = "ProcessDesignerTileDetailsViewed";
        var ProcessDesignerTileDetailsViewedEvent = (function (_super) {
            __extends(ProcessDesignerTileDetailsViewedEvent, _super);
            function ProcessDesignerTileDetailsViewedEvent() {
                _super.call(this, null, ProcessDesigner.ProcessDesignerTileDetailsViewedEventName);
            }
            ProcessDesignerTileDetailsViewedEvent.prototype.SetInfo = function (processId, sessionId, state, tileId, tileType, parentTileId) {
                this.AddEventParameter(ProcessDesignerTileDetailsViewedParameters.processId, processId);
                this.AddEventParameter(ProcessDesignerTileDetailsViewedParameters.sessionId, sessionId);
                this.AddEventParameter(ProcessDesignerTileDetailsViewedParameters.state, state);
                this.AddEventParameter(ProcessDesignerTileDetailsViewedParameters.tileId, tileId);
                this.AddEventParameter(ProcessDesignerTileDetailsViewedParameters.tileType, tileType);
                this.AddEventParameter(ProcessDesignerTileDetailsViewedParameters.parentTileId, parentTileId);
                this.AddEventParameter(ProcessDesignerTileDetailsViewedParameters.timestamp, Utility.GetTimeStamp());
            };
            return ProcessDesignerTileDetailsViewedEvent;
        })(TelemetryEvent);
        ProcessDesigner.ProcessDesignerTileDetailsViewedEvent = ProcessDesignerTileDetailsViewedEvent;
        var ProcessDesignerTileDetailsViewedParameters = (function () {
            function ProcessDesignerTileDetailsViewedParameters() {
            }
            ProcessDesignerTileDetailsViewedParameters.processId = "ProcessId";
            ProcessDesignerTileDetailsViewedParameters.sessionId = "SessionId";
            ProcessDesignerTileDetailsViewedParameters.state = "State";
            ProcessDesignerTileDetailsViewedParameters.tileId = "TileId";
            ProcessDesignerTileDetailsViewedParameters.tileType = "Type";
            ProcessDesignerTileDetailsViewedParameters.parentTileId = "ParentTileId";
            ProcessDesignerTileDetailsViewedParameters.timestamp = "Timestamp";
            return ProcessDesignerTileDetailsViewedParameters;
        })();
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// ---------------------------------------------------------------------------
// <copyright file="ProcessDesignerTileAddedEvent.ts" company="Microsoft">
//     Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// ---------------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        var TelemetryEvent = _Microsoft.Client.Telemetry.TelemetryEvent;
        var Utility = _Microsoft.Client.Telemetry.Utility;
        ProcessDesigner.ProcessDesignerTileAddedEventName = "ProcessDesignerTileAdded";
        var ProcessDesignerTileAddedEvent = (function (_super) {
            __extends(ProcessDesignerTileAddedEvent, _super);
            function ProcessDesignerTileAddedEvent() {
                _super.call(this, null, ProcessDesigner.ProcessDesignerTileAddedEventName);
            }
            ProcessDesignerTileAddedEvent.prototype.SetInfo = function (processId, sessionId, state, addMethod, tileId, tileType, parentTileId) {
                this.AddEventParameter(ProcessDesignerTileAddedParameters.processId, processId);
                this.AddEventParameter(ProcessDesignerTileAddedParameters.sessionId, sessionId);
                this.AddEventParameter(ProcessDesignerTileAddedParameters.state, state);
                this.AddEventParameter(ProcessDesignerTileAddedParameters.addMethod, addMethod);
                this.AddEventParameter(ProcessDesignerTileAddedParameters.tileId, tileId);
                this.AddEventParameter(ProcessDesignerTileAddedParameters.tileType, tileType);
                this.AddEventParameter(ProcessDesignerTileAddedParameters.parentTileId, parentTileId);
                this.AddEventParameter(ProcessDesignerTileAddedParameters.timestamp, Utility.GetTimeStamp());
            };
            return ProcessDesignerTileAddedEvent;
        })(TelemetryEvent);
        ProcessDesigner.ProcessDesignerTileAddedEvent = ProcessDesignerTileAddedEvent;
        var ProcessDesignerTileAddedParameters = (function () {
            function ProcessDesignerTileAddedParameters() {
            }
            ProcessDesignerTileAddedParameters.processId = "ProcessId";
            ProcessDesignerTileAddedParameters.sessionId = "SessionId";
            ProcessDesignerTileAddedParameters.state = "State";
            ProcessDesignerTileAddedParameters.addMethod = "AddMethod";
            ProcessDesignerTileAddedParameters.tileId = "TileId";
            ProcessDesignerTileAddedParameters.tileType = "Type";
            ProcessDesignerTileAddedParameters.parentTileId = "ParentTileId";
            ProcessDesignerTileAddedParameters.timestamp = "Timestamp";
            return ProcessDesignerTileAddedParameters;
        })();
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// ---------------------------------------------------------------------------
// <copyright file="ProcessDesignerTileRemovedEvent.ts" company="Microsoft">
//     Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// ---------------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        var TelemetryEvent = _Microsoft.Client.Telemetry.TelemetryEvent;
        var Utility = _Microsoft.Client.Telemetry.Utility;
        ProcessDesigner.ProcessDesignerTileRemovedEventName = "ProcessDesignerTileRemoved";
        var ProcessDesignerTileRemovedEvent = (function (_super) {
            __extends(ProcessDesignerTileRemovedEvent, _super);
            function ProcessDesignerTileRemovedEvent() {
                _super.call(this, null, ProcessDesigner.ProcessDesignerTileRemovedEventName);
            }
            ProcessDesignerTileRemovedEvent.prototype.SetInfo = function (processId, sessionId, state, tileId, tileType, parentTileId) {
                this.AddEventParameter(ProcessDesignerTileRemovedParameters.processId, processId);
                this.AddEventParameter(ProcessDesignerTileRemovedParameters.sessionId, sessionId);
                this.AddEventParameter(ProcessDesignerTileRemovedParameters.state, state);
                this.AddEventParameter(ProcessDesignerTileRemovedParameters.tileId, tileId);
                this.AddEventParameter(ProcessDesignerTileRemovedParameters.tileType, tileType);
                this.AddEventParameter(ProcessDesignerTileRemovedParameters.parentTileId, parentTileId);
                this.AddEventParameter(ProcessDesignerTileRemovedParameters.timestamp, Utility.GetTimeStamp());
            };
            return ProcessDesignerTileRemovedEvent;
        })(TelemetryEvent);
        ProcessDesigner.ProcessDesignerTileRemovedEvent = ProcessDesignerTileRemovedEvent;
        var ProcessDesignerTileRemovedParameters = (function () {
            function ProcessDesignerTileRemovedParameters() {
            }
            ProcessDesignerTileRemovedParameters.processId = "ProcessId";
            ProcessDesignerTileRemovedParameters.sessionId = "SessionId";
            ProcessDesignerTileRemovedParameters.state = "State";
            ProcessDesignerTileRemovedParameters.tileId = "TileId";
            ProcessDesignerTileRemovedParameters.tileType = "Type";
            ProcessDesignerTileRemovedParameters.parentTileId = "ParentTileId";
            ProcessDesignerTileRemovedParameters.timestamp = "Timestamp";
            return ProcessDesignerTileRemovedParameters;
        })();
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// ---------------------------------------------------------------------------
// <copyright file="ProcessDesignerTileReorderedEvent.ts" company="Microsoft">
//     Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// ---------------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        var TelemetryEvent = _Microsoft.Client.Telemetry.TelemetryEvent;
        var Utility = _Microsoft.Client.Telemetry.Utility;
        ProcessDesigner.ProcessDesignerTileReorderedEventName = "ProcessDesignerTileReordered";
        var ProcessDesignerTileReorderedEvent = (function (_super) {
            __extends(ProcessDesignerTileReorderedEvent, _super);
            function ProcessDesignerTileReorderedEvent() {
                _super.call(this, null, ProcessDesigner.ProcessDesignerTileReorderedEventName);
            }
            ProcessDesignerTileReorderedEvent.prototype.SetInfo = function (processId, sessionId, state, tileId, tileType, parentTileId, reorderMethod) {
                this.AddEventParameter(ProcessDesignerTileReorderedParameters.processId, processId);
                this.AddEventParameter(ProcessDesignerTileReorderedParameters.sessionId, sessionId);
                this.AddEventParameter(ProcessDesignerTileReorderedParameters.state, state);
                this.AddEventParameter(ProcessDesignerTileReorderedParameters.tileId, tileId);
                this.AddEventParameter(ProcessDesignerTileReorderedParameters.tileType, tileType);
                this.AddEventParameter(ProcessDesignerTileReorderedParameters.parentTileId, parentTileId);
                this.AddEventParameter(ProcessDesignerTileReorderedParameters.reorderMethod, reorderMethod);
                this.AddEventParameter(ProcessDesignerTileReorderedParameters.timestamp, Utility.GetTimeStamp());
            };
            return ProcessDesignerTileReorderedEvent;
        })(TelemetryEvent);
        ProcessDesigner.ProcessDesignerTileReorderedEvent = ProcessDesignerTileReorderedEvent;
        var ProcessDesignerTileReorderedParameters = (function () {
            function ProcessDesignerTileReorderedParameters() {
            }
            ProcessDesignerTileReorderedParameters.processId = "ProcessId";
            ProcessDesignerTileReorderedParameters.sessionId = "SessionId";
            ProcessDesignerTileReorderedParameters.state = "State";
            ProcessDesignerTileReorderedParameters.tileId = "TileId";
            ProcessDesignerTileReorderedParameters.tileType = "Type";
            ProcessDesignerTileReorderedParameters.parentTileId = "ParentTileId";
            ProcessDesignerTileReorderedParameters.timestamp = "Timestamp";
            ProcessDesignerTileReorderedParameters.reorderMethod = "ReorderMethod";
            return ProcessDesignerTileReorderedParameters;
        })();
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// ---------------------------------------------------------------------------
// <copyright file="ProcessDesignerSessionClosedEvent.ts" company="Microsoft">
//     Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// ---------------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        var TelemetryEvent = _Microsoft.Client.Telemetry.TelemetryEvent;
        var Utility = _Microsoft.Client.Telemetry.Utility;
        ProcessDesigner.ProcessDesignerSessionClosedEventName = "ProcessDesignerSessionClosed";
        var ProcessDesignerSessionClosedEvent = (function (_super) {
            __extends(ProcessDesignerSessionClosedEvent, _super);
            function ProcessDesignerSessionClosedEvent() {
                _super.call(this, null, ProcessDesigner.ProcessDesignerSessionClosedEventName);
            }
            ProcessDesignerSessionClosedEvent.prototype.SetInfo = function (processId, processType, sessionId, state, type) {
                this.AddEventParameter(ProcessDesignerSessionClosedParameters.processId, processId);
                this.AddEventParameter(ProcessDesignerSessionClosedParameters.processType, processType);
                this.AddEventParameter(ProcessDesignerSessionClosedParameters.sessionId, sessionId);
                this.AddEventParameter(ProcessDesignerSessionClosedParameters.state, state);
                this.AddEventParameter(ProcessDesignerSessionClosedParameters.type, type);
                this.AddEventParameter(ProcessDesignerSessionClosedParameters.timestamp, Utility.GetTimeStamp());
            };
            ProcessDesignerSessionClosedEvent.prototype.SetUserAndOrgInfo = function (userId, userRole, organizationId) {
                this.AddEventParameter(ProcessDesignerSessionClosedParameters.userId, userId);
                this.AddEventParameter(ProcessDesignerSessionClosedParameters.userRole, userRole);
                this.AddEventParameter(ProcessDesignerSessionClosedParameters.organizationId, organizationId);
            };
            return ProcessDesignerSessionClosedEvent;
        })(TelemetryEvent);
        ProcessDesigner.ProcessDesignerSessionClosedEvent = ProcessDesignerSessionClosedEvent;
        var ProcessDesignerSessionClosedParameters = (function () {
            function ProcessDesignerSessionClosedParameters() {
            }
            ProcessDesignerSessionClosedParameters.processType = "ProcessType";
            ProcessDesignerSessionClosedParameters.processId = "ProcessId";
            ProcessDesignerSessionClosedParameters.sessionId = "SessionId";
            ProcessDesignerSessionClosedParameters.state = "State";
            ProcessDesignerSessionClosedParameters.type = "Type";
            ProcessDesignerSessionClosedParameters.timestamp = "Timestamp";
            ProcessDesignerSessionClosedParameters.userId = "UserId";
            ProcessDesignerSessionClosedParameters.userRole = "UserRole";
            ProcessDesignerSessionClosedParameters.organizationId = "OrganizationId";
            return ProcessDesignerSessionClosedParameters;
        })();
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// -----------------------------------------------------------------------
// <copyright file="TelemetryEventReporter.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
/// <reference path="../../TelemetryEvents/ProcessDesignerLaunchedEvent.ts"/>
/// <reference path="../../TelemetryEvents/ProcessDesignerTileDetailsViewedEvent.ts"/>
/// <reference path="../../TelemetryEvents/ProcessDesignerTileAddedEvent.ts"/>
/// <reference path="../../TelemetryEvents/ProcessDesignerTileRemovedEvent.ts"/>
/// <reference path="../../TelemetryEvents/ProcessDesignerTileReorderedEvent.ts"/>
/// <reference path="../../TelemetryEvents/ProcessDesignerSessionClosedEvent.ts"/>
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        'use strict';
        var TelemetryReporterType = _Microsoft.Client.Telemetry.TelemetryReporterType;
        var TelemetryEventReporter = (function () {
            function TelemetryEventReporter() {
            }
            TelemetryEventReporter.ReportProcessDesignerLaunchEvent = function (context, elapsedTimeInMS, errorDetails, errorCount) {
                try {
                    if (!context) {
                        context = [];
                    }
                    var event = new ProcessDesigner.ProcessDesignerLaunchedEvent();
                    var originCrmClient = "WebClient";
                    var wInstance = ProcessDesigner.WindowUtility.GetTopWindow();
                    if (!CommonTypes.Types.String.isNullOrEmpty(wInstance["Xrm"]["Page"]["context"]["client"]["getClient"]())) {
                        originCrmClient = wInstance["Xrm"]["Page"]["context"]["client"]["getClient"]() + "Client";
                    }
                    var launchedFrom = "EntityForm";
                    if (!CommonTypes.Types.Object.isNullOrUndefined(window["launchPoint"])) {
                        launchedFrom = window["launchPoint"];
                    }
                    var processType = ProcessDesigner.ProcessTypeNames.BusinessProcessFlow;
                    if (context.parameters && context.parameters.StateCode && context.parameters.StatusCode
                        && !CommonTypes.Types.Object.isNullOrUndefined(context.parameters.StateCode.raw)
                        && !CommonTypes.Types.Object.isNullOrUndefined(context.parameters.StatusCode.raw)) {
                        ProcessDesigner.processState = TelemetryEventReporter.getProcessState(context.parameters.StateCode.raw, context.parameters.StatusCode.raw);
                    }
                    var immediateLaunchedFrom = TelemetryEventReporter.getOriginParams();
                    var parentSessionId = "";
                    if (context.preInitialization && context.preInitialization.error) {
                        errorDetails += "\n" + context.preInitialization.error;
                    }
                    event.SetLaunchInfo(ProcessDesigner.ProcessDesignerControl.getProcessId(), ProcessDesigner.sessionId, processType, ProcessDesigner.processState, originCrmClient, launchedFrom, immediateLaunchedFrom, parentSessionId, elapsedTimeInMS, errorDetails, errorCount);
                    if (context.internal) {
                        var userId = context.internal.userId.replace('{', '').replace('}', '');
                        var userRoles = context.internal.userRoles.toString();
                        var organizationId = window.ORG_ID.toString().replace('{', '').replace('}', '');
                        event.SetUserAndOrgInfo(userId, userRoles, organizationId);
                    }
                    try {
                        if (context.client) {
                            var formFactor = context.client.formFactor.toString();
                            var userAgent = context.client.userAgent.getUserAgentName();
                            var locale = context.client.locale;
                            var languageCode = context.client.languageCode;
                            event.SetEnvInfo(formFactor, userAgent, locale, languageCode);
                        }
                    }
                    catch (e) {
                    }
                    finally {
                        event.FinishActivity(TelemetryEventReporter.telemetryReportingType);
                    }
                }
                catch (e) {
                }
            };
            TelemetryEventReporter.getOriginParams = function () {
                var iframeRequestOrigin = window["IFRAME_REQUEST_ORIGIN"];
                if (iframeRequestOrigin && iframeRequestOrigin.trim().length > 0) {
                    return iframeRequestOrigin;
                }
                return "";
            };
            TelemetryEventReporter.getProcessType = function (category) {
                switch (category) {
                    case ProcessDesigner.ProcessType.Workflow:
                        return "Workflow";
                    case ProcessDesigner.ProcessType.Dialog:
                        return "Dialog";
                    case ProcessDesigner.ProcessType.BusinessRule:
                        return "Business Rule";
                    case ProcessDesigner.ProcessType.Action:
                        return "Workflow";
                    case ProcessDesigner.ProcessType.BusinessProcessFlow:
                        return "Business Process Flow";
                    default:
                        return "";
                }
            };
            TelemetryEventReporter.getLinkType = function (category) {
                switch (category) {
                    case ProcessDesigner.LinkType.PBLLink:
                        return "PBLLink";
                    case ProcessDesigner.LinkType.BPFEntitylink:
                        return "BPFEntitylink";
                    default:
                        return "";
                }
            };
            TelemetryEventReporter.getProcessState = function (state, statusCode) {
                if (state == 0 && statusCode == 1) {
                    return ProcessDesigner.TelemetryConstants.processStateDraft;
                }
                else if (state == 1 && statusCode == 2) {
                    return ProcessDesigner.TelemetryConstants.processStateActive;
                }
                else {
                    return "";
                }
            };
            TelemetryEventReporter.getOrgId = function () {
                return window.ORG_ID.toString().replace('{', '').replace('}', '');
            };
            TelemetryEventReporter.ReportTileDetailsViewedTelemetryEvent = function (tileId, tileType, parentTileId) {
                var event = new ProcessDesigner.ProcessDesignerTileDetailsViewedEvent();
                event.SetInfo(ProcessDesigner.processId, ProcessDesigner.sessionId, ProcessDesigner.processState, tileId, tileType, parentTileId);
                event.FinishActivity(TelemetryEventReporter.telemetryReportingType);
            };
            TelemetryEventReporter.ReportTileAddedTelemetryEvent = function (addMethod, tileId, tileType, parentTileId) {
                ProcessDesigner.isStructuralChangePerformed = true;
                var event = new ProcessDesigner.ProcessDesignerTileAddedEvent();
                event.SetInfo(ProcessDesigner.processId, ProcessDesigner.sessionId, ProcessDesigner.processState, addMethod, tileId, tileType, parentTileId);
                event.FinishActivity(TelemetryEventReporter.telemetryReportingType);
            };
            TelemetryEventReporter.ReportTileConnectedTelemetryEvent = function (sourceTileId, ifConditionTileId, destinationTileId) {
                ProcessDesigner.isStructuralChangePerformed = true;
                var event = new ProcessDesigner.ConnectOperationPerformedEvent();
                event.SetInfo(ProcessDesigner.processId, ProcessDesigner.sessionId, ProcessDesigner.ProcessTypeNames.BusinessProcessFlow, ProcessDesigner.processState, sourceTileId, ifConditionTileId, destinationTileId);
                event.FinishActivity(TelemetryEventReporter.telemetryReportingType);
            };
            TelemetryEventReporter.ReportTileDisconnectedTelemetryEvent = function (sourceTileId, ifConditionTileId, defaultPathTileId) {
                ProcessDesigner.isStructuralChangePerformed = true;
                var event = new ProcessDesigner.DisconnectOperationPerformedEvent();
                event.SetInfo(ProcessDesigner.processId, ProcessDesigner.sessionId, ProcessDesigner.ProcessTypeNames.BusinessProcessFlow, ProcessDesigner.processState, sourceTileId, ifConditionTileId, defaultPathTileId);
                event.FinishActivity(TelemetryEventReporter.telemetryReportingType);
            };
            TelemetryEventReporter.ReportTileReconnectedTelemetryEvent = function (sourceTileId, ifConditionTileId, oldDefaultPathTileId, newDefaultPathTileId) {
                ProcessDesigner.isStructuralChangePerformed = true;
                var event = new ProcessDesigner.ReconnectOperationPerformedEvent();
                event.SetInfo(ProcessDesigner.processId, ProcessDesigner.sessionId, ProcessDesigner.ProcessTypeNames.BusinessProcessFlow, ProcessDesigner.processState, sourceTileId, ifConditionTileId, oldDefaultPathTileId, newDefaultPathTileId);
                event.FinishActivity(TelemetryEventReporter.telemetryReportingType);
            };
            TelemetryEventReporter.ReportTileRemovedTelemetryEvent = function (tileId, tileType, parentTileId) {
                ProcessDesigner.isStructuralChangePerformed = true;
                var event = new ProcessDesigner.ProcessDesignerTileRemovedEvent();
                event.SetInfo(ProcessDesigner.processId, ProcessDesigner.sessionId, ProcessDesigner.processState, tileId, tileType, parentTileId);
                event.FinishActivity(TelemetryEventReporter.telemetryReportingType);
            };
            TelemetryEventReporter.ReportTileReorderedTelemetryEvent = function (tileId, tileType, parentTileId, reorderMethod) {
                ProcessDesigner.isStructuralChangePerformed = true;
                var event = new ProcessDesigner.ProcessDesignerTileReorderedEvent();
                event.SetInfo(ProcessDesigner.processId, ProcessDesigner.sessionId, ProcessDesigner.processState, tileId, tileType, parentTileId, reorderMethod);
                event.FinishActivity(TelemetryEventReporter.telemetryReportingType);
            };
            TelemetryEventReporter.ReportProcessDesignerCloseEvent = function (context) {
                var event = new ProcessDesigner.ProcessDesignerSessionClosedEvent();
                var sessionType = "";
                if (ProcessDesigner.isStructuralChangePerformed) {
                    sessionType = "Build";
                }
                else if (ProcessDesigner.isPropertyPageSaved) {
                    sessionType = "Refine";
                }
                else {
                    sessionType = "Review";
                }
                event.SetInfo(ProcessDesigner.processId, ProcessDesigner.ProcessTypeNames.BusinessProcessFlow, ProcessDesigner.sessionId, ProcessDesigner.processState, sessionType);
                var userId = context.internal.userId.replace('{', '').replace('}', '');
                var userRoles = context.internal.userRoles.toString();
                var organizationId = window.ORG_ID.toString().replace('{', '').replace('}', '');
                event.SetUserAndOrgInfo(userId, userRoles, organizationId);
                event.FinishActivityImmediately(TelemetryEventReporter.telemetryReportingType);
            };
            TelemetryEventReporter.ReportProcessDesignerActivateEvent = function (elapsedTimeInMS, errorCode, errorDetails, errorCount) {
                var event = new ProcessDesigner.ProcessDesignerActivatedEvent();
                event.SetInfo(ProcessDesigner.processId, ProcessDesigner.sessionId, TelemetryEventReporter.getProcessType(ProcessDesigner.ProcessType.BusinessProcessFlow), ProcessDesigner.processState, TelemetryEventReporter.getOrgId(), elapsedTimeInMS, errorCode, errorDetails, errorCount);
                event.FinishActivity(TelemetryEventReporter.telemetryReportingType);
            };
            TelemetryEventReporter.ReportProcessDesignerDeactivateEvent = function (elapsedTimeInMS, errorCode, errorDetails, errorCount) {
                var event = new ProcessDesigner.ProcessDesigneDeactivatedEvent();
                event.SetInfo(ProcessDesigner.processId, ProcessDesigner.sessionId, TelemetryEventReporter.getProcessType(ProcessDesigner.ProcessType.BusinessProcessFlow), ProcessDesigner.processState, TelemetryEventReporter.getOrgId(), elapsedTimeInMS, errorCode, errorDetails, errorCount);
                event.FinishActivity(TelemetryEventReporter.telemetryReportingType);
            };
            TelemetryEventReporter.ReportProcessDesignerSaveEvent = function (elapsedTimeInMS, errorDetails, errorCount) {
                var event = new ProcessDesigner.ProcessDesignerSavedEvent();
                event.SetInfo(ProcessDesigner.processId, ProcessDesigner.sessionId, TelemetryEventReporter.getProcessType(ProcessDesigner.ProcessType.BusinessProcessFlow), ProcessDesigner.processState, TelemetryEventReporter.getOrgId(), elapsedTimeInMS, errorDetails, errorCount);
                event.FinishActivity(TelemetryEventReporter.telemetryReportingType);
            };
            TelemetryEventReporter.ReportProcessDesignerValidateEvent = function (validatedAt, errorDetails, errorCount) {
                var event = new ProcessDesigner.ProcessDesignerValidatedEvent();
                event.SetInfo(ProcessDesigner.processId, ProcessDesigner.sessionId, ProcessDesigner.processState, validatedAt, errorDetails, errorCount, TelemetryEventReporter.getProcessType(ProcessDesigner.ProcessType.BusinessProcessFlow));
                event.FinishActivity(TelemetryEventReporter.telemetryReportingType);
            };
            TelemetryEventReporter.ReportProcessDesignerPBLlinkClickedEvent = function () {
                var event = new ProcessDesigner.ProcessDesignerLinkClickedEvent();
                event.SetInfo(ProcessDesigner.processId, ProcessDesigner.sessionId, ProcessDesigner.processState, TelemetryEventReporter.getLinkType(ProcessDesigner.LinkType.PBLLink), TelemetryEventReporter.getProcessType(ProcessDesigner.ProcessType.BusinessProcessFlow));
                event.FinishActivity(TelemetryEventReporter.telemetryReportingType);
            };
            TelemetryEventReporter.ReportProcessDesignerBPFEntitylinkClickedEvent = function () {
                var event = new ProcessDesigner.ProcessDesignerLinkClickedEvent();
                event.SetInfo(ProcessDesigner.processId, ProcessDesigner.sessionId, ProcessDesigner.processState, TelemetryEventReporter.getLinkType(ProcessDesigner.LinkType.BPFEntitylink), TelemetryEventReporter.getProcessType(ProcessDesigner.ProcessType.BusinessProcessFlow));
                event.FinishActivity(TelemetryEventReporter.telemetryReportingType);
            };
            TelemetryEventReporter.GetAddModeNameForActivity = function (addMode) {
                var addModeName = "";
                switch (addMode) {
                    case ProcessDesigner.BPFToolBarAddMode.AddStep:
                    case ProcessDesigner.BPFToolBarAddMode.AddActionStep:
                    case ProcessDesigner.BPFToolBarAddMode.AddFlowStep:
                    case ProcessDesigner.BPFToolBarAddMode.AddStage:
                    case ProcessDesigner.BPFToolBarAddMode.AddCondition:
                    case ProcessDesigner.BPFToolBarAddMode.AddWorkflow:
                        addModeName = "Add";
                        break;
                    case ProcessDesigner.BPFToolBarAddMode.PasteStage:
                    case ProcessDesigner.BPFToolBarAddMode.PasteStep:
                    case ProcessDesigner.BPFToolBarAddMode.PasteActionStep:
                    case ProcessDesigner.BPFToolBarAddMode.PasteFlowStep:
                    case ProcessDesigner.BPFToolBarAddMode.PasteBranch:
                    case ProcessDesigner.BPFToolBarAddMode.PasteWorkflow:
                        if (GenericWorkflowDesigner.CutCommand.cutInProgress) {
                            addModeName = "Cut-Paste";
                            break;
                        }
                        addModeName = "Copy-Paste";
                        break;
                    case ProcessDesigner.BPFToolBarAddMode.DropStep:
                    case ProcessDesigner.BPFToolBarAddMode.None:
                    default:
                        addModeName = "Drag-Drop";
                        break;
                }
                return addModeName;
            };
            TelemetryEventReporter.ReportProcessDesignerSmbAddOobBPFSolutionDependencyEvent = function (responseType, statusText, responseText) {
                var event = new ProcessDesigner.ProcessDesignerSolDependencyErrorEvent();
                event.SetInfo(ProcessDesigner.processId, ProcessDesigner.sessionId, TelemetryEventReporter.getProcessType(ProcessDesigner.ProcessType.BusinessProcessFlow), ProcessDesigner.processState, responseType, statusText, responseText);
                event.FinishActivity(TelemetryEventReporter.telemetryReportingType);
            };
            TelemetryEventReporter.telemetryReportingType = TelemetryReporterType.MetricsReportingService;
            return TelemetryEventReporter;
        })();
        ProcessDesigner.TelemetryEventReporter = TelemetryEventReporter;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// -----------------------------------------------------------------------
// <copyright file="TextWriter.ts" company="Microsoft">
//      Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// -----------------------------------------------------------------------
/// <reference path="ITextWriter.ts"/>
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        'use strict';
        var TextWriter = (function () {
            function TextWriter() {
                this.text = "";
            }
            TextWriter.prototype.write = function (value) {
                this.text += value;
            };
            TextWriter.prototype.writeLine = function (value) {
                this.write(value);
                this.write(TextWriter.CoreNewLine);
            };
            TextWriter.prototype.getText = function () {
                return this.text;
            };
            TextWriter.CoreNewLine = "\r\n";
            return TextWriter;
        })();
        ProcessDesigner.TextWriter = TextWriter;
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// ---------------------------------------------------------------------------
// <copyright file="ConnectOperationPerformedEvent.ts" company="Microsoft">
//     Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// ---------------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        var TelemetryEvent = _Microsoft.Client.Telemetry.TelemetryEvent;
        var Utility = _Microsoft.Client.Telemetry.Utility;
        ProcessDesigner.ConnectOperationPerformedEventName = "ProcessDesignerTileConnected";
        var ConnectOperationPerformedEvent = (function (_super) {
            __extends(ConnectOperationPerformedEvent, _super);
            function ConnectOperationPerformedEvent() {
                _super.call(this, null, ProcessDesigner.ConnectOperationPerformedEventName);
            }
            ConnectOperationPerformedEvent.prototype.SetInfo = function (processId, sessionId, processType, state, sourceTileId, ifConditionTileId, destinationTileId) {
                this.AddEventParameter(ConnectOperationPerformedParameters.processId, processId);
                this.AddEventParameter(ConnectOperationPerformedParameters.sessionId, sessionId);
                this.AddEventParameter(ConnectOperationPerformedParameters.processType, processType);
                this.AddEventParameter(ConnectOperationPerformedParameters.state, state);
                this.AddEventParameter(ConnectOperationPerformedParameters.sourceTileId, sourceTileId);
                this.AddEventParameter(ConnectOperationPerformedParameters.ifConditionTileId, ifConditionTileId);
                this.AddEventParameter(ConnectOperationPerformedParameters.destinationTileId, destinationTileId);
                this.AddEventParameter(ConnectOperationPerformedParameters.timestamp, Utility.GetTimeStamp());
            };
            return ConnectOperationPerformedEvent;
        })(TelemetryEvent);
        ProcessDesigner.ConnectOperationPerformedEvent = ConnectOperationPerformedEvent;
        var ConnectOperationPerformedParameters = (function () {
            function ConnectOperationPerformedParameters() {
            }
            ConnectOperationPerformedParameters.processId = "ProcessId";
            ConnectOperationPerformedParameters.sessionId = "SessionId";
            ConnectOperationPerformedParameters.processType = "ProcessType";
            ConnectOperationPerformedParameters.state = "State";
            ConnectOperationPerformedParameters.sourceTileId = "SourceTileId";
            ConnectOperationPerformedParameters.ifConditionTileId = "IfConditionTileId";
            ConnectOperationPerformedParameters.destinationTileId = "DestinationTileId";
            ConnectOperationPerformedParameters.timestamp = "Timestamp";
            return ConnectOperationPerformedParameters;
        })();
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// ---------------------------------------------------------------------------
// <copyright file="DisconnectOperationPerformedEvent.ts" company="Microsoft">
//     Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// ---------------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        var TelemetryEvent = _Microsoft.Client.Telemetry.TelemetryEvent;
        var Utility = _Microsoft.Client.Telemetry.Utility;
        ProcessDesigner.DisconnectOperationPerformedEventName = "ProcessDesignerTileDisconnected";
        var DisconnectOperationPerformedEvent = (function (_super) {
            __extends(DisconnectOperationPerformedEvent, _super);
            function DisconnectOperationPerformedEvent() {
                _super.call(this, null, ProcessDesigner.DisconnectOperationPerformedEventName);
            }
            DisconnectOperationPerformedEvent.prototype.SetInfo = function (processId, sessionId, processType, state, sourceTileId, ifConditionTileId, defaultPathTileId) {
                this.AddEventParameter(DisconnectOperationPerformedParameters.processId, processId);
                this.AddEventParameter(DisconnectOperationPerformedParameters.sessionId, sessionId);
                this.AddEventParameter(DisconnectOperationPerformedParameters.processType, processType);
                this.AddEventParameter(DisconnectOperationPerformedParameters.state, state);
                this.AddEventParameter(DisconnectOperationPerformedParameters.sourceTileId, sourceTileId);
                this.AddEventParameter(DisconnectOperationPerformedParameters.ifConditionTileId, ifConditionTileId);
                this.AddEventParameter(DisconnectOperationPerformedParameters.defaultPathTileId, defaultPathTileId);
                this.AddEventParameter(DisconnectOperationPerformedParameters.timestamp, Utility.GetTimeStamp());
            };
            return DisconnectOperationPerformedEvent;
        })(TelemetryEvent);
        ProcessDesigner.DisconnectOperationPerformedEvent = DisconnectOperationPerformedEvent;
        var DisconnectOperationPerformedParameters = (function () {
            function DisconnectOperationPerformedParameters() {
            }
            DisconnectOperationPerformedParameters.processId = "ProcessId";
            DisconnectOperationPerformedParameters.sessionId = "SessionId";
            DisconnectOperationPerformedParameters.processType = "ProcessType";
            DisconnectOperationPerformedParameters.state = "State";
            DisconnectOperationPerformedParameters.sourceTileId = "SourceTileId";
            DisconnectOperationPerformedParameters.ifConditionTileId = "IfConditionTileId";
            DisconnectOperationPerformedParameters.defaultPathTileId = "DefaultPathTileId";
            DisconnectOperationPerformedParameters.timestamp = "Timestamp";
            return DisconnectOperationPerformedParameters;
        })();
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// ---------------------------------------------------------------------------
// <copyright file="ProcessDesignerLinkClicked.ts" company="Microsoft">
//     Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// ---------------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        var TelemetryEvent = _Microsoft.Client.Telemetry.TelemetryEvent;
        var Utility = _Microsoft.Client.Telemetry.Utility;
        ProcessDesigner.ProcessDesignerLinkClickedEventName = "ProcessDesignerLinkClicked";
        var ProcessDesignerLinkClickedEvent = (function (_super) {
            __extends(ProcessDesignerLinkClickedEvent, _super);
            function ProcessDesignerLinkClickedEvent() {
                _super.call(this, null, ProcessDesigner.ProcessDesignerLinkClickedEventName);
            }
            ProcessDesignerLinkClickedEvent.prototype.SetInfo = function (processId, sessionId, state, linkType, processType) {
                this.AddEventParameter(ProcessDesignerActivatedParameters.processId, processId);
                this.AddEventParameter(ProcessDesignerActivatedParameters.sessionId, sessionId);
                this.AddEventParameter(ProcessDesignerActivatedParameters.linkType, linkType);
                this.AddEventParameter(ProcessDesignerActivatedParameters.processType, processType);
                this.AddEventParameter(ProcessDesignerActivatedParameters.state, state);
                this.AddEventParameter(ProcessDesignerActivatedParameters.timestamp, Utility.GetTimeStamp());
            };
            return ProcessDesignerLinkClickedEvent;
        })(TelemetryEvent);
        ProcessDesigner.ProcessDesignerLinkClickedEvent = ProcessDesignerLinkClickedEvent;
        var ProcessDesignerActivatedParameters = (function () {
            function ProcessDesignerActivatedParameters() {
            }
            ProcessDesignerActivatedParameters.processId = "ProcessId";
            ProcessDesignerActivatedParameters.sessionId = "SessionId";
            ProcessDesignerActivatedParameters.linkType = "LinkType";
            ProcessDesignerActivatedParameters.processType = "ProcessType";
            ProcessDesignerActivatedParameters.state = "State";
            ProcessDesignerActivatedParameters.timestamp = "Timestamp";
            return ProcessDesignerActivatedParameters;
        })();
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// ---------------------------------------------------------------------------
// <copyright file="ProcessDesignerSavedEvent.ts" company="Microsoft">
//     Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// ---------------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        var TelemetryEvent = _Microsoft.Client.Telemetry.TelemetryEvent;
        var Utility = _Microsoft.Client.Telemetry.Utility;
        ProcessDesigner.ProcessDesignerSavedEventName = "ProcessDesignerSaved";
        var ProcessDesignerSavedEvent = (function (_super) {
            __extends(ProcessDesignerSavedEvent, _super);
            function ProcessDesignerSavedEvent() {
                _super.call(this, null, ProcessDesigner.ProcessDesignerSavedEventName);
            }
            ProcessDesignerSavedEvent.prototype.SetInfo = function (processId, sessionId, processType, state, orgId, elapsedTimeInMS, errorDetails, errorCount) {
                this.AddEventParameter(ProcessDesignerSavedParameters.processId, processId);
                this.AddEventParameter(ProcessDesignerSavedParameters.sessionId, sessionId);
                this.AddEventParameter(ProcessDesignerSavedParameters.processType, processType);
                this.AddEventParameter(ProcessDesignerSavedParameters.state, state);
                this.AddEventParameter(ProcessDesignerSavedParameters.timeCreated, Utility.GetTimeStamp());
                this.AddEventParameter(ProcessDesignerSavedParameters.elapsedTimeInMS, elapsedTimeInMS);
                this.AddEventParameter(ProcessDesignerSavedParameters.errorDetails, errorDetails);
                this.AddEventParameter(ProcessDesignerSavedParameters.errorCount, errorCount);
            };
            return ProcessDesignerSavedEvent;
        })(TelemetryEvent);
        ProcessDesigner.ProcessDesignerSavedEvent = ProcessDesignerSavedEvent;
        var ProcessDesignerSavedParameters = (function () {
            function ProcessDesignerSavedParameters() {
            }
            ProcessDesignerSavedParameters.processId = "ProcessId";
            ProcessDesignerSavedParameters.sessionId = "SessionId";
            ProcessDesignerSavedParameters.processType = "ProcessType";
            ProcessDesignerSavedParameters.state = "State";
            ProcessDesignerSavedParameters.timeCreated = "TimeCreated";
            ProcessDesignerSavedParameters.elapsedTimeInMS = "ElapsedTimeInMilliSeconds";
            ProcessDesignerSavedParameters.errorDetails = "ErrorDetails";
            ProcessDesignerSavedParameters.errorCount = "ErrorCount";
            return ProcessDesignerSavedParameters;
        })();
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// ---------------------------------------------------------------------------
// <copyright file="ProcessDesignerActivatedEvent.ts" company="Microsoft">
//     Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// ---------------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        var TelemetryEvent = _Microsoft.Client.Telemetry.TelemetryEvent;
        var Utility = _Microsoft.Client.Telemetry.Utility;
        ProcessDesigner.ProcessDesignerActivatedEventName = "ProcessDesignerActivated";
        var ProcessDesignerActivatedEvent = (function (_super) {
            __extends(ProcessDesignerActivatedEvent, _super);
            function ProcessDesignerActivatedEvent() {
                _super.call(this, null, ProcessDesigner.ProcessDesignerActivatedEventName);
            }
            ProcessDesignerActivatedEvent.prototype.SetInfo = function (processId, sessionId, processType, state, orgId, elapsedTimeInMS, errorCode, errorDetails, errorCount) {
                this.AddEventParameter(ProcessDesignerActivatedParameters.processId, processId);
                this.AddEventParameter(ProcessDesignerActivatedParameters.sessionId, sessionId);
                this.AddEventParameter(ProcessDesignerActivatedParameters.processType, processType);
                this.AddEventParameter(ProcessDesignerActivatedParameters.state, state);
                this.AddEventParameter(ProcessDesignerActivatedParameters.timeCreated, Utility.GetTimeStamp());
                this.AddEventParameter(ProcessDesignerActivatedParameters.elapsedTimeInMS, elapsedTimeInMS);
                this.AddEventParameter(ProcessDesignerActivatedParameters.errorCode, errorCode);
                this.AddEventParameter(ProcessDesignerActivatedParameters.errorDetails, errorDetails);
                this.AddEventParameter(ProcessDesignerActivatedParameters.errorCount, errorCount);
            };
            return ProcessDesignerActivatedEvent;
        })(TelemetryEvent);
        ProcessDesigner.ProcessDesignerActivatedEvent = ProcessDesignerActivatedEvent;
        var ProcessDesignerActivatedParameters = (function () {
            function ProcessDesignerActivatedParameters() {
            }
            ProcessDesignerActivatedParameters.processId = "ProcessId";
            ProcessDesignerActivatedParameters.sessionId = "SessionId";
            ProcessDesignerActivatedParameters.processType = "ProcessType";
            ProcessDesignerActivatedParameters.state = "State";
            ProcessDesignerActivatedParameters.timeCreated = "TimeCreated";
            ProcessDesignerActivatedParameters.elapsedTimeInMS = "ElapsedTimeInMilliSeconds";
            ProcessDesignerActivatedParameters.errorCode = "ErrorCode";
            ProcessDesignerActivatedParameters.errorDetails = "ErrorDetails";
            ProcessDesignerActivatedParameters.errorCount = "ErrorCount";
            return ProcessDesignerActivatedParameters;
        })();
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// ---------------------------------------------------------------------------
// <copyright file="ProcessDesignerSolDependencyErrorEvent.ts" company="Microsoft">
//     Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// ---------------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        var TelemetryEvent = _Microsoft.Client.Telemetry.TelemetryEvent;
        var Utility = _Microsoft.Client.Telemetry.Utility;
        ProcessDesigner.ProcessDesignerSolDependencyErrorEventName = "ProcessDesignerSolDependencyError";
        var ProcessDesignerSolDependencyErrorEvent = (function (_super) {
            __extends(ProcessDesignerSolDependencyErrorEvent, _super);
            function ProcessDesignerSolDependencyErrorEvent() {
                _super.call(this, null, ProcessDesigner.ProcessDesignerSolDependencyErrorEventName);
            }
            ProcessDesignerSolDependencyErrorEvent.prototype.SetInfo = function (processId, sessionId, processType, state, responseType, statusText, ResponseText) {
                this.AddEventParameter(ProcessDesignerSolDependencyErrorParameters.processId, processId);
                this.AddEventParameter(ProcessDesignerSolDependencyErrorParameters.sessionId, sessionId);
                this.AddEventParameter(ProcessDesignerSolDependencyErrorParameters.processType, processType);
                this.AddEventParameter(ProcessDesignerSolDependencyErrorParameters.state, state);
                this.AddEventParameter(ProcessDesignerSolDependencyErrorParameters.responseType, responseType);
                this.AddEventParameter(ProcessDesignerSolDependencyErrorParameters.statusText, statusText);
                this.AddEventParameter(ProcessDesignerSolDependencyErrorParameters.ResponseText, ResponseText);
                this.AddEventParameter(ProcessDesignerSolDependencyErrorParameters.timestamp, Utility.GetTimeStamp());
            };
            return ProcessDesignerSolDependencyErrorEvent;
        })(TelemetryEvent);
        ProcessDesigner.ProcessDesignerSolDependencyErrorEvent = ProcessDesignerSolDependencyErrorEvent;
        var ProcessDesignerSolDependencyErrorParameters = (function () {
            function ProcessDesignerSolDependencyErrorParameters() {
            }
            ProcessDesignerSolDependencyErrorParameters.processId = "ProcessId";
            ProcessDesignerSolDependencyErrorParameters.sessionId = "SessionId";
            ProcessDesignerSolDependencyErrorParameters.processType = "ProcessType";
            ProcessDesignerSolDependencyErrorParameters.state = "State";
            ProcessDesignerSolDependencyErrorParameters.responseType = "ResponseType";
            ProcessDesignerSolDependencyErrorParameters.statusText = "StatusText";
            ProcessDesignerSolDependencyErrorParameters.ResponseText = "ResponseText";
            ProcessDesignerSolDependencyErrorParameters.timestamp = "Timestamp";
            return ProcessDesignerSolDependencyErrorParameters;
        })();
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// ---------------------------------------------------------------------------
// <copyright file="ProcessDesignerValidatedEvent.ts" company="Microsoft">
//     Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// ---------------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        var TelemetryEvent = _Microsoft.Client.Telemetry.TelemetryEvent;
        var Utility = _Microsoft.Client.Telemetry.Utility;
        ProcessDesigner.ProcessDesignerValidatedEventName = "ProcessDesignerValidated";
        var ProcessDesignerValidatedEvent = (function (_super) {
            __extends(ProcessDesignerValidatedEvent, _super);
            function ProcessDesignerValidatedEvent() {
                _super.call(this, null, ProcessDesigner.ProcessDesignerValidatedEventName);
            }
            ProcessDesignerValidatedEvent.prototype.SetInfo = function (processId, sessionId, state, validatedAt, errorDetails, errorCount, ProcessType) {
                this.AddEventParameter(ProcessDesignerValidatedParameters.processId, processId);
                this.AddEventParameter(ProcessDesignerValidatedParameters.sessionId, sessionId);
                this.AddEventParameter(ProcessDesignerValidatedParameters.processType, ProcessType);
                this.AddEventParameter(ProcessDesignerValidatedParameters.state, state);
                this.AddEventParameter(ProcessDesignerValidatedParameters.validatedAt, validatedAt);
                this.AddEventParameter(ProcessDesignerValidatedParameters.errorDetails, errorDetails);
                this.AddEventParameter(ProcessDesignerValidatedParameters.errorCount, errorCount);
                this.AddEventParameter(ProcessDesignerValidatedParameters.timestamp, Utility.GetTimeStamp());
            };
            return ProcessDesignerValidatedEvent;
        })(TelemetryEvent);
        ProcessDesigner.ProcessDesignerValidatedEvent = ProcessDesignerValidatedEvent;
        var ProcessDesignerValidatedParameters = (function () {
            function ProcessDesignerValidatedParameters() {
            }
            ProcessDesignerValidatedParameters.processId = "ProcessId";
            ProcessDesignerValidatedParameters.sessionId = "SessionId";
            ProcessDesignerValidatedParameters.processType = "ProcessType";
            ProcessDesignerValidatedParameters.state = "State";
            ProcessDesignerValidatedParameters.validatedAt = "ValidatedAt";
            ProcessDesignerValidatedParameters.errorDetails = "ErrorDetails";
            ProcessDesignerValidatedParameters.errorCount = "ErrorCount";
            ProcessDesignerValidatedParameters.timestamp = "Timestamp";
            return ProcessDesignerValidatedParameters;
        })();
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// ---------------------------------------------------------------------------
// <copyright file="ProcessDesignerDeactivatedEvent.ts" company="Microsoft">
//     Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// ---------------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        var TelemetryEvent = _Microsoft.Client.Telemetry.TelemetryEvent;
        var Utility = _Microsoft.Client.Telemetry.Utility;
        ProcessDesigner.ProcessDesignerDeactivatedEventName = "ProcessDesignerDeactivated";
        var ProcessDesigneDeactivatedEvent = (function (_super) {
            __extends(ProcessDesigneDeactivatedEvent, _super);
            function ProcessDesigneDeactivatedEvent() {
                _super.call(this, null, ProcessDesigner.ProcessDesignerDeactivatedEventName);
            }
            ProcessDesigneDeactivatedEvent.prototype.SetInfo = function (processId, sessionId, processType, state, orgId, elapsedTimeInMS, errorCode, errorDetails, errorCount) {
                this.AddEventParameter(ProcessDesignerDeactivatedParameters.processId, processId);
                this.AddEventParameter(ProcessDesignerDeactivatedParameters.sessionId, sessionId);
                this.AddEventParameter(ProcessDesignerDeactivatedParameters.processType, processType);
                this.AddEventParameter(ProcessDesignerDeactivatedParameters.state, state);
                this.AddEventParameter(ProcessDesignerDeactivatedParameters.timeCreated, Utility.GetTimeStamp());
                this.AddEventParameter(ProcessDesignerDeactivatedParameters.elapsedTimeInMS, elapsedTimeInMS);
                this.AddEventParameter(ProcessDesignerDeactivatedParameters.errorCode, errorCode);
                this.AddEventParameter(ProcessDesignerDeactivatedParameters.errorDetails, errorDetails);
                this.AddEventParameter(ProcessDesignerDeactivatedParameters.errorCount, errorCount);
            };
            return ProcessDesigneDeactivatedEvent;
        })(TelemetryEvent);
        ProcessDesigner.ProcessDesigneDeactivatedEvent = ProcessDesigneDeactivatedEvent;
        var ProcessDesignerDeactivatedParameters = (function () {
            function ProcessDesignerDeactivatedParameters() {
            }
            ProcessDesignerDeactivatedParameters.processId = "ProcessId";
            ProcessDesignerDeactivatedParameters.sessionId = "SessionId";
            ProcessDesignerDeactivatedParameters.processType = "ProcessType";
            ProcessDesignerDeactivatedParameters.state = "State";
            ProcessDesignerDeactivatedParameters.timeCreated = "TimeCreated";
            ProcessDesignerDeactivatedParameters.elapsedTimeInMS = "ElapsedTimeInMilliSeconds";
            ProcessDesignerDeactivatedParameters.errorCode = "ErrorCode";
            ProcessDesignerDeactivatedParameters.errorDetails = "ErrorDetails";
            ProcessDesignerDeactivatedParameters.errorCount = "ErrorCount";
            return ProcessDesignerDeactivatedParameters;
        })();
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
// ---------------------------------------------------------------------------
// <copyright file="ReconnectOperationPerformedEvent.ts" company="Microsoft">
//     Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>
// ---------------------------------------------------------------------------
var MscrmControls;
(function (MscrmControls) {
    var ProcessDesigner;
    (function (ProcessDesigner) {
        var TelemetryEvent = _Microsoft.Client.Telemetry.TelemetryEvent;
        var Utility = _Microsoft.Client.Telemetry.Utility;
        ProcessDesigner.ReconnectOperationPerformedEventName = "ProcessDesignerTileReconnected";
        var ReconnectOperationPerformedEvent = (function (_super) {
            __extends(ReconnectOperationPerformedEvent, _super);
            function ReconnectOperationPerformedEvent() {
                _super.call(this, null, ProcessDesigner.ReconnectOperationPerformedEventName);
            }
            ReconnectOperationPerformedEvent.prototype.SetInfo = function (processId, sessionId, processType, state, sourceTileId, ifConditionTileId, oldDefaultPathTileId, newDefaultPathTileId) {
                this.AddEventParameter(ReconnectOperationPerformedParameters.processId, processId);
                this.AddEventParameter(ReconnectOperationPerformedParameters.sessionId, sessionId);
                this.AddEventParameter(ReconnectOperationPerformedParameters.processType, processType);
                this.AddEventParameter(ReconnectOperationPerformedParameters.state, state);
                this.AddEventParameter(ReconnectOperationPerformedParameters.sourceTileId, sourceTileId);
                this.AddEventParameter(ReconnectOperationPerformedParameters.ifConditionTileId, ifConditionTileId);
                this.AddEventParameter(ReconnectOperationPerformedParameters.oldDefaultPathTileId, oldDefaultPathTileId);
                this.AddEventParameter(ReconnectOperationPerformedParameters.newDefaultPathTileId, newDefaultPathTileId);
                this.AddEventParameter(ReconnectOperationPerformedParameters.timestamp, Utility.GetTimeStamp());
            };
            return ReconnectOperationPerformedEvent;
        })(TelemetryEvent);
        ProcessDesigner.ReconnectOperationPerformedEvent = ReconnectOperationPerformedEvent;
        var ReconnectOperationPerformedParameters = (function () {
            function ReconnectOperationPerformedParameters() {
            }
            ReconnectOperationPerformedParameters.processId = "ProcessId";
            ReconnectOperationPerformedParameters.sessionId = "SessionId";
            ReconnectOperationPerformedParameters.processType = "ProcessType";
            ReconnectOperationPerformedParameters.state = "State";
            ReconnectOperationPerformedParameters.sourceTileId = "SourceTileId";
            ReconnectOperationPerformedParameters.ifConditionTileId = "IfConditionTileId";
            ReconnectOperationPerformedParameters.oldDefaultPathTileId = "OldDefaultPathTileId";
            ReconnectOperationPerformedParameters.newDefaultPathTileId = "NewDefaultPathTileId";
            ReconnectOperationPerformedParameters.timestamp = "Timestamp";
            return ReconnectOperationPerformedParameters;
        })();
    })(ProcessDesigner = MscrmControls.ProcessDesigner || (MscrmControls.ProcessDesigner = {}));
})(MscrmControls || (MscrmControls = {}));
