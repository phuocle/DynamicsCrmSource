Type.registerNamespace("Mscrm");var CONNECTION_ROLE="connectionrole",CONNECTION_ROLE_OBECT_TYPE_CODE="connectionroleobjecttypecode",ASSOCIATED_OBJECT_TYPE_CODE="associatedobjecttypecode",DEFAULT_ENTITY_TYPE_CODE=2,CONNECTION_CUSTOM_VIEWID="{1DEC1FD6-8E84-4342-BA12-5DF9A981D7D2}",CONNECTION_ROLE_DEFAULT_SAVEQUERYID="{0F00BF5F-3C30-4C9B-9E06-7F5F26FFD537}",Mscrm;(function(Mscrm){var ConnectionsLegacyClient=function(){function ConnectionsLegacyClient(){}ConnectionsLegacyClient.prototype.record1roleid_onchange=function(context){Mscrm.Connection.setType(context.getEventSource().getName(),"record2roleid","record2id")};ConnectionsLegacyClient.prototype.record2roleid_onchange=function(context){Mscrm.Connection.setType(context.getEventSource().getName(),"record1roleid","record1id")};ConnectionsLegacyClient.prototype.connectionForm_onload=function(){Xrm.Page.getControl("record1roleid").addPreSearch(function(){Mscrm.Connection.applyFilter("record1roleid","record1id","record2roleid")});Xrm.Page.getControl("record2roleid").addPreSearch(function(){Mscrm.Connection.applyFilter("record2roleid","record2id","record1roleid")})};ConnectionsLegacyClient.prototype.record1roleid_onclick=function(){Mscrm.Connection.preSelectObjectType("record1id","record1roleid","record2roleid")};ConnectionsLegacyClient.prototype.record1roleid_onclick=function(){Mscrm.Connection.preSelectObjectType("record2id","record2roleid","record1roleid")};return ConnectionsLegacyClient}();Mscrm.ConnectionsLegacyClient=ConnectionsLegacyClient})(Mscrm||(Mscrm={}));var Mscrm;(function(Mscrm){var ConnectionsModernClient=function(){function ConnectionsModernClient(){}ConnectionsModernClient.prototype.record1roleid_onchange=function(context){Mscrm.ConnectionsModernClient.setTypeRefreshed(context.getEventSource().getName(),"record2roleid","record2id")};ConnectionsModernClient.prototype.record2roleid_onchange=function(context){Mscrm.ConnectionsModernClient.setTypeRefreshed(context.getEventSource().getName(),"record1roleid","record1id")};ConnectionsModernClient.prototype.connectionForm_onload=function(){Xrm.Page.getControl("record1roleid").addPreSearch(function(){Mscrm.ConnectionsModernClient.applyFilterRefreshed("record1roleid","record1id","record2roleid")});Xrm.Page.getControl("record2roleid").addPreSearch(function(){Mscrm.ConnectionsModernClient.applyFilterRefreshed("record2roleid","record2id","record1roleid")});var queryStringParameters=Xrm.Page.context.getQueryStringParameters();(queryStringParameters&&(queryStringParameters.record1id&&queryStringParameters.record1id.entityType&&queryStringParameters.record1id.entityType=="pricelevel")||queryStringParameters.parentrecordtype&&queryStringParameters.parentrecordtype=="pricelevel")&&ConnectionsModernClient.SetDefaultRole();Xrm.WebApi.retrieveRecord("savedquery",CONNECTION_ROLE_DEFAULT_SAVEQUERYID,"?$select=fetchxml,name,statecode,layoutxml").then(function(response){if(response){Mscrm.ConnectionsModernClient.defaultConnectionRoleFetchXml=response.fetchxml;Mscrm.ConnectionsModernClient.defaultConnectionRoleViewName=response.name;Mscrm.ConnectionsModernClient.defaultConnectionRoleLayoutXml=response.layoutxml}})};ConnectionsModernClient.setTypeRefreshed=function(roleLookupElementId,peerRoleLookupElementId,peerRecordLookupElementId){var roleLookup=Xrm.Page.getAttribute(roleLookupElementId),peerRecordLookup=Xrm.Page.getAttribute(peerRecordLookupElementId),peerRoleLookup=Xrm.Page.getAttribute(peerRoleLookupElementId),roleLookupReference=roleLookup&&roleLookup.getValue()&&roleLookup.getValue()[0],peerRecordLookupReference=peerRecordLookup&&peerRecordLookup.getValue()&&peerRecordLookup.getValue()[0],peerRoleLookupReference=peerRoleLookup&&peerRoleLookup.getValue()&&peerRoleLookup.getValue()[0];if(!roleLookupReference)return;var associatedRecordOtc=-1,peerRoleId;if(peerRecordLookupReference)associatedRecordOtc=Xrm.Internal.getEntityCode(peerRecordLookupReference.entityType);if(peerRoleLookupReference)peerRoleId=peerRoleLookupReference.id;Mscrm.ConnectionsModernClient.getPossibleRoleRefreshed(roleLookupReference.id,peerRoleId,associatedRecordOtc).then(function(result){if(!result)return;if(result.length>0){if(!peerRoleLookupReference||peerRoleLookupReference&&result[0]&&result[0]!=peerRoleLookupReference.Id){var lookupItem={id:result[0],entityType:CONNECTION_ROLE,name:result[1]};peerRoleLookup.setValue([lookupItem])}}else peerRoleLookup.setValue(null)})};ConnectionsModernClient.SetDefaultRole=function(){var defaultConnectionRoleId="C7F4A13C-9853-4806-907F-BFC3463459A9",roleLookup=Xrm.Page.getAttribute("record2roleid");roleLookup&&roleLookup.getValue()==null&&Mscrm.ConnectionsModernClient.getDefaultRole(defaultConnectionRoleId).then(function(result){if(!result)return;if(result.length>0){var lookupItem={id:result[0],entityType:CONNECTION_ROLE,name:result[1]};roleLookup.setValue([lookupItem])}else roleLookup.setValue(null)})};ConnectionsModernClient.getDefaultRole=function(roleId){return new Promise(function(resolve,reject){var fetchXML="<fetch distinct='false' no-lock='false' mapping='logical' page='1' count='2'><entity name='connectionrole'><attribute name='connectionroleid' /><attribute name='name' /><filter type='and'><condition attribute='connectionroleid' operator='eq' value='"+roleId+"' /></filter>";fetchXML=fetchXML+"</entity></fetch>";var result=[];Xrm.WebApi.retrieveMultipleRecords(CONNECTION_ROLE,"?fetchXml="+fetchXML).then(function(response){if(!response)return resolve(null);if(response.entities.length==1){result[0]=response.entities[0]["connectionroleid"];result[1]=response.entities[0]["name"]}return resolve(result)},function(error){return resolve(null)})})};ConnectionsModernClient.getPossibleRoleRefreshed=function(roleId,peerRoleId,associatedRecordOtc){return new Promise(function(resolve,reject){var fetchXML="<fetch distinct='false' no-lock='false' mapping='logical' page='1' count='2'><entity name='connectionrole'><attribute name='connectionroleid' /><attribute name='name' /><link-entity name='connectionroleassociation' to='connectionroleid' from='connectionroleid' link-type='inner'><filter type='and'><condition attribute='associatedconnectionroleid' operator='eq' value='"+roleId+"' /></filter>";if(associatedRecordOtc!=-1)fetchXML=fetchXML+"<link-entity name='connectionroleobjecttypecode' to='connectionroleid' from='connectionroleid' link-type='inner'><filter type='or'><condition attribute='associatedobjecttypecode' operator='eq' value='"+associatedRecordOtc+"' /><condition attribute='associatedobjecttypecode' operator='eq' value='0' /></filter></link-entity>";fetchXML=fetchXML+"</link-entity></entity></fetch>";var result=[];Xrm.WebApi.retrieveMultipleRecords(CONNECTION_ROLE,"?fetchXml="+fetchXML).then(function(response){if(!response)return resolve(null);if(response.entities.length==1){result[0]=response.entities[0]["connectionroleid"];result[1]=response.entities[0]["name"]}else if(response.entities.length>1)if(peerRoleId)result[0]=peerRoleId;return resolve(result)})})};ConnectionsModernClient.applyFilterRefreshed=function(sourceElementId,masterLookupElementId,peerLookupElementId){var fetchXml=null,layoutXml=null,lookupToFilter=Xrm.Page.getAttribute(sourceElementId),masterLookup=Xrm.Page.getAttribute(masterLookupElementId),peerLookup=Xrm.Page.getAttribute(peerLookupElementId),lookupToFilterReference=lookupToFilter&&lookupToFilter.getValue()&&lookupToFilter.getValue()[0],masterLookupReference=masterLookup&&masterLookup.getValue()&&masterLookup.getValue()[0],peerLookupReference=peerLookup&&peerLookup.getValue()&&peerLookup.getValue()[0],queryParameters=Xrm.Page.context.getQueryStringParameters();if(sourceElementId=="record2roleid"&&queryParameters&&queryParameters.roleCategoryId){var filterExpression="<filter type='and'><condition attribute='category' operator='eq' value='"+queryParameters.roleCategoryId+"'/></filter>";lookupToFilter.controls.get(0)&&lookupToFilter.controls.get(0).addCustomFilter(filterExpression)}if(masterLookupReference||peerLookupReference){layoutXml="<grid name='resultset' object='3231' jump='name' select='1' icon='1' preview='0'><row name='result' id='connectionroleid'><cell name='name' width='300' /><cell name='category' width='150' /><cell name='statecode' width='150' /></row></grid>";fetchXml="<fetch version='1.0' output-format='xml - platform' mapping='logical'><entity name='connectionrole'><attribute name='category' /><attribute name='name' /><attribute name='connectionroleid' /><attribute name='statecode' /><filter type='and'><condition attribute='statecode' operator='eq' value='0' /></filter><order attribute='category' descending='false' />";if(masterLookupReference)fetchXml=fetchXml+"<link-entity name='connectionroleobjecttypecode' from='connectionroleid' to='connectionroleid' link-type='inner'><filter type='or'><condition attribute='associatedobjecttypecode' operator='eq' value='"+Xrm.Internal.getEntityCode(masterLookupReference.entityType)+"' /><condition attribute='associatedobjecttypecode' operator='eq' value='0' /></filter></link-entity>";if(peerLookupReference)fetchXml=fetchXml+"<link-entity name='connectionroleassociation' from='connectionroleid' to='connectionroleid' link-type='inner'><filter type='and'><condition attribute='associatedconnectionroleid' operator='eq' value='"+peerLookupReference.id+"' /></filter></link-entity>";fetchXml=fetchXml+"</entity></fetch>"}var customViewName=Xrm.Utility.getResourceString("Main_system_library","Web.Connections.ConnectionRoles.rolelookup_filtered_view_name");Xrm.Page.ui.controls.get(sourceElementId).addCustomView(CONNECTION_CUSTOM_VIEWID,CONNECTION_ROLE,customViewName&&customViewName.length>0?customViewName:Mscrm.ConnectionsModernClient.defaultConnectionRoleViewName,fetchXml?fetchXml:Mscrm.ConnectionsModernClient.defaultConnectionRoleFetchXml,layoutXml?layoutXml:Mscrm.ConnectionsModernClient.defaultConnectionRoleLayoutXml,true)};return ConnectionsModernClient}();Mscrm.ConnectionsModernClient=ConnectionsModernClient})(Mscrm||(Mscrm={}));var Mscrm;(function(Mscrm){clickhandlers=Xrm.Internal.isUci&&Xrm.Internal.isUci()?new Mscrm.ConnectionsModernClient:new Mscrm.ConnectionsLegacyClient;Mscrm.record1roleid_onchange=clickhandlers.record1roleid_onchange.bind(clickhandlers);Mscrm.record2roleid_onchange=clickhandlers.record2roleid_onchange.bind(clickhandlers);Mscrm.connectionForm_onload=clickhandlers.connectionForm_onload.bind(clickhandlers);Mscrm.record1roleid_setadditionalparams=function(){};Mscrm.record2roleid_setadditionalparams=function(){};Mscrm.record2id_onclick=function(){};Mscrm.record1id_onclick=function(){};if(!Xrm.Internal.isUci()){Mscrm.record1roleid_onclick=clickhandlers.record1roleid_onclick;Mscrm.record2roleid_onclick=clickhandlers.record1roleid_onclick}})(Mscrm||(Mscrm={}))