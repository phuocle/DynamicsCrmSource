var manageConnectionRole={};manageConnectionRole.listSortedByLogicalName=[];manageConnectionRole.entityList=null;manageConnectionRole.connectionRoleObjectTypeCode="connectionroleobjecttypecode";manageConnectionRole.TelemetryComponentName="ManageRecordTypeDialogJS.";manageConnectionRole.activityPointer="activitypointer";manageConnectionRole.param_recordIdName="param_recordId";manageConnectionRole.param_selectedEntitiesName="param_selectedEntities";manageConnectionRole.entitylistControlName="entitylist";manageConnectionRole.statusAttributeName="param_stateCode";manageConnectionRole.okButtonID="ok_id";manageConnectionRole.ConnectionRoleResourceLibraryName="Main_system_library";manageConnectionRole.deactivateMessageID="uci_ConnectionRole_Deactivate_Message";manageConnectionRole.connectionRoleEntityName="connectionrole";function onLoad(context){var formContext=context.getFormContext();MakeRequest(formContext)}function onSave(context){var connectionRoleEntitySetName="connectionroles",formContext=context.getFormContext(),recordIdAttribute=formContext.data.attributes.get(manageConnectionRole.param_recordIdName);if(!recordIdAttribute){manageConnectionRole.reportError(new Error("ConnectionRole ID not available"),"onSave");return}var connectionRoleRecordId=recordIdAttribute.getValue(),prevSelectedEntities=[],param_selectedEntities=formContext.data.attributes.get(manageConnectionRole.param_selectedEntitiesName);if(!param_selectedEntities){manageConnectionRole.reportError(new Error("param_selectedEntities not available"),"onSave");return}prevSelectedEntities=JSON.parse(param_selectedEntities.getValue());var newSelectedIndex=[],entitylistControl=formContext.data.attributes.get(manageConnectionRole.entitylistControlName);if(!entitylistControl){manageConnectionRole.reportError(new Error("entitylistControl not available"),"onSave");return}newSelectedIndex=entitylistControl.getValue();var newSelectedEntities=[];if(!manageConnectionRole.entityList){manageConnectionRole.reportError(new Error("manageConnectionRole.entityList not available"),"onSave");return}for(var index in newSelectedIndex)newSelectedEntities.push(manageConnectionRole.entityList[newSelectedIndex[index]]);var create=[],del={};prevSelectedEntities.map(function(entity){del[entity.LogicalName]=entity});var selectAllLength=manageConnectionRole.listSortedByLogicalName.length;if(newSelectedEntities.length===selectAllLength)if(!(prevSelectedEntities.length===selectAllLength||prevSelectedEntities.length===1&&prevSelectedEntities[0].LogicalName==="none"))create.push({LogicalName:"none"});else del={};else newSelectedEntities.map(function(entity){if(del[entity.LogicalName])delete del[entity.LogicalName];else create.push(entity)});for(var changeSet=[],keys=Object.keys(del),count=0;count<keys.length;count++)changeSet.push(new manageConnectionRole.ODataDeleteRequest({entityType:manageConnectionRole.connectionRoleObjectTypeCode,id:del[keys[count]].connectionroleobjecttypecodeid}));for(var count=0;count<create.length;count++){var data={"connectionroleid@odata.bind":connectionRoleEntitySetName+"("+connectionRoleRecordId.guid+")",associatedobjecttypecode:create[count].LogicalName};changeSet.push(new manageConnectionRole.ODataCreateRequest(manageConnectionRole.connectionRoleObjectTypeCode,data))}if(changeSet.length>0){changeSet.push(new manageConnectionRole.ODataUpdateRequest(manageConnectionRole.connectionRoleEntityName,connectionRoleRecordId.guid,{}));Xrm.WebApi.online.executeMultiple([changeSet]).then(function(){formContext.ui.close()},function(error){manageConnectionRole.reportError(error,onSave)})}else formContext.ui.close()}function onClose(context){context.getFormContext().ui.close()}function MakeRequest(formContext){var serverUrl=formContext.context.getClientUrl(),oDataEndpointUrl=serverUrl+"/api/data/v9.0/EntityDefinitions?$select=LogicalName,DisplayName &$filter=IsConnectionsEnabled/Value eq true",service=new XMLHttpRequest;service.open("GET",oDataEndpointUrl);service.setRequestHeader("X-Requested-With","XMLHttpRequest");service.setRequestHeader("Accept","application/json, text/javascript, */*");service.send(null);service.onreadystatechange=function(){if(this.readyState===4){service.onreadystatechange=null;switch(this.status){case 200:case 204:var retrieved=JSON.parse(service.responseText);manageConnectionRole.entityList=retrieved.value;manageConnectionRole.entityList.sort(manageConnectionRole.compareByDisplayName);if(manageConnectionRole.entityList&&manageConnectionRole.entityList.length>0&&formContext&&formContext.data&&formContext.data.attributes){var EntityListControl=formContext.getControl(manageConnectionRole.entitylistControlName);if(EntityListControl){for(var count=0;count<manageConnectionRole.entityList.length;count++)if(manageConnectionRole.entityList[count].LogicalName!==manageConnectionRole.activityPointer){EntityListControl.addOption({text:manageConnectionRole.entityList[count].DisplayName.UserLocalizedLabel.Label,value:count});manageConnectionRole.listSortedByLogicalName.push({LogicalName:manageConnectionRole.entityList[count].LogicalName,index:count})}manageConnectionRole.listSortedByLogicalName.sort(manageConnectionRole.compare)}var objectTypeCodeList=null,param_selectedEntitiesAttribute=formContext.data.attributes.get(manageConnectionRole.param_selectedEntitiesName);if(param_selectedEntitiesAttribute)objectTypeCodeList=JSON.parse(param_selectedEntitiesAttribute.getValue());if(objectTypeCodeList&&objectTypeCodeList.length>0){objectTypeCodeList.sort(manageConnectionRole.compare);var SelectedEntityList=manageConnectionRole.getCommonIndex(manageConnectionRole.listSortedByLogicalName,objectTypeCodeList);formContext.data.attributes.get(manageConnectionRole.entitylistControlName).setValue(SelectedEntityList)}}var statusAttribute=formContext.data.attributes.get(manageConnectionRole.statusAttributeName);if(statusAttribute){var okButton=formContext.getControl(manageConnectionRole.okButtonID);if(statusAttribute.getValue()===1){okButton&&okButton.setVisible(false);var deactivateMessage=Xrm.Utility.getResourceString(manageConnectionRole.ConnectionRoleResourceLibraryName,manageConnectionRole.deactivateMessageID);deactivateMessage&&formContext.ui.setFormNotification(deactivateMessage,"INFO",1)}else if(okButton){okButton.setVisible(true);manageConnectionRole.ToggleOkButton(formContext)}}break;default:var error;try{error=JSON.parse(service.response).error}catch(e){error=new Error("Unexpected Error")}manageConnectionRole.reportError(error,"MakeRequest");break}}};return null}manageConnectionRole.compare=function(a,b){if(a&&b){if(a.LogicalName<b.LogicalName)return -1;if(a.LogicalName>b.LogicalName)return 1;return 0}else if(a&&!b)return 1;else if(!a&&b)return -1;return 0};manageConnectionRole.compareByDisplayName=function(a,b){if(a&&b&&a.DisplayName&&a.DisplayName.UserLocalizedLabel&&a.DisplayName.UserLocalizedLabel.Label&&b.DisplayName&&b.DisplayName.UserLocalizedLabel&&b.DisplayName.UserLocalizedLabel.Label){if(a.DisplayName.UserLocalizedLabel.Label.toLowerCase()<b.DisplayName.UserLocalizedLabel.Label.toLowerCase())return -1;if(a.DisplayName.UserLocalizedLabel.Label.toLowerCase()>b.DisplayName.UserLocalizedLabel.Label.toLowerCase())return 1;return 0}else if(a&&!b)return 1;else if(!a&&b)return -1;return 0};manageConnectionRole.getCommonIndex=function(mainArray,secondaryArry){if(secondaryArry)if(secondaryArry.length==1&&secondaryArry[0].LogicalName==="none")return mainArray.map(function(value){return value.index});var countM=0,countS=0,result=[];if(mainArray&&secondaryArry)while(countM<mainArray.length&&countS<secondaryArry.length)if(mainArray[countM].LogicalName<secondaryArry[countS].LogicalName)countM++;else if(mainArray[countM].LogicalName>secondaryArry[countS].LogicalName)countS++;else{result.push(mainArray[countM].index);countM++;countS++}return result};manageConnectionRole.ODataDeleteRequest=function(){function ODataDeleteRequest(entityReference){this.entityReference=entityReference}ODataDeleteRequest.prototype.getMetadata=function(){return {boundParameter:undefined,parameterTypes:{entityReference:{typeName:"mscrm.crmbaseentity",structuralProperty:5}},operationName:"Delete",operationType:2}};return ODataDeleteRequest}();manageConnectionRole.ODataCreateRequest=function(){function ODataCreateRequest(etn,payload){this.etn=etn;this.payload=payload}ODataCreateRequest.prototype.getMetadata=function(){return {boundParameter:undefined,parameterTypes:{},operationName:"Create",operationType:2}};return ODataCreateRequest}();manageConnectionRole.ODataUpdateRequest=function(){function ODataUpdateRequest(etn,id,payload){this.etn=etn;this.id=id;this.payload=payload}ODataUpdateRequest.prototype.getMetadata=function(){return {boundParameter:undefined,parameterTypes:{},operationName:"Update",operationType:2}};return ODataUpdateRequest}();manageConnectionRole.reportError=function(error,functionName){Xrm.Reporting.reportFailure(manageConnectionRole.TelemetryComponentName+functionName,error);Xrm.Navigation.openErrorDialog(error)};function onEntityListChange(context){var formContext=context.getFormContext();manageConnectionRole.ToggleOkButton(formContext)}manageConnectionRole.ToggleOkButton=function(formContext){var entityList=formContext.data.attributes.get(manageConnectionRole.entitylistControlName);if(entityList){var okButton=formContext.getControl(manageConnectionRole.okButtonID);if(okButton)if(!entityList.isValid())okButton.setDisabled(true);else okButton.setDisabled(false)}}