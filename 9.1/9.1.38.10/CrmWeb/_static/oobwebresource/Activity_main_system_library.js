var CommandBarActions;(function(CommandBarActions){var ChangeState=function(){function ChangeState(){}ChangeState.ChangeState=function(action,entityId,entityName){Dialogs.ChangeState.HandleStateChangeAction(action,entityId,entityName)};return ChangeState}();CommandBarActions.ChangeState=ChangeState})(CommandBarActions||(CommandBarActions={}));var CommandBarActions;(function(CommandBarActions){var ChangeStateGrid=function(){function ChangeStateGrid(){}ChangeStateGrid.CloseActivityFromGrid=function(gridControl,records){for(var i=0;i<records.length;i++){var entityId=records[i].Id,entityName=records[i].TypeName;CommandBarActions.ChangeState.ChangeState(Xrm.Constants.ActionNames.deactivate,entityId,entityName)}};return ChangeStateGrid}();CommandBarActions.ChangeStateGrid=ChangeStateGrid})(CommandBarActions||(CommandBarActions={}));var CommandBarActions;(function(CommandBarActions){var Deactivate=function(){function Deactivate(){}Deactivate.Deactivate=function(gridControl,records,entityIdentifier,defaultCloseState,callback){var entityLogicalName="";if(typeof entityIdentifier==="number")entityLogicalName=XrmClientApi.Internal.GetEntityName(entityIdentifier);else entityLogicalName=entityIdentifier;if(records.length==0){var alertDialogStrings={text:Xrm.Utility.getResourceString(null,Utilities.ResourceStrings.noItemSelected)};Xrm.Utility.openAlertDialog(alertDialogStrings);return}if(XrmClientApi.Internal.IsEnabledForInteractionCentric())for(var typeName=records[0].TypeName,i=1;i<records.length;i++)if(records[i].TypeName==typeName)continue;else{var alertDialogStrings={text:Xrm.Utility.getResourceString(null,Utilities.ResourceStrings.gridApplyRuleHeterogenousActivityTypeRecordsSelected)};Xrm.Utility.openAlertDialog(alertDialogStrings);return}var options={width:600,height:250},ids="",objectSubtype=null;if(entityLogicalName==Xrm.Constants.EntityNames.Workflow){if(records.length>0){objectSubtype=gridControl["getCellValue"](Utilities.AttributeNames.type,records[0].Id);var retrieveOptions="?select=rendererobjecttypecode";Xrm.WebApi.retrieveRecord(entityLogicalName,records[0].Id.toString(),retrieveOptions).then(function(entity){var rendererobjecttypecode=entity["rendererobjecttypecode"];if(rendererobjecttypecode)if(rendererobjecttypecode==Xrm.Constants.EntityNames.SLA||rendererobjecttypecode==Xrm.Constants.EntityNames.SLAItem||rendererobjecttypecode==Xrm.Constants.EntityNames.RoutingRule||rendererobjecttypecode==Xrm.Constants.EntityNames.ConvertRule||rendererobjecttypecode==Xrm.Constants.EntityNames.ConvertRuleItem){var alertDialogStrings={text:Xrm.Utility.getResourceString(null,Utilities.ResourceStrings.GridActionDeactivateWorflow)};Xrm.Utility.openAlertDialog(alertDialogStrings);return}Dialogs.Deactivate.OpenDialog(gridControl,records,entityLogicalName,defaultCloseState,callback,options,ids,objectSubtype)},function(reponse){Utilities.ClientApiUtility.ActionFailedCallback})}}else{switch(entityLogicalName){case Xrm.Constants.EntityNames.BusinessUnit:options.width=650;options.height=280;for(var i=0;i<records.length;i++)ids+=records[i].Id;break;case Xrm.Constants.EntityNames.DiscountType:case Xrm.Constants.EntityNames.Account:case Xrm.Constants.EntityNames.Contact:options.height=200;break;case Xrm.Constants.EntityNames.CampaignActivity:case Xrm.Constants.EntityNames.CampaignResponse:options.height=250;options.width=400;break;case Xrm.Constants.EntityNames.ActivityPointer:for(var record=records[0],i=1;i<records.length;i++)if(records[i].TypeName!=record.TypeName){var alertDialogStrings={text:Xrm.Utility.getResourceString(null,Utilities.ResourceStrings.gridApplyRuleHeterogenousActivityTypeRecordsSelected)};Xrm.Utility.openAlertDialog(alertDialogStrings);return}switch(record.TypeName){case Xrm.Constants.EntityNames.SocialActivity:var alertDialogStrings={text:Xrm.Utility.getResourceString(null,Utilities.ResourceStrings.gridApplyRuleSocialActivityTypeRecordsSelectedForInvalidAction)};Xrm.Utility.openAlertDialog(alertDialogStrings);return;case Xrm.Constants.EntityNames.Email:var alertDialogStrings={text:Xrm.Utility.getResourceString(null,Utilities.ResourceStrings.gridApplyRuleSelectedEmails)};Xrm.Utility.openAlertDialog(alertDialogStrings);return;case Xrm.Constants.EntityNames.CampaignResponse:case Xrm.Constants.EntityNames.CampaignActivity:if(defaultCloseState==1){var alertDialogStrings={text:Xrm.Utility.getResourceString(null,Utilities.ResourceStrings.gridApplyRuleSelectedRecords)};Xrm.Utility.openAlertDialog(alertDialogStrings);return}break}entityLogicalName=record.TypeName;break}Dialogs.Deactivate.OpenDialog(gridControl,records,entityLogicalName,defaultCloseState,callback,options,ids,objectSubtype)}};return Deactivate}();CommandBarActions.Deactivate=Deactivate})(CommandBarActions||(CommandBarActions={}));var CommandBarActions;(function(CommandBarActions){var SaveAsCompleted=function(){function SaveAsCompleted(){}SaveAsCompleted.SaveAsCompleted=function(){var entityId=Xrm.Page.data.entity.getId(),entityName=Xrm.Page.data.entity.getEntityName(),saveOptions={saveMode:58,useSchedulingEngine:false};CommandBarActions.SetState.SetState(saveOptions,entityId,entityName,1,-1,true)};return SaveAsCompleted}();CommandBarActions.SaveAsCompleted=SaveAsCompleted})(CommandBarActions||(CommandBarActions={}));var CommandBarActions;(function(CommandBarActions){var SetRegarding=function(){function SetRegarding(){}SetRegarding.SetRegarding=function(gridControl,records,entityIdentifier){var entityLogicalName="";if(typeof entityIdentifier==="number")entityLogicalName=XrmClientApi.Internal.GetEntityName(entityIdentifier);else entityLogicalName=entityIdentifier;var dialogParams=[];dialogParams[MetadataDrivenConstants.CommonDialogConstants.EntityName]=entityLogicalName;dialogParams[MetadataDrivenConstants.CommonDialogConstants.Records]=records;var options={height:240,width:500},dialogCallbackParams=[];dialogCallbackParams[MetadataDrivenConstants.CommonDialogConstants.GridControl]=gridControl;Xrm.Utility.openDialog(Xrm.Constants.DialogNames.SetRegarding,dialogParams,options).then(function(response){Dialogs.DialogUtility.CloseDialogFromGridCallback.call(null,dialogCallbackParams)},null)};return SetRegarding}();CommandBarActions.SetRegarding=SetRegarding})(CommandBarActions||(CommandBarActions={}));var CommandBarActions;(function(CommandBarActions){var SetState=function(){function SetState(){}SetState.Activate=function(entityId,entityName){var stateCode=0;switch(entityName){case Xrm.Constants.EntityNames.CampaignResponse:return;case Xrm.Constants.EntityNames.DuplicateRule:case Xrm.Constants.EntityNames.Quote:stateCode=1;break;case Xrm.Constants.EntityNames.Contract:stateCode=2;break;case Xrm.Constants.EntityNames.ConvertRule:case Xrm.Constants.EntityNames.RoutingRule:CommandBarActions.ChangeState.ChangeState(Xrm.Constants.ActionNames.activate,entityId,entityName);return;case Xrm.Constants.EntityNames.ChannelAccessProfileRule:return;case Xrm.Constants.EntityNames.SLA:return;case Xrm.Constants.EntityNames.Product:return;case Xrm.Constants.EntityNames.Position:return}if(XrmClientApi.Utilities.EnforceStateTransitions(entityName))CommandBarActions.ChangeState.ChangeState(Xrm.Constants.ActionNames.activate,entityId,entityName);else{var saveOptions={saveMode:6,useSchedulingEngine:false};this.SetState(saveOptions,entityId,entityName,stateCode)}};SetState.Deactivate=function(entityId,entityName){var stateCode=1;switch(entityName){case Xrm.Constants.EntityNames.DuplicateRule:stateCode=0;break;case Xrm.Constants.EntityNames.ChannelAccessProfileRule:return;case Xrm.Constants.EntityNames.ConvertRule:case Xrm.Constants.EntityNames.RoutingRule:CommandBarActions.ChangeState.ChangeState(Xrm.Constants.ActionNames.deactivate,entityId,entityName);return;case Xrm.Constants.EntityNames.SLA:return;case Xrm.Constants.EntityNames.Position:return}if(XrmClientApi.Utilities.EnforceStateTransitions(entityName)){CommandBarActions.ChangeState.ChangeState(Xrm.Constants.ActionNames.deactivate,entityId,entityName);return}XrmClientApi.Internal.GetStatusOptionsFromStateCode(entityName,stateCode).then(function(statusOptions){if(statusOptions!=null||statusOptions.length<=1){var saveOptions={saveMode:5,useSchedulingEngine:false};this.SetState(saveOptions,entityId,entityName,stateCode)}else this.ChangeState(Xrm.Constants.ActionNames.deactivate,entityId,entityName)},function(){var saveOptions={saveMode:5,useSchedulingEngine:false};this.SetState(saveOptions,entityId,entityName,stateCode)})};SetState.SetState=function(saveOptions,entityId,entityName,stateCode,statusCode,closeWindow,entityToOpen,entityIdToOpen){if(Xrm.Page.data.entity.getId()!=null)return;if(!Xrm.Page.data.isValid())return;if(typeof statusCode=="undefined")statusCode=-1;else if(stateCode==-1){XrmClientApi.Internal.GetStateCodeFromStatusOption(entityName,statusCode).then(function(statusStateCode){stateCode=statusStateCode;this.SetStateInternal(saveOptions,entityId,entityName,stateCode,statusCode,closeWindow,entityToOpen,entityIdToOpen)},function(){this.SetStateInternal(saveOptions,entityId,entityName,stateCode,statusCode,closeWindow,entityToOpen,entityIdToOpen)});return}this.SetStateInternal(saveOptions,entityId,entityName,stateCode,statusCode,closeWindow,entityToOpen,entityIdToOpen)};SetState.SetStateInternal=function(saveOptions,entityId,entityName,stateCode,statusCode,closeWindow,entityToOpen,entityIdToOpen){var UpdateSuccessCallback=function(saveResponse){this.SetStateUpdate(entityId,entityName,stateCode,statusCode,closeWindow,entityToOpen,entityIdToOpen)},ErrorCallback=function(errorResponse){this.isBusy=false};if(!this.isBusy){this.isBusy=true;Xrm.Page.data.save(saveOptions).then(UpdateSuccessCallback,ErrorCallback)}};SetState.SetStateUpdate=function(entityId,entityName,stateCode,statusCode,closeWindow,entityToOpen,entityIdToOpen){if(entityId)entityId=Xrm.Page.data.entity.getId();var entity={statecode:stateCode,statuscode:statusCode};Xrm.WebApi.updateRecord(entityName,entityId,entity).then(function(entity){this.PostSetState(entityId,entityName,closeWindow,entityToOpen,entityIdToOpen)},function(response){Dialogs.DialogUtility.HideProgressMessage();Utilities.ClientApiUtility.ActionFailedCallback(response)})};SetState.PostSetState=function(entityId,entityName,closeWindow,entityToOpen,entityIdToOpen){if(closeWindow){if(entityIdToOpen){Xrm.Page.ui.close();Xrm.Utility.openEntityForm(entityToOpen,entityIdToOpen,null)}else{this.RefreshParentGrid(entityId,entityName);Xrm.Page.ui.close()}this.isBusy=false;return}if(entityIdToOpen)Xrm.Utility.openEntityForm(entityToOpen,entityIdToOpen,null);else{Xrm.Page.data.refresh(true);this.RefreshParentGrid(entityId,entityName);CommandBarActions.CommandBarUtility.PerformPageRefresh(true)}this.isBusy=false};SetState.RefreshParentGrid=function(entityId,entityName){entityName!=null&&XrmClientApi.Internal.RefreshParentGrid(entityName,"",entityId)};SetState.isBusy=false;return SetState}();CommandBarActions.SetState=SetState})(CommandBarActions||(CommandBarActions={}));var CommandBarActions;(function(CommandBarActions){var CommandBarUtility=function(){function CommandBarUtility(){}CommandBarUtility.PerformPageRefresh=function(shouldSaveAndRefresh){if(shouldSaveAndRefresh===void 0)shouldSaveAndRefresh=false;if(XrmClientApi.Internal.IsEnabledForInteractionCentric())if(shouldSaveAndRefresh)Xrm.Page.data.save().then(function(successResponse){this.PerformPageDataAndRibbonRefresh()},Utilities.ClientApiUtility.OperationFailedCallback);else this.PerformPageDataAndRibbonRefresh();else Xrm.Page.data.refresh(true)};CommandBarUtility.PerformPageDataAndRibbonRefresh=function(){Xrm.Page.data.refresh(true).then(function(successResponse){Xrm.Page.ui.refreshRibbon()},Utilities.ClientApiUtility.OperationFailedCallback)};CommandBarUtility.RefreshParentGrid=function(entityId,entityName){entityName!=null&&XrmClientApi.Internal.RefreshParentGrid(entityName,"",entityId)};return CommandBarUtility}();CommandBarActions.CommandBarUtility=CommandBarUtility})(CommandBarActions||(CommandBarActions={}));var Dialogs;(function(Dialogs){var ChangeState=function(){function ChangeState(){}ChangeState.HandleStateChangeAction=function(action,entityId,entityName){var options={height:250,width:600},entityReference={entityType:entityName,id:entityId},records=[];records[0]=entityReference;var dialogArguments=[];dialogArguments[MetadataDrivenConstants.CommonDialogConstants.Records]=records;dialogArguments[MetadataDrivenConstants.DeactivateDialogConstants.Action]=action;dialogArguments[MetadataDrivenConstants.CommonDialogConstants.LastButtonClicked]="";dialogArguments[MetadataDrivenConstants.DeactivateDialogConstants.StateId]=-1;dialogArguments[MetadataDrivenConstants.DeactivateDialogConstants.StatusId]=-1;Xrm.Utility.openDialog(Xrm.Constants.DialogNames.SetStateDialog,dialogArguments,options).then(function(response){this.CloseSetStateDialogCallback.call(null,null)},null)};ChangeState.CloseSetStateDialogCallback=function(dialogParams,callbackParams){if(dialogParams!=null&&dialogParams[MetadataDrivenConstants.CommonDialogConstants.LastButtonClicked]==MetadataDrivenConstants.CommonDialogConstants.DialogOkId){var recordsAttribute=dialogParams[MetadataDrivenConstants.CommonDialogConstants.Records];if(recordsAttribute!=null){var records=recordsAttribute;if(records!=null){var entityName=records[0].entityType,entityId=records[0].id,selectedState=dialogParams[MetadataDrivenConstants.DeactivateDialogConstants.StateId],selectedStatus=dialogParams[MetadataDrivenConstants.DeactivateDialogConstants.StatusId],saveOptions={useSchedulingEngine:false,saveMode:dialogParams[MetadataDrivenConstants.DeactivateDialogConstants.Action].toString()==Xrm.Constants.ActionNames.activate?6:5},updateSuccessCallBack=function(saveResponse){Dialogs.DialogUtility.ShowProgressMessage();var entity={statecode:selectedState,statuscode:selectedStatus};Xrm.WebApi.updateRecord(entityName,entityId,entity).then(function(entity){Dialogs.DialogUtility.HideProgressMessage();CommandBarActions.CommandBarUtility.PerformPageRefresh()},function(errorResponse){this.isBusy=false;Utilities.ClientApiUtility.ActionFailedCallback(errorResponse)})};Xrm.Page.data.save(saveOptions).then(updateSuccessCallBack,Utilities.ClientApiUtility.OperationFailedCallback)}}}};return ChangeState}();Dialogs.ChangeState=ChangeState})(Dialogs||(Dialogs={}));var Dialogs;(function(Dialogs){var Deactivate=function(){function Deactivate(){}Deactivate.OpenDialog=function(gridControl,records,entityIdentifier,defaultCloseState,callback,options,ids,objectSubtype){for(var _this=this,selectedRecords=[],i=0;i<records.length;i++){var resourceString="";switch(records[i].TypeName){case Xrm.Constants.EntityNames.SocialActivity:resourceString=Utilities.ResourceStrings.gridApplyRuleSocialActivityTypeRecordsSelectedForInvalidAction;break;case Xrm.Constants.EntityNames.Email:resourceString=Utilities.ResourceStrings.gridApplyRuleSelectedEmails;break;case Xrm.Constants.EntityNames.CampaignResponse:case Xrm.Constants.EntityNames.CampaignActivity:if(defaultCloseState==1)resourceString=Utilities.ResourceStrings.gridApplyRuleSelectedRecords;break}if(resourceString){var alertString={text:Xrm.Utility.getResourceString(null,resourceString)};Xrm.Utility.openAlertDialog(alertString);return}selectedRecords[i]={entityType:records[i].TypeName,id:records[i].Id}}var dialogParams=[];dialogParams[MetadataDrivenConstants.CommonDialogConstants.Records]=selectedRecords;dialogParams[MetadataDrivenConstants.DeactivateDialogConstants.Action]=Xrm.Constants.ActionNames.deactivate;dialogParams[MetadataDrivenConstants.CommonDialogConstants.LastButtonClicked]="";dialogParams[MetadataDrivenConstants.DeactivateDialogConstants.StateId]=-1;dialogParams[MetadataDrivenConstants.DeactivateDialogConstants.StatusId]=-1;if(defaultCloseState!=null)dialogParams[MetadataDrivenConstants.DeactivateDialogConstants.DefaultCloseState]=defaultCloseState.toString();var dialogCallbackParams=[];dialogCallbackParams[MetadataDrivenConstants.CommonDialogConstants.GridControl]=gridControl;options.height=250;options.width=600;var onClose=function(callbackParams,dialogCallback){_this.CloseSetStateDialogFromGridCallback(callbackParams,dialogCallback,callback)};Xrm.Utility.openDialog(Xrm.Constants.DialogNames.SetStateDialog,dialogParams,options).then(function(response){onClose.call(null,dialogCallbackParams)},null)};Deactivate.CloseSetStateDialogFromGridCallback=function(dialogParams,callbackParams,callback){if(dialogParams!=null&&dialogParams[MetadataDrivenConstants.CommonDialogConstants.LastButtonClicked]==MetadataDrivenConstants.CommonDialogConstants.DialogOkId){var gridControl=callbackParams[MetadataDrivenConstants.CommonDialogConstants.GridControl],records=dialogParams[MetadataDrivenConstants.CommonDialogConstants.Records],selectedState=dialogParams[MetadataDrivenConstants.DeactivateDialogConstants.StateId],selectedStatus=dialogParams[MetadataDrivenConstants.DeactivateDialogConstants.StatusId];Dialogs.DialogUtility.ShowProgressMessage();if(records.length==1){var entity={statecode:selectedState,statuscode:selectedStatus};Xrm.WebApi.updateRecord(records[0].entityType,records[0].id,entity).then(function(entity){Dialogs.DialogUtility.HideProgressMessage();gridControl!=null&&gridControl.refresh();callback!=null&&callback()},function(errorResponse){this.isBusy=false;Utilities.ClientApiUtility.ActionFailedCallback(errorResponse)})}else this.SetStateMultipleRecords(records,selectedState,selectedStatus,gridControl,callback)}};Deactivate.SetStateMultipleRecords=function(records,state,status,gridControl,onSuccess){var setStateMultipleRequest=[];records.forEach(function(entityReference){var entityPayload="?statecode="+state+"&statuscode="+status,setStateRequest=Xrm.RequestSerializer.buildUpdateRequest(entityReference.entityType,entityReference.id,entityPayload);setStateMultipleRequest.push(setStateRequest)});Xrm.ExecuteODataBatch.executeODataBatch(setStateMultipleRequest).then(function(setStateResponses){Dialogs.DialogUtility.HideProgressMessage();for(var index=0;index<records.length;index++){var responseItem=setStateResponses[index];if(responseItem.json!=null){this.OpenAlertDialogForSetStateMultipleError(gridControl);return}}gridControl!=null&&gridControl.refresh();onSuccess!=null&&onSuccess()},function(errorResponse){Dialogs.DialogUtility.HideProgressMessage();this.isBusy=false;Utilities.ClientApiUtility.ActionFailedCallback(errorResponse)})};Deactivate.OpenAlertDialogForSetStateMultipleError=function(gridControl){var alertDialogStrings={text:Xrm.Utility.getResourceString(null,Utilities.ResourceStrings.multipleErrorsFound)};Xrm.Utility.openAlertDialog(alertDialogStrings).then(function(setStateResponse){gridControl.refresh()},null)};return Deactivate}();Dialogs.Deactivate=Deactivate})(Dialogs||(Dialogs={}));var Dialogs;(function(Dialogs){var SetRegarding=function(){function SetRegarding(){}SetRegarding.SetRegardingOnLoad=function(){var headerDescription=Xrm.Page.ui.controls.get(Utilities.ResourceStrings.dialogDescription),selectedRecordsCount=0,recordsAttribute=Xrm.Page.getAttribute(MetadataDrivenConstants.CommonDialogConstants.Records),recordsAttributeValue=recordsAttribute.getValue();if(recordsAttribute!=null&&recordsAttributeValue!=null){var records=recordsAttributeValue;selectedRecordsCount=Number(records.length)}var titleDescription="";if(selectedRecordsCount==1)titleDescription=Utilities.String.Stringformat([Xrm.Utility.getResourceString(null,Utilities.ResourceStrings.setRegardingDescription),selectedRecordsCount.toString(),XrmClientApi.Internal.GetEntityDisplayName(MetadataDrivenConstants.SetRegardingDialogConstants.ActivityLogicalName)]);else titleDescription=Utilities.String.Stringformat([Xrm.Utility.getResourceString(null,Utilities.ResourceStrings.setRegardingDescription),selectedRecordsCount.toString(),XrmClientApi.Internal.GetEntityLocalizedSetName(MetadataDrivenConstants.SetRegardingDialogConstants.ActivityLogicalName)]);headerDescription.setLabel(titleDescription);var setButton=Xrm.Page.getControl(MetadataDrivenConstants.CommonDialogConstants.DialogOkId);setButton.setDisabled(true)};SetRegarding.SetRegardingDialogRegardingChange=function(){var setButton=Xrm.Page.getControl(MetadataDrivenConstants.CommonDialogConstants.DialogOkId),setRegardingLookupControl=Xrm.Page.data.entity.attributes.get(MetadataDrivenConstants.SetRegardingDialogConstants.RegardingControlName),selectedRegardingEntity=setRegardingLookupControl.getValue();setButton.setDisabled(selectedRegardingEntity==null)};SetRegarding.SetRegardingDialogSetClick=function(){if(Xrm.Utility.getGlobalContext().client.getClient()==Xrm.Constants.ClientNames.mobile&&Xrm.Utility.getGlobalContext().client.getClientState()==Xrm.Constants.ClientStates.offline){Dialogs.DialogUtility.ShowMoCAOfflineError();return}var recordsAttribute=Xrm.Page.getAttribute(MetadataDrivenConstants.CommonDialogConstants.Records);if(recordsAttribute!=null){var regardingObjectId="",regardingObjectType="",recordsAttributeValue=recordsAttribute.getValue(),setRegardingLookupAttribute=Xrm.Page.data.entity.attributes.get(MetadataDrivenConstants.SetRegardingDialogConstants.RegardingControlName);if(setRegardingLookupAttribute!=null){var lookupValue=setRegardingLookupAttribute.getValue();if(lookupValue!=null){regardingObjectId=lookupValue[0].id;regardingObjectType=lookupValue[0].entityType}}var records=recordsAttributeValue;Dialogs.DialogUtility.ShowProgressMessage();if(records.length==1)this.SaveRegardingObject(records[0].id,records[0].entityType,regardingObjectId,regardingObjectType,true);else if(Xrm.Utility.getGlobalContext().client.getClient()==Xrm.Constants.ClientNames.web||Xrm.Utility.getGlobalContext().client.getClient()==Xrm.Constants.ClientNames.outlook&&Xrm.Utility.getGlobalContext().client.getClientState()==Xrm.Constants.ClientStates.online)this.SaveRegardingMultiple(records,regardingObjectId,regardingObjectType);else this.PerformSaveRegardingMultiple(records,regardingObjectId,regardingObjectType,0,true)}};SetRegarding.SaveRegardingObject=function(id,entityIdentifier,regardingObjectId,regardingEntityIdentifier,closeDialog){var entityName="";if(typeof entityIdentifier==="number")entityName=XrmClientApi.Internal.GetEntityName(entityIdentifier);else entityName=entityIdentifier;var regardingEntityName="";if(typeof regardingEntityIdentifier==="number")regardingEntityName=XrmClientApi.Internal.GetEntityName(regardingEntityIdentifier);else regardingEntityName=regardingEntityIdentifier;var regardingLookup={entityType:regardingEntityName,id:regardingObjectId},retrieveOptions="?select="+MetadataDrivenConstants.SetRegardingDialogConstants.RegardingObjectColumnName+","+MetadataDrivenConstants.SetRegardingDialogConstants.RegardingObjectTypeColumnName;Xrm.WebApi.retrieveRecord(entityName,id,retrieveOptions).then(function(entity){entity[MetadataDrivenConstants.SetRegardingDialogConstants.RegardingObjectColumnName]=regardingLookup;entity[MetadataDrivenConstants.SetRegardingDialogConstants.RegardingObjectTypeColumnName]=entityName;Xrm.WebApi.updateRecord(entityName,id,entity).then(function(entity){if(closeDialog){Dialogs.DialogUtility.setLastButtonClicked(MetadataDrivenConstants.CommonDialogConstants.DialogOkId);Dialogs.DialogUtility.HideProgressMessage();Xrm.Page.ui.close()}},function(response){Dialogs.DialogUtility.HideProgressMessage();Utilities.ClientApiUtility.ActionFailedCallback(response)})},function(response){Dialogs.DialogUtility.HideProgressMessage();Utilities.ClientApiUtility.ActionFailedCallback(response)})};SetRegarding.SaveRegardingMultiple=function(records,regardingObjectId,regardingEntityIdentifier){var regardingEntityName="";if(typeof regardingEntityIdentifier==="number")regardingEntityName=XrmClientApi.Internal.GetEntityName(regardingEntityIdentifier);else regardingEntityName=regardingEntityIdentifier;for(var regardingLookup={entityType:regardingEntityName,id:regardingObjectId},valueIds="",i=0;i<records.length;i++)valueIds=valueIds+"<value>"+records[i].id+"</value>";var queryFetchXml="<fetch mapping='logical' distinct='true'><entity name='activitypointer'><attribute name='activityid'/><attribute name='regardingobjectid'/><attribute name='regardingobjecttypecode'/><attribute name='activitytypecode'/><filter type='and'><condition attribute='activityid' operator='in'>"+valueIds+"</condition></filter></entity></fetch>",retrieveOptions="?fetchXml="+queryFetchXml;Xrm.WebApi.retrieveMultipleRecords(regardingEntityName,retrieveOptions).then(function(entities){if(entities.length==0){this.OpenAlertDialogForSetRegardingMultipleError();return}for(var index=0;index<entities.length;index++){var entity=entities[index];entity[MetadataDrivenConstants.SetRegardingDialogConstants.RegardingObjectColumnName]=regardingLookup;entity[MetadataDrivenConstants.SetRegardingDialogConstants.RegardingObjectTypeColumnName]=regardingEntityName;entities[index]=entity}var updateMultipleRequest=[];records.forEach(function(entityReference){var entityPayload="?logicalname="+entityReference.entityType+"&name="+entityReference.name+"&identifier="+entityReference.id,updateRequest=Xrm.RequestSerializer.buildUpdateRequest(entityReference.entityType,entityReference.id,entityPayload);updateMultipleRequest.push(updateRequest)});Xrm.ExecuteODataBatch.executeODataBatch(updateMultipleRequest).then(function(saveRegardingResponses){for(var index=0;index<records.length;index++){var responseItem=saveRegardingResponses[index];if(responseItem.json!=null){this.OpenAlertDialogForSetStateMultipleError();return}}Dialogs.DialogUtility.setLastButtonClicked(MetadataDrivenConstants.CommonDialogConstants.DialogOkId);Dialogs.DialogUtility.HideProgressMessage();Xrm.Page.ui.close()},function(response){Dialogs.DialogUtility.HideProgressMessage();Utilities.ClientApiUtility.ActionFailedCallback(response)})},function(response){Dialogs.DialogUtility.HideProgressMessage();Utilities.ClientApiUtility.ActionFailedCallback(response)})};SetRegarding.OpenAlertDialogForSetRegardingMultipleError=function(){var alertDialogStrings={text:Xrm.Utility.getResourceString(null,Utilities.ResourceStrings.multipleErrorsFound)};Xrm.Utility.openAlertDialog(alertDialogStrings).then(function(){Dialogs.DialogUtility.setLastButtonClicked(MetadataDrivenConstants.CommonDialogConstants.DialogOkId);Dialogs.DialogUtility.HideProgressMessage();Xrm.Page.ui.close()})};SetRegarding.PerformSaveRegardingMultiple=function(records,regardingObjectId,regardingEntityIdentifier,currentIndex,success){var regardingEntityName="";if(typeof regardingEntityIdentifier==="number")regardingEntityName=XrmClientApi.Internal.GetEntityName(regardingEntityIdentifier);else regardingEntityName=regardingEntityIdentifier;if(currentIndex>=records.length){Dialogs.DialogUtility.HideProgressMessage();if(!success){this.OpenAlertDialogForSetRegardingMultipleError();return}Dialogs.DialogUtility.setLastButtonClicked(MetadataDrivenConstants.CommonDialogConstants.DialogOkId);Xrm.Page.ui.close()}else{var regardingLookup={entityType:regardingEntityName,id:regardingObjectId},entityName=records[currentIndex].entityType,retrieveOptions="?select="+MetadataDrivenConstants.SetRegardingDialogConstants.RegardingObjectColumnName+","+MetadataDrivenConstants.SetRegardingDialogConstants.RegardingObjectTypeColumnName;Xrm.WebApi.retrieveRecord(entityName,records[currentIndex].id,retrieveOptions).then(function(entity){entity[MetadataDrivenConstants.SetRegardingDialogConstants.RegardingObjectColumnName]=regardingLookup;entity[MetadataDrivenConstants.SetRegardingDialogConstants.RegardingObjectTypeColumnName]=entityName;Xrm.WebApi.updateRecord(entityName,records[currentIndex].id,entity).then(function(entity){this.PerformSaveRegardingMultiple(records,regardingObjectId,regardingEntityName,currentIndex+1,success)},function(response){this.PerformSaveRegardingMultiple(records,regardingObjectId,regardingEntityName,currentIndex+1,false)})},function(response){this.PerformSaveRegardingMultiple(records,regardingObjectId,regardingEntityName,currentIndex+1,false)})}};return SetRegarding}();Dialogs.SetRegarding=SetRegarding})(Dialogs||(Dialogs={}));var Dialogs;(function(Dialogs){var DialogUtility=function(){function DialogUtility(){}DialogUtility.SerializeEntityReferences=function(records){return JSON.stringify(records)};DialogUtility.CloseDialogFromGridCallback=function(dialogParams,callbackParams){if(Xrm.Utility.getGlobalContext().client.getClient()==Xrm.Constants.ClientNames.web||dialogParams!=null&&dialogParams[MetadataDrivenConstants.CommonDialogConstants.LastButtonClicked]==MetadataDrivenConstants.CommonDialogConstants.DialogOkId){var gridControl=callbackParams[MetadataDrivenConstants.CommonDialogConstants.GridControl];gridControl!=null&&gridControl.refresh()}};DialogUtility.DeserializeSdkEntityReferences=function(stringifiedRecords){if(stringifiedRecords!=null&&stringifiedRecords.length>0)return [];return this.GetSdkEntityReference(JSON.parse(stringifiedRecords))};DialogUtility.GetSdkEntityReference=function(records){for(var entities=[],index=0;index<records.length;index++){var item=records[index],entity={name:item.Name!=null&&item.Name.length>0?item.Name:null,id:item.Id!=null&&item.Id.length>0?Utilities.Guid.newGuid():null,entityType:item.TypeName!=null&&item.TypeName.length>0?item.TypeName:null};entities[index]=entity}return entities};DialogUtility.ShowMoCAOfflineError=function(){var errorStrings={text:Xrm.Utility.getResourceString(null,Utilities.ResourceStrings.offline)};Xrm.Utility.openAlertDialog(errorStrings)};DialogUtility.ShowProgressMessage=function(){var processingMessage=Xrm.Utility.getResourceString(null,Utilities.ResourceStrings.progressMOCADialog);XrmClientApi.Internal.Progress(processingMessage,MetadataDrivenConstants.CommonDialogConstants.ProgressValue,MetadataDrivenConstants.CommonDialogConstants.ProgressMaxValue,MetadataDrivenConstants.CommonDialogConstants.ProgressMinValue)};DialogUtility.setLastButtonClicked=function(buttonId){var lastButtonClicked=Xrm.Page.getAttribute(MetadataDrivenConstants.CommonDialogConstants.LastButtonClicked);if(lastButtonClicked!=null){lastButtonClicked.setValue(buttonId);if(window!=null)if(typeof window["getDialogArguments"]==="function"){if(window["getDialogArguments"]()!=null)window["getDialogArguments"]()[MetadataDrivenConstants.CommonDialogConstants.LastButtonClicked]=lastButtonClicked}else if(window.parent!=null&&typeof window.parent["getDialogArguments"]==="function")if(window.parent["getDialogArguments"]()!=null)window.parent["getDialogArguments"]()[MetadataDrivenConstants.CommonDialogConstants.LastButtonClicked]=lastButtonClicked}};DialogUtility.HideProgressMessage=function(){XrmClientApi.Internal.Progress("",MetadataDrivenConstants.CommonDialogConstants.ProgressMaxValue,MetadataDrivenConstants.CommonDialogConstants.ProgressMaxValue,MetadataDrivenConstants.CommonDialogConstants.ProgressMinValue)};DialogUtility.GetDialogArguments=function(){if(window!=null)if(typeof window["getDialogArguments"]==="function"){if(window["getDialogArguments"]()!=null)return window["getDialogArguments"]()}else if(window.parent!=null&&typeof window.parent["getDialogArguments"]==="function")if(window.parent["getDialogArguments"]()!=null)return window.parent["getDialogArguments"]();return null};DialogUtility.IsMDDConverted=function(action,entityName){switch(action){case Xrm.Constants.ActionNames.activate:switch(entityName){case Xrm.Constants.EntityNames.Audit:case Xrm.Constants.EntityNames.CampaignResponse:case Xrm.Constants.EntityNames.ChannelAccessProfileRule:case Xrm.Constants.EntityNames.Contract:case Xrm.Constants.EntityNames.Service:case Xrm.Constants.EntityNames.SLA:case Xrm.Constants.EntityNames.SystemUser:case Xrm.Constants.EntityNames.Workflow:case Xrm.Constants.EntityNames.KbArticleTemplate:return false}break;case Xrm.Constants.ActionNames.deactivatecampactivity:return false;case Xrm.Constants.ActionNames.deactivate:switch(entityName){case Xrm.Constants.EntityNames.Audit:case Xrm.Constants.EntityNames.CampaignResponse:case Xrm.Constants.EntityNames.ChannelAccessProfileRule:case Xrm.Constants.EntityNames.Contract:case Xrm.Constants.EntityNames.Service:case Xrm.Constants.EntityNames.SLA:case Xrm.Constants.EntityNames.SystemUser:case Xrm.Constants.EntityNames.Workflow:case Xrm.Constants.EntityNames.KbArticleTemplate:return false}break;case Xrm.Constants.ActionNames.deleteaction:switch(entityName){case Xrm.Constants.EntityNames.Audit:case Xrm.Constants.EntityNames.Service:case Xrm.Constants.EntityNames.Workflow:case Xrm.Constants.EntityNames.HierarchyRule:return false}break;case Xrm.Constants.ActionNames.converttoopportunity:switch(entityName){case Xrm.Constants.EntityNames.ServiceAppointment:return false}break;case Xrm.Constants.ActionNames.converttocase:switch(entityName){case Xrm.Constants.EntityNames.ServiceAppointment:return false}break;case Xrm.Constants.ActionNames.assign:switch(entityName){case Xrm.Constants.EntityNames.Connection:case Xrm.Constants.EntityNames.DuplicateRule:case Xrm.Constants.EntityNames.EmailServerProfile:case Xrm.Constants.EntityNames.EmailSignature:case Xrm.Constants.EntityNames.Goal:case Xrm.Constants.EntityNames.GoalRollupQuery:case Xrm.Constants.EntityNames.ImportMap:case Xrm.Constants.EntityNames.Mailbox:case Xrm.Constants.EntityNames.MailMergeTemplate:case Xrm.Constants.EntityNames.PostFollow:case Xrm.Constants.EntityNames.Queue:case Xrm.Constants.EntityNames.Report:case Xrm.Constants.EntityNames.ServiceAppointment:case Xrm.Constants.EntityNames.SharePointDocumentLocation:case Xrm.Constants.EntityNames.SharePointSite:case Xrm.Constants.EntityNames.Workflow:return false}break}return true};DialogUtility.SerializeSdkEntityReferences=function(records){return JSON.stringify(this.GetSdkEntityReference(this.GetEntityReference(records)))};DialogUtility.GetEntityReference=function(records){for(var entities=[],i=0;i<records.length;i++){var item=records[i],entity={Name:item.name!=null?item.name:null,Id:item.id!=null?item.id:null,TypeName:item.entityType!=null?item.entityType:null};entities[entities.length]=entity}return entities};return DialogUtility}();Dialogs.DialogUtility=DialogUtility})(Dialogs||(Dialogs={}));var ActivityUtility;(function(ActivityUtility){var Activity=function(){function Activity(){}Activity.SetOwner=function(){var ownerId=Xrm.Page.data.entity.attributes.get("ownerid");try{ownerId!=null&&ownerId.getValue()==null&&ownerId.setValue(this.GetCurrentUser())}catch(Exception){}};Activity.GetCurrentUser=function(){var owner=Array();owner[0].id=Xrm.Utility.getGlobalContext().getUserId();owner[0].name=Xrm.Utility.getGlobalContext().getUserName();owner[0].entityType="systemuser";return owner};Activity.SetOrganizer=function(){try{var organizer=Xrm.Page.data.entity.attributes.get("organizer");if(organizer){var ownerId=Xrm.Page.data.entity.attributes.get("ownerid"),organizerValue=ownerId!=null&&ownerId.getValue()!=null?ownerId.getValue():this.GetCurrentUser();organizer.setValue(organizerValue)}}catch(Exception){}};Activity.CanAttachFile=function(entityIdentifier){var entityLogicalName="";if(typeof entityIdentifier==="number")entityLogicalName=XrmClientApi.Internal.GetEntityName(entityIdentifier);else entityLogicalName=entityIdentifier;if(Xrm.Constants.EntityNames.ActivityPointer==entityLogicalName||Xrm.Constants.EntityNames.Email==entityLogicalName)return false;else return true};return Activity}();ActivityUtility.Activity=Activity})(ActivityUtility||(ActivityUtility={}));var Utilities;(function(Utilities){var ClientApiUtility=function(){function ClientApiUtility(){}ClientApiUtility.OperationFailedCallback=function(response){var errorCode=response.errorCode,message=response.message,serializedException=response.debugMessage;this.HandleError(errorCode,message,serializedException)};ClientApiUtility.ActionFailedCallback=function(response){response!=null&&this.HandleError(response.errorCode,response.message,response.debugMessage)};ClientApiUtility.HandleError=function(errorCode,customErrorMessage,serializedException){var errorDetails={text:customErrorMessage},options={height:260,width:550};Xrm.Utility.openAlertDialog(errorDetails,options)};return ClientApiUtility}();Utilities.ClientApiUtility=ClientApiUtility})(Utilities||(Utilities={}));var Utilities;(function(Utilities){var CampaignActivityStateHandler=function(){function CampaignActivityStateHandler(){}CampaignActivityStateHandler.prototype.SetDates=function(actualStartDate,actualEndDate){this.SetDate(actualStartDate,Utilities.AttributeNames.actualstart);this.SetDate(actualEndDate,Utilities.AttributeNames.actualend)};CampaignActivityStateHandler.prototype.SetDate=function(date,dateFieldName){if(date==null)return;var dateString=date.toString();if(dateString==null||dateString.length==0)return;var dateValue;if(dateString.length>10)dateValue=new Date(Number(dateString.substr(0,4)),Number(dateString.substr(5,2))-1,Number(dateString.substr(8,2)),Number(dateString.substr(11,2)),Number(dateString.substr(14,2)),Number(dateString.substr(17,2)));else dateValue=new Date(Number(dateString.substr(0,4)),Number(dateString.substr(5,2))-1,Number(dateString.substr(8,2)));if(dateValue!=null){var dateField=Xrm.Page.getAttribute(dateFieldName);this.EnsureFieldEnabled(dateFieldName);dateField.setValue(dateValue)}};CampaignActivityStateHandler.prototype.UpdateState=function(){var stateField=Xrm.Page.getAttribute(Utilities.AttributeNames.statecode);stateField.addOnChange(this.SetCampaignActivityState)};CampaignActivityStateHandler.prototype.EnsureFieldEnabled=function(fieldName){this.SetFieldState(fieldName,false)};CampaignActivityStateHandler.prototype.SetFieldState=function(fieldName,desiredState){var control=Xrm.Page.ui.controls.get(fieldName);control!=null&&control.getDisabled()!=desiredState&&control.setDisabled(desiredState)};CampaignActivityStateHandler.prototype.SetCampaignActivityState=function(context){var stateField=Xrm.Page.getAttribute(Utilities.AttributeNames.statecode);stateField!=null&&Xrm.Page.ui.refreshRibbon();stateField.removeOnChange(this.SetCampaignActivityState)};return CampaignActivityStateHandler}();Utilities.CampaignActivityStateHandler=CampaignActivityStateHandler})(Utilities||(Utilities={}));var Utilities;(function(Utilities){var ResourceStrings;(function(ResourceStrings){ResourceStrings.offline="Error_Message_Generic_Mobile_Client_Offline";ResourceStrings.dialogDescription="label_DialogDescription";ResourceStrings.progressMOCADialog="Msg_Progress_MOCA_Dialog";ResourceStrings.setRegardingDescription="Dialog_SetRegarding_Description";ResourceStrings.multipleErrorsFound="Error_Message_Action_MultipleErrorsFound";ResourceStrings.noItemSelected="Error_Message_Action_NoItemSelected";ResourceStrings.gridApplyRuleHeterogenousActivityTypeRecordsSelected="Grid_Apply_Rule_Heterogenous_Activity_Type_Records_Selected";ResourceStrings.gridApplyRuleSocialActivityTypeRecordsSelectedForInvalidAction="Grid_Apply_Rule_Social_Activity_Type_Records_Selected_For_Invalid_Action";ResourceStrings.gridApplyRuleSelectedEmails="Grid_Apply_Rule_Selected_Emails";ResourceStrings.gridApplyRuleSelectedRecords="Grid_Apply_Rule_Selected_Records";ResourceStrings.GridActionDeactivateWorflow="Grid_Action_Deactivate_Worflow"})(ResourceStrings=Utilities.ResourceStrings||(Utilities.ResourceStrings={}));var AttributeNames;(function(AttributeNames){AttributeNames.actualstart="actualstart";AttributeNames.actualend="actualend";AttributeNames.statecode="statecode";AttributeNames.type="type"})(AttributeNames=Utilities.AttributeNames||(Utilities.AttributeNames={}))})(Utilities||(Utilities={}));var MetadataDrivenConstants;(function(MetadataDrivenConstants){var CommonDialogConstants;(function(CommonDialogConstants){CommonDialogConstants.DialogOkId="ok_id";CommonDialogConstants.EntityName="entityName";CommonDialogConstants.LastButtonClicked="lastButtonClicked";CommonDialogConstants.ProgressValue=40;CommonDialogConstants.ProgressMinValue=0;CommonDialogConstants.ProgressMaxValue=100;CommonDialogConstants.GridControl="gridControl";CommonDialogConstants.Records="records"})(CommonDialogConstants=MetadataDrivenConstants.CommonDialogConstants||(MetadataDrivenConstants.CommonDialogConstants={}));var SetRegardingDialogConstants;(function(SetRegardingDialogConstants){SetRegardingDialogConstants.RegardingObjectColumnName="regardingobjectid";SetRegardingDialogConstants.RegardingObjectTypeColumnName="regardingobjecttypecode";SetRegardingDialogConstants.RegardingControlName="regarding_id";SetRegardingDialogConstants.ActivityLogicalName="activitypointer"})(SetRegardingDialogConstants=MetadataDrivenConstants.SetRegardingDialogConstants||(MetadataDrivenConstants.SetRegardingDialogConstants={}));var DeactivateDialogConstants;(function(DeactivateDialogConstants){DeactivateDialogConstants.StateId="state_id";DeactivateDialogConstants.StatusId="status_id";DeactivateDialogConstants.Action="action";DeactivateDialogConstants.DefaultCloseState="defaultCloseState"})(DeactivateDialogConstants=MetadataDrivenConstants.DeactivateDialogConstants||(MetadataDrivenConstants.DeactivateDialogConstants={}))})(MetadataDrivenConstants||(MetadataDrivenConstants={}));var Utilities;(function(Utilities){var Guid=function(){function Guid(){}Guid.newGuid=function(){return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=Math.random()*16|0,v=c=="x"?r:r&3|8;return v.toString(16)})};return Guid}();Utilities.Guid=Guid;var String=function(){function String(){}String.Stringformat=function(listOfStrings){for(var sourceString=listOfStrings[0],i=1;i<listOfStrings.length;i++){var regEx=new RegExp("\\{"+(i-1)+"\\}","gm");sourceString=sourceString.replace(regEx,listOfStrings[i])}return sourceString};return String}();Utilities.String=String})(Utilities||(Utilities={}))