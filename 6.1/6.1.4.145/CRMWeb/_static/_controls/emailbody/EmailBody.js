function unblock(emailId,wrpcTokenAsQueryString){if(window.confirm(LOCID_WARN_HARMFUL_CONTENT)){var o=openStdWin(Mscrm.CrmUri.create("/_controls/emailbody/msgBody.aspx?unblockContent=1&id="+emailId+"&entityType=email"+wrpcTokenAsQueryString),null,700,500,"menubar=1,status=1,resizable=1,scrollbars=1");o.opener=null;o.focus()}}function BuildChooseTemplateTargetList(){var aTargets=[];AddRecipients(aTargets,"regardingobjectid","re");AddRecipients(aTargets,"to","to");AddRecipients(aTargets,"cc","cc");return aTargets}function AddRecipients(aTargets,aTargetControlId,sTargetControlSource){var aTargetControl=Mscrm.FormControlInputBehavior.GetBehaviorForForm(aTargetControlId);if(!IsNull(aTargetControl))for(var recipients=aTargetControl.Items(),i=0;i<recipients.length;i++){recipients[i].source=sTargetControlSource;aTargets.push(recipients[i])}}function ChooseTemplateTarget(aTargets,storedRange){for(var sUrl="/activities/email/dlg_template_target.aspx?",oSelectedId,oSelectedType,nObjects=0,bConflicts=false,iId,oIds="",oTypes="",oNames="",oParts="",i=0;i<aTargets.length;i++)if(isValidTemplateObjectType(aTargets[i].type)){nObjects++;oIds+=(i>0?";":"")+CrmEncodeDecode.CrmUrlEncode(aTargets[i].id);oTypes+=(i>0?";":"")+CrmEncodeDecode.CrmUrlEncode(aTargets[i].type);oNames+=(i>0?";":"")+CrmEncodeDecode.CrmUrlEncode(aTargets[i].name);oParts+=(i>0?";":"")+CrmEncodeDecode.CrmUrlEncode(aTargets[i].source);oSelectedId=aTargets[i].id;oSelectedType=aTargets[i].type;if(!bConflicts){if(IsNull(iId))iId=oSelectedId;bConflicts=iId!=oSelectedId}}var sUrlElement="oids="+oIds+"&otypes="+oTypes+"&onames="+oNames+"&oparts="+oParts;if(nObjects==0){var RegardingItems=Mscrm.FormControlInputBehavior.GetBehaviorForForm("regardingobjectid").Items();if(RegardingItems.length>0&&RegardingItems[0].type==BulkOperation)alert(LOCID_EMAIL_CHANGE_REGARDING);else alert(LOCID_EMAIL_RECIPIENT_TMPLT_RQD);return null}if(nObjects>1&&bConflicts){if(sUrl.length+sUrlElement.length>2e3){alert(LOCID_EMAIL_TOO_MANY_TARGETS);return}sUrl+=sUrlElement;var parameters=new Array(storedRange),oUrl=Mscrm.CrmUri.create(sUrl),crmDialog=new Mscrm.CrmDialog(oUrl,null,540,350,null);crmDialog.setCallbackInfo("templateTargetCallback",this,parameters);crmDialog.show();return}return new TemplateTarget(oSelectedId,oSelectedType)}function templateTargetCallback(sResponse,storedRange){if(sResponse==null)ApplyTemplate(true,null,storedRange);else{oSelectedId=sResponse.oid;oSelectedType=sResponse.otype;ApplyTemplate(true,new TemplateTarget(oSelectedId,oSelectedType),storedRange)}}function ApplyTemplate(skipDialog,oTarget,storedRange){if(IsNull(storedRange))if(Mscrm.Utilities.isIE10OrLower())storedRange=document.selection.createRange();else storedRange=document.getSelection();if(!IsNull(storedRange)&&storedRange.boundingHeight==0&&storedRange.boundingWidth==0&&storedRange.boundingLeft==0&&storedRange.boundingTop==0)storedRange=null;if(IsNull(skipDialog)||!skipDialog){var aTargets=BuildChooseTemplateTargetList();oTarget=ChooseTemplateTarget(aTargets,storedRange)}if(oTarget==null)return;var oUrl,qsUrl=Mscrm.CrmUri.create(window.location.search),emailId=qsUrl.get_query()["id"];if(IsNull(emailId)){var extraqs=qsUrl.get_query()["extraqs"],recordId=null;if(!IsNull(extraqs)){extraqs=CrmEncodeDecode.CrmUrlDecode(extraqs);recordId=Mscrm.CrmUri.create(extraqs).get_query()["id"];emailId=recordId}if(IsNull(recordId)){recordId=Xrm.Page.data.entity.getId();emailId=recordId!=""?recordId:null}}var richClient="";if(isRichClient())richClient="&richClient=1";if(emailId!=null)oUrl=Mscrm.CrmUri.create("/_grid/cmds/dlg_bulkemail.aspx?bulkemail=false&objectTypeCode="+oTarget.otype+"&objectId="+oTarget.oid+"&targetId="+emailId+"&targetType=4202"+richClient);else oUrl=Mscrm.CrmUri.create("/_grid/cmds/dlg_bulkemail.aspx?bulkemail=false&objectTypeCode="+oTarget.otype+"&objectId="+oTarget.oid+richClient);var parameters=[oTarget,storedRange],crmDialog=new Mscrm.CrmDialog(oUrl,null,540,450,null);crmDialog.setCallbackInfo("performActionAfterSelectTemplate",this,parameters);crmDialog.show()}function performActionAfterSelectTemplate(sResponse,oTarget,storedRange){if(sResponse!=null)if(isRichClient())getOutlookHostedWindow().insertTemplateMessageData(sResponse.tmplId,oTarget.oid,oTarget.otype);else{var descriptionElement=Mscrm.FormControlInputBehavior.GetBehaviorForForm("description"),oldDescription=descriptionElement.get_dataValue();InsertHtmlIntoHtmlBody(sResponse.EmailBody,storedRange);var newDescription=descriptionElement.get_dataValue();oldDescription!=newDescription&&descriptionElement.fireOnChange();var subjectCtrl=Xrm.Page.data.entity.attributes.get("subject"),sEmailSubject=subjectCtrl.getValue();if(!IsNull(sEmailSubject)&&sEmailSubject.length>0)if(!confirm(LOCID_EMAIL_REPLACE_SUBJECT))return;subjectCtrl.setValue(CrmEncodeDecode.CrmHtmlDecode(sResponse.EmailSubject).substr(0,subjectCtrl.getMaxLength()));sEmailSubject!=subjectCtrl.getValue()&&subjectCtrl.fireOnChange();try{auto(ActivityMimeAttachment)}catch(e){}}}function isValidTemplateObjectType(nObjectType){return nObjectType!=Queue&&nObjectType!=BulkOperation&&nObjectType!=UnresolvedEmailParty}function TemplateTarget(oid,otype){this.oid=oid;this.otype=otype}function InsertKBArticle(){var lookupItems=LookupKBArticle();Mscrm.Utilities.isModalDialogSupported()&&performActionAfterKBLookup(lookupItems)}function performActionAfterKBLookup(lookupItems){var oId=GetFirstLookupItem(lookupItems);RecordEntityUsed(KbArticle,oId);InsertKBArticleIntoEmailBody(oId)}function RecordEntityUsed(iType,oId){if(IsNull(iType)||iType==0||IsNull(oId))return;var oCommand=new RemoteCommand("MruWebService","RecordEntityUsed");oCommand.SetParameter("entityType",iType);oCommand.SetParameter("entityId",oId);oCommand.Execute()}function LookupKBArticle(){var oUrl=Mscrm.CrmUri.create("/CS/dialogs/KBSearch.aspx?HideEmailButton=true"),crmDialog=new Mscrm.CrmDialog(oUrl,null,700,500,null);crmDialog.setCallbackInfo("performActionAfterKBLookup",this,null);return crmDialog.show()}function LookupSalesLiterature(){var lookupItems=LookupObjects(null,"single",SalesLiterature,0);return GetFirstLookupItem(lookupItems)}function GetFirstLookupItem(lookupItems){if(!IsNull(lookupItems))if(lookupItems.items.length>0)return lookupItems.items[0].id;return null}function InsertKBArticleIntoEmailBody(oId){if(!IsNull(oId)){oUrl=Mscrm.CrmUri.create("/CS/articles/viewer/content.aspx");oUrl.get_query()["id"]=oId;var oXmlHttp=new XMLHttpRequest;oXmlHttp.open("POST",oUrl.toString(),false);oXmlHttp.send("");if(oXmlHttp.responseText!=null){var descriptionElement=Mscrm.FormControlInputBehavior.GetBehaviorForForm("description"),oldDescription=descriptionElement.get_dataValue();InsertHtmlIntoHtmlBody(oXmlHttp.responseText);var newDescription=descriptionElement.get_dataValue();oldDescription!=newDescription&&descriptionElement.fireOnChange()}}}function InsertHtmlIntoHtmlBody(sHtmlToInsert){InsertHtmlIntoHtmlBody(sHtmlToInsert,null)}function InsertHtmlIntoHtmlBody(sHtmlToInsert,range){if(isRichClient())getOutlookHostedWindow().InsertHtmlIntoHtmlBody(sHtmlToInsert);else Mscrm.FormControlInputBehavior.GetBehaviorForForm("description").InsertValue(sHtmlToInsert,range)}