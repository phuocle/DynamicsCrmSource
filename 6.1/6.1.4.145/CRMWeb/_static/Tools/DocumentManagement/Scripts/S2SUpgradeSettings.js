Type.registerNamespace("Mscrm");Mscrm.SPSiteRecord=function(){};Mscrm.SPSiteRecord.prototype={$1_0:null,$3_0:null,$9_0:null,$0_0:null,get_parentSite:function(){return this.$1_0},set_parentSite:function(value){this.$1_0=value;return value},get_relativeUrl:function(){return this.$3_0},set_relativeUrl:function(value){this.$3_0=value;return value},get_absoluteUrl:function(){return this.$0_0},set_absoluteUrl:function(value){this.$0_0=value;return value},get_name:function(){return this.$9_0},set_name:function(value){this.$9_0=value;return value}};Mscrm.S2SUpgradePageHelper=function(){};Mscrm.S2SUpgradePageHelper.initializeControls=function(){var $v_0=$get("txtSiteCollectionUrl");if(window.WizardHasProperty("DefaultSiteUrl"))$v_0.value=window.WizardGetProperty("DefaultSiteUrl")};Mscrm.S2SUpgradePageHelper.$L=function(){var $v_0=window.bGrayTextOn;return $v_0?Mscrm.InternalUtilities._String.Empty:$get("txtSiteCollectionUrl").value};Mscrm.S2SUpgradePageHelper.savePageProperties=function(){var $v_0=Mscrm.S2SUpgradePageHelper.$L();if(isNullOrEmptyString($v_0)){window.WizardSetProperty("DefaultSiteUrl",$v_0);return true}var $v_1=Mscrm.CrmUri.create($v_0);if($v_1.get_host().toUpperCase()==="LOCALHOST"){alert(window.LOCID_DOCM_LOCALHOST_URL);return false}var $v_2=Mscrm.CrmUri.create(window.location.href);$v_2.get_scheme()!==$v_1.get_scheme()&&alert(window.LOCID_DOCM_MIXEDMODE_WARNING);window.WizardSetProperty("DefaultSiteUrl",$v_0);return true};Mscrm.S2SUpgradePageHelper.migrateToS2S=function(){var $v_0=window.WizardGetProperty("DefaultSiteUrl"),$v_1=2;if(!isNullOrEmptyString($v_0)){if(validateUrlProtocol($v_0)===$v_1){alert(window.LOCID_DOCM_INVALIDURL);return}var $v_8=Mscrm.CrmUri.create($v_0);if(!($v_8.get_scheme()==="http"||$v_8.get_scheme()==="https")){alert(window.LOCID_DOCM_INVALIDURL);return}var $v_9=Mscrm.Utilities.trimEnd($v_8.get_path().toLowerCase(),["/"]);if($v_9.endsWith(".aspx")||$v_9.endsWith(".ashx")||$v_9.endsWith(".asmx")||$v_9.endsWith(".svc")){alert(window.LOCID_DOCM_URLCANNOTBEPAGE);return}if($v_0.endsWith("/"))$v_0=$v_0.substr(0,$v_0.length-1)}var $v_2=$get("descriptionHeader"),$v_3=$get("siteUrlTable"),$v_4=$get("noteSummaryLabel"),$v_5=$get("showProgress"),$v_6=$get("S2SSitesMessage"),$v_7=$get("S2SChangesMessage");$v_2.style.display="none";$v_3.style.display="none";$v_4.style.display="none";$v_7.style.display="none";$v_6.style.display="none";$v_5.style.display="block";Mscrm.CrmHeader.setScriptFile(Mscrm.CrmUri.create("/_static/_common/scripts/jquery-1.11.3.min.js"),true);Mscrm.CrmHeader.setScriptFile(Mscrm.CrmUri.create("/_static/_common/scripts/CrmServiceProxyFramework.js"),true);Mscrm.CrmHeader.setScriptFile(Mscrm.CrmUri.create("/_static/_common/scripts/CrmServiceProxy.js"),true);Xrm.Internal.messages.migrateToS2S($v_0).then(function($p1_0){Mscrm.S2SUpgradePageHelper.$H($p1_0)},Mscrm.S2SUpgradePageHelper.$B)};Mscrm.S2SUpgradePageHelper.$H=function($p0){window.WizardNavigate(_WizardNavigateEnum.NEXT)};Mscrm.S2SUpgradePageHelper.finalizeSettings=function(){if(window.parent.opener){window.parent.opener.location.reload();window.WizardNavigate(_WizardNavigateEnum.CLOSE)}};Mscrm.S2SUpgradePageHelper.enableFeature=function(){Mscrm.CrmHeader.setScriptFile(Mscrm.CrmUri.create("/_static/_common/scripts/jquery-1.11.3.min.js"),true);Mscrm.CrmHeader.setScriptFile(Mscrm.CrmUri.create("/_static/_common/scripts/CrmServiceProxyFramework.js"),true);Mscrm.CrmHeader.setScriptFile(Mscrm.CrmUri.create("/_static/_common/scripts/CrmServiceProxy.js"),true);var $v_0=$get("showProgress"),$v_1=$get("buttonNext");Xrm.Internal.messages.upgradeToS2S().then(function(){$v_0.style.display="none";Mscrm.Utilities.enableDisableDomElement($v_1,false)},Mscrm.S2SUpgradePageHelper.$B)};Mscrm.S2SUpgradePageHelper.$B=function($p0){var $v_0=$get("showProgress"),$v_1=$p0.get_organizationServiceFault();if(!IsNull($v_1)){var $v_2=$v_1.get_errorCode();Xrm.Internal.openErrorDialog($v_2,$p0.get_message());$v_2===-2147188651&&window.location.reload()}if($v_0)$v_0.style.display="none"};Mscrm.S2SUpgradePageHelper.retrieveSites=function(){var $v_0="<fetch version='1.0' mapping='logical'><entity name='sharepointsite'><attribute name='absoluteurl' /><attribute name='relativeurl' /><attribute name='name' /><attribute name='sharepointsiteid' /><attribute name='parentsite' /><filter type='and'><condition attribute='statecode' operator='eq' value='0' /></filter></entity></fetch>";Mscrm.CrmHeader.setScriptFile(Mscrm.CrmUri.create("/_static/_common/scripts/jquery-1.11.3.min.js"),true);Mscrm.CrmHeader.setScriptFile(Mscrm.CrmUri.create("/_static/_common/scripts/CrmServiceProxyFramework.js"),true);Mscrm.CrmHeader.setScriptFile(Mscrm.CrmUri.create("/_static/_common/scripts/CrmServiceProxy.js"),true);Xrm.Internal.messages.retrieveMultiple($v_0).then(function($p1_0){Mscrm.S2SUpgradePageHelper.$I($p1_0)},Mscrm.S2SUpgradePageHelper.$B)};Mscrm.S2SUpgradePageHelper.$I=function($p0){var $v_0=$get("buttonNext");Mscrm.Utilities.enableDisableDomElement($v_0,true);var $v_1=$p0.get_entityCollection();if($v_1.get_count()>0){Mscrm.S2SUpgradePageHelper.$4=$v_1.get_count();$get("SiteValidationStatus").style.display="";$get("SiteValidationCounts").style.display="";$get("StatusReportSectionHeader").style.display="";$get("StatusReportSectionData").style.display="";$get("StatusReportSectionData").style.height="250px";$get("statusDiv").style.height="250px";var $v_2=$get("ToValidate");XUI.Html.SetText($v_2,Mscrm.S2SUpgradePageHelper.$4.toString());var $v_3=$get("TotalValid");XUI.Html.SetText($v_3,window.LOCID_SP_VALIDATION_IN_PROGRESS);var $v_4=$get("TotalInvalid");XUI.Html.SetText($v_4,window.LOCID_SP_VALIDATION_IN_PROGRESS);var $v_5=Mscrm.InternalUtilities._String.Empty,$v_6=Mscrm.InternalUtilities._String.Empty,$v_7;Mscrm.S2SUpgradePageHelper.$6={};Mscrm.S2SUpgradePageHelper.$7=[];for($v_7=0;$v_7<Mscrm.S2SUpgradePageHelper.$4;$v_7++){var $v_8=new Mscrm.SPSiteRecord;$v_8.$1_0=IsNull($v_1.get_item($v_7).getFormattedValue("parentsite"))?Microsoft.Dynamics.Client.Core.Framework.Guid.get_empty():$v_1.get_item($v_7).getFormattedValue("parentsite").Id;$v_8.$0_0=IsNull($v_1.get_item($v_7).getFormattedValue("absoluteurl"))?Mscrm.InternalUtilities._String.Empty:$v_1.get_item($v_7).getFormattedValue("absoluteurl").toString();$v_8.$3_0=IsNull($v_1.get_item($v_7).getFormattedValue("relativeurl"))?Mscrm.InternalUtilities._String.Empty:$v_1.get_item($v_7).getFormattedValue("relativeurl").toString();$v_8.$9_0=IsNull($v_1.get_item($v_7).getFormattedValue("name"))?Mscrm.InternalUtilities._String.Empty:$v_1.get_item($v_7).getFormattedValue("name").toString();Mscrm.S2SUpgradePageHelper.$6[$v_1.get_item($v_7).getFormattedValue("sharepointsiteid").toString()]=$v_8}$v_7=0;var $$dict_A=Mscrm.S2SUpgradePageHelper.$6;for(var $$key_B in $$dict_A){var $v_9={key:$$key_B,value:$$dict_A[$$key_B]},$v_A=$v_9.value;if(!isNullOrEmptyString($v_A.$0_0))$v_6=$v_A.$0_0;else $v_6=String.format("{0}/{1}",Mscrm.Utilities.trimEnd(Mscrm.S2SUpgradePageHelper.$D($v_A.$1_0),["/"]),$v_A.$3_0,Sys.CultureInfo.InvariantCulture);$v_5=$v_A.$9_0;Mscrm.S2SUpgradePageHelper.$7[$v_7++]=$v_6;Mscrm.S2SUpgradePageHelper.$G($v_5,$v_6,$v_7)}Mscrm.S2SUpgradePageHelper.$F(Mscrm.S2SUpgradePageHelper.$7[0].toString())}else $get("NoSitesFound").style.display=""};Mscrm.S2SUpgradePageHelper.$D=function($p0){var $v_0=Mscrm.S2SUpgradePageHelper.$6[$p0.toString()];if($v_0.$1_0.equals(Microsoft.Dynamics.Client.Core.Framework.Guid.get_empty()))return $v_0.$0_0.endsWith("/")?$v_0.$0_0.substr(0,$v_0.$0_0.length-1):$v_0.$0_0;else return String.format("{0}/{1}",Mscrm.Utilities.trimEnd(Mscrm.S2SUpgradePageHelper.$D($v_0.$1_0),["/"]),$v_0.$3_0,Sys.CultureInfo.InvariantCulture)};Mscrm.S2SUpgradePageHelper.$F=function($p0){var $v_0=String.format("<siteUrlsXml><siteUrl url='{0}'>false</siteUrl></siteUrlsXml>",$p0,Sys.CultureInfo.InvariantCulture);Xrm.Internal.messages.validateUrl($v_0).then(function($p1_0){Mscrm.S2SUpgradePageHelper.$K($p1_0)},Mscrm.S2SUpgradePageHelper.$J)};Mscrm.S2SUpgradePageHelper.$J=function($p0){var $v_0=$p0.get_organizationServiceFault();if(!IsNull($v_0)){var $v_1=$v_0.get_errorCode();Xrm.Internal.openErrorDialog($v_1,$p0.get_message())}Mscrm.S2SUpgradePageHelper.$2++;Mscrm.S2SUpgradePageHelper.$C(window.LOCID_SP_VALIDATION_INVALID," mscrm-text-regular");Mscrm.S2SUpgradePageHelper.$E()};Mscrm.S2SUpgradePageHelper.$K=function($p0){var $v_0=$p0.get_urlValidationResult(),$v_1=XUI.Xml.LoadXml($v_0),$v_2=XUI.Xml.SelectNodes($v_1,"/siteUrlsXml/siteUrl",null),$v_3=$v_2[0],$v_4=XUI.Xml.GetText($v_3);if($v_4.toLowerCase()==="true"){Mscrm.S2SUpgradePageHelper.$A++;Mscrm.S2SUpgradePageHelper.$C(window.LOCID_SP_VALIDATION_VALID," mscrm-text-semiBold")}else{Mscrm.S2SUpgradePageHelper.$2++;Mscrm.S2SUpgradePageHelper.$C(window.LOCID_SP_VALIDATION_INVALID," mscrm-text-regular")}Mscrm.S2SUpgradePageHelper.$E()};Mscrm.S2SUpgradePageHelper.$E=function(){Mscrm.S2SUpgradePageHelper.$5++;if(Mscrm.S2SUpgradePageHelper.$5===Mscrm.S2SUpgradePageHelper.$4){var $v_0=$get("TotalValid");XUI.Html.SetText($v_0,Mscrm.S2SUpgradePageHelper.$A.toString());var $v_1=$get("TotalInvalid");XUI.Html.SetText($v_1,Mscrm.S2SUpgradePageHelper.$2.toString());if(!Mscrm.S2SUpgradePageHelper.$2){$get("StatusReportSectionData").style.height="138px";$get("statusDiv").style.height="138px";var $v_2=$get("ValidSitesMessage");$v_2.style.display="";var $v_3=$get("buttonNext");Mscrm.Utilities.enableDisableDomElement($v_3,false)}else{$get("StatusReportSectionData").style.height="160px";$get("statusDiv").style.height="160px";var $v_4=$get("InvalidSitesMessage");$v_4.style.display=""}}else Mscrm.S2SUpgradePageHelper.$F(Mscrm.S2SUpgradePageHelper.$7[Mscrm.S2SUpgradePageHelper.$5])};Mscrm.S2SUpgradePageHelper.$C=function($p0,$p1){var $v_0=$get(Mscrm.S2SUpgradePageHelper.$5+1+"_validateStatusCell");$v_0.innerHTML="";XUI.Html.SetText($v_0,$p0);$v_0.className+=$p1;$v_0.setAttribute("title",$p0)};Mscrm.S2SUpgradePageHelper.$G=function($p0,$p1,$p2){var $v_0=$get("StatusReportTable"),$v_1=$v_0.insertRow(-1);$v_1.id=$p2.toString();var $v_2=document.createElement("label");XUI.Html.SetText($v_2,$p0);$v_2.setAttribute("title",$p0);var $v_3=$v_1.insertCell(-1);$v_3.id=$p2+"_dlNameCell";$v_3.className="mscrm-text-regular mscrm-text-dark mscrm-siteTable-RowColumn";$v_3.appendChild($v_2);$v_1.appendChild($v_3);var $v_4=document.createElement("a");$v_4.setAttribute("title",$p1);$v_4.setAttribute("href",$p1);$v_4.setAttribute("target","_blank");$v_4.className="ms-crm-gridUrl";XUI.Html.SetText($v_4,$p1);$v_4.style.cursor="pointer";var $v_5=$v_1.insertCell(-1);$v_5.id=$p2+"_siteUrlCell";$v_5.className="mscrm-text-regular mscrm-text-dark mscrm-siteTable-RowColumn";$v_5.appendChild($v_4);$v_1.appendChild($v_5);var $v_6=document.createElement("img");$v_6.setAttribute("src","/_imgs/ico/16_progress.gif");$v_6.setAttribute("alt",window.LOCID_SP_CREATEDL_INPROGRESS);var $v_7=$v_1.insertCell(-1);$v_7.id=$p2+"_validateStatusCell";$v_7.appendChild($v_6);$v_1.appendChild($v_7);$v_7.className="mscrm-siteTable-RowColumn";$v_1.scrollIntoView()};Mscrm.SPSiteRecord.registerClass("Mscrm.SPSiteRecord");Mscrm.S2SUpgradePageHelper.registerClass("Mscrm.S2SUpgradePageHelper");Mscrm.S2SUpgradePageHelper.$A=0;Mscrm.S2SUpgradePageHelper.$2=0;Mscrm.S2SUpgradePageHelper.$4=0;Mscrm.S2SUpgradePageHelper.$5=0;Mscrm.S2SUpgradePageHelper.$6=null;Mscrm.S2SUpgradePageHelper.$7=null