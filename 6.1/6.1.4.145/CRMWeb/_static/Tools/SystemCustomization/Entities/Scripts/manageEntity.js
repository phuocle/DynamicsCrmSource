var _oConst={sInvalidSchemaNameChars:"[^A-Za-z0-9_]",sCheckBoxIdFormat:"chkDA{0}",sEntityEditorUrlFormat:"/tools/systemcustomization/Entities/manageEntity.aspx?entityId={0}",sInformationPageId:"divInformation",sFormsPageId:"divForms",sViewsPageId:"divViews",sUIElementsPageId:"divUIElements",sVisualizationsPageId:"divVisualizations",sAttributesPageId:"divAttributes",sRelationshipsPageId1ToN:"divRelationships1ToN",sRelationshipsPageIdNTo1:"divRelationshipsNTo1",sRelationshipsPageIdNToN:"divRelationshipsNToN",sMessagesPageId:"divMessages",sBusinessRulesListPage:"divBusinessRules"},_oMessages={sPublishAlert:LOCID_MANENT_PUBLISHALERT,sCloseAlert:LOCID_FORMS_SAVE_CONFIRM_TITLE,sPublishUnsavedAlert:LOCID_MESSAGE_PUBLISHUNSAVED},_bSaving=false,_bReadyState=false,_sInputXml="",_txtSingularName;Sys.Application.add_load(ManageEntityJsWindowOnLoad);Sys.Application.add_unload(ManageEntityJsWindowOnUnLoad);function ManageEntityJsWindowOnLoad(){_bReadyState=true;!_bCreate&&window.focus();_sInputXml=getEntityXml();loadPage(_oConst.sInformationPageId);_txtSingularName=Mscrm.FormControlInputBehavior.GetBehavior("txtSingularName");!_txtSingularName.get_disabled()&&_txtSingularName.setFocus();$addHandler(document,"keydown",ProcessKeyDown);attachWindowOnBeforeUnload(window_onbeforeunload)}function ManageEntityJsWindowOnUnLoad(){$removeHandler(document,"keydown",ProcessKeyDown)}function window_onbeforeunload(oEvent){oEvent=oEvent.rawEvent;if(!_bSaving&&isFormDirty())oEvent.returnValue=_oMessages.sCloseAlert}function _save(){saveEntityAction(false)}function _saveandclose(){saveEntityAction(true)}function _saveandnew(){}function CallbackParams(bClose,bReload,bRefreshGrid,bRerfreshMsgGrid){this.bClose=bClose;this.bReload=bReload;this.bRefreshGrid=bRefreshGrid;this.bRerfreshMsgGrid=bRerfreshMsgGrid}function remoteEntityCommandCallback(oResult,oCallbackParams){if(oResult.Success||oResult.get_success&&oResult.get_success()){if(oResult.Success){if(oResult.RemoteCommand.Command==_oEntUtlConst.sCreateEntityCommand)_sEntityId=oResult.ReturnValue}else if(oResult.get_remoteCommandXml().get_command()==_oEntUtlConst.sCreateEntityCommand){var iEntityIdStart=oResult.get_returnValue().indexOf("<entityid>");if(iEntityIdStart!=-1){iEntityIdStart+=10;_sEntityId=CrmEncodeDecode.CrmXmlDecode(oResult.get_returnValue().substring(iEntityIdStart,oResult.get_returnValue().indexOf("</entityid>")))}}if(oCallbackParams.bRefreshGrid){try{window.opener.$find("gridEntities").Refresh()}catch(e){}RefreshSolutionExplorer()}if(oCallbackParams.bClose){CloseEntityEditor();return false}if(oCallbackParams.bReload){var frmReload=$get("frmReloadId");frmReload.action=Mscrm.CrmUri.create(formatString(_oConst.sEntityEditorUrlFormat,_sEntityId));frmReload.submit();return false}oCallbackParams.bRerfreshMsgGrid&&refreshMsgGrid()}_bSaving=false;return true}function RefreshSolutionExplorer(){try{var pagemode=document.getElementById("pagemode");if(!IsNull(pagemode)&&pagemode.value=="iframe")PageOnloadCallBack();else{var grid=window.opener.$find(getGridId(window.opener));grid.Refresh();window.opener.Mscrm.TreeNavControl.refreshTree()}}catch(e){}}function CloseEntityEditor(){var pagemode=document.getElementById("pagemode");if(!IsNull(pagemode)&&pagemode.value=="iframe")Mscrm.TreeNavControl.navigateToNode("9801");else closeWindow()}function PageOnloadCallBack(){try{var pagemode=document.getElementById("pagemode");!IsNull(pagemode)&&pagemode.value=="iframe"&&Mscrm.TreeNavControl.iFrameOnLoadCallBack()}catch(e){}}function saveEntityAction(bClose){if(!_bSaving&&validateParameters()){_bSaving=true;var sDataXml=getEntityXml(),oCallbackParams=new CallbackParams(bClose,true,true,false);if(_bCreate)createEntity(sDataXml,remoteEntityCommandCallback,oCallbackParams);else if(isFormDirty())updateEntity(sDataXml,remoteEntityCommandCallback,oCallbackParams);else if(bClose){CloseEntityEditor();return}else _bSaving=false}}function deleteEntityAction(){var uri=Mscrm.CrmUri.create("/_grid/cmds/dlg_delete.aspx?iObjType=9801&iTotal=1"),ids=[];ids[0]=_sEntityId;var crmDialog=new Mscrm.CrmDialog(uri,ids,570,205,null);crmDialog.setCallbackInfo("performActionAfterDelete",this,null);crmDialog.show()}function performActionAfterDelete(result){if(!IsNull(result)){try{var pagemode=$get("pagemode");if(!IsNull(pagemode)&&pagemode.value=="iframe")PageOnloadCallBack();else{var grid=window.opener.$find(getGridId(window.opener));grid.Refresh();window.opener.Mscrm.TreeNavControl.refreshTree()}}catch(e){}CloseEntityEditor()}}function showDependencyAction(){Mscrm.Dependency.launchDependencyDlg(Mscrm.EntityTypeCode.Entity,_sEntityId)}function managedPropertyAction(){Mscrm.ManagedPropertyUtil.launchManagedPropertyDlg(Mscrm.EntityTypeCode.Entity,_sEntityId)}function publishEntityAction(){if(!isFormDirty()||confirm(_oMessages.sPublishAlert)){var oDataXml=createXmlDoc(_oTags.publish),oEntitiesXml=addXmlNode(oDataXml,_oTags.entities);addTextXmlNode(oEntitiesXml,_oTags.entity,_sEntityId);var sDataXml=convertXmlDocToString(oDataXml),oCallbackParams=new CallbackParams(false,false,true,true);publishEntities(sDataXml,1,remoteEntityCommandCallback,oCallbackParams)}}function publishEntitiesAllAction(){var isDirty=isFormDirty();if(!isDirty||isDirty&&confirm(_oMessages.sPublishUnsavedAlert)){var oCallbackParams=new CallbackParams(false,false,true,true);publishEntitiesAll(remoteEntityCommandCallback,oCallbackParams)}}function updateEntityIconsAction(){var retVal=updateEntityIcons(_sEntityId,true);!IsNull(retVal)&&retVal&&RefreshSolutionExplorer()}var _oVisiblePage=null;function loadPage(sPageId,ev){var oPage=$get(sPageId);if(!IsNull(_oVisiblePage))_oVisiblePage.style.display="none";_oVisiblePage=oPage;_oVisiblePage.style.display="inline";if(sPageId!=_oConst.sInformationPageId){var oIFrameElement=XUI.Html.DomUtils.GetFirstChild(XUI.Html.DomUtils.GetFirstChild(oPage));if(oIFrameElement.src.indexOf("/_static/blank.htm")>-1)oIFrameElement.src=oIFrameElement.getAttribute("url")}var target=Mscrm.Utilities.getEventTarget(ev);!IsNull(target)&&Mscrm.Details.resetBreadcrumb(target);PageOnloadCallBack()}function getEntityXml(){var oDataXml=createXmlDoc(_oTags.entity),addEvenWhenDisabled=_bCreate;addTextXmlNode(oDataXml,_oTags.entityid,_sEntityId);addSchemaXml(oDataXml,addEvenWhenDisabled);addDisplayAreaXml(oDataXml);addActivityXml(oDataXml);addRichClientXml(oDataXml,addEvenWhenDisabled);addMailMergeXml(oDataXml,addEvenWhenDisabled);addAccessTeamXml(oDataXml);addDuplicateDetectionXml(oDataXml);addAssociatedEntityXml(oDataXml,addEvenWhenDisabled);addConnectionsXml(oDataXml,true);addAuditXml(oDataXml);addDocumentManagementXml(oDataXml);addBusinessProcessXml(oDataXml);addCollaborationXml(oDataXml);addVisibleInMobileXml(oDataXml);addReadingPaneEnabledXml(oDataXml);addPrimaryAttributeXml(oDataXml);addQuickCreateXml(oDataXml);addPrimaryImageXml(oDataXml);return convertXmlDocToString(oDataXml)}function addSchemaXml(oDataXml){addControlDataValue(oDataXml,_oTags.singularname,$get("txtSingularName"),true);addControlDataValue(oDataXml,_oTags.pluralname,$get("txtPluralName"),true);addControlDataValue(oDataXml,_oTags.schemaname,$get("txtSchemaName"),true);addControlDataValue(oDataXml,_oTags.ownershiptype,$get("selOwnershipType"),true);addControlDataValue(oDataXml,_oTags.description,$get("txtDescription"),true)}function addDisplayAreaXml(oDataXml){for(var oDisplayAreasXml=addXmlNode(oDataXml,_oTags.displayareas),iCheckBox=0;true;iCheckBox++){var oCheckBox=$get(formatString(_oConst.sCheckBoxIdFormat,iCheckBox)),checkBoxControl=Mscrm.FormControlInputBehavior.GetElementBehavior(oCheckBox);if(IsNull(oCheckBox))break;if(!checkBoxControl.get_disabled()){var oDisplayAreaXml=addXmlNode(oDisplayAreasXml,_oTags.displayarea);addXmlAttribute(oDisplayAreaXml,_oTags.id,oCheckBox.getAttribute("areaid"));addControlDataValueAsAttribute(oDisplayAreaXml,_oTags.displayed,oCheckBox)}}}function addMailMergeXml(oDataXml,addEvenWhenDisabled){addControlDataValue(oDataXml,_oTags.mailmergecheck,$get("EnableMailMergeCheck"),addEvenWhenDisabled)}function addAuditXml(oDataXml){addControlDataValue(oDataXml,_oTags.auditenabled,$get("chkIsAuditingEnabled"))}function addDocumentManagementXml(oDataXml){addControlDataValue(oDataXml,_oTags.docmgmtenabled,$get("enableDocumentMgmt"))}function addAccessTeamXml(oDataXml){addControlDataValue(oDataXml,_oTags.autocreateaccessteams,$get("enableAutoCreateAccessTeams"))}function addBusinessProcessXml(oDataXml){addControlDataValue(oDataXml,_oTags.businessprocessenabled,$get("chkIsBusinessProcessEnabled"))}function addDuplicateDetectionXml(oDataXml){addControlDataValue(oDataXml,_oTags.duplicatecheck,$get("chkEnableDupCheck"),true)}function addCollaborationXml(oDataXml){addControlDataValue(oDataXml,_oTags.collaboration,$get("chkCollaboration"),true);addControlDataValue(oDataXml,_oTags.autoroutetoownerqueue,$get("chkAutoRoute"),true)}function addActivityXml(oDataXml){var checkIsActivity=$get("checkIsActivity"),isActivityControl=Mscrm.FormControlInputBehavior.GetElementBehavior(checkIsActivity),checkIsCommunicationActivity=$get("checkIsCommunicationActivity"),oAcXml=addXmlNode(oDataXml,_oTags.entityisactivity);if(!IsNull(oAcXml)&&!isActivityControl.get_disabled()){addControlDataValue(oDataXml,_oTags.ownershiptype,$get("selOwnershipType"),true);addControlDataValue(oAcXml,_oTags.entityisactivity,checkIsActivity);addControlDataValue(oDataXml,_oTags.iscommunicationactivity,checkIsCommunicationActivity)}}function addRichClientXml(oDataXml,addEvenWhenDisabled){var oRCXml=addXmlNode(oDataXml,_oTags.richclient);addControlDataValue(oRCXml,_oTags.offline,$get("chkRCOffline"),addEvenWhenDisabled)}function addAssociatedEntityXml(oDataXml,addEvenWhenDisabled){var oAEXml=addXmlNode(oDataXml,_oTags.associatedentity);addControlDataValue(oAEXml,_oTags.notes,$get("chkAENotes"),addEvenWhenDisabled);addControlDataValue(oAEXml,_oTags.activities,$get("chkAEActivities"),addEvenWhenDisabled);addControlDataValue(oAEXml,_oTags.activityparties,$get("chkAEEnableEmail"),addEvenWhenDisabled)}function addConnectionsXml(oDataXml,addEvenWhenDisabled){addControlDataValue(oDataXml,_oTags.connection,$get("chkCConnections"),addEvenWhenDisabled)}function addVisibleInMobileXml(oDataXml){addControlDataValue(oDataXml,_oTags.visibleinmobile,$get("chkIsEnabledForMobile"));addControlDataValue(oDataXml,_oTags.visibleinmobileclient,$get("chkIsEnabledForMobileClient"));addControlDataValue(oDataXml,_oTags.readonlyinmobileclient,$get("chkIsReadOnlyForMobileClient"),true)}function addReadingPaneEnabledXml(oDataXml){addControlDataValue(oDataXml,_oTags.readingpaneenabled,$get("chkIsReadingPaneEnabled"))}function addQuickCreateXml(oDataXml){addControlDataValue(oDataXml,_oTags.isquickcreateenabled,$get("chkIsQuickCreateEnabled"))}function addPrimaryAttributeXml(oDataXml){if(_bCreate){var oAttributeXml=addXmlNode(oDataXml,_oTags.attribute);addControlDataValue(oAttributeXml,_oTags.displayname,$get("txtAttributeDisplayName"));addControlDataValue(oAttributeXml,_oTags.schemaname,$get("txtAttributeSchemaName"));addControlDataValue(oAttributeXml,_oTags.reqlevel,$get("selAttributeReqLevel"));addControlDataValue(oAttributeXml,_oTags.description,$get("txtAttributeDescription"));var oTypeXml=addXmlNode(oAttributeXml,_oTags.type);addControlDataValue(oTypeXml,_oTags.name,$get("selAttributeType"));addControlDataValue(oTypeXml,_oTags.format,$get("selAttributeFormat"));addControlDataValue(oTypeXml,_oTags.length,$get("numMaxAttributeLen"))}}function addPrimaryImageXml(oDataXml){addControlDataValue(oDataXml,_oTags.primaryimagename,$get("selPrimaryImage"),true)}function validateParameters(){var bValid=true;bValid=bValid&&validateRequiredValue($get("txtSingularName"));bValid=bValid&&validateRequiredValue($get("txtPluralName"));if(_bCreate){bValid=bValid&&validateSchemaName($get("txtSchemaName"));bValid=bValid&&validateRequiredValue($get("txtAttributeDisplayName"));bValid=bValid&&validateSchemaName($get("txtAttributeSchemaName"));bValid=bValid&&validateRequiredValue($get("selAttributeReqLevel"));bValid=bValid&&validateRequiredValue($get("numMaxAttributeLen"))}return bValid}function onSingularNameChange(){var oSchemaName=Mscrm.FormControlInputBehavior.GetBehavior("txtSchemaName");if(_bCreate&&(_txtSingularName.get_dataValue()!=null&&_txtSingularName.get_dataValue().length>0)&&(oSchemaName.get_dataValue()==null||oSchemaName.get_dataValue().length==0)){var regExp=new RegExp(_oConst.sInvalidSchemaNameChars,"g");oSchemaName.set_dataValue(_txtSingularName.get_dataValue().replace(regExp,"").substr(0,oSchemaName.get_element().maxLength));oSchemaName.get_dataValue()!=null&&oSchemaName.get_dataValue().length>0&&oSchemaName.set_dataValue(oSchemaName.get_dataValue().toLowerCase())}}function onAttributeSchemaNameChange(){var oAttributeDisplayName=Mscrm.FormControlInputBehavior.GetBehavior("txtAttributeDisplayName"),oAttributeSchemaName=Mscrm.FormControlInputBehavior.GetBehavior("txtAttributeSchemaName");if(_bCreate&&(oAttributeDisplayName.get_dataValue()!=null&&oAttributeDisplayName.get_dataValue().length>0)&&(oAttributeSchemaName.get_dataValue()==null||oAttributeSchemaName.get_dataValue().length==0)){var regExp=new RegExp(_oConst.sInvalidSchemaNameChars,"g");oAttributeSchemaName.set_dataValue(oAttributeDisplayName.get_dataValue().replace(regExp,"").substr(0,oAttributeDisplayName.get_element().maxLength));oAttributeSchemaName.set_dataValue(oAttributeSchemaName.get_dataValue().toLowerCase())}}function isFormDirty(){try{return _sInputXml!=getEntityXml()}catch(ex){return false}}function refreshMsgGrid(){try{var oPage=$get(_oConst.sMessagesPageId),oIFrameElement=XUI.Html.DomUtils.GetFirstChild(oPage),oIFrame=$get(oIFrameElement.id);oIFrame.contentWindow.$find("gridDisplayStrings").Refresh()}catch(e){}}