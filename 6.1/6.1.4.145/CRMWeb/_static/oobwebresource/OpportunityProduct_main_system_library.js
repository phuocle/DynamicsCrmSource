Type.registerNamespace("Mscrm");Mscrm.uomid_setadditionalparams=function(context){var productidAttributes=Xrm.Page.data.entity.attributes.get("productid"),opportunityid=GetOpportunityId(),guid="{15F1D7AC-47FF-4487-9F42-A48E0DEBDF76}",viewName="Unit Group Units By Product Price Level updated",fetchXml="<fetch version='1.0' mapping='logical'><entity name='uom'><attribute name='name' /><attribute name='uomid' /><link-entity name='productpricelevel' from='uomid' to='uomid'><link-entity name='opportunity' from='pricelevelid' to='pricelevelid'><filter><condition attribute='opportunityid' operator='like' value='"+CrmEncodeDecode.CrmXmlAttributeEncode(opportunityid)+"' /></filter></link-entity><link-entity name='product' from='productid' to='productid'><filter><condition attribute='productid' operator='like' value='"+CrmEncodeDecode.CrmXmlAttributeEncode(productidAttributes.getValue()[0].id)+"' /></filter></link-entity></link-entity></entity></fetch>",layoutXml="<grid name='resultset' object='1055' jump='name' select='1' preview='0' icon='1'><row name='result' id='uomid'><cell name='name' width='300' /></row></grid>";Xrm.Page.ui.controls.get("uomid").addCustomView(guid,"uom",viewName,fetchXml,layoutXml,true)};Mscrm.Form_onload=function(){var formType=Xrm.Page.ui.getFormType();if(formType!=Xrm.FormType.readOnly&&formType!=Xrm.FormType.disabled&&formType!=Xrm.FormType.bulkEdit){if(formType===Xrm.FormType.create)if(!Mscrm.InternalUtilities.JSTypes.isNull(CAN_OVERRIDE_PRICE)&&(!CAN_OVERRIDE_PRICE||CAN_OVERRIDE_PRICE==="false"))Xrm.Page.data.entity.attributes.get("isproductoverridden").setValue(false);else if(Mscrm.InternalUtilities.JSTypes.isNullOrEmptyString(Xrm.Page.data.entity.getId())){Xrm.Page.data.entity.attributes.get("isproductoverridden").setValue(true);Xrm.Page.data.entity.attributes.get("isproductoverridden").fireOnChange();!Mscrm.InternalUtilities.JSTypes.isNull(Xrm.Page.getControl("productdescription"))&&Xrm.Page.getControl("productdescription").setFocus()}AddEventHandlers();var quantityControlAttributes=Xrm.Page.data.entity.attributes.get("quantity"),ispriceoverriddenAttributes=Xrm.Page.data.entity.attributes.get("ispriceoverridden"),productidAttributes=Xrm.Page.data.entity.attributes.get("productid"),uomidAttributes=Xrm.Page.data.entity.attributes.get("uomid"),productdescriptionAttributes=Xrm.Page.data.entity.attributes.get("productdescription");_defaultQtyAcc=quantityControlAttributes.getPrecision();SetAttributeIfNotNull(ispriceoverriddenAttributes.getName(),"prevDataValue",ispriceoverriddenAttributes.getValue());SetAttributeIfNotNull(productidAttributes.getName(),"prevDataValue",productidAttributes.getValue());SetAttributeIfNotNull(uomidAttributes.getName(),"prevDataValue",uomidAttributes.getValue());SetAttributeIfNotNull(productdescriptionAttributes.getName(),"prevDataValue",productdescriptionAttributes.getValue());if(Mscrm.InternalUtilities.JSTypes.isNull(productidAttributes.getValue())){_productQtyDec=_defaultQtyAcc;ProductOverriddenHandler()}else GetQuantityDecimalForOP(productidAttributes.getValue()[0].id,ProductOverriddenHandler);var iOriginalQty=quantityControlAttributes.getValue();if(Xrm.Page.context.client.getClient()!=Xrm.ClientNames.mobile)quantityControlAttributes.getIsDirty()&&alert(formatString(LOCID_QTY_CHANGED_DUE_TO_ACC_H,Mscrm.NumberUtility.addFormatting(iOriginalQty),Mscrm.NumberUtility.addFormatting(quantityControlAttributes.getDataValue(),quantityControlAttributes.getPrecision()))+"\n"+LOCID_QTY_CHANGED_DUE_TO_ACC_F)}};Mscrm.isproductoverridden_onchange=function(){ProductOverriddenHandler()};Mscrm.productid_onchange=function(){var uomidAttributes=Xrm.Page.data.entity.attributes.get("uomid"),uomidControl=Xrm.Page.ui.controls.get("uomid"),productidAttributes=Xrm.Page.data.entity.attributes.get("productid");uomidAttributes.setValue([]);uomidControl.setDisabled(Mscrm.InternalUtilities.JSTypes.isNull(productidAttributes.getValue()));_productQtyDec=_defaultQtyAcc;var quantityAttributes=Xrm.Page.data.entity.attributes.get("quantity");quantityAttributes.setPrecision(_productQtyDec)};Mscrm.uomid_onchange=function(){var uomid=Xrm.Page.data.entity.attributes.get("uomid"),quantityAttributes=Xrm.Page.data.entity.attributes.get("quantity"),aoItems=uomid.getValue();if(Mscrm.InternalUtilities.JSTypes.isNull(aoItems)||aoItems.length==0){_productQtyDec=_defaultQtyAcc;quantityAttributes.setPrecision(_productQtyDec)}else{var productidAttributes=Xrm.Page.data.entity.attributes.get("productid"),shim=function(){var quantityAttributes=Xrm.Page.data.entity.attributes.get("quantity");quantityAttributes.setPrecision(_productQtyDec)};GetQuantityDecimalForOP(productidAttributes.getValue()[0].id,shim)}};Mscrm.ispriceoverridden_onchange=function(){UpdatePriceOverriden(true)};Mscrm.productid_setadditionalparams=function(context){var opportunityid=GetOpportunityId(),guid="{3ADA8BBE-DDE2-453B-A855-5A38853BDA21}",viewName="Products in Parent Price List updated",fetchXml="<fetch version='1.0' mapping='logical' distinct='true'><entity name='product'><attribute name='name' /><attribute name='price' /><attribute name='defaultuomid' /><attribute name='productnumber' /><attribute name='productid' /><filter type='and'><condition attribute='statecode' operator='eq' value='0' /></filter><order attribute='name' descending='false' /><link-entity name='productpricelevel' from='productid' to='productid'><attribute name='productid' /><link-entity name='opportunity' from='pricelevelid' to='pricelevelid'><filter><condition attribute='opportunityid' operator='eq' value='"+CrmEncodeDecode.CrmXmlAttributeEncode(opportunityid)+"' /></filter></link-entity></link-entity></entity></fetch>",layoutXml="<grid name='resultset' object='1024' jump='name' select='1' preview='0' icon='1'><row name='result' id='productid'><cell name='name' width='200' /><cell name='price' width='100' /><cell name='defaultuomid' width='100' /><cell name='productnumber' width='100' /></row></grid>";Xrm.Page.ui.controls.get("productid").addCustomView(guid,"product",viewName,fetchXml,layoutXml,true)};Mscrm.Form_onsave=function(context){CheckPriceAndQuantityNonNegative(context.getEventArgs())};function AddEventHandlers(){if(Xrm.Page.context.client.getClient()!=Xrm.ClientNames.mobile)window.onbeforeunload=function(){RemoveOnChangeEventHandler(Xrm.Page.data.entity.attributes.get("quantity"),calculate_price);RemoveOnChangeEventHandler(Xrm.Page.data.entity.attributes.get("priceperunit"),calculate_price);RemoveOnChangeEventHandler(Xrm.Page.data.entity.attributes.get("manualdiscountamount"),calculate_price);RemoveOnChangeEventHandler(Xrm.Page.data.entity.attributes.get("tax"),calculate_price)};else RegisterMobileClientEvents();AddOnChangeEventHandler(Xrm.Page.data.entity.attributes.get("quantity"),calculate_price);AddOnChangeEventHandler(Xrm.Page.data.entity.attributes.get("priceperunit"),calculate_price);AddOnChangeEventHandler(Xrm.Page.data.entity.attributes.get("manualdiscountamount"),calculate_price);AddOnChangeEventHandler(Xrm.Page.data.entity.attributes.get("tax"),calculate_price)}function RegisterMobileClientEvents(){if(Xrm.Page.context.client.getClient()!=Xrm.ClientNames.mobile)return;var productId=Xrm.Page.ui.controls.get("productid");!Mscrm.InternalUtilities.JSTypes.isNull(productId)&&productId.addPreSearch(Mscrm.productid_setadditionalparams);var uomid=Xrm.Page.ui.controls.get("uomid");!Mscrm.InternalUtilities.JSTypes.isNull(uomid)&&uomid.addPreSearch(Mscrm.uomid_setadditionalparams)}function AddOnChangeEventHandler(field,handler){!Mscrm.InternalUtilities.JSTypes.isNull(field)&&!Mscrm.InternalUtilities.JSTypes.isNull(handler)&&field.addOnChange(handler)}function RemoveOnChangeEventHandler(field,handler){!Mscrm.InternalUtilities.JSTypes.isNull(field)&&!Mscrm.InternalUtilities.JSTypes.isNull(handler)&&field.removeOnChange(handler)}function calculate_price(){if(Xrm.Page.context.client.getClient()=="Mobile"){var opportunityid=GetOpportunityId(),columns=[];columns[0]="isrevenuesystemcalculated";var isRevenueSystemCalculated;Xrm.Internal.messages.retrieve(Mscrm.InternalUtilities.EntityNames.Opportunity,opportunityid,columns).then(function(response){var opportunityEntity=response.get_entity();if(opportunityEntity.hasValue("isrevenuesystemcalculated")){isRevenueSystemCalculated=opportunityEntity.getValue("isrevenuesystemcalculated");isRevenueSystemCalculated.getValue("value")&&UpdatePrice()}},function(errorResponse){return})}else{var formType=Xrm.Page.ui.getFormType();if(formType==Xrm.FormType.create||Mscrm.InlineEditDataService.get_busy())return;Xrm.Page.data.save()}}function UpdatePrice(){var baseAmount=0,extendedAmount=0,quantity=Xrm.Page.data.entity.attributes.get("quantity").getValue(),priceperunit=Xrm.Page.data.entity.attributes.get("priceperunit").getValue(),manualdiscountamount=Xrm.Page.data.entity.attributes.get("manualdiscountamount").getValue(),volumediscountamount=Xrm.Page.data.entity.attributes.get("volumediscountamount").getValue(),tax=Xrm.Page.data.entity.attributes.get("tax").getValue();baseAmount=quantity*(priceperunit-volumediscountamount);extendedAmount=baseAmount-manualdiscountamount+tax;if(isNaN(baseAmount)||isNaN(extendedAmount))return;Xrm.Page.data.entity.attributes.get("extendedamount").setValue(extendedAmount);Xrm.Page.data.entity.attributes.get("baseamount").setValue(baseAmount)}function GetOpportunityId(){var opportunityidAttributes=Xrm.Page.data.entity.attributes.get("opportunityid"),opportunityid;if(!Mscrm.InternalUtilities.JSTypes.isNull(opportunityidAttributes))opportunityid=opportunityidAttributes.getValue()[0].id;else opportunityid=Xrm.Page.context.getQueryStringParameters()["opportunityid"];return opportunityid}function GetQuantityDecimalForOP(productId,callback){var columns=[];columns[0]="quantitydecimal";Xrm.Internal.messages.retrieve(Mscrm.InternalUtilities.EntityNames.Product,productId,columns).then(function(response){var productEntity=response.get_entity();if(productEntity.hasValue("quantitydecimal"))_productQtyDec=productEntity.getValue("quantitydecimal").toString();else _productQtyDec=_defaultQtyAcc;!Mscrm.InternalUtilities.JSTypes.isNull(callback)&&callback()},function(errorResponse){_productQtyDec=_defaultQtyAcc;!Mscrm.InternalUtilities.JSTypes.isNull(callback)&&callback()})}