Type.registerNamespace("Mscrm");Mscrm.Form_onload=function(){Mscrm.setupAdvFind();var filterXml=document.getElementById("PropertiesXml").value,fetchXml=String.format('<fetch version="1.0" output-format="xml-platform" mapping="logical" distinct="false"><entity name="incident"><attribute name="title"/>{0}</entity></fetch>',filterXml);$find("advFind").set_fetchXml(fetchXml);var conditionXml=document.getElementById("ConditionXml").value;if(conditionXml)conditionXml=conditionXml.replace(/dataslugs=""/g,"");$find("appConditionBuilder").LoadXml(conditionXml);var convertRuleId=Xrm.Page.data.entity.attributes.get("convertruleid");if(!IsNull(convertRuleId))if(IsNull(convertRuleId.getValue())){var _convertRuleId=window.top.opener.Xrm.Page.data.entity.getId();Xrm.Page.getAttribute("convertruleid").setValue(_convertRuleId)}var crmFormCtrl=$find("crmForm");crmFormCtrl.add_onSave(Mscrm.Form_onsave);attachWindowOnBeforeUnload(formClose);ShowNotifications()};function formClose(oEvent){oEvent=oEvent.rawEvent;var conditionBuilder=$find("appConditionBuilder"),fetchXml=$find("advFind");if(conditionBuilder.get_isDirty()||fetchXml.get_isDirty())oEvent.returnValue=LOCID_FORMS_SAVE_CONFIRM_TITLE}Mscrm.Form_onsave=function(){var conditionBuilder=$find("appConditionBuilder");!conditionBuilder.ParseXml()&&context.getEventArgs().preventDefault();var conditionXml=$find("appConditionBuilder").GetXml();Xrm.Page.getAttribute("conditionxml").setValue(conditionXml);var fetchXml=$find("advFind").get_fetchXml(),fetchXmlDoc=XUI.Xml.LoadXml(fetchXml),filterXml=XUI.Xml.SelectSingleNode(fetchXmlDoc,"/fetch/entity/filter",null);if(!IsNull(filterXml)){var propertiesXml=convertXmlDocToString(filterXml);Xrm.Page.getAttribute("propertiesxml").setValue(propertiesXml)}var queueId=Xrm.Page.data.entity.attributes.get("queueid");if(!IsNull(queueId))if(IsNull(queueId.getValue())){var _queueId=window.top.opener.Xrm.Page.data.entity.attributes.get("queueid");!IsNull(_queueId.getValue())&&Xrm.Page.getAttribute("queueid").setValue(_queueId.getValue()[0].id)}detachWindowOnBeforeUnload(formClose);if(!IsNull(window.event))window.event.returnValue=false};Mscrm.setupAdvFind=function(){crmCreate(Mscrm.AdvancedFind,{},null,{},$get("advFind"))};function ShowNotifications(){var isCreate=Xrm.Page.ui.getFormType()==Xrm.FormType.create,isValid=isCreate?true:IsEntityRecordValid(Xrm.Page.data.entity.getId()),showNotification=!isCreate&&!isValid;if(showNotification){var notificationText=LOCID_ERROR_MISSING_CRI;Xrm.Page.ui.setFormNotification(notificationText,"WARNING","ConvertRuleItemErrorNotofication")}else Xrm.Page.ui.clearFormNotification("ConvertRuleItemErrorNotofication")}