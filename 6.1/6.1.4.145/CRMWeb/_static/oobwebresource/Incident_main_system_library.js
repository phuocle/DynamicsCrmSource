Type.registerNamespace("Mscrm");Mscrm.IncidentMainSystemLibraryWebResource=function(){};Mscrm.IncidentMainSystemLibraryWebResource.setDependentControlState=function(dependentAttributeId,lookupAttributeId){var $v_0=Xrm.Page.data.entity.attributes.get(dependentAttributeId),$v_1=false;if(!Mscrm.InternalUtilities.JSTypes.isNull($v_0)&&Mscrm.InternalUtilities.JSTypes.isNull($v_0.getValue()))$v_1=true;var $v_2;if(!Mscrm.InternalUtilities.JSTypes.isNull($v_2))for(var $v_3=$v_2.getLength(),$v_4=0;$v_4<$v_3;$v_4++){var $v_5=$v_2.get($v_4);!Mscrm.InternalUtilities.JSTypes.isNull($v_5)&&$v_5.setDisabled($v_1)}};Mscrm.IncidentMainSystemLibraryWebResource.form_OnSave=function(){if(Xrm.Page.context.client.getClient()===Xrm.ClientNames.mobile&&Xrm.Page.ui.getFormType()===1){var $v_0=Xrm.Page.data.entity.attributes.get("routecase");!Mscrm.InternalUtilities.JSTypes.isNull($v_0)&&$v_0.setValue(false)}};Mscrm.IncidentMainSystemLibraryWebResource.registerClass("Mscrm.IncidentMainSystemLibraryWebResource");Type.registerNamespace("Mscrm");Mscrm.setDependentControlState=Mscrm.IncidentMainSystemLibraryWebResource.setDependentControlState;var kbArticleIdInputElement=null,childCasesGridSectionId="{b1f997ea-9b7b-4a2d-9a33-eb3cb14e08f7}";Mscrm.Form_onload=function(){if(Xrm.Page.data.entity.getId()!=""){var relatedCases=Xrm.Page.ui.controls.get("header_process_relatedcases");if(!IsNull(relatedCases)){relatedCases.set_disabled(1);relatedCases.set_lockIcon()}}if(IsNull(kbArticleIdInputElement))if(Xrm.Page.context.client.getClient()!==Xrm.ClientNames.mobile&&!Mscrm.InternalUtilities.JSTypes.isNull(Mscrm.FormControlInputBehavior.GetBehavior("kbarticleid_i"))){kbArticleIdInputElement=Mscrm.FormControlInputBehavior.GetBehavior("kbarticleid_i").getLookupEdit();$addHandler(kbArticleIdInputElement,"keydown",Mscrm.kbarticleid_onKeykeydown);attachWindowOnUnload(Mscrm.Form_cleanup)}Xrm.Page.context.client.getClient()==Xrm.ClientNames.mobile&&Xrm.Page.getControl("kbarticleid").setDisabled(true);var readyStateCheck=function(){if(Xrm.Page.ui!=null)if(document.readyState==="complete"){if(Xrm.Page.ui.controls.get("ChildCasesGrid")!=null){Xrm.Page.context.client.getClient()!=Xrm.ClientNames.mobile&&Mscrm.ServiceRefreshUtilities.validateCaseChildCount();var incidentId=Xrm.Page.data.entity.getId(),parentCaseId=Xrm.Page.data.entity.attributes.get("parentcaseid");if(!Mscrm.InternalUtilities.JSTypes.isNull(incidentId)&&!Mscrm.InternalUtilities.JSTypes.isNull(parentCaseId)&&!Mscrm.InternalUtilities.JSTypes.isNull(parentCaseId.getValue())||Xrm.Page.context.isOutlookClient()&&!Xrm.Page.context.isOutlookOnline()){var childCasesGridSection=Xrm.Page.ui.tabs.get("CASERELATIONSHIP_TAB").sections.get("ChildCases");!Mscrm.InternalUtilities.JSTypes.isNull(childCasesGridSection)&&childCasesGridSection.setVisible(false)}}clearInterval(readyStateCheckInterval)}!IsNull(window.IS_OUTLOOK_CLIENT)&&window.IS_OUTLOOK_CLIENT&&raiseEvent(Mscrm.ScriptEvents.ReloadCommandBar,null,null)},readyStateCheckInterval=setInterval(readyStateCheck,1e3);window.setTimeout(function(){var control=Xrm.Page.ui.controls.get("parentcaseid");if(Xrm.Page.context.isOutlookClient()&&!Xrm.Page.context.isOutlookOnline())if(control!=null){control.setVisible(false);return}var incidentId=Xrm.Page.data.entity.getId();if(incidentId!=""){var columns=[],childCount;columns[0]="numberofchildincidents";Xrm.Internal.messages.retrieve(Mscrm.InternalUtilities.EntityNames.Incident,incidentId,columns).then(function(response){var incidentEntity=response.get_entity();if(incidentEntity.hasValue("numberofchildincidents")){childCount=incidentEntity.getValue("numberofchildincidents");if(childCount>0)control!=null&&control.setVisible(false)}},function(errorResponse){})}},0);var formState=Xrm.Page.data.entity.attributes.get("statecode");if(!Mscrm.InternalUtilities.JSTypes.isNull(formState)&&formState.getValue()==0){var bIsWriteIn=Xrm.Page.data.entity.attributes.get("contractid").getValue();Xrm.Page.data.entity.attributes.get("contractdetailid").setRequiredLevel(!Mscrm.InternalUtilities.JSTypes.isNull(bIsWriteIn)?Xrm.RequiredLevel.required:Xrm.RequiredLevel.none)}Mscrm.setDependentControlState("customerid","contractid");Mscrm.setDependentControlState("contractid","contractdetailid")};Mscrm.Form_cleanup=function(){detachWindowOnUnload(Mscrm.Form_cleanup);!IsNull(kbArticleIdInputElement)&&$removeHandler(kbArticleIdInputElement,"keydown",Mscrm.kbarticleid_onKeykeydown);kbArticleIdInputElement=null};Mscrm.customerid_onchange=function(){Mscrm.clearLookup("contractid");Mscrm.clearLookup("primarycontactid");Mscrm.clearLookup("contractdetailid");Mscrm.clearLookup("entitlementid");Mscrm.clearLookup("productid");Xrm.Page.data.entity.attributes.get("contractdetailid").setRequiredLevel(Xrm.RequiredLevel.none)};Mscrm.productid_onchange=function(){if(Xrm.Page.context.client.getClient()!=Xrm.ClientNames.mobile){var oLookup=Mscrm.FormControlInputBehavior.GetBehavior("entitlementid_i");oLookup.AddParam("productid","")}};Mscrm.primarycontactid_onchange=function(){if(Xrm.Page.context.client.getClient()!=Xrm.ClientNames.mobile){var oLookup=Mscrm.FormControlInputBehavior.GetBehavior("entitlementid_i");oLookup.AddParam("primarycontactid","")}};Mscrm.entitlementid_onclick=function(e){var bCustomerIsValid=Mscrm.verifyIfLookupFieldIsSet("customerid",LOCID_ERROR_MISSING_CUSTOMER),bProductIsValid=Mscrm.verifyIfLookupFieldIsSet("productid",""),bPrimaryContactIsValid=Mscrm.verifyIfLookupFieldIsSet("primarycontactid","");if((bCustomerIsValid||bProductIsValid||bPrimaryContactIsValid)&&Xrm.Page.context.client.getClient()!=Xrm.ClientNames.mobile){var oLookup=Mscrm.FormControlInputBehavior.GetBehavior("entitlementid_i");oLookup.onLookup(e)}};Mscrm.entitlementid_setadditionalparams=function(context){if(Xrm.Page.context.client.getClient()!=Xrm.ClientNames.mobile)if(Mscrm.verifyIfLookupFieldIsSet("customerid",LOCID_ERROR_MISSING_CUSTOMER)||Mscrm.verifyIfLookupFieldIsSet("productid","")||Mscrm.verifyIfLookupFieldIsSet("primarycontactid","")){var oLookup=Mscrm.FormControlInputBehavior.GetBehavior("entitlementid_i"),productControl=Xrm.Page.getAttribute("productid").getValue(),customerControl=Xrm.Page.getAttribute("customerid").getValue(),primaryContactControl=Xrm.Page.getAttribute("primarycontactid").getValue();!IsNull(customerControl)&&oLookup.AddParam("customerid",customerControl[0].id);!IsNull(productControl)&&oLookup.AddParam("productid",productControl[0].id);!IsNull(primaryContactControl)&&oLookup.AddParam("primarycontactid",primaryContactControl[0].id);oLookup.AddParam("DisableViewPicker","1")}};Mscrm.primarycontactid_onclick=function(e){var bCustomerIsValid=Mscrm.verifyIfLookupFieldIsSet("customerid",LOCID_ERROR_MISSING_CUSTOMER);if(bCustomerIsValid&&Xrm.Page.context.client.getClient()!=Xrm.ClientNames.mobile){var oLookup=Mscrm.FormControlInputBehavior.GetBehavior("primarycontactid_i");oLookup.onLookup(e)}};Mscrm.primarycontactid_setadditionalparams=function(context){if(Xrm.Page.context.client.getClient()!=Xrm.ClientNames.mobile)if(Mscrm.verifyIfLookupFieldIsSet("customerid",LOCID_ERROR_MISSING_CUSTOMER)){var relationshipId="",oRelatedLookup=Xrm.Page.data.entity.attributes.get("customerid");if(!IsNull(oRelatedLookup)&&!IsNull(oRelatedLookup.getValue())){var relatedItem=oRelatedLookup.getValue()[0];if(relatedItem.type===Mscrm.EntityTypeCode.Account.toString())relationshipId="contact_customer_accounts";else if(relatedItem.type===Mscrm.EntityTypeCode.Contact.toString())relationshipId="contact_customer_contacts";var oLookup=Mscrm.FormControlInputBehavior.GetBehavior("primarycontactid_i");oLookup.set_filterRelationshipId(relationshipId);oLookup.set_dependantAttributeName("incident.customerid");oLookup.set_dependantAttributeType(relatedItem.type.toString());oLookup.AddParam("AllowFilterOff","0")}}};Mscrm.contractid_onclick=function(e){var bIsValid=Mscrm.verifyIfLookupFieldIsSet("customerid",LOCID_ERROR_MISSING_CUSTOMER);if(bIsValid&&Xrm.Page.context.client.getClient()!=Xrm.ClientNames.mobile){var oLookup=Mscrm.FormControlInputBehavior.GetBehavior("contractid_i");oLookup.onLookup(e)}};Mscrm.contractid_setadditionalparams=function(context){if(Xrm.Page.context.client.getClient()!=Xrm.ClientNames.mobile)if(Mscrm.verifyIfLookupFieldIsSet("customerid",LOCID_ERROR_MISSING_CUSTOMER)){var relationshipId="";oRelatedLookup=Xrm.Page.data.entity.attributes.get("customerid");if(!Mscrm.InternalUtilities.JSTypes.isNull(oRelatedLookup)&&!Mscrm.InternalUtilities.JSTypes.isNull(oRelatedLookup.getValue())){var oLookup=Xrm.Page.ui.controls.get("contractid").get_editControlBehavior(),sOriginalRelation=oLookup.get_filterRelationshipId();if(!isNullOrEmptyString(sOriginalRelation))sOriginalRelation=sOriginalRelation.substring(sOriginalRelation.indexOf("_")+1,sOriginalRelation.lastIndexOf("_"));else sOriginalRelation="customer";var relatedItem=oRelatedLookup.getValue()[0];if(relatedItem.type===Mscrm.EntityTypeCode.Account.toString())relationshipId="contract_"+sOriginalRelation+"_accounts";else if(relatedItem.type===Mscrm.EntityTypeCode.Contact.toString())relationshipId="contract_"+sOriginalRelation+"_contacts";oLookup.set_filterRelationshipId(relationshipId);oLookup.set_dependantAttributeName("incident.customerid");oLookup.set_dependantAttributeType(relatedItem.type.toString());oLookup.AddParam("AllowFilterOff","1")}}};Mscrm.contractid_onchange=function(){var bIsWriteIn=false,isSet=Mscrm.verifyIfLookupFieldIsSet("contractid","");if(isSet){var isValid=Mscrm.verifyIfLookupFieldIsSet("customerid",window.LOCID_ERROR_MISSING_CUSTOMER);if(!isValid&&!Mscrm.InternalUtilities.JSTypes.isNull(Xrm.Page.data.entity.attributes.get("customerid")))Mscrm.clearLookup("contractid");else bIsWriteIn=true}Xrm.Page.data.entity.attributes.get("contractdetailid").setRequiredLevel(bIsWriteIn?Xrm.RequiredLevel.required:Xrm.RequiredLevel.none);Mscrm.clearLookup("contractdetailid");Mscrm.setDependentControlState("contractid","contractdetailid")};Mscrm.contractdetailid_onclick=function(e){var bIsValid=Mscrm.verifyIfLookupFieldIsSet("contractid",LOCID_ERROR_MISSING_CONTRACT);if(bIsValid&&Xrm.Page.context.client.getClient()!=Xrm.ClientNames.mobile){var oLookup=Mscrm.FormControlInputBehavior.GetBehavior("contractdetailid_i");oLookup.onLookup(e)}};Mscrm.contractdetailid_onchange=function(){var contractdetailid=Xrm.Page.data.entity.attributes.get("contractdetailid");if(!Mscrm.InternalUtilities.JSTypes.isNull(contractdetailid.getValue())){var bIsValid=Mscrm.verifyIfLookupFieldIsSet("contractid",LOCID_ERROR_MISSING_CONTRACT);if(!bIsValid)Mscrm.clearLookup("contractdetailid");else Mscrm.clearLookup("productid")}};Mscrm.kbarticleid_onKeykeydown=function(eventObject){!Mscrm.InternalUtilities.JSTypes.isNull(eventObject)&&eventObject.keyCode===Sys.UI.Key.enter&&Mscrm.isLookUpInEditMode("kbarticleid_i")&&Mscrm.FormControlInputBehavior.GetBehavior("kbarticleid_i").Lookup(true,false,"",false)};Mscrm.kbarticleid_onshowdialog=function(context){var oUrl=Mscrm.CrmUri.create("/CS/dialogs/KBSearch.aspx?isLookup=true"),args=context.getEventArgs(),parameters=[];parameters[0]=args;var callbackFunction=Mscrm.Utilities.createCallbackFunctionObject("performActionAfterKBsearch",this,parameters,false),crmDialog=new Mscrm.CrmDialog(oUrl,null,700,500,null);crmDialog.setCallbackReference(callbackFunction);crmDialog.show()};Mscrm.performActionAfterKBsearch=function(ret_val,args){args.set_lookupItems(ret_val);Mscrm.Utilities.executeFunction(args.get_callbackForShowDialog(),args)};Mscrm.kbarticleid_onchange=function(){var oKbViewer=$get("kbviewer");if(!Mscrm.InternalUtilities.JSTypes.isNull(oKbViewer)){var kbarticleid=Mscrm.FormControlInputBehavior.GetBehavior("kbarticleid_i"),oKBId=kbarticleid.Items(false,false,false,false,false)[0];if(Mscrm.InternalUtilities.JSTypes.isNull(oKBId)){oKbViewer.src="";Mscrm.setDisplayForShowKbViewerCheckBox("none")}else{var url=Mscrm.CrmUri.create(oKbViewer.getAttribute("baseSrc")),id=url.get_query()["id"];if(id!=null){url.get_query()["id"]=oKBId.id;oKbViewer.src=url;oKbViewer.setAttribute("url",url.toString())}Mscrm.setDisplayForShowKbViewerCheckBox("table")}}};Mscrm.clearLookup=function(elementId){var oLookUp=Xrm.Page.data.entity.attributes.get(elementId);!Mscrm.InternalUtilities.JSTypes.isNull(oLookUp)&&oLookUp.setValue(null)};Mscrm.verifyIfLookupFieldIsSet=function(elementId,ErrorMessage){var oLookup=Xrm.Page.data.entity.attributes.get(elementId);if(!Mscrm.InternalUtilities.JSTypes.isNull(oLookup)&&!Mscrm.InternalUtilities.JSTypes.isNull(oLookup.getValue()))return true;!Mscrm.InternalUtilities.JSTypes.isNull(oLookup)&&!isNullOrEmptyString(ErrorMessage)&&Mscrm.ErrorStatusControl.showError(ErrorMessage);return false};Mscrm.setDisplayForShowKbViewerCheckBox=function(displayType){var element=$get("showKBViewer");if(!Mscrm.InternalUtilities.JSTypes.isNull(element)){while(element.tagName.toUpperCase()!=="TABLE")element=element.parentNode;element.style.display=displayType}};Mscrm.isLookUpInEditMode=function(elementId){return Mscrm.FormControlInputBehavior.GetBehavior(elementId).getLookupEdit().className!=="ms-crm-Hidden-NoBehavior"}