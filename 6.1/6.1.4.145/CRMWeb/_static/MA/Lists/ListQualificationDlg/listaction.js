var _sFetchXml=null,_sUrl="",_i=0,_sCustParams="",_sIds="",_bActionStarted=false,_a=getDialogArguments(),_oXml=null,_sDialogXml="",_xmlhttp=new XMLHttpRequest,_xmlDoc=null,_sSubmitUrl="",_iErrorCode=0,_sErrorNumber="",_sErrorDescription="",_iErrorCount=0,bPostActions=false,SELECTED=1,ALLINQUERY=2;function ListActionJsWindowOnLoad(){var crmGridObj=getCrmGrid();!IsNull(crmGridObj)&&crmGridObj.add_onBeforeRefresh(RefreshMemberCount)}executeFunctionDeferred(ListActionJsWindowOnLoad,false,true);function Go(){_iErrorCode=ERROR_NONE;_iErrorCount=0;_sErrorNumber="";_sErrorDescription="";_bActionStarted=true;window.setTimeout("performAction()",0)}function wait(){var iStatus=handleXMLErr(_oXml,true);if(iStatus==ERROR_CONTINUE){if(_iErrorCount==0){_iErrorCode=iStatus;var errNode=XUI.Xml.SelectSingleNode(_oXml,"/error/code",null);_sErrorNumber=IsNull(errNode)?"0x80004005":XUI.Xml.GetText(errNode);var descNode=XUI.Xml.SelectSingleNode(_oXml,"/error/description",null);_sErrorDescription=IsNull(descNode)?"":XUI.Xml.GetText(descNode)}_iErrorCount++}if(_iErrorCode==ERROR_CONTINUE)if(_iErrorCount==1)openErrorDlg(_sErrorNumber,_sErrorDescription);else alert(LOCID_LISTACTION_MULTIPLEERRORS);else{window.returnValue=true;Mscrm.Utilities.setReturnValue(true)}closeWindow()}function performAction(){if(_sDialogXml=="")_sDialogXml="<node />";_xmlDoc=XUI.Xml.LoadXml(_sDialogXml);_sSubmitUrl="/MA/Lists/ListQualificationDlg/dlg_"+CrmEncodeDecode.CrmUrlEncode(sAction)+".aspx?"+_sCustParams;var oUrl=Mscrm.CrmUri.create(_sSubmitUrl);_xmlhttp.open("POST",oUrl.toString(),false);Mscrm.Utilities.setResponseTypeToMSXml(_xmlhttp);SetTokenInHeader(_xmlhttp,oUrl);_xmlhttp.send(_xmlDoc);_oXml=_xmlhttp.responseXML;wait()}function cancel(){if(_bActionStarted){if(window.confirm(formatString(LOCID_LISTACTION_CANCELCONFIRM,_a.length-_i))){window.returnValue=true;closeWindow()}}else closeWindow()}function RefreshMemberCount(){var memberCount=document.getElementById("MemberCount");if(memberCount!=null){var command=new RemoteCommand("MarketingAutomation","RetrieveList"),sListId=this.parent.$get("crmFormSubmit").crmFormSubmitId.value,columns=[];columns.type="string";columns[0]="membercount";command.SetParameter("id",sListId);command.SetParameter("columns",columns);var oResult=command.Execute();if(oResult.Success){var resultXml=XUI.Xml.LoadXml(oResult.ReturnValue),sMemberCount=CrmEncodeDecode.CrmHtmlEncode(XUI.Xml.GetText(XUI.Xml.SelectSingleNode(resultXml,"/list/membercount",null)));memberCount.innerHTML=sMemberCount}}}function OpenManageMembersWizard(listMemberType,sGridId,listId,iWidth,iHeight){var oUrl=Mscrm.CrmUri.create("/MA/Lists/ListQualificationDlg/dlg_manage_members.aspx"),parameters=[listMemberType,sGridId,listId],crmDialog=new Mscrm.CrmDialog(oUrl,"Search",iWidth,iHeight,"maximize:yes;minimize:yes");crmDialog.setCallbackInfo("OpenManageMembersWizardCallback",this,parameters);crmDialog.show()}function OpenManageMembersWizardCallback(result,listMemberType,sGridId,listId){switch(result){case "0":break;case "1":LaunchAddToListSimple(listId,sGridId);break;case "2":LaunchListQualification("lqAdd",sGridId,listMemberType,listId);break;case "3":LaunchListQualification("lqRemove",sGridId,listMemberType,listId);break;case "4":LaunchListQualification("lqKeep",sGridId,listMemberType,listId);break}}function LaunchListQualification(lqAction,sGridId,listMemberType,listId){var url="/MA/Lists/ListQualificationDlg/dlg_query_build.aspx?";url+="ListMemberType="+CrmEncodeDecode.CrmUrlEncode(listMemberType);url+="&ListId="+CrmEncodeDecode.CrmUrlEncode(listId);url+="&InvokeType="+CrmEncodeDecode.CrmUrlEncode(lqAction);var parameters=[];parameters[0]=listMemberType;var callbackFunction=Mscrm.InternalUtilities.GridUtilities.createCallbackFunctionFactory(performGridRefresh,parameters),dialogOptions=new Xrm.DialogOptions;dialogOptions.height=615;dialogOptions.width=820;var dialogUrl=Mscrm.CrmUri.create(url);Xrm.Internal.openDialog(dialogUrl.toString(),dialogOptions,null,null,callbackFunction)}function OpenDynamicListQuery(listMemberType,sGridId,listId){var url="/MA/Lists/ListQualificationDlg/dlg_query_build.aspx?";url+="ListMemberType="+CrmEncodeDecode.CrmUrlEncode(listMemberType);url+="&ListId="+CrmEncodeDecode.CrmUrlEncode(listId);url+="&InvokeType="+CrmEncodeDecode.CrmUrlEncode("lqUseQuery");var parameters=[];parameters[0]=listMemberType;var callbackFunction=Mscrm.InternalUtilities.GridUtilities.createCallbackFunctionFactory(performGridRefresh,parameters),dialogOptions=new Xrm.DialogOptions;dialogOptions.height=615;dialogOptions.width=820;var dialogUrl=Mscrm.CrmUri.create(url);Xrm.Internal.openDialog(dialogUrl.toString(),dialogOptions,null,null,callbackFunction)}function ProcessLQAdd(sFetchXml,sParams,iSelected,iOption){if(iOption==SELECTED){sParams+="&autoTrigger=1";var url="/_grid/cmds/dlg_addtolist.aspx?";url+=sParams;var parameters=[Xrm.Page.context],callbackFunction=Mscrm.InternalUtilities.GridUtilities.createCallbackFunctionFactory(performAfterAddtoList,parameters),dialogOptions=new Xrm.DialogOptions;dialogOptions.height=200;dialogOptions.width=400;Xrm.Internal.openDialog(url.toString(),dialogOptions,iSelected,null,callbackFunction);isOutlookHostedWindow()&&performAfterAddtoList(oResult)}else if(iOption==ALLINQUERY){if(sFetchXml!=null)_sFetchXml=sFetchXml;_sCustParams=sParams+"&iOption="+CrmEncodeDecode.CrmUrlEncode(iOption)+"&iViewType="+CrmEncodeDecode.CrmUrlEncode(getCrmGrid().GetParameter("viewtype"));_iErrorCode=ERROR_NONE;_iErrorCount=0;_sErrorNumber="";_bActionStarted=true;_sUrl=Mscrm.CrmUri.create("/MA/Lists/ListQualificationdlg/dlg_List_add.aspx").toString();_sUrl+="?";DisplayActionMsg(LOCID_BI_PROCESSING,350,150);window.setTimeout("postBackFetch()",50);window.returnValue=true}else window.returnValue=false}function performAfterAddtoList(oResult){if(oResult)window.returnValue=true;else window.returnValue=false;Mscrm.Utilities.setReturnValue(window.returnValue);window.setTimeout(closeWindow,0)}function ProcessLQRemove(sFetchXml,sParams,iSelected,iOption){if(iOption==SELECTED||iOption==ALLINQUERY){if(sFetchXml!=null)_sFetchXml=sFetchXml;if(iOption==SELECTED)_sIds=iSelected;_sCustParams=sParams+"&iOption="+CrmEncodeDecode.CrmUrlEncode(iOption)+"&iViewType="+CrmEncodeDecode.CrmUrlEncode(getCrmGrid().GetParameter("viewtype"));_iErrorCode=ERROR_NONE;_iErrorCount=0;_sErrorNumber="";_bActionStarted=true;_sUrl=Mscrm.CrmUri.create("/MA/Lists/ListQualificationdlg/dlg_List_qualify.aspx").toString();_sUrl+="?";DisplayActionMsg(LOCID_BI_PROCESSING,350,150);window.setTimeout("postBackFetch()",50);window.returnValue=true}else window.returnValue=false}function ProcessLQKeep(sFetchXml,sParams,iSelected,iOption){ProcessLQRemove(sFetchXml,sParams,iSelected,iOption)}function ProcessLQUseQuery(sFetchXml,sParams){if(sFetchXml!=null){_sFetchXml=sFetchXml;_sCustParams=sParams;_iErrorCode=ERROR_NONE;_iErrorCount=0;_sErrorNumber="";_bActionStarted=true;_sUrl=Mscrm.CrmUri.create("/MA/Lists/ListQualificationDlg/dlg_dynamicList_query.aspx").toString();_sUrl+="?";DisplayActionMsg(LOCID_BI_PROCESSING,350,150);window.setTimeout("postBackFetch()",50);window.returnValue=true}else window.returnValue=false}function postBackFetch(){if(_sFetchXml==""||_sFetchXml==null)_sDialogXml="<node/>";else _sDialogXml=_sFetchXml;_sDialogXml="<root>"+_sDialogXml+"<Ids>";if(_sIds!=null&&_sIds.length!=0)for(var iLen=_sIds.length,i=0;i<iLen;i++)_sDialogXml=_sDialogXml+"<Id>"+CrmEncodeDecode.CrmXmlEncode(_sIds[i])+"</Id>";_sDialogXml=_sDialogXml+"</Ids></root>";_xmlDoc=XUI.Xml.LoadXml(_sDialogXml);_sSubmitUrl=_sUrl+_sCustParams;var oUrl=Mscrm.CrmUri.create(_sSubmitUrl);_xmlhttp.open("POST",oUrl.toString(),false);Mscrm.Utilities.setResponseTypeToMSXml(_xmlhttp);SetTokenInHeader(_xmlhttp,oUrl);_xmlhttp.send(_xmlDoc);_oXml=XUI.Xml.LoadXml(XUI.Xml.XMLSerializer.serializeToString(_xmlhttp.responseXML));wait()}function GetListMemberType(){var command=new RemoteCommand("MarketingAutomation","RetrieveList"),sListId;if(this.parent.$get("crmFormSubmit")==null)sListId=$get("crmFormSubmit").crmFormSubmitId.value;else sListId=this.parent.$get("crmFormSubmit").crmFormSubmitId.value;if(!sListId)sListId=Xrm.Page.data.entity.getId();var columns=[];columns.type="string";columns[0]="createdfromcode";command.SetParameter("id",sListId);command.SetParameter("columns",columns);var oResult=command.Execute();if(oResult.Success){var resultXml=XUI.Xml.LoadXml(oResult.ReturnValue);return XUI.Xml.GetText(XUI.Xml.SelectSingleNode(resultXml,"/list/createdfromcode",null))}return ""}function LaunchAddToListSimple(listId,sGridId){var qs=new QueryString,a=[],sMemberType=GetListMemberType(),itemObjectId="",itemObjectTypeCode="",parameters=[listId,sGridId,sMemberType,a],callbackRef=Mscrm.Utilities.createCallbackFunctionObject("launchAddToListAction",this,parameters,false);LookupObjectsWithCallback(callbackRef,null,"multi",sMemberType,0,null,null,"1")}function launchAddToListAction(lookupItems,listId,sGridId,sMemberType,a){var bMakeCall=false;if(lookupItems)if(lookupItems.items.length>0){for(i=0;i<lookupItems.items.length;i++)a[i]=lookupItems.items[i].id;bMakeCall=true}if(bMakeCall){var parameters=[];parameters[0]=sMemberType;var oUrl=Mscrm.CrmUri.create("/_grid/cmds/dlg_addtolist.aspx?autoTrigger=1&iObjType="+CrmEncodeDecode.CrmUrlEncode(sMemberType)+"&iTotal="+CrmEncodeDecode.CrmUrlEncode(a.length)+"&sIds=&itemObjectId="+CrmEncodeDecode.CrmUrlEncode(listId)+"&itemObjectTypeCode="),crmDialog=new Mscrm.CrmDialog(oUrl,a,400,200,null);crmDialog.setCallbackInfo("performGridRefresh",this,parameters);crmDialog.show()}}function performGridRefresh(oResult,sGridId){oResult&&sGridId!=null&&auto(sGridId)}