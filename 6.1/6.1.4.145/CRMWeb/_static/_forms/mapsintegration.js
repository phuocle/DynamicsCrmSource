var map,searchManager,mapLocale,mapDiv,addressString="",initialMapBounds,lastFocusedControl,mapDivTouchStartTime,mapDivClickIsValid=false,mapLoadMetricsStopwatch=new Mscrm.MetricsStopwatch("BingMapLoad"),request_num=0;function hideMap(){if(Exists(mapDiv))mapDiv.style.display="none"}function CallbackNullCheckAndExecute(callback){callback!=null&&callback!=undefined&&callback()}function RefreshBingMap(entityJson,mapLoadedCallback){switch(window.LOCID_MAP_MODE){case "NotRendered":CallbackNullCheckAndExecute(mapLoadedCallback);return;case "RenderAsLink":var addressAnchor=document.getElementById("bingAddressLink");if(Exists(addressAnchor)){addressString=getAddress(entityJson,addressAnchor.getAttribute("addressField"));addressAnchor.setAttribute("href",getAddressUrl())}CallbackNullCheckAndExecute(mapLoadedCallback);break;case "RenderAsMap":if(typeof Microsoft=="undefined"||typeof Microsoft.Maps=="undefined"||typeof Microsoft.Maps.loadModule=="undefined"){window.setTimeout(function(){RefreshBingMap(entityJson)},100);CallbackNullCheckAndExecute(mapLoadedCallback);return}setPerfMarkerTimestamp("StartRefreshMap");if(Exists(map)){var address=getAddress(entityJson,mapDiv.getAttribute("addressField"));if(address!=addressString){addressString=address;CallbackNullCheckAndExecute(mapLoadedCallback);if(IsStringAvailable(addressString))Microsoft.Maps.loadModule("Microsoft.Maps.Search",{callback:geoCodeAndRender});else{map.setView({bounds:initialMapBounds});map.entities.clear()}}}else{mapDiv=document.getElementById("mapcontrol_container");if(Exists(mapDiv)){addressString=getAddress(entityJson,mapDiv.getAttribute("addressField"));var bingMapKey=mapDiv.getAttribute("bingMapsApiKey");Microsoft.Maps.loadModule("Microsoft.Maps.Themes.BingTheme",{callback:function(){lastFocusedControl=document.activeElement;map=new Microsoft.Maps.Map(mapDiv,{credentials:bingMapKey,showDashboard:false,enableSearchLogo:false,showScalebar:false,theme:new Microsoft.Maps.Themes.BingTheme});!IsNull(lastFocusedControl)&&lastFocusedControl.focus();CallbackNullCheckAndExecute(mapLoadedCallback);if(window.UseTabletExperience){Microsoft.Maps.Events.addHandler(map,"viewchangestart",handleViewChangeStart);Microsoft.Maps.Events.addHandler(map,"viewchangeend",handleViewChangeEnd);mapDiv.addEventListener("touchend",handleMapDivTouchEnd,false)}else Microsoft.Maps.Events.addHandler(map,"click",handleClick);initialMapBounds=map.getBounds();Microsoft.Maps.loadModule("Microsoft.Maps.Search",{callback:geoCodeAndRender})}})}else CallbackNullCheckAndExecute(mapLoadedCallback)}break}}function Exists(object){return typeof object!="undefined"&&object!=null}function IsStringAvailable(variable){return !(variable===undefined||IsNull(variable)||variable=="")}function getAddress(entityJson,addressField){if(!IsStringAvailable(addressField))return "";var address=Mscrm.InlineEditUtilities.getDecodedValue(entityJson[addressField],true);return IsStringAvailable(address)?address:""}function createSearchManager(){if(!searchManager){map.addComponent("searchManager",new Microsoft.Maps.Search.SearchManager(map));searchManager=map.getComponent("searchManager")}}function configureMap(location){map.entities.clear();if(Mscrm.CrmBrowser.get_currentBrowser().get_isAndroid()&&Mscrm.CrmBrowser.get_currentBrowser().get_version()>=29)map.setView({center:location,zoom:10});else map.setView({center:location,zoom:15});var pin1=new Microsoft.Maps.Pushpin(location,null);map.entities.push(pin1);map.entities.push(new Microsoft.Maps.Infobox(location,{title:addressString,pushpin:pin1}))}function handleClick(e){e.mouseMoved==false&&openBingWebsite()}function handleViewChangeStart(e){var mapDiv=document.getElementById("mapcontrol_container");if(mapDiv!=null)for(var images=mapDiv.getElementsByTagName("img"),i=0;i<images.length;i++){images[i].removeEventListener("touchstart",handleMapDivTouchStart);images[i].removeEventListener("touchmove",handleMapDivTouchMove)}}function handleViewChangeEnd(e){var mapDiv=document.getElementById("mapcontrol_container");if(mapDiv!=null)for(var images=mapDiv.getElementsByTagName("img"),i=0;i<images.length;i++){images[i].addEventListener("touchstart",handleMapDivTouchStart,false);images[i].addEventListener("touchmove",handleMapDivTouchMove,false)}}function handleMapDivTouchStart(e){mapDivTouchStartTime=(new Date).getTime();mapDivClickIsValid=true}function handleMapDivTouchMove(e){mapDivClickIsValid=false}function handleMapDivTouchEnd(e){var currentTime=(new Date).getTime();mapDivClickIsValid&&currentTime-mapDivTouchStartTime>100&&openBingWebsite();mapDivClickIsValid=false}function openBingWebsite(){window.open(getAddressUrl())}function getAddressUrl(){var addressParameter=Mscrm.InlineEditUtilities.normalizeNewLineForTextArea(addressString);addressParameter=addressParameter.split("\r").join(" ");return "http://www.bing.com/maps/?where1="+CrmEncodeDecode.CrmUrlEncode(addressParameter)+"&mkt="+CrmEncodeDecode.CrmUrlEncode(window.LOCID_MAP_LOCALE)}function geoCodeAndRender(address){request_num=0;mapLoadMetricsStopwatch.start();sendRequest()}function onGeocodeSuccess(result,userData){setPerfMarkerTimestamp("FinishGeocode");if(result){var topResult=result.results&&result.results[0];topResult&&configureMap(topResult.location)}request_num=0;setPerfMarkerTimestamp("FinishRefreshMap");mapLoadMetricsStopwatch.stop()}function onGeocodeFailed(result,userData){setPerfMarkerTimestamp("FinishGeocode");if(Mscrm.CrmBrowser.get_currentBrowser().get_isMobileSafari()&&request_num<=12){request_num++;sendRequest()}else{request_num=0;setPerfMarkerTimestamp("FinishRefreshMap");mapLoadMetricsStopwatch.stop()}}function sendRequest(){createSearchManager();var userData={name:"Maps Test User",id:"XYZ"+request_num},request={where:addressString,count:5,bounds:map.getBounds(),callback:onGeocodeSuccess,errorCallback:onGeocodeFailed,userData:userData};setPerfMarkerTimestamp("StartGeocode");searchManager.geocode(request)}