Type.registerNamespace("Wall.Interfaces");Wall.Interfaces.IUpdatePostResponse=function(){};Wall.Interfaces.IUpdatePostResponse.registerInterface("Wall.Interfaces.IUpdatePostResponse");Type.registerNamespace("Wall.Interfaces.EventArguments");Wall.Interfaces.EventArguments.PostUpdatedEventArgs=function(post){Wall.Interfaces.EventArguments.PostUpdatedEventArgs.initializeBase(this);this.$n_1=post};Wall.Interfaces.EventArguments.PostUpdatedEventArgs.prototype={$n_1:null,get_post:function(){return this.$n_1}};Type.registerNamespace("Wall.Service.Messages");Wall.Service.Messages.UpdatePostResponse=function(){Wall.Service.Messages.UpdatePostResponse.initializeBase(this)};Type.registerNamespace("Mscrm.FormInputControl.NotesV2");Mscrm.FormInputControl.NotesV2.NotesControl=function(element){this.$$d_$10_3=Function.createDelegate(this,this.$10_3);Mscrm.FormInputControl.NotesV2.NotesControl.initializeBase(this,[element])};Mscrm.FormInputControl.NotesV2.NotesControl.$1H=function(){var $v_0=window.self._notesV2Strings;Mscrm.FormInputControl.NotesV2.NotesControl.localizedStrings=$P_CRM.parseJSON($v_0)};Mscrm.FormInputControl.NotesV2.NotesControl.prototype={$O_3:null,$1_3:null,$2_3:null,$a_3:null,$Q_3:null,$V_3:null,$b_3:null,$8_3:false,$T_3:false,$U_3:false,$k_3:false,$j_3:false,$S_3:false,$J_3:false,$4_3:0,$f_3:null,$H_3:null,$I_3:false,$P_3:false,get_masterComponentId:function(){return this.$V_3},set_masterComponentId:function(value){this.$V_3=value;return value},get_isControlReadOnly:function(){return this.$8_3},set_isControlReadOnly:function(value){this.$8_3=value;return value},get_isNoteCreateEnabled:function(){return this.$T_3&&!this.$8_3},set_isNoteCreateEnabled:function(value){this.$T_3=value;return value},get_isNoteReadEnabled:function(){return this.$U_3},set_isNoteReadEnabled:function(value){this.$U_3=value;return value},get_isNoteEditEnabled:function(){return this.$k_3&&!this.$8_3},set_isNoteEditEnabled:function(value){this.$k_3=value;return value},get_isNoteDeleteEnabled:function(){return this.$j_3&&!this.$8_3},set_isNoteDeleteEnabled:function(value){this.$j_3=value;return value},get_notesWallTabIndex:function(){return this.$4_3},set_notesWallTabIndex:function(value){this.$4_3=value;return value},get_wallContentPageUrl:function(){return this.$b_3},set_wallContentPageUrl:function(value){this.$b_3=value;return value},$l_3:function(){return Mscrm.CrmBrowser.get_currentBrowser().get_isMobileSafari()&&!window.IS_LIVE&&!window.IS_CLAIMS},handleEvent:function(eventCode,parameters,sourceComponent){Mscrm.CrmUIControl.prototype.handleEvent.call(this,eventCode,parameters,sourceComponent);switch(eventCode){case Mscrm.ScriptEvents.RefreshNotesWall:if(parameters[Mscrm.FormInputControl.Tabs.RefreshTabEventParameters.tabName]===Mscrm.SfaTabsConstants.NotesTabId)this.$J_3=true;else this.$J_3=false;if(this.$V_3===sourceComponent.get_id()){if(IsNull(parameters[Mscrm.FormInputControl.Tabs.RefreshTabEventParameters.entityId])){this.$Z_3(Mscrm.FormInputControl.NotesV2.NotesControl.localizedStrings.PendingCreate);return null}else{this.$S_3=true;this.$f_3=parameters[Mscrm.FormInputControl.Tabs.RefreshTabEventParameters.entityId]}if(!this.$I_3)if(!IsNull(this.$H_3)){this.$Y_3();this.$R_3()}else break;this.$O_3.set_entityId(this.$f_3);this.$J_3&&this.$2_3.refreshAll()}break}return null},initialize:function(){Mscrm.CrmUIControl.prototype.initialize.call(this);Mscrm.FormInputControl.NotesV2.NotesControl.$1H();if(!this.$U_3){this.$Z_3(Mscrm.FormInputControl.NotesV2.NotesControl.localizedStrings.NoNotesAvailable);return}!IsNull(this.get_eventManager())&&this.get_eventManager().subscribeEvent(Mscrm.ScriptEvents.RefreshNotesWall,this.get_id());this.$1I_3();Mscrm.OnLoadDeferredExecutor.queueCallback(this.$$d_$10_3,2)},$1I_3:function(){setPerfMarkerTimestamp(Mscrm.RefreshFormMarker.StartNotesWallContentLoadTime);var $v_0=new Sales.Common.Framework.Loaders.ContentLoader,$$t_2=this;$v_0.loadContent(this.$b_3,"html",function($p1_0){$$t_2.$H_3=$p1_0;setPerfMarkerTimestamp(Mscrm.RefreshFormMarker.FinishNotesWallContentLoadTime);if($$t_2.$P_3&&!$$t_2.$I_3&&$$t_2.$S_3){$$t_2.$Y_3();$$t_2.$R_3();$$t_2.$J_3&&$$t_2.$2_3.refreshAll()}})},$10_3:function(){if(!this.$S_3){this.$Z_3(Mscrm.FormInputControl.NotesV2.NotesControl.localizedStrings.PendingCreate);this.$P_3=true;return}if(!this.$I_3&&!IsNull(this.$H_3)){this.$Y_3();this.$R_3();this.$J_3&&this.$2_3.refreshAll()}this.$P_3=true},$Y_3:function(){this.get_element().innerHTML=this.$H_3;if(Mscrm.CrmBrowser.get_currentBrowser().get_isIE8()){var $v_0=$P_CRM(this.$H_3),$v_1=$P_CRM(this.get_element());$v_0.find("script").insertBefore($v_1.find("#progressTemplate"))}},$R_3:function(){if(!this.$I_3)this.$I_3=true;else return;setPerfMarkerTimestamp(Mscrm.RefreshFormMarker.StartNotesWallInitializeTime);this.$1_3=$P_CRM(this.get_element());if(!this.$8_3&&this.$T_3){this.$1G_3();this.$m_3()}else{this.$Q_3=this.$1_3.find("#header");this.$Q_3.hide();this.$m_3()}setPerfMarkerTimestamp(Mscrm.RefreshFormMarker.FinishNotesWallInitializeTime)},$1G_3:function(){var $v_0=new Mscrm.FormInputControl.NotesV2.ObjectModel.NotePost;$v_0.set_postId("createNote");Mscrm.FormInputControl.NotesV2.NotesWall.insertPostBefore($v_0,this.$1_3,this.$1_3.find(".filterAndRefreshContainer"));this.$1_3.find("#createNote").addClass("createNote");this.$1_3.find("#createNote").find(".notesTextBoxDiv").prepend('<b class="border-notch notch"></b><b class="notch"></b>');var $v_1=this.$1_3.parents(".tabsControl").find(".tabLink").filter(String.format("[tabid='{0}']",Mscrm.SfaTabsConstants.NotesTabId))[0];if(IsNull($v_1))return;var $v_2=$v_1.offsetLeft,$v_3=$v_1.offsetWidth/2-10,$v_4=$v_2+$v_3;if(!IsNull($v_1.offsetParent)){var $v_6=$v_1.offsetParent.offsetWidth;$v_4=$v_4>=$v_6?($v_2+$v_6)/2:$v_4}var $v_5=$v_4+"px";this.$1_3.find("b.notch").css("left",$v_5)},dispatchNoteCommand:function(commandName,parameters){if(commandName==="onblur")this.$1J_3(parameters);else this.$a_3.dispatchNoteCommand(commandName,parameters)},$1J_3:function($p0){if(!this.$8_3){var $$t_3=this;window.setTimeout(function(){var $v_0=$$t_3.$1_3.find("#"+$p0),$v_1=getActiveElement();if(!IsNull($v_1)&&$P_CRM($v_1).parents().index($v_0[0])>0)return;$$t_3.$a_3.dispatchNoteCommand("post",$p0)},0)}},$m_3:function(){!this.get_isNoteCreateEnabled()&&this.$1_3.addClass("nocreate");!this.get_isNoteEditEnabled()&&this.$1_3.addClass("noedit");!this.get_isNoteDeleteEnabled()&&this.$1_3.addClass("nodelete");this.$l_3()&&this.$1_3.addClass("noupload");this.$4_3=parseInt(this.get_element().getAttribute("notesWallTabIndex"));Mscrm.CrmBrowser.get_currentBrowser().get_isTouchEnabled()&&this.$1_3.parents(".mobile").length<1&&this.$1_3.addClass("mobile");var $v_0=new Wall.Service.ObjectModel.EntityReference,$v_1=Xrm.Page.data.entity;$v_0.set_logicalName($v_1.getEntityName());$v_0.set_id($v_1.getId());this.$O_3=new Mscrm.FormInputControl.NotesV2.NotesWallService(Xrm.Page.context,$v_0,this.$1_3);this.$2_3=new Mscrm.FormInputControl.NotesV2.NotesWall(this.$1_3,this.$O_3,"header","postTemplate","commentTemplate","notesWallContainer",String.format("#{0}_notesTextBox","createNote"),"progressTemplate","firstRunContent","showMoreLinkTemplate",this.$4_3,!this.get_isNoteCreateEnabled(),!this.get_isNoteEditEnabled(),!this.get_isNoteDeleteEnabled(),this.$l_3());this.$2_3.set_pageSize(10);this.$a_3=new Mscrm.FormInputControl.NotesV2.NotesWallCommandDispatcher(this.get_element().id,this.$2_3,this.$O_3);if(this.get_isNoteCreateEnabled()){var $$t_5=this;this.$2_3.add_postCreated(function($p1_0,$p1_1){var $v_2=$$t_5.$1_3.find("#createdPostIdHiddenField")[0];$v_2.value=$p1_1.get_post().get_postId()+":post"})}},$Z_3:function($p0){this.get_element().innerHTML=String.format("<div class='NotesV2OnlyText'><div class='text'>{0}</div></div>",CrmEncodeDecode.CrmHtmlEncode($p0))},dispose:function(){if(this.get_isDisposed())return;this.$Q_3=null;Mscrm.CrmUIControl.prototype.dispose.call(this)}};function dispatchNoteCommand($p0,$p1,$p2){var $v_0=$P_CRM($p0).parents(".notesWall").first().parents("*").first(),$v_1=$find($v_0.get(0).id);$v_1.dispatchNoteCommand($p1,$p2)}function formatNoteDate($p0,$p1){return Wall.Control.Utils.DateUtils.formatDateAsReadableStringWithGivenResources($p0,$p1,Mscrm.FormInputControl.NotesV2.NotesControl.localizedStrings.Today,Mscrm.FormInputControl.NotesV2.NotesControl.localizedStrings.Yesterday)}Mscrm.FormInputControl.NotesV2.NotesWallHelper=function(){};Mscrm.FormInputControl.NotesV2.NotesWallHelper.$1B=function($p0){var $v_0=$p0.find("#crmFormSubmit");if(IsNull($v_0))return $p0.find("#crmFormSubmitXml");else return $v_0.find("#crmFormSubmitXml")};Mscrm.FormInputControl.NotesV2.NotesWallHelper.$1D=function($p0){return $p0.find("#errorInfoDiv")};Mscrm.FormInputControl.NotesV2.NotesWallHelper.$1C=function($p0){return $p0.find("#errorCodeDiv")};Mscrm.FormInputControl.NotesV2.NotesWallHelper.$1F=function($p0){return $p0.find("#userFile")};Mscrm.FormInputControl.NotesV2.NotesWallHelper.$1E=function($p0){var $v_0=Mscrm.FormInputControl.NotesV2.NotesWallHelper.$1F($p0).val();if(_String.isNullOrEmpty($v_0))return _String.empty;if($v_0.indexOf("\\")<0)return $v_0;return $v_0.substr($v_0.lastIndexOf("\\")+1)};Mscrm.FormInputControl.NotesV2.NotesWallHelper.$D=function($p0,$p1){if(!Mscrm.FormInputControl.NotesV2.NotesWallHelper.$L($p1));var $v_0=$p1.find(String.format("#{0}_attachFileIframe",$p0));return $P_CRM($v_0.get(0).contentWindow.document.body)};Mscrm.FormInputControl.NotesV2.NotesWallHelper.$L=function($p0){return $p0.hasClass("attachmentIframeLoaded")};Mscrm.FormInputControl.NotesV2.NotesWallHelper.getFileNameFromPost=function($p0,$p1){if(!Mscrm.FormInputControl.NotesV2.NotesWallHelper.$L($p1))return _String.empty;return Mscrm.FormInputControl.NotesV2.NotesWallHelper.$1E(Mscrm.FormInputControl.NotesV2.NotesWallHelper.$D($p0,$p1))};Mscrm.FormInputControl.NotesV2.NotesWallHelper.getErrorInfoDivJQueryFromPost=function($p0,$p1){return Mscrm.FormInputControl.NotesV2.NotesWallHelper.$1D(Mscrm.FormInputControl.NotesV2.NotesWallHelper.$D($p0,$p1))};Mscrm.FormInputControl.NotesV2.NotesWallHelper.getErrorCodeDivJQueryFromPost=function($p0,$p1){return Mscrm.FormInputControl.NotesV2.NotesWallHelper.$1C(Mscrm.FormInputControl.NotesV2.NotesWallHelper.$D($p0,$p1))};Mscrm.FormInputControl.NotesV2.NotesWallHelper.getCrmFormSubmitXmlJQueryFromPost=function($p0,$p1){return Mscrm.FormInputControl.NotesV2.NotesWallHelper.$1B(Mscrm.FormInputControl.NotesV2.NotesWallHelper.$D($p0,$p1))};Mscrm.FormInputControl.NotesV2.NotesWallHelper.resetAttachmentIdFromPost=function($p0,$p1){Mscrm.FormInputControl.NotesV2.NotesWallHelper.$L($p1)&&Mscrm.FormInputControl.NotesV2.NotesWallHelper.$D($p0,$p1).find("#AttachmentId").val("")};Mscrm.FormInputControl.NotesV2.NotesWallHelper.getNoteIdQueryStringFromPost=function($p0,$p1){if(!Mscrm.FormInputControl.NotesV2.NotesWallHelper.$L($p1))return _String.empty;var $v_0=parseQueryString($p1.find(String.format("#{0}_attachFileIframe",$p0)).get(0).contentWindow.location),$v_1=$v_0["id"];if(!_String.isNullOrEmpty($v_1))return Sales.Common.CrmSoapServiceProxy.Utils.Utils.parseGuid($v_1);return _String.empty};Mscrm.FormInputControl.NotesV2.NotesWallHelper.getSerializedExceptionFromPost=function($p0,$p1){var $v_0=Mscrm.FormInputControl.NotesV2.NotesWallHelper.$D($p0,$p1).first(),$v_1=$v_0.find("#SerializedException");if($v_1.length>0)return $v_0.find("#SerializedException").text();return ""};Mscrm.FormInputControl.NotesV2.NotesWallHelper.isIframeContentValid=function($p0,$p1){var $v_0=Mscrm.FormInputControl.NotesV2.NotesWallHelper.getNoteIdQueryStringFromPost($p0,$p1);if(_String.isNullOrEmpty($v_0)&&!$p1.find(String.format("#{0}_attachFileIframe",$p0)).get(0).contentWindow.location.pathname.toLowerCase().endsWith("/notes/notesv2attach.aspx")){Mscrm.FormInputControl.NotesV2.NotesWallHelper.resetAttachmentIframe($p0,$p1);return false}else return true};Mscrm.FormInputControl.NotesV2.NotesWallHelper.resetAttachmentIframe=function($p0,$p1){$p1.removeClass("attachmentIframeLoaded");var $v_0=$p1.find(String.format("#{0}_attachFileIframe",$p0));$v_0.removeClass("iframeLoaded");$v_0.css("width","");$v_0.css("height","")};Mscrm.FormInputControl.NotesV2.NotesWall=function(rootContainer,wallService,headerId,postTemplateId,commentTemplateId,wallContainerId,postTextBoxJQueryId,progressTemplateId,emptyTemplateId,showMoreLinkTemplateId,notesWallTabIndex,isCreateDisabled,isUpdateDisabled,isDeleteDisabled,isUploadDisabled){this.$$d_$q_1=Function.createDelegate(this,this.$q_1);this.$$d_$r_1=Function.createDelegate(this,this.$r_1);this.$4_1=-1;this.$6_1={};this.$3_1={};this.$9_1={};Mscrm.FormInputControl.NotesV2.NotesWall.initializeBase(this,[rootContainer,wallService,"."+headerId,postTemplateId,commentTemplateId,wallContainerId,postTextBoxJQueryId,progressTemplateId,emptyTemplateId,showMoreLinkTemplateId]);this.$w_1=rootContainer.find("#deleteNoteTemplate");this.$v_1=rootContainer.find("#undeleteNoteAttachmentTemplate");this.$E_1=wallService;this.$4_1=notesWallTabIndex;this.$C_1=isCreateDisabled;this.$F_1=isUpdateDisabled;this.$c_1=isDeleteDisabled;this.$N_1=isUploadDisabled;var $$t_R=this;this.add_postsRefreshing(function($p1_0,$p1_1){setPerfMarkerTimestamp(Mscrm.RefreshFormMarker.StartNotesWallRefreshLoadTime)});var $$t_S=this;this.add_postsRefreshed(function($p1_0,$p1_1){setPerfMarkerTimestamp(Mscrm.RefreshFormMarker.FinishNotesWallRefreshLoadTime)});var $$t_T=this;this.add_postCreating(function($p1_0,$p1_1){setPerfMarkerTimestamp(Mscrm.RefreshFormMarker.StartPostNoteTime)});var $$t_U=this;this.add_postCreated(function($p1_0,$p1_1){setPerfMarkerTimestamp(Mscrm.RefreshFormMarker.FinishPostNoteTime)});var $$t_V=this;this.add_postsInserted(function($p1_0,$p1_1){$$t_V.$h_1($p1_1.get_posts())});this.$x_1(rootContainer);if(!this.$C_1){var $v_0=new Mscrm.FormInputControl.NotesV2.ObjectModel.NotePost;$v_0.set_postId("createNote");this.$h_1([$v_0])}var $$t_W=this;Wall.Control.Utils.WindowUtils.add_onWindowUnload(function($p1_0){Sales.Common.CrmSoapServiceProxy.CrmSoapServiceBase.set_isAsync(false);$$t_W.$t_1(null)});this.setEmptyState()};Mscrm.FormInputControl.NotesV2.NotesWall.$A=function($p0){$p0.css("opacity","1");Wall.Control.Utils.Browser.getCurrentBrowser().get_isIE8OrLower()&&$p0.css("filter","")};Mscrm.FormInputControl.NotesV2.NotesWall.insertPostBefore=function(post,rootContainer,objectReference){rootContainer.find("#postTemplate").tmpl([post]).insertBefore(objectReference)};Mscrm.FormInputControl.NotesV2.NotesWall.$16=function($p0){$p0.find("a, textarea, input, button").attr("disabled","disabled")};Mscrm.FormInputControl.NotesV2.NotesWall.prototype={$E_1:null,$w_1:null,$v_1:null,$C_1:false,$F_1:false,$c_1:false,$N_1:false,clearInputFields:function(){Mscrm.FormInputControl.NotesV2.NotesWallHelper.resetAttachmentIdFromPost("createNote",this.rootContainer.find("#createNote"));this.rootContainer.find(String.format("#{0}_notesTitleBox","createNote")).val("");if(!IsNull(this.postTextBox)){this.postTextBox.value="";$P_CRM(this.postTextBox).trigger("change")}this.rootContainer.parents(".tabsControl").find(".tabLink").filter(String.format("[tabid='{0}']",Mscrm.SfaTabsConstants.NotesTabId)).focus();this.convertToReadMode("createNote")},processError:function(response){if(Wall.Interfaces.ICreatePostResponse.isInstanceOfType(response))this.$K_1(response,"createNote",true);else Wall.Interfaces.IRetrievePostsRequest.isInstanceOfType(response)&&this.$K_1(response,null,true)},$K_1:function($p0,$p1,$p2){if($p0.get_errorMessage().startsWith("0x")){$p0.get_errorMessage().startsWith("0x80043e08")&&Mscrm.FormInputControl.NotesV2.NotesWallHelper.resetAttachmentIdFromPost("createNote",this.rootContainer.find("#createNote"));openErrorDlg($p0.get_errorMessage(),null,null,-1,-1)}else{var $v_0=Wall.Control.Utils.XmlUtils.parseXmlDocument($p0.get_errorMessage());if(!IsNull($v_0)){var $v_1=Mscrm.ErrorInformation.createFromDoc($v_0.documentElement);openErrorDlg($v_1.get_code(),$v_1.get_description(),$v_1,-1,-1)}else openErrorDlg(null,$p0.get_errorMessage(),null,-1,-1)}this.fireEvent(Wall.Interfaces.EventArguments.ErrorEventArgs,Wall.UI.Wall.errorEventName,new Wall.Interfaces.EventArguments.ErrorEventArgs($p0));!_String.isNullOrWhiteSpace($p1)&&$p2&&this.$B_1($p1,true)},resizeProgressTemplate:function(){return},refreshAll:function(){if(!this.get_isDisabled()){var $$t_0=this;this.$t_1(function(){Wall.UI.Wall.prototype.refreshAll.call($$t_0)})}},processRetrievePostsResponse:function(retrievePostsResponse,dataCallback,emptyCallback,errorCallback){var $$t_4=this;Wall.UI.Wall.prototype.processRetrievePostsResponse.call(this,retrievePostsResponse,dataCallback,function(){$$t_4.setEmptyState();emptyCallback&&emptyCallback()},errorCallback);if(retrievePostsResponse.get_morePosts()){var $$t_5=this;window.setTimeout(function(){$$t_5.renderOlderPosts()},2e3)}},deletePost:function(postId){if(this.$c_1)return;var $v_0=this.wallContainerjQuery.find(String.format(Wall.UI.Wall.postjQueryTemplate,postId)),$v_1=this.findDisplayedPostById(postId),$v_2={};$v_2["height"]="10px";$v_2["opacity"]="0";var $$t_6=this;$v_0.animate($v_2,"fast","linear",function(){$v_0.hide();var $v_3=$$t_6.$w_1.tmpl($v_1,$$t_6).insertBefore($v_0).show();$$t_6.$6_1[postId]=$v_1;var $v_4=$$t_6.$$d_$r_1;$P_CRM(window).data("undeletePostMessageAnimationCallback_"+postId,$v_4);$P_CRM(window).data("undeletePostMessageAnimationObject_"+postId,$v_3);$v_3.find("a:last").focus();$$t_6.$r_1($v_3,postId,true)})},undoDeleteNote:function(noteId){if(noteId in this.$6_1)delete this.$6_1[noteId];this.wallContainerjQuery.find(String.format("#undeletePost_{0}",noteId)).stop(true).remove();var $v_0=this.wallContainerjQuery.find(String.format(Wall.UI.Wall.postjQueryTemplate,noteId));Mscrm.FormInputControl.NotesV2.NotesWall.$A($v_0);$v_0.css("height","auto").slideDown("fast");$v_0.addClass("focus");$v_0.find(String.format("#deletenoteaction_{0}",noteId)).focus()},$15_1:function($p0){if($p0 in this.$6_1){setPerfMarkerTimestamp(Mscrm.RefreshFormMarker.StartDeleteNoteTime);var $$t_3=this;this.$E_1.deletePost(this.$6_1[$p0],function($p1_0){var $v_0=$$t_3.wallContainerjQuery.find(String.format(Wall.UI.Wall.postjQueryTemplate,$p0));if($p1_0.get_isSucceeded()){$$t_3.fireEvent(Wall.Interfaces.EventArguments.PostDeletedEventArgs,Wall.UI.Wall.postDeletedEventName,new Wall.Interfaces.EventArguments.PostDeletedEventArgs($p0));setPerfMarkerTimestamp(Mscrm.RefreshFormMarker.FinishDeleteNoteTime);$$t_3.removePost($p0)}else{Mscrm.FormInputControl.NotesV2.NotesWall.$A($v_0);$v_0.css("height","auto").slideDown("fast");$$t_3.$K_1($p1_0,$p0,false)}});delete this.$6_1[$p0]}},$r_1:function($p0,$p1,$p2){Mscrm.FormInputControl.NotesV2.NotesWall.$A($p0);$p0.stop(true);if($p2){var $v_0={};$v_0["opacity"]="0.2";var $$t_4=this;$p0.show(1).delay(4e3).animate($v_0,3e3,"linear",function(){$p0.remove();$p0.hasClass("deleteNoteDiv")&&$$t_4.$15_1($p1)})}},$t_1:function($p0){var $$dict_1=this.$6_1;for(var $$key_2 in $$dict_1){var $v_2={key:$$key_2,value:$$dict_1[$$key_2]},$v_3=$v_2.value.get_postId();if($v_3 in this.$3_1)delete this.$3_1[$v_3]}var $v_0=_Dictionary.count(this.$6_1)+_Dictionary.count(this.$3_1);if(!$v_0){!IsNull($p0)&&$p0();return}var $v_1=true,$$t_B=this;this.$d_1(this.$6_1,function($p1_0){$$t_B.$E_1.deletePost($p1_0,function($p2_0){$v_0--;if($v_0<=0){$v_0+=1e3;$v_1=false;!IsNull($p0)&&$p0()}})});var $$t_C=this;this.$d_1(this.$3_1,function($p1_0){$$t_C.$E_1.deleteAttachment($p1_0,function($p2_0){$v_0--;if($v_0<=0){$v_0+=1e3;$v_1=false;!IsNull($p0)&&$p0()}})});var $$t_D=this;window.setTimeout(function(){if($v_1){$v_0+=1e3;!IsNull($p0)&&$p0()}},2e3)},$d_1:function($p0,$p1){var $v_0=[],$$dict_3=$p0;for(var $$key_4 in $$dict_3){var $v_2={key:$$key_4,value:$$dict_3[$$key_4]};Array.enqueue($v_0,$v_2.value);delete $p0[$v_2.key]}var $v_1=Array.dequeue($v_0);while(!IsNull($v_1)){$p1($v_1);$v_1=Array.dequeue($v_0)}},deleteAttachment:function(noteId){if(this.$F_1)return;var $v_0=this.wallContainerjQuery.find(String.format(Wall.UI.Wall.postjQueryTemplate,noteId)).find(String.format("#attachment_{0}",noteId)),$v_1=this.findDisplayedPostById(noteId),$v_2={};$v_2["height"]="10px";$v_2["opacity"]="0";var $$t_6=this;$v_0.animate($v_2,"fast","linear",function(){$v_0.hide();var $v_3=$$t_6.$v_1.tmpl($v_1,$$t_6).insertBefore($v_0).show();$$t_6.$3_1[noteId]=$v_1;var $v_4=$$t_6.$$d_$q_1;$P_CRM(window).data("undeleteAttachmentAnimationCallback_"+noteId,$v_4);$P_CRM(window).data("undeleteAttachmentAnimationObject_"+noteId,$v_3);$v_3.find("a:last").focus();$$t_6.wallContainerjQuery.find(String.format(Wall.UI.Wall.postjQueryTemplate,noteId)).addClass("emptyAttachment");$$t_6.$q_1($v_3,noteId,true)});this.$B_1(noteId,false)},undoDeleteAttachment:function(noteId){if(noteId in this.$3_1)delete this.$3_1[noteId];this.wallContainerjQuery.find(String.format("#undeleteAttachment_{0}",noteId)).stop(true).remove();var $v_0=this.wallContainerjQuery.find(String.format(Wall.UI.Wall.postjQueryTemplate,noteId)).find(String.format("#attachment_{0}",noteId));Mscrm.FormInputControl.NotesV2.NotesWall.$A($v_0);$v_0.css("height","auto").slideDown("fast");this.wallContainerjQuery.find(String.format(Wall.UI.Wall.postjQueryTemplate,noteId)).removeClass("emptyAttachment");$v_0.focus()},$13_1:function($p0){if($p0 in this.$3_1){setPerfMarkerTimestamp(Mscrm.RefreshFormMarker.StartDeleteNoteAttachmentTime);var $$t_5=this;this.$E_1.deleteAttachment(this.$3_1[$p0],function($p1_0){var $v_0=null,$v_1=$$t_5.wallContainerjQuery.find(String.format(Wall.UI.Wall.postjQueryTemplate,$p0));if(!IsNull($v_1))$v_0=$v_1.find(String.format("#attachment_{0}",$p0));if($p1_0.get_isSucceeded()){var $v_2=$$t_5.findDisplayedPostById($p0);$v_2.fileName=null;$$t_5.$1R_1($v_2);$$t_5.updatePostInDisplayedPostArray($p0,$v_2);$$t_5.fireEvent(Wall.Interfaces.EventArguments.PostDeletedEventArgs,Wall.UI.Wall.postDeletedEventName,new Wall.Interfaces.EventArguments.PostDeletedEventArgs($p0));setPerfMarkerTimestamp(Mscrm.RefreshFormMarker.FinishDeleteNoteAttachmentTime);$$t_5.$B_1($p0,true)}else{if(!IsNull($v_0)){Mscrm.FormInputControl.NotesV2.NotesWall.$A($v_0);$v_0.css("height","auto").slideDown("fast")}$$t_5.$K_1($p1_0,$p0,true)}});delete this.$3_1[$p0]}},$q_1:function($p0,$p1,$p2){Mscrm.FormInputControl.NotesV2.NotesWall.$A($p0);$p0.stop(true);if($p2){var $v_0={};$v_0["opacity"]="0.2";var $$t_4=this;$p0.show(1).delay(4e3).animate($v_0,3e3,"linear",function(){$$t_4.$W_1($p1)})}},$W_1:function($p0){var $v_0=this.wallContainerjQuery.find(String.format("#undeleteAttachment_{0}",$p0));$v_0.remove();if($v_0.hasClass("deleteAttachmentDiv")){this.$13_1($p0);this.$B_1($p0,true)}},attachToNote:function(noteId){if(!(!this.$C_1&&noteId==="createNote"))if(this.$F_1)return;noteId in this.$3_1&&this.$W_1(noteId);if(this.$N_1)return;var $v_0=this.rootContainer.find("#"+noteId);if(_String.isNullOrWhiteSpace(XUI.Html.GetText($v_0.find(".attachmentFileName")[0]))){$v_0.find("#attachButton").hide();if($v_0.hasClass("attachmentIframeLoaded"))this.$s_1($v_0,noteId);else $v_0.addClass("showIframeOnLoad")}},$h_1:function($p0){for(var $$arr_1=$p0,$$len_2=$$arr_1.length,$$idx_3=0;$$idx_3<$$len_2;++$$idx_3){var $v_0=$$arr_1[$$idx_3],$v_1=this.rootContainer.find("#"+$v_0.get_postId());this.$x_1($v_1);$v_1.trackChildFocus(new ChildFocusTrackerOptions(["container",this.rootContainer]));var $v_2=$v_1.find(String.format("#{0}_notesTextBox",$v_0.get_postId()));if($v_0.get_postId().substring(0,4)!=="temp"){$v_2.textAreaAutoResize();$v_2.textAreaSetWatermark(new TextAreaWatermarkOptions(["watermarkText",$v_0.get_postId()==="createNote"?Mscrm.FormInputControl.NotesV2.NotesControl.localizedStrings.CreateNoteTextWatermark:Mscrm.FormInputControl.NotesV2.NotesControl.localizedStrings.TextWatermark]));$v_1.find(String.format("#{0}_notesTitleBox",$v_0.get_postId())).htmlElementSetWatermark(new HTMLElementWatermarkOptions(["watermarkText",Mscrm.FormInputControl.NotesV2.NotesControl.localizedStrings.TitleWatermark]),"input")}this.convertToReadMode($v_0.get_postId());this.$17_1($v_1)}},$i_1:function($p0,$p1){Mscrm.FormInputControl.NotesV2.NotesWall.insertPostBefore($p0,this.rootContainer,$p1);this.fireEvent(Wall.Interfaces.EventArguments.PostsInsertedEventArgs,Wall.UI.Wall.postsInsertedEventName,new Wall.Interfaces.EventArguments.PostsInsertedEventArgs([$p0]))},$1R_1:function($p0){XUI.Html.SetText(this.rootContainer.find("#"+$p0.get_postId()).find(".attachmentFileName")[0],!$p0.fileName?"":$p0.fileName)},convertToReadMode:function(noteId){var $v_0=this.rootContainer.find("#"+noteId),$v_1=$v_0.find(String.format("#{0}_notesTitleBox",noteId));if(_String.isNullOrEmpty($v_1.getElementValueWithoutWatermark("input")))$v_0.addClass("emptyTitle");else $v_0.removeClass("emptyTitle");var $v_2=$v_0.find(String.format("#{0}_notesTextBox",noteId));$v_2.attr("MinHeight","20");$v_2.forceResize();if(_String.isNullOrEmpty($v_2.getValueWithoutWatermark()))$v_0.addClass("emptyText");else $v_0.removeClass("emptyText");$v_0.find(String.format("#{0}_attachFileIframe",noteId)).hide();var $v_3=$v_0.find(".attachmentFileName");if($v_3.length>0&&_String.isNullOrWhiteSpace(XUI.Html.GetText($v_3[0]))){$v_0.addClass("emptyAttachment");$v_0.find("#attachButton").show()}else{$v_0.removeClass("emptyAttachment");$v_0.find("#attachButton").hide()}this.$1O_1($v_0);$v_0.removeClass("editMode");$v_0.addClass("readMode")},$B_1:function($p0,$p1){if(!(!this.$C_1&&$p0==="createNote"))if(this.$F_1)return;var $v_0=this.rootContainer.find("#"+$p0);if($v_0.hasClass("editMode")&&!$p1)return;$v_0.find(String.format("#{0}_notesTextBox",$p0)).attr("MinHeight","40");$v_0.find(String.format("#{0}_notesTextBox",$p0)).forceResize();$v_0.find(String.format("#{0}_attachFileIframe",$p0)).hide();if(_String.isNullOrWhiteSpace(XUI.Html.GetText($v_0.find(".attachmentFileName")[0]))){$v_0.addClass("emptyAttachment");$v_0.find("#attachButton").show()}else{$v_0.removeClass("emptyAttachment");$v_0.find("#attachButton").hide()}this.$y_1($v_0);$v_0.removeClass("readMode");$v_0.addClass("editMode");var $v_1=$v_0.find(String.format("#{0}_attachFileIframe",$p0));if(!$v_1.hasClass("iframeLoaded")&&!$v_1.hasClass("iframeLoading")&&!this.$N_1){$v_1.addClass("iframeLoading");var $v_2=Mscrm.CrmUri.create("/notes/notesv2attach.aspx");if($p0!=="createNote")$v_2.get_query()["id"]=CrmEncodeDecode.CrmUrlEncode($p0);var $v_3=null,$$t_A=this;$v_3=function($p1_0){$v_1.removeClass("iframeLoading");$v_1.addClass("iframeLoaded");$v_0.addClass("attachmentIframeLoaded");$v_1.unbind("load",$v_3);$v_0.hasClass("editMode")&&$v_0.hasClass("showIframeOnLoad")&&$v_0.find("#attachButton").css("display")==="none"&&$$t_A.$s_1($v_0,$p0)};$v_1.load($v_3);$v_1[0].contentWindow.location.replace($v_2.toString())}if(!$p1){var $v_4=null,$$t_B=this;$v_4=function($p1_0){var $v_5=getActiveElement();if(!IsNull($v_5)&&($P_CRM($v_5).parents().index($v_0[0])>0||$P_CRM($v_5).hasClass("post")&&$v_5===$v_0[0]))return;$$t_B.$o_1($p0);$P_CRM(document).unbind("click",$v_4)};$P_CRM(document).click($v_4)}},$e_1:function($p0){if($p0==="createNote")this.clearInputFields();else{var $v_0=this.findDisplayedPostById($p0),$v_1=CrmEncodeDecode.CrmHtmlDecode($v_0.get_text());this.rootContainer.find(String.format("#{0}_notesTitleBox",$p0)).val($v_0.title);this.rootContainer.find(String.format("#{0}_notesTextBox",$p0)).val($v_1);XUI.Html.SetText(this.rootContainer.find("#"+$p0).find(".attachmentFileName")[0],!$v_0.fileName?"":$v_0.fileName)}this.rootContainer.parents(".tabsControl").find(".tabLink").filter(String.format("[tabid='{0}']",Mscrm.SfaTabsConstants.NotesTabId)).focus();this.convertToReadMode($p0)},$o_1:function($p0){if($p0==="createNote")this.$1L_1();else this.$1S_1($p0)},$1S_1:function($p0){if(this.$F_1){this.convertToReadMode($p0);return}if($p0 in this.$9_1){this.convertToReadMode($p0);return}$p0 in this.$3_1&&this.$W_1($p0);var $v_0=this.findDisplayedPostById($p0),$v_1=this.wallContainerjQuery.find(String.format("#{0}_notesTitleBox",$p0)).getElementValueWithoutWatermark("input"),$v_2=this.wallContainerjQuery.find(String.format("#{0}_notesTextBox",$p0)).getValueWithoutWatermark(),$v_3=Mscrm.FormInputControl.NotesV2.NotesWallHelper.getFileNameFromPost($p0,this.wallContainerjQuery.find("#"+$p0)),$v_4=this.get_wallService().getWallServiceFactory().clonePost($v_0),$v_5=new Mscrm.FormInputControl.NotesV2.ObjectModel.NotePost;$v_5.set_postId($v_4.get_postId());var $v_6=Mscrm.InlineEditUtilities.normalizeNewLineForTextArea($v_2);if($v_6!==$v_0.get_text()){$v_5.set_text($v_2);$v_4.set_text($v_6)}var $v_7=$v_0.title||"";if($v_1!==$v_7){$v_5.title=$v_1;$v_4.title=$v_1}if(isNullOrEmptyString($v_0.fileName)&&!isNullOrEmptyString($v_3)){$v_5.fileName=$v_3;$v_4.fileName=$v_3}if(IsNull($v_5.fileName)&&IsNull($v_5.get_text())&&IsNull($v_5.title)){this.convertToReadMode($p0);return}this.$9_1[$p0]=$v_4;var $v_8=!!$v_5.fileName,$v_9=this.rootContainer.find("#"+$p0);$v_4.set_postId(String.format("temp_{0}",$p0));this.$i_1($v_4,$v_9);var $v_A=this.rootContainer.find("#temp_"+$p0);$v_9.hide();$v_8&&Mscrm.FormInputControl.NotesV2.NotesWall.$16($v_A);var $$t_G=this;this.$E_1.updatePost($v_5,function($p1_0){var $v_B=$$t_G.wallContainerjQuery.find("#"+$p0),$v_C=$$t_G.wallContainerjQuery.find("#"+$v_4.get_postId());if(!($v_C.length===1&&$v_B.length===1)){if($p0 in $$t_G.$9_1)delete $$t_G.$9_1[$p0];return}var $v_D=$$t_G.$9_1[$p0];$v_D.set_postId($p0);if($p1_0.get_isSucceeded()){$$t_G.updatePostInDisplayedPostArray($p0,$v_D);$$t_G.$i_1($v_D,$v_B);$v_C.remove();$v_B.remove();$$t_G.fireEvent(Wall.Interfaces.EventArguments.PostUpdatedEventArgs,"PostUpdated",new Wall.Interfaces.EventArguments.PostUpdatedEventArgs($v_5))}else{$v_C.remove();$v_B.show();$$t_G.$B_1($p0,false);$$t_G.$K_1($p1_0,$p0,true)}delete $$t_G.$9_1[$p0]})},$1L_1:function(){if(this.$C_1)return;var $v_0=$P_CRM(this.postTextBox),$v_1=$v_0.getValueWithoutWatermark(),$v_2=this.rootContainer.find(String.format("#{0}_notesTitleBox","createNote")).getElementValueWithoutWatermark("input"),$v_3=Mscrm.FormInputControl.NotesV2.NotesWallHelper.getFileNameFromPost("createNote",this.rootContainer.find("#createNote"));if((_String.isNullOrEmpty($v_1)||_String.isNullOrEmpty($v_1.trim()))&&(_String.isNullOrEmpty($v_2)||_String.isNullOrEmpty($v_2.trim()))&&_String.isNullOrEmpty($v_3)){this.convertToReadMode("createNote");return}var $v_4=this.get_wallService().getWallServiceFactory().createPost();$v_4.set_text(Mscrm.InlineEditUtilities.normalizeNewLineForTextArea($v_1));$v_4.title=$v_2;$v_4.fileName=$v_3;$v_4.set_postId("temp"+Math.random().toString().replace(".",""));var $v_5=this.get_wallService().getWallServiceFactory().createPost();$v_5.set_text($v_1);$v_5.title=$v_2;$v_5.fileName=$v_3;this.createPost($v_4,$v_5)},$x_1:function($p0){if(this.$4_1>0){$p0.hasClass("post")&&$p0.attr("tabIndex",this.$4_1.toString());$p0.find("post, a, textarea, input, button").filter(':not([tabIndex="-1"])').attr("tabIndex",this.$4_1.toString())}},$1O_1:function($p0){$p0.find(".notesTitleBox, .notesTextBox, #attachButton, .doneLink").attr("tabIndex","-1")},$y_1:function($p0){this.$4_1>0&&$p0.find(".notesTitleBox, .notesTextBox, #attachButton, .doneLink").attr("tabIndex",this.$4_1.toString())},$17_1:function($p0){if(!(!this.$C_1&&!IsNull($p0)&&$p0.length>0&&$p0[0].id==="createNote"))this.$F_1&&$p0.find(".notesTitleBox, .notesTextBox, .attachImage, #attachButton, #deleteAttachmentLink, .doneLink").attr("disabled","disabled");this.$N_1&&$p0.find(".attachImage, #attachButton").attr("disabled","disabled")},$s_1:function($p0,$p1){var $v_0=$p0.find(String.format("#{0}_attachFileIframe",$p1));$v_0.show();$p0.find(".userFile").attr("tabIndex",this.$4_1.toString());var $v_1=$v_0[0];$v_1.focus();$v_1.contentDocument.body.focus();$v_0.find("userFile").focus();$v_0.attr("tabIndex",this.$4_1.toString())}};Mscrm.FormInputControl.NotesV2.NotesWallService=function(clientGlobalContext,wallEntityReference,rootContainer){this.$G_0=wallEntityReference;this.$M_0=new Mscrm.FormInputControl.NotesV2.NotesWallServiceFactory(clientGlobalContext,null);this.$X_0=rootContainer;this.$M_0.$5_0.set_name(Mscrm.FormInputControl.NotesV2.NotesControl.localizedStrings.You)};Mscrm.FormInputControl.NotesV2.NotesWallService.prototype={$M_0:null,$G_0:null,$X_0:null,get_entityId:function(){return this.$G_0.get_id()},set_entityId:function(value){this.$G_0.set_id(value);return value},getWallServiceFactory:function(){return this.$M_0},retrievePosts:function(retrievePostsRequest,retrievePostsCallback){var $v_0=Wall.Control.Utils.RemoteCommandFactory.createRemoteCommand("Annotation","RetrieveNotesCollection",null);$v_0.SetParameter("parentEntityId",this.$G_0.get_id());$v_0.SetParameter("pageNumber",retrievePostsRequest.get_pageNumber());$v_0.SetParameter("pageSize",retrievePostsRequest.get_pageSize());$v_0.SetParameter("pagingCookie",retrievePostsRequest.get_pagingCookie());var $v_1=new Wall.Service.Messages.RetrievePostsBaseResponse,$$t_C=this;$v_0.Execute(function($p1_0,$p1_1){$v_1.set_posts(new Array(0));if(!IsNull($p1_0)&&!IsNull($p1_0.ReturnValue)&&$p1_0.Success){var $v_2=$p1_0.ReturnValue,$v_3=$v_2.AnnotationCollection.AnnotationUI;if(!IsNull($v_3))if(typeof $v_3.length==="undefined"){var $v_4=$v_2.AnnotationCollection.AnnotationUI,$v_5=$v_4;$v_1.get_posts()[0]=Mscrm.FormInputControl.NotesV2.Convertors.NoteConverter.serviceToWall($v_5)}else $v_3.length>0&&$v_1.set_posts(Mscrm.FormInputControl.NotesV2.Convertors.NoteConverter.serviceToWallCollection($v_3));$v_1.set_morePosts($v_2.MoreRecords);$v_1.set_pagingCookie($v_2.PagingCookie)}else $v_1.set_errorMessage($$t_C.$7_0());_Array.each(Wall.Interfaces.IPost,$v_1.get_posts(),function($p2_0,$p2_1){$p2_1.set_text($$t_C.$19_0($p2_1.get_text()));$p2_1.title=$$t_C.$1A_0($p2_1.title)});retrievePostsCallback($v_1)})},postMessage:function(post,createPostCallback){var $v_0=post,$v_1=$v_0.get_text(),$v_2=$v_0.title,$v_3=this.$M_0.$5_0.get_id(),$v_4=this.$G_0.get_id(),$v_5=this.$G_0.get_logicalName(),$v_6=String.format("<annotation><isdocument>0</isdocument><notetext>{0}</notetext><objectid>{1}</objectid><objecttypecode>{2}</objecttypecode><subject>{3}</subject><ownerid type='8'>{4}</ownerid></annotation>",CrmEncodeDecode.CrmXmlEncode($v_1),CrmEncodeDecode.CrmXmlEncode($v_4),CrmEncodeDecode.CrmXmlEncode($v_5),CrmEncodeDecode.CrmXmlEncode($v_2),CrmEncodeDecode.CrmXmlEncode($v_3));if(_String.isNullOrEmpty($v_0.fileName))this.$11_0($v_6,createPostCallback);else{var $$t_C=this;this.$u_0("createNote",$v_6,new Wall.Service.Messages.CreatePostResponse,function($p1_0){var $v_7=$p1_0;if(!_String.isNullOrEmpty($v_7.get_errorMessage()))$v_7.set_revertPost(true);else{var $v_8=Mscrm.FormInputControl.NotesV2.NotesWallHelper.getNoteIdQueryStringFromPost("createNote",$$t_C.$X_0.find("#createNote"));!_String.isNullOrEmpty($v_8)&&$v_7.set_postId(Sales.Common.CrmSoapServiceProxy.Utils.Utils.parseGuid($v_8))}createPostCallback($v_7)})}},updatePost:function(post,updatePostCallback){var $v_0=post,$v_1=!IsNull($v_0.get_text()),$v_2=!IsNull($v_0.title),$v_3=!IsNull($v_0.fileName);if(IsNull($v_1)&&IsNull($v_2)&&IsNull($v_3)){updatePostCallback(new Wall.Service.Messages.UpdatePostResponse);return}var $v_4="";if($v_1)$v_4=String.format($v_4+"<notetext>{0}</notetext>",CrmEncodeDecode.CrmXmlEncode($v_0.get_text()));if($v_2)$v_4=String.format($v_4+"<subject>{0}</subject>",CrmEncodeDecode.CrmXmlEncode($v_0.title));var $v_5="<annotation>"+$v_4+"</annotation>";if(!$v_3){this.$1T_0(post.get_postId(),$v_5,updatePostCallback);return}else{var $$t_A=this;this.$u_0(post.get_postId(),$v_5,new Wall.Service.Messages.UpdatePostResponse,function($p1_0){var $v_6=$p1_0;updatePostCallback($v_6)})}},$1A_0:function($p0){var $v_0=XUI.Xml.LoadXml($p0),$v_1=XUI.Xml.SelectSingleNode($v_0,"//Title",null),$v_2=CrmEncodeDecode.CrmXmlDecode(XUI.Xml.GetText($v_1));return $v_2},$19_0:function($p0){var $v_0=XUI.Xml.LoadXml($p0),$v_1=XUI.Xml.SelectSingleNode($v_0,"//Text",null),$v_2=CrmEncodeDecode.CrmXmlDecode(XUI.Xml.GetText($v_1));return this.formatPostTextForRendering($v_2)},formatPostTextForRendering:function(postText){return Sales.Common.CrmSoapServiceProxy.Utils.EncodingUtils.multilineHtmlEncode(postText,false)},deletePost:function(post,deletePostCallback){var $v_0=false,$v_1=Wall.Control.Utils.RemoteCommandFactory.createRemoteCommand("Annotation","DeleteAnnotation",null);$v_1.SetParameter("id",post.get_postId());var $$t_A=this;$v_1.ErrorHandler=function($p1_0,$p1_1){var $v_2=new Wall.Service.Messages.DeletePostResponse;if(!IsNull($p1_1))$v_2.set_errorMessage(XUI.Xml.XMLSerializer.serializeToString($p1_1));else $v_2.set_errorMessage($p1_0);deletePostCallback($v_2);$v_0=true};var $$t_B=this;$v_1.Execute(function($p1_0,$p1_1){if($v_0)return;var $v_3=new Wall.Service.Messages.DeletePostResponse;(IsNull($p1_0)||IsNull($p1_0.ReturnValue)||!$p1_0.Success)&&$v_3.set_errorMessage($$t_B.$7_0());deletePostCallback($v_3)})},deleteAttachment:function(post,deleteAttachmentCallback){var $v_0=false,$v_1=Wall.Control.Utils.RemoteCommandFactory.createRemoteCommand("Annotation","RemoveAttachment",null);$v_1.SetParameter("id",post.get_postId());$v_1.SetParameter("type",5);var $$t_A=this;$v_1.ErrorHandler=function($p1_0,$p1_1){var $v_2=new Wall.Service.Messages.DeletePostResponse;if(!IsNull($p1_1))$v_2.set_errorMessage(XUI.Xml.XMLSerializer.serializeToString($p1_1));else $v_2.set_errorMessage($p1_0);deleteAttachmentCallback($v_2);$v_0=true};var $$t_B=this;$v_1.Execute(function($p1_0,$p1_1){if($v_0)return;var $v_3=new Wall.Service.Messages.DeletePostResponse;(IsNull($p1_0)||IsNull($p1_0.ReturnValue)||!$p1_0.Success)&&$v_3.set_errorMessage($$t_B.$7_0());deleteAttachmentCallback($v_3)})},$7_0:function(){var $v_0=Mscrm.FormInputControl.NotesV2.NotesControl.localizedStrings.GenericErrorMessage;return $v_0},$11_0:function($p0,$p1){var $v_0=false,$v_1=Wall.Control.Utils.RemoteCommandFactory.createRemoteCommand("Annotation","SaveWithAttachment",null);$v_1.SetParameter("id","");$v_1.SetParameter("update",false);$v_1.SetParameter("type",5);$v_1.SetParameter("dataXml",$p0);var $$t_B=this;$v_1.ErrorHandler=function($p1_0,$p1_1){var $v_2=new Wall.Service.Messages.CreatePostResponse;if(!IsNull($p1_1))$v_2.set_errorMessage(XUI.Xml.XMLSerializer.serializeToString($p1_1));else $v_2.set_errorMessage($p1_0);$v_2.set_revertPost(true);$p1($v_2);$v_0=true};var $$t_C=this;$v_1.Execute(function($p1_0,$p1_1){if($v_0)return;var $v_3=new Wall.Service.Messages.CreatePostResponse;if(IsNull($p1_0)||IsNull($p1_0.ReturnValue)){$v_3.set_errorMessage($$t_C.$7_0());$v_3.set_revertPost(true);$p1($v_3);return}var $v_4=XUI.Xml.LoadXml($p1_0.ReturnValue);if(!$p1_0.Success){if(XUI.Xml.SelectSingleNode($v_4,"/error",null))$v_3.set_errorMessage(XUI.Xml.GetText(XUI.Xml.SelectSingleNode($v_4,"/error",null)));else $v_3.set_errorMessage($$t_C.$7_0());$v_3.set_revertPost(true);$p1($v_3);return}$v_3.set_postId(Sales.Common.CrmSoapServiceProxy.Utils.Utils.parseGuid(XUI.Xml.GetText(XUI.Xml.SelectSingleNode($v_4,"/annotation/annotationid",null))));$p1($v_3)})},$1T_0:function($p0,$p1,$p2){var $v_0=false,$v_1=Wall.Control.Utils.RemoteCommandFactory.createRemoteCommand("Annotation","UpdateAndRetrieveTimeStamp",null);$v_1.SetParameter("annotationId",$p0);$v_1.SetXmlParameter("annotationXml",$p1);var $$t_B=this;$v_1.ErrorHandler=function($p1_0,$p1_1){var $v_2=new Wall.Service.Messages.UpdatePostResponse;if(!IsNull($p1_1))$v_2.set_errorMessage(XUI.Xml.XMLSerializer.serializeToString($p1_1));else $v_2.set_errorMessage($p1_0);$p2($v_2);$v_0=true};var $$t_C=this;$v_1.Execute(function($p1_0,$p1_1){if($v_0)return;var $v_3=new Wall.Service.Messages.UpdatePostResponse;(IsNull($p1_0)||IsNull($p1_0.ReturnValue)||!$p1_0.Success)&&$v_3.set_errorMessage($$t_C.$7_0());$p2($v_3)})},$u_0:function($p0,$p1,$p2,$p3){var $v_0=this.$X_0.find("#"+$p0);if(!$v_0.hasClass("attachmentIframeLoaded"));var $v_1=$v_0.find(String.format("#{0}_attachFileIframe",$p0));Mscrm.FormInputControl.NotesV2.NotesWallHelper.getCrmFormSubmitXmlJQueryFromPost($p0,$v_0).val($p1);var $v_2=null,$v_3=$v_1.get(0).contentWindow,$$t_D=this;$v_2=function($p1_0){var $v_5=Mscrm.FormInputControl.NotesV2.NotesWallHelper.getErrorCodeDivJQueryFromPost($p0,$v_0),$v_6=Mscrm.FormInputControl.NotesV2.NotesWallHelper.getErrorInfoDivJQueryFromPost($p0,$v_0);if($v_5.length>0&&!_String.isNullOrEmpty($v_5.html()))$p2.set_errorMessage($v_5.html());else if($v_6.length>0&&!_String.isNullOrEmpty($v_6.html()))$p2.set_errorMessage($v_6.html());else{var $v_7=Mscrm.FormInputControl.NotesV2.NotesWallHelper.getSerializedExceptionFromPost($p0,$v_0);if(!_String.isNullOrEmpty($v_7)){$p2.set_errorMessage($v_7);Mscrm.FormInputControl.NotesV2.NotesWallHelper.resetAttachmentIframe($p0,$v_0)}else!Mscrm.FormInputControl.NotesV2.NotesWallHelper.isIframeContentValid($p0,$v_0)&&$p2.set_errorMessage($$t_D.$7_0())}$p3($p2);$v_1.unbind("load",$v_2)};$v_1.load($v_2);var $v_4=$v_3.attachForNotesV2();if(!_String.isNullOrEmpty($v_4)){$p2.set_errorMessage($v_4);$p3($p2);$v_1.unbind("load",$v_2)}},formatCommentTextForRendering:function(commentText){throw Error.notImplemented()},retrieveComments:function(retrieveCommentsRequest,retrieveCommentsCallback){throw Error.notImplemented()},postComment:function(comment,createCommentCallback){throw Error.notImplemented()},deleteComment:function(comment,deleteCommentCallback){throw Error.notImplemented()},getWallActions:function(actionType,context){throw Error.notImplemented()},getWallFilters:function(filterType,context){throw Error.notImplemented()},retrieveWallFilters:function(filterType,context,retrieveWallFiltersCallback){throw Error.notImplemented()},selectWallFilter:function(wallFilter){throw Error.notImplemented()},getSelectedWallFilter:function(filterType){throw Error.notImplemented()},setDefaultFilter:function(wallFilter,setDefaultFilterCallback){throw Error.notImplemented()},getWallActionsAsync:function(actionType,context,getWallActionsSuccessCallback,getWallActionsFailureCallback){throw Error.notImplemented()}};Mscrm.FormInputControl.NotesV2.NotesWallServiceFactory=function(clientContext,regardingEntity){this.$5_0=new Wall.Service.ObjectModel.EntityReference;this.$5_0.set_id(this.$1N_0(clientContext.getUserId()));this.$5_0.set_logicalName(Sales.Common.CrmSoapServiceProxy.ObjectModel.SystemUser.entityLogicalName);this.$5_0.set_name(Mscrm.FormInputControl.NotesV2.NotesControl.localizedStrings.You);this.$p_0=regardingEntity};Mscrm.FormInputControl.NotesV2.NotesWallServiceFactory.prototype={$5_0:null,$p_0:null,get_currentUser:function(){return this.$5_0},set_currentUser:function(value){this.$5_0=value;return value},createPost:function(){var $v_0=new Mscrm.FormInputControl.NotesV2.ObjectModel.NotePost;$v_0.modifiedBy=this.$5_0;$v_0.formattedModifiedOn=Mscrm.FormInputControl.NotesV2.NotesControl.localizedStrings.JustNow;$v_0.set_createdBy(this.$5_0);$v_0.set_formattedCreatedOn(Mscrm.FormInputControl.NotesV2.NotesControl.localizedStrings.JustNow);$v_0.set_deleteEnabled(true);$v_0.set_regardingId(this.$p_0);$v_0.title=_String.empty;$v_0.set_text(_String.empty);$v_0.fileName=_String.empty;return $v_0},clonePost:function(originalPost){var $v_0=originalPost,$v_1=new Mscrm.FormInputControl.NotesV2.ObjectModel.NotePost;$v_1.modifiedBy=this.$5_0;$v_1.formattedModifiedOn=Mscrm.FormInputControl.NotesV2.NotesControl.localizedStrings.JustNow;$v_1.set_createdBy($v_0.get_createdBy());$v_1.set_createdOn($v_0.get_createdOn());$v_1.set_formattedCreatedOn($v_0.get_formattedCreatedOn());$v_1.set_deleteEnabled($v_0.get_deleteEnabled());$v_1.set_regardingId($v_0.get_regardingId());$v_1.fileName=$v_0.fileName;$v_1.fileSize=$v_0.fileSize;$v_1.set_postId($v_0.get_postId());$v_1.set_text($v_0.get_text());$v_1.title=$v_0.title;return $v_1},$1N_0:function($p0){return !isNullOrEmptyString($p0)?$p0.replace("{","").replace("}",""):_String.empty},createEntityReference:function(){return new Wall.Service.ObjectModel.EntityReference},createRetrievePostsRequest:function(){return new Wall.Service.Messages.RetrievePostsRequest},createRetrieveLikesRequest:function(){throw Error.create("NotImplementedException")},createComment:function(){throw Error.create("NotImplementedException")},createRetrieveCommentsRequest:function(){throw Error.create("NotImplementedException")}};Mscrm.FormInputControl.NotesV2.WallCommands=function(){};Mscrm.FormInputControl.NotesV2.NotesWallCommandDispatcher=function(wallElementId,wall,wallService){this.$2_0=wall};Mscrm.FormInputControl.NotesV2.NotesWallCommandDispatcher.prototype={$2_0:null,dispatchNoteCommand:function(commandName,parameters){var $v_0=parameters;if(_String.isNullOrEmpty(commandName))throw Error.create("commandName is undefined");commandName=commandName.toLowerCase();switch(commandName){case "post":this.$1K_0($v_0);break;case "delete":this.$14_0($v_0);break;case "undodeletepost":this.$1Q_0($v_0);break;case "edit":this.$18_0($v_0);break;case "read":this.$1M_0($v_0);break;case "deleteattachment":this.$12_0($v_0);break;case "undodeleteattachment":this.$1P_0($v_0);break;case "attach":this.$z_0($v_0);break;case "discard":this.$e_0($v_0);break;default:throw Error.create("invalid commandName")}},$1P_0:function($p0){this.$2_0.undoDeleteAttachment($p0)},$12_0:function($p0){this.$2_0.deleteAttachment($p0)},$18_0:function($p0){this.$2_0.$B_1($p0,false)},$1M_0:function($p0){this.$2_0.convertToReadMode($p0)},$14_0:function($p0){this.$2_0.deletePost($p0)},$1Q_0:function($p0){this.$2_0.undoDeleteNote($p0)},$z_0:function($p0){this.$2_0.attachToNote($p0)},$e_0:function($p0){this.$2_0.$e_1($p0)},$1K_0:function($p0){this.$2_0.$o_1($p0)}};Type.registerNamespace("Mscrm.FormInputControl.NotesV2.Convertors");Mscrm.FormInputControl.NotesV2.Convertors.NoteConverter=function(){};Mscrm.FormInputControl.NotesV2.Convertors.NoteConverter.serviceToWall=function(annotationUI){var $v_0=new Mscrm.FormInputControl.NotesV2.ObjectModel.NotePost;$v_0.set_postId(annotationUI.NoteId);$v_0.set_text(annotationUI.Text);$v_0.set_createdOn(new Date(annotationUI.CreatedOn.toString()));$v_0.set_createdBy(Mscrm.FormInputControl.NotesV2.Convertors.NoteConverter.$g(annotationUI.CreatedBy));$v_0.modifiedOn=new Date(annotationUI.ModifiedOn.toString());$v_0.modifiedBy=Mscrm.FormInputControl.NotesV2.Convertors.NoteConverter.$g(annotationUI.ModifiedBy);$v_0.fileName=annotationUI.FileName;$v_0.fileSize=annotationUI.FileSize;$v_0.title=annotationUI.Title;$v_0.set_formattedCreatedOn("");$v_0.formattedModifiedOn="";return $v_0};Mscrm.FormInputControl.NotesV2.Convertors.NoteConverter.serviceToWallCollection=function(annotationUIs){for(var $v_0=new Array(0),$v_1=0;$v_1<annotationUIs.length;$v_1++)$v_0[$v_1]=Mscrm.FormInputControl.NotesV2.Convertors.NoteConverter.serviceToWall(annotationUIs[$v_1]);return $v_0};Mscrm.FormInputControl.NotesV2.Convertors.NoteConverter.$g=function($p0){if(IsNull($p0))return null;var $v_0=new Wall.Service.ObjectModel.EntityReference;$v_0.set_id($p0.Id);$v_0.set_logicalName($p0.TypeName);$v_0.set_name($p0.Name);return $v_0};Type.registerNamespace("Mscrm.FormInputControl.NotesV2.ObjectModel");Mscrm.FormInputControl.NotesV2.ObjectModel.NotePost=function(){Mscrm.FormInputControl.NotesV2.ObjectModel.NotePost.initializeBase(this)};Mscrm.FormInputControl.NotesV2.ObjectModel.NotePost.prototype={modifiedOn:null,formattedModifiedOn:null,modifiedBy:null,fileName:null,fileSize:0,title:null,get_modifiedOn:function(){return this.modifiedOn},set_modifiedOn:function(value){this.modifiedOn=value;return value},get_formattedModifiedOn:function(){return this.formattedModifiedOn},set_formattedModifiedOn:function(value){this.formattedModifiedOn=value;return value},get_modifiedBy:function(){return this.modifiedBy},set_modifiedBy:function(value){this.modifiedBy=value;return value},get_fileName:function(){return this.fileName},set_fileName:function(value){this.fileName=value;return value},get_fileSize:function(){return this.fileSize},set_fileSize:function(value){this.fileSize=value;return value},get_title:function(){return this.title},set_title:function(value){this.title=value;return value}};Wall.Interfaces.EventArguments.PostUpdatedEventArgs.registerClass("Wall.Interfaces.EventArguments.PostUpdatedEventArgs",Sys.EventArgs);Wall.Service.Messages.UpdatePostResponse.registerClass("Wall.Service.Messages.UpdatePostResponse",Wall.Service.Messages.BaseResponse);Mscrm.FormInputControl.NotesV2.NotesControl.registerClass("Mscrm.FormInputControl.NotesV2.NotesControl",Mscrm.CrmUIControl);Mscrm.FormInputControl.NotesV2.NotesWallHelper.registerClass("Mscrm.FormInputControl.NotesV2.NotesWallHelper");Mscrm.FormInputControl.NotesV2.NotesWall.registerClass("Mscrm.FormInputControl.NotesV2.NotesWall",Wall.UI.Wall);Mscrm.FormInputControl.NotesV2.NotesWallService.registerClass("Mscrm.FormInputControl.NotesV2.NotesWallService",null,Wall.Interfaces.IWallService);Mscrm.FormInputControl.NotesV2.NotesWallServiceFactory.registerClass("Mscrm.FormInputControl.NotesV2.NotesWallServiceFactory",null,Wall.Interfaces.IWallServiceFactory);Mscrm.FormInputControl.NotesV2.WallCommands.registerClass("Mscrm.FormInputControl.NotesV2.WallCommands");Mscrm.FormInputControl.NotesV2.NotesWallCommandDispatcher.registerClass("Mscrm.FormInputControl.NotesV2.NotesWallCommandDispatcher");Mscrm.FormInputControl.NotesV2.Convertors.NoteConverter.registerClass("Mscrm.FormInputControl.NotesV2.Convertors.NoteConverter");Mscrm.FormInputControl.NotesV2.ObjectModel.NotePost.registerClass("Mscrm.FormInputControl.NotesV2.ObjectModel.NotePost",Wall.Service.ObjectModel.Post);Mscrm.FormInputControl.NotesV2.NotesControl.localizedStrings=null;Mscrm.FormInputControl.NotesV2.NotesWall.notesWallJQuerySelector=".notesWall";Mscrm.FormInputControl.NotesV2.NotesWall.createTemplateId="createNote";Mscrm.FormInputControl.NotesV2.NotesWall.noteTitleTextBoxIdJQueryTemplate="#{0}_notesTitleBox";Mscrm.FormInputControl.NotesV2.NotesWall.postTextBoxIdJQueryTemplate="#{0}_notesTextBox";Mscrm.FormInputControl.NotesV2.NotesWall.createTemplatePostClass="createNote";Mscrm.FormInputControl.NotesV2.NotesWall.entityPageIframeIdTemplate="#{0}_attachFileIframe";Mscrm.FormInputControl.NotesV2.NotesWall.attachmentIframeLoadedClass="attachmentIframeLoaded";Mscrm.FormInputControl.NotesV2.NotesWall.iframeLoadedClass="iframeLoaded";Mscrm.FormInputControl.NotesV2.NotesWall.iframeLoadingClass="iframeLoading";Mscrm.FormInputControl.NotesV2.WallCommands.postCommandName="post";Mscrm.FormInputControl.NotesV2.WallCommands.deleteCommandName="delete";Mscrm.FormInputControl.NotesV2.WallCommands.undoDeleteNoteCommandName="undodeletepost";Mscrm.FormInputControl.NotesV2.WallCommands.editCommandName="edit";Mscrm.FormInputControl.NotesV2.WallCommands.readCommandName="read";Mscrm.FormInputControl.NotesV2.WallCommands.deleteAttachmentCommandName="deleteattachment";Mscrm.FormInputControl.NotesV2.WallCommands.undoDeleteAttachmentCommandName="undodeleteattachment";Mscrm.FormInputControl.NotesV2.WallCommands.attachToNoteCommandName="attach";Mscrm.FormInputControl.NotesV2.WallCommands.discardCommandName="discard"