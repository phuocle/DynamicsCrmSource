function SaveAsCompleted(){Mscrm.CommandBarActions.saveAsCompleted()}function assignRecurringInstance(iObjType){var parameters=[];parameters[0]=iObjType;var callbackFunctionObject=Mscrm.Utilities.createCallbackFunctionObject("assignSeriesAction",this,parameters),oUrl=Mscrm.CrmUri.create("/activities/act_dlgs/dlg_seriesaction.aspx?actionType=3"),oReturnValue=openStdDlgWithCallback(oUrl,null,500,220,callbackFunctionObject);isOutlookHostedWindow()&&assignSeriesAction(oReturnValue,iObjType)}function assignSeriesAction(oReturnValue,iObjType){oReturnValue&&Mscrm.CommandBarActions.assignObject(iObjType)}function assignSpecificActivity(iObjType,sSrcQueueId){if(!Xrm.Page.data.getIsValid())return;var sEntityId=new Array($get("crmFormSubmit").crmFormSubmitId.value),oUrl=Mscrm.CrmUri.create("/_grid/cmds/dlg_assignqueue.aspx?iObjType="+CrmEncodeDecode.CrmUrlEncode(iObjType)+"&iTotal=1&sQType=1&srcQueueId="+CrmEncodeDecode.CrmUrlEncode(sSrcQueueId)),dialogOptions=new Xrm.DialogOptions;dialogOptions.height=310;dialogOptions.width=500;var parameters=[iObjType,crmFormCtrl],refreshFormAndGridCallBack=Mscrm.InternalUtilities.GridUtilities.createCallbackFunctionFactory(refreshFormAndGrid,parameters);Xrm.Internal.openDialog(url.toString(),dialogOptions,parameters,null,refreshFormAndGridCallBack)}function refreshFormAndGrid(oReturnValue,iObjType,crmFormCtrl){crmFormCtrl.SubmitCrmForm(4,true,true,false);RefreshParentGrid(iObjType)}function RefreshParentGrid(iObjType){Xrm.Internal.refreshParentGrid(iObjType,Xrm.Internal.getEntityName(iObjType))}function RefreshParentCampaignResponseGrid(){try{window.opener.parent!=null&&window.opener.parent.RefreshCampaignResponse()}catch(e){}}function SwapLookups(oLookupA,oLookupB){var swapStyle="single",aoLookupAItems=oLookupA.getValue(),aoLookupBItems=oLookupB.getValue(),isTrimRequired=false,result=true;if(!IsNull(aoLookupAItems)&&aoLookupAItems.length>1&&(!IsNull(aoLookupBItems)&&aoLookupBItems.length>1))swapStyle="multi";if(swapStyle=="single"&&(!IsNull(aoLookupAItems)&&aoLookupAItems.length>1||!IsNull(aoLookupBItems)&&aoLookupBItems.length>1)){var oUrl=Mscrm.CrmUri.create("/Activities/dlg_confirm_swap.aspx"),dialogOptions=new Xrm.DialogOptions;dialogOptions.height=250;dialogOptions.width=350;var parameters,swapLookupValuesCallBack;if(Xrm.Page.context.client.getClient()==Xrm.ClientNames.mobile){parameters=[true,oLookupA.getName(),oLookupB.getName()];swapLookupValuesCallBack=Mscrm.InternalUtilities.GridUtilities.createCallbackFunctionFactory(swapLookupValuesForMobile,parameters)}else{parameters=[true,oLookupA,oLookupB];swapLookupValuesCallBack=Mscrm.InternalUtilities.GridUtilities.createCallbackFunctionFactory(swapLookupValues,parameters)}Xrm.Internal.openDialog(oUrl.toString(),dialogOptions,parameters,null,swapLookupValuesCallBack);return}swapLookupValues(result,isTrimRequired,oLookupA,oLookupB)}function swapLookupValuesForMobile(result,isTrimRequired,oLookupAName,oLookupBName){swapLookupValues(result,isTrimRequired,Xrm.Page.data.entity.attributes.get(oLookupAName),Xrm.Page.data.entity.attributes.get(oLookupBName))}function swapLookupValues(result,isTrimRequired,oLookupA,oLookupB){if(!result||!IsNull(result)&&result=="false"){if(Xrm.Page.context.client.getClient()==Xrm.ClientNames.mobile)resetDirectionValuesForMobile();else resetDirectionValues();return false}var a=oLookupA,b=oLookupB,aoLookupAItems=oLookupA.getValue(),aoLookupBItems=oLookupB.getValue();if(isTrimRequired){aoLookupAItems=TrimLookup(aoLookupAItems);aoLookupBItems=TrimLookup(aoLookupBItems);a.setValue(aoLookupAItems);b.setValue(aoLookupBItems)}var tmp=a.getValue();a.setValue(b.getValue());b.setValue(tmp)}function resetDirectionValues(){var attr_directioncode=Xrm.Page.getAttribute("directioncode");!IsNull(attr_directioncode)&&attr_directioncode.removeOnChange(directioncode_onchange_handler);var directioncodeCtrl=Xrm.Page.data.entity.attributes.get("directioncode");!IsNull(directioncodeCtrl)&&directioncodeCtrl.setValue(directioncodeCtrl.getValue()==0?1:0);!IsNull(attr_directioncode)&&attr_directioncode.addOnChange(directioncode_onchange_handler,true)}function resetDirectionValuesForMobile(){var attr_directioncode=Xrm.Page.data.entity.attributes.get("directioncode");if(!IsNull(attr_directioncode)){attr_directioncode.removeOnChange(Mscrm.directioncode_onchange);attr_directioncode.setValue(attr_directioncode.getValue()==0);attr_directioncode.addOnChange(Mscrm.directioncode_onchange)}}function TrimLookup(aoLookupItems){if(aoLookupItems.length>1){var aoReturnItem=[];aoReturnItem.push(aoLookupItems[0]);return aoReturnItem}else return aoLookupItems}function promoteToResponse(iObjType){if(Xrm.Page.data.getIsValid()){var sUrl="?_CreateFromType="+CrmEncodeDecode.CrmUrlEncode(iObjType)+"&_CreateFromId="+CrmEncodeDecode.CrmUrlEncode(Xrm.Page.data.entity.getId());openFrmObj(sUrl,buildWinName(),CampaignResponse)}}function convertToCase(iObjType){!IsNull(Mscrm.InlineEditUtilities)&&Mscrm.InlineEditUtilities.tryResetFocusOnActiveControl();if(Xrm.Page.data.entity.getIsDirty()){Mscrm.InternalUtilities._Script.alert(LOCID_CONV_ACT_SAVE_WARNING);return false}if(Xrm.Page.data.getIsValid()){var directionCodeCtrl=Xrm.Page.data.entity.attributes.get("directioncode"),directionCodeVal=true;if(!IsNull(directionCodeCtrl)){directionCodeVal=directionCodeCtrl.getValue();directionCodeVal=directionCodeVal=="0"?false:true}var sUrlElement="",subjectField="",_subject=Xrm.Page.data.entity.attributes.get("subject");if(!IsNull(_subject)&&!IsNull(_subject.getValue()))subjectField=_subject.getValue();sUrlElement+="subject="+CrmEncodeDecode.CrmUrlEncode(subjectField);var customerItems=null,secondaryCust=null;sUrlElement+="&activityType="+CrmEncodeDecode.CrmUrlEncode(iObjType);if(directionCodeVal==true){var toBehavior=Xrm.Page.data.entity.attributes.get("to");if(!IsNull(toBehavior))customerItems=toBehavior.getValue();if(IsNull(customerItems))customerItems=[];var ccBehavior=Xrm.Page.data.entity.attributes.get("cc");if(!IsNull(ccBehavior)){secondaryCust=ccBehavior.getValue();if(!IsNull(secondaryCust))for(var i=0;i<secondaryCust.length;i++)customerItems[customerItems.length]=secondaryCust[i]}var bccBehavior=Xrm.Page.data.entity.attributes.get("bcc");if(!IsNull(bccBehavior)){secondaryCust=bccBehavior.getValue();if(!IsNull(secondaryCust))for(var i=0;i<secondaryCust.length;i++)customerItems[customerItems.length]=secondaryCust[i]}}else if(directionCodeVal==false){var fromBehavior=Xrm.Page.data.entity.attributes.get("from");if(!IsNull(fromBehavior))customerItems=fromBehavior.getValue()}if(iObjType==Mscrm.InternalUtilities.EntityTypeCode.Appointment||iObjType==Mscrm.InternalUtilities.EntityTypeCode.RecurringAppointmentMaster){var requiredattendees=Xrm.Page.data.entity.attributes.get("requiredattendees");if(!IsNull(requiredattendees))customerItems=requiredattendees.getValue();if(IsNull(customerItems))customerItems=[];var optionalattendees=Xrm.Page.data.entity.attributes.get("optionalattendees");if(!IsNull(optionalattendees)){secondaryCust=optionalattendees.getValue();if(!IsNull(secondaryCust))for(var i=0;i<secondaryCust.length;i++)customerItems[customerItems.length]=secondaryCust[i]}}if(!IsNull(customerItems))GetValidCustomer(customerItems,sUrlElement,iObjType,0,Mscrm.InternalUtilities.EntityNames.Incident);else{GetValidCustomerSuccess(sUrlElement,iObjType,customerItems);RefreshParentGrid(iObjType)}}}function GetValidCustomer(customerItems,sUrlElement,iObjType,customerNo,customerType){if(customerNo==customerItems.length)return GetValidCustomerSuccess(sUrlElement,iObjType,customerItems,customerType);try{var isValidCustomer=true;if(!IsNull(customerType)&&customerType=="lead"&&customerItems[customerNo].type.toString()!=Mscrm.InternalUtilities.EntityTypeCode.Lead.toString())isValidCustomer=false;if(!IsNull(customerType)&&customerType!="lead"&&(customerItems[customerNo].type.toString()!=Mscrm.InternalUtilities.EntityTypeCode.Account.toString()&&customerItems[customerNo].type.toString()!=Mscrm.InternalUtilities.EntityTypeCode.Contact.toString()))isValidCustomer=false;if(!isValidCustomer)return GetValidCustomer(customerItems,sUrlElement,iObjType,customerNo+1,customerType);var columns=[];columns[0]="statecode";Xrm.Internal.messages.retrieve(Xrm.Internal.getEntityName(typeof customerItems[customerNo].type!="number"?Number.parseInvariant(customerItems[customerNo].type):customerItems[customerNo].type),customerItems[customerNo].id,columns).then(function(response){if(typeof response.get_entity!="undefined"&&typeof response.get_entity().getObjectData!="undefined"&&typeof response.get_entity().getObjectData().fields!="undefined"&&typeof response.get_entity().getObjectData().fields.statecode!="undefined"&&typeof response.get_entity().getObjectData().fields.statecode.value!="undefined"&&response.get_entity().getObjectData().fields.statecode.value.toString()=="0"&&typeof response.get_entity().get_key!="undefined"){for(var id=response.get_entity().get_key().toString(),k=0;k<customerItems.length;k++)if(!IsNull(customerItems[k].id)&&customerItems[k].id.toLowerCase().indexOf(id.toLowerCase())!=-1){if(customerType!="lead")sUrlElement+="&customerId="+CrmEncodeDecode.CrmUrlEncode(customerItems[k].id)+"&customerType="+CrmEncodeDecode.CrmUrlEncode(customerItems[k].type)+"&customerName="+CrmEncodeDecode.CrmUrlEncode(customerItems[k].name);else sUrlElement+="&leadId="+CrmEncodeDecode.CrmUrlEncode(customerItems[k].id)+"&leadName="+CrmEncodeDecode.CrmUrlEncode(customerItems[k].name);return GetValidCustomerSuccess(sUrlElement,iObjType,customerItems,customerType)}try{Mscrm.CrmDebug.assert(true,"customer with id {0} was not found on the page",id)}catch(e){}return GetValidCustomer(customerItems,sUrlElement,iObjType,customerNo+1,customerType)}else return GetValidCustomer(customerItems,sUrlElement,iObjType,customerNo+1,customerType)},function(response){return GetValidCustomer(customerItems,sUrlElement,iObjType,customerNo+1,customerType)})}catch(e){}}function GetValidCustomerSuccess(sUrlElement,iObjType,customerItems,customerType){if(customerType=="opportunity")return GetValidForConvertToOpportunity(sUrlElement,iObjType,customerItems);else if(customerType=="lead")return GetValidForConvertToOpportunityWithLead(sUrlElement,iObjType);var height=320,parameters=null;parameters=[iObjType];var convertToCaseActionCallBack=Mscrm.InternalUtilities.GridUtilities.createCallbackFunctionFactory(convertToCaseAction,parameters),oUrl=Mscrm.CrmUri.create("/Activities/act_dlgs/convert_to_case.aspx?"+sUrlElement),dialogOptions=new Xrm.DialogOptions;dialogOptions.height=310;dialogOptions.width=410;Xrm.Internal.openDialog(oUrl.toString(),dialogOptions,parameters,null,convertToCaseActionCallBack);RefreshParentGrid(iObjType)}function convertToCaseAction(objRet,iObjType){if(objRet)if(Mscrm.CommandBarActions.isMobileCompanionApp()||Xrm.Page.context.isOutlookOnline()&&(iObjType==4210||iObjType==4212||iObjType==4201||iObjType==4202||iObjType==4251||iObjType==4216)){var activityId=Xrm.Page.data.entity.getId(),customerid=objRet.CustomerId,objectTypeCode=typeof iObjType!="number"?Number.parseInvariant(iObjType):iObjType,customerTypeCode=typeof objRet.CustomerType!="number"?Number.parseInvariant(objRet.CustomerType):objRet.CustomerType,subjectTypeCode=typeof objRet.SubjectType!="number"?Number.parseInvariant(objRet.SubjectType):objRet.SubjectType;try{Mscrm.InternalUtilities.Sdk.convertToCase(function(response){convertToCaseSuccess(response,objRet.SaveActivity,objRet.OpenNewRecord,iObjType)},function(response){if(Mscrm.CommandBarActions.isMobileCompanionApp())Mscrm.CommandBarActions.actionFailedCallback(response);else Mscrm.XrmInternal.openErrorDialog(response.get_organizationServiceFault().get_errorCode(),response.get_error().toString())},Xrm.Page.data.entity.attributes.get("subject").getValue(),activityId,objectTypeCode,customerid,customerTypeCode,null,null,objRet.SubjectId,subjectTypeCode)}catch(e){}}else{var command=new RemoteCommand("ActivitiesWebService","ConvertActivityToCase");command.SetParameter("activityIdStr",Xrm.Page.data.entity.getId());command.SetParameter("activityType",iObjType);command.SetParameter("activitySubject",Xrm.Page.data.entity.attributes.get("subject").getValue());command.SetParameter("customerId",objRet.CustomerId);command.SetParameter("customerType",objRet.CustomerType);command.SetParameter("subjectId",objRet.SubjectId);command.SetParameter("subjectType",objRet.SubjectType);var response=command.Execute();response.Success&&convertToCaseSuccess(response,objRet.SaveActivity,objRet.OpenNewRecord,iObjType)}}function convertToCaseSuccess(response,saveActivity,openNewRecord,iObjType){var caseId;if(typeof response.ReturnValue!="undefined")caseId=response.ReturnValue;else if(typeof response.id!="undefined")caseId=response.id;var _regardingobjectid=Xrm.Page.data.entity.attributes.get("regardingobjectid");if(caseId!=""&&!IsNull(_regardingobjectid)){var itemsArray=[],reg=new LookupControlItem;reg.id=caseId;reg.entityType="incident";var _subject=Xrm.Page.data.entity.attributes.get("subject");if(!IsNull(_subject))reg.name=_subject.getValue();else reg.name="";itemsArray.push(reg);_regardingobjectid.setValue(itemsArray)}if(Mscrm.CommandBarActions.isMobileCompanionApp()||Mscrm.Utilities.isRefreshForm()){if(saveActivity==false){if(caseId!=""&&!IsNull(_regardingobjectid)){Xrm.Page.data.save();openNewRecord&&Xrm.Utility.openEntityForm(Mscrm.InternalUtilities.EntityNames.Incident,caseId)}}else{Xrm.Page.data.setFormDirty(false);if(openNewRecord&&caseId!=""){UnsetCheckpointInHistoryManager();Mscrm.CommandBarActions.markActivityComplete(Xrm.Page.data.entity.getId(),Xrm.Page.data.entity.getEntityName(),false,Mscrm.InternalUtilities.EntityNames.Incident,caseId)}else Mscrm.CommandBarActions.markActivityComplete(Xrm.Page.data.entity.getId(),Xrm.Page.data.entity.getEntityName(),true)}RefreshParentGrid(iObjType)}else convertToEntityLegacy(response,saveActivity,openNewRecord,iObjType,Mscrm.InternalUtilities.EntityNames.Incident)}function convertToLead(iObjType){!IsNull(Mscrm.InlineEditUtilities)&&Mscrm.InlineEditUtilities.tryResetFocusOnActiveControl();if(Xrm.Page.data.entity.getIsDirty()){Mscrm.InternalUtilities._Script.alert(LOCID_CONV_ACT_SAVE_WARNING);return false}if(!Xrm.Page.data.getIsValid())return;var oCrmFormSubmit=$get("crmFormSubmit"),sUrlElement="activityType="+CrmEncodeDecode.CrmUrlEncode(iObjType);sUrlElement+="&activityId="+CrmEncodeDecode.CrmUrlEncode(Xrm.Page.data.entity.getId());var height=390,parameters=[];parameters[0]=iObjType;var oUrl=Mscrm.CrmUri.create("/Activities/act_dlgs/convert_to_lead.aspx?"+sUrlElement),convertToLeadActionCallBack=Mscrm.InternalUtilities.GridUtilities.createCallbackFunctionFactory(convertToLeadAction,parameters),dialogOptions=new Xrm.DialogOptions;dialogOptions.height=height;dialogOptions.width=410;Xrm.Internal.openDialog(oUrl.toString(),dialogOptions,parameters,null,convertToLeadActionCallBack)}function convertToLeadAction(objRet,iObjType){if(objRet)try{var oCrmFormSubmit=$get("crmFormSubmit"),crmFormCtrl=$find("crmForm"),command=new RemoteCommand("ActivitiesWebService","ConvertActivityToLead");command.SetParameter("activityIdStr",Xrm.Page.data.entity.getId());command.SetParameter("activityType",iObjType);command.SetParameter("topic",objRet.Topic);command.SetParameter("firstName",objRet.FirstName);command.SetParameter("lastName",objRet.LastName);command.SetParameter("company",objRet.Company);command.SetParameter("emailAddress",objRet.EmailAddress);var oResult=command.Execute();if(oResult.Success){if(objRet.SaveActivity==true)Mscrm.CommonActivityPageHandler.executeCommand(Mscrm.InlineCommands.Deactivate,objRet.OpenNewRecord);else Mscrm.CommonActivityPageHandler.executeCommand(Mscrm.InlineCommands.Save,objRet.OpenNewRecord);RefreshParentGrid(iObjType);var leadId=oResult.ReturnValue;objRet.OpenNewRecord&&leadId!=""&&openObj(Lead,leadId)}}catch(e){}}function convertToOpportunity(iObjType){!IsNull(Mscrm.InlineEditUtilities)&&Mscrm.InlineEditUtilities.tryResetFocusOnActiveControl();if(Xrm.Page.data.entity.getIsDirty()){Mscrm.InternalUtilities._Script.alert(LOCID_CONV_ACT_SAVE_WARNING);return false}if(Xrm.Page.data.getIsValid()){var _directionCodeCtrl=Xrm.Page.data.entity.attributes.get("directioncode"),directionCodeVal=true;if(!IsNull(_directionCodeCtrl)){directionCodeVal=_directionCodeCtrl.getValue();directionCodeVal=directionCodeVal=="0"||directionCodeVal==false?false:true}var customerItems=null,secondaryCust=null,sUrlElement="";sUrlElement+="activityType="+CrmEncodeDecode.CrmUrlEncode(iObjType);if(directionCodeVal==true){var _to=Xrm.Page.data.entity.attributes.get("to");if(!IsNull(_to))customerItems=_to.getValue();if(IsNull(customerItems))customerItems=[];var _cc=Xrm.Page.data.entity.attributes.get("cc");if(!IsNull(_cc)){secondaryCust=_cc.getValue();if(!IsNull(secondaryCust))for(var i=0;i<secondaryCust.length;i++)customerItems[customerItems.length]=secondaryCust[i]}var _bcc=Xrm.Page.data.entity.attributes.get("bcc");if(!IsNull(_bcc)){secondaryCust=_bcc.getValue();if(!IsNull(secondaryCust))for(var i=0;i<secondaryCust.length;i++)customerItems[customerItems.length]=secondaryCust[i]}}else if(directionCodeVal==false){var _from=Xrm.Page.data.entity.attributes.get("from");if(!IsNull(_from))customerItems=_from.getValue()}if(iObjType==Mscrm.InternalUtilities.EntityTypeCode.Appointment||iObjType==Mscrm.InternalUtilities.EntityTypeCode.RecurringAppointmentMaster){var _requiredattendees=Xrm.Page.data.entity.attributes.get("requiredattendees");if(!IsNull(_requiredattendees))customerItems=_requiredattendees.getValue();if(IsNull(customerItems))customerItems=[];var _optionalattendees=Xrm.Page.data.entity.attributes.get("optionalattendees");if(!IsNull(_optionalattendees)){secondaryCust=_optionalattendees.getValue();if(!IsNull(secondaryCust))for(var i=0;i<secondaryCust.length;i++)customerItems[customerItems.length]=secondaryCust[i]}}!IsNull(customerItems)&&GetValidCustomer(customerItems,sUrlElement,iObjType,0,"opportunity")}RefreshParentGrid(iObjType)}function GetValidForConvertToOpportunity(sUrlElement,iObjType,customerItems){if(sUrlElement.indexOf("customerId")==-1)GetValidCustomer(customerItems,sUrlElement,iObjType,0,"lead");else GetValidForConvertToOpportunityWithLead(sUrlElement,iObjType)}function GetValidForConvertToOpportunityWithLead(sUrlElement,iObjType){var regardingCtrl=Xrm.Page.data.entity.attributes.get("regardingobjectid");if(!IsNull(regardingCtrl)){var regardingItems=regardingCtrl.getValue();if(!IsNull(regardingItems)&&regardingItems.length==1)if(regardingItems[0].type.toString()==Mscrm.InternalUtilities.EntityTypeCode.CampaignActivity.toString()||regardingItems[0].type.toString()==Mscrm.InternalUtilities.EntityTypeCode.BulkOperation.toString())sUrlElement+="&campaignId="+CrmEncodeDecode.CrmUrlEncode(regardingItems[0].id)+"&campaignType="+CrmEncodeDecode.CrmUrlEncode(regardingItems[0].type)+"&campaignName="+CrmEncodeDecode.CrmUrlEncode(regardingItems[0].name)}var subjectField="",_subject=Xrm.Page.data.entity.attributes.get("subject");if(!IsNull(_subject.getValue()))subjectField=_subject.getValue();var ownerId="",ownerType="",ownerCtrl=Xrm.Page.data.entity.attributes.get("ownerid");if(!IsNull(ownerCtrl)){var dataVal=ownerCtrl.getValue();ownerId=dataVal[0].id;ownerType=dataVal[0].type}sUrlElement+="&subject="+CrmEncodeDecode.CrmUrlEncode(subjectField);sUrlElement+="&ownerId="+CrmEncodeDecode.CrmUrlEncode(ownerId);sUrlElement+="&ownerType="+CrmEncodeDecode.CrmUrlEncode(ownerType);var height=400;if(sUrlElement.indexOf("leadId")!=-1)height+=30;var parameters=[];parameters[0]=iObjType;var dialogOptions=new Xrm.DialogOptions;if(Xrm.Page.context.client.getClient()==Xrm.ClientNames.mobile){dialogOptions.height=height+50;dialogOptions.width=650}else{dialogOptions.height=height;dialogOptions.width=410}var oUrl=Mscrm.CrmUri.create("/Activities/act_dlgs/convert_activity.aspx?"+sUrlElement),convertToOppActionCallBack=Mscrm.InternalUtilities.GridUtilities.createCallbackFunctionFactory(convertToOppAction,parameters);Xrm.Internal.openDialog(oUrl.toString(),dialogOptions,null,null,convertToOppActionCallBack);RefreshParentGrid(iObjType)}function convertToOppAction(objRet,iObjType){if(objRet)if(Mscrm.CommandBarActions.isMobileCompanionApp()||Xrm.Page.context.isOutlookOnline()&&(iObjType==4210||iObjType==4212||iObjType==4201||iObjType==4202||iObjType==4251||iObjType==4216))try{var activityTypeCode=typeof iObjType!="number"?Number.parseInvariant(iObjType):iObjType,customerTypeCode=typeof objRet.CustomerType!="number"?Number.parseInvariant(objRet.CustomerType):objRet.CustomerType,campaignTypeCode=typeof objRet.CampaignType!="number"?Number.parseInvariant(objRet.CampaignType):objRet.CampaignType,ownerTypeCode=typeof objRet.ownerType!="number"?Number.parseInvariant(objRet.ownerType):objRet.ownerType;Mscrm.CommandBarActions.convertToOpportunity(function(response){ConvertToOpportunitySuccess(response,objRet.SaveActivity,objRet.OpenNewRecord,iObjType)},function(response){Mscrm.CommandBarActions.actionFailedCallback(response)},Xrm.Page.data.entity.attributes.get("subject").getValue(),Xrm.Page.data.entity.getId(),activityTypeCode,objRet.CustomerId,customerTypeCode,objRet.ownerId,ownerTypeCode,objRet.LeadId,objRet.CurrencyId,objRet.CampaignId,campaignTypeCode,objRet.LogResponse)}catch(e){}else{var command=new RemoteCommand("ActivitiesWebService","ConvertActivity");command.SetParameter("activitySubject",Xrm.Page.data.entity.attributes.get("subject").getValue());command.SetParameter("activityId",Xrm.Page.data.entity.getId());command.SetParameter("activityType",iObjType);command.SetParameter("leadId",objRet.LeadId);command.SetParameter("customerId",objRet.CustomerId);command.SetParameter("customerType",objRet.CustomerType);command.SetParameter("currencyId",objRet.CurrencyId);command.SetParameter("campaignId",objRet.CampaignId);command.SetParameter("campaignType",objRet.CampaignType);command.SetParameter("logResponse",objRet.LogResponse);command.SetParameter("ownerId",objRet.ownerId);command.SetParameter("ownerType",objRet.ownerType);var response=command.Execute();response.Success&&ConvertToOpportunitySuccess(response,objRet.SaveActivity,objRet.OpenNewRecord,iObjType)}}function ConvertToOpportunitySuccess(response,saveActivity,openNewRecord,iObjType){var oppId;if(typeof response.ReturnValue!="undefined")oppId=response.ReturnValue;else if(typeof response.id!="undefined")oppId=response.id;else if(typeof response.get_recordId!="undefined"&&typeof response.get_recordId()!="undefined")oppId=response.get_recordId().toString();var _regardingCtrl=Xrm.Page.data.entity.attributes.get("regardingobjectid");if(oppId!=""&&!IsNull(_regardingCtrl)){var itemsArray=[],reg=new Xrm.LookupObject;reg.id=oppId;reg.entityType=Mscrm.InternalUtilities.EntityNames.Opportunity;var _subject=Xrm.Page.data.entity.attributes.get("subject");if(!IsNull(_subject))reg.name=_subject.getValue();else reg.name="";itemsArray.push(reg);_regardingCtrl.setValue(itemsArray)}if(Mscrm.CommandBarActions.isMobileCompanionApp()||Mscrm.Utilities.isRefreshForm()){if(saveActivity==false){if(oppId!=""&&!IsNull(_regardingCtrl)){Xrm.Page.data.save();openNewRecord&&Xrm.Utility.openEntityForm(Mscrm.InternalUtilities.EntityNames.Opportunity,oppId)}}else{Xrm.Page.data.setFormDirty(false);if(openNewRecord&&oppId!=""){UnsetCheckpointInHistoryManager();Mscrm.CommandBarActions.markActivityComplete(Xrm.Page.data.entity.getId(),Xrm.Page.data.entity.getEntityName(),false,Mscrm.InternalUtilities.EntityNames.Opportunity,oppId)}else Mscrm.CommandBarActions.markActivityComplete(Xrm.Page.data.entity.getId(),Xrm.Page.data.entity.getEntityName(),true)}RefreshParentGrid(iObjType)}else convertToEntityLegacy(response,saveActivity,openNewRecord,iObjType,Mscrm.InternalUtilities.EntityNames.Opportunity)}function convertToEntityLegacy(response,saveActivity,openNewRecord,iObjType,targetEntityName){var crmFormCtrl=$find("crmForm");if(saveActivity==false){crmFormCtrl.SubmitCrmForm(1,true,true,false);RefreshParentGrid(iObjType)}else crmFormCtrl.SubmitCrmForm(58,true,true,false);openNewRecord&&response.ReturnValue!=""&&Xrm.Utility.openEntityForm(targetEntityName,response.ReturnValue);RefreshParentGrid(iObjType)}function okToSave(){if(Xrm.Page.data.entity.getIsDirty()&&!IsNull(Xrm.Page.data.entity.attributes.get("statecode"))&&(Xrm.Page.data.entity.attributes.get("statecode").getValue()==1||Xrm.Page.data.entity.attributes.get("statecode").getValue()==2))if(!Mscrm.InternalUtilities._Script.confirm(LOCID_ACTIVITY_CLOSED_WARNING))return false;return true}function CustomActivitySubmit(sender,args){if(!args.isDefaultPrevented())!okToSave()&&args.preventDefault()}function UnsubscribeLink(){var iframe=document.getElementById("descriptionIFrame"),idoc=document;if(!IsNull(iframe))idoc=iframe.contentDocument||iframe.contentWindow.document;try{idoc.execCommand("createLink",false,"mailto:[Run_Time_Address]?subject=[Run_Time_Subject]")}catch(e){}}function SetFocusOnSubject(){var subjectCtrl=Xrm.Page.ui.controls.get("subject");if(!IsNull(subjectCtrl)&&!subjectCtrl.getDisabled())try{subjectCtrl.setFocus()}catch(e){}}function UnsetCheckpointInHistoryManager(){if(Mscrm.CommandBarActions.isMobileCompanionApp())return;var pageManager=Mscrm.PageManager.get_instance();if(!IsNull(pageManager)){var parameters={isCheckPoint:false};pageManager.raiseEvent(Mscrm.ScriptEvents.UpdatePageInformation,parameters)}}