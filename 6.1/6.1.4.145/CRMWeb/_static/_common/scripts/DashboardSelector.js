Type.registerNamespace("Mscrm");Mscrm.DashboardSelector=function(element){this.$$d_resizeDashboardHandler=Function.createDelegate(this,this.resizeDashboardHandler);this.$$d_$A_3=Function.createDelegate(this,this.$A_3);this.$$d_$9_3=Function.createDelegate(this,this.$9_3);this.$$d_$B_3=Function.createDelegate(this,this.$B_3);this.$$d_$G_3=Function.createDelegate(this,this.$G_3);this.$2_3=[0,0];this.$4_3=window.screen.availHeight;Mscrm.DashboardSelector.initializeBase(this,[element])};Mscrm.DashboardSelector.prototype={$8_3:true,$0_3:null,$3_3:null,$5_3:false,get_selector:function(){if(IsNull(this.$3_3))this.$3_3=$get("dashboardSelectorContainer",this.get_element());return this.$3_3},set_selector:function(value){this.$3_3=value;return value},get_dashboardItems:function(){return XUI.Xml.SelectNodes(this.$0_3.get_menuXml(),"/Menu/MenuItem",null)},get_currentItem:function(){if(!IsNull(this.get_selector().attributes.getNamedItem("CurrentItem")))return this.get_selector().attributes.getNamedItem("CurrentItem").value;return ""},get_currentType:function(){if(!IsNull(this.get_selector().attributes.getNamedItem("CurrentItemType")))return parseInt(this.get_selector().attributes.getNamedItem("CurrentItemType").value,10);return Mscrm.EntityTypeCode.None},getDashboardNode:function(id){return XUI.Xml.SelectSingleNode(this.$0_3.get_menuXml(),"//MenuItem[@id='"+id+"']",null)},get_reloadNeeded:function(){return this.$5_3},set_reloadNeeded:function(value){this.$5_3=value;return value},initialize:function(){Mscrm.CrmUIControl.prototype.initialize.call(this);this.$H_3();this.loadList(this.get_selector().attributes.getNamedItem("MenuXml").value,null,true)},dispose:function(){if(this.get_isDisposed())return;this.$J_3();Mscrm.CrmUIControl.prototype.dispose.call(this)},$H_3:function(){this.set_selector($get("dashboardSelectorContainer",this.get_element()));if(!IsNull(this.get_selector())){Mscrm.PageManager.get_instance().get_eventManager().subscribeEvent(Mscrm.ScriptEvents.WindowResize,this.get_id());var $v_0=$get("dashboardSelectorLink",this.get_element());$addHandler($v_0,"click",this.$$d_$G_3);this.$0_3=new Mscrm.Popup(this.$$d_$B_3)}},$J_3:function(){var $v_0=$get("dashboardSelectorLink",this.get_element());$removeHandler($v_0,"click",this.$$d_$G_3);this.$0_3.dispose()},handleEvent:function(eventCode,parameters,sourceComponent){Mscrm.CrmUIControl.prototype.handleEvent.call(this,eventCode,parameters,sourceComponent);switch(eventCode){case Mscrm.ScriptEvents.WindowResize:this.$C_3();break}return null},$C_3:function(){var $v_0=$get("dashboardSelectorLink"),$v_1=XUI.Html.DomUtils.GetFirstChild($v_0);if(IsNull($v_0)||IsNull($v_1))return;try{$v_1.style.width=$v_1.clientWidth.toString();var $v_2=$v_0.parentNode.offsetWidth,$v_3=$v_1.scrollWidth,$v_4=XUI.Html.DomUtils.GetNextSibling($v_1).offsetWidth;if($v_3>$v_2-$v_4)$v_1.style.width=($v_2-$v_4-30).toString();else $v_1.style.width="auto"}catch($$e_5){}},selectDefaultDashboard:function(){var $v_0="";if(!IsNull(this.get_selector().attributes.getNamedItem("defaultItem"))){$v_0=this.get_selector().attributes.getNamedItem("defaultItem").value;if(Mscrm.Utilities.isServiceMetadataAvailable())if($v_0==="{15e19ce1-819e-4789-a5aa-ea4fe1741568}"){var $v_1=XUI.Xml.LoadXml(this.get_selector().attributes.getNamedItem("MenuXml").value),$v_2=XUI.Xml.SelectSingleNode($v_1,"Menu/MenuItem[@id='{063e7659-05d9-4030-960d-10fe269a5a8b}']",null);if(!IsNull($v_2))$v_0="{063e7659-05d9-4030-960d-10fe269a5a8b}"}}this.$6_3($v_0);this.loadSelectedDashboard()},hide:function(){!IsNull(this.$0_3)&&!IsNull(this.$0_3.get_currentMenu())&&this.$0_3.get_currentMenu().hide()},loadList:function(newList,defaultItem,refreshNeeded){this.$0_3.set_menuXml(XUI.Xml.LoadXml(newList));this.$0_3.set_currentMenu(null);this.$I_3();if(!isNullOrEmptyString(defaultItem)){this.get_selector().setAttribute("defaultItem",defaultItem);this.$6_3(defaultItem)}refreshNeeded&&this.selectDefaultDashboard();this.$D_3()},$G_3:function($p0){$p0.stopPropagation();var $v_0=Mscrm.Utilities.getDomEventElement($p0,"A"),$v_1=new Mscrm.SelectorUtil($get("dashboardSelectorLink",this.get_element()),this.$0_3,XUI.Xml.XMLSerializer.serializeToString(this.$0_3.get_menuXml()));$v_1.selectorClicked($v_0)},$B_3:function($p0,$p1){setPerfMarkerTimestamp(Mscrm.RefreshFormMarker.StartDashboardLoad);var $v_0=$p1["menuitem"];this.$6_3($v_0.get_menuItemId());this.loadSelectedDashboard()},$6_3:function($p0){var $v_0=this.getDashboardNode($p0);if(IsNull($v_0)&&this.get_dashboardItems().length>0){$p0=XUI.Xml.GetText(this.get_dashboardItems()[1].attributes.getNamedItem("id"));$v_0=this.getDashboardNode($p0)}var $v_1=window.LOCID_NO_DASHBOARDS_AVAILABLE,$v_2=Mscrm.EntityTypeCode.None.toString();if(!IsNull($v_0)){$v_1=XUI.Xml.GetText($v_0.attributes.getNamedItem("display"));$v_2=XUI.Xml.GetText($v_0.attributes.getNamedItem("type"))}XUI.Html.SetText(this.get_selector(),$v_1);this.get_selector().setAttribute("CurrentItem",$p0);this.get_selector().setAttribute("CurrentItemType",$v_2);this.get_selector().title=$v_1;var $v_3=String.format(window.LOCID_VIEW_TITLE_FORMAT,window.LOCID_DASHBOARD_PLURAL_NAME,$v_1);setPageTitle($v_3)},$I_3:function(){this.$7_3("defaultItem");this.$7_3("userDefaultItem");this.$7_3("systemDefaultItem")},$7_3:function($p0){var $v_0="",$v_1=XUI.Xml.DomUtils.GetFirstChild(this.$0_3.get_menuXml());if(!IsNull($v_1.attributes.getNamedItem($p0)))$v_0=XUI.Xml.GetText($v_1.attributes.getNamedItem($p0));this.get_selector().setAttribute($p0,$v_0)},$D_3:function(){var $v_0={};$v_0["timestamp"]=new Date;$v_0["queryList"]="";var $v_1={};$v_1["data"]=$v_0;$v_1["key"]=String.format("QueryList_{0}","Dashboard");Mscrm.PageManager.get_instance().raiseEvent(Mscrm.ScriptEvents.InsertCacheData,$v_1)},$1_3:function($p0,$p1){var $v_0=$get($p0);if(!IsNull($v_0)){$v_0.style.zIndex=$p1;if(0>=$p1)$v_0.style.visibility="hidden";else $v_0.style.visibility="visible"}},$9_3:function($p0){this.$1_3("dashboardFrameRow",1);this.$1_3("dashboardLoadingRow",0);this.$1_3("dashboardNotificationRow",0);var $v_0=$get("dashboardFrame");try{refreshRibbon();$removeHandler($v_0,"load",this.$$d_$9_3);if($v_0.contentWindow.document.readyState==="complete")setPerfMarkerTimestamp(Mscrm.RefreshFormMarker.FinishDashboardLoad);else $addHandler($v_0.contentWindow.document,"readystatechange",this.$$d_$A_3);this.$E_3();if(window.UseTabletExperience&&this.$8_3){this.$8_3=false;this.selectDefaultDashboard()}else{var $v_1=this.$F_3();Mscrm.PageManager.get_instance().raiseEvent(Mscrm.ScriptEvents.DashboardViewChanged,$v_1);$addHandler(window,"resize",this.$$d_resizeDashboardHandler);this.get_selector().focus()}}catch($$e_3){}},$A_3:function($p0){var $v_0=$get("dashboardFrame");if($v_0.contentWindow.document.readyState==="complete"){setPerfMarkerTimestamp(Mscrm.RefreshFormMarker.FinishDashboardLoad);$removeHandler($v_0.contentWindow.document,"readystatechange",this.$$d_$A_3)}},$E_3:function(){var $v_0=$get("dashboardFrame");if(!IsNull($v_0)){this.$2_3[0]=$v_0.offsetWidth;this.$2_3[1]=$v_0.offsetHeight}},$F_3:function(){var $v_0={},$v_1=Mscrm.CrmUri.create(window.location.href);$v_0["uri"]=$v_1.toString();if(this.get_currentType()!==Mscrm.EntityTypeCode.None){var $v_2=this.getDashboardNode(this.get_currentItem());$v_0["otc"]=this.get_currentType().toString();$v_0["action"]=$v_1.get_queryString().replace("?","");$v_0["etn"]="Dashboard";$v_0["entitydisplayname"]=window.LOCID_DASHBOARD_SINGLE_NAME;$v_0["title"]=XUI.Xml.GetText($v_2.attributes.getNamedItem("display"));$v_0["id"]=this.get_currentItem()}return $v_0},resizeDashboardHandler:function(e){if(window.UseTabletExperience&&Mscrm.CrmBrowser.get_currentBrowser().get_agent()===3)if(this.$4_3===window.screen.availHeight)return;else this.$4_3=window.screen.availHeight;var $v_0=$get("dashboardFrame");if(!IsNull($v_0)){var $v_1=$v_0.offsetWidth,$v_2=$v_0.offsetHeight;if(Math.abs($v_1-this.$2_3[0])<40&&Math.abs($v_2-this.$2_3[1])<40)return;this.$2_3[0]=$v_1;this.$2_3[1]=$v_2;var $v_3=$v_0.contentWindow.Sys.Application;if(!IsNull($v_3)){var $v_4=$v_3.findComponent("crmPageManager");!IsNull($v_4)&&$v_4.raiseEvent(Mscrm.ScriptEvents.OnDashboardRefresh,null)}}},loadSelectedDashboard:function(){var $v_0=this.get_currentItem(),$v_1=this.get_currentType();if(!this.get_dashboardItems().length||isNullOrEmptyString($v_0)){this.$1_3("dashboardFrameRow",0);this.$1_3("dashboardLoadingRow",0);this.$1_3("dashboardNotificationRow",1)}else{this.$1_3("dashboardFrameRow",0);this.$1_3("dashboardLoadingRow",1);this.$1_3("dashboardNotificationRow",0);var $v_2=Mscrm.CrmUri.create("/dashboards/dashboard.aspx");$v_2.appendToQuery("dashboardId="+$v_0);$v_2.appendToQuery("&pagemode=iframe");$v_2.appendToQuery("&dashboardType="+$v_1.toString());var $v_3=this.$$d_$9_3,$v_4=$get("dashboardFrame");if(!IsNull($v_4)){$v_4.contentWindow.location.replace($v_2.toString());$addHandler($v_4,"load",$v_3)}}this.updateStickyDashboardUrl($v_0)},updateStickyDashboardUrl:function(dashboardId){var $v_0={};$v_0["dashboardId"]=dashboardId;$v_0["dashboardType"]="0";if(this.$5_3)$v_0["refreshDashboard"]=true;if(isOutlookHostedWindow())getOutlookHostedWindow().handleEvent(Mscrm.ScriptEvents.UpdateDashboardsUrl,$v_0,null);else Mscrm.PageManager.get_instance().raiseEvent(Mscrm.ScriptEvents.UpdateDashboardsUrl,$v_0)}};Mscrm.DashboardSelector.registerClass("Mscrm.DashboardSelector",Mscrm.CrmUIControl)