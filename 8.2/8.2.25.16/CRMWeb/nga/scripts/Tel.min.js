var Dynamics=Dynamics||{};Dynamics.Telemetry=function(){function f(n,t,i,r,u){this.n=n;this.v=t;this.t=i;this.rid=r;this.p=u}function s(n,t,i,r){this.n=n;this.t=t;this.rid=i;this.p=r;this.f=!1}function h(u){if(!t.ReportingEndpoint||t.ReportingEndpoint.length===0){console.warn("Reporting endpoint not set. Ignoring start activity request.");return}if(!(u.rid in n)){if(r.numberOfActivities>=i.MaxInMemoryActivities){console.warn("Ignored new activity start. Max number of activities in memory has been reached.");return}n[u.rid]=[];u.p.IsActivityStart=!0;var o=new f(u.n,null,u.t,u.rid,u.p);e(o)}}function e(u){if(!t.ReportingEndpoint||t.ReportingEndpoint.length===0){console.warn("Reporting endpoint not set. Ignored add data point request.");return}if(!u.n||!u.rid){console.warn("Metric object does not have a name or activity id. Ignored add data point request.");return}if(!(u.rid in n)){console.warn("Ignored attempt to add data point to a non-existent activity");return}if(n[u.rid].length>=i.MaxMetricsPerActivity){console.warn("Ignored data point addition. Max. number of metrics per activity has been reached.  Sending metrics to server.");o(u.rid);return}if(u.v!=null&&typeof u.v=="object"){console.warn("Ignored add data point request. Value cannot be object type.");return}if(Object.keys(u.p).length>t.MaxPropertiesPerMetric){console.warn("Ignored add data point request. Number of properties for data point is greater than allowed number.");return}typeof u.v=="string"&&(u.v=u.v.substr(0,i.MaxMetricValueChars));var f=u.rid;u[f]=undefined;n[f].push(u);r.numberOfActivities++;c()}function c(){$.each(n,function(t){n[t]&&n[t].f&&u()})}function u(){$.each(n,function(t,i){if(n[t].f){var u=null,f={};$.each(i,function(n,i){if(i.v!=null&&i.p!=null&&Object.keys(i.p).length>0){var r=new Microsoft.Crm.Client.Core.Framework.TelemetryCore.ClientActivityEvent(t,i.n,i.p);r.addEventParameter("Value",i.v);i.n in f?f[i.n]+=i.v:f[i.n]=i.v;Microsoft.Crm.Client.Core.Framework.TelemetryCore.TelemetryReporter.get_Instance().reportEventImmediate(r)}else i.v==null?u=new Microsoft.Crm.Client.Core.Framework.TelemetryCore.ClientActivityEvent(t,i.n,i.p):u!=null&&u.addEventParameter(i.n,i.v)});u!=null&&($.each(f,function(n,t){u.addEventParameter(n,t)}),Microsoft.Crm.Client.Core.Framework.TelemetryCore.TelemetryReporter.get_Instance().reportEventImmediate(u));r.numberOfActivities--}});n=l()}function l(){var t={};return $.each(n,function(i,r){n[i].f||(t[i]=r)}),t}function o(t){t in n?(n[t].f=!0,u()):console.warn("activityid : "+activityId+" not found in the tracking activities.")}var n={},i={MaxInMemoryActivities:200,MaxMetricsPerActivity:100,MaxMetricValueChars:50,InMemoryActivitiesReportingThreshold:10,MaxPropertiesPerMetric:10},t={ReportingEndpoint:new String(""),IsReportingEnabled:!1},r={isOutstandingRequest:!1,numberOfActivities:0};$(window).on("beforeunload",function(){Dynamics.Telemetry.forceReportMetrics()});return{constants:i,startActivity:h,addDataPointToActivity:e,Metric:f,telemetryContext:t,forceReportMetrics:u,Activity:s,finishActivity:o}}()