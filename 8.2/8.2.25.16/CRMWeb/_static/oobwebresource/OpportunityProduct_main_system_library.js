Type.registerNamespace("Mscrm");Mscrm.OpportunityProductWebResource=function(){};Mscrm.OpportunityProductWebResource.setAdditionalParamsForUomId=function(context){var $v_0=null,$v_1=Xrm.Page.getAttribute("productid");if(!Mscrm.InternalUtilities.JSTypes.isNull($v_1))$v_0=$v_1.getValue();var $v_2=Mscrm.OpportunityProductWebResource.getOpportunityId(),$v_3="{15F1D7AC-47FF-4487-9F42-A48E0DEBDF76}",$v_4="Unit Group Units By Product Price Level updated",$v_5="<fetch version='1.0' mapping='logical'><entity name='uom'><attribute name='name' /><attribute name='uomid' /><link-entity name='productpricelevel' from='uomid' to='uomid'><link-entity name='opportunity' from='pricelevelid' to='pricelevelid'><filter><condition attribute='opportunityid' operator='eq' value='"+CrmEncodeDecode.CrmXmlAttributeEncode($v_2)+"' /></filter></link-entity><link-entity name='product' from='productid' to='productid'><filter><condition attribute='productid' operator='eq' value='"+CrmEncodeDecode.CrmXmlAttributeEncode($v_0[0].id)+"' /></filter></link-entity></link-entity></entity></fetch>",$v_6="<grid name='resultset' object='1055' jump='name' select='1' preview='0' icon='1'><row name='result' id='uomid'><cell name='name' width='300' /></row></grid>",$v_7=Xrm.Page.ui.controls.get("uomid");$v_7.addCustomView($v_3,"uom",$v_4,$v_5,$v_6,true)};Mscrm.OpportunityProductWebResource.getOpportunityId=function(){var $v_0=Xrm.Page.getAttribute("opportunityid");if(!Mscrm.InternalUtilities.JSTypes.isNull($v_0)){var $v_1=$v_0.getValue();return $v_1[0].id}else{var $v_2=Xrm.Page.context.getQueryStringParameters()["opportunityid"];return $v_2["opportunityid"].toString()}};Mscrm.OpportunityProductWebResource.formOnLoad=function(){Mscrm.CommandBarActions.initializeCachedProperties();var $v_0=Xrm.Page.ui.getFormType(),$v_1=Xrm.Page.getAttribute("producttypecode"),$v_2="isOppProductWriteInMode";if($v_0!==3&&$v_0!==4&&$v_0!==6&&!Mscrm.InternalUtilities.JSTypes.isNull($v_1)&&$v_1.getValue()!==3){var $v_3=Xrm.Page.data.entity.attributes.get("quantity");Mscrm.CommandBarActions.defaultQuantityAccuracy=$v_3.getPrecision();if($v_0===1){var $v_9=Xrm.Internal.canOverridePriceEngine("opportunity"),$v_A=Xrm.Page.data.entity.attributes.get("isproductoverridden");if(!$v_9)$v_A.setValue(false);else{if($v_2 in Xrm.Page.context.getQueryStringParameters()){var $v_B=Boolean.parse(Xrm.Page.context.getQueryStringParameters()[$v_2].toString());$v_A.setValue($v_B)}else{var $v_C=Xrm.Page.getControl("productid"),$v_D=Xrm.Page.getControl("isproductoverridden");if(Mscrm.InternalUtilities.JSTypes.isNullOrEmptyString(Xrm.Page.data.entity.getId())&&!Mscrm.InternalUtilities.JSTypes.isNull($v_C)&&!Mscrm.InternalUtilities.JSTypes.isNull($v_D))if($v_C.getVisible()&&$v_C.getDisabled()&&!$v_D.getVisible())$v_A.setValue(true);else if(!$v_C.getVisible()&&!$v_D.getVisible())$v_A.setValue(true);else $v_D.getVisible()&&$v_D.getDisabled()&&($v_C.getDisabled()||!$v_C.getVisible())&&$v_A.setValue(true)}if(Mscrm.InternalUtilities.JSTypes.isNullOrEmptyString(Xrm.Page.data.entity.getId())&&$v_A.getValue()){$v_A.fireOnChange();if(!Mscrm.InternalUtilities.JSTypes.isNull(Xrm.Page.getControl("productdescription"))){var $v_E=Xrm.Page.getControl("productdescription");$v_E.setFocus()}}}}Mscrm.OpportunityProductWebResource.addEventHandlers();var $v_4=Xrm.Page.getAttribute("ispriceoverridden"),$v_5=Xrm.Page.getAttribute("productid"),$v_6=Xrm.Page.getAttribute("uomid"),$v_7=Xrm.Page.getAttribute("productdescription"),$v_8=$v_5.getValue();Mscrm.CommandBarActions.setValueIfNotNull($v_4.getName(),"prevDataValue",$v_4.getValue());Mscrm.CommandBarActions.setValueIfNotNull($v_5.getName(),"prevDataValue",$v_5.getValue());Mscrm.CommandBarActions.setValueIfNotNull($v_6.getName(),"prevDataValue",$v_6.getValue());Mscrm.CommandBarActions.setValueIfNotNull($v_7.getName(),"prevDataValue",$v_7.getValue());if(Mscrm.InternalUtilities.JSTypes.isNull($v_5.getValue())){var $v_F=Xrm.Page.getAttribute("productdescription").getValue();Mscrm.CommandBarActions.productQuantityAccuracy=Mscrm.CommandBarActions.defaultQuantityAccuracy;Mscrm.CommandBarActions.productOverriddenHandler();if($v_F){Xrm.Internal.setFormEntityName($v_F);Xrm.Internal.refreshFormNav()}}else Mscrm.OpportunityProductWebResource.getQuantityDecimalForOP($v_8[0].id,Mscrm.CommandBarActions.productOverriddenHandler);if(Xrm.Page.context.client.getClient()!=="Mobile"){var $v_G=$v_3.getValue();if($v_3.getIsDirty()){var $v_H=parseInt($v_G.toString(),$v_3.getPrecision()),$v_I=Xrm.Internal.getResourceString("LOCID_QTY_CHANGED_DUE_TO_ACC");Xrm.Utility.alertDialog(String.format($v_I,$v_G.toString(),$v_H),null)}}}Xrm.Internal.messages.retrieveMultiple(Mscrm.OpportunityProductWebResource.$1).then(function($p1_0){if($p1_0)Mscrm.OpportunityProductWebResource.$0=$p1_0},function($p1_0){try{console.log("Error in OpportunityProductWebResource_FormOnLoad: "+JSON.stringify(errorResponse))}catch($v_J){}})};Mscrm.OpportunityProductWebResource.isProductOverriddenonChange=function(){Mscrm.CommandBarActions.productOverriddenHandler()};Mscrm.OpportunityProductWebResource.onChangeProductId=function(){var $v_0=Xrm.Page.getAttribute("uomid"),$v_1=Xrm.Page.ui.controls.get("uomid"),$v_2=Xrm.Page.getAttribute("productid");$v_0.setValue([]);$v_1.setDisabled(Mscrm.InternalUtilities.JSTypes.isNull($v_2.getValue()));Mscrm.CommandBarActions.productQuantityAccuracy=Mscrm.CommandBarActions.defaultQuantityAccuracy;var $v_3=Xrm.Page.data.entity.attributes.get("quantity");$v_3.setPrecision(Mscrm.CommandBarActions.productQuantityAccuracy)};Mscrm.OpportunityProductWebResource.onChangeUomId=function(){var $v_0=Xrm.Page.getAttribute("uomid"),$v_1=Xrm.Page.data.entity.attributes.get("quantity"),$v_2=$v_0.getValue();if(Mscrm.InternalUtilities.JSTypes.isNull($v_2)||!$v_2.length){Mscrm.CommandBarActions.productQuantityAccuracy=Mscrm.CommandBarActions.defaultQuantityAccuracy;$v_1.setPrecision(Mscrm.CommandBarActions.productQuantityAccuracy)}else{var $v_3=Xrm.Page.getAttribute("productid"),$v_4=$v_3.getValue();Mscrm.OpportunityProductWebResource.getQuantityDecimalForOP($v_4[0].id,Mscrm.OpportunityProductWebResource.shimCallBack)}};Mscrm.OpportunityProductWebResource.isPriceOverriddenonChange=function(){Mscrm.CommandBarActions.updatePriceAttributes(true)};Mscrm.OpportunityProductWebResource.setAdditionalParamsForProductId=function(context){if(Mscrm.OpportunityProductWebResource.$0)Mscrm.OpportunityProductWebResource.generateProductLookupCustomView(Mscrm.OpportunityProductWebResource.$0);else Xrm.Internal.messages.retrieveMultiple(Mscrm.OpportunityProductWebResource.$1).then(function($p1_0){if($p1_0){Mscrm.OpportunityProductWebResource.$0=$p1_0;Mscrm.OpportunityProductWebResource.generateProductLookupCustomView(Mscrm.OpportunityProductWebResource.$0)}},Mscrm.InternalUtilities.ClientApiUtility.actionFailedCallback)};Mscrm.OpportunityProductWebResource.generateProductLookupCustomView=function(response){var $v_0="",$v_1="",$v_2="",$v_3=Mscrm.OpportunityProductWebResource.getOpportunityId(),$v_4="{3ADA8BBE-DDE2-453B-A855-5A38853BDA21}",$v_5="Products in Parent Price List updated";if(response){var $v_6=response.entityCollection;if($v_6&&$v_6.get_entities()){var $v_7=$v_6.get_entities()[0];if(!IsNull($v_7)){if($v_7.hasValue("fetchxml")){$v_0=$v_7.getValue("fetchxml");$v_2=$v_0.substr(0,$v_0.indexOf("</entity>"))+"<link-entity name='productpricelevel' from='productid' to='productid'><attribute name='productid' /><link-entity name='opportunity' from='pricelevelid' to='pricelevelid'><filter><condition attribute='opportunityid' operator='eq' value='"+CrmEncodeDecode.CrmXmlAttributeEncode($v_3)+"' /></filter></link-entity></link-entity>"+$v_0.substr($v_0.indexOf("</entity>"))}if($v_7.hasValue("layoutxml"))$v_1=$v_7.getValue("layoutxml");var $v_8=Xrm.Page.ui.controls.get("productid");$v_8.addCustomView($v_4,"product",$v_5,$v_2,$v_1,true)}}}};Mscrm.OpportunityProductWebResource.formOnSave=function(context){Mscrm.CommandBarActions.checkPriceAndQuantityNonnegative(context.getEventArgs())};Mscrm.OpportunityProductWebResource.shimCallBack=function(){var $v_0=Xrm.Page.data.entity.attributes.get("quantity");$v_0.setPrecision(Mscrm.CommandBarActions.productQuantityAccuracy)};Mscrm.OpportunityProductWebResource.addEventHandlers=function(){Mscrm.OpportunityProductWebResource.registerMobileClientEvents();var $v_0=Xrm.Page.getAttribute("quantity"),$v_1=Xrm.Page.getAttribute("priceperunit"),$v_2=Xrm.Page.getAttribute("manualdiscountamount"),$v_3=Xrm.Page.getAttribute("tax"),$v_4=function($p1_0){Mscrm.OpportunityProductWebResource.calculatePrice(null)};!Mscrm.InternalUtilities.JSTypes.isNull($v_0)&&$v_0.addOnChange($v_4);!Mscrm.InternalUtilities.JSTypes.isNull($v_1)&&$v_1.addOnChange($v_4);!Mscrm.InternalUtilities.JSTypes.isNull($v_2)&&$v_2.addOnChange($v_4);!Mscrm.InternalUtilities.JSTypes.isNull($v_3)&&$v_3.addOnChange($v_4)};Mscrm.OpportunityProductWebResource.registerMobileClientEvents=function(){if(Xrm.Page.context.client.getClient()!=="Mobile")return;var $v_0=Xrm.Page.ui.controls.get("productid"),$v_1=function($p1_0){Mscrm.OpportunityProductWebResource.setAdditionalParamsForProductId($p1_0.toString())};!Mscrm.InternalUtilities.JSTypes.isNull($v_0)&&$v_0.addPreSearch($v_1);var $v_2=Xrm.Page.ui.controls.get("uomid"),$v_3=function($p1_0){Mscrm.OpportunityProductWebResource.setAdditionalParamsForUomId($p1_0.toString())};!Mscrm.InternalUtilities.JSTypes.isNull($v_2)&&$v_2.addPreSearch($v_3)};Mscrm.OpportunityProductWebResource.calculatePrice=function(failureCallback){if(Xrm.Page.context.client.getClient()==="Mobile"){var $v_0=Mscrm.OpportunityProductWebResource.getOpportunityId(),$v_1=new Array(0);$v_1[0]="isrevenuesystemcalculated";Xrm.Internal.messages.retrieve("opportunity",$v_0,$v_1).then(function($p1_0){var $v_2=$p1_0.entity;if($v_2.hasValue("isrevenuesystemcalculated"))!$v_2.getValue("isrevenuesystemcalculated")&&Mscrm.OpportunityProductWebResource.updatePrice()},failureCallback)}else{var $v_3=Xrm.Page.ui.getFormType();if($v_3===1)return;Xrm.Page.data.save()}};Mscrm.OpportunityProductWebResource.updatePrice=function(){var $v_0=0,$v_1=0,$v_2=0,$v_3=0,$v_4=0,$v_5=0,$v_6=0,$v_7=Xrm.Page.getAttribute("quantity");if(!Mscrm.InternalUtilities.JSTypes.isNull($v_7))$v_2=$v_7.getValue();var $v_8=Xrm.Page.getAttribute("priceperunit");if(!Mscrm.InternalUtilities.JSTypes.isNull($v_8))$v_3=$v_8.getValue();var $v_9=Xrm.Page.getAttribute("manualdiscountamount");if(!Mscrm.InternalUtilities.JSTypes.isNull($v_9))$v_4=$v_9.getValue();var $v_A=Xrm.Page.getAttribute("volumediscountamount");if(!Mscrm.InternalUtilities.JSTypes.isNull($v_A))$v_5=$v_A.getValue();var $v_B=Xrm.Page.getAttribute("tax");if(!Mscrm.InternalUtilities.JSTypes.isNull($v_B))$v_6=$v_B.getValue();$v_0=$v_2*($v_3-$v_5);$v_1=$v_0-$v_4+$v_6;if(isNaN($v_0)||isNaN($v_1))return;var $v_C=Xrm.Page.getAttribute("extendedamount");!Mscrm.InternalUtilities.JSTypes.isNull($v_C)&&$v_C.setValue($v_1);var $v_D=Xrm.Page.getAttribute("baseamount");!Mscrm.InternalUtilities.JSTypes.isNull($v_D)&&$v_D.setValue($v_0)};Mscrm.OpportunityProductWebResource.getQuantityDecimalForOP=function(opportunityid,productallback){var $v_0=new Array(0);$v_0[0]="quantitydecimal";Xrm.Internal.messages.retrieve("product",opportunityid,$v_0).then(function($p1_0){var $v_1=$p1_0.entity;if($v_1.hasValue("quantitydecimal"))Mscrm.CommandBarActions.productQuantityAccuracy=$v_1.getValue("quantitydecimal");else Mscrm.CommandBarActions.productQuantityAccuracy=Mscrm.CommandBarActions.defaultQuantityAccuracy;!Mscrm.InternalUtilities.JSTypes.isNull(productallback)&&productallback()},function($p1_0){Mscrm.CommandBarActions.productQuantityAccuracy=Mscrm.CommandBarActions.defaultQuantityAccuracy;!Mscrm.InternalUtilities.JSTypes.isNull(productallback)&&productallback()})};Mscrm.OpportunityProductWebResource.prototype={removeOnChangeEventHandler:function(){var $$t_6=this,$v_0=function($p1_0){Mscrm.OpportunityProductWebResource.calculatePrice(null)},$v_1=Xrm.Page.getAttribute("quantity"),$v_2=Xrm.Page.getAttribute("priceperunit"),$v_3=Xrm.Page.getAttribute("manualdiscountamount"),$v_4=Xrm.Page.getAttribute("tax");!Mscrm.InternalUtilities.JSTypes.isNull($v_1)&&$v_1.removeOnChange($v_0);!Mscrm.InternalUtilities.JSTypes.isNull($v_2)&&$v_2.removeOnChange($v_0);!Mscrm.InternalUtilities.JSTypes.isNull($v_3)&&$v_3.removeOnChange($v_0);!Mscrm.InternalUtilities.JSTypes.isNull($v_4)&&$v_4.removeOnChange($v_0)}};Mscrm.OpportunityProductWebResource.registerClass("Mscrm.OpportunityProductWebResource");Mscrm.OpportunityProductWebResource.$0=null;Mscrm.OpportunityProductWebResource.$2="{BCC509EE-1444-4A95-AED2-128EFD85FFD5}";Mscrm.OpportunityProductWebResource.$1="<fetch version='1.0' mapping='logical'><entity name='savedquery'><attribute name='fetchxml' /><attribute name='layoutxml' /><filter type='and'><condition attribute='savedqueryid' operator='eq' value= '"+Mscrm.OpportunityProductWebResource.$2+"' /></filter><order attribute='versionnumber' descending='true' /></entity></fetch>";Mscrm.Form_onload=Mscrm.OpportunityProductWebResource.formOnLoad;Mscrm.uomid_setadditionalparams=Mscrm.OpportunityProductWebResource.setAdditionalParamsForUomId;Mscrm.isproductoverridden_onchange=Mscrm.OpportunityProductWebResource.isProductOverriddenonChange;Mscrm.productid_onchange=Mscrm.OpportunityProductWebResource.onChangeProductId;Mscrm.uomid_onchange=Mscrm.OpportunityProductWebResource.onChangeUomId;Mscrm.ispriceoverridden_onchange=Mscrm.OpportunityProductWebResource.isPriceOverriddenonChange;Mscrm.productid_setadditionalparams=Mscrm.OpportunityProductWebResource.setAdditionalParamsForProductId;Mscrm.Form_onsave=Mscrm.OpportunityProductWebResource.formOnSave