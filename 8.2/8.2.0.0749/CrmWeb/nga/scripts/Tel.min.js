var Dynamics=Dynamics||{};Dynamics.Telemetry=function(){var a={},d={MaxInMemoryActivities:200,MaxMetricsPerActivity:100,MaxMetricValueChars:50,InMemoryActivitiesReportingThreshold:10,MaxPropertiesPerMetric:10},b={ReportingEndpoint:new String(""),IsReportingEnabled:false},c={isOutstandingRequest:false,numberOfActivities:0};$(window).on("beforeunload",function(){Dynamics.Telemetry.forceReportMetrics()});function h(e,d,c,a,b){this.n=e;this.v=d;this.t=c;this.rid=a;this.p=b}function m(d,c,a,b){this.n=d;this.t=c;this.rid=a;this.p=b;this.f=false}function l(e){if(!b.ReportingEndpoint||b.ReportingEndpoint.length===0)return;if(!(e.rid in a)){if(c.numberOfActivities>=d.MaxInMemoryActivities)return;a[e.rid]=[];e.p.IsActivityStart=true;var g=new h(e.n,null,e.t,e.rid,e.p);f(g)}}function f(e){if(!b.ReportingEndpoint||b.ReportingEndpoint.length===0)return;if(!e.n||!e.rid)return;if(!(e.rid in a))return;if(a[e.rid].length>=d.MaxMetricsPerActivity){g(e.rid);return}if(e.v!=null&&typeof e.v==="object")return;if(Object.keys(e.p).length>b.MaxPropertiesPerMetric)return;if(typeof e.v==="string")e.v=e.v.substr(0,d.MaxMetricValueChars);var f=e.rid;e[f]=undefined;a[f].push(e);c.numberOfActivities++;j()}function j(){$.each(a,function(b){a[b]&&a[b].f&&e()})}function e(){if(c.isOutstandingRequest)return;c.isOutstandingRequest=true;var d=k();a=i();$.ajax({type:"POST",url:b.ReportingEndpoint,data:d,contentType:"application/json; charset=utf-8",dataType:"json",success:function(a){c.isOutstandingRequest=false;if(a.d){var b=Object.create(a.d);b.Success}},error:function(){c.isOutstandingRequest=false}})}function k(){var b={},e=b.request={},d=e.MetricsCollections=[];$.each(a,function(b,e){if(a[b].f){d.push({RequestId:b,Metrics:e});c.numberOfActivities--}});var f=JSON.stringify(b);return f}function i(){var b={};$.each(a,function(c,d){if(!a[c].f)b[c]=d});return b}function g(b){b in a && (a[b].f=true, e())}return{constants:d,startActivity:l,addDataPointToActivity:f,Metric:h,telemetryContext:b,forceReportMetrics:e,Activity:m,finishActivity:g}}()